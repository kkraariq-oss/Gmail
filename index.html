<script>
// ÿ¥ÿπÿßÿ± SVG ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä (ÿØÿßÿ¶ÿ±ÿ© ŸÖÿπ ÿ≠ÿ±ŸÅ Y)
const defaultSVGLogo =
  'data:image/svg+xml;utf8,' +
  encodeURIComponent(`
    <svg width="180" height="180" viewBox="0 0 180 180" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="90" cy="90" r="85" fill="#6366f1" fill-opacity="0.13" stroke="#6366f1" stroke-width="8"/>
      <text x="50%" y="54%" text-anchor="middle" fill="#6366f1" fill-opacity="0.35" font-size="80" font-family="Cairo,Arial,sans-serif" font-weight="bold" dy=".35em">Y</text>
    </svg>
  `);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üñºÔ∏è ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ™ÿ¨ÿ± ÿ®ÿµŸäÿ∫ÿ© Base64 - Ÿäÿ∏Ÿáÿ± ŸÅŸä ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ŸäÿµÿßŸÑÿßÿ™ ÿßŸÑŸÖÿ∑ÿ®Ÿàÿπÿ©
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üìå ŸÉŸäŸÅŸäÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ¥ÿπÿßÿ±:
// 1Ô∏è‚É£ ÿßŸÅÿ™ÿ≠ ŸÖŸàŸÇÿπ: https://www.base64-image.de/
// 2Ô∏è‚É£ ÿßÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿßŸÑÿ¥ÿπÿßÿ± (yaqoub_logo.png ÿ£Ÿà ÿ£Ÿä ÿµŸàÿ±ÿ© ÿ£ÿÆÿ±Ÿâ)
// 3Ô∏è‚É£ ÿßŸÜÿ≥ÿÆ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÜÿßÿ™ÿ¨ (Ÿäÿ®ÿØÿ£ ÿ®ŸÄ data:image/png;base64,)
// 4Ô∏è‚É£ ÿßŸÑÿµŸÇ ÿßŸÑŸÉŸàÿØ ÿ®ŸäŸÜ ÿπŸÑÿßŸÖÿ™Ÿä ÿßŸÑÿ™ŸÜÿµŸäÿµ ÿ£ÿØŸÜÿßŸá ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿßŸÑŸÜÿµ ÿßŸÑŸÖŸàÿ¨ŸàÿØ
// 
// üìù ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ŸÖŸáŸÖÿ©:
// - ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ´ÿßŸÑŸäÿ©: PNG ÿ®ÿÆŸÑŸÅŸäÿ© ÿ¥ŸÅÿßŸÅÿ©ÿå ÿ≠ÿ¨ŸÖ 400x400 ÿ®ŸÉÿ≥ŸÑ
// - ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ£ŸÇÿµŸâ: ÿ£ŸÇŸÑ ŸÖŸÜ 500KB ŸÑŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ≥ÿ±Ÿäÿπÿ©
// - ÿßŸÑŸÉŸàÿØ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ≥ÿ∑ÿ± Ÿàÿßÿ≠ÿØ ÿ∑ŸàŸäŸÑ ÿ®ÿØŸàŸÜ ŸÅŸàÿßÿµŸÑ ÿ£ÿ≥ÿ∑ÿ±
// - ŸÑÿß ÿ™ÿ≠ÿ∞ŸÅ 'data:image/png;base64,' ŸÖŸÜ ÿ®ÿØÿßŸäÿ© ÿßŸÑŸÉŸàÿØ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const logoBase64 = `
data:image/webp;base64,UklGRgynAABXRUJQVlA4WAoAAAAgAAAA/wMA/wMASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZWUDggHqUAAJDgA50BKgAEAAQ+USaRRqOmrisiEelZwAoJZ0ndx0o/xifu5yAPNgA58HlL3J57kMop7C3SuN5e6cO/R0aGabRL9O6mT5YP9z1R5wiI3nPy//vXxtYD/Y/g/8vPuv0xOrP7XnW84f8f+1/5H9ufjD62f0f7BH8W/nX66dhX94vUt+8H7ke9l6ef6Z6hX8h/8vXG+hZ5c3tGfuf+3Xtj+oB//+AR9y+fP5r/Wf8fxv/L/vf9z+b/7y/VNXF5H30H8z/z/8l+435vfd3/K/afy5+Zv+9/m/Ya/K/6j/n/t+5Kbhf+d/2vUd96ftv/J/v/q694fVX+Y/d/3Bv7n/ef+xzANAn9Nf9j/Ney1/7/6r/devv6p/+v+y+BH+ef339lPbb////m+DH70f//3b/2u////tFI7/uO9fYl1eISvXSh4myfhwbZef+Tohb5Na91qLCtpBdXh5OjU7kjuOJI6Lzk9QLzO1JaCzvvCXxuQLcXzNer5qYmk48PeMKUJ1AjebDb1j5vVVWarQ1se+afyxTp6w9T9vfUa80Gz98Amycw+bTJ1Yf8Z2Q2XRga1R1xMOCRneXBeZd/Bo/QleUW3lXTPHxaEhis0APDmg8WfKt+xR/z7cOR3D4iKs7ZD7aRloXIebJOP5d7hC/KZyKGnpsHl9L1Xtmjqr0yoMlRwvuGOwjInen9+Qjy/kkLnc4bDgkhioBq2+qOCOm6zv0mwtd6KgslJ6w4MY4MV+vmYQGCoJTCOjDrH9AzWXc2wFCrMX03QrND3cuRpq+EijtofR7egak6JPRdM1s/GWkwxW00OfdDQg8bmKLO4U5p9CVavfWSe8b3dIQaFaviEWjYYk8kbsC5ZaQ2sIk915nvPm+S/OEH/gUevDd6lvXfGUMEYTYAB9pSDj792Y35+EBFg8gmgMtYDyeja/toeD5eNvfiZp+8ZohieX/ilej1FicizxSzKoApaEjk6/eNWFVwLMbi1bCNVNeGlA2KJq9oKplw6tg/ZEkpsSPw5/dAlSRJZoKef+11DSCdKti+3krZJPTKgrJXsxyZu0SkNHMeShcSK5c+qY3EYvVBnYtmFgFN5fM5tgNGY0ZhZLbf/RxjG4ZlsaUvztgVXc922AeSFgSOSBK3InLKpt0VzAKGmJpZpbkjFU/DwhqS4EH5XvNtthTMr9Oz3xkv7QJqVlVKs7DDhNGj4s+41VL6ofNS01WAmYgEpKzWovIiaI+vwwF953527qe5LuXtiowCz406XiUwU93rmpGejV4Dw3fTgGjlZtc2qg1eufajLoM5wlz//6XLghpHU32W4EKYSHNWV7gr2ZNaHIDct3xkSBVlDwuOR1cGHuk2D7bg7Th7InSrqFBHWuyqHsjnwQ2vf6MBJlgPX/vzE0n7tW/gefuFc+EP3igKJbmyunSbHSwVmWfVCiVLuVuwBHrEbdc0d3mrlkJX6p/IQPsIunnsOMYQOAmbuZe3xxEdAifSxeDZjx9QielW79W3Vb/Stzay/EKx0/dHfxy8pcNJpWITPHPNzrLoYGTQ20DO7vWoG4sKUdMaUmGEXCWHCTitbUKci2fHRWR/xCmzJoWKiL9Rr9UNoYenvxFIL/5qKNsNUR+UJFydMV3fuLzlGQ1Kp6HRmWWKUiJEhCoM4RQnfI6k7qr0VEF7cpr1MEaoy0lVj5x+AMw6u/C7WWCyh++1S+BktZLy8agB6b/A0566qmmXckS4TBVP/G+5SFzdFtkmpFBlVCyMlUQWWVRuZsJJP+nd5Jy36awXns6HQpNCWfuX9LPdAKs5oge09Y9rwXf7tVTfxkxowo94gxaFlwYqhDTFnMDR0vkxsJuw5KCth1P/Og2nogg8Kn7vVc2qSYRE28IRlhVINZweHiCHAUWPUMFsV5/MDvU0kNzwbFpKFK1zmbnUxhlkz6N09DUg8/1zRDSh2HAAeV3i94rl2HxwguarBXmzryDTH1qz0yU8d4Z9zd8vDLcomtWfcKL4m8T0+HoMVjRpvdcBTeJLKe7iR4V0RYNvucwuU8JDMC5xNirjkz9iROpK5idfTLRgIqzf+c1/+pWV//fLjILC0TGd74f3/4zsbGPwh3eKMuHie/JsbyGcHO1v0yW1DpFl2jHJ0MTexh5NSky5WVC6uVL7UOvXZZrZ3K4EuTyHV/hUtAzgron6QWoxxBXtCwcHO9PiLPkOnm2nqOQMPNkiswjMRqcYqqb4PBu1wFhYmUCZxTTnD5K2cN1hYQtd7Ysnp8x0KiwhEF96ubw22LUugHUnLnBWKsgyE+jmXLRqBB4qwYaD1dB1f+Z97G1/vzv95QbzPHFLlmsblNc64azAZDwiSDFf+egPXOAbmWZ/mblej8VBMnh9TyrgAVWrd5D2e5i+qmRnCWmLnx1mA7+Ncc/h52EZOeLykRv/nKCJy/BruGKpXw2iPzX+xaV4VmRqb27Y4D5tGyUQLcRuBTi8tY1lgRUC5EMOUKy0OKPuumZJKCPvEJ2fBdra6bWsyNXoaw/tf7REd9+1tTM4rYVyUXJ2tybdp5PTyFEhbipWoR6L46PcGPoTcVShzS3S0q2Jtg9j/5tI/k0ZWEkwtFzDGEp6jB87j+gyfL5oE5rvBthU5JENUepOb5V2TjcBkRuDve7216Iec6PYU3V18CT7UcX8Q1FjJwAo+6B0t7Sl0sO7I0q+MvIyffrRY/ZPTW11VzbPNA5kdKSfd9CqsW0OvVQHtg2TGZx2wKwjfH5Qg+nvtFfjYjUClx1pf7WJ+lowb0/8hoVbVy4j/ekeuctGkUx+uIqOkmPAvjTdnyXdF0gwg9l61tHr2DKYSrCsHbajfaYpPt8E6xdbo30wGnNFL76Vyp2//CFrSPRaEqYjeLaaTp0BT5qCC9ayEl+9qmxF0tUBomQSeEQMvtRLnEcgecR/Q5NURlLRepQFO5ZKSY6mGlfAXizrsvPCxaGX9c5x+ZKGBgQi43ZDegi6PSJMDd6oSswNxRG6/7jOpbFK5pbCJUFsm9WGSgFCuRSsQXy3kP3czffMBGx1YxJJRkCAvCbLzljCp+E0LHJE/7tmZOZcOP9p36qtEVDMrEwBAvvQZf+dNFkmhonCgBYRa0IhKa/z/d5aY5XUWjgfBdXglmclrPr7J/oyzhdBTV7hGc+pQWaYdd0hk37azOEb+A3hf1Zw9QaE1ocY7AXoMKKzkANycsDTCdTLXwds02s+/l1jMJIOchk3iKn/ZJUMPXfihMfsbnygt5KkSg8DRqX4cf2oVxgPZN3QVxwnLmc0/psrM36EOBNdPaSj21peVyrsmNlYqb9/U9ofvECjTaIEvFQHpUcdSgvdPDC6h1MldD9uk7w86F0tGx/x+w6BaKRKPsIrHFIAWcHTaTFAAdjvI+dMpqJyizE54w2xWHwD/a58jEfUT6Nm2gHRP6ZMaQQj9QopaFbzVuJ3qJgsNPijr5/hKCxdiSXiJmG4IbAUCVwoC/lHIWH8Tr51Ssvo3GPVC0WGCwJRCA0OhNQArOIHGvO9Miz6E8sU0rWBzK/SPa3eknqs5RkG3UAysXZiE4i8yO1xSAFnlchDIyP82TZQazKY4Ibu9/moheUyJ1csQVNH1nPJa4ZLIP87NA4C/GyHaYXfQ7z3CeMDE2OOnUKaYkgIVHIhAalwe8wBvHYchVJ379/+vq2bUD0v+e2tQZl8FJVhMtWawg6n5WpwI/FFjAJ+hVMOGgIP/i6ruZ8naRurk5GlUQVIWn9RW/nXlnvWQ37MMRI0fCGFJVZSJU6BOegCdwVt3mYyaS7WR4VRg9sVVXBbciGUifY8Nn5EmUGOWwLPJTaUCGxJWvfP1WTcL30fQmva/wttAs87Y2HzkhC5UYvXE1ldpG69Y5IwVvoZOJbR/0QBvcP9gtJf2Nl68XcxCvJU2c5cLmC9TX/0RRzQoGLnb4mLBhh7vJvfJaFkF2agou6E9x5Htgmm846u7I8Dj1UZtNQbvyZ3ij9OWgLsaYnjeNI/FP5Eqw/+L43kh4z08sw6PfQAj3oKeaO0AHSwdUrU8lKCWmTtXuceMtin/GX4W6JDLk8QtG4Odgac6u2E5ouNm16h83nTz6VMbM+RjiUoMtzAN692NzCFx8W6/+42iQrjrISVA7aYhTWyIolSF/LLEOLOCIVVbFniiBsS/EjgA9+qK6lGbCnR1OhKNDmMtopoGf6Ph2BvvokNxMpFq18TnwJ5m3MV+rLRcNUWTHMvq/IebtZWvfJrx4MJ10y+G6thz45v04Ott11a42wX7p/YSgObxNb+1KsC0i26qtvqc25CJRckfj/dX+MxX/zffbsaOkQxFR5mOjeiVygKZevbPGW2u301LvUfQm215n5lLPdmEpZpg2TdMdnDh82uMBWxX77XX9ibLjEvYcrxNba6ZU/CqvvvUZdwIE+DXrpZIX4a++2Xl+ZrurSl9zanvD9Z2n08EvXsprNT+DZyWzygiR0nMYcIdBpFXE9sVj/1rAbV9zbDbVtjATXo3pEGuS1ulaP28INXJ+6TztNAIGoTpHf9u52FJ8lbSa5UqzImDr18wobm9NKb/biJqVuGHWLOpZ9XUG3qtuYg+qW740Xx7ebXL0v5h09bj0o/5kUQALxKuLo9rSf5Rhu+9iPWSuWzH/IK3F4555nFv4r1bGw9W8gxrg31N4rjBe/40Dau2q4RtEi7NA1woT43AW8pVg0zIa9BhM7Hh2LqLtYnU1goNrMeIj9hnFwRrK27rL86I2WCvRvKT9rywZJFumPVw8aHU6+F+EP7WDeCNLZZfai+kf6cSwwrr2YNC4wcdD4s/27ZuKSwgZuo4/LKmpSMFYcWPhTEzgW4lCPEpgzU5rsOFvVTXTYGqH9wabpAP6gKaFM7lcRDOTcmNmc13evEqTwccrLJo8BUWV0wCu0JYRzXWjqJyjCmQ/OJF06SpXf0zv6Py2DEh4qAYfOsvPYP8OuKZw8MUP/FtASuiYrOq8fgRpoIqGiEdt74ueFPXxTMVCO3Xzj55n8LY0YcNr20zdFKR3Iiuq7f7kBZg66zeVoWHI6/DQx8iUSWDwKJSmIYo9XjfmV+3ycCcg+KX1gPsXyRFpUYnr6ENwdV2O8nryiVYQGmI3vfxW5u9F7fW14IR/ZnuhRlxrUJQMvfzf5U4mcMKHg4dTBiyffWxerSIj3mBBkKw+4unKBmDlwAzTmHAsOArYCv3NrEFQkyUd9VDQfXh3mvmpikI5MzDii6b5BnIvjbKSqXztq4n0i5wysxkA5QH8md8qpwQxYmrn2rUbkw9hLoqY/LJ57DkVdZ5YnYh710xvRMpHGJPgOMwBPhaWF+ocjjJFJ0iQ+ig6rlopB1ayp+cAMocDlzsU4+rkyLRqLICGWevhg3Ew6uCnYgCnVlF2FT9eCj2Z7kQUihZdHDEhPkM0bveYnRoAMeYPYiQAKNy9SteYJ9J7uaPDcXw97usYXGzrPiZRQz06TZyxLzyDcji1HsdqU290c7f0Pip1HkYDpS8B757rdb9rha+Q+7Qq84SpQcmBF0rNEMuiRPNq+a2coygGMVv6ofj0GS36gt7UHycH7Bz0WYxw0yzNMYbQTDsPs0ekltnZk1AWSjKbPWO7s5gLNYY4zhQDmiBM2oTp53xhSLlQwqavhEzTRqQ2vA63KfRZt5b4j3H0u8P5sNi+mevtlRnbdr/tgEbB63/zacLLsMN7ZuMDHNpWI0KtyCsb5jBYrAg4ZNrkAYautbHkLkFPgFcr64wRqjuEDWosCxRccQ6gh4N5pxreqlYzi8XfYc/OTC+J/DjBrAfzX0Y7F0qtw23kqlDYcWZKWDzD3hqoegVv7mcFcYcT/9koLsKAoBqG5eO6ccqtdltnasb4mJTtzl3YdjWx+EgCLp99HVNRCe6uaAqJSuAuxpp0Mfpe5E3s8j3m4UyB9gqUJouP8SHCbGZtueU5jPh2vG95Aagyqn9JsWiIF2kbIFZ5Io6S5bPdOns7oIjJEG3QVFl2G1mipJtirc4CMSa/lxAQTtlmKvweAk0TVVD5VoCO+3nzW0z+JW7EfmelDytSZA6fDjdUK1X7M7Z9Pk/JUj91mXqNNfuIE40vY90uttUqBGFPXLgbBl5hMAohBewfF8Rcp2+dWRMuaqFT+tg4XqmevM9Wey65oDv4jMhbFPiqRq/4OmGKl1CE0TORlrfZ+ghTmhzk/rbOyWcFkgzfz2+RVDK9ixR0RXlAaW2VyNryfbxwtlZhe81w4MknL145Ar850WqqDNdTrXP0U0IQrSA1TS0nXDCr8OHfafFAKu2sQiCVJFrrtzu9UHpOrVzGM5JSLjrjTbZSqajozfrAjw6ppLPnPYyGju8bG7MOXLjkiK7MWNBX5RTPUWxfLk9CVimWMbqEuEippITVLFFunNQe44aFBBMwsnWax9xCAU/K2XwuLjmNG2+iCQbF4/sUUUKuOwZCKcFHevuKD0DUA8xeIRzfnr1gFWR7g4AuSBqpjOVngK9OjEB1BWfKkFbKGzxznwcOkQnZzQWX4AU8wtTOhG+tVyu6flV8IZHcGex+1g69cxgDCdaOQmO9GfS/6+o6Pnqs7qWzdhmh2sGIS/oH/QqaXcy3+L1gDrQCIYZRckHZxjQV9GUfRTaW19xRJ/pyaqOGvy3xyHW/xSktvZOSdUQsCm1WXXGTPyHY9hAME9GLklGCPBLbtrqrH2qDAUqlvVGUXGq2qt0R4FQnkE3PLAtiGRBFl+5DNw3nxn+oAy7mipZ3fvQtFcXddqWSrkVeT8Ea4FsFwg1yPZ015q9358HDHok4JYVMLVsrGC7toQtOi9OjoUP+wsN5JUH8M0Kers0dUwXgNkMw/Pymjgnp80qjCd3BzoenxCZeR+s83YqI/ayfPcreC7B6y9coSru4FJJbe8iRbac12PSPKMRBH7GaGLCyoAgn5xoeEMX2dKAIh6KbuF1QN57NhlyyAa/mxOL/49yd1XqAIV+2fxJa9mUvqiKw2gLpkzcnf87vJrjPLkEvIKeiQM2gmaXWMRVCcOvZMGADS/wKUbCZgbDde+sppS03X+R01bYWeKucWk6XzkuOZfbaSSUsP2Y26JD3hD1YeQqkjyQDIDwhm/gUKuYdTk3lvY3bDfiNRNtM9HydfS6AcO/bofQ94160l5tC7vNW6VBlRgSH2MH5c4CcUzKJKfCZEjYLktqSdDlQWEbSOap2uc0FVd/ItnmQoYD2QuhebsVt/m6EHtegsESNtiyxWnPr9Ny+Upd/AD/OktVKkGVpsPPKzA+pNqRa0dwLHVXpgX7SiE0NhMW4jhO9tP148RiORi4Vhschbd3ydGUATvKjp9++IAx6g4LkmScchIdHJtOR++KQqYAghNav02nPWwjUuc6++h9yZXzF/nsC1jXmeG7BaPTrR409Wm7Qj57Ar1nD0Af7q4R4TkiSN6rJS58D7D5pSXQhZwYnZKujrvJbfp8u7JCzrZIT4En+TPt34lRnggzovpXTnfnBm+SNAJomnsN3RGech10t6IERkY62QddqJt7fZp1ynKuJ8dOthenLmqyC73g+r6Gay9hMETgG1xxChdv48fkVbm849VvlFKKGrSxJtDV/Z1xB1W3wBGGWs/11T2tldvRu8HvTEA7RSMn2VnGPI6OWJirH29R5b4SLnfX2259Wj/GjCD2NZmeMotaVz8lURXd48BsjTrTm/K6zLubqFccyCQCHN3eNsbaNJBtQTBzmI/BjpM0s0TjiO9g+lbY7/5jSPTW6AAq6X5dSUFZXcm70pk9f5QxlklofOruc1FCpnVx4yp2d7K8SSZUQhyIehFFFEsWrngjWAPpp7G8sKtoB/veQo+zYU3l9RBo/EsC/WOti9x5o8S6ljhF2gEQyjs+uctJyrdbsv5VGNiKyGRL0w+32aR5AEttMZz71h+93Hm4QCGynO44jGlqqr/0sJ/S9zLoKKhUFVe0wMcwcbYb3S2aCysbNSKRLO5zi872v/HxRBdGY96xy0XXdlKnnQgQrYnuMB9s3DcvGXdwhlIX65wTp4f4X70FX8IeRsxEY4R1TaUdepoKioL+J59wVbXUOf1HgxdG0nawbb7U3KzyCGb7ZJSMgSMZizp1WgOrnkjtWFiAzhjQ3IHvcuZWKrbNB95pLrHXtIguQ65Mg7XdQK3sHI+8EPWUA4HjMnKpNn2NAaPs1fsCPYgAMW/SD9xRfi5G3+B1DYnF5DazHK1cfQKpSzXbyVCz0DMCa11A7fSj0BDs5yJK/Qrlc1gEk3VntlRoSQOncGfV6kyj3Voa5Ez7nkld409wlbgu3A5aMdjG7KTKjijaquNp8X3bDPzzqqSA/Hm6sGVrC8q7ztKRuXY4zebuLUI5q+Nq8OBuSz8Fdxk53+lPdlBSjCZ5GbM9F4hJi0smxNJnHphhnx0SkP68A1tl2TgqR/+sBPp3lXde+5pfjJHT6mDIg9cQe6mGBKkEJpn0FvvVIYhh0pQx7RG3v95FKMCz861TNLndRzk07AzPWfyDLTGNo3uWlbU0jw+ERHfMju4PO4dkIs5wvNWyttlh6U7o9kEbcuB2BCY27zKIwTmnoG2ZES7lR0WTIeSIaWQvIkaq0RlYWTY0WeYcvnks3TgiqarZwalSZE/nL/f52WbrfrxPCnEx7lqu22tfvV38nH3ZGkg2r6yb5dpg/Q+CxB5Ixth/ASnUEml5bNBCAAL4ISDmqZveSXlzuyLMaFEbv2/oAThCkTjKca7zHhG/fu2hfJ5TEiHd8+4DdcvUIFjTX/2UKIpckzNGJ4gohmyyW2hz+zv3hbiW5ftwzYC79DhkoxoMr6JEYRBxKeElNa/9pLTwtWp9YOPW2WTwRgLdiKQRP7Oh1baW/2S83jsOea0ybThBipJBKb7ukYUxhWpXSq4rbnDYbqvQRMrLBcAuNHqGUc8qdrrMBj7dua3v+4eMINUOF/KVC48p1Xzat6uUM18N9ekNrkQBQ5H23ccmWJVxSZFBt50Lj4b7n1hOUe2QP87ucRwcumK4/baI/ozi/umwCOnfKJma3fBcQ+cvY1D67JerKIKtYdXRAEDDo1UIsHqIBDpQ/ZGLJe0IgXu3LCFyiBDVI5dp0UDWKSK8s3y16WHvBX28qufR4dEEXnz2e16g6cSSj585ybbPuMsMrXg9fGrv4FHumyzy7qtGCPa7yqe8pENeOyWF3dRtxv7v1r/vseuvv5/vP72pDrnhPnnePVkn/2u59czMSOnYMhH08GmnY+IPWCk3XsYg8nALULc3HKoB6Obkm6Wq0F/FPcbD7NtsQmSizb7YkLBbnpFgQvCnKx2wQJUFxjieqR46R7fvRu6E1Hh/hBd4xQj/r5Vpk0N3svp0W6y8a7bn3/wpd1L1jM/KiWGtaoR737/cs+f/837zrROV7fcBXBZXyw+YJ7GW/YMdSvT9Sto7Dfu6UQurStBbcsgWglP7E+3LQOVM52TNNfiOuJ3uH6oypU4J/1bFntO+kBPoYzgNH3dGU6rar2RH2WFxG9TtuqoxFd3fljvkJ/mOUf+vp/YIkv/+5nX88KiEn17ZPf7ZT6f5l5oHEQH6392rUAO4o1HZRGC2243i7ljQtyXs14aRogfPZe9Yz3CtEA69DffU/OFNIvpYuLMrW6icAze21D7N6YtoFRKFdIe7E82fKTgtB93/Tuzv//NxK4yNCT//+4xpv//ruemOSiSeijXyikv8VptHaartHrvuPCYKDV7dZqgM32yu179gSOY2vHWIPSwUtFJkgSg4ceV+xjNEx1n0M13/64I2cTIQlxm+f3jfBHL5f+lvJG/nMg+LiBHKnlp21O1VgmKXk1j5G/vAPy67R8uYqc4P/J0ioRwP2LQ4fQ6SnpcaRp++hU5q3C9MORoEC/3t5Z+ICOku24TR8YwNQEaCN0fnNqS/+krjsf9p4+oTPGHnZUGsyDd02qYFZ5Dbe88LFgB33EbADjj30jLWpmb7aGtsvy+r+n/NfleNGFDTQMsM+taRgKVUFR18Ltc1GsH5nbzHdiBxxCGc8I6rp+WsGXfuj9WQFwgiQByKcJ4wnISJT+ZJZKxFcvlPiL0afcF0N1J8tqIPXPz5zyxkp7kh7+e/3AYn9TDxfAZ8GJy61GJnUM+iL5cURS03WZZ+vuVd4RAAI5tbM90dYWG9CJBohvvxTF2N4E7P3GeWzwT1hffM2skptSwbQwpidTxwoPqCE0hBXdRaABAW6GMVsLpn3Anuuhiq9XlFAsadQvB142j85AQwneQiREpHoAhjaf4zD3hPbIXY7o1rDDSHFD7b3ORYQcquGoAPypmmJZSlSn9t6TdhvP/QxdiTmMv8cQ+K+cbnAmi0OG/dnsZEE1OxZfT2yzthW00mW94DHhQLm2h7GIVPX0IOctOarIK0XJT5rRGaE+VRADx9dVgLtmlpN5caepgfOf4xoybO04b8qqrhWEzscfFmTE9+JsqX8izxR73yPyhxbdCIFEClrqaq7ujWsN/DIkcQ98qS+vj9Q+VrCCRrw3o3/FnjkN1CF0KYpAkxAEutTVdnl168D7IelV8vCX2CITAJrcdX0i9A9m5GhG9jn6sgTyeJeSpi9suCUmf4KeNQAjat6zZkmCnX3OdNZYyUaR/lmV2i+PSyoRwOxwAAP7KKUdQQ5vTsvsESgGFUad1Q/hSG0nr4rfE5k9d0lkRwXVMlfI0/zkp5E3OeXFha7KbrEUeEA9JaV4qqD5EauWBLxKpl7JxZtenWmtlNCms36T6ASp2qTWbwlhI9fAbNwsX45yzOShSPCOExagR9M1TBmVKKWb26pMmkPiAw7597vnJ7JJxsc9CmeUx7JnAFKstGoAKyz67Z4nM+e6E25V4pFdnsOLW3J4sh9Lje01ykpOOKjMUXz1EIEN3Zs0Zo4JABZNan8ECI7vd9fQkko+lo3b0thCLKvkQYJT/tkz1C9Tqn8x2S207V/rwMD5bmP0gAwEF02Yi8oQF65g5zh3PurWt3Z29efk5iKwiZgYwnJFvKfUICIcmRzDVs/VVkE49nKmjoYV5XuyeHqhru0pggDIIyJwP9jjBf4zi/8NcNXbim0A9NlrJupYNM0gaSz9OCE4cvKOKm2dWleS0nMnJuvz09dy0gUODmMAR4JQMmkpirDVKqUhYIj1XkPRiJSgvj84PDQ2vXPzwf0eMh7L2PT8EqaMM5ECTbsqNHre6zruHPG1HLqA7oOSX4ldj34InCSxT3MNSfaBG++57IRh/XtTyQH0w7t4T4BrltCXkF7Vl42mCHik1EBOPqdX77bDAQ2s1WmZzzhJ3Qy4tEHwadfV8CtJIm82wE+Yd7b98NDVkVRRHg58GO1P+gDqdbiiNFgk/3CGKYqWU/jQ7vat4kBkq5i0v0OPFPlZ7NsHtBcckGUIc7vVfN7GtrsxbjJZojPK2SJScYVigJ2Yg/I98tVF/K7aK285prGLiSAQIkBC6unoKi0jXrm88A1+JiFjCSkTmSD6dYMfx7v/kLGio3fnd5yKrUApcdOIXzm+Srodc0XZ5p4EdZwCZBv2WtMHnOZH4n1s6pge94IAL5FcGn6kh2AQV1j41vY4AKv1B61UBzj7G3SocWhRsRwrxClfpX30zwNrGD6FRx0/IIZyPz7qoLQBFvGj7BVpCJEnc4SQCtE0FyLquGuAnj2sx247ZVW9F5Bb6GeoXxJ2b53EH18GHk/jgMoHPyKqNsZqFKxrFvqz6f9gGjhjFjG91OyPmT1HddyeIXyImG2khmR+6PYUh29QK4w6LFcVJsGsWlrNiEhg9EJzH6/TctbWDrd80ybkpv+Bml6eSwIf111waoEBTUwadOEAHU73P4bi2WZkBv3Rg4rrvOadl/5nImmftZWeECbNwZX5KoWnPE3h3Tkg7zntxHfKmw9o+qNMX6AoSAuTpTn5M5ct4u6sub+xFl9AMpABdMdSMvovkzOQI+FRaNGg5inwUamudRzasP+di6Fbi6JxntHVK236Ye50a05O30kGmluz7PBOf2R/6y2C9H4nhB+7TZIHPDG1Hnmz5mgguzXwOEntrB4UvYCCgsovzLfBhsmgYvyHTu0u7RrVh6C9sZQePT1JnQy6UFC5CRKE4fW+KURmRMCkV8tkARL/ZjWSNpEevhP0nPxHlHVmu3XHpDeGnFG/7wT2mOwOvr9X1jaddrwetX1vFTmgEKuP7xSsn7+UYmAIvVvAssZrZsqkgXUzU+GSYkAJpSL+L9SuUSiGcMMGnu1E9rqlcH7YSY9NOn3VrWVzM1kaicb0LDCasDsWG2oo5WD65ocJVXpYnmaqk5ntH8/pzAUam1rZ1QTytKN5pjJwg8W5BSaWH2KITrSEJDe14rEguVH4Y+OaRApR0W9B+oETLxg1d6/0UjGD4BDvtyQzrAg1xNmZxjW8MograoX6PpxNIBUJQHWEN9mWdNQtU/n3ZS/+DTTylHbdd8BnH3pyq5LJxoZLDr73DpxJzt+EGVDswPG1rCHbj59+mL5rQ6aKy+eEk0Hp+fkzman3wAAeu4yHyn2p+nweB69KUf6IxpHfp5nFS3Wb9QgrhF1s3Kwf4/oitIzd8adncocSzoT0EmsBsimw+q0uT1sVRmBETfEysiYSR50xpNZGt7lBgDyOlwBCiXtvtXczupTgKg0yswxba6R5CHoKEoI/KeXLqKdPYwvVHoqA1lXjqojcQsEQ52QacGuaBXZ3g8hd3jH8BEzDC6CXdA96aTNrN0chuB4ieO11zee9pPTptAfHBkW+oOyNFgT0BLqt4oH6K4dsYEdX3AGDn+D1vB8vvcUppS2i4zHEM1WpPS1KVW7CEziUhJQ32D899krbl8xD4vYcUc6ki0kMSCpaTNnTEuVhUtgn8av7htwgcN34OUhiM/R2477/eOstafh4OOmAVMVYn86wLJGG2YVcn6PA7JWHjATMoUicGfW8/loJnJkpt563ZleDF8vO1FyNR22UlItCifTanxFjokLFxxRKSI6jkBArqiNjFRRr/W3RmepN5wa6OrUHheh90SoWHifDtodUp8uf3jgtl7DV24UOzotkwKOtiIfwAZoS/C67COmZCpIkvaySVw6OeBTgRDqoy+uucMDK+G29rLNgH7fL7nBLbEgZpapQg8bTy6w/TZU1OGyv7sQet+SSz9cFAKuArNDwohZJ7zHYVz/GpxC/IExLYnBRp663gr2e0Saomw5Q1DPxSZg5VYxWcXjUboVfJBC1VrdE9DDzCGcHWp5jfW7JTkvQk8qLRLYceJB+ami2wKWoR+xLbppSUqWv8oeN1uXKZNTotmp5GwcgbQBfnX0WRY0y/y3TgkJgpc8fCn9kmcKYHteozk+7PIVnYAONuAp8jG4Duom5fTu40BexTUdVcEjfw5nqurp2dH01SCfia/a/n7ecRaB0b0wEQKL5lj6TX5ChwTtccYfS7I2/YqeQ5ajhoCmJvpGUBOhCkVVI+MgXRYSS+0uABB0uTRAfPgdhvXFSgTc4X7598MI7Vu8bGv/ROUXAAmqyn5DG5awxFl/HF9E43qLd0umMb1wuee9qeafq1EY4u+ROonQ6lRFCQULN/i++A4UuGpb4tEoReKMB5Orh6ZazhSKUpnB4qi/Jyiyw9vMzpDB5K3UwcfCCcSq8B9cbg4RDJhB8jjgTbYUmA6dXBEGlrgxI5/HLZu3t3f2uKZz3ekdlfRR1Z9gsyEj0DM9rdXYoviaY/btMBmOY9pXa8KDatuCFwlkebq1dl6dK/aiF2T9vJGXMOW413lzLAogIMBDbowpWGYkP4M24e9R69JcGdYsQEQFKDChv+uACVEjEbQruBkHQ0CfiUTySQ+9M1G7wG5YzjG9n3JY42CGk4WPdx3ZKbcYubZvQPKkDU6vgmdC5iF2Li96XbnxkBSuj6ZOXT9huYOSvqZsDUNefNo5JIYWvtZqMUZe1XJwKdH1SOdKFLXlNuINskYc0dNx/giCNyBWQWSq+SPaUxjPh2rcvcwCprt0MYGnUCpJcyl0WLRvqYYbW3I+ygOVOYiV9dbf2C5Tm3OtGK1wpcJjdyDnyxzO8WcI/MTG3fP63K0OB/x7wBvu7ndA9aTxf4D9SgGIO3uQ0XYeettUgtLlHwseR2ITF5EiAUZJ2E0AHIcZjttEbXPbvl+hKYFh6q19MTuSvOTnmJhk8LcNTc+Bk30Wyp0snPZ2fbE8DKTIhbdAPjRTR/aBjNv5Vvw1owMP32faCvg+q0TvtLrAneuscVjV/RRbtJZPmc01PYzrfZjTWjTJUZBXVVAVXJ6bQQhZyIRjR8g5gUZ4CKbMstj9Q6VIJY2U/dlr1C4cUwRpjwKV++6P8fnwZ9/VgshTBVG8k7DeYCHTzZKm6HN0/e+fCQs+dtCscXxF5HmG9jZx56GWwC7VB3XosC+ux1kL1ihOtQ/2rur0eb4UW1ev0GE+LB0x8+zlzbDlNbk+FYR0WQw9G8Iic7lk89GTJkSstTqv8xaTbutctZB13jPLaHNlBoWIvYhKQ6+3sHEXX0c/QYVgNu7m2epM9OBsc/jVB+QNHp2VOgHH8eae5KPVZPA9L6mJQfrcKFGeRlZNAN7x+kOsMbfPbyw2Q1dVc5de4tcePERAAewjJZ8asRwzb9EP8fWhsvdCQ0ddSXUwm/xZcCcNtMf5JW/h1XEw42yaOhT4V5Ry3INQyYy6oYN/etvswEQdLCVpBC2aq8574oCHa63Re+4Y90jWGozt8b3k7p249n4dbjsa6vRZqkR8cJMYK04fCl2f/3nj6M61gqv72XAT1OnOOmpQstbr+p+NnsYeGDlMwaqcmET4GMs2OFqsL42mVrGNNYcPSq0DumTwfAdqYnm8DqWs0x6tbmTPTSQ7kxjB3ctw/SppC7eJo0knnflBM/9dG/F6dOPsl3/Dz+6RFJqpXL3kEjtSrxHoYl4F0W4FOpWI+3tKv55pRIpguoR6rtU2vOqWmmfwXyO4WSFPha3j8zpzi82oQqB4+nB/vwX8k0RBSuOLJTv0cHODh0XHYuE12kmVyA0UaT4FZTRDv2zVtheoi6TCM2AVirBk+ISrq7URnD+ZNHzPm/CLDnwzIEQCtp19FSWhLwDjbnJV6F/9khIILOF2BxQUpyaqyU0WFL15UKuXnmkyRSFV7nRNhmHRntNEOfrlKlbkSh2nVH7bWg7dBcQK1Yg/Lqjyyge15ufMyg7usiI0FQtzD0VNbRYF2oY5qe4PjyONqaZ0ShfJHBwpPd71MiMUXsEJVG1SntElupWMh6cpPeA17A5NmG5Mfz5/kMxi/2Hy2Jp/xWCqcbyyYY5Ct/EH7bC/Stm1fBnQN+j1B8RSUvEtE+ZgUPCVCXYEQQ+aKuAn+n6Vjfl77WITDaSMmz4LpAwjKMBuZSpVdKM/ywGXaK+Z0jAeYYitvNYRwnDQ2KeIYqQRNmELCgWbWLR5bwuEYnQPyI24Zfmgzx+ey0CLQSoB11L0GqFo7f8l+nLwy/UxTbXumHfsgLOrs6OZESA13M2i4PlpGlT5/rSwyTPp0QlavGFMmHUMoKzfnwrma4bCCIEoVBeXF17rhquAkIDaweShXg6LjQ7o9+2sVYiEmHCnmjS/vJ5OVruOmbmyTZIvJcxyZIVoaXx9saVlrNfiElLyCeQcuy8xcvQKcGapJhfqRIORyDPnXcXh0JCSzFGsZgVa3bWb00Ccvr/fKIxZbi1vgcFiMYmGhzeLeUlyL6Xshs73VCvROzO96FPGeSVQSzOl+wrEv7obxrtQ2ZdYP2D60U+588n55cGcQd0t7fFKiiVfOPNuAQL8apLU6f1yZv3oQqd0w8nGFFdeunTQYom1iquzONcXmzRBd1sSVLZ2fdSw5pLbjIaILzSXW0+I3TElTm0tYPl4nEPQrtYImU1/0BbtqZjeLUO+aZgiN1XixewNlMmLw6cCT/OsyeFDY9V04pLuEs72xi33GFLQjH1bl81jeHXbvZxH7fCC6Y98t4T0/FMPSfeApUAeXkI
z5szGRfLSClMqbWEq4C4f4JNt5SChr67ooL6EbnDxqHov+pS5Wv1PLy07E3MX9t3iKTRYM9aBJw6KCtG2L5OqrMC/Q31RMDe2fIjqtE01m+Srn6yorcImpMDJlnSPNjVYu86Grnf9RAqvHrc1VtKLIvTal25qx9lt4b6K8kUgcIwbmt1c/DjDdnQH4rBq3nZtlQq/xseihkl8RM64fhtZV7MeWcCvoLNMj2JWlvxMBXO/uykhq1fzUPm47G9t4Lz5/le8V2KsyHcS3fxHJwvSccjttSEGelbjjm7/2JLYo2gli/1gDBdXo7jh0cl8g75ZdSnlLPOxupRX9HyFyL0FScGnstgH8pCHyEez05hxDwori6UCha3mhFOlL1aAdQdpwCbE0benKEPrhvK4QJrVJ3ykoc9qIWKs5KncxhV9LNzpULGnj27RobHk0Zh+2fC7xmTYSIfFrnAkf5vkWGgCJdcKf2HtuLY1sFAoba+LM8f8R0mBiBcSCEeb00ly4hNlAYsp422qfmOSrulzLC3rObWB3fY/MLt0e41UeyhRRTNHnDYu70gJEJyFVUSOW7eYh4CvsqZB5wiwK09cZIazXBu3aeQnXUYKC7dJUxNn4v9hqzZUgsuuAiF+vnFeggwvRSE/vZGoBS3w222DU2IKlLwrvhpLG9mLirbmE+SLIGSUfVt5WO01avOoufHLY+a+cp89pnf8HaAU49UIrBUwDiX8a56ufYU4RNSQHshC87NrGFf8RAWQ4vaHbIC7dJP5V+DF+C9rqebUJjNVQNtdADL26A1kA4jHaQon/X04nlwoa9m5a7yme4xVdf5GV9FFRctlBPue7peTnrHx22rWa6sROB+d4Cm76U7S3p0MDNIP/EAWfArcCQvEOI/rT8EWNcKtdAOWHAI/BQUkrIqg047kfCy2juC0y58gjYOYluBN1XReBoVd2nPqUFMJWBPxxZLAW7pCUTwbC0V96NFjxG07FFLNw7F0fsQ9Zd+6GeS4oMURC41thdjJIhpXN4c5SXzFpxfsOcT/NwwUIgQ832IUf6AgD73Oi8aVco61LIliVo3IicN+oMjBEEnFHtpjN7bKFw0UOKNmnRYzOthEnUZoYTz7ngoCkIHY72QIDz4CSMdkFnKEipxpxUWlHpF0UO5LFBQRPipYf5aMkV+0CWGrkMKeQOs63iNGHGjhUitETz3wxQI+Rsg531rrffPxRQZiUcscK2t2lQW0llBn464UkpporjwpDxmjjEOXE7OuvAihpdstA6XHY0AZXsThKkrXrLZces2odtFQx7HVt+PzAsPuJI9wb2TKOwJif0GSOHzn9cCafnpYJToVHgdOlaleB8XihH7NofPepyGx9xvtCz2k7e8jPCfLpSwPzmUJCN1jjhM1vXyzodCwIP9jqFbRCNppDHlqavfjHlNAy8azh8Tlh8oKfs4aePzdbeVJ7S5XFjQtUjpzV+kKU5hAsH508VCoABFN88TS5sxp0ROpTPLuunorvweY43tjVcCYkng5AR0iuEveqag6OMNmRojFARFH3r8p9n7D10DUeY9p/fhB/AddnUV36iAvjMRDqGvvO0XNIuXzFpjNuzTtwQVpMQKab2SQLSZQCFpWPxVFngu1UR98RrMBx6Wf85PPo/HL/n4hm1pV7Gjec+2XNI4wzT6LWUoJ3U7+SNAUoKtJwaqJ7GT1tbPNFnNUI2mfmMoF/El14mlu/AQstKOvituE9Aggh7Ber/Y85/TgEo2IV7bNEe/9mo+REUJpxAHxcMdIM2VwGja6EEAw5adnhM/2y5So4zlNGHWubAXS+ipnaEvS60gwFlOB77m1857NRL+KNQjJc1mZukCH6qlkLnmiDB/QftYgO8tlECtPPPfumMushM30rjKv/PlDnQDCunu8bip7LMP1YI54D/lImGHcSTEkQuSSImMvjdKp24m9YakaHV0DoPId0REHCj2fFbdDR3EQZEWAHjhQVS1pBL3iq0uqUyKUTqTMAiFrvZSL3jVmNU/0NqRqPHBN98ESittwOLuNR+hg7ClRy6X6D/jqJml855DzZBVYlhHp6/eNX3x0ZuDE/EXaIhKkvwvX+G5tTMwY4u+eKG2b/2ypY22AEUvWejPc9n07DNsaOBUORXleknkR4H0ecZhwF7rAWqX857STupjzxPZBT1POO4EOZtFDfzY43EEnRmB0CG3gbMI1+hm8cOELarE1hWK6SbJmWxGbsb1veJkZzmZtdvBfuEZbEyFXb7zFu7rnYqmjkSBPq3b/TItmbdc8GRWZNGHf7kVTJgs8EAq8HtNWf2g6smPHhzS4Vf/VjX0DG69c9hMcPyg5TCEB+Nul10iQfmWwwuaMNgZ5BRptD7TANI1Kfb29asaSWi4QK9BBRi0cL/44zyO2ypo7s+9nYtAHUAfn5MNi3US2HkttYiXITIL5eU3hexdO/BOOx1IQrndQ18oS/oOsgzyfYxuluetUdqRXYzNxbEX8/KhCbFHxEhtU/hPKbwPwwMEIuo4e7BxF1PfjFvGeGyDciSgd405uoxsa9UZ6AXj8eteLnfsuHKhdC71hoKfnfv4wEXFFQGiMrViTspnJ9h/3aHExiKO+xnl2S2RQnhgq+4I/mAiF48g1NBtrdG44LYd1Ee5p1c3cj1YQAzB6pSGZAssqcVkuDfNWpoh7hK8e/1IlA/pj6IN0Y61PfW13HFXtmRfid/9LE+RBeBiA9l2KzmQ+hnlu2p0TCbWAgoJpXTBmJk3umFesXEMaJUiLv8rUc6ZZV3ar7jQ1SOxxUquIovDKvmqDOpFHu2QC4EzcSQB3Nyxsg3B5Ig76pJyjT+7QlLuTVtoPJXQXzgQvsGf8sJmqH1n8O5ckmedTe3W0lIeRpibScz3yIl2WMVCwedhTVxUXqVsZy7Yd7fwr0KARf7UuRgfpXnqwYnjySkrtG8B1jCZo2h5RKDxYPDrjFK3bV4N+3hIqwVS8LvSjkT1HAIvZxVcnaCFW/1n9DqXkaC1UAM5DixM0MmPy8gWalj+SIGlw4PdWTaYbNNVsPAX1Mixb9ktQ3UrJaQuc8N7f8j5qwbDqQ+kypBYZi0mKHfCpk8K8gpYVBxQUt15iG7S1tWpcOb6TqISXEX4UM+JsHEsivDU02/Lsv5weveqan0UnDqYFy50DHh3OUiFQ5uOU1dN1/kAuFXQg8kC3JzpVx0uX26DNNZtN0liCeAxDCpYrT6IwFsNwBUHa9jSNjRq5v2ajLL80N3N+SjEW41kE8zHPbmqNMWpv/GwWlRk2FnxdyiUhb9r5C0G0b3wWsI+AIf9UXIg2YLgSW4FRpAw5Q5rOj38xITi+CY7Pwdd09a1eCIuNcqIUbumw+a7zG49BYihI7HoWjU73eQXMcSdN9vcGJ21nhVkllL5WwforEhaPNT9Lj4EtohW6ZDMb2ZGQph80I5jKPTTZf/qRKcc2p8/CRWX+KLdBJUbkdM6A1nMe4xyKYoeGhlGl+YWU/HuX0DW5blshoIdqwUhRa9H7rYQPR8K/r6FDy6Sk+Vxr11QJSo+GJRLC8tUHKjOjjMP11LxFJsdj78yH6p3z/HxytWkHI8xXFJyulk7s2t1pUefcxnSTya7RewLeFEtom/zZeAyKEWL38CBksB2HSEaqi+9/vFT5gfZk72fUSmQpFhfigiN6JrZM9NdzEdkraZiLksP9t1OQq609UHipCNavxRNwWDJmPaSRryQ6j2cy8otTGnmafnyhbZr3HWW7PDzz/ft9rxj0Pfxp72AWI+TzXN41AKNhmshxg/g0h8Aap5ASur6CtYM7dXj8a0exGh5goxOdBP519FxqmqhfEhX71zhX8reZA4C2coeU/a1cc0WUDDaAUjYNdiEbQMr06WUyy5W0eToaPPbl0GYiy3DvMvwVzQD0KKk3oHbJIhGAdlzpxRkMPw65nPwSESiVm99HA6w5+M2AnMkYK9o6MORIMFdXsHtheSQRbbcfZ3DDQoBrV2GenZGmhrvvNTev4vhS3b75Lv0QoRup5HOIq4pYEIIttpwVJulxhJ2sI6DHNg2Z/E1SJCofRN/gWd0KYZqBu5deiqSDA/9K3VI30WPiq6M8q6RpEFN8Ygz1f6FFVXYocUaHid3CV0dSgxCGBh58GxlD2ob81WCQdc3q8s1AVMgrAx0p4TyVnIdWruR1JJrfkOaVmBcYRbAZl5JBDe3/F1m3OeMhytcPSOgK7SldDdY7F7wfsIS8wZCJ7iDuoXkXMUC5KaOyPCy6xb+l/p4q3Zvj1NJbcu7hIuQ4LWrF0sj+GNcbGUEXgm9Ml5wgrwEmJoWj2+AD6k6U8rq28a7DuaObUQWuETCk8RDGW3OEu0vCZvhnEwKrKADghKjV7BXcdKTX7uqikkXD8rAmVYx5A5wE53ivfuLDTSFXyZFeTiC9rO5UFDyKimulmeSGj6gZCMom+P7up7cDnFTs29YJeDE1PvcTzd4205t/zsb2BkMGQdwczfRInIlAWBmznlw6iFgbni4l/p5CKgrrL1ogp9AEMdWdYm7KPDdWuThAHDyoUmzQT/bOWZnUcbjDcXZzvXwIZRtx/omgIZl0ubquMGFli7QqjDyLY9RPdduwJrgxR184iCunckUrU7gjOJ8AA1Pmkd0JUK7xp6dsWCv+qLEofwdJGOfsi9aBr957go+AeNwX8lY1Z2AS39XIlPsIdHdGlsW69oVWTBjSJ/jyBHeGFJAZxY2Y0q3KYEFgqsBYrgeTJ4e36XyVgHiNEMBwcZHw7sFVncSExiL7uS8D8zUUtrPZe81T5SvGljfZWyfoTS+vu2htNcx2/sLY5t4J8kz+Z22JF2RoZQTbkmhYz2Vdig7vI62WBbHkBdGX7+bYa4UKc00glONexB3R1RTULtt0/qA73Am2GVvZ0l9sqcfwh6Ov4n3B4mR/M1b0Ud+7XLm3XHtgLPATPTe+S6geT2LGHIDj5XUTiX+IHJNRK/HyqVpf+/qIz/q+73L1B4g83V2mjg7sNnLv/f2waKRwWbkKqL5KjzphSyTMX8QKZ6+c12G183Tfjgfp4c1KgMQuQXcWZg/DLzYC/kL/182kq4gCUR62AXOF0CL4N6t/s5m5lAKPU+KJ+2mFqjyK3CKKDg6o2pdSj1b5+SvSO/uSCFlXv2ka3U6wWFnWpePXQstzp839dDX55bjqYF/5aiucOWCB+hW7D1ekIiLhe80wgAxb4T4iugPknTKJWXCjt69heJkBA1qSvgos0055GrNCERpOzMaYuHh7CycErX3yQ3UkYtlpyFHgLn2HFFRyGlY8H9afjC0AONu1iZTOIKtkfz7X0alJSgBPlAev8cwv8lp1AsUR7W8vkeLWVHJdrYMlxznkqvv6z3OpBmOhx+Q41fUWPIKZ2vDtqwnrPMtTPWEUySk03X2jAfGgwxaq3rnit9rifOnqVDefCN7t+PA/6JH/5kMQ/g5Z29AJfg9QEyeAt3k1gRmRfnMLMtUFJPpFMVktJagzdZ0kUG8cRoBtKvwhvUlF2zTdo0rnnlKU5rcGpS8yw6XgrgC0WGFXEpJuFz86JPNytZ582lkfHbW4UnX+cgTWnqWFH7r4KkDWzAB+VA6WRQiuFFRHdlOl+KAt3k1UrbR7awoB2ZrN3hC3brj06/BZWCQWnLdBabzQ1AeGWyYoDOsZgopI2hEAXj3akVjeV6SLJOsDj1A6UAQBMRxUo5X++29/e8WqvY4yDvXuEPqnx+vQntRmxCUXABm2DE7O4+R5ejSr8u3XxR0XzvWJzBrawTfSljC1afosAj1xLP3HHr2lrUUoxF6ch9D2oQzNTsbRVYlHl+hz+TVH4s0H3Y/LXWkRi3cEz9hP9Lb5JWWfqSJxLSLE1herdJHHHURdjnCanhJl6kQHuuUh07mrDy6BHp4sp78HPDdBUuWfh5EA0LI9qHn7YPZxHo/FYsrcWCiR1KuseIfCu6o5HdbTNIA3qkHfNFCB0WfBSSRxzG+7t/JSGrjADNC9fZobdagyw4TJiAtPp94LmrLbKoCpuiCDGwAcvOVD+HYUUixYwdwCUVniyb30sLut2NnBVhlrINjEHrA+GINep26qKXfyAkHgmEO9FFWsPIAtaa+5IqEUeOL91AnAkTeBLkEV8kbGr2nKGtCjHWuRBuHGlfClDRgOGBD/Onpd1GkHt+IiuKowKpurTU1m/8sRmFrDbRmHhW8SEwqC7Si/Xi7iC8HX8zMONNaY7lK2/Z/RRJJDTp7peEDzkAg7Qv4vNA9bm+cLr6od5HsEwP4kxB7dy1PoCIcq1G5C6CjUAp83DCMOOTNuGg8cSiLkI+uR4CFRTfQNsksEB/2rO7op9rffV3rIrDLfTigvfLYte9SXtloMVSeizM9GEY8W5tR0Azqpj+hZ7REKp6ZgAy2WId/d05mRcf75irUAxhMiaxyh7UhjjfrfLfuqVKb37esXtoFTwlUOJc69Yz/1O6VVVS+o7+EH2w8nXIX8MybG+fzYHvj6hzaNecGs8cRf9hN6fvbDhTsFJfhClowS63lI2UceTSY06YhGmdHv2jYEG94ukUNkV27ijQ1eX//YkKYuHiDvmCaNpdy9H2Mzo4FbtXY4oPszjsHvPtbkymTs4wxqvzVgn/Ss90EUWuPhGPkcqF5G9Svx8yRVKmfIIUVy2UuJ9/6UyDqvOosxn3siMz8YC8PIWlbx68CVgYTiokS9yZf36GKyYJbOh79HbkvoNmQbK6ORyAo9sRXD39iNPRG23x37tzrM1PnTubdlhPo84vmuo2rvkYB3ZmhMs1x1uo9tMOLv64n9cghDNb2Uf6YmPx072Aiej5esNYxkPJVOvCeFzjSn05Mr//nlIqqqjkuPwEWNQR350aPe6TtgzwG4iGIsbhoV/dPrwHg6D7Qq/hNjx8J5n9wv3nXTGteZXX+LqMMQ+awCmC1GLSRCr30wFM6nK0nkQ7VxI11cC0gl+CaLEIc2evu7MZdkMpU5aj8683xpBK+rCzGzTSwHeFYtqj/uskjQBqPzzEEK9yMvdsB/tgPjgIZW5bme7+69tGabl3IyqxViKWxY1t4uSUB81Kf132O06Jpmn1Zv4Z7RbFSUWFeJ2MevUBoAA+wX7VPwNfSEkaS3w/XOM1tnYkdaD3XSZv5JBIZ782004Bjz7KK60GpUcUmIYCCKOiwWe/hXDxevUCZW8kCTbP4pFvJ1I/dRskLA/DYc7fh8KZPNTbqUwD5bMw4wCztflWyWjWR6F4COYLMIRcwf2wOFhXUkn3xsXTrGuSCJRXwViCf29G8/TupdlzS8Ipw5J+/12nGjKtqAEWthgZaA+Z0DO9Hoi9R5PED6tcX5pjuJaFzuIyX+lQCysFw4NJuq7XhanFqt4FkhpLnPZF8u3ZXAOC/m/FvHA02AXU3Hxukif1nfJUNN4Ab4YoU/C1DqMhemT81fYxPX+FvN9AyZsH/7iIR5aXqyZbN6GFkdawLPfBdPFezbK3PZ0jZy2Epj/QS3JhnJw7XUfaDwMUR7FA2MTlz2QliBlF0odhlURsx7SN+alDCqmmOErfUO9lWf+RCpt6JFfMYSDFUJGBk3dVSjSeH8pSkh+imlTZCmx7HGtOu114i6/57jg1lZ3G1VNbpgW42cR559wGOaa040vU7ZOpdCULzPvArYeViajHfcJdigf3eNFH4nWM4KgxtUtsxVLWery9485U+NViPag3eRu3Dh/OwbvxPOpVNOnV0xu7XWquRhHyAyQHdtJ2ThJuVdYqaFZ90g25SkR6qrsyDY1/6rERHVWLjg1D69fRciths4+FNsTOQ8M6ISCaU91j3Txm8+UyT7CgTg446Du2qJYcLiBoDTkvsHznZGzzDBHhvojBzFPiWLysrhY4fpnfcfC9L6WtNEiCirBieAVYp7+63vzEaW6+scYQz3LTR7hA1htj26q8FlzoePqIBaSVlR9xT8nkxoYHNlmyXaiAtCJoJ77bXMcwp1iieXXO6Gr8/yg+/7Bd3hfH3aCuegCPv1vkFd0pudO8/k0gzO/AdZ5VyWiA4+irmhUN9ipbcTSJ74n6ONH4VCROT68vvyjWnzhl+X1lLyyNISMtEGtdNRzUS/fKt445T3sq66x7Al79u+gkH6DREl53f0EnpWBerGE6b9fKADwRiyGbcorLBLzOXGqu3peFV+dE32YQhKUaPTjJmFge2eUCeMEna+/s1pgsw6Oe+koQRD1uWleT8CqkePrHWPw/pDhBmKW4DL95acj5h+jjyJTRizf/K+F1fTvdqv5bGqX2D83iHxhlxhxfGxejccMMii+CatumbLmv8v9Va1ouyaeFFUP/6/jKwlPeg9brd0NUNPgNLswLrS6Cp3TzfVNL2bGKZEXs4l4DOuT0msdt1RpJrwOTGD3B/q64JLQm+D1e+1QB9s/aZox95q/JjZneIKc/HpLCI38lw+XNTYMsiOUih9dyTy+Aj6x72xwYUUOfsQlGZ2XqoPkRlZ7VqM1Zk0Dfywnhy6ujSS55J/Wp0MpVnaLb/iY83vkvBJ8g7ghYIXjWACUuh54NoK3wupnjrvQ9bE2sAqP7nuawsPi2Hhkyduaf5n2eGfHp+UAj+wdA4NGFcE2ZW299xvExcPZZPvE8u9Ag9qt//3MYoCIYurgdHggFIEFWxI5W1woTJF0GSVIK9w1UaOHAaM2IJN+2Ls3kqtpoe0aTCA59MBLUcVtfE3TFgvbhJT95hXZpyLwI+hLAjnD8mVHMz/HoGDIjynpJyPE0HQ/VdsJtO3bRMxt2kG9T9Vc52PLknJxWN4t0CaKuVHYRN+xtBKScG4vhhD1qOuq1zLKo7ASy0bJUzNKVQcd17YGQrkAXm+Rpu0jc3G5H4ACADTvUHh1CePq2FOAVzJ2QvV+Yam1LyIWmThYUBPHPk4Iz8w1PMK3tW5DheRNEXJbTkHU/tNr6cJ27YtExlzTUUOTd8Qv13yk07vWbMsz86QZJjUUzYoPBLggzjgYytyZANPXsIT9OWGTl5MtM9BWIYXFLSsU0X5gzdYZcGH4ECbXopWsOx3NabfFhSocn/l9BfiyHNtgDVLd5IFk1ChuxBUWytt7md6ODjeFF9eb6uXXTrWxhgajb7f47SZgBcwB65JoqSiwidx12phPJTQua+6Onfe8cJo5aOO4NA6Hj6iASBbfOqb8ljk+T/SVpmofFgyjhOwtNCfvVyfhvmolgHVU1UzF+gCEDBk+q+oe9uHMz6ohdkPDdOX1WUvQcwOf/S33bT+COPda4uOdH8gQ8WwrkUYguHzAYkjGjRWU4aeLM71ZtNo7cOl5r9E94jKVYjhce+anNs8JSzuYsHnfu+1EmJaRKJY0RwrGIZLVks18GxdXnldjsPDEf5MvGK3UKU04mEHJ6z0r1q1jfX7lOQEuUzKQDag0zgb4+PZlKw44+140JRifGlFbfS2I4A2DFTlUJPgkQ3J9MSgCThhVna3BP/giTSG1Z+LYS9H4bCf9608c1rHL1/iLfac7EkS7P5J+JKkbU5ZbvJiTB78mVjvQ2Yz7sf/G+9t80bsOw+x4wx6Ohjc2FR26F/Rl1Cz5KDjh72EvRJQlz2GhDpVH57EHygv2pZaqZ4C00J6o0oAx+oOvOJs3XlOp/ewfu5rZqMxTixFhXqEFWvlvGuftpgUWf/fsxbzYEv2r9X6BNgUXn1e9KOyrNypAX6V3+EwlYjxdqNXSruaH+wIlypsmU85eW31qYdCelO+1610xs4OVgWPaFiMdRxgKPYwHm1fQJhjeXVZUUnLDMbQ2hXCqQPhQtKpm6MiSbXUGiQ5v6y9/VBpfDeqxfALQzI40Ib5whW9TtrbwH+By8VblthNjJEFNr0eoo4mzS60l2WeFVMD/P69LzVVVPG0/5iD+y/mvQVmCk6UpSEchktwCwPvA6oNqm1mlbM2Gf5FWegoRTTy8buI6ZPD6lqvqirKW+OFshu9l/p9IZCniv/8uktNMSVJvWapw/867eKQj5NCSaY9WrMM9U0tjp/gW0znnCNGp0W0G3qV53CTdQ+b4wLJoGGIg4JJKFiLW6I1h6lckIKno+3E+WD21UScdm7VELZ/RfBOj4SuN7SKC66Vd9sYc4nQiCWwPecOyJGzLq5kY9CL+p7HwhjpoqdLOZhUqKfUtSlwVCROb6qmUdkvkAKUEeSUPp3uNwSMOVnqsYag8SwXYu/lpgNyK6KK8RMSe9bNpZ0N976RX+kb6WiVCYY3c4NTRVVrNVB5hrwdn9lMfSjlwfBuJNd88Kk0ooSmuOCBcU4rLw+yRABPqbLhMphVMYZBRqAawSEeBbT/nK6lQAPdCzSXD/01fnW55jsEOr2+syl6CR3PbtMoehIh9RPMe3fbysR/B86EiWwT5+0fTLt+dvSF4Y7IUtrWKCO/JhayfXL2mB8/Jj5a63LVrrV4h9fKkE0WbGM9UZS3ctBEDiz4+4H0VbNTUzzvRcf+7Gr6yRiFt9yPCaKtr1bQDSbEZ4zms/94O9CXaeuuuoSmBukUggeoSV9Jq8KoSNh3Ez2sciDi2qP/Byod6cou8ZO0ZVBF/yFJbdpbiWOIyeK1mHN5mzD3d19vqH6XLsy+FBsalvZRfXi9vOfDaCsu74+NgA1XH1TsTuNm2KLFAdUadCKa5Vdtm8jGdd+boyC5KWw27dp+t9D367brAZV54spOIRnYHm4OK7RMA2lERYhpCotOEv6eJhaplUpoH0JJ+nT3DoCOpTwYOps+Ng0yZcsjpENPRO6kemDTEfS/pi2fh7ZSH1g13Ka0Ws9oojbvfrgwzv/CmhV6WrzXCvrly3pzed6KWdXsBMGQy9hR5vxwZ2bOHpO55d05ma5CjDqjEsYLdRNAY715NiP/DyneyE8Jopb/G8ET9ddshtt7m6Xa3N7Aix76udOs+rfSMRULchfq55UftuHjWT058e8nFMVpgPPVjauRsugg39YnIB1qxseQ+2MGkGkzspsQG3hUx0xK3ew3GQTPSBK2FJK4vdx1WXdpg4H78J7QYVP255mQAoSXcUpQxOAIm4neQXg0/e/wCj/oRBkb6+t11ytdC1inYcCg501Ghnoht8zYv4UnVkWdRvuSFJ8V+yU0+R4YjH2yf13DuBIKDycyHyRz4Kh0PKUF6UdRP6ej3QjE19r2cr+DqM3PkCqyTYNxnQCbD5RLajspiV8vOornZC8Sftp2eGggcjpnqkryg9gRsJEJgWdxoDYfKNDWAd4H0A0feep+9tbxpojj3oQe4d242PGMn3JRuyYdyaKxeK4Bc1qxthmi8kvVC/IQrLhyjROBELqpjVAYzYDYihDHXQBG4J2pf7Biu8zPsk+RH5tBT7YZ1dtX+jfXbprbkjiMwZpKW31f6dUMH2o2Z8Upde4wvuMgkxu9uqwgNnEaHJC1aNqz6xQGDYmjsb7RGPxB0iz8XkogDFS+B3MTATxsx7kF3W4f+8YKhzkJID0l/Y2TWxPY0td97ox/vvXgmDmhCsjuNiMbxPac3yfaTg7D5SpNMCr/e8mJ7vw/0vHyQoOc4uhj2exXa7yT31epsA4ZZ8SExffzUOIb9pCPgkwuI4nRdcB9CgYNYWdmrIk3NrFrijo2ojXJSKbu7ILR/oBjqzYqQXwSs2VYXbuxowz2QLPDehs6uO4mRr/OLmxHbMrZmDoN4LMlU3nt17qTF+8UdjS799euACoCTVAz27ZSfEIPxYuSsS6LFTz5fEehMDeqr9MWWOyYBBqvSByW2D03B1WYyWCGXOtBfluEgvNahSaagh6m4vqmtiFm7E74foTiOCs+Tm8x59lEv1KjiG/sg9Dl2IMw/gKdKV6I9e0jbsn/csIU6nbawZj80H8Mv+vDVvY+EkTLS5d/oKVhabyzSuWC0Youa20KV5veIVnxD/3/C+46UfvnwZjAXo9FtQ8gJtUazSysVezh92BiwDFX4wL1CLUU6c2aYQdw2QhuSjGhHtmYYCpixoVFL9veV/4zrEER87n0HelVDBx/aH/aDfIObuVAfX+euJF5TA6F2adPhULtHqea4HqOGSq5uTu7pTwO1ZLRkx7JGvD/gkjikYBik28dCSukXtwI3RiG41UMU3ivnft8bICNYPLBEK1obTCEmElH8t/MRkzgpVM5tjARtEOmUoOzGjy1rv6HmBRMQC/HX91+2I+AnHg1P+XbwbpX7G20GpkzW1H54ZhUherSN+2xtygHLfocqdJJzvtFZR2v27VrJxaWCX4Sj5k97aRglxKQ4Oazrai1xT7DqsqBUvhOi5OfKxoM3HkDfXHwGkKvnjFfEvqwsxhe5GKhqHBeonGUMVBNVGM+9fyh2+oAzkUgTrSnLWXtVDwxv9ZKSY+MPB2LDJYPc42mY3RAmTz46jqvfSqSjgjxGO6VP5sULUnpU2SZrEsN8H7/yySUSs8wCC+jPEIl+guQc46/kfqRIjbNZ7n3dWHLACDSNAog59Q2x6wJ53XMsQnIJUKBLqW/ovzVZhj0b1oXPZcwJNsPnJ2Ddt7G5e48xm4I1u1oS0bt1fElHvfDOQCzAdBOigpo6Z+b5BelFraXEXevmNBvZXAgtBB8l4QT7L7BJfrt9L729/NugjY7k8S1p0LWAXqwoyj9p8yxt115kDJE6q/9FkuRjFKfZUSm+sEJA7vRQn/3GHYTJkxkQkhCMYBSC5rFNPkuVHNHfNqdzHF+socD7y8mIntJWvVGAOoISIBotvn4Uqm1ys2PstlNUkeIWuRpRTsZB9hXg4+tV0shH0VEO9vRZcRkaOpyblcUiRlKe5NZG+FWK/RldU1AKKqSS65ArmM0jhF9jCpasD0wDFMO+e04The5QVrEbYWk+qLwMAxluyTEUNnOwltVRmSSqyt4OAWp31dpijFBs2iZs0tgjEStRD6cIlK2a2tgjLxL4QgV5SmcI981HpBxDpG4CntD4iaWl9ELdkDhOcHwAP0c9ks4uOIUu2qb4rUw9uPWR5kvevvCb/SAkj74ygtIe15OEsC0FT5fqP62Jlr5MJmn0/9YsUrOdFHjpodGSv0+9SfSZJvPU0XlSqD+L7ATAP7c/WZngoVNZsv+kttSMueJLmpEHjcnTxZkY+H1SbhCHs9mzJ0ID7/z/2kHtmu92HgeIOaZ89r5gsaZtRJTeczJF9W4Q7qtrFiNgooXYJoFg/EI/2v3UOJLKxvdXKFF1KEIXBULJ+gpKVql2AHzC6wqXX8uVeoOhN9lrst7Tkwc1ubrBvTv2r+aSlfUApYeL4LwP6FCCbsiXLdgP2ipB9cQpEV5KJ/Zod45dwHqM7KUzOdjuj0xpSoV5F7PqVXvnTS/aCqlVqB/X89nTMoxrVJjD/e6QDV6jfHO4x54QKVbWannpv+R23Oaw0BBirCSyBanD43tD+NrHfZhMxncr3fLv8jy1OG9TrrF6ReokFM3ASbM4F1uFvJfCJ28pVHiRj+cw5VHvoj7vciWMk2Rlm3AMuO89CeZM4gku33H+zBDkt2KsoWVki45tqOc+KuozXb54W7/W8Xg294QOS7A5Jsq+I+D+M9I7213/zbLLmbQTy4+/5GX79Xbq9FMav+MvPawphiKWRolx/5C235nYl8uN1fnNG/hGzsFztQ2vLf0sSyYLXuOjkspSplyKpMK7bfMjbQvKAptJD18fa9+M3OT84h/PjvPZMdrWY8K7JgKn9G/Vku/37CaMN71NFQZVP953RCHNcluFovSwkXHEtia37G4zQ4eab8jMHWxlXOnt6rLdOze7sLBfWSLR+8TxDSWo4fAP7FNH/5acrUfdDN0GtrxX5civ1DedENau47HvAW7TMKF5jvo0R54SmO2nQ3RDfFBCJHJ+qR9xm+CIqAz1Tf4kuJKD9OzeMc+38Yq3y+G6vGGQfXzNh+EWNFq1K+3TzwSHknk9cRakkcyGOCfJI22q6xhQf/bduLmUrHmQy4OuZOmKNVXtlilbjF2+BxQ9sYRwP99SuUOInEhMsKZDtfEX3PSrAu3vZimfdiwlj7RzfCI943y3uv+6JE2T/hXv0Xamlic2lonLQJ0dWqr0q/fBJ543Rjv0+seRyFopAEIYC4a5snXmcDOkPGB4b5mmzLvq+3SdTHR+HijO8q2KRu+CI4+tPFco4Q0KIU5FGcDqXgShorZQ7Rg6HSiKZTA1YlMrAE2XE5sn17RQaGzteXGYRQiLlxAFpwVEh4FiWujcmnl3SLYJn8YVrWazYG6OSQ/zuzHRlgwEoB7GZchforThTwckM5MUgL6YawiRYfIIap27NK32felLERzXR6NjV0P/1oNDw+7itCuhrGeNmIaR18zN/C4Zh6nKnwnhnZJpNEXXlPBGTS8MQpG3IMaul1MN8oqmhaoXsj5Tr6/nu/Cqf5y/hSEYdnGzFRHjB/t3yex3GZdezEheiM1efadJigpECXU55Q5AnAS/TpvMvH/evas1bjD+ApMl1W9/lRoUz6QridPgAGH/WrbqbS5yjY+YPxnRCfzvnwsWMZtLgA9aaBF4BAdxKIMz91NEKp+1fc5mN0PiyMuNIgY7hTZAYhZE1A/Mmw+HbLkD87rY9c4IWejMPp3S0Y+2CcaIslpoDoAZnwvT6+0oV65VssynK2jBQyu2RmxLj4elRzZwkP6zTEatYVs8AbfzElTm0Hvlr/EQFL6xL4nD+IH0uwf9UP0Sr/Fly7uQBX0Sq08l0tAsn9opzQbyZV85oHW7ZHRLuLbiKD/fgAtcY2GVzOzIAFMBgsPiL4lW48d3zTzeKeWVEWTivB6/Owehbb385vV4wSq66EW5BeFPGSc9ozMNm3wZo3pRxcBm6X1gk/znVb3+8mt+udx8GoNetHBXaVcTHfYF1jPGPbzUsjbYnapYf0xMQcnjoUQxPhh9VBAXs+FZj00WxUxUhsja2OL338ogh8XRMPodinpP4BLIL8PiNUku9bJ3yY9NS0upiCSjdiES/nC3fez9m/KChwwMHDmB2vcUdW+eqHmpnxwyYYZ7tJ5uB9xD8fSfrBgv9vDIdiN308HZ5bqv3p8fzmkBKHxS0unLnY3jTjBh29BGnDg91xY2JSJhJRhoeMcR4FufozgavLQz0S9EAVznEIZXvc36gtWBWMhqqAq/vWZtiLIAsNcUnJtxkzYq/caW3uDsdPYXH4IG8/IVU2bQXH2kGs/B2D4BXFOQpLU0HqFbg1UQvP0XDx6p9LM8zIFD7MX423hj8WxeV1s5tLPpiNWOZRMGQFMS2f9RVYUq92CaeQiLuxWkVHQCZh0w3oEbaGuhLJ/g8Mtbl1Ki08AEVxyfQtj/QI4hgw1IlqonglMHYGXQU9Whh907ydShc3fXz9F05BZAZNmcICJsCcct32LE+1P/oYMzzJVXrKrQYBRdv0ANHxs84ZjICeFy+zJPjDMRimGDYl1idsd2GjpacIweit4pQbnXMrJOmOOqoXfdRhhBfkrNZcyt2H/7vv9X6Xwf1uv7j31zTTNhPfa7rDzT+rxhLxcl3BX1x/t2Yb63uY+VMAEr5Ar8ZZ3nGfUw3F4rv9sD3LC4w2qnp9jIPRPVmd863zVoeWZ4N+UjQNlUwM+f8TFDOLW9AU+pK0Ez0ePCjPE4ep7zmIDcCS0786cbINQQGO2Pl62HEtCR884pxeehzbe9/5qsTy690XEWnXhnrHZ9WmHr7kI6lKAc9AWhjn8RdXj3AayCH86a74CZpA/xj0XYxVGS3tGIhAVw2sVH6djlxEeuAcWCGWhYHzfPA+iGPb8VOTSBBf3AA93G8dIpqZB3iiEIfc4jAj3vwwWhzkcFxJ4wBdWXbOtwCtnyA3TdMDQlhjDrHIlr2Ad8RcHasmRb7PR3Djdy+IpVYnYnPb8hV0RMaEQqr/qrvDOty/N9GX780/qU+quOoSDECke87biAp06A+QPq6CxM/EqcwcvmUKAYkVewqZx7RFH6dAlQSiBajfTX3anp7NwnX9mjb8OCml5Jk3zNvBkDQyfdTpW61JczAu7xEvo3zx5DqMVXRBLIG9Y56ee/E8Uj+bwZ6k1Z5uT5jJ35uTB2XvZOEO7VHLdpKx0jXJNIycGnKvjCmlPUr2EKQv+H8+GYZkg+No650qIMp7kNf8aqut0HQbg29iNESXcFhKTQRa4hC/Wg/b5HbiNK1EHOXk9A/Hsy4rAHHsMUyVxAZLFLj4jeKIi8/N6i4L6IO5YRFcShizhijRoN/fQmnCL+ycklHc09XPV+o+edzdIZzzCigRj2+yH/ZSnuDVsZB8IumQinXx83w80uq2ODwmnoY4YarmI7BqBMqVkIqtWT3Q26HdzE/V7MgQiDNcBRRm5fJ3R/fBdc5KGKJBAGIki7sWP2yxMuilzGH4QPxtl89u/eklqCiuDSHpYybZw4CflmTTicB7DhgO/PJjQjzc0GX3s2xaAnjg5kCI4f34AzXFAKxR5LhTdaNxXwIkaIZ3Ci7NO0ZOR1CadQTLt67qUSDZCYrg1MtQZDM+twFsyYgUfe6d5L7s/3RwzU3V4TZlmioMPqFZ3i0SawmtleS7o5SSJHrRh1jym8Tk3qFPsuRkKyxDXHN/sEX+IzArsIzieiDL4ivFyrfwKFPi6ie846D9U88fXzXgQ6oVpC3eImf26Cn3ZBcF+klt7McZZrCnduVNz7hj4rPvMXGa7pJzDpnBe+A8oabuXznVrhrGVYvMjKM5+
351NQayD3EUBxcYoSUNkmF6c9qve6qRJu6RJAizo5mFHgy0nGX00BuZqcAqRf8KZr84oPMeg9HWa1M8Vs0YdTdVOVhbdpazUGB+xLW8586isuSOzWNOy67623m0eEWwvDWwrEe5EScukrFGf0qwG4aUObJOjyni9wfNrQeHEfQHTCOzxz1c51SwZU22WIoTh4W4YXnxQMaZpCK6Otr2huI/rGvyv7OcYbtRir2UL0R7sKEfyCwNTAQlrg6YC3m1hTM5HWaijDMOi1t2jVB74hmugATrbwSzIkkNCTAx1r3tihk2+dyMICeIyQtsQ1a6fzCLkVQRZ/3MJblddXlHKJvHFMekGU4r2o0aydTx3Bh5XZGU087EmFNCfP9OsflDUjyhMM0sNpkbWcpzYBEFfm8IBDF0dOAjxmwak6wDU3+LfMw+oaV/p3tFryWyEsg8xztUNJcJrpvfYZMPsMaYTHZjiEFuc+mNOXRFy8iEMdtrEO4N/fkiZNrO9TzZA7+lpNcoaxdllDtK0OFWFDcpC6tfPMsZ0mNzLAL+68jpU1cmQh3fGZx0LpP0oSZ2xncTE53+U/GOhMv8RANtuKwMwXFVRk61nsy8yLoX4GfsbZTKy53dCqT+KxxwRNfHjh9EirjDTrHJD3BL57rBka97Uys+Frf36LU08GysiDnj3RNRT4POUi1eAA3RYUouT4CXQINQrAjv9C9hz/rEo+y/N6bSej2rlUcu3GokFSEJKTFPY3uqlE/tE7xOSpaYSYTn5YouSszf/VtB1IooVp9OWi8ah5QJ1xlfM7Auagio2i7Zj8BDziXBEHqrxD4vqrtU6uRhpr2oMaq0VW5Qp9pTrLwy/yFOWWX5TynZJt23syFyhL3bBYYMhA9ACEdasxnprG4Gm4tUKfcV7tCQT3n29CK0lXLqopCMbY84U+ZL3N2SV2m2LSiEdwvAPcgXLCp3tcWvPzCVIGRBYlUZMmLIyna9i9IQVY+yIYIXuvTMlfAgenw0V1rWbf6mW8ehTGZwwJzZrL8aAPj8Nbdz8Ebx2KPOEo11vw1oQ7TIrMYD5U3e/y52NslP2XqMiQcQOYDSeRsZznAGdKkd90aQULi90L8W6OrmXONeL1ljfR/Oc1L1ixCQAIKgDvTx3cdl37zR12QRkhBO8ar1UDZDcNVv9mnnK3yuHyKjuZdGXx9ZV1a977sfl9/rCTFRjdc8p70cTgxOdyIr8WVY7FDm8c/xjKsKH38g4xrL452kKts0tJgaZcJlbxcFIwh3IhwjKOp+fGJvkFRRE0Cir2m2u5IpvowRkcLNR2eBrD9APEccYxIW1ucXzuYBVUeN9Ocb8xhcNBBkZ3uWak0lNr45yUUnc9SsOpbqDiscJfbk9cyHjz07JWcWDERgk3zQmLAMaF/pW3IrlHIf/XkftSYdu2pw1lYlzT5WzadeZDigfMQzZutk/ydHp6cIleswjsg8cHBi7O3CIgxks27+bkq8BLl6fYc9kxBhnW/3FOzAKnE23Fy1Gahan/PDRkvObeSg02srCvxtSR/XscnVnHe0rkwY32jCv0gULm/UUHK0NtW6AzSejTxz3i3y2E/9PQFrWCoGWZglofoGteV/u4kbG3Lxa8xKwwpHF3pvrfXjzdc/adqlz3baGmvFn862T+MkGAlzDtgTFcLSm31y3qRDJHsE2FRGWC5QYa2ai2LKhJnmj9yHzsZt3BAYVewLyy22cB8cm00GbtuR8i+zuzG8uPNLJhBWSeZJ0hqu2JIklg7+/RzT77gHWILlwuJPrKa/dYoup4VB2VMaY/bimxdkC9Eq77ivM7DORn0AEvS1xnaQ0sqNHmj+T1OZsfoe+1nXhc2lpC4q7RKIbT7AqUqByLIGeqjX6SrvkRiarkAggryfEf1U3RgZ2rlTdSz0mFjCUhdb2duYzQ1Tkb80GwGWWCkoCTIlYlTkls2u/Vn4mdWkCbctuEmp1RPiaiwKgr1qO5KqlzbTRduWo8Sorbc9lutFecba/QZYSEvob/GI1wquLGenCrubOhZtV/C5ebHIswXogKMS4vyeLq+1/R555K4MpBNSyJj4zFTQ0iOxi1ODXlI8wLXsHb+NN2mo9JZXN40JSXQA/QErbsZ3k1TpcYy4AivU6Be95YYBs+TIH9kb/Ud46536JZCEpGJ/abEbuwhgyWE6JVY/0z/unE/0pOKirlZqXenHsmvlzCCX4bIgwdDHyEeCUXlThIwo7FxDAz2jgL2mk4aXL2R9DFvVoEQhs/XeJbb29Oa6AE0VhHopBSJfQJ35uPdQhDhMcAQen+1Y61XMDucCJJnlsdBDkbcz5KUSzhnKIaxCW/E1zW/T+nDi4WCtC6/tTy9sMfVXGqfYqbLP1wnZLNvjekeNrwRwSG04KsMUcJdKV+wx9sVDJuKKHXAr0hxBQmWB0eeUa0S+x2JQA/JsvXFGr1ywnlipvWNtW5hggctEVSujy9f3rk5Fiz3C56dXrArRE2NAJfoy76dIi7wCI0GWmC5/7lfbdRj5yiFRdzpLWYfNHnCECikptmJ+gVykvyAirBDClZw02OiciG6dUnZ41oih/JVa3jWJVK+Pu9poWs4XcBwgIZgnRJIqPtRwBZ8jm/ZRd44wSYyb+g1mMEboDW6g2gBaZ7hBGyYEKlSBHe0whXPyGqKUdpQOww4bavg1GOBYIxvpsSTtZQAbwNmmPqwIGbIM4HUfPZUS3gfZtSuwEG+mXYTPOmbwj5UvvQAxxm1peeRBlQwqKvy+NhPE4J6U7ZVPYLqtHV+eB8c8B8fiJo95mdc0cA+hzc7BI4WReTK08cIkLW7bPP+klyMZaoYiP5c8l6Z5r/1bJv9C8mSn+2KxqN6ev4e0ZSqZK6cyN1/wflY21ZSJ+KI9JQihJykGFTm1cIZAW1WI3tenPppixEcmtOGr2HKHnSCbzLQdBEeCVfZOvLXOOBxkWW3FlhiAPLl9U26AEOhTRlyaKECpdDKZSZhnXnXlMSe6DzgFZ2p1RclQlD1r7sXGgJeIQyZFWJcayuvKyRbhB1VNkUS158Dr/mKGis9BjIDtDM+4HUeAdbUANeVDU5GGSN/LDtuHRrFFLh4m0J1TbdUZ1nCZCJe/AAXdomXt3zN3JbR8djYhk6CXrYF6PhcpRrwcc8fCpzFEbbVEUKAH+dj2Kihl+w6QT4w5U8dYhtBozdGkzwxCWV5tQVmdNhHI8ZmdM5/E1xR97HUarFtFf+uQJwESNArbL4xuDG6q8KcpV3mST1UbmMW2x/7EeI2kj665118PXqLhxcfNFhi+l65OhICKwh/p+ZMAJWjeLleKOR2BpjgvBGlG9z+G9GxfacRSYgHYzncGi8BACxYYCZiSprdwVIp6ocWHcSh7UMCLUd+NH8rEEdezHWwtd2UB+JgCqqwE5MCcvaXEd1jy2aonKHvbOxcPNwoIwb4Wk9zTBontxYro3nWEw0Y49gba9Zemz9kZdTMJana8qWbithA90spUq9E3CViLLQz50t99GVRcW1MtTZ3XtJbt3HHFGjUG2TqFhxeevIIUHTvpM1uADE/eBwAC0Kd8rXFOfnGZrXC2BHCDZXfg2KLzF5oCYxGWoh5PIE9KLmoDaQfL2nxyDa9iuU/sCXrDNm2W5lbDOFJDu2oMp+yyFehn6PtpGrqNCq7o1AcRfxlMyOV+rJAVxmoczqlzbtygmW8k8bCiES1Ennabrx3NPJo0GI1p5O+VjDSYo7vtdpSJgm3w6yLBCW2an3Gx6BDkbPywlFqdaBiZ06BZbwY+2seuGIImLUPOa5oS+MiTwmp/b3t+QKzomzsrooMB4EJcdOmrDLmo2aVebBJckJF6lcy2uqAsDnPSfx2qtniCtbFfMtKZ0h1ZplZcAgqfjch2V/H5CCxLOsEO8QLQznzag9c/U3RzY89AY+D8EXBFvyeYV5E8cUWyjx3Z9mHKY1bxKDFPz4Hr0D3FRtsZQZQERAxg6A+vfM/neWp45vCRp0gkd2+psCQV5Bk2tGpXmx/Ed7Gu+iJLY6V3mHBUKUtwVdw9C+pvRnTc5DwaflWDO0BCDmmdePYf5LEzto3JpRPGqtEbXd5ZdrX113FgUsxa2pw+YPf01PL60ZUB2G54S1CsXK7+EtfScQca7glJhSBgL5/Dx9duMvhISUs7oJoiBA6HtdJHLwn1BdKdBVGT2UMfiT2oe9aIC2TW8m3ih3d/halQiLsfqZoiauNpWZrzbk55qN+LtgQYjnAROWrlLrIRbP2OARZJ2+cdzIOZJoWVx1rtUGu2OmV3v+bWMSILCdWd1AbZk8Gjr2reZhN0Jb1TVkOOCzeTV0vO9phqDYmP41RVdIz1UdR6YBsfV7JprhwvFYnBOCETi1A7hM6/mnFpfI7kGtSUiaWeTI5vTBcUbR0H0r9O6ZIR8KnwLnLe0dxSEPBeUHEscGq41vARs5auQF2rwZcCQZ1oDQVAis3WMmuhAvpdNlsi+0viThke75S4OVsfR9jy9Ir1vOjWb2hGUgU79RNEalD12SLq4nQ+Oc6WHQSug4ndUFTAtPz+/MD3WdbjIf8n/P8EK4G/piU+9x3q8O+Bd+MBV6zlyaMt/EmkRMdfBLky8GiwJ85oKetnA/iUsjDP99tROapk9o2biiqUTQaGJPaejQNmERliWBUd3gJ88HpP5qCpx7tgcCAplzX8Cip6vNjef29VrQvvWFv6bCb7n8hSdfVWQmWY04pReA5Bhcgm1j3khF8dCK3jtiCqHnBj9eOADboolUTDliz/unur0yKhCUbTjPbvBM+mKNiTN57oMhC7EZcyA46tDkj/f0iT9VvjgtvO5POcHkDkVOaSKBYzk5MzFe61q7b6s0B8NREtDDgA165Gk80P1/RzSYwLk1aDpDLwpxyEDoasBPXEjs1Iwf3ooCc2xN4WqJEbhTw4DBWysdIV3VrlEp0U69gt0T9pg3NMu1v4yWcjX1RxUy4NZE+v4Rca315yu6rfNPxK6ur5uoIRttb2IZlvq0dqsESspN/eaTYsiy6Dlufnn3gZYdlgZpe7JdZF0JloB6hLnWOdwofdcbIlAHke4hNQ7nh77Zpu4CEnaH3UAXrJj+UD3yk/ODtaLxP/rnUpuCCIU08HgFG69qUATwJQje2dIrUhSIfEw86AYjx55LA/eBlBqDhn9Nv8PEM0qN18VAQm74ETPG9YuhC+EJm0zLe+4T0Nr8Hma+dkdkDKJFMg6uXV1TncbtZw4sNxS5LgHLfSpSXi1cUNCY7CR+1fkHg+sAIC0NILWY3YUvZpTHNMT+3qyEUZNgIH8PyjXufMW6leyLUaOXI+ouBW5p6YHUWI+nFZcSuedwcSJfNJ0meAmkoFFUvP4dW6VIj+DIzovUOxi1iIft7fpyEOwZDrJxFw4dKoD3ZeFI4Y0Fl98CNfKYW3LbIW2hhMpvtB9R2Vyu/RNIrAmKu+Siuh87Lf6p59OhWQVH1q6XS9JLBT43b85UnsrljAL63Xq3Bz5RQ/vgT3gIQ5T1qrdzwOVIPieu7jJmD5PY69gucV/51am9v28Da4N7JT4uFnfwcCyL4gEGMUhC31vhWunmufvsLxqnYw1LZn+2QcO7NpTGyPxT4iEUBjFRPsDmoOlC0OZMdUe8Mh/2g4wKcYWqcRcbTJClshRnV39VclR6l4KvDbwaK7xB1q9CP/UuGrEd4e+07mNwNUAGpGX94bjy24+8G9lpA7M8YKOjqlaRUNpYuIotYFAROP8u2R1nFP3TU5XKpSty7eXPnWDYPoPq2v7WAsiiebnyvi2P+CUAzDNjViINBMUbfRpLv4vXbm69UtU2ZkT3qLOV8KP/VC14oaFKZAzJAjJubryIHveHGJ9jlg1dutGtPaqoBSenOSHIJFs9+Gpw9uYeeA8UOzxLyOLBCpFppsOX9j47IrgeNihQLPfZfkI472DRr82RL8AMR1FLNGdtIvKWMNocBunmcZ5dR58xr1j5ZHiVhWqr2Xy0H0Pt/SQfugNfabnyyCrG92hcYWNYrkdUSL+JhpexTdvrtmSkOzVW0OM6ZiSsUwQ2mR3VoxINf41+QE2REeKlpAhxEibxQ1dTXNmHfGWvDcRT5o522b2iIRhf3I9TiuJMj3x34H+yE4eIQ9PWhWfbu/zpVC9A7FcAJnq9MHboSIQQkvlaCjwckefe+UMNy6KSNaUI4p28npYC8WV4mY5EQ5haUj27BKBBDYVcgvh2s+WVpboA7x12dDH0kYqGdKRNe+BtlqOoNtoYgWocFL4r6iw79K6mB00c+1awReu8I0RSOKDxaDOA68msARCR/9PJ8ven+1cUWaUD7+Q0jxGHKUlzY+nfAVCPrfKFGNs0JG1OSlOob8JUzSIndgacxMGXxbi2UQF5qqHNC4bOtp1LcsFX6j7stLnLcJ0D/HeZbJyySL5rx1cA4DxtzUP6MuPhiKik/R5Urg5XeijKnYw5e7mjoKI5/ZfGO1SPVDrZlCIx/1bvl+Zfv7q79yq4/q9/XjVIxfliZoFfXXb9yoSQ8nEl3wSk6vjv2DeIi9wSkJLhS3A9XKaTlUYl+mD5J+sSq3dHr9lENJnJCer4IahjnTUmO+gcTosbA/Vyf70M3gPzuRQyWDz0j6gVaOIbfq3oKSKaUsAXKKprfXkQ4iOhtgYyIfuUxVjzf86whtE4L9s95nRzs4wbGMSdqhK7om4uQLLdw2/cqes0F7b3YlzR48ENNtSOOtjVcpHaMITPewKH/O/A07zVknoNzQiP6xMmEAyIN7T59O/v2Zpqfo+3pV9yCUxVtc3AaBg6mGDt8Gndppr5VEZONal2nXGBg9IbpBMhogitJUEi7kOsZhEBB0Q9xKlVOKTNoKufzjDAUemcEmEP19fHlObJB50zLU+dLSOVmF4GMcxUVPf5uQvaZhZPwV5LKifIjw7k+0eiafj8onEwoHXZ/yqy/R9yJ9vYQ+W5hd7ATlUx6cs0WgiS6nBuvOnZglE5HhG8OaEmOQDmGgp1rDffNIlfb0uL2dgTJmvLqiVkFm0vNVngpZgVeMWPR+mzwaQ9HanyeN6CH8bXlLV6p9KWDmiFrF6nSF4bJ69GPJJ8Xp4kp3AbzXT9n2x0r/XRe/e/PQ0E41H1pMZv+qtylOXvEitMhG9ZSNqB6R6B8ntP3gSZQJFvTSC7WpAejN51iGXNll38IXBO1EwvJJpY8yM3ebQQ5KEIobAle2j91+ml0UMgnKsSoGEyyEJJsvQHJ3+n4mW3RrkHj1uSz5zPN2SebytnqEKF1Xum7n7tTFDyIpl6GvE4GIOj5nDw3O69DXO/DO89NXmXYVgE7NeaPATRQgQHxIhONw/FRJ9OXXK9Hf8BUvuv0TuOXGIZsXBh5IJnUd/N//Zj1s86BnNGdjUYEUOITAL9wv8V5SsOe5Nyjp8/wWddTt+VA9h6QsNr0Ncl/Sf9L3UtuU4Gr98HII7PzRfwx9iKDdMUao+czYdZMfbQ6yBEhdBEamW5OnyV2DJFVezAbebGOcSVO2wWL4AoV1BQ1JzVrfSJuFiOUpv6Ni8b4ZG8gURHVfGuldaMrMtV++0Z1Oy6o5O4wzt4j43p1uvbcbBb2g/f3JTw5iH/j0IDLbpqJa8+CIHxqPjWlfafMW6tCZykz/oekhoreNSHPoWTle6LwV9Eb56NMx0ibp4NQKI9KNNWXK38TyT+yMKKcULg9d+zhNV5NsAhEothoKfTpWggNq4MXBZicGfLKBD5APGSwEe/XZdFAYMYCkExQM6WBu9dX89Y9qs8fh+r2irznxFNJtjUK+CrFET+Le/Rsl1C45fAkdsnMfb8GoIXMCzH+rKaUY5vzHjymHiRJRRXzTWRz9x6Hdf/Z9PdRxudjoHLL4xiIkbRAG5M2GDK3lxi8e1Nl2H86TjM4ARxMZt8eMpnPHpdNRduHicWXOZbGtJxvV9NsdKcH6AHToS4Ouifj1X3ZgPpoi/N6/qkFFeDg4c1PRnDEzYSmeWzD3a1qxnoZuxeOh8c91rnRczbVLOOxPI6sn9zntu3r/AR26ObqxrCkfzTu2JoB0LlHopJE3b0BYW9KbTYtFxKhti/mU/6hGOnVmLTJO7mm/UD/UxlY1dBCCue4rZfL6W72P4n0V9ZwgV4wPIEpmGow9eFp8hna49YTpwKEGxfy6IbLpOmwjAAuWVuVBKGCYgnoXlvoVwSsAWDEcxkNR5P+4mKM3fvbHjn6UGnJXcuH8AYoDc6FWI1MP8sbT+vj/o94Wf5aXNmIbHo48/mlIa/QzHTWqyS5lKlyYCEng5ufeZ5SOeN/nY6AVezT0gWnfy07PEz4rSAOOQQ7m+2/zKRTESXd4xMl2QOoQQ9pa4xiNjMTshSHbAw3zQI642OGujzlNz7/c5JQMYeN3YO4gSs2+tMHh6f2zvSD2tN8m7MG1NLpWkvPArKGO75r/m28fMZpGdNZkPZS7+02hoduLzQ96PaMrO9tyHDWg3QmdX7eeD92LJn+L6qU/87QrHW/dnO0ZOGimbu2sg6Xd+nChBTis8YPpvS19zdZsEwM4x6kIAl1CFNeI3ZQcI7mdltVQwi/+bOY8G+3dPnZPuxxC/PWRq2uNyIz0uoW6NR0uZb8a5nQ02hq19CB0+Uyg/aTQ92+oijxw4WRY5Cg2fJTH5ZF/hDU/yHgQopM6dIEGui0mTUKJIeuvX3RlfsEaiRU3D2mE/R3M1//oT+9Ku0PjZZQVkp9Z3DtkO+WNwoSl+EdTLziBpP87rH8FVrzEQSFGQClrD1pRgOO2I/b+x3AGxWrx3XEU2XRqbUHJ1j3cyiSthM8diua7a8AKugPc8gJ63j1NrFEGJBCLssmlbMlHWT6ybUeElSfA06bSaelaKbQcwosd03tXib61XiE5Ku0aUumMwyULJp1XN/htzn41H+FvSX4C23vGMQcvAbw5onmk6mRMluIguC5qMRT1ExFzRVAZMRBNZIediPTmB6hHrmacr4xzaR38w17hnxvHL92lmbmy+eT6CJOCTCQuT4Z2IvlXXnBbtfLIca3sulg8JjT0rN4KnEVsGO9HzdGUWgXPKK1FrnlKulS9u66bbGWY2UjYmXqwupCE5WTsZ3bzaJk09WzWHHq8+MNKFR9tXSFpEAJCF9vKlTzxJcKglGb/307kOj21oHkalenBaCXmXv5Z3E0u5ajSJa2cqEC1RuSU4AIchUKgte3+ZF5pO3TrdLRsLM3oqFHBzInP+2ZyNJRYo/djc9eKcPfQ3beWfydiJzmglhprF6opcNi61B9DTIQNqvoBRMPSbD3zZQRgh6X1lEJXfB07DU8pg/V2CJTqK9Iy9R47K/Wyb1+2Tpm53iZ3QBTU6hOIFZbtaATf7XS6t3jFg+NXpZ9thtTNGQM2sP5cZzuZzpKQ6lCOkdTyHh61h9jIrx2xetycl5dyjwWfi5W5GJaA12/BHRd4DMAzdAzH6HmnGu8S1xIUmd5Vt9JCPaTMITXZ636IoJ7XECQSGIsjC1aKlgp9w1zxYD1wtphdcMsQ8b47mu4bm3m/Qtwc9VwF+YXLRqqL8CYTibEl/o44eYlIHrE8oD5rH8AEXAuX103wWOi5zML7RgGbTPzrKTCtnL5VD2QTp60Oc4kMiA2glrkKxxC5hKCkjarDUOrr2/WLka/ATKhXeuL5Va+sgFxjKZ4GPtcu+h0408FMbM1YJ+poI4sbiyzSnpZNnlXIFMziGN4k3e3ztV6m6q4M3X6D1kv29iNONiYXNvqto/Rz5vgFw1mcptfomyPgoUzrE8PUV4OLA5ivdktuqEXsOxqwar2e5649+wRL7Gdbe4+TBi13ZUn41nrnBw2nG93cPHuZqa00Np5LBJQ62VCRdAnDc+6/eK1YMdYMwwu3BCPECCYlMcPkfMPRgPk14Yr5yX90J6lZX1ZJLBoZnNnexdoPDw3+awZ3Tw11rh/ViEd+nd/3oGFMTWixgV3w8xTpmPyAwMwa15MltDqg+X52uO7+nM5CfQqu6u2Uu/jNk/jArwP8/HjV/oT4wWL3GugBxbPn2XsI5iKJ/SU2padxtmPuGrJ95bZs1oPiMUAWndA9CE8lKLffMeu3K9AQfeUj52E0JScvJ3talcb98fdkgezgkN/efUI2LqV/dGigoabU3v6L11EMd5xFBg087aQsS62o4qPyJdKvet4q4YJfCOIBJZiEYmXhbm2Q9OpP/bZcQkQTx496Kz3Mnw7yfIeaJZTVhWFmv+NmSKGRIwlgsGJcGs8hmalkD34KAF8iSPKpa4Ef70nZ9j1sJC+K0OVHHPNl7P3iA5w9dvSrCBCF4byeTuZL/Hp60jujHsQzumX4zli0M1A7qvoupiZWAnlUxYvtqQw/0h4r9E7Aj6zZJUGfzKH0pehHoLAah/A2CgEujEAtvd9Jc0x3XcAOMEy1si+lDZFbldZCg6C1JxDS7oToRHcvahtkgzCV3Yl45UNVIi+xrL+DH2Hpk9pvNqZikt2kE/Ydy1vHNOKxOGM1fR9otLOyO1F/TMAJonFvwCbp28fjWcWHwZA/uXA93GXm3CVF7GAq6IalvAUTzBWuLabscOoWjyeNYcc56XUC8lTukoPQG5S7xY1VxMHgmfNVgFfFrdJucin42XOIVy9qvJMzzFpUILjMebYZnFRu28Ct0bfaR85rGktiu1XT+UOaaJFIIXKJFW5CqWd+YpFJbUtzR4+zKdTRo1Hp2ehkvMLY+ZeIhxNEvlJtMOxR7TeAgrBlGAr89BfgF+GeaISXV6lqDF3nYkZcNa6Fzj13NHKJcsbRoeQCY9npsvfqapUxGIJtjjOnVXuheHjG9Yz/x9+Fzup6C+baoyjpva+vJl9EUGsvbvYdOcL3rxaa9NyhsXJ5Mn2lHZ+Sm52sSEDFXDkVFlYxziVueK/RyeLjUogG7Xl/CeDW5bA8KFsHmLCZljgl04hK8ej2URCGRvm3H7tWl876HenjgFC7Zv3j2/0jNT7HG21J3sXUKc25W66i3KPRGMPfw5nRuvfJ+UI1+PHeiVs29OnVrjqn63fNa1tMmNtO0yIvWX37FkmGMKOO0E2g6klH41uZempaqeaiFsiheJ8kuxS/Ws8r1BT9+4gN6cZxExlK2Re+cHWkvvbA+mFBJ5EyCp/W0as9ZQjge5SMAO+x/W1m8bHhotsk3pfasGYrvEAtD6LWYx7L//Y4jyEyLTvFHqh0e9Djyp6w8hsrFlgqARrv3GCYYyud7S6WOJd3wPeGaIf35R/0lyc8YS4qyHc9y1aBpnAcO6vRirzHesXFLuJ/OXLhdJSA1uKsfN25583tfdYtyzFjVwamgou45NxufwD8IznCRW6ZbylpiJEeh88pfVzHfzHqV6ZtZTDB2pWXIbxIkPYxEgx2oOpyJSFk+zJpWK5vQLSWPe9fNGQv4bdmyzSBZOdNv6DKsR0KbXL/utx98hhPoBTtrOBGgrJ49D3FsJkZzUvvfVPzwApkn4/pAgGM7vPkwEF9rroR5sIFt8jScGNTiXsb/PFiXsdq00am3ogwfn/1Elrg2LEFfQDl20OZy42CinosqRikYHAytS0wEaOE2+hNH+Owd4J6JAhnPXEH577sztt36OMAUFO65jvG4d6JanE1l1rpZapX8G6gXfzN0Oi03YeI89E1hSASDqCzGhne7XvKyzaPvRFh5pepwRRQ1MSAzE8bn+DsWa38MZM6zVr3nlB4ix/pynL9hc9JtyASRVmQxsiXHFkRHvvcc0/G1+dL1lr3FgR0UfhoFvNB7bWCKVIP++1pVmDwv/JNXwmSQ67vMGQ8g0Leduu1buNJgUYXtCRKOKlwman8L5AxnCXRQC0qumWYqmlJ38FwoIAtTytZxunHWZgRoTsmhB0UiYvzVnHrUPnR3IVVa7fiY8npQbki1E3TeP3NcnunbRB/y1wNGJyfFXTW85rX3qJ8JyJ0Cl/HFFNAvLou7ZlKcuzqZm+73/9C8RnL8UYkPLSKosVSWI0OAsuuUeNyirCATZ3CvghCPyUah4P4CmevHQh+1xbGjXq/KQUa1pkAzkJuiGLvIEBqCDUA6HrKC9JysTsUaPM6PsbHpg0ztKs9OOVf5VOJ7G+CZclDZEFWJeIhrO9RktYisQTlLJUzG1hz+xM5R/IgFGhlKN09yl/qSJs+i+nis2Zly+WJZGaQvafCEigfgblb7r9WFkqhrPTyGKRJxH6Le36w9yuHtwDs24SqEVAcJ25xtiV3W/bqqXl2b8VWIgVBQ7ob7op+qQPd8h2lk1GI5p6Y5IwuVAu8P8rnKW1JQ3LTQwJzb9I7MYhCSXONPh0tNjNQWu3AEBDxFf8YRWFNnDuIV667VSlmKWmyMSCaBPIX9YfKeS7yqIQOK1Wkp1E8zXWWhPnETHChQy86bZgPClClpPuCfa5euUrR+j+THzz7OsIC4PGsWwsGdpNYGw3cCYFmsghDjQrp8jUheAbIdlFRwTAh5i6oq3SCyVZf3GNikr46siQig8LbrqiA/TQHtv+/4wqptYaVBvUnH3MQ8uTsgHDsajYIGd8TBiXQ1wMmQ7LpB3hBfw2WSRHOsSYJLDHPfsyGSYMOPKpifFD6gxSE+qFZzjonFwf7frh83f9HVPug66BpK1cGtMwI64E4dZQkAMQtSyFtyE7zWDO5BRwkwIpPue0ibp7A0oPkOSpN3ijXyv9YxzbbYvnSG/zzd/FzI18u2o1Pak+zWDpMhtJqmgqxt+U+iUwX3zH+vWbub5r8YCxJbR4W+7zoOeK0JORcMw8ecXI21ysbF1ZPSvuvOi/YexvRYuQEAVIKcbOWbTdokGoahP7FnblZcHr7Hv/7LSzqFm0WI8Paq0J13ObcK24IVDJnOfQyRiD/x+GEGBqb4+n2cduNMtcX4NIi3FtPCa0RhMXBG3xNlnFAIuVL1QC2t3Gf24KhDbyb05xG7RR8U6pa5rE/XFUQFwa0nNJa7tMI7gGcNT2ow+SGbnS50fIcD6XcpAXlk9a/BR/7NLtp85rwWB0W9phUSUutKeIwQu52ZNTbOc29N1eT79Y7/PnAjlik9dFA0aNp8F7a/soxypN1OomibGnZDlPyAKFW5NixkOUT4hiy9Ltybno3d3fdpPa2PVFK721wsm/EJapovo5PeOLfmRWTc8rq/fBF3ejIW2ymr8AODvnt56mZ2uEoScW+dC5LJdmdssdXfXOQa6ocvM7OHa13wdBFcbgeVTPi6ks3W1KoV4zt4E8hT0HDHW3+PVp1T0gihV1J1SeXK/+olKfSwUjfsIb0NYgmyCA+k00XvJxMlb+zyOMPIi7gy/N1oqEVV/7WuJYFCosCKImeRVue+D5Vwrc++heEuGircYCvcbb2mXZvYGC/GUpQchKN1f4KgJNG0XP1HB4w515XW6NNWLFA36ASIusm7jmsHzgUFvyPG5iHiRZURbwdqszy/5CliCqPS2An/d7++dHaFiOwFg1ESnrnsWO1lsMBvBfHy7TOWnvRiw/LCXFRADF+f5HaA61nawS+74JBcCJkdkivtub4OkN8+8LAnI1rqkO6UoWF/Zomj0Os5bzcNYH+2GvnL20PBbycBbtec/L+R5wfHE1zFbY/lutFZTSpHONQ5B3azlGHeWgef2uIVP/UF0AAhfsMY7xwyyl63sMwqzbh4Ryrv+o6Ogb+CzvW5jQ2KGN5CV+lL9KYrOkKZVttrFtZauSQ+c0jJU8VpWNKhs/987TKdwGieuocsAq0HrjlZxpZYcw8HAjt9Tlw1vJ0P6GiEqXqaUXK8kpy5coluCaUL5eSH/Eei8ERV/8cRenkd15Om65qanjfhjkLUJu0P5CWpXwqfqGvIiD+AW0krHVnXVE+K3G8mJLaR4XZgOOnb3cNvAz8oMP0CJQnBYxwhrDcOl/bziS7yfRJitmZqHlRmjJ9v7tQRXu4nISfgVioWauEQuRa6XvA2CqtH/5wzFia1ZXd4xjZjiUm9iVDcYiIkE6LmreWmqxh3bjLiKWMn7j+oyGv8EshgdRmDWOq8Nu9TR2nPuumFGR/p7OfeEZu23WI8jlEClXBdEupXpUedfe8MKb311G44xkecS1WnC/lmmUtAOueBH6HfJwX4qfunqshlpuEGr6k+wJG/tAsQp7Mm9QHyiciXEWvPKWZf4GPN4kZPEcNhEyQyQ+NeVphQeWd3n28ow744ENROurYNWTwv+sm6nwqrC3KidmBl/wAprX20zR0su+/N89Wtugn3mgz8CM7/GNZopelcUJY+U4CoCjwvC/DGoED0tO9Wfe9IdxftW9ETwdz7A7Pa3x501FNZb4OO8RGMy96My1YFxu7xV7yEbLOs00GqpT8MZ8Y1wIIAMQJ65r86cLgL7NexEqfRNdd1e0PurZRCQbdAijv6ODROeC+z6aEp2W9rgjavORwrKp0Lb7vXgPwSojWMfdURMLjgHsbz7xrDcxGWly5nJKouV7+qY8kPc5NcJ+Uw+f2KaSIiTKfISubckdKiTDkafeh31hMSW3qNgQA8F/DJaIf4dgqSF3A8xpDvf2cuqXmVFDBOJ212jFu9ecrbVKs8y8Cu7wdhSLCV7ed4K/w/Qcjj5A+QPYy3Sh7y1c77md41jfJPmRg+C8TsWwzvLwUX83G1mDUUCWE15JYZQH4FWedXRhoFPRCvvJs8AytY5vlAB/ubL6nHi7DZ0wGoQFH2uMy4f75Qs6IjoRrfQzUetXZmU3iMBx+dNcAYkoTKwZnLP+VaOqtRc7vU32B/m+wVXHhJqbGnhQi0u+7lcwwEhc1ehbkBoUT1DAWVlcG+hJGgqGZQV5ozPzknsdFWdQ3kGUB2YS0NH1CpMH6vwCAFOCwmfB2GhZt8HTSaXkBnhLYj07/fndOfspXkDNnzNpcD7XXlm+6u2IxMwEbsSjaMix9xoZ29W0fhfRRduregF4B2r3n320KiXXymsNuhpAT2ZrzM8tsaJccBhs8SE7gUjXyjdReKuyraKrDCn4XoQRaxmbcp5tssToSaDs/ZEhxwrqZZGEENpskvdxn86FIoYIOx/8SRluDyZBGTxa/HFrCJeeIVMN9yMkcFC74tMEZ+Ed9RYcYFG/pkbIuEyRt8zcmDhIKDbYNEpdVaVXe8zIMea3laKB2XgLLz6yRakkzKitFPi5sDCjdpv7rfmgDjEGkzVENGcQLFcnPIHELKHRX5WlMuLuhwIc9CTXW8GKKOZM5e4esvw7TrHa+3OI1FY4DTPjCyAi/EXJD3IGOLTIWogCBX2TJnHf6OlAQrBts9kj/j2coMaeXLhWM5KxC1AfOODqeOPv3WfArvfOgloG55m5PZ+ZNvb9mVXtD6/eYt709RRC3eYT1yFJgQZfwsvi5SktHZya3rWxdL9cwPdSv+VbmCo/ds32deNpAyoa3yttJW/+FZA5Wg9v4csgxZO8rVI1br0JZ3mn/pSuyP8E/Ayk6ylF9qPs5TLKorBUTqky8MYfPpRKmuoI1Kdlsq28DpfIVh4k/pKeJaYvfGKtsvKgApZZ+HQdpS0hG5VYvTnFfiJ5ZDCfpVnvlT77XJMjHciTMWY0+s5tUpHQTBYUcb/C7w9v416CeuEg2/prXutrjVsKwQIXDCzYVEcHsOoyOCbRTwhDKW6YAMawtFiEVyApN+3yA2ymViPrFoj1xAUN3OWu875EAbByNlUgLpBW53dDGHYgyUFZIXoue6F8iyq0V15C/NDt8o+DkXSxk7a0ULaBbq0vvq8PF/fgD8BE+H9kyJsY6rVaV0b1I/jZEXauzSbJw98ozfrOJ5ver/2PMWPLzoiq+wCJywkL8wUCrVbCVXfZHGLoJXBMCp2fr4tu2h7xU/a39LvmjeycYJi7fnbjS5vDQqsRcvp0oLlfqjcgtjmpi2ZHVV83Q2CLWwDRhwwdg5HtEHAX2Z7ZTmOTMfzjMRmrpP3ruibOQbO1/A8vn33P4mL/rIaGNGzyIUjGLYdJ0OP4VH43CgM4ggJpdTSrNCX4mLDHoYKMS9FZ/X/5CGc5cUPnfkqiB94M/Oa9niS2WhKCnx944h9KrGr8ryWBPA2/v5VzvIKfEMQ0LrIm8cIxiEzlyrLeAsMhlrgjqfrAhAKzFUB7kns3RWCXfWfsYPke0CuXHeNks+T7FaMSUPbdA1zrcHm8UAiDbdL3nGC0bUh99NP0d3ztdxB4LKUfBu+lL1RH5QqHoiZNavWXmJYLI/zn+6p8JE5q8A0BV8Ea+buSnoZkbJ9E8le5Eaxa7ERQ5CKlHAHxQUzDgpXUDquyqaTao3f1RnEb8HFnbD0kIG+h1AdCptr8/Jy3Gu4n/2yt6kCuTd3PlXR8JrBDC73pyJCZSgXIH+TLGl00Dx+oHrf9yEM9CNWODSyxwDMGXTVrDrnk8Tye4abdx980G0ZdCTEOaSl9qsWJKCRN4rq2zUjNXqk/jfm6nPSmUwqW3+zpw/LDOTKuLbDaB7Yih/3srDmqAkXnFyF916MJz0ONKvc8/PzbkV0vtLkr1lpNQkvlA2RX0j7PgS0j9CGOiwfSOtnwsEYUdgACHuyXAcdRgIOlX6glgXgyWo3To32uWkheucqNLnpWGKY/ZRPpaquPs1F12uVKX/Kd24yk9Ea2metHctIp9DsM049fbSUpORChFnAtUGuSaBbwWgaHdOdcwzbloUc+dbyXqaxFefCSRNLvLjT3PiyIQuqHF0ZAMaNDipt8Yix/TAq8h74DzMznA+I2buPapnDClIz7yxRulyze2l0loo4
SjHAxpJumqD0qBnDDboq2lHNfaPCkq5AugaZ1C2jH1UC4bY9HQGgq7uPu/jDg2P0Ko9/xOnak+mXkP8v+Z4KiONQXMkW2CxsXu84zhMdDQh7fENwt93phdpmnG+kXbb3ztvOFVHE0DAVIur2J9GPXI0J6HoB4p78O4mlCiGZICx1YkA0bgJAPa5tj+mlDrYKSll3zEd0guNj+NZErMZHvS5C2SfRP+hX+Th5B87eh9WzUVNKh2IRp/g3lEOsCZw95p0P6QIghJapYC3mS4JeVWFM55mO/gdc5lxY3zuBXv9rI08ewKoRz0nzlTzOzPw2EuJChsnmeansGubkgLq+Z1TN9yH9X+qSxevxqQUO11fyxErfsdduPAoSlG2ocTKLgLR1RgQD+wYwayw/frORNWIU8BVXyzApw9S/GstflMt8Hk8YG/+fDND9OoQ4/JKGm+VbIhzfyDbd3ZrZERP5gNxiJsFaDSWzmZxSy1syFARE7NfFyapwjuOsehrqO7fdsNW8ypN8GvJJHtQA67WPY2tCPJmBUG+dHbhqPn+IqrDbqUmWUgkFpdPCLNqrjvfuHf2qw5R063gL7vD1ficJUQrHK47VbvC4qBju5n3A8xPCWDRYqaCZYNtgRe/oGUmM5IGH2bCsYGbsEkeAeQZ5NiC5w2LDfICqh6ny1KEVipSSVlIXb3Hqr/SebSf/+b5YcFynTvPE6uk2O3tNj6SJKwywrWjxUMrCEF4EvQpbWwrVIaaCpIkJ5sIkQn5WgdzTHmtIt7IOIKb8WhTQOPYZAG+87Ds3TAgze0oxI4Dl6b1pgZw3vUHfEp4sZpH6bxy0/ctzvOOkaYqe0RY2gHD5EGJtDdcvi49gZ+eRN7/SLUfmRhj5EqZBHakvAB3jB6q8E3OZ6wO43HqCfMEId2C9GYY062xPBeXMGsblcV5Qya/OTun+Bmi4XckPuN+3BECn/j2sWe6eii2FeJxs/4TxSVEEDf0adUboTqQK2s1aDF2zHB4BS3ShhqPTYAI0LCM5LeJevED1MGqvxT4ZAKepafMOZMso1ZSH43F59XwYO0tW8y/Yt1T3ubXer03z6dl37rE93pPDC8HN2Ur0+Ae1ImgSXmprtVr5rQYVSw18+ohruPeT62ac3dcjg1+G7su+GBtbGCw5SaJS4K88rEv2ET+1lM78U26PWgry6KFZkQ67HqoAfTEebV0ES/j8XYS9vHpjSntO9KqcVQ6UMqL98jmge5YtoRPVXvOHHKWOq2JsltarE7i5wruhOHFHOW+h2oobKPJ6CpM73Mdxi89QcHNsljhM6lF0hToxXNzwikME5BGCa4nGPFRuRmsqpkXa5XaP9iXa96KXDlkO/5cCoL+poz/pn0gngGPHh/6cPoVKW89otc1AYGo7BqxBCUY7c3s4bhtONER7DHA4cx9WUEXzQYhaa/t/Q+OzXT4P07ETVL/f+BE9gorrQjd0bCqj5Iev1DuJPxcgL+m0bu6mXaqhpqXUrOs1TYEn8WIqJ9nfyAywM1BtbKLCTaS4F4K8iiz8VO7+1MXusyT4WBt18/O42Mf7VnlpWOywY1kP6micN44Xk80Vxkv73v/399GcmMlVxegYXxvPZT35LKuhIfGvHGapHamHKRXru+Uaz0cVH4aB0leNOPorrgpvV7fev5iaiIwp3FHeEn18pz3pZT3/6PbpX6Tb6MgsVakMa+jGdwyk2WQhAoq7t9CK4vxkqSHJwiIC0tBucjXM2o2hjeSaPZ+E53LhP5UYl8PL+MFBOhhyslIeFL5sjZF9BqED0vKWC0uoKglGIDbuf7RFkYGVkzpuPFL8ySaYCNTx66jDJKw9qCkF8gMl8GmX2adoILsr9QDtzjpSHKu6Yymur79ex693k12y4FfS6beiZ5Wfsr22KTkCpv0bj99L5RCQ+bumKxsoidkwazPoC7NqYiryDsDLTpf4Zni9YSPSGfPcuUdUM9eNLG45fXPAuo106zhSXZhB/K5ARs6dkj1P38/43r/VYLgIKROmbS2z+vBCpv0cgClEIwLcdkFEDc6lVHDwrmNa4wBrEL6eGNT6LDBh5Zc93EXIs5AqhG01NMneY9UGtresq865AsSJYpJmjiVZR6E8nELs6ctDC65wSmF7l01z5jEXD3yBF6igNNzcqg8nCreTdgYU/zArjzFVFVBFlVeKum2wgkMKs1v/WBbyU+fH6KD7hITKWM8nNA/TgMIEzOS+W2/i1wu608EN5BBcRWkqz9KpKzDOfV9O6PVk7f3tidyGGtE35UeYXUzcLECAddngeR8UkhaT8D6n0oTToFFCNesjhTu09DrMGbmiL0nVnCzJ31+twtMPtTOMQjiHHxLj4Kmsz/GIVG96q/4j7uIhtVcafrdKszUTxV2mo5FsILM2c/qoC9ieQje9ZUZ5dS8nNc20HfirVCfU495gtpja6crmWFBBBz15vPnY79cFXJzvPa7D18NZPcMFDoGhbJDVat1DKOPeSmTHh5iCLGHyrNhJULRGEKTew3yjkJyGOGfFtw1lprRKw6a7PfUUTdANddCaeoGlLIkhoCj60crxVxPkjv7+tQyj90BEgp6paZVPOAhb0DeOpNEsPs4zrQCLBWADDnh8K23vaHnDkT0lWQ7+YYYJjzg1wcKtOE9TG4lU18gWISdqsCioVHOkY6mnA0j20zQC+4LZEMTSRYBVdXcaIIbqLvyA3t+dky6hOJUeGi5B+2fjHuWVCcgEWc/RArqX3H9NYKxUR0Gi1jt3LOBoT1FUQEecjSN7dMAOFfGJPbrLYprupVyvvSGWdGsNpTdtI1+p+1Vt8Np1svXc9yin1Prvc+W/wi0xMi4LMV0BkIHLuDdYYG08GHU8Yg52nrANasaN4FqdhH9c3wes8sAiyvj1dmfsJBjGs93uuSTwq5V+8KwdFB7WsswzD9qNMXNzoWCKpUaGOcGF9y5yidVSPp+lxusFA0Bbd/LbM4ltuzn2mgiqMBrr5/b9GC2qodSJ85pUyFLMc3mopOzEl2CoygqUXqPTOsC3anIeWU1fwMyB8MjglRIpdftjNcSzamyytWH3OpLYQUbN1iYzufu26/QkImhfYr84lD9eo6XNqL/G0sS1s0jAI5Nfctd5wLImuN4bk19JLfrRwh91XF4d8qKlcXgjD+C7LEVq0inP1kUil8OTALvTIXszCbo5a04JcxIiDK+I5UEk2ynGGFI2LQF83XE/Pi6ppq4lMqp8xZd6iWVlfCnjgB3mEm3MyN/Csm5HySm4rFX9Cn2EVYqhZxVCX5Q5DuPOQlhBi5cdLZAkOWP8hFAKNvHFHjVflaW35c7WUHl8E86+CHdnsLHAcj+RSHZlLiX+LV2sSx/ndpLIUzrgSZgnEgrl00oVQJyAegEEiA3j9YwaASVpikSi+vVla67ZJFrZJrBMrbSLIXDX1iX5NwjEszXGwfiDMpquUOVOG3dHlTHRtEJlVrBym7x401MTW1prUEos5x30ItAowkWHuMkMZKmdFbZQYNOVdz4Bx27XiwZXnYByqnjlByyfxS5bLLZvES1Km4ZrVW3A/mzo0u0BuMPVKzVeZ1DmkS+hjPdoJDVaC+zimAAl54gojKBkq0xvYWyxfEHTWEiGS9FWdPf25ACjBT4aqWg6/7tbuoQ8nl/qL7Zj5x5fz1v+I+B+uSmEEO+WtYgoLcwAIi/jv865bvB1LQc0FTv7qKOe7ppcelzRdwfrGaf7ZbESlmprc6zi4v4GO0Xz62FW4vGmnRFMv9MSTnLIhhdM1Gmmp6W3QYGcYnvjicOtLwBb9zRHqYN05N80we1APazQRJCMK2j4pEWZNN7fpHa21kptAj1/4xVxdQkG0Fr0dZJXp7t8GkDJPleOStHBRAtPGF8io3mXYbeHCaqLf+nn3LLAj4H8NSWiZlK4lNczMznWdBUXJsYARCvyPzGIFrDKasX1wv2heed4SwukqEOccaDeN9w7TUkUmA9uONNqlDIu2j1BPBPmQhEsbUFcy4wST8TGLPDD+2SHjV/d+eXu6UTE85Ysw2bcT7g9LzVsCRkm2SaQyBIqay6ItEycpZ7DU/ZNR2ZJGjVwAiqKpcIHsmR+I6DsncePA8N8hAnge4lcNghC5fFIagQRwf9OqrJMMeN+KyxhoKwQoMtowQEMfWyhQ+nzbd2q6LPUVWB/GB/jhVPX47i228rxz7gSa9ShW/YyeobsZ14rYBnx9FAoZBw0+2+NS31GqLX5fxon0Jb4RGnLVFofZ2xyd/keTiiuOjQr9yPLBRaG5oWkIZ6lDAo47yatPRKzjebGQ5RloPtvxwSSDngIOaPsjBeGawVle7O//H6OUiksBVIQ3NFDdUlI6BfwTYr50eHhOG4u9IE4lRWrGy2ly/OecaBu4+1asQYVlGG/UV4/ezNTHkNTb3oK+RaT+SEXUQuf1rCC2E8t+6zAmFvy/Bfl7g3ruZx/i1slAEApN6GCbskKGvAhj+sc0vRuR+zYGCZg4vvu/MvSLoMpLRNT54JCVzSBLLRUKj+pYwayHrLoISfSp26MEm+7C5+gp+5f18QUTAeuYt3LoAPx7EyMkwftkiuaeLHPQ9JX0FTDcJf0/m1bz1OUPRRhYIkP5mIpwIVq3uI2sBfjKHR/KuMRwecu7er/z4+WT6H35Ire4IZL2icofX62QJQd9cAeUPisgH+g/rkyR1IQxjhz8gcBb5O+xT2vnzsFhLIW3lyCD+HKmG/u9if+v7kB0SLrmbjdFyayqxQ1MlXUrkcoRbSnVErISJBJV6ZUqE1hd+yKJnL3hdTzrJEaqIuyS7Xua/CjkHc07V/qdE/OFvvtmh24VEheesYyaJ/pPpw5+uvrdVCH1gqrIlFt3aPC8U1rAQxXXskClW+nohAKWyMHOZbecQ9v1qbOo18LJy2Vt91O6QuhJy1MYP1XVqm72O+AOiFxticuoWSoDredRsOYgfoX4CgkWmXkKVRlxOcT3DG2iYMYTi7QrJdvOLWBd6t5GpCjNeSgb/2neGYNzlJIHBgJlTONPbTu7bXt13UNuX9j5JiTrfoix/QF2tfZl0Z1fmHeHRzg0ilhotsRmnewUcW12pExAWDiMbtJpQmne9mgCezlNIrwM3Ln7f7BykCPY+td5XKawp2+7mH7C4oIud0WxujMruEPcVYILXuvwk+FnsLgXbVaVlAIodyyljMcEHPDFr754gVbejfYMHRWZ3qwidjWUDmLReffwKQdM+CYRBIzw27IvDJbP8KOz/XJqry8Nsg1DaoWKW1Lb2/hmmCLnDWe9uvI/MQeGorzNz0D35EmmMWmPHRLNs3eXHD418jerkUT2gUaui7b3E8p/vzlXI33KHcSMSj/NbeS56+5Es411CW30jIniNCE2Y7aAqBMu77v5C1EOYao8hnkMKDmVWk+7xJmNDD2CcC0E5yP2XnxKADhkMe0euflskxj22uYTMFkaIpHvwyEYUFquhkJ4sBYV/vecI5RcLFBH3vAzZJkmoDhgXBCy6/Tehgxww8+oZvHefOXZYU1Kd0CK6Ih8GBQv9pX8fJ9Pm5l19X6ri6VqX433lmZpSpJvS2VtVUIJL3XcjDT1gHlzYdtZYZCTpb+hiJoM8OKCMJy+9hjGiRCszGI2PKpstzC/vP8n6QHmgnAvZOL8NnIBK0n/OafwEhhS6VQUi1bpql67/faBiSQhsUbELeEMxFRW3O+4XibdeTDjEBJrcjr1XDJfERUyr5PSgJXIaURtoOb/h0ZyAmxeyBP/2dlll4GR2eATJ0skEbROve1pQC2WPq0e3ObfMpd/ROfIXiB3pmzaI07YTIfcy3f6EcN9i2TpqIDyy46b8s24AJJAFAEzPIX8BlGw4QaYQCn91iBTM49aDTdftGXqJ2WBJo9BlFdY7ztpE+L4EGY9R9w9GY1JphsjfZSAr9F5L0QzkEUBVAAW2khPvC3pVPck4akjtEfesGEapVyHRt/RubbE4dkhPljiDJGnX36x7sVOClR383sAOOafgA9q4DWBwKfiHTtYRu+iMsnipat4VmI2arxLRBfznZ5v+WiTusBr3TPOVI4+e6L/Vluf0Mi42cir2XQGygQokoQkhKJC88ayevberp8wBjiG3buvAdTYPiKaAL6fbHdiB62Br3UhWdzX6xKw9ueLyUyXDIC8DhtWu/Ilp6NTrxVbg4KV+dQHv8o9wLLSnvBg4t88hgOdP8vbWdTpCN5wyGGER360JiPrtrOKrfHZXSwbrbwajFGSpW9rDPTBu09WpYASkQMMZgTYhwu1beqSst10xOTgnDvEUT7RaY10cpfABxWRuc1KIwpEkYAUMl5LnLHRoBwv0v0xMNmRrn7ZGtb9Rgqt21ZJgsP14wwswxSCuyQ9LyTimN5ud1UDSMH0pTcIbwoG+xy5ZWXLqXOCSFoaIMAKGaaLQfJi4+zJOIb5it6WFBSuwIfAcI42FQQP9pw/UcjGpzBEkD7kImpKejdwQMEo++Of0U9eivHoKa0G3uySyu3/a++4SGgcJvq3DoXh9yB2F8EpXETGraAI8zH2Ue3SPEaSPLr7h8kb6kb0VEziC4otThnYg21HDe74TqHMkUuxTX8kvhM9CFfgrj4BiP8U1hl78HqumD77K/HUeRVAPbqsAVez9JHKAYaa2Q5OnAbIMnbrhPeskIEXs4RRYbr53Jq+Te+Jd7U9J8JRPmsS3+BdiqKcYXpzvvaYrq0No2TczWomdUpmShKlkuA88MgDsmPmpXKNE8++XkbUug11touZ7Ow3q9RQJd5Teh3Lnvm40HrdPvHmLxu0G5kGHRMfpONun16Q4fSy5LQ3tz3NRusjIpnNuRtrXu47nkGZ/7toIgy1MlF+1N0mXs2ncTo0fdhJLQHaNe2punW7ABtATha+m5qTNA4Kchu4t6NYzt0KrZMjyce69PC9n9n74qKwKVUeCVvAIeFZEw6/2xT6JZxcWmGYqkCS+YnYAntV2NVILSZfov7aX1jolQH8tH/4Kd3n6qvzCpzmOa8li3tXAJUgJsvkBuE0u9jEpBlm8ghgqLpiP+pq2UDbiHKGTVSK0Jmce6MF2BBELNZf5UpMb33L9xqm+3wDALf7S3leOXPTi4vwemlZGBdeBQAM7Na7VSgG8cMM7gAAAA==
`.trim();


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ÿØÿßŸÑÿ© ÿπÿßŸÖÿ© ŸÑÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä localStorage ÿ®ÿ¥ŸÉŸÑ ÿ¢ŸÖŸÜ (ŸÖÿπ ÿØÿπŸÖ await)
async function saveToLocalStorage(key, value) {
    try {
        localStorage.setItem(key, JSON.stringify(value));
        // ŸäŸÖŸÉŸÜ ÿ•ÿ∂ÿßŸÅÿ© ÿ±ÿ≥ÿßŸÑÿ© ŸÑŸàÿ¨ ŸáŸÜÿß ÿ•ÿ∞ÿß ÿ±ÿ∫ÿ®ÿ™
        // console.log(`‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ${key} ŸÅŸä localStorage`);
        return true;
    } catch (e) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä localStorage:', e);
        return false;
    }
}
// ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ÿ•ŸÑŸâ ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ© (ÿ™ÿπŸÖŸÑ ÿπŸÑŸâ ŸÉŸÑ ÿßŸÑŸÜÿµŸàÿµ)
function toEnglishDigits(str) {
    if (typeof str !== 'string') str = String(str);
    return str.replace(/[Ÿ†-Ÿ©]/g, d => '0123456789'['Ÿ†Ÿ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶ŸßŸ®Ÿ©'.indexOf(d)]);
}
// ‚úÖ ÿ•ŸäÿµÿßŸÑ ÿ™ÿ≥ÿØŸäÿØ - ŸÖÿ∂ÿ∫Ÿàÿ∑ ŸÑÿµŸÅÿ≠ÿ© Ÿàÿßÿ≠ÿØÿ© A4 (ŸÖÿ∂ŸÖŸàŸÜ 100%)
function generateInstallmentPaymentReceipt({debt, paidInstallment, storeSettings}) {
    // ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
    const customerName = debt.customer_name || '';
    const customerPhone = debt.customer_phone || '';
    const storeName = 'ŸÖÿπÿ±ÿ∂ ŸäÿπŸÇŸàÿ® ŸÑŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ©';
    const storeAddress = storeSettings?.storeAddress || storeSettings?.store_address || 'ÿßŸÑÿ≠ŸÑÿ© - ÿ®ÿßÿ® ÿßŸÑŸáÿßÿ¥ŸÖŸäÿ©';
    const storePhone = storeSettings?.storePhone || storeSettings?.store_phone || '07803092185';
    
    // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÇÿ≥ÿ∑
    const paidMonth = paidInstallment.month;
    const paidAmount = paidInstallment.paid_amount || paidInstallment.amount;
    const originalAmount = paidInstallment.amount || 0;
    const paidDate = paidInstallment.paid_date ? new Date(paidInstallment.paid_date) : new Date();
    const paymentType = paidAmount >= originalAmount ? 'full' : 'partial';
    
    // ŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸÖŸÜ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØ
    let paymentNote = '';
    if (debt.payments && Array.isArray(debt.payments)) {
        const paymentRecord = debt.payments.find(p => p.month === paidMonth);
        if (paymentRecord && paymentRecord.notes) {
            paymentNote = paymentRecord.notes;
        }
    }
    
    // ÿ™ŸàŸÑŸäÿØ ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ™ŸÑŸÇÿßÿ¶Ÿäÿ©
    let autoNote = '';
    if (paymentType === 'partial') {
        const remaining = originalAmount - paidAmount;
        autoNote = `ÿ™ŸÖ ÿØŸÅÿπ ${toEnglishDigits(paidAmount.toLocaleString('en'))} ÿØ.ÿπ ŸÖŸÜ ÿ£ÿµŸÑ ${toEnglishDigits(originalAmount.toLocaleString('en'))} ÿØ.ÿπ`;
    } else {
        autoNote = `ÿ™ŸÖ ÿ™ÿ≥ÿØŸäÿØ ÿßŸÑŸÇÿ≥ÿ∑ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ: ${toEnglishDigits(paidAmount.toLocaleString('en'))} ÿØ.ÿπ`;
    }
    
    // ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
    const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
    const dateStrArabic = paidDate.toLocaleDateString('ar-IQ', dateOptions);
    const dateStr = toEnglishDigits(dateStrArabic);
    
    const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
    const timeStrArabic = paidDate.toLocaleTimeString('ar-IQ', timeOptions);
    const timeStr = toEnglishDigits(timeStrArabic);
    
    // ÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
    const allInstallments = debt.installments || [];
    const paidInstallments = allInstallments.filter(inst => inst.status === 'paid');
    const totalPaidAmount = debt.paid_amount || 0;
    const totalAmount = debt.total_amount || debt.final_total || 0;
    const remainingAmount = debt.remaining_amount || (totalAmount - totalPaidAmount);
    const totalMonths = debt.installment_months || allInstallments.length;
    const paidMonthsCount = paidInstallments.length;
    
    // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©
    const invoiceId = debt.invoice_id || debt.debt_id || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
    const receiptNumber = `${invoiceId}-${paidMonth}`;

    let html = `<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="UTF-8">
<title>ÿ•ŸäÿµÿßŸÑ ÿ™ÿ≥ÿØŸäÿØ ŸÇÿ≥ÿ∑</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Cairo', sans-serif;
    background: white;
    color: #000;
    padding: 20px;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
}

.receipt-container {
    max-width: 210mm;
    margin: 0 auto;
    background: white;
    border: 3px solid #000;
    padding: 15px;
}

.receipt-header {
    text-align: center;
    padding: 6px 0 6px 0;
    border-bottom: 3px double #000;
    margin-bottom: 8px;
}

.store-name {
    font-size: 26px;
    font-weight: 700;
    color: #000;
    margin-bottom: 8px;
    letter-spacing: 1px;
}

.store-info {
    font-size: 14px;
    color: #333;
    margin-bottom: 15px;
}

.devices-bar {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 4px;
    padding: 2px 0;
    border: 1px solid #bbb;
    border-radius: 6px;
    margin-top: 2px;
    background: #fafafa;
    min-height: 32px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}

/* ÿ£ŸäŸÇŸàŸÜÿßÿ™ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ŸÅŸä ÿµŸÅ Ÿàÿßÿ≠ÿØ Ÿàÿ≠ÿ¨ŸÖ ÿ£ÿµÿ∫ÿ± */
.device-icon {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 2px;
    font-size: 9px;
    color: #333;
    padding: 2px 6px;
    border-radius: 4px;
    background: #f3f3f3;
    min-width: 60px;
    min-height: 22px;
}
.device-icon span:first-child {
    font-size: 15px;
    margin-left: 2px;
}

.receipt-title {
    font-size: 20px;
    font-weight: 700;
    margin: 2px 0 2px 0;
    padding: 0;
    border: none;
    border-radius: 0;
    text-align: center;
    color: #000;
}

.receipt-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    padding: 6px 0;
    border-bottom: 2px solid #ddd;
}

.info-box {
    border: 2px solid #ddd;
    border-radius: 5px;
    padding: 10px;
    background: white;
}

.info-label {
    font-size: 12px;
    color: #666;
    font-weight: 600;
    margin-bottom: 5px;
}

.info-value {
    font-size: 16px;
    font-weight: 700;
    color: #000;
}

.customer-section {
    padding: 6px 0;
    border-bottom: 2px dashed #ccc;
}

.section-title {
    font-size: 16px;
    font-weight: 700;
    color: #000;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid #000;
}

.customer-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.info-item {
    font-size: 14px;
    color: #333;
}

.info-item strong {
    color: #000;
}

.paid-installments {
    padding: 6px 0;
    border-bottom: 2px dashed #ccc;
}

.installment-card {
    border: 1px solid #000;
    border-radius: 5px;
    padding: 6px 10px;
    background: white;
    margin-bottom: 4px;
}

.installment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
    padding-bottom: 4px;
    border-bottom: 1px solid #eee;
}

.installment-number {
    font-size: 13px;
    font-weight: 700;
    color: #000;
}

.installment-amount {
    font-size: 15px;
    font-weight: 700;
    color: #000;
}

.installment-details {
    font-size: 12px;
    color: #333;
    line-height: 1.5;
    margin-bottom: 2px;
}

.payment-status {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    margin-top: 2px;
    border: 1px solid #000;
}

.status-full {
    background: white;
    color: #000;
}

.status-partial {
    background: #f5f5f5;
    color: #000;
}

.debt-summary {
    padding: 4px 0 2px 0;
    border-bottom: none;
    margin-bottom: 0;
}

.summary-grid {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    border: none;
}

.summary-item {
    border: none;
    border-radius: 0;
    padding: 2px 8px;
    text-align: center;
    background: none;
    font-size: 13px;
    min-width: 90px;
}

.summary-label {
    font-size: 11px;
    color: #666;
    margin-bottom: 0;
}

.summary-value {
    font-size: 14px;
    font-weight: 700;
    color: #000;
}

.notes-section {
    padding: 6px 0;
}

.note-text {
    font-size: 13px;
    color: #333;
    line-height: 1.8;
    border: 2px solid #ddd;
    padding: 12px;
    border-radius: 5px;
    background: white;
}

.receipt-footer {
    text-align: center;
    padding: 6px 0;
    margin-top: 8px;
    border-top: 3px double #000;
    font-size: 12px;
    color: #333;
}

@media print {
    body { padding: 0; }
    .receipt-container { border: 2px solid #000; }
}
</style>
</head>
<body>
<div class="receipt-container">
    <div class="receipt-header">
        <div class="store-name">${storeName}</div>
        <div class="receipt-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">
            <div style="font-size:13px; color:#333; font-weight:600;">${storeAddress} ‚Ä¢ ${storePhone}</div>
            <div style="display:flex; gap:16px;">
                <span style="font-size:13px; color:#333; font-weight:600;">ÿ±ŸÇŸÖ ÿßŸÑÿ•ŸäÿµÿßŸÑ: ${toEnglishDigits(receiptNumber)}</span>
                <span style="font-size:13px; color:#333; font-weight:600;">ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©: ${toEnglishDigits(invoiceId)}</span>
            </div>
        </div>
        <div class="devices-bar">
            <div class="device-icon">
                <span>üßä</span>
                <span>ÿ´ŸÑÿßÿ¨ÿßÿ™</span>
            </div>
            <div class="device-icon">
                <span>‚ùÑÔ∏è</span>
                <span>ŸÖÿ®ÿ±ÿØÿßÿ™</span>
            </div>
            <div class="device-icon">
                <span>üëî</span>
                <span>ÿ∫ÿ≥ÿßŸÑÿßÿ™</span>
            </div>
            <div class="device-icon">
                <span>üî•</span>
                <span>ŸÖÿØÿßŸÅÿ¶</span>
            </div>
            <div class="device-icon">
                <span>üí®</span>
                <span>ŸÖÿ±ÿßŸàÿ≠</span>
            </div>
            <div class="device-icon">
                <span>üì∫</span>
                <span>ÿ¥ÿßÿ¥ÿßÿ™</span>
            </div>
            <div class="device-icon">
                <span>üì±</span>
                <span>ŸáŸàÿßÿ™ŸÅ</span>
            </div>
            <div class="device-icon">
                <span>‚ö°</span>
                <span>ÿ£ÿ¨Ÿáÿ≤ÿ© ŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ©</span>
            </div>
        </div>
        <div class="receipt-title">ÿ•ŸäÿµÿßŸÑ ÿ™ÿ≥ÿØŸäÿØ ŸÇÿ≥ÿ∑</div>
    </div>
    <div class="receipt-info">
        <div class="info-box">
            <div class="info-label">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</div>
            <div class="info-value" style="font-size: 13px;">${dateStr}</div>
        </div>
        <div class="info-box">
            <div class="info-label">ÿßŸÑŸàŸÇÿ™</div>
            <div class="info-value">${timeStr}</div>
        </div>
    </div>
    <div class="customer-section">
        <div class="section-title">üë§ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ</div>
        <div class="customer-info">
            <div class="info-item"><strong>ÿßŸÑÿßÿ≥ŸÖ:</strong> ${customerName}</div>
            ${customerPhone ? `<div class="info-item"><strong>ÿßŸÑŸáÿßÿ™ŸÅ:</strong> ${customerPhone}</div>` : ''}
        </div>
    </div>
    <div class="paid-installments">
        <div class="section-title">üí∞ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑŸÖÿ≥ÿØÿØ</div>
        <div class="installment-card">
            <div class="installment-header">
                <div class="installment-number">ÿßŸÑŸÇÿ≥ÿ∑ ${toEnglishDigits(paidMonth)} ŸÖŸÜ ${toEnglishDigits(totalMonths)}</div>
                <div class="installment-amount">${toEnglishDigits(paidAmount.toLocaleString('en'))} ÿØ.ÿπ</div>
            </div>
            <div class="installment-details">
                ${autoNote}${paymentNote ? `<br>üìù ${paymentNote}` : ''}
            </div>
            <span class="payment-status ${paymentType === 'full' ? 'status-full' : 'status-partial'}">
                ${paymentType === 'full' ? '‚úì ÿ™ÿ≥ÿØŸäÿØ ŸÉÿßŸÖŸÑ' : '‚ö† ÿ™ÿ≥ÿØŸäÿØ ÿ¨ÿ≤ÿ¶Ÿä'}
            </span>
        </div>
    </div>
    <div class="debt-summary">
        <div class="section-title">üìä ŸÖŸÑÿÆÿµ ÿßŸÑÿØŸäŸÜ</div>
        <div class="summary-grid">
            <div class="summary-item">
                <div class="summary-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿØŸäŸÜ</div>
                <div class="summary-value">${toEnglishDigits(totalAmount.toLocaleString('en'))} ÿØ.ÿπ</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿØÿØ</div>
                <div class="summary-value">${toEnglishDigits(totalPaidAmount.toLocaleString('en'))} ÿØ.ÿπ</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</div>
                <div class="summary-value">${toEnglishDigits(remainingAmount.toLocaleString('en'))} ÿØ.ÿπ</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ≥ÿØÿØÿ©</div>
                <div class="summary-value">${toEnglishDigits(paidMonthsCount)} ŸÖŸÜ ${toEnglishDigits(totalMonths)}</div>
            </div>
        </div>
    </div>
    <div class="notes-section">
        <div class="section-title">üìå ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ŸáÿßŸÖÿ©</div>
        <div class="note-text">
            ‚Ä¢ ÿßÿ≠ÿ™ŸÅÿ∏ ÿ®Ÿáÿ∞ÿß ÿßŸÑÿ•ŸäÿµÿßŸÑ ŸÉÿ•ÿ´ÿ®ÿßÿ™ ŸÑŸÑÿØŸÅÿπ<br>
            ‚Ä¢ ŸÑŸÑÿßÿ≥ÿ™ŸÅÿ≥ÿßÿ± ÿßÿ™ÿµŸÑ ÿπŸÑŸâ: ${storePhone}<br>
            ‚Ä¢ ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ´ŸÇÿ™ŸÉŸÖ ÿ®ŸÜÿß
        </div>
    </div>
    <div class="receipt-footer">
        <div style="font-weight:700;margin-bottom:5px;">ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ´ŸÇÿ™ŸÉŸÖ üôè</div>
        <div>ŸÜÿ∏ÿßŸÖ ŸÉÿßÿ¥ ÿ®ÿ±Ÿà - Digital Creativity ¬© ${new Date().getFullYear()}</div>
    </div>
</div>
</body>
</html>`;
    
    return html;
}
</script>
<!doctype html>
<html lang="ar" dir="rtl">
<!-- ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿµÿßŸÖÿ™ÿ© - Digital Creativity -->
<script>
// ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿ≤ÿ± "ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±" ŸÅŸä ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä
function showPage(page) {
    console.log('üìÑ ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿ©:', page);
    
    // ÿ•ÿÆŸÅÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
    document.querySelectorAll('.section').forEach(section => {
        section.style.display = 'none';
    });

    // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÉŸÑÿßÿ≥ ÿßŸÑŸÜÿ¥ÿ∑ ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿπŸÜÿßÿµÿ± ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });

    // ÿπÿ±ÿ∂ ŸÇÿ≥ŸÖ ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ÿ•ÿ∞ÿß ŸÉÿßŸÜ page ŸáŸà 'reports'
    if (page === 'reports') {
        const reportsSection = document.getElementById('reportsSection');
        if (reportsSection) {
            reportsSection.style.display = 'block';
            // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÉŸÑÿßÿ≥ ÿßŸÑŸÜÿ¥ÿ∑ ŸÑÿ≤ÿ± ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±
            const reportsNavBtn = document.querySelector('.nav-item .nav-link .fa-chart-bar')?.parentElement?.parentElement;
            if (reportsNavBtn) {
                reportsNavBtn.classList.add('active');
            }
        }
    } else {
        // ŸÖŸÜÿ∑ŸÇ ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿßÿ™ ÿßŸÑÿ£ÿÆÿ±Ÿâ
        const pageSection = document.getElementById(page + 'Section');
        if (pageSection) {
            pageSection.style.display = 'block';
        }
    }
    
    // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿπŸÜÿßÿµÿ± ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ©
    if (window.securityManager) {
        setTimeout(() => {
            window.securityManager.applyPermissionsToElements();
        }, 100);
    }
}

// ÿØÿßŸÑÿ© ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ
function openSystemManagement() {
    console.log('üîß ŸÅÿ™ÿ≠ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ...');
    showModal('systemManagementModal');
    updateSystemStatus();
}

// ÿØÿßŸÑÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ
async function updateSystemStatus() {
    try {
        const uid = localStorage.getItem('app_uid');
        const version = localStorage.getItem('app_version') || '1.0.0';
        
        document.getElementById('systemStatusUID').textContent = uid || 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±';
        document.getElementById('systemStatusVersion').textContent = version;
        
        if (window.authFix) {
            const accountCheck = await window.authFix.checkCurrentAccount();
            const statusElem = document.getElementById('systemStatusAccount');
            if (accountCheck.hasAccount && accountCheck.isValid) {
                statusElem.textContent = '‚úÖ ÿµÿßŸÑÿ≠';
                statusElem.style.color = '#10b981';
            } else if (accountCheck.hasAccount && !accountCheck.isValid) {
                statusElem.textContent = '‚ö†Ô∏è ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠';
                statusElem.style.color = '#f59e0b';
            } else {
                statusElem.textContent = 'ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≠ÿ≥ÿßÿ®';
                statusElem.style.color = '#6b7280';
            }
        }
        
        const firebaseElem = document.getElementById('systemStatusFirebase');
        if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
            firebaseElem.textContent = '‚úÖ ŸÖÿ™ÿµŸÑ';
            firebaseElem.style.color = '#10b981';
        } else {
            firebaseElem.textContent = '‚ö†Ô∏è ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ';
            firebaseElem.style.color = '#ef4444';
        }
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ:', error);
    }
}

// ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ
async function systemCheckAccount() {
    const logDiv = document.getElementById('systemConsoleLog');
    logDiv.innerHTML += '<div style="color:#3b82f6">‚è≥ ÿ¨ÿßÿ±Ÿä ŸÅÿ≠ÿµ ÿßŸÑÿ≠ÿ≥ÿßÿ®...</div>';
    
    try {
        const result = await window.authFix.checkCurrentAccount();
        if (result.hasAccount && result.isValid) {
            logDiv.innerHTML += '<div style="color:#10b981">‚úÖ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿµÿßŸÑÿ≠ ŸàŸäÿπŸÖŸÑ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠</div>';
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        } else if (result.hasAccount && !result.isValid) {
            logDiv.innerHTML += `<div style="color:#f59e0b">‚ö†Ô∏è ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠: ${result.reason}</div>`;
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        } else {
            logDiv.innerHTML += '<div style="color:#6b7280">‚ÑπÔ∏è ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≠ÿ≥ÿßÿ® ŸÖÿ≠ŸÅŸàÿ∏</div>';
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }
        updateSystemStatus();
    } catch (error) {
        logDiv.innerHTML += `<div style="color:#ef4444">‚ùå ÿÆÿ∑ÿ£: ${error.message}</div>`;
        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
    }
    logDiv.scrollTop = logDiv.scrollHeight;
}

async function systemFixRegistration() {
    const logDiv = document.getElementById('systemConsoleLog');
    logDiv.innerHTML += '<div style="color:#3b82f6">‚è≥ ÿ¨ÿßÿ±Ÿä ÿ•ÿµŸÑÿßÿ≠ ŸÖÿ¥ŸÉŸÑÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ...</div>';
    
    try {
        const result = await window.authFix.attemptRegistrationFix();
        if (result.success) {
            logDiv.innerHTML += `<div style="color:#10b981">‚úÖ ${result.message}</div>`;
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        } else {
            logDiv.innerHTML += `<div style="color:#ef4444">‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ•ÿµŸÑÿßÿ≠: ${result.error}</div>`;
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }
        updateSystemStatus();
    } catch (error) {
        logDiv.innerHTML += `<div style="color:#ef4444">‚ùå ÿÆÿ∑ÿ£: ${error.message}</div>`;
        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
    }
    logDiv.scrollTop = logDiv.scrollHeight;
}

async function systemSoftReset() {
    if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ ÿßŸÑÿÆŸÅŸäŸÅÿ©ÿü\n\nÿ≥Ÿäÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÖÿπ ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™.')) {
        return;
    }
    
    const logDiv = document.getElementById('systemConsoleLog');
    logDiv.innerHTML += '<div style="color:#f59e0b">‚è≥ ÿ¨ÿßÿ±Ÿä ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ ÿßŸÑÿÆŸÅŸäŸÅÿ©...</div>';
    
    try {
        const result = await window.systemReset.softReset();
        if (result.success) {
            logDiv.innerHTML += '<div style="color:#10b981">‚úÖ ÿ™ŸÖÿ™ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ ÿ®ŸÜÿ¨ÿßÿ≠</div>';
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            setTimeout(() => window.location.reload(), 2000);
        } else {
            logDiv.innerHTML += `<div style="color:#ef4444">‚ùå ŸÅÿ¥ŸÑÿ™ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ: ${result.error}</div>`;
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }
    } catch (error) {
        logDiv.innerHTML += `<div style="color:#ef4444">‚ùå ÿÆÿ∑ÿ£: ${error.message}</div>`;
        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
    }
    logDiv.scrollTop = logDiv.scrollHeight;
}

async function systemFullReset() {
    if (!confirm('‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÉÿßŸÖŸÑÿ©\n\nÿ≥Ÿäÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸÜŸáÿßÿ¶ŸäÿßŸã!\n\nŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü')) {
        return;
    }
    
    if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ 100%ÿü\n\nŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°!')) {
        return;
    }
    
    const logDiv = document.getElementById('systemConsoleLog');
    logDiv.innerHTML += '<div style="color:#ef4444">‚è≥ ÿ¨ÿßÿ±Ÿä ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÉÿßŸÖŸÑÿ©...</div>';
    
    try {
        const result = await window.systemReset.fullReset(true);
        if (result.success) {
            logDiv.innerHTML += '<div style="color:#10b981">‚úÖ ÿ™ŸÖÿ™ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÉÿßŸÖŸÑÿ©</div>';
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }
    } catch (error) {
        logDiv.innerHTML += `<div style="color:#ef4444">‚ùå ÿÆÿ∑ÿ£: ${error.message}</div>`;
        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
    }
    logDiv.scrollTop = logDiv.scrollHeight;
}

async function systemClearInvalidData() {
    const logDiv = document.getElementById('systemConsoleLog');
    logDiv.innerHTML += '<div style="color:#3b82f6">‚è≥ ÿ¨ÿßÿ±Ÿä ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿßŸÑÿµÿßŸÑÿ≠ÿ©...</div>';
    
    try {
        const cleared = await window.authFix.clearInvalidAccount();
        if (cleared) {
            logDiv.innerHTML += '<div style="color:#10b981">‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿßŸÑÿµÿßŸÑÿ≠ÿ©</div>';
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        } else {
            logDiv.innerHTML += '<div style="color:#6b7280">‚ÑπÔ∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©</div>';
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }
        updateSystemStatus();
    } catch (error) {
        logDiv.innerHTML += `<div style="color:#ef4444">‚ùå ÿÆÿ∑ÿ£: ${error.message}</div>`;
        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
    }
    logDiv.scrollTop = logDiv.scrollHeight;
}

async function systemExportBackup(type = 'full') {
    const logDiv = document.getElementById('systemConsoleLog');
    logDiv.innerHTML += '<div style="color:#3b82f6">‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©...</div>';
    try {
        await window.systemReset.exportBackup(type);
        logDiv.innerHTML += '<div style="color:#10b981">‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠</div>';
        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
    } catch (error) {
        logDiv.innerHTML += `<div style="color:#ef4444">‚ùå ÿÆÿ∑ÿ£: ${error.message}</div>`;
        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
    }
    logDiv.scrollTop = logDiv.scrollHeight;
}

// ============================================================================
// üî• ÿØŸàÿßŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿ•ŸÑŸâ Firebase
// ============================================================================

/**
 * ÿ¨ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ localStorage Ÿà IndexedDB
 */
/**
 * ÿπÿ±ÿ∂ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
 */
function showNotification(message, type = 'info') {
    console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
    
    // ÿ•ŸÜÿ¥ÿßÿ° ÿπŸÜÿµÿ± ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
    const notification = document.createElement('div');
    notification.textContent = message;
    
    // ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 9999999;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideInRight 0.3s ease;
        font-size: 14px;
        line-height: 1.5;
    `;
    
    // ÿ£ŸÑŸàÿßŸÜ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜŸàÿπ
    const colors = {
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
    };
    
    notification.style.background = colors[type] || colors.info;
    
    // ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿµŸÅÿ≠ÿ©
    document.body.appendChild(notification);
    
    // ÿ•ÿ≤ÿßŸÑÿ© ÿ®ÿπÿØ 4 ÿ´ŸàÿßŸÜ
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 4000);
}

// ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ±ÿ≥ŸàŸÖ ÿßŸÑŸÖÿ™ÿ≠ÿ±ŸÉÿ©
if (!document.getElementById('notificationStyles')) {
    const style = document.createElement('style');
    style.id = 'notificationStyles';
    style.textContent = `
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
}

/**
 * ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠ ŸàÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑÿ™ŸÉŸàŸÜ ÿµÿßŸÑÿ≠ÿ© ŸÑŸÄ Firebase
 * Firebase ŸÑÿß ŸäŸÇÿ®ŸÑ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠ ÿßŸÑÿ™Ÿä ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ: . # $ / [ ]
 */
function sanitizeForFirebase(obj) {
    if (obj === null || obj === undefined) {
        return obj;
    }
    
    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÜÿµÿßŸã
    if (typeof obj === 'string') {
        return obj;
    }
    
    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿ±ŸÇŸÖÿßŸã ÿ£Ÿà boolean
    if (typeof obj !== 'object') {
        return obj;
    }
    
    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿµŸÅŸàŸÅÿ©
    if (Array.isArray(obj)) {
        return obj.map(item => sanitizeForFirebase(item));
    }
    
    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ object
    const sanitized = {};
    for (const key in obj) {
        if (obj.hasOwnProperty(key)) {
            // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ - ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿßŸÑÿ£ÿ≠ÿ±ŸÅ ÿ∫Ÿäÿ± ÿßŸÑÿµÿßŸÑÿ≠ÿ© ÿ®ŸÄ _
            let cleanKey = key.replace(/[.#$\/\[\]]/g, '_');
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ Ÿäÿ®ÿØÿ£ ÿ®ÿ±ŸÇŸÖÿå ÿ£ÿ∂ŸÅ ÿ®ÿßÿØÿ¶ÿ©
            if (/^\d/.test(cleanKey)) {
                cleanKey = 'key_' + cleanKey;
            }
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ŸÅÿßÿ±ÿ∫ÿßŸã ÿ®ÿπÿØ ÿßŸÑÿ™ŸÜÿ∏ŸäŸÅ
            if (!cleanKey || cleanKey.trim() === '') {
                cleanKey = 'empty_key';
            }
            
            // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÇŸäŸÖÿ© ÿ£Ÿäÿ∂ÿßŸã
            sanitized[cleanKey] = sanitizeForFirebase(obj[key]);
        }
    }
    
    return sanitized;
}

async function collectAllAppData() {
    const data = {
        timestamp: new Date().toISOString(),
        version: '2.0.7',
        localStorage: {},
        indexedDB: {}
    };

    // ÿ¨ŸÖÿπ ÿ®ŸäÿßŸÜÿßÿ™ localStorage
    const keysToBackup = [
        'products', 'sales', 'debts', 'installments', 'payments',
        'customers', 'suppliers', 'categories', 'expenses',
        'storeSettings', 'printerSettings', 'systemSettings',
        'userPreferences', 'lastBackup', 'appVersion'
    ];

    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key) {
            // ŸÜÿ≥ÿÆ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠ ÿ£Ÿà ŸÅŸÇÿ∑ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠ ÿßŸÑŸÖÿ≠ÿØÿØÿ©
            data.localStorage[key] = localStorage.getItem(key);
        }
    }

    // ÿ¨ŸÖÿπ ÿ®ŸäÿßŸÜÿßÿ™ IndexedDB ÿ•ŸÜ Ÿàÿ¨ÿØÿ™
    try {
        if (window.elementDb && typeof window.elementDb.getAll === 'function') {
            const allData = await window.elementDb.getAll();
            data.indexedDB = {
                all: allData,
                products: allData.filter(item => item.type === 'product'),
                invoices: allData.filter(item => item.type === 'invoice'),
                debts: allData.filter(item => item.type === 'debt'),
                payments: allData.filter(item => item.type === 'payment')
            };
        }
    } catch (e) {
        console.warn('‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿ¨ŸÖÿπ ÿ®ŸäÿßŸÜÿßÿ™ IndexedDB:', e);
    }

    return data;
}

/**
 * ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ•ŸÑŸâ Firebase
 */
async function uploadBackupToFirebase(isAutomatic = false) {
    console.log('üöÄ uploadBackupToFirebase - ÿßŸÑÿ®ÿØÿ°...', { isAutomatic });
    
    try {
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑ Firebase
        console.log('üîç ŸÅÿ≠ÿµ Firebase...', { 
            firebaseExists: typeof firebase !== 'undefined',
            appsLength: firebase?.apps?.length 
        });
        
        if (typeof firebase === 'undefined') {
            throw new Error('Firebase ÿ∫Ÿäÿ± ŸÖÿ≠ŸÖŸëŸÑ ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ©');
        }
        
        if (!firebase.apps || firebase.apps.length === 0) {
            throw new Error('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäŸëÿ£. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ŸáŸäÿ¶ÿ© Firebase ŸÅŸä firebase-config.js');
        }

        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ
        console.log('üîç ŸÅÿ≠ÿµ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ...');
        
        const userStatus = localStorage.getItem('userStatus');
        const currentUser = localStorage.getItem('currentUser');
        
        if (!userStatus || !currentUser) {
            // ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸèÿ≥ÿ¨ŸÑ - ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ≥ÿ±Ÿäÿπ
            console.log('‚ö†Ô∏è ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸèÿ≥ÿ¨ŸÑ - ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ');
            
            if (!isAutomatic) {
                openQuickRegistrationModal();
            }
            
            return false;
        }
        
        if (userStatus !== 'active') {
            const msg = '‚è≥ ÿ≠ÿ≥ÿßÿ®ŸÉ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÅÿπŸäŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÖŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿ© (ÿÆŸÑÿßŸÑ 24 ÿ≥ÿßÿπÿ©).';
            if (!isAutomatic) {
                if (typeof showNotification === 'function') {
                    showNotification(msg, 'warning');
                } else {
                    alert(msg);
                }
            }
            console.warn('‚ö†Ô∏è ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸèŸÅÿπŸëŸÑ - ÿ™ŸÖ ÿ™ÿÆÿ∑Ÿä ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä');
            return false;
        }
        
        const userData = JSON.parse(currentUser);
        console.log('‚úÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸèÿ≥ÿ¨ŸÑ ŸàŸÖŸèŸÅÿπŸëŸÑ:', userData.fullName, '- UID:', userData.uid);

        if (!isAutomatic) {
            if (typeof showNotification === 'function') {
                showNotification('‚è≥ ÿ¨ÿßÿ±Ÿä ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©...', 'info');
            }
        }

        // ÿ¨ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        const backupData = await collectAllAppData();
        
        // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑÿ™ŸÉŸàŸÜ ÿµÿßŸÑÿ≠ÿ© ŸÑŸÄ Firebase
        const sanitizedData = sanitizeForFirebase(backupData);
        
        // ÿ≠ÿ≥ÿßÿ® ÿ≠ÿ¨ŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        const dataSize = new Blob([JSON.stringify(sanitizedData)]).size;
        const dataSizeKB = (dataSize / 1024).toFixed(2);
        const dataSizeMB = (dataSize / (1024 * 1024)).toFixed(2);
        const sizeText = dataSize > 1024 * 1024 ? `${dataSizeMB} MB` : `${dataSizeKB} KB`;

        // ÿ±ŸÅÿπ ÿ•ŸÑŸâ Firebase Database
        const database = firebase.database();
        const timestamp = Date.now();
        const backupRef = database.ref(`users/${userData.uid}/backups/${timestamp}`);
        
        await backupRef.set({
            data: sanitizedData,
            metadata: {
                timestamp: new Date().toISOString(),
                size: dataSize,
                sizeText: sizeText,
                version: '2.1.0',
                automatic: isAutomatic,
                deviceInfo: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language
                }
            }
        });

        // ÿ≠ŸÅÿ∏ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
        await database.ref(`users/${userData.uid}/lastBackup`).set({
            timestamp: new Date().toISOString(),
            timestampMs: timestamp,
            size: sizeText,
            automatic: isAutomatic
        });

        // ÿ™ÿ≠ÿØŸäÿ´ localStorage
        localStorage.setItem('lastFirebaseBackup', JSON.stringify({
            date: new Date().toISOString(),
            size: sizeText,
            timestamp: timestamp
        }));

        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
        updateFirebaseBackupUI();

        if (!isAutomatic) {
            showNotification(`‚úÖ ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠ (${sizeText})`, 'success');
        }
        
        console.log(`‚úÖ ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ•ŸÑŸâ Firebase ÿ®ŸÜÿ¨ÿßÿ≠ - ÿßŸÑÿ≠ÿ¨ŸÖ: ${sizeText}`);
        
        return true;
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©:', error);
        if (!isAutomatic) {
            showNotification(`‚ùå ŸÅÿ¥ŸÑ ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©: ${error.message}`, 'error');
        }
        return false;
    }
}

/**
 * ÿ™ÿ≠ŸÖŸäŸÑ ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÖŸÜ Firebase
 */
async function downloadBackupFromFirebase() {
    console.log('üì• downloadBackupFromFirebase - ÿßŸÑÿ®ÿØÿ°...');
    
    try {
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑ Firebase
        if (typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0) {
            throw new Error('Firebase ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ');
        }

        const user = firebase.auth?.()?.currentUser;
        if (!user) {
            showNotification('Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã', 'error');
            return;
        }

        showNotification('‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©...', 'info');

        const database = firebase.database();
        
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
        const backupsRef = database.ref(`users/${user.uid}/backups`);
        const snapshot = await backupsRef.orderByKey().limitToLast(1).once('value');
        
        if (!snapshot.exists()) {
            showNotification('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ©', 'warning');
            return;
        }

        const backupData = snapshot.val();
        const backupKey = Object.keys(backupData)[0];
        const backup = backupData[backupKey];

        // ÿ™ŸÜÿ≤ŸäŸÑ ŸÉŸÖŸÑŸÅ JSON
        const dataStr = JSON.stringify(backup.data, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `firebase-backup-${backupKey}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showNotification('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©:', error);
        showNotification(`‚ùå ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©: ${error.message}`, 'error');
    }
}

/**
 * ÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
 */
async function viewFirebaseBackupHistory() {
    console.log('üìú viewFirebaseBackupHistory - ÿßŸÑÿ®ÿØÿ°...');
    
    try {
        const user = firebase.auth?.()?.currentUser;
        if (!user) {
            showNotification('Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã', 'error');
            return;
        }

        const database = firebase.database();
        const backupsRef = database.ref(`users/${user.uid}/backups`);
        const snapshot = await backupsRef.orderByKey().limitToLast(10).once('value');
        
        if (!snapshot.exists()) {
            showNotification('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ©', 'info');
            return;
        }

        const backups = [];
        snapshot.forEach(child => {
            const backup = child.val();
            backups.push({
                key: child.key,
                timestamp: backup.metadata?.timestamp,
                size: backup.metadata?.sizeText,
                automatic: backup.metadata?.automatic
            });
        });

        // ÿπÿ±ÿ∂ ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ŸÖŸÜÿ®ÿ´ŸÇÿ©
        let html = `
            <div style="padding: 2rem;">
                <h2 style="margin-bottom: 1.5rem; color: var(--theme-text-primary);">
                    <i class="fas fa-history"></i> ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
                </h2>
                <div style="max-height: 400px; overflow-y: auto;">
        `;

        backups.reverse().forEach((backup, index) => {
            const date = new Date(backup.timestamp);
            const dateStr = date.toLocaleDateString('ar-EG', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            const autoIcon = backup.automatic ? 'ü§ñ ÿ™ŸÑŸÇÿßÿ¶Ÿä' : 'üë§ ŸäÿØŸàŸä';
            
            html += `
                <div style="background: var(--theme-bg-secondary); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong style="color: var(--theme-text-primary);">ŸÜÿ≥ÿÆÿ© #${backups.length - index}</strong>
                        <span style="color: var(--theme-text-secondary); font-size: 0.9rem;">${autoIcon}</span>
                    </div>
                    <div style="color: var(--theme-text-secondary); font-size: 0.95rem;">
                        üìÖ ${dateStr}
                    </div>
                    <div style="color: var(--theme-text-secondary); font-size: 0.95rem;">
                        üíæ ÿßŸÑÿ≠ÿ¨ŸÖ: ${backup.size}
                    </div>
                </div>
            `;
        });

        html += `
                </div>
                <button class="btn btn-secondary" onclick="closeModal()" style="margin-top: 1.5rem; width: 100%;">
                    ÿ•ÿ∫ŸÑÿßŸÇ
                </button>
            </div>
        `;

        showModal('ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©', html);
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿπÿ±ÿ∂ ÿßŸÑÿ≥ÿ¨ŸÑ:', error);
        showNotification(`‚ùå ŸÅÿ¥ŸÑ ÿπÿ±ÿ∂ ÿßŸÑÿ≥ÿ¨ŸÑ: ${error.message}`, 'error');
    }
}

/**
 * ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä
 */
function updateFirebaseBackupUI() {
    try {
        const lastBackup = localStorage.getItem('lastFirebaseBackup');
        if (lastBackup) {
            const data = JSON.parse(lastBackup);
            const date = new Date(data.date);
            const dateStr = date.toLocaleDateString('ar-EG', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const dateElem = document.getElementById('lastFirebaseBackupDate');
            const sizeElem = document.getElementById('firebaseBackupSize');
            
            if (dateElem) dateElem.textContent = dateStr;
            if (sizeElem) sizeElem.textContent = data.size;
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
        const statusElem = document.getElementById('firebaseConnectionStatus');
        if (statusElem) {
            if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                statusElem.textContent = '‚úÖ ŸÖÿ™ÿµŸÑ';
                statusElem.style.color = '#10b981';
            } else {
                statusElem.textContent = '‚ö†Ô∏è ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ';
                statusElem.style.color = '#ef4444';
            }
        }
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä:', error);
    }
}

/**
 * ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
 */
async function autoBackupOnAppStart() {
    try {
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
        const autoBackupEnabled = localStorage.getItem('autoFirebaseBackupEnabled');
        if (autoBackupEnabled === 'false') {
            console.log('‚ÑπÔ∏è ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÖÿπÿ∑ŸÑ');
            return;
        }

        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
        const lastBackup = localStorage.getItem('lastFirebaseBackup');
        const now = Date.now();
        
        if (lastBackup) {
            try {
                const data = JSON.parse(lastBackup);
                const lastBackupTime = data.timestamp || 0;
                const hoursSinceLastBackup = (now - lastBackupTime) / (1000 * 60 * 60);
                
                // ÿ•ÿ∞ÿß ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ŸÅŸä ÿ¢ÿÆÿ± 6 ÿ≥ÿßÿπÿßÿ™ÿå ÿ™ÿÆÿ∑Ÿä
                if (hoursSinceLastBackup < 6) {
                    console.log(`‚ÑπÔ∏è ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÉÿßŸÜÿ™ ŸÖŸÜÿ∞ ${hoursSinceLastBackup.toFixed(1)} ÿ≥ÿßÿπÿ© - ÿ™ŸÖ ÿßŸÑÿ™ÿÆÿ∑Ÿä`);
                    return;
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©:', e);
            }
        }

        // ÿ®ÿØÿ° ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÖÿ®ÿßÿ¥ÿ±ÿ©
        console.log('ü§ñ ÿ®ÿØÿ° ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä...');
        const success = await uploadBackupToFirebase(true);
        if (success) {
            console.log('‚úÖ ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿ®ŸÜÿ¨ÿßÿ≠');
        }
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä:', error);
    }
}

// ============================================================================
// ÿ™ÿµÿØŸäÿ± ÿßŸÑÿØŸàÿßŸÑ ÿ•ŸÑŸâ window object ŸÑÿ∂ŸÖÿßŸÜ ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸäŸáÿß
// ============================================================================
window.uploadBackupToFirebase = uploadBackupToFirebase;
window.downloadBackupFromFirebase = downloadBackupFromFirebase;
window.viewFirebaseBackupHistory = viewFirebaseBackupHistory;
window.updateFirebaseBackupUI = updateFirebaseBackupUI;
window.autoBackupOnAppStart = autoBackupOnAppStart;
window.collectAllAppData = collectAllAppData;

// ============================================================================
// ŸÜŸáÿßŸäÿ© ÿØŸàÿßŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿ•ŸÑŸâ Firebase
// ============================================================================


// ============================================================================
// üîê ŸÜÿ∏ÿßŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸàÿßŸÑÿ™ŸÅÿπŸäŸÑ
// ============================================================================

/**
 * ÿ™ŸàŸÑŸäÿØ ÿ±ŸÖÿ≤ ÿπÿ¥Ÿàÿßÿ¶Ÿä ŸÅÿ±ŸäÿØ (6 ÿ£ÿ±ŸÇÿßŸÖ)
 */
function generateActivationCode() {
    return Math.floor(100000 + Math.random() * 900000).toString();
}

/**
 * ÿ™ŸàŸÑŸäÿØ ŸÖÿπÿ±ŸÅ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅÿ±ŸäÿØ (UID)
 */
function generateUserUID() {
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 10000);
    return `USER_${timestamp}_${random}`;
}

/**
 * ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© Ÿàÿßÿ™ÿ≥ÿßÿ® ÿ•ŸÑŸâ ÿßŸÑÿ¥ÿ±ŸÉÿ©
 */
function sendWhatsAppToCompany(fullName, phone, activationCode, userUID) {
    try {
        // ÿ±ŸÇŸÖ ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ® ÿßŸÑÿÆÿßÿµ ÿ®ÿßŸÑÿ¥ÿ±ŸÉÿ© (ÿßŸÑÿ•ÿ®ÿØÿßÿπ ÿßŸÑÿ±ŸÇŸÖŸä)
        const companyWhatsApp = '9647813798636'; // ÿ±ŸÇŸÖ ÿßŸÑÿ¥ÿ±ŸÉÿ© ŸÖÿπ ŸÉŸàÿØ ÿßŸÑÿØŸàŸÑÿ©
        
        // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
        const message = `
üÜï *ÿ∑ŸÑÿ® ÿ™ŸÅÿπŸäŸÑ ÿ¨ÿØŸäÿØ - ŸÜÿ∏ÿßŸÖ ŸäÿπŸÇŸàÿ®*

üë§ *ÿßŸÑÿßÿ≥ŸÖ:* ${fullName}
üì± *ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ:* ${phone}
üî¢ *ÿ±ŸÖÿ≤ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ:* ${activationCode}
üÜî *ÿßŸÑŸÖÿπÿ±ŸÅ ÿßŸÑŸÅÿ±ŸäÿØ:* ${userUID}

üìÖ *ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:* ${new Date().toLocaleString('ar-EG')}

‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÅÿπŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.
`.trim();
        
        // ÿ•ŸÜÿ¥ÿßÿ° ÿ±ÿßÿ®ÿ∑ Ÿàÿßÿ™ÿ≥ÿßÿ®
        const whatsappURL = `https://wa.me/${companyWhatsApp}?text=${encodeURIComponent(message)}`;
        
        // ŸÅÿ™ÿ≠ Ÿàÿßÿ™ÿ≥ÿßÿ® ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ÿ¨ÿØŸäÿØÿ©
        window.open(whatsappURL, '_blank');
        
        console.log('‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ±ÿßÿ®ÿ∑ Ÿàÿßÿ™ÿ≥ÿßÿ® ÿ®ŸÜÿ¨ÿßÿ≠');
        return true;
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© Ÿàÿßÿ™ÿ≥ÿßÿ®:', error);
        return false;
    }
}

/**
 * ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä Firebase
 */
async function saveUserToFirebase(userData) {
    console.log('üíæ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä Firebase...', userData);
    
    try {
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑ Firebase
        if (typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0) {
            throw new Error('Firebase ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ');
        }

        const database = firebase.database();
        const userRef = database.ref(`users/${userData.uid}`);
        
        // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        await userRef.set({
            fullName: userData.fullName,
            phone: userData.phone,
            activationCode: userData.activationCode,
            uid: userData.uid,
            status: 'pending', // ÿ≠ÿßŸÑÿ©: pending, active, blocked
            registeredAt: userData.registeredAt,
            activatedAt: null,
            lastLogin: null,
            metadata: {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language
            }
        });

        console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä Firebase ÿ®ŸÜÿ¨ÿßÿ≠');
        return true;
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', error);
        return false;
    }
}

/**
 * ŸÖÿπÿßŸÑÿ¨ÿ© ÿ•ÿ±ÿ≥ÿßŸÑ ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
 */
async function handleRegisterSubmit(event) {
    event.preventDefault();
    console.log('üìù ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∑ŸÑÿ® ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ...');
    
    try {
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        const fullName = document.getElementById('registerFullName').value.trim();
        const phone = document.getElementById('registerPhone').value.trim();
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        if (!fullName || !phone) {
            alert('‚ùå Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ');
            return;
        }
        
        if (phone.length !== 11) {
            alert('‚ùå ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ 11 ÿ±ŸÇŸÖ');
            return;
        }
        
        // ÿ™ÿπÿ∑ŸäŸÑ ÿ≤ÿ± ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ
        const registerBtn = document.getElementById('registerBtn');
        const originalBtnText = registerBtn.innerHTML;
        registerBtn.disabled = true;
        registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ...';
        
        // ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        const activationCode = generateActivationCode();
        const userUID = generateUserUID();
        const registeredAt = new Date().toISOString();
        
        const userData = {
            fullName,
            phone,
            activationCode,
            uid: userUID,
            registeredAt,
            status: 'pending'
        };
        
        console.log('üìä ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', userData);
        
        // ÿ≠ŸÅÿ∏ ŸÅŸä Firebase
        const savedToFirebase = await saveUserToFirebase(userData);
        
        if (!savedToFirebase) {
            throw new Error('ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä Firebase');
        }
        
        // ÿ≠ŸÅÿ∏ ŸÅŸä localStorage
        localStorage.setItem('currentUser', JSON.stringify(userData));
        localStorage.setItem('userStatus', 'pending');
        
        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© Ÿàÿßÿ™ÿ≥ÿßÿ®
        sendWhatsAppToCompany(fullName, phone, activationCode, userUID);
        
        // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ Ÿàÿ•ÿ∏Ÿáÿßÿ± ÿ≠ÿßŸÑÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('waitingActivation').style.display = 'block';
        document.getElementById('userActivationCode').textContent = activationCode;
        
        console.log('‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!');
        
        // ÿ®ÿØÿ° ŸÅÿ≠ÿµ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÉŸÑ 30 ÿ´ÿßŸÜŸäÿ©
        startActivationPolling(userUID);
        
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ:', error);
        alert(`‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ${error.message}`);
        
        // ÿ•ÿπÿßÿØÿ© ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≤ÿ±
        const registerBtn = document.getElementById('registerBtn');
        registerBtn.disabled = false;
        registerBtn.innerHTML = originalBtnText;
    }
}

/**
 * ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ
 */
async function checkActivationStatus() {
    console.log('üîç ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ...');
    
    try {
        const userData = JSON.parse(localStorage.getItem('currentUser'));
        if (!userData || !userData.uid) {
            throw new Error('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≥ÿ™ÿÆÿØŸÖ');
        }
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑ Firebase
        if (typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0) {
            throw new Error('Firebase ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ');
        }
        
        const database = firebase.database();
        const userRef = database.ref(`users/${userData.uid}`);
        
        const snapshot = await userRef.once('value');
        
        if (!snapshot.exists()) {
            throw new Error('ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
        }
        
        const userDataFromFirebase = snapshot.val();
        console.log('üìä ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ Firebase:', userDataFromFirebase);
        
        if (userDataFromFirebase.status === 'active') {
            // ÿ™ŸÖ ÿßŸÑÿ™ŸÅÿπŸäŸÑ!
            console.log('‚úÖ ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®!');
            
            // ÿ™ÿ≠ÿØŸäÿ´ localStorage
            localStorage.setItem('userStatus', 'active');
            localStorage.setItem('currentUser', JSON.stringify(userDataFromFirebase));
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸàŸÇÿ™ ÿ¢ÿÆÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ
            await userRef.update({
                lastLogin: new Date().toISOString()
            });
            
            // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
            updateRegistrationUI();
            
            // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä
            updateCloudSubscriptionUI();
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ±ÿ≠Ÿäÿ®
            showNotification(`üéâ ŸÖÿ±ÿ≠ÿ®ÿßŸã ${userDataFromFirebase.fullName}! ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿ≠ÿ≥ÿßÿ®ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠`, 'success');
            
            return true;
        } else if (userDataFromFirebase.status === 'blocked') {
            alert('‚ö†Ô∏è ÿ≠ÿ≥ÿßÿ®ŸÉ ŸÖÿ≠ÿ∏Ÿàÿ±. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿ¥ÿ±ŸÉÿ©.');
            return false;
        } else {
            alert('‚è≥ ÿ≠ÿ≥ÿßÿ®ŸÉ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÅÿπŸäŸÑ. ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿÆŸÑÿßŸÑ 24 ÿ≥ÿßÿπÿ©.');
            return false;
        }
        
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ:', error);
        const errorMessage = error?.message || error?.toString() || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
        alert(`‚ùå ÿÆÿ∑ÿ£: ${errorMessage}`);
        return false;
    }
}

/**
 * ÿ®ÿØÿ° ŸÅÿ≠ÿµ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
 */
let activationPollingInterval = null;

function startActivationPolling(userUID) {
    console.log('üîÑ ÿ®ÿØÿ° ŸÅÿ≠ÿµ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä...');
    
    // ÿ•ŸäŸÇÿßŸÅ ÿ£Ÿä ŸÅÿ≠ÿµ ÿ≥ÿßÿ®ŸÇ
    if (activationPollingInterval) {
        clearInterval(activationPollingInterval);
    }
    
    // ŸÅÿ≠ÿµ ŸÉŸÑ 30 ÿ´ÿßŸÜŸäÿ©
    activationPollingInterval = setInterval(async () => {
        const isActive = await checkActivationStatus();
        if (isActive) {
            clearInterval(activationPollingInterval);
        }
    }, 30000); // 30 ÿ´ÿßŸÜŸäÿ©
}

/**
 * ŸÖÿπÿßŸÑÿ¨ÿ© ÿ•ÿ±ÿ≥ÿßŸÑ ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ (ŸÖŸÜ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™)
 */
async function handleSettingsRegisterSubmit(event) {
    event.preventDefault();
    console.log('üìù ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∑ŸÑÿ® ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ŸÖŸÜ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™...');
    
    try {
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        const fullName = document.getElementById('settingsRegisterFullName').value.trim();
        const phone = document.getElementById('settingsRegisterPhone').value.trim();
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        if (!fullName || !phone) {
            showNotification('‚ùå Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ', 'error');
            return;
        }
        
        if (phone.length !== 11) {
            showNotification('‚ùå ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ 11 ÿ±ŸÇŸÖ', 'error');
            return;
        }
        
        // ÿ™ÿπÿ∑ŸäŸÑ ÿ≤ÿ± ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ
        const registerBtn = document.getElementById('settingsRegisterBtn');
        const originalBtnText = registerBtn.innerHTML;
        registerBtn.disabled = true;
        registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ...';
        
        // ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        const activationCode = generateActivationCode();
        const userUID = generateUserUID();
        const registeredAt = new Date().toISOString();
        
        const userData = {
            fullName,
            phone,
            activationCode,
            uid: userUID,
            registeredAt,
            status: 'pending'
        };
        
        console.log('üìä ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', userData);
        
        // ÿ≠ŸÅÿ∏ ŸÅŸä Firebase
        const savedToFirebase = await saveUserToFirebase(userData);
        
        if (!savedToFirebase) {
            throw new Error('ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä Firebase');
        }
        
        // ÿ≠ŸÅÿ∏ ŸÅŸä localStorage
        localStorage.setItem('currentUser', JSON.stringify(userData));
        localStorage.setItem('userStatus', 'pending');
        
        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© Ÿàÿßÿ™ÿ≥ÿßÿ®
        sendWhatsAppToCompany(fullName, phone, activationCode, userUID);
        
        // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ Ÿàÿ•ÿ∏Ÿáÿßÿ± ÿ≠ÿßŸÑÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±
        document.getElementById('registrationFormSection').style.display = 'none';
        document.getElementById('settingsWaitingActivation').style.display = 'block';
        
        // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿ¨ÿßÿ≠ (ÿ®ÿØŸàŸÜ ÿπÿ±ÿ∂ ÿ±ŸÖÿ≤ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ)
        showNotification('‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ®ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠! ÿ≥ÿ™ÿ™ŸÑŸÇŸâ ÿ±ŸÖÿ≤ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿÆŸÑÿßŸÑ 24 ÿ≥ÿßÿπÿ©', 'success');
        console.log('‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!');
        
        // ÿ®ÿØÿ° ŸÅÿ≠ÿµ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÉŸÑ 30 ÿ´ÿßŸÜŸäÿ©
        startActivationPolling(userUID);
        
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ:', error);
        showNotification(`‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ${error.message}`, 'error');
        
        // ÿ•ÿπÿßÿØÿ© ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≤ÿ±
        const registerBtn = document.getElementById('settingsRegisterBtn');
        if (registerBtn) {
            registerBtn.disabled = false;
            registerBtn.innerHTML = originalBtnText;
        }
    }
}

/**
 * ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ŸÅŸä ÿµŸÅÿ≠ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
 */
function updateRegistrationUI() {
    try {
        const currentUser = localStorage.getItem('currentUser');
        const userStatus = localStorage.getItem('userStatus');
        
        const registrationStatusDisplay = document.getElementById('registrationStatusDisplay');
        const registrationFormSection = document.getElementById('registrationFormSection');
        const settingsWaitingActivation = document.getElementById('settingsWaitingActivation');
        const settingsRegisteredUserInfo = document.getElementById('settingsRegisteredUserInfo');
        
        if (!currentUser || !userStatus) {
            // ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ - ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© + ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
            if (registrationStatusDisplay) {
                registrationStatusDisplay.innerHTML = `
                    <div style="background: rgba(251, 191, 36, 0.1); border-right: 4px solid #fbbf24; padding: 1.5rem; border-radius: 12px;">
                        <h4 style="color: #fbbf24; margin-bottom: 0.5rem;">
                            <i class="fas fa-exclamation-circle"></i> ÿ∫Ÿäÿ± ŸÖŸèÿ≥ÿ¨ŸÑ
                        </h4>
                        <p style="color: var(--theme-text-secondary); line-height: 1.6; margin: 0;">
                            ŸÑŸÑÿßÿ≥ÿ™ŸÅÿßÿØÿ© ŸÖŸÜ ŸÖŸäÿ≤ÿ© ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿå Ÿäÿ¨ÿ® ÿπŸÑŸäŸÉ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ£ŸàŸÑÿßŸã.
                        </p>
                    </div>
                `;
            }
            if (registrationFormSection) registrationFormSection.style.display = 'block';
            if (settingsWaitingActivation) settingsWaitingActivation.style.display = 'none';
            if (settingsRegisteredUserInfo) settingsRegisteredUserInfo.style.display = 'none';
            return;
        }
        
        const userData = JSON.parse(currentUser);
        
        if (userStatus === 'pending') {
            // ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÅÿπŸäŸÑ
            if (registrationStatusDisplay) registrationStatusDisplay.innerHTML = '';
            if (registrationFormSection) registrationFormSection.style.display = 'none';
            if (settingsWaitingActivation) settingsWaitingActivation.style.display = 'block';
            if (settingsRegisteredUserInfo) settingsRegisteredUserInfo.style.display = 'none';
            
        } else if (userStatus === 'active') {
            // ŸÖŸèŸÅÿπŸëŸÑ
            if (registrationStatusDisplay) registrationStatusDisplay.innerHTML = '';
            if (registrationFormSection) registrationFormSection.style.display = 'none';
            if (settingsWaitingActivation) settingsWaitingActivation.style.display = 'none';
            if (settingsRegisteredUserInfo) {
                settingsRegisteredUserInfo.style.display = 'block';
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™
                const nameElem = document.getElementById('settingsUserNameDisplay');
                const phoneElem = document.getElementById('settingsUserPhoneDisplay');
                
                if (nameElem) nameElem.textContent = userData.fullName || '---';
                if (phoneElem) phoneElem.textContent = userData.phone || '---';
            }
        }
        
        console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ');
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ:', error);
    }
}

// ÿ™ÿµÿØŸäÿ± ÿßŸÑÿØŸàÿßŸÑ ÿ•ŸÑŸâ window object
window.handleSettingsRegisterSubmit = handleSettingsRegisterSubmit;
window.updateRegistrationUI = updateRegistrationUI;

/**
 * ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
 */
async function checkUserStatus() {
    console.log('üîê ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)...');
    
    try {
        const userStatus = localStorage.getItem('userStatus');
        const currentUser = localStorage.getItem('currentUser');
        
        if (!userStatus || !currentUser) {
            // ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖ - ŸÑŸÉŸÜ Ÿáÿ∞ÿß ÿßÿÆÿ™Ÿäÿßÿ±Ÿäÿå ŸÑÿß ŸÜŸèÿ∏Ÿáÿ± ÿµŸÅÿ≠ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ
            console.log('‚ÑπÔ∏è ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)');
            return false;
        }
        
        const userData = JSON.parse(currentUser);
        
        if (userStatus === 'pending') {
            // ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÅÿπŸäŸÑ - ÿ®ÿØÿ° ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
            console.log('‚è≥ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÅÿπŸäŸÑ');
            
            // ŸÅÿ≠ÿµ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©
            await checkActivationStatus();
            
            // ÿ®ÿØÿ° ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
            startActivationPolling(userData.uid);
            
            return false;
        } else if (userStatus === 'active') {
            // ŸÖŸÅÿπŸëŸÑ
            console.log('‚úÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÅÿπŸëŸÑ:', userData.fullName);
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸàŸÇÿ™ ÿ¢ÿÆÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ
            if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                try {
                    const database = firebase.database();
                    await database.ref(`users/${userData.uid}`).update({
                        lastLogin: new Date().toISOString()
                    });
                } catch (e) {
                    console.warn('‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ŸàŸÇÿ™ ÿ¢ÿÆÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ:', e);
                }
            }
            
            return true;
        }
        
        return false;
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', error);
        return false;
    }
}

// ÿ™ÿµÿØŸäÿ± ÿßŸÑÿØŸàÿßŸÑ ÿ•ŸÑŸâ window object
window.handleRegisterSubmit = handleRegisterSubmit;
window.checkActivationStatus = checkActivationStatus;
window.checkUserStatus = checkUserStatus;
window.handleSettingsRegisterSubmit = handleSettingsRegisterSubmit;
window.updateRegistrationUI = updateRegistrationUI;

/**
 * ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ≥ÿ±Ÿäÿπ
 */
function openQuickRegistrationModal() {
    const modal = document.getElementById('quickRegistrationModal');
    if (modal) {
        modal.style.display = 'flex';
        
        // ÿ™ŸÅÿ±Ÿäÿ∫ ÿßŸÑÿ≠ŸÇŸàŸÑ
        const nameInput = document.getElementById('quickRegisterFullName');
        const phoneInput = document.getElementById('quickRegisterPhone');
        if (nameInput) nameInput.value = '';
        if (phoneInput) phoneInput.value = '';
        
        // ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿ≠ŸÇŸÑ ÿßŸÑÿßÿ≥ŸÖ
        setTimeout(() => {
            if (nameInput) nameInput.focus();
        }, 100);
    }
}

/**
 * ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ≥ÿ±Ÿäÿπ
 */
function closeQuickRegistrationModal() {
    const modal = document.getElementById('quickRegistrationModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

/**
 * ŸÖÿπÿßŸÑÿ¨ÿ© ÿ•ÿ±ÿ≥ÿßŸÑ ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ≥ÿ±Ÿäÿπ
 */
async function handleQuickRegisterSubmit(event) {
    event.preventDefault();
    console.log('üìù ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ≥ÿ±Ÿäÿπ...');
    
    try {
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        const fullName = document.getElementById('quickRegisterFullName').value.trim();
        const phone = document.getElementById('quickRegisterPhone').value.trim();
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        if (!fullName || !phone) {
            showNotification('‚ùå Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ', 'error');
            return;
        }
        
        if (phone.length !== 11) {
            showNotification('‚ùå ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ 11 ÿ±ŸÇŸÖ', 'error');
            return;
        }
        
        // ÿ™ÿπÿ∑ŸäŸÑ ÿ≤ÿ± ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ
        const registerBtn = document.getElementById('quickRegisterBtn');
        const originalBtnText = registerBtn.innerHTML;
        registerBtn.disabled = true;
        registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ...';
        
        // ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        const activationCode = generateActivationCode();
        const userUID = generateUserUID();
        const registeredAt = new Date().toISOString();
        
        const userData = {
            fullName,
            phone,
            activationCode,
            uid: userUID,
            registeredAt,
            status: 'pending',
            activatedAt: null,
            lastLogin: null,
            metadata: {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language
            }
        };
        
        console.log('üìä ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', userData);
        
        // ÿ≠ŸÅÿ∏ ŸÅŸä Firebase
        const savedToFirebase = await saveUserToFirebase(userData);
        
        if (!savedToFirebase) {
            throw new Error('ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä Firebase');
        }
        
        // ÿ≠ŸÅÿ∏ ŸÅŸä localStorage
        localStorage.setItem('currentUser', JSON.stringify(userData));
        localStorage.setItem('userStatus', 'pending');
        
        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© Ÿàÿßÿ™ÿ≥ÿßÿ® (ÿ®ÿØŸàŸÜ ÿπÿ±ÿ∂ ÿßŸÑÿ±ŸÖÿ≤ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ)
        sendWhatsAppToCompany(fullName, phone, activationCode, userUID);
        
        // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
        closeQuickRegistrationModal();
        
        // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿ¨ÿßÿ≠
        showNotification(`‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ®ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠! ÿ≥ÿ™ÿ™ŸÑŸÇŸâ ÿ±ŸÖÿ≤ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿÆŸÑÿßŸÑ 24 ÿ≥ÿßÿπÿ©`, 'success');
        
        console.log('‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ≥ÿ±Ÿäÿπ ÿ®ŸÜÿ¨ÿßÿ≠!');
        
        // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸÅÿ™Ÿàÿ≠ÿ©
        updateRegistrationUI();
        
        // ÿ®ÿØÿ° ŸÅÿ≠ÿµ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
        startActivationPolling(userUID);
        
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ≥ÿ±Ÿäÿπ:', error);
        showNotification(`‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ${error.message}`, 'error');
        
        // ÿ•ÿπÿßÿØÿ© ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≤ÿ±
        const registerBtn = document.getElementById('quickRegisterBtn');
        if (registerBtn) {
            registerBtn.disabled = false;
            registerBtn.innerHTML = originalBtnText;
        }
    }
}

// ÿ™ÿµÿØŸäÿ± ÿßŸÑÿØŸàÿßŸÑ ÿßŸÑÿ¨ÿØŸäÿØÿ©
window.openQuickRegistrationModal = openQuickRegistrationModal;
window.closeQuickRegistrationModal = closeQuickRegistrationModal;
window.handleQuickRegisterSubmit = handleQuickRegisterSubmit;
window.showNotification = showNotification;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© (Cloud Management)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ®ŸäŸÜ ÿ™ÿ®ŸàŸäÿ®ÿßÿ™ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
 */
function switchCloudTab(tabName) {
    console.log('üîÑ switchCloudTab:', tabName);
    
    // ÿ•ÿÆŸÅÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™
    document.querySelectorAll('.cloud-tab-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    
    // ÿ•ÿ≤ÿßŸÑÿ© active ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
    document.querySelectorAll('.cloud-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
    const targetPanel = document.getElementById(`cloudTab-${tabName}`);
    const targetBtn = document.querySelector(`.cloud-tab-btn[data-tab="${tabName}"]`);
    
    if (targetPanel) {
        targetPanel.classList.add('active');
    }
    
    if (targetBtn) {
        targetBtn.classList.add('active');
    }
    
    // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿ© ÿ≠ÿ≥ÿ® ÿ≠ÿßŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
    updateCloudTabContent(tabName);
}

/**
 * ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™ ÿ≠ÿ≥ÿ® ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
 */
function updateCloudTabContent(tabName) {
    const userStatus = localStorage.getItem('userStatus');
    const isLoggedIn = userStatus === 'active';
    const isPending = userStatus === 'pending';
    
    console.log('üìä updateCloudTabContent:', { tabName, userStatus, isLoggedIn, isPending });
    
    if (tabName === 'login') {
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ™ÿ®ŸàŸäÿ®ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
        const loginForm = document.getElementById('cloudLoginForm');
        const loggedInPanel = document.getElementById('cloudLoggedInPanel');
        const waitingPanel = document.getElementById('cloudWaitingActivation');
        
        if (isLoggedIn) {
            // ŸÖÿ≥ÿ¨ŸÑ ŸàŸÖŸÅÿπŸëŸÑ
            if (loginForm) loginForm.style.display = 'none';
            if (waitingPanel) waitingPanel.style.display = 'none';
            if (loggedInPanel) {
                loggedInPanel.style.display = 'block';
                updateCloudUserInfo();
            }
        } else if (isPending) {
            // ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÅÿπŸäŸÑ
            if (loginForm) loginForm.style.display = 'none';
            if (loggedInPanel) loggedInPanel.style.display = 'none';
            if (waitingPanel) waitingPanel.style.display = 'block';
        } else {
            // ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ
            if (loggedInPanel) loggedInPanel.style.display = 'none';
            if (waitingPanel) waitingPanel.style.display = 'none';
            if (loginForm) loginForm.style.display = 'block';
        }
    } else if (tabName === 'backup') {
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ™ÿ®ŸàŸäÿ®ÿ© ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆ
        const loginRequired = document.getElementById('cloudBackupLoginRequired');
        const backupPanel = document.getElementById('cloudBackupPanel');
        
        if (isLoggedIn) {
            if (loginRequired) loginRequired.style.display = 'none';
            if (backupPanel) {
                backupPanel.style.display = 'block';
                refreshCloudBackupInfo();
            }
        } else {
            if (backupPanel) backupPanel.style.display = 'none';
            if (loginRequired) loginRequired.style.display = 'block';
        }
    } else if (tabName === 'restore') {
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ™ÿ®ŸàŸäÿ®ÿ© ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ
        const loginRequired = document.getElementById('cloudRestoreLoginRequired');
        const restorePanel = document.getElementById('cloudRestorePanel');
        
        if (isLoggedIn) {
            if (loginRequired) loginRequired.style.display = 'none';
            if (restorePanel) restorePanel.style.display = 'block';
        } else {
            if (restorePanel) restorePanel.style.display = 'none';
            if (loginRequired) loginRequired.style.display = 'block';
        }
    } else if (tabName === 'history') {
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ÿ¨ŸÑ
        loadCloudBackupHistory();
    }
}

/**
 * ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä ÿ™ÿ®ŸàŸäÿ®ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
 */
function updateCloudUserInfo() {
    const userData = JSON.parse(localStorage.getItem('currentUser') || '{}');
    
    console.log('üë§ updateCloudUserInfo:', userData);
    
    // ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
    const displayNameEl = document.getElementById('cloudUserDisplayName');
    if (displayNameEl) {
        displayNameEl.textContent = `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${userData.fullName || '---'}`;
    }
    
    // ÿßŸÑÿßÿ≥ŸÖ
    const nameEl = document.getElementById('cloudUserName');
    if (nameEl) {
        nameEl.textContent = userData.fullName || '---';
    }
    
    // ÿßŸÑŸáÿßÿ™ŸÅ
    const phoneEl = document.getElementById('cloudUserPhone');
    if (phoneEl) {
        phoneEl.textContent = userData.phone || '---';
    }
    
    // ÿßŸÑŸÖÿπÿ±ŸëŸÅ
    const uidEl = document.getElementById('cloudUserUID');
    if (uidEl) {
        uidEl.textContent = userData.uid || '---';
    }
    
    // ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
    const registeredAtEl = document.getElementById('cloudUserRegisteredAt');
    if (registeredAtEl && userData.registeredAt) {
        const date = new Date(userData.registeredAt);
        registeredAtEl.textContent = date.toLocaleDateString('ar-EG', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }
}

/**
 * ÿπÿ±ÿ∂ ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ¨ÿØŸäÿØ
 */
function showCloudRegisterForm() {
    document.getElementById('cloudRegisterFormPanel').style.display = 'block';
    document.getElementById('cloudLoginFormPanel').style.display = 'none';
}

/**
 * ÿ•ÿÆŸÅÿßÿ° ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
 */
function hideCloudRegisterForm() {
    document.getElementById('cloudRegisterFormPanel').style.display = 'none';
}

/**
 * ÿπÿ±ÿ∂ ŸÜŸÖŸàÿ∞ÿ¨ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
 */
function showCloudLoginForm() {
    document.getElementById('cloudLoginFormPanel').style.display = 'block';
    document.getElementById('cloudRegisterFormPanel').style.display = 'none';
}

/**
 * ÿ•ÿÆŸÅÿßÿ° ŸÜŸÖŸàÿ∞ÿ¨ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
 */
function hideCloudLoginForm() {
    document.getElementById('cloudLoginFormPanel').style.display = 'none';
}

/**
 * ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∑ŸÑÿ® ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ¨ÿØŸäÿØ ŸÖŸÜ ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
 */
async function handleCloudRegisterSubmit(event) {
    event.preventDefault();
    console.log('üìù handleCloudRegisterSubmit...');
    
    try {
        const fullName = document.getElementById('cloudRegFullName').value.trim();
        const phone = document.getElementById('cloudRegPhone').value.trim();
        
        if (!fullName || !phone) {
            showNotification('‚ùå Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ', 'error');
            return;
        }
        
        if (phone.length !== 11) {
            showNotification('‚ùå ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ 11 ÿ±ŸÇŸÖ', 'error');
            return;
        }
        
        // ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        const activationCode = generateActivationCode();
        const userUID = generateUserUID();
        const registeredAt = new Date().toISOString();
        
        const userData = {
            fullName,
            phone,
            activationCode,
            uid: userUID,
            registeredAt,
            status: 'pending'
        };
        
        console.log('üìä ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', userData);
        
        // ÿ≠ŸÅÿ∏ ŸÅŸä Firebase
        const savedToFirebase = await saveUserToFirebase(userData);
        
        if (!savedToFirebase) {
            throw new Error('ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä Firebase');
        }
        
        // ÿ≠ŸÅÿ∏ ŸÅŸä localStorage
        localStorage.setItem('currentUser', JSON.stringify(userData));
        localStorage.setItem('userStatus', 'pending');
        
        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© Ÿàÿßÿ™ÿ≥ÿßÿ®
        sendWhatsAppToCompany(fullName, phone, activationCode, userUID);
        
        // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿ¨ÿßÿ≠
        showNotification('‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ®ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠! ÿ≥ÿ™ÿ™ŸÑŸÇŸâ ÿ±ŸÖÿ≤ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿÆŸÑÿßŸÑ 24 ÿ≥ÿßÿπÿ©', 'success');
        
        // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
        hideCloudRegisterForm();
        updateCloudTabContent('login');
        updateCloudManagementSummary();
        
        // ÿ®ÿØÿ° ŸÅÿ≠ÿµ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
        startActivationPolling();
        
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ:', error);
        showNotification(`‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ${error.message}`, 'error');
    }
}

/**
 * ŸÖÿπÿßŸÑÿ¨ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
 */
async function handleCloudLoginSubmit(event) {
    event.preventDefault();
    console.log('üîê handleCloudLoginSubmit...');
    
    try {
        const fullName = document.getElementById('cloudLoginFullName').value.trim();
        const phone = document.getElementById('cloudLoginPhone').value.trim();
        const activationCode = document.getElementById('cloudLoginActivationCode').value.trim();
        
        if (!fullName || !phone || !activationCode) {
            showNotification('‚ùå Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ', 'error');
            return;
        }
        
        if (phone.length !== 11) {
            showNotification('‚ùå ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ 11 ÿ±ŸÇŸÖ', 'error');
            return;
        }
        
        if (activationCode.length !== 6) {
            showNotification('‚ùå ÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ 6 ÿ£ÿ±ŸÇÿßŸÖ', 'error');
            return;
        }
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Firebase
        if (typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0) {
            throw new Error('Firebase ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ');
        }
        
        const database = firebase.database();
        
        // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ Ÿàÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ
        const usersRef = database.ref('users');
        const snapshot = await usersRef.orderByChild('phone').equalTo(phone).once('value');
        
        if (!snapshot.exists()) {
            throw new Error('ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ');
        }
        
        let foundUser = null;
        snapshot.forEach(childSnapshot => {
            const user = childSnapshot.val();
            if (user.activationCode === activationCode && user.fullName === fullName) {
                foundUser = user;
            }
        });
        
        if (!foundUser) {
            throw new Error('ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
        }
        
        if (foundUser.status !== 'active') {
            throw new Error('ÿ≠ÿ≥ÿßÿ®ŸÉ ÿ∫Ÿäÿ± ŸÖŸÅÿπŸëŸÑ ÿ®ÿπÿØ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ÿ≠ÿ™Ÿâ ÿ™ÿ™ŸÖ ÿßŸÑŸÖŸàÿßŸÅŸÇÿ© ÿπŸÑŸâ ÿ∑ŸÑÿ®ŸÉ.');
        }
        
        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÜÿßÿ¨ÿ≠
        localStorage.setItem('currentUser', JSON.stringify(foundUser));
        localStorage.setItem('userStatus', 'active');
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ¢ÿÆÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ
        await database.ref(`users/${foundUser.uid}`).update({
            lastLogin: new Date().toISOString()
        });
        
        showNotification(`üéâ ŸÖÿ±ÿ≠ÿ®ÿßŸã ${foundUser.fullName}! ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠`, 'success');
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
        hideCloudLoginForm();
        updateCloudTabContent('login');
        updateCloudManagementSummary();
        
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ:', error);
        const errorMessage = error?.message || error?.toString() || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
        showNotification(`‚ùå ÿÆÿ∑ÿ£: ${errorMessage}`, 'error');
    }
}

/**
 * ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
 */
function handleCloudLogout() {
    if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü')) {
        localStorage.removeItem('currentUser');
        localStorage.removeItem('userStatus');
        
        showNotification('‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
        updateCloudTabContent('login');
        updateCloudManagementSummary();
    }
}

/**
 * ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ ŸÖŸÜ ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
 */
async function checkCloudActivationStatus() {
    await checkActivationStatus();
    updateCloudTabContent('login');
    updateCloudManagementSummary();
}

/**
 * ÿ•ŸÑÿ∫ÿßÿ° ÿ∑ŸÑÿ® ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
 */
function cancelCloudRegistration() {
    if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ŸÑÿ∫ÿßÿ° ÿ∑ŸÑÿ® ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑÿü')) {
        localStorage.removeItem('currentUser');
        localStorage.removeItem('userStatus');
        
        showNotification('‚úÖ ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ∑ŸÑÿ®', 'success');
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
        updateCloudTabContent('login');
        updateCloudManagementSummary();
    }
}

/**
 * ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä
 */
function refreshCloudBackupInfo() {
    const lastBackup = JSON.parse(localStorage.getItem('lastFirebaseBackup') || '{}');
    
    // ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ©
    const lastDateEl = document.getElementById('cloudBackupLastDate');
    if (lastDateEl) {
        if (lastBackup.date) {
            const date = new Date(lastBackup.date);
            lastDateEl.textContent = date.toLocaleString('ar-EG');
        } else {
            lastDateEl.textContent = 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ';
        }
    }
    
    // ÿ≠ÿ¨ŸÖ ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ©
    const lastSizeEl = document.getElementById('cloudBackupLastSize');
    if (lastSizeEl) {
        lastSizeEl.textContent = lastBackup.size || '0 KB';
    }
}

/**
 * ÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
 */
async function showCloudBackupHistory() {
    switchCloudTab('history');
    await loadCloudBackupHistory();
}

/**
 * ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
 */
async function loadCloudBackupHistory() {
    const listEl = document.getElementById('cloudBackupHistoryList');
    if (!listEl) return;
    
    try {
        const userData = JSON.parse(localStorage.getItem('currentUser') || '{}');
        if (!userData.uid) {
            listEl.innerHTML = '<p style="text-align: center; color: var(--theme-text-secondary); padding: 2rem;"><i class="fas fa-lock"></i> Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã</p>';
            return;
        }
        
        listEl.innerHTML = '<p style="text-align: center; color: var(--theme-text-secondary); padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p>';
        
        const database = firebase.database();
        const backupsRef = database.ref(`users/${userData.uid}/backups`);
        const snapshot = await backupsRef.orderByKey().limitToLast(20).once('value');
        
        if (!snapshot.exists()) {
            listEl.innerHTML = '<p style="text-align: center; color: var(--theme-text-secondary); padding: 2rem;"><i class="fas fa-info-circle"></i> ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ≥ÿ≠ÿßÿ®Ÿäÿ© ÿ®ÿπÿØ</p>';
            return;
        }
        
        const backups = [];
        snapshot.forEach(childSnapshot => {
            backups.push({
                key: childSnapshot.key,
                ...childSnapshot.val()
            });
        });
        
        // ÿπŸÉÿ≥ ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® (ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã)
        backups.reverse();
        
        // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ¨ÿØŸàŸÑ
        let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr style="background: var(--theme-bg-secondary); border-bottom: 2px solid rgba(255,255,255,0.1);">';
        html += '<th style="padding: 1rem; text-align: right;">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>';
        html += '<th style="padding: 1rem; text-align: right;">ÿßŸÑÿ≠ÿ¨ŸÖ</th>';
        html += '<th style="padding: 1rem; text-align: right;">ÿ™ŸÑŸÇÿßÿ¶Ÿä</th>';
        html += '<th style="padding: 1rem; text-align: right;">ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>';
        html += '</tr></thead><tbody>';
        
        backups.forEach((backup, index) => {
            const date = new Date(backup.metadata?.timestamp || parseInt(backup.key));
            const size = backup.metadata?.sizeText || '---';
            const isAuto = backup.metadata?.automatic ? 'ŸÜÿπŸÖ' : 'ŸÑÿß';
            
            html += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">`;
            html += `<td style="padding: 1rem;">${date.toLocaleString('ar-EG')}</td>`;
            html += `<td style="padding: 1rem;">${size}</td>`;
            html += `<td style="padding: 1rem;">${isAuto}</td>`;
            html += `<td style="padding: 1rem;">`;
            html += `<button class="btn btn-sm btn-secondary" onclick="restoreSpecificBackup('${backup.key}')">`;
            html += `<i class="fas fa-download"></i> ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ`;
            html += `</button>`;
            html += `</td>`;
            html += `</tr>`;
        });
        
        html += '</tbody></table></div>';
        listEl.innerHTML = html;
        
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ÿ¨ŸÑ:', error);
        listEl.innerHTML = `<p style="text-align: center; color: #ef4444; padding: 2rem;"><i class="fas fa-exclamation-triangle"></i> ÿÆÿ∑ÿ£: ${error.message}</p>`;
    }
}

/**
 * ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÖÿ≠ÿØÿØÿ©
 */
async function restoreSpecificBackup(backupKey) {
    if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ Ÿáÿ∞Ÿá ÿßŸÑŸÜÿ≥ÿÆÿ©ÿü ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©!')) {
        return;
    }
    
    try {
        const userData = JSON.parse(localStorage.getItem('currentUser') || '{}');
        if (!userData.uid) {
            throw new Error('Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
        }
        
        showNotification('‚è≥ ÿ¨ÿßÿ±Ÿä ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©...', 'info');
        
        const database = firebase.database();
        const backupRef = database.ref(`users/${userData.uid}/backups/${backupKey}`);
        const snapshot = await backupRef.once('value');
        
        if (!snapshot.exists()) {
            throw new Error('ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
        }
        
        const backupData = snapshot.val().data;
        
        // ÿßÿ≥ÿ™ÿπÿßÿØÿ© localStorage
        if (backupData.localStorage) {
            for (const [key, value] of Object.entries(backupData.localStorage)) {
                localStorage.setItem(key, value);
            }
        }
        
        showNotification('‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
        
        // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        setTimeout(() => {
            location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ:', error);
        showNotification(`‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ: ${error.message}`, 'error');
    }
}

/**
 * ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
 */
function saveCloudSettings() {
    const autoBackupEnabled = document.getElementById('cloudAutoBackupEnabled')?.checked || false;
    const autoBackupFrequency = document.getElementById('cloudAutoBackupFrequency')?.value || 'startup';
    
    localStorage.setItem('autoFirebaseBackupEnabled', autoBackupEnabled);
    localStorage.setItem('cloudAutoBackupFrequency', autoBackupFrequency);
    
    showNotification('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
}

/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * ÿØŸàÿßŸÑ ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÉÿßŸÖŸÑÿ© ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 */

/**
 * ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
 */
function saveDataUploadSettings() {
    const autoUploadEnabled = document.getElementById('autoUploadAllData')?.checked || false;
    const uploadFrequency = document.getElementById('autoUploadFrequency')?.value || '5min';
    
    localStorage.setItem('autoUploadAllDataEnabled', autoUploadEnabled);
    localStorage.setItem('autoUploadFrequency', uploadFrequency);
    
    // ÿ•ÿ∞ÿß ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ±ŸÅÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿäÿå ŸÇŸÖ ÿ®ÿ¨ÿØŸàŸÑÿ© ÿßŸÑÿ±ŸÅÿπ
    if (autoUploadEnabled) {
        scheduleAutoDataUpload();
        showNotification('‚úÖ ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ±ŸÅÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™', 'success');
    } else {
        // ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ¨ÿØŸàŸÑÿ©
        if (window.dataUploadInterval) {
            clearInterval(window.dataUploadInterval);
            window.dataUploadInterval = null;
        }
        showNotification('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™', 'success');
    }
}

/**
 * ÿ±ŸÅÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸäÿØŸàŸäÿßŸã
 */
async function manualUploadAllData() {
    try {
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
        const currentUserId = localStorage.getItem('currentUserId');
        if (!currentUserId) {
            showNotification('‚ùå Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã', 'error');
            return;
        }

        showNotification('üîÑ ÿ¨ÿßÿ±Ÿä ÿ±ŸÅÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...', 'info');

        // ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        await uploadAllDataToFirebase();

        // ÿ™ÿ≠ÿØŸäÿ´ ŸàŸÇÿ™ ÿ¢ÿÆÿ± ÿ±ŸÅÿπ
        const lastUploadTime = new Date().toISOString();
        localStorage.setItem('lastDataUploadTime', lastUploadTime);
        updateLastDataUploadDisplay();

        showNotification('‚úÖ ÿ™ŸÖ ÿ±ŸÅÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');

    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
        const errorMessage = error?.message || error?.toString() || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
        showNotification(`‚ùå ŸÅÿ¥ŸÑ ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ${errorMessage}`, 'error');
    }
}

/**
 * ÿ¨ÿØŸàŸÑÿ© ÿßŸÑÿ±ŸÅÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™
 */
function scheduleAutoDataUpload() {
    const frequency = localStorage.getItem('autoUploadFrequency') || '5min';
    
    // ÿ•ŸÑÿ∫ÿßÿ° ÿ£Ÿä ÿ¨ÿØŸàŸÑÿ© ÿ≥ÿßÿ®ŸÇÿ©
    if (window.dataUploadInterval) {
        clearInterval(window.dataUploadInterval);
    }

    let intervalTime = 5 * 60 * 1000; // 5 ÿØŸÇÿßÿ¶ŸÇ ÿßŸÅÿ™ÿ±ÿßÿ∂ŸäÿßŸã

    switch(frequency) {
        case 'immediate':
            // ŸÑÿß ŸÜÿ≥ÿ™ÿÆÿØŸÖ interval ŸÑŸÑÿ±ŸÅÿπ ÿßŸÑŸÅŸàÿ±Ÿäÿå ÿ®ŸÑ ŸÜÿ±ŸÅÿπ ÿπŸÜÿØ ŸÉŸÑ ÿ™ÿ∫ŸäŸäÿ±
            return;
        case '5min':
            intervalTime = 5 * 60 * 1000;
            break;
        case '15min':
            intervalTime = 15 * 60 * 1000;
            break;
        case '30min':
            intervalTime = 30 * 60 * 1000;
            break;
        case 'hourly':
            intervalTime = 60 * 60 * 1000;
            break;
        case 'daily':
            intervalTime = 24 * 60 * 60 * 1000;
            break;
    }

    // ÿ¨ÿØŸàŸÑÿ© ÿßŸÑÿ±ŸÅÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
    window.dataUploadInterval = setInterval(async () => {
        const autoUploadEnabled = localStorage.getItem('autoUploadAllDataEnabled') === 'true';
        const currentUserId = localStorage.getItem('currentUserId');
        
        if (autoUploadEnabled && currentUserId) {
            console.log('üîÑ ÿ±ŸÅÿπ ÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™...');
            try {
                await uploadAllDataToFirebase();
                const lastUploadTime = new Date().toISOString();
                localStorage.setItem('lastDataUploadTime', lastUploadTime);
                updateLastDataUploadDisplay();
                console.log('‚úÖ ÿ™ŸÖ ÿßŸÑÿ±ŸÅÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿ®ŸÜÿ¨ÿßÿ≠');
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ±ŸÅÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä:', error);
            }
        }
    }, intervalTime);

    console.log(`üìÖ ÿ™ŸÖ ÿ¨ÿØŸàŸÑÿ© ÿßŸÑÿ±ŸÅÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÉŸÑ ${frequency}`);
}

/**
 * ÿ±ŸÅÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ Firebase
 */
async function uploadAllDataToFirebase() {
    const currentUserId = localStorage.getItem('currentUserId');
    if (!currentUserId) {
        throw new Error('Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
    }

    // ÿ¨ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    const allData = {
        products: JSON.parse(localStorage.getItem('products') || '[]'),
        categories: JSON.parse(localStorage.getItem('categories') || '[]'),
        invoices: JSON.parse(localStorage.getItem('invoices') || '[]'),
        debts: JSON.parse(localStorage.getItem('debts') || '[]'),
        installments: JSON.parse(localStorage.getItem('installments') || '[]'),
        revenues: JSON.parse(localStorage.getItem('revenues') || '[]'),
        expenses: JSON.parse(localStorage.getItem('expenses') || '[]'),
        customers: JSON.parse(localStorage.getItem('customers') || '[]'),
        suppliers: JSON.parse(localStorage.getItem('suppliers') || '[]'),
        storeSettings: JSON.parse(localStorage.getItem('storeSettings') || '{}'),
        systemSettings: JSON.parse(localStorage.getItem('systemSettings') || '{}'),
        timestamp: new Date().toISOString()
    };

    // ÿ™ÿ∑ŸáŸäÿ± ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠ ŸÑŸÄ Firebase
    const sanitizedData = sanitizeForFirebase(allData);

    // ÿ±ŸÅÿπ ÿ•ŸÑŸâ Firebase
    const dataRef = firebase.database().ref(`users/${currentUserId}/fullData`);
    await dataRef.set({
        data: sanitizedData,
        uploadedAt: firebase.database.ServerValue.TIMESTAMP,
        version: '1.0'
    });

    return sanitizedData;
}

/**
 * ÿ™ÿ≠ÿØŸäÿ´ ÿπÿ±ÿ∂ ÿ¢ÿÆÿ± ŸàŸÇÿ™ ÿ±ŸÅÿπ ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™
 */
function updateLastDataUploadDisplay() {
    const lastUploadTime = localStorage.getItem('lastDataUploadTime');
    const displayEl = document.getElementById('lastDataUploadTime');
    
    if (displayEl) {
        if (lastUploadTime) {
            const date = new Date(lastUploadTime);
            const now = new Date();
            const diffMinutes = Math.floor((now - date) / (1000 * 60));
            
            if (diffMinutes < 1) {
                displayEl.textContent = 'ÿßŸÑÿ¢ŸÜ';
            } else if (diffMinutes < 60) {
                displayEl.textContent = `ŸÇÿ®ŸÑ ${diffMinutes} ÿØŸÇŸäŸÇÿ©`;
            } else {
                const diffHours = Math.floor(diffMinutes / 60);
                if (diffHours < 24) {
                    displayEl.textContent = `ŸÇÿ®ŸÑ ${diffHours} ÿ≥ÿßÿπÿ©`;
                } else {
                    const diffDays = Math.floor(diffHours / 24);
                    displayEl.textContent = `ŸÇÿ®ŸÑ ${diffDays} ŸäŸàŸÖ`;
                }
            }
        } else {
            displayEl.textContent = 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ±ŸÅÿπ ÿ®ÿπÿØ';
        }
    }
}

/**
 * ÿ™ŸáŸäÿ¶ÿ© ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
 */
function initDataUpload() {
    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂
    updateLastDataUploadDisplay();
    
    // ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ŸÉÿ±ÿßÿ± ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ
    const autoUploadCheckbox = document.getElementById('autoUploadAllData');
    const frequencyPanel = document.getElementById('autoUploadFrequencyPanel');
    
    if (autoUploadCheckbox && frequencyPanel) {
        autoUploadCheckbox.addEventListener('change', function() {
            frequencyPanel.style.display = this.checked ? 'block' : 'none';
        });
        
        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑÿ£ŸàŸÑŸä
        const autoUploadEnabled = localStorage.getItem('autoUploadAllDataEnabled') === 'true';
        autoUploadCheckbox.checked = autoUploadEnabled;
        frequencyPanel.style.display = autoUploadEnabled ? 'block' : 'none';
        
        // ÿ™ŸáŸäÿ¶ÿ© ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿ±ŸÅÿπ
        const savedFrequency = localStorage.getItem('autoUploadFrequency');
        const frequencySelect = document.getElementById('autoUploadFrequency');
        if (savedFrequency && frequencySelect) {
            frequencySelect.value = savedFrequency;
        }
        
        // ÿ¨ÿØŸàŸÑÿ© ÿßŸÑÿ±ŸÅÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸÅÿπŸÑÿßŸã
        if (autoUploadEnabled) {
            scheduleAutoDataUpload();
        }
    }
}

/**
 * ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿØŸàÿßŸÑ ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
 */
document.addEventListener('DOMContentLoaded', function() {
    // ÿ™ŸáŸäÿ¶ÿ© ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    setTimeout(initDataUpload, 1000);
});

/**
 * ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸÑÿÆÿµ ŸÅŸä ÿ£ÿπŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ©
 */
function updateCloudManagementSummary() {
    // ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ÿ≥ÿ≠ÿßÿ®Ÿäÿ©
    const lastBackup = JSON.parse(localStorage.getItem('lastFirebaseBackup') || '{}');
    const lastDateEl = document.getElementById('cloudLastBackupDate');
    if (lastDateEl) {
        if (lastBackup.date) {
            const date = new Date(lastBackup.date);
            const now = new Date();
            const diffHours = Math.floor((now - date) / (1000 * 60 * 60));
            
            if (diffHours < 1) {
                lastDateEl.textContent = 'ŸÇÿ®ŸÑ ÿ£ŸÇŸÑ ŸÖŸÜ ÿ≥ÿßÿπÿ©';
            } else if (diffHours < 24) {
                lastDateEl.textContent = `ŸÇÿ®ŸÑ ${diffHours} ÿ≥ÿßÿπÿ©`;
            } else {
                const diffDays = Math.floor(diffHours / 24);
                lastDateEl.textContent = `ŸÇÿ®ŸÑ ${diffDays} ŸäŸàŸÖ`;
            }
        } else {
            lastDateEl.textContent = 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ';
        }
    }
    
    // ÿ≠ÿ¨ŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    const sizeEl = document.getElementById('cloudBackupSize');
    if (sizeEl) {
        sizeEl.textContent = lastBackup.size || '0 KB';
    }
    
    // ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®
    const userStatus = localStorage.getItem('userStatus');
    const statusEl = document.getElementById('cloudAccountStatus');
    if (statusEl) {
        if (userStatus === 'active') {
            statusEl.textContent = '‚úì ŸÖŸèŸÅÿπŸëŸÑ';
            statusEl.style.color = '#10b981';
        } else if (userStatus === 'pending') {
            statusEl.textContent = '‚è≥ ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±';
            statusEl.style.color = '#f59e0b';
        } else {
            statusEl.textContent = 'ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ';
            statusEl.style.color = '#ef4444';
        }
    }
    
    // ÿπÿØÿØ ÿßŸÑŸÜÿ≥ÿÆ (ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´Ÿá ŸÑÿßÿ≠ŸÇÿßŸã ŸÖŸÜ Firebase)
    const countEl = document.getElementById('cloudBackupCount');
    if (countEl) {
        countEl.textContent = '---';
    }
}

// ÿ™ÿµÿØŸäÿ± ÿßŸÑÿØŸàÿßŸÑ ÿßŸÑÿ¨ÿØŸäÿØÿ©
window.switchCloudTab = switchCloudTab;
window.showCloudRegisterForm = showCloudRegisterForm;
window.hideCloudRegisterForm = hideCloudRegisterForm;
window.showCloudLoginForm = showCloudLoginForm;
window.hideCloudLoginForm = hideCloudLoginForm;
window.handleCloudRegisterSubmit = handleCloudRegisterSubmit;
window.handleCloudLoginSubmit = handleCloudLoginSubmit;
window.handleCloudLogout = handleCloudLogout;
window.checkCloudActivationStatus = checkCloudActivationStatus;
window.cancelCloudRegistration = cancelCloudRegistration;
window.refreshCloudBackupInfo = refreshCloudBackupInfo;
window.showCloudBackupHistory = showCloudBackupHistory;
window.loadCloudBackupHistory = loadCloudBackupHistory;
window.restoreSpecificBackup = restoreSpecificBackup;
window.saveCloudSettings = saveCloudSettings;
window.updateCloudManagementSummary = updateCloudManagementSummary;

/**
 * ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä ŸÅŸä ÿµŸÅÿ≠ÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®
 */
function updateCloudSubscriptionUI() {
    const container = document.getElementById('cloudSubscriptionContent');
    if (!container) return;
    
    const userStatus = localStorage.getItem('userStatus');
    const currentUser = localStorage.getItem('currentUser');
    
    // ÿßŸÑÿ≠ÿßŸÑÿ© 1: ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ - ÿπÿ±ÿ∂ ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
    if (!userStatus || !currentUser) {
        container.innerHTML = `
            <div style="background: linear-gradient(135deg, var(--theme-bg-secondary) 0%, var(--theme-bg-hover) 100%); border-radius: 20px; padding: 2.5rem; border: 2px solid rgba(102, 126, 234, 0.2); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);">
              
              <!-- ÿ£ŸäŸÇŸàŸÜÿ© -->
              <div style="text-align: center; margin-bottom: 2rem;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);">
                  <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: white;"></i>
                </div>
                <h3 style="font-size: 1.75rem; font-weight: 700; color: var(--theme-text-primary); margin: 0 0 0.5rem 0;">
                  ÿßÿ¥ÿ™ÿ±ŸÉ ŸÅŸä ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä
                </h3>
                <p style="font-size: 1.1rem; color: var(--theme-text-secondary); margin: 0;">
                  ÿßÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿ®ÿ¥ŸÉŸÑ ÿ¢ŸÖŸÜ ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
                </p>
              </div>

              <!-- ÿßŸÑŸÖŸäÿ≤ÿßÿ™ -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                
                <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.1);">
                  <div style="display: flex; align-items: start; gap: 1rem;">
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                      <i class="fas fa-shield-alt" style="font-size: 1.25rem; color: white;"></i>
                    </div>
                    <div>
                      <h4 style="color: var(--theme-text-primary); margin: 0 0 0.5rem 0; font-size: 1.1rem;">ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿ¢ŸÖŸÜ</h4>
                      <p style="color: var(--theme-text-secondary); margin: 0; font-size: 0.95rem; line-height: 1.5;">
                        ÿ≠ŸÖÿßŸäÿ© ŸÉÿßŸÖŸÑÿ© ŸÑÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
                      </p>
                    </div>
                  </div>
                </div>

                <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.1);">
                  <div style="display: flex; align-items: start; gap: 1rem;">
                    <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                      <i class="fas fa-sync-alt" style="font-size: 1.25rem; color: white;"></i>
                    </div>
                    <div>
                      <h4 style="color: var(--theme-text-primary); margin: 0 0 0.5rem 0; font-size: 1.1rem;">ŸÜÿ≥ÿÆ ÿ™ŸÑŸÇÿßÿ¶Ÿä</h4>
                      <p style="color: var(--theme-text-secondary); margin: 0; font-size: 0.95rem; line-height: 1.5;">
                        ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑÿ®ŸäÿßŸÜÿßÿ™ŸÉ ŸäŸàŸÖŸäÿßŸã
                      </p>
                    </div>
                  </div>
                </div>

                <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.1);">
                  <div style="display: flex; align-items: start; gap: 1rem;">
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                      <i class="fas fa-laptop" style="font-size: 1.25rem; color: white;"></i>
                    </div>
                    <div>
                      <h4 style="color: var(--theme-text-primary); margin: 0 0 0.5rem 0; font-size: 1.1rem;">ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿ≥ŸáŸÑ</h4>
                      <p style="color: var(--theme-text-secondary); margin: 0; font-size: 0.95rem; line-height: 1.5;">
                        ÿßÿ≥ÿ™ÿ±ÿ¨ÿπ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿπŸÑŸâ ÿ£Ÿä ÿ¨Ÿáÿßÿ≤ ŸÅŸä ÿ£Ÿä ŸàŸÇÿ™
                      </p>
                    </div>
                  </div>
                </div>

              </div>

              <!-- ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ -->
              <form id="cloudRegisterForm" onsubmit="handleCloudRegisterSubmit(event); return false;" style="max-width: 600px; margin: 0 auto;">
                
                <!-- ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ±ÿ®ÿßÿπŸä -->
                <div style="margin-bottom: 1.5rem;">
                  <label style="display: block; color: var(--theme-text-primary); font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;">
                    <i class="fas fa-user"></i> ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ±ÿ®ÿßÿπŸä
                  </label>
                  <input 
                    type="text" 
                    id="cloudRegisterFullName" 
                    required
                    placeholder="ŸÖÿ´ÿßŸÑ: ÿ£ÿ≠ŸÖÿØ ŸÖÿ≠ŸÖÿØ ÿπŸÑŸä ÿ≠ÿ≥ŸÜ"
                    style="
                      width: 100%;
                      padding: 1rem;
                      border-radius: 12px;
                      border: 2px solid rgba(102, 126, 234, 0.3);
                      background: var(--theme-bg-tertiary);
                      color: var(--theme-text-primary);
                      font-size: 1rem;
                      transition: border 0.3s ease;
                    "
                    onfocus="this.style.borderColor='#667eea'"
                    onblur="this.style.borderColor='rgba(102, 126, 234, 0.3)'"
                  >
                </div>

                <!-- ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ -->
                <div style="margin-bottom: 2rem;">
                  <label style="display: block; color: var(--theme-text-primary); font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;">
                    <i class="fas fa-phone"></i> ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ
                  </label>
                  <input 
                    type="tel" 
                    id="cloudRegisterPhone" 
                    required
                    placeholder="ŸÖÿ´ÿßŸÑ: 07701234567"
                    pattern="[0-9]{11}"
                    style="
                      width: 100%;
                      padding: 1rem;
                      border-radius: 12px;
                      border: 2px solid rgba(102, 126, 234, 0.3);
                      background: var(--theme-bg-tertiary);
                      color: var(--theme-text-primary);
                      font-size: 1rem;
                      direction: ltr;
                      text-align: right;
                      transition: border 0.3s ease;
                    "
                    onfocus="this.style.borderColor='#667eea'"
                    onblur="this.style.borderColor='rgba(102, 126, 234, 0.3)'"
                  >
                  <small style="color: var(--theme-text-secondary); font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                    ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ ŸÖŸÉŸàŸÜ ŸÖŸÜ 11 ÿ±ŸÇŸÖ (07XX XXX XXXX)
                  </small>
                </div>

                <!-- ÿ≤ÿ± ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ -->
                <button 
                  type="submit"
                  id="cloudRegisterBtn"
                  class="btn btn-primary"
                  style="
                    width: 100%;
                    padding: 1.25rem;
                    font-size: 1.1rem;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 0.75rem;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border: none;
                  "
                >
                  <i class="fas fa-paper-plane"></i>
                  <span>ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ</span>
                </button>

                <!-- ŸÖŸÑÿßÿ≠ÿ∏ÿ© -->
                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-right: 4px solid #3b82f6; border-radius: 8px;">
                  <p style="color: var(--theme-text-primary); margin: 0; font-size: 0.9rem; line-height: 1.6;">
                    <strong>üì± ŸÖŸÑÿßÿ≠ÿ∏ÿ©:</strong> ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ®ŸÉ ÿ•ŸÑŸâ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿπÿ®ÿ± Ÿàÿßÿ™ÿ≥ÿßÿ®. ÿ≥ÿ™ÿ™ŸÑŸÇŸâ ÿ±ŸÖÿ≤ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿÆŸÑÿßŸÑ 24 ÿ≥ÿßÿπÿ©.
                  </p>
                </div>

              </form>

            </div>
        `;
        return;
    }
    
    const userData = JSON.parse(currentUser);
    
    // ÿßŸÑÿ≠ÿßŸÑÿ© 2: ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÅÿπŸäŸÑ
    if (userStatus === 'pending') {
        container.innerHTML = `
            <div style="background: linear-gradient(135deg, var(--theme-bg-secondary) 0%, var(--theme-bg-hover) 100%); border-radius: 20px; padding: 2.5rem; border: 2px solid rgba(102, 126, 234, 0.2); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);">
              
              <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 5rem; margin-bottom: 1rem;">‚è≥</div>
                <h3 style="font-size: 1.75rem; font-weight: 700; color: var(--theme-text-primary); margin: 0 0 0.5rem 0;">
                  ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÅÿπŸäŸÑ
                </h3>
                <p style="font-size: 1.1rem; color: var(--theme-text-secondary); margin: 0;">
                  ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ®ŸÉ ÿ•ŸÑŸâ ÿßŸÑÿ¥ÿ±ŸÉÿ©
                </p>
              </div>

              <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ∑ŸÑÿ® -->
              <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="display: grid; gap: 1rem;">
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--theme-text-secondary);"><i class="fas fa-user"></i> ÿßŸÑÿßÿ≥ŸÖ:</span>
                    <strong style="color: var(--theme-text-primary);">${userData.fullName}</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--theme-text-secondary);"><i class="fas fa-phone"></i> ÿßŸÑŸáÿßÿ™ŸÅ:</span>
                    <strong style="color: var(--theme-text-primary); direction: ltr;">${userData.phone}</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--theme-text-secondary);"><i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ∑ŸÑÿ®:</span>
                    <strong style="color: var(--theme-text-primary);">${new Date(userData.registeredAt).toLocaleDateString('ar-EG')}</strong>
                  </div>
                </div>
              </div>

              <!-- ÿ™ŸÜÿ®ŸäŸá -->
              <div style="background: rgba(59, 130, 246, 0.1); border-right: 4px solid #3b82f6; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                <p style="color: var(--theme-text-primary); line-height: 1.8; margin: 0; font-size: 0.95rem;">
                  <strong>üì± ŸÖŸÑÿßÿ≠ÿ∏ÿ©:</strong> ÿ≥ÿ™ÿ™ŸÑŸÇŸâ ÿ±ŸÖÿ≤ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿπÿ®ÿ± ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿßŸÑÿ±ŸÖÿ≤ ÿπŸÜÿØ ŸàÿµŸàŸÑŸá. ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿÆŸÑÿßŸÑ 24 ÿ≥ÿßÿπÿ©.
                </p>
              </div>

              <!-- ÿ≤ÿ± ŸÅÿ≠ÿµ ÿßŸÑÿ™ŸÅÿπŸäŸÑ -->
              <button 
                onclick="checkActivationStatus()"
                class="btn btn-primary"
                style="width: 100%; padding: 1.25rem; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; gap: 0.75rem;"
              >
                <i class="fas fa-sync-alt"></i>
                <span>ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ</span>
              </button>

              <!-- ÿ≤ÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ -->
              <button 
                onclick="handleCloudLogout()"
                style="
                  width: 100%;
                  padding: 1rem;
                  border-radius: 12px;
                  border: 2px solid #ef4444;
                  background: transparent;
                  color: #ef4444;
                  font-size: 1rem;
                  font-weight: 600;
                  cursor: pointer;
                  margin-top: 1rem;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 0.5rem;
                "
                onmouseover="this.style.background='rgba(239, 68, 68, 0.1)'"
                onmouseout="this.style.background='transparent'"
              >
                <i class="fas fa-sign-out-alt"></i>
                <span>ÿ•ŸÑÿ∫ÿßÿ° Ÿàÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</span>
              </button>

            </div>
        `;
        return;
    }
    
    // ÿßŸÑÿ≠ÿßŸÑÿ© 3: ŸÖŸèŸÅÿπŸëŸÑ - ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™
    if (userStatus === 'active') {
        container.innerHTML = `
            <div style="background: linear-gradient(135deg, var(--theme-bg-secondary) 0%, var(--theme-bg-hover) 100%); border-radius: 20px; padding: 2.5rem; border: 2px solid rgba(34, 197, 94, 0.3); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);">
              
              <!-- ÿßŸÑÿπŸÜŸàÿßŸÜ -->
              <div style="text-align: center; margin-bottom: 2rem;">
                <div style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);">
                  <i class="fas fa-check" style="font-size: 3.5rem; color: white;"></i>
                </div>
                <h3 style="font-size: 1.75rem; font-weight: 700; color: var(--theme-text-primary); margin: 0 0 0.5rem 0;">
                  ÿßÿ¥ÿ™ÿ±ÿßŸÉŸÉ ŸÖŸèŸÅÿπŸëŸÑ ÿ®ŸÜÿ¨ÿßÿ≠
                </h3>
                <p style="font-size: 1.1rem; color: var(--theme-text-secondary); margin: 0;">
                  ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä
                </p>
              </div>

              <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ -->
              <div style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                
                <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--theme-text-secondary);"><i class="fas fa-user"></i> ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ:</span>
                    <strong style="color: var(--theme-text-primary);">${userData.fullName}</strong>
                  </div>
                </div>

                <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--theme-text-secondary);"><i class="fas fa-phone"></i> ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ:</span>
                    <strong style="color: var(--theme-text-primary); direction: ltr;">${userData.phone}</strong>
                  </div>
                </div>

                <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--theme-text-secondary);"><i class="fas fa-fingerprint"></i> ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:</span>
                    <strong style="color: var(--theme-text-primary); font-family: 'Courier New', monospace; font-size: 0.9rem;">${userData.uid || '---'}</strong>
                  </div>
                </div>

                <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--theme-text-secondary);"><i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ:</span>
                    <strong style="color: var(--theme-text-primary);">${new Date(userData.registeredAt).toLocaleDateString('ar-EG')}</strong>
                  </div>
                </div>

                <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--theme-text-secondary);"><i class="fas fa-check-circle"></i> ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ:</span>
                    <strong style="color: #22c55e;">
                      <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #22c55e; margin-left: 5px;"></span>
                      ŸÖŸèŸÅÿπŸëŸÑ ŸàŸÜÿ¥ÿ∑
                    </strong>
                  </div>
                </div>

              </div>

              <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ -->
              <div style="display: grid; gap: 1rem;">
                
                <!-- ÿ≤ÿ± ÿ±ŸÅÿπ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© -->
                <button 
                  onclick="uploadBackupToFirebase(false)"
                  class="btn btn-primary"
                  style="
                    width: 100%;
                    padding: 1.25rem;
                    font-size: 1.1rem;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 0.75rem;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    border: none;
                  "
                >
                  <i class="fas fa-cloud-upload-alt"></i>
                  <span>ÿ±ŸÅÿπ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿßŸÑÿ¢ŸÜ</span>
                </button>

                <!-- ÿ≤ÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ -->
                <button 
                  onclick="handleCloudLogout()"
                  style="
                    width: 100%;
                    padding: 1rem;
                    border-radius: 12px;
                    border: 2px solid #ef4444;
                    background: transparent;
                    color: #ef4444;
                    font-size: 1rem;
                    font-weight: 600;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 0.5rem;
                  "
                  onmouseover="this.style.background='rgba(239, 68, 68, 0.1)'"
                  onmouseout="this.style.background='transparent'"
                >
                  <i class="fas fa-sign-out-alt"></i>
                  <span>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</span>
                </button>

              </div>

            </div>
        `;
        return;
    }
}

/**
 * ŸÖÿπÿßŸÑÿ¨ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä
 */
async function handleCloudRegisterSubmit(event) {
    event.preventDefault();
    console.log('üìù ŸÖÿπÿßŸÑÿ¨ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä...');
    
    try {
        const fullName = document.getElementById('cloudRegisterFullName').value.trim();
        const phone = document.getElementById('cloudRegisterPhone').value.trim();
        
        if (!fullName || !phone) {
            showNotification('‚ùå Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ', 'error');
            return;
        }
        
        if (phone.length !== 11) {
            showNotification('‚ùå ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ 11 ÿ±ŸÇŸÖ', 'error');
            return;
        }
        
        const registerBtn = document.getElementById('cloudRegisterBtn');
        const originalBtnText = registerBtn.innerHTML;
        registerBtn.disabled = true;
        registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ...';
        
        const activationCode = generateActivationCode();
        const userUID = generateUserUID();
        const registeredAt = new Date().toISOString();
        
        const userData = {
            fullName,
            phone,
            activationCode,
            uid: userUID,
            registeredAt,
            status: 'pending',
            activatedAt: null,
            lastLogin: null,
            metadata: {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language
            }
        };
        
        const savedToFirebase = await saveUserToFirebase(userData);
        
        if (!savedToFirebase) {
            throw new Error('ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä Firebase');
        }
        
        localStorage.setItem('currentUser', JSON.stringify(userData));
        localStorage.setItem('userStatus', 'pending');
        
        sendWhatsAppToCompany(fullName, phone, activationCode, userUID);
        
        showNotification('‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ®ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠! ÿ≥ÿ™ÿ™ŸÑŸÇŸâ ÿ±ŸÖÿ≤ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿÆŸÑÿßŸÑ 24 ÿ≥ÿßÿπÿ©', 'success');
        
        updateCloudSubscriptionUI();
        
        startActivationPolling(userUID);
        
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ:', error);
        showNotification(`‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ${error.message}`, 'error');
        
        const registerBtn = document.getElementById('cloudRegisterBtn');
        if (registerBtn) {
            registerBtn.disabled = false;
            registerBtn.innerHTML = originalBtnText;
        }
    }
}

/**
 * ŸÖÿπÿßŸÑÿ¨ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä
 */
function handleCloudLogout() {
    if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ŸÑŸÑÿ≠ÿ≥ÿßÿ®.')) {
        return;
    }
    
    localStorage.removeItem('currentUser');
    localStorage.removeItem('userStatus');
    
    // ÿ•ŸäŸÇÿßŸÅ ŸÅÿ≠ÿµ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
    if (window.activationPollingInterval) {
        clearInterval(window.activationPollingInterval);
        window.activationPollingInterval = null;
    }
    
    showNotification('‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
    
    updateCloudSubscriptionUI();
}

// ÿ™ÿµÿØŸäÿ± ÿßŸÑÿØŸàÿßŸÑ
window.updateCloudSubscriptionUI = updateCloudSubscriptionUI;
window.handleCloudRegisterSubmit = handleCloudRegisterSubmit;
window.handleCloudLogout = handleCloudLogout;

/**
 * ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä ÿµŸÅÿ≠ÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®
 */
function updateUserDisplayInfo() {
    try {
        const currentUser = localStorage.getItem('currentUser');
        const userStatus = localStorage.getItem('userStatus');
        
        if (!currentUser) {
            return;
        }
        
        const userData = JSON.parse(currentUser);
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿßÿ≥ŸÖ
        const nameElem = document.getElementById('userDisplayName');
        if (nameElem) nameElem.textContent = userData.fullName || '---';
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ
        const phoneElem = document.getElementById('userDisplayPhone');
        if (phoneElem) phoneElem.textContent = userData.phone || '---';
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ±ŸÖÿ≤ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ
        const codeElem = document.getElementById('userDisplayCode');
        if (codeElem) codeElem.textContent = userData.activationCode || '---';
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
        const dateElem = document.getElementById('userDisplayDate');
        if (dateElem && userData.registeredAt) {
            const date = new Date(userData.registeredAt);
            dateElem.textContent = date.toLocaleDateString('ar-EG');
        }
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®
        const statusTextElem = document.getElementById('userDisplayStatus');
        const statusBadgeElem = document.getElementById('userDisplayStatusBadge');
        
        if (userStatus === 'active') {
            if (statusTextElem) statusTextElem.textContent = '‚úÖ ÿ≠ÿ≥ÿßÿ® ŸÖŸÅÿπŸëŸÑ ŸàŸÜÿ¥ÿ∑';
            if (statusBadgeElem) {
                statusBadgeElem.innerHTML = '<span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #10b981; margin-left: 5px;"></span>ŸÖŸÅÿπŸëŸÑ';
                statusBadgeElem.style.color = '#10b981';
            }
        } else if (userStatus === 'pending') {
            if (statusTextElem) statusTextElem.textContent = '‚è≥ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÅÿπŸäŸÑ';
            if (statusBadgeElem) {
                statusBadgeElem.innerHTML = '<span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #f59e0b; margin-left: 5px;"></span>ŸÖÿπŸÑŸÇ';
                statusBadgeElem.style.color = '#f59e0b';
            }
        } else if (userStatus === 'blocked') {
            if (statusTextElem) statusTextElem.textContent = '‚õî ÿ≠ÿ≥ÿßÿ® ŸÖÿ≠ÿ∏Ÿàÿ±';
            if (statusBadgeElem) {
                statusBadgeElem.innerHTML = '<span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #ef4444; margin-left: 5px;"></span>ŸÖÿ≠ÿ∏Ÿàÿ±';
                statusBadgeElem.style.color = '#ef4444';
            }
        }
        
        console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä ÿßŸÑŸàÿßÿ¨Ÿáÿ©');
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', error);
    }
}

/**
 * ŸÖÿπÿßŸÑÿ¨ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
 */
function handleLogout() {
    const confirmed = confirm('‚ö†Ô∏è ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©.');
    
    if (!confirmed) {
        return;
    }
    
    try {
        // ÿ•ŸäŸÇÿßŸÅ ŸÅÿ≠ÿµ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
        if (activationPollingInterval) {
            clearInterval(activationPollingInterval);
        }
        
        // ÿ≠ÿ∞ŸÅ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ localStorage
        localStorage.removeItem('currentUser');
        localStorage.removeItem('userStatus');
        
        console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠');
        
        // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ©
        showNotification('‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
        
        // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        setTimeout(() => {
            location.reload();
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨:', error);
        alert(`‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ${error.message}`);
    }
}

// ÿ™ÿµÿØŸäÿ± ÿßŸÑÿØŸàÿßŸÑ ÿßŸÑÿ¨ÿØŸäÿØÿ©
window.updateUserDisplayInfo = updateUserDisplayInfo;
window.handleLogout = handleLogout;

// ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿπŸÜÿØ ÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®
const originalShowPage = window.showPage;
if (typeof originalShowPage === 'function') {
    window.showPage = function(pageId) {
        originalShowPage(pageId);
        
        // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿå ÿ≠ÿØŸëÿ´ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™
        if (pageId === 'settings-account') {
            setTimeout(() => {
                updateUserDisplayInfo();
            }, 100);
        }
        
        // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿå ÿ≠ÿØŸëÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
        if (pageId === 'settings-backup') {
            setTimeout(() => {
                updateRegistrationUI();
            }, 100);
        }
        
        // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©ÿå ÿ≠ÿØŸëÿ´ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™
        if (pageId === 'cloudManagement') {
            setTimeout(() => {
                updateCloudManagementSummary();
                updateCloudTabContent('login');
                switchCloudTab('login');
            }, 100);
        }
    };
}

// ============================================================================
// ŸÜŸáÿßŸäÿ© ŸÜÿ∏ÿßŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸàÿßŸÑÿ™ŸÅÿπŸäŸÑ
// ============================================================================


(function() {
    console.log('üîß ÿ™ÿ∑ÿ®ŸäŸÇ ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿµÿßŸÖÿ™ÿ©...');
    // ÿ≠ŸÅÿ∏ ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ©
    const originalPrintInvoiceHtml = window.electronAPI?.printInvoiceHtml;
    if (originalPrintInvoiceHtml) {
        // ÿ™ÿ¨ÿßŸàÿ≤ ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ©
        window.electronAPI.printInvoiceHtml = function(html, options = {}) {
            // ÿ•ÿ¨ÿ®ÿßÿ± silent: true ÿØÿßÿ¶ŸÖÿßŸã
            const forcedOptions = {
                ...options,
                silent: true  // ‚ö° ÿ∑ÿ®ÿßÿπÿ© ÿµÿßŸÖÿ™ÿ© ÿ•ÿ¨ÿ®ÿßÿ±Ÿäÿ©
            };
            console.log('‚úÖ ÿ∑ÿ®ÿßÿπÿ© ÿµÿßŸÖÿ™ÿ© ŸÖŸÅÿπŸëŸÑÿ©:', forcedOptions);
            // ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ© ŸÖÿπ ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿπÿØŸÑÿ©
            return originalPrintInvoiceHtml(html, forcedOptions);
        };
        console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿµÿßŸÖÿ™ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
    } else {
        console.warn('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ electronAPI.printInvoiceHtml');
    }
    // ÿ™ÿ¨ÿßŸàÿ≤ ÿ£Ÿä ÿØŸàÿßŸÑ ÿ∑ÿ®ÿßÿπÿ© ÿ£ÿÆÿ±Ÿâ
    if (window.thermalPrinter?.print) {
        const originalThermalPrint = window.thermalPrinter.print;
        window.thermalPrinter.print = function(html, options = {}) {
            return originalThermalPrint(html, { ...options, silent: true });
        };
    }
    if (window.a4Printer?.print) {
        const originalA4Print = window.a4Printer.print;
        window.a4Printer.print = function(html, options = {}) {
            return originalA4Print(html, { ...options, silent: true });
        };
    }
    // ÿ•ÿ∂ÿßŸÅÿ© ÿØÿßŸÑÿ© ÿπÿßŸÖÿ© ŸÑŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿµÿßŸÖÿ™ÿ©
    window.forceSilentPrint = function(html, options = {}) {
        if (window.electronAPI && window.electronAPI.printInvoiceHtml) {
            window.electronAPI.printInvoiceHtml(html, {
                ...options,
                silent: true,
                printBackground: true
            });
        } else {
            console.error('‚ùå electronAPI ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠');
        }
    };
    console.log('üéâ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿµÿßŸÖÿ™ÿ© ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ!');
})();

// ÿØÿßŸÑÿ© ŸÑŸÖÿ≥ÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑŸÇÿØŸäŸÖÿ© ŸÖŸÜ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
window.clearInvoiceCache = function () {
    if (window.invoiceData) {
        window.invoiceData = null;
    }
    if (window.lastPrintedInvoice) {
        window.lastPrintedInvoice = null;
    }
};

// ÿØÿßŸÑÿ© ÿ∑ÿ®ÿßÿπÿ© ÿ¢ŸÖŸÜÿ© ÿ™ÿ∂ŸÖŸÜ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿØÿßÿ¶ŸÖÿßŸã
window.safePrintInvoice = function (html, options = {}) {
    window.clearInvoiceCache();
    window.forceSilentPrint(html, options);
};
window.testSilentPrint = function() {
    const testHtml = `
<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial;
            padding: 20px;
            text-align: center;
        }
        h1 {
            color: #2196F3;
        }
    </style>
    
    <!-- CSS ŸÑŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© -->
    <style>
    /* ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ */
    .action-buttons {
        display: flex;
        gap: 5px;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .btn-icon {
        padding: 6px 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-icon:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .btn-icon.btn-info {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
    }
    
    .btn-icon.btn-primary {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
    }
    
    .btn-icon.btn-warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
    }
    
    .btn-icon.btn-danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }
    
    .btn-icon.btn-success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }
    
    /* ÿµŸÅŸàŸÅ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ */
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    /* ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑÿØŸäŸÜ */
    #debtProductsContainer {
        margin: 1rem 0;
    }
    
    #debtProductsTable input.form-input {
        width: 100%;
        padding: 8px;
    }
    
    /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ© */
    .modal-content {
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ¨ÿØÿßŸàŸÑ */
    .table th, .table td {
        padding: 12px;
        vertical-align: middle;
    }
    
    /* ÿ≤ÿ± ÿßŸÑÿ∑ÿ®ÿßÿπÿ© */
    .export-btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    
    /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© */
    .stat-card {
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    /* ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ®ŸàŸäÿ® */
    .expense-tab-btn {
        transition: all 0.3s ease;
    }
    
    .expense-tab-btn:hover {
        transform: translateY(-2px);
    }
    
    /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ≠ŸÇŸàŸÑ */
    .form-input:focus, .form-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± */
    .btn {
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn:active {
        transform: translateY(0);
    }
    
    /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™ */
    .card {
        transition: box-shadow 0.3s ease;
    }
    
    .card:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    
    /* Responsive Design */
    @media (max-width: 900px) {
        .a4-grid {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(4, minmax(90px, auto));
            min-width: 0;
            overflow-x: auto;
        }
        .a4-box {
            min-width: 120px;
        }
    }

    @media (max-width: 600px) {
        .a4-grid {
            grid-template-columns: 1fr;
            grid-template-rows: repeat(6, minmax(90px, auto));
            min-width: 0;
            overflow-x: auto;
        }
        .a4-box {
            min-width: 100px;
        }
    }
    </style>
</head>
<body>
    <h1>‚úÖ ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿµÿßŸÖÿ™ÿ©</h1>
    <p>ÿ•ÿ∞ÿß ÿ∏Ÿáÿ±ÿ™ Ÿáÿ∞Ÿá ÿßŸÑÿµŸÅÿ≠ÿ© ÿπŸÑŸâ ÿßŸÑÿ∑ÿßÿ®ÿπÿ© ÿ®ÿØŸàŸÜ ŸÜÿßŸÅÿ∞ÿ© ŸÖÿπÿßŸäŸÜÿ©ÿå ŸÅÿßŸÑÿ•ÿµŸÑÿßÿ≠ ŸäÿπŸÖŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!</p>
    <p>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: ${new Date().toLocaleString('en-US')}</p>
</body>
</html>
    `;
    console.log('üß™ ÿ¨ÿßÿ±Ÿä ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿµÿßŸÖÿ™ÿ©...');
    window.forceSilentPrint(testHtml);
};

console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   üñ®Ô∏è  ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿµÿßŸÖÿ™ÿ© v2.0.1         ‚ïë
‚ïë   ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿ•ÿ®ÿØÿßÿπ ÿßŸÑÿ±ŸÇŸÖŸä - ŸÉÿ±ÿßÿ± ÿßŸÑÿ≥ÿπÿ®ÿ±Ÿä      ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

‚úÖ ÿßŸÑÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™:
  ‚Ä¢ ÿ•ŸÑÿ∫ÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
  ‚Ä¢ ÿ∑ÿ®ÿßÿπÿ© ÿµÿßŸÖÿ™ÿ© ÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© ÿπŸÜÿØ ÿßŸÑÿØŸÅÿπ
  ‚Ä¢ ÿØÿπŸÖ ÿ¨ŸÖŸäÿπ ÿ£ŸÜŸàÿßÿπ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±

üìù ÿßŸÑÿ£ŸàÿßŸÖÿ± ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© ŸÅŸä Console:
  ‚Ä¢ testSilentPrint()      - ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
  ‚Ä¢ forceSilentPrint(html) - ÿ∑ÿ®ÿßÿπÿ© ÿµÿßŸÖÿ™ÿ© ÿ•ÿ¨ÿ®ÿßÿ±Ÿäÿ©

üîß ŸÑŸÑÿØÿπŸÖ: info@digital-creativity.iq
`);
</script>
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ŸÜÿ∏ÿßŸÖ ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ ÿßŸÑŸÖÿ™ŸÉÿßŸÖŸÑ</title>
  <!-- SheetJS for Excel support -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<!-- jsPDF for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  
 <!-- ‚úÖ ÿßÿ≥ÿ™ÿÆÿØŸÖ Ÿáÿ∞ÿß -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="./firebase-config.js"></script>
<script src="./firebase-config-fixed.js"></script>


  <!-- Firebase Initialization Check - ŸÜÿ≥ÿÆÿ© ŸÖÿ≠ÿ≥ŸëŸÜÿ© ÿ£ŸÉÿ´ÿ± ÿµÿ®ÿ±ÿßŸã -->
  <script>
(function() {
    'use strict';
    
    console.log('üîç ŸÅÿ≠ÿµ ÿ™ŸáŸäÿ¶ÿ© Firebase...');
    
    // Ÿàÿ∏ŸäŸÅÿ© ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜÿ©
    function checkFirebaseInit() {
        return new Promise((resolve, reject) => {
            let attempts = 0;
            const maxAttempts = 50; // ÿ≤ŸäÿßÿØÿ© ÿ•ŸÑŸâ 50 ŸÖÿ≠ÿßŸàŸÑÿ© = 10 ÿ´ŸàÿßŸÜŸç
            
            const checkInterval = setInterval(() => {
                attempts++;
                
                // ŸÅÿ≠ÿµ Firebase
                if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                    // ŸÅÿ≠ÿµ database
                    if (window.database && typeof window.database.ref === 'function') {
                        clearInterval(checkInterval);
                        console.log('‚úÖ Firebase ÿ¨ÿßŸáÿ≤ Ÿàÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ™Ÿá ÿ®ŸÜÿ¨ÿßÿ≠');
                        console.log('üìä Firebase Apps:', firebase.apps.length);
                        console.log('üîó Database ŸÖÿ™ÿµŸÑ:', !!window.database);
                        resolve(true);
                        return;
                    }
                    
                    // ÿ•ÿ∞ÿß Firebase ŸÖŸàÿ¨ŸàÿØ ŸÑŸÉŸÜ database ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸëŸÅ
                    if (!window.database) {
                        try {
                            window.database = firebase.database();
                            console.log('‚úÖ ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ŸáŸäÿ¶ÿ© database ÿ®ŸÜÿ¨ÿßÿ≠');
                        } catch (error) {
                            console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© database:', error);
                        }
                    }
                }
                
                // ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ™ŸÇÿØŸÖ ŸÉŸÑ 10 ŸÖÿ≠ÿßŸàŸÑÿßÿ™
                if (attempts % 10 === 0 && attempts < maxAttempts) {
                    console.log(`‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±... (ŸÖÿ≠ÿßŸàŸÑÿ© ${attempts}/${maxAttempts})`);
                }
                
                // ÿ•ÿ∞ÿß ŸàÿµŸÑŸÜÿß ŸÑŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™
                if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    console.warn('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© Firebase ÿÆŸÑÿßŸÑ ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ™ŸàŸÇÿπ');
                    console.log('‚ÑπÔ∏è ÿ≥Ÿäÿ≠ÿßŸàŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿπŸÜÿØ ÿßŸÑÿ≠ÿßÿ¨ÿ©');
                    // ŸÜÿ≠ŸÑŸëŸáÿß ÿ®ÿØŸàŸÜ reject ŸÑŸÉŸä ŸÑÿß ÿ™ÿ∏Ÿáÿ± ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÖÿ≤ÿπÿ¨ÿ©
                    resolve(false); // ‚úÖ ÿ™ÿ∫ŸäŸäÿ± ŸÖŸÜ reject ÿ•ŸÑŸâ resolve(false)
                }
            }, 200); // ŸÅÿ≠ÿµ ŸÉŸÑ 200ms
        });
    }
    
    // ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑŸÅÿ≠ÿµ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            const isReady = await checkFirebaseInit();
            
            if (isReady) {
                console.log('üéâ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ');
            } else {
                console.log('‚ö†Ô∏è Firebase ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ™Ÿá ÿ®ÿπÿØÿå ÿ≥Ÿäÿ™ŸÖ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ÿπŸÜÿØ ÿßŸÑÿ≠ÿßÿ¨ÿ©');
                // ŸÑÿß ÿ™ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿå ŸÅŸÇÿ∑ ÿ≥ÿ¨ŸÑ ŸÅŸä Console
            }
            
        } catch (error) {
            // Ÿáÿ∞ÿß ŸÑŸÜ Ÿäÿ≠ÿØÿ´ ÿßŸÑÿ¢ŸÜ ŸÑÿ£ŸÜŸÜÿß ŸÜÿ≥ÿ™ÿÆÿØŸÖ resolve ÿ®ÿØŸÑÿßŸã ŸÖŸÜ reject
            console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© Firebase:', error);
        }
    });
    
    // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿßÿπÿØ ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Firebase ŸÅŸä ÿ£Ÿä ŸàŸÇÿ™
    window.checkFirebaseConnection = async function() {
        if (!window.database) {
            console.error('‚ùå database ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸëŸÅ');
            return false;
        }
        
        try {
            // ŸÖÿ≠ÿßŸàŸÑÿ© ŸÇÿ±ÿßÿ°ÿ© ÿ®ÿ≥Ÿäÿ∑ÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ
            await database.ref('.info/connected').once('value');
            console.log('‚úÖ Firebase ŸÖÿ™ÿµŸÑ');
            return true;
        } catch (error) {
            console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ:', error);
            return false;
        }
    };
    
    // ÿØÿßŸÑÿ© ŸÑÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸäÿØŸàŸäÿßŸã
    window.retryFirebaseInit = async function() {
        console.log('üîÑ ÿ•ÿπÿßÿØÿ© ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ŸáŸäÿ¶ÿ© Firebase...');
        
        try {
            if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                if (!window.database) {
                    window.database = firebase.database();
                    console.log('‚úÖ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© Database');
                }
                
                if (!window.firestore) {
                    window.firestore = firebase.firestore();
                    console.log('‚úÖ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© Firestore');
                }
                
                console.log('‚úÖ ÿ™ŸÖÿ™ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ŸáŸäÿ¶ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                return true;
            } else {
                console.error('‚ùå Firebase SDK ÿ∫Ÿäÿ± ŸÖÿ≠ŸÖŸëŸÑ');
                return false;
            }
        } catch (error) {
            console.error('‚ùå ŸÅÿ¥ŸÑ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ŸáŸäÿ¶ÿ©:', error);
            return false;
        }
    };
    
    console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ Firebase Initialization Check');
})();
  </script>
  
  <script src="./_sdk/data_sdk.js"></script>
  <script src="./_sdk/element_sdk.js"></script>
  
  <!-- System Reset SDK - ŸÜÿ∏ÿßŸÖ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ¥ÿßŸÖŸÑ -->
  <script>
/**
 * System Reset SDK - ŸÜÿ∏ÿßŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ
 * Ÿäÿ≠ŸÑ ŸÖÿ¥ŸÉŸÑÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ÿπŸÜÿØ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ´ÿ®Ÿäÿ™
 * Digital Creativity Company - ÿßŸÑŸÖÿ∑Ÿàÿ±: ŸÉÿ±ÿßÿ±
 */
(function() {
    'use strict';
    const RESET_KEY = 'app_reset_token';
    const VERSION_KEY = 'app_version';
    const CURRENT_VERSION = '1.0.0';
    class SystemReset {
        constructor() { this.resetInProgress = false; }
        async validateStoredData() {
            try {
                const uid = localStorage.getItem('app_uid');
                const secret = localStorage.getItem('app_secret');
                const version = localStorage.getItem(VERSION_KEY);
                if (version !== CURRENT_VERSION) {
                    console.log('‚ö†Ô∏è ÿ•ÿµÿØÿßÿ± ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ™ÿ∫Ÿäÿ±ÿå Ÿäÿ≠ÿ™ÿßÿ¨ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ');
                    return { isValid: false, reason: 'version_mismatch', message: 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇÿå Ÿäÿ¨ÿ® ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ŸáŸäÿ¶ÿ©' };
                }
                if (uid && secret) {
                    try {
                        if (typeof database !== 'undefined') {
                            const snap = await database.ref(`users/${uid}`).once('value');
                            if (!snap.exists()) {
                                console.log('‚ö†Ô∏è ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä Firebase');
                                return { isValid: false, reason: 'user_not_found', message: 'ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™' };
                            }
                            const userData = snap.val();
                            if (userData.profile && userData.profile.secret !== secret) {
                                console.log('‚ö†Ô∏è Secret Key ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠');
                                return { isValid: false, reason: 'invalid_secret', message: 'ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©' };
                            }
                            console.log('‚úÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ÿµÿßŸÑÿ≠ÿ©');
                            return { isValid: true };
                        }
                    } catch (error) {
                        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Firebase:', error);
                        return { isValid: false, reason: 'firebase_error', message: 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™' };
                    }
                }
                return { isValid: false, reason: 'no_data', message: 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ©' };
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                return { isValid: false, reason: 'validation_error', message: error.message };
            }
        }
        async clearAllLocalData(keepVersion = false) {
            if (this.resetInProgress) {
                console.log('‚ö†Ô∏è ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ ŸÇŸäÿØ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞ ÿ®ÿßŸÑŸÅÿπŸÑ');
                return { success: false, error: 'reset_in_progress' };
            }
            this.resetInProgress = true;
            const cleared = [];
            try {
                console.log('üîÑ ÿ®ÿØÿ° ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©...');
                try {
                    const keysToKeep = keepVersion ? [VERSION_KEY] : [];
                    const savedData = {};
                    keysToKeep.forEach(key => {
                        const value = localStorage.getItem(key);
                        if (value) savedData[key] = value;
                    });
                    localStorage.clear();
                    keysToKeep.forEach(key => {
                        if (savedData[key]) localStorage.setItem(key, savedData[key]);
                    });
                    cleared.push('localStorage');
                    console.log('‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ localStorage');
                } catch (error) { console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿ≥ÿ≠ localStorage:', error); }
                try {
                    const databases = await indexedDB.databases();
                    for (const db of databases) {
                        await new Promise((resolve, reject) => {
                            const request = indexedDB.deleteDatabase(db.name);
                            request.onsuccess = () => { console.log(`‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ${db.name}`); resolve(); };
                            request.onerror = () => reject(request.error);
                            request.onblocked = () => { console.warn(`‚ö†Ô∏è ŸÖÿ≥ÿ≠ ${db.name} ŸÖÿ≠ÿ∏Ÿàÿ±`); resolve(); };
                        });
                    }
                    cleared.push('IndexedDB');
                    console.log('‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ IndexedDB');
                } catch (error) { console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿ≥ÿ≠ IndexedDB:', error); }
                try {
                    sessionStorage.clear();
                    cleared.push('sessionStorage');
                    console.log('‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ sessionStorage');
                } catch (error) { console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿ≥ÿ≠ sessionStorage:', error); }
                try {
                    if ('caches' in window) {
                        const cacheNames = await caches.keys();
                        await Promise.all(cacheNames.map(cacheName => caches.delete(cacheName)));
                        cleared.push('caches');
                        console.log('‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ Cache Storage');
                    }
                } catch (error) { console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿ≥ÿ≠ Cache:', error); }
                try {
                    if (window.elementSdk && typeof window.elementSdk.clearConfig === 'function') {
                        await window.elementSdk.clearConfig();
                        cleared.push('elementSdk');
                        console.log('‚úÖ ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ Element SDK');
                    }
                    if (window.dataSdk && typeof window.dataSdk.clearAllData === 'function') {
                        await window.dataSdk.clearAllData();
                        cleared.push('dataSdk');
                        console.log('‚úÖ ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ Data SDK');
                    }
                } catch (error) { console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ SDKs:', error); }
                console.log('‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                console.log('üìä ÿßŸÑÿπŸÜÿßÿµÿ± ÿßŸÑÿ™Ÿä ÿ™ŸÖ ŸÖÿ≥ÿ≠Ÿáÿß:', cleared);
                return { success: true, cleared };
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                return { success: false, error: error.message };
            } finally { this.resetInProgress = false; }
        }
        async fullReset(reloadPage = true) {
            try {
                console.log('üîÑ ÿ®ÿØÿ° ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÉÿßŸÖŸÑÿ©...');
                const result = await this.clearAllLocalData(false);
                if (!result.success) throw new Error('ŸÅÿ¥ŸÑ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                localStorage.setItem(VERSION_KEY, CURRENT_VERSION);
                console.log('‚úÖ ÿ™ŸÖÿ™ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÉÿßŸÖŸÑÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                if (reloadPage) {
                    console.log('üîÑ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ...');
                    setTimeout(() => { window.location.reload(); }, 500);
                }
                return { success: true, message: 'ÿ™ŸÖÿ™ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ ÿ®ŸÜÿ¨ÿßÿ≠' };
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÉÿßŸÖŸÑÿ©:', error);
                return { success: false, error: error.message };
            }
        }
        async softReset() {
            try {
                console.log('üîÑ ÿ®ÿØÿ° ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ ÿßŸÑÿÆŸÅŸäŸÅÿ©...');
                const settingsToKeep = {
                    theme: localStorage.getItem('currentTheme'),
                    language: localStorage.getItem('app_language'),
                    storeSettings: localStorage.getItem('storeSettings'),
                    systemSettings: localStorage.getItem('systemSettings')
                };
                await this.clearAllLocalData(true);
                Object.keys(settingsToKeep).forEach(key => {
                    if (settingsToKeep[key]) localStorage.setItem(key, settingsToKeep[key]);
                });
                console.log('‚úÖ ÿ™ŸÖÿ™ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ ÿßŸÑÿÆŸÅŸäŸÅÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                return { success: true, message: 'ÿ™ŸÖÿ™ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ ŸÖÿπ ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™' };
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ ÿßŸÑÿÆŸÅŸäŸÅÿ©:', error);
                return { success: false, error: error.message };
            }
        }
        async autoCheck() {
            try {
                console.log('üîç ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
                const savedVersion = localStorage.getItem(VERSION_KEY);
                if (!savedVersion) {
                    localStorage.setItem(VERSION_KEY, CURRENT_VERSION);
                    console.log('‚úÖ ÿ£ŸàŸÑ ÿ™ÿ¥ÿ∫ŸäŸÑ - ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿµÿØÿßÿ±');
                    return { needsReset: false, reason: 'first_run' };
                }
                if (savedVersion !== CURRENT_VERSION) {
                    console.log('‚ö†Ô∏è ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ•ÿµÿØÿßÿ± ŸÖÿÆÿ™ŸÑŸÅ');
                    return { needsReset: true, reason: 'version_changed' };
                }
                const validation = await this.validateStoredData();
                if (!validation.isValid && validation.reason !== 'no_data') {
                    console.log('‚ö†Ô∏è ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©');
                    return { needsReset: true, reason: validation.reason, validation };
                }
                console.log('‚úÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿßŸÉÿ™ŸÖŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
                return { needsReset: false, validation };
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä:', error);
                return { needsReset: false, error: error.message };
            }
        }
        async exportBackup(type = 'full') {
            try {
                const backup = {
                    timestamp: Date.now(),
                    date: new Date().toISOString(),
                    version: CURRENT_VERSION,
                    localStorage: {},
                    indexedDB: {},
                    elementConfig: null
                };
                // Always export localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    backup.localStorage[key] = localStorage.getItem(key);
                }
                // Export elementSdk config
                if (window.elementSdk && typeof window.elementSdk.getConfig === 'function') {
                    backup.elementConfig = window.elementSdk.getConfig();
                }
                // Export IndexedDB data
                if (window.dataSdk && typeof window.dataSdk.getAll === 'function') {
                    const allData = window.dataSdk.getAll();
                    if (type === 'full') {
                        backup.indexedDB.all = allData;
                    } else if (type === 'selective') {
                        // Only products, invoices, debts, payments
                        backup.indexedDB.products = allData.filter(item => item.type === 'product');
                        backup.indexedDB.invoices = allData.filter(item => item.type === 'invoice');
                        backup.indexedDB.debts = allData.filter(item => item.type === 'debt');
                        backup.indexedDB.payments = allData.filter(item => item.type === 'payment');
                    }
                }
                const dataStr = JSON.stringify(backup, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `app-backup-${type}-${Date.now()}.json`;
                link.click();
                URL.revokeObjectURL(url);
                console.log('‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©');
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©:', error);
                throw error;
            }
        }
    }
    window.systemReset = new SystemReset();
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            const checkResult = await window.systemReset.autoCheck();
            if (checkResult.needsReset) {
                console.log('‚ö†Ô∏è Ÿäÿ≠ÿ™ÿßÿ¨ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ•ŸÑŸâ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ:', checkResult.reason);
                const shouldReset = confirm(`ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©.\n\nÿßŸÑÿ≥ÿ®ÿ®: ${checkResult.validation?.message || checkResult.reason}\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇÿü`);
                if (shouldReset) await window.systemReset.fullReset(true);
            }
        } catch (error) { console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä:', error); }
    });
    console.log('‚úÖ System Reset SDK ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑŸá ÿ®ŸÜÿ¨ÿßÿ≠');
})();
  </script>
  
  <!-- Authentication Fix SDK - ÿ•ÿµŸÑÿßÿ≠ ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿµÿßÿØŸÇÿ© -->
  <script>
/**
 * Authentication Fix - ÿ•ÿµŸÑÿßÿ≠ ŸÖÿ¥ŸÉŸÑÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™
 * Digital Creativity Company - ÿßŸÑŸÖÿ∑Ÿàÿ±: ŸÉÿ±ÿßÿ±
 */
(function() {
    'use strict';
    class AuthFix {
        constructor() { this.registrationAttempts = 0; this.maxAttempts = 3; }
        async checkCurrentAccount() {
            try {
                const uid = localStorage.getItem('app_uid');
                const secret = localStorage.getItem('app_secret');
                if (!uid || !secret) {
                    console.log('‚ÑπÔ∏è ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≠ÿ≥ÿßÿ® ŸÖÿ≠ŸÅŸàÿ∏');
                    return { hasAccount: false, isValid: false };
                }
                if (typeof database !== 'undefined') {
                    try {
                        const snap = await database.ref(`users/${uid}`).once('value');
                        if (!snap.exists()) {
                            console.log('‚ö†Ô∏è ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä Firebase');
                            return { hasAccount: true, isValid: false, uid, reason: 'not_found_in_firebase' };
                        }
                        const userData = snap.val();
                        if (userData.profile && userData.profile.secret !== secret) {
                            console.log('‚ö†Ô∏è Secret Key ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠');
                            return { hasAccount: true, isValid: false, uid, reason: 'invalid_secret' };
                        }
                        console.log('‚úÖ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿµÿßŸÑÿ≠');
                        return { hasAccount: true, isValid: true, uid, userData };
                    } catch (error) {
                        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Firebase:', error);
                        return { hasAccount: true, isValid: false, uid, reason: 'firebase_error', error: error.message };
                    }
                }
                return { hasAccount: true, isValid: false, uid };
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿ≥ÿßÿ®:', error);
                return { hasAccount: false, isValid: false, error: error.message };
            }
        }
        async clearInvalidAccount() {
            try {
                console.log('üîÑ ŸÖÿ≥ÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ∫Ÿäÿ± ÿßŸÑÿµÿßŸÑÿ≠...');
                localStorage.removeItem('app_uid');
                localStorage.removeItem('app_secret');
                localStorage.removeItem('user_id');
                if (window.currentUser) window.currentUser = null;
                console.log('‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ∫Ÿäÿ± ÿßŸÑÿµÿßŸÑÿ≠');
                return true;
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿ≥ÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ®:', error);
                return false;
            }
        }
        async createNewAccount(userData) {
            try {
                const { fullName, phone, address, storeName, lat, lng } = userData;
                if (!fullName || !phone || !address || !storeName) {
                    return { success: false, error: 'missing_data', message: 'Ÿäÿ±ÿ¨Ÿâ ÿ™ÿπÿ®ÿ¶ÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©' };
                }
                const accountCheck = await this.checkCurrentAccount();
                if (accountCheck.hasAccount && accountCheck.isValid) {
                    return { success: false, error: 'account_exists', message: 'ŸäŸàÿ¨ÿØ ÿ≠ÿ≥ÿßÿ® ÿµÿßŸÑÿ≠ ÿ®ÿßŸÑŸÅÿπŸÑ' };
                }
                if (accountCheck.hasAccount && !accountCheck.isValid) {
                    console.log('‚ö†Ô∏è ÿ≠ÿ≥ÿßÿ® ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ ŸÖŸàÿ¨ŸàÿØÿå ÿ≥Ÿäÿ™ŸÖ ŸÖÿ≥ÿ≠Ÿá');
                    await this.clearInvalidAccount();
                }
                console.log('üîÑ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ...');
                if (typeof database === 'undefined') {
                    return { success: false, error: 'firebase_not_ready', message: 'ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿ¨ÿßŸáÿ≤ÿ©' };
                }
                const newUserRef = database.ref('users').push();
                const uid = newUserRef.key;
                const secret = this.generateRandomKey(10);
                const appSettingsSnap = await database.ref('appSettings/trialDays').once('value');
                const trialDays = appSettingsSnap.exists() ? Number(appSettingsSnap.val()) : 30;
                const createdAt = Date.now();
                const trialUntil = createdAt + (trialDays * 24 * 60 * 60 * 1000);
                const userObj = {
                    profile: {
                        uid, secret, fullName, phone, address, storeName,
                        lat: lat || null, lng: lng || null, createdAt,
                        deviceInfo: {
                            platform: navigator.platform || '',
                            userAgent: navigator.userAgent || '',
                            appVersion: localStorage.getItem('app_version') || '1.0.0'
                        }
                    },
                    trialUntil, subscription: null, status: 'active', createdBy: 'web_app'
                };
                await database.ref(`users/${uid}`).set(userObj);
                localStorage.setItem('app_uid', uid);
                localStorage.setItem('app_secret', secret);
                if (typeof window !== 'undefined') {
                    window.currentUser = userObj;
                    window.currentUser.uid = uid;
                }
                console.log('‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ®ŸÜÿ¨ÿßÿ≠');
                console.log('üìù UID:', uid);
                return { success: true, uid, secret, trialDays, userData: userObj, message: 'ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ®ŸÜÿ¨ÿßÿ≠' };
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ®:', error);
                this.registrationAttempts++;
                return { success: false, error: 'creation_failed', message: error.message, attempts: this.registrationAttempts };
            }
        }
        async attemptRegistrationFix() {
            try {
                console.log('üîß ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ÿµŸÑÿßÿ≠ ŸÖÿ¥ŸÉŸÑÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ...');
                const accountCheck = await this.checkCurrentAccount();
                console.log('üìä ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®:', accountCheck);
                if (accountCheck.hasAccount && !accountCheck.isValid) {
                    console.log('üîÑ ŸÖÿ≥ÿ≠ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ∫Ÿäÿ± ÿßŸÑÿµÿßŸÑÿ≠...');
                    await this.clearInvalidAccount();
                    return { success: true, action: 'cleared_invalid_account', message: 'ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ∫Ÿäÿ± ÿßŸÑÿµÿßŸÑÿ≠ÿå ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ' };
                }
                if (accountCheck.hasAccount && accountCheck.isValid) {
                    return { success: true, action: 'account_valid', message: 'ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≠ÿßŸÑŸä ÿµÿßŸÑÿ≠', userData: accountCheck.userData };
                }
                return { success: true, action: 'ready_for_registration', message: 'ÿ¨ÿßŸáÿ≤ ŸÑÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ' };
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ:', error);
                return { success: false, error: error.message };
            }
        }
        generateRandomKey(length = 10) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        async canRegister() {
            try {
                const accountCheck = await this.checkCurrentAccount();
                if (accountCheck.hasAccount && accountCheck.isValid) {
                    return { canRegister: false, reason: 'valid_account_exists', message: 'ŸäŸàÿ¨ÿØ ÿ≠ÿ≥ÿßÿ® ÿµÿßŸÑÿ≠ ÿ®ÿßŸÑŸÅÿπŸÑ' };
                }
                if (accountCheck.hasAccount && !accountCheck.isValid) {
                    await this.clearInvalidAccount();
                }
                return { canRegister: true, message: 'ŸäŸÖŸÉŸÜŸÉ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ' };
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ•ŸÖŸÉÿßŸÜŸäÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ:', error);
                return { canRegister: false, reason: 'check_failed', message: error.message };
            }
        }
    }
    window.authFix = new AuthFix();
    window.createUserAccount_original = window.createUserAccount;
    window.createUserAccount = async function(formData) {
        try {
            console.log('üîê ÿßÿ≥ÿ™ÿØÿπÿßÿ° createUserAccount ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜ...');
            const canRegisterCheck = await window.authFix.canRegister();
            if (!canRegisterCheck.canRegister) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            const result = await window.authFix.createNewAccount(formData);
            if (result.success) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                if (typeof showModal === 'function' && typeof document !== 'undefined') {
                    const form = document.getElementById('userDetailsForm');
                    if (form) form.style.display = 'none';
                    showModal('userInfoModal');
                    const uidElem = document.getElementById('userUID');
                    const secretElem = document.getElementById('userSecret');
                    const trialElem = document.getElementById('trialDaysDisplay');
                    if (uidElem) uidElem.textContent = result.uid;
                    if (secretElem) secretElem.textContent = result.secret;
                    if (trialElem) trialElem.textContent = result.trialDays;
                }
                return result;
            } else {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                if (result.attempts >= 2) {
                    console.log('üîß ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑŸÖÿ¥ŸÉŸÑÿ©...');
                    const fixResult = await window.authFix.attemptRegistrationFix();
                    if (fixResult.success && fixResult.action === 'cleared_invalid_account') {
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    }
                }
                return result;
            }
        } catch (error) {
            console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä createUserAccount:', error);
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            return { success: false, error: error.message };
        }
    };
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            console.log('üîç ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿµÿßÿØŸÇÿ©...');
            const accountCheck = await window.authFix.checkCurrentAccount();
            if (accountCheck.hasAccount && !accountCheck.isValid) {
                console.log('‚ö†Ô∏è ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ≠ÿ≥ÿßÿ® ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠');
                const shouldClear = confirm('ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿßÿ® ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©.\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÖÿ≥ÿ≠ Ÿáÿ∞Ÿá ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑÿ™ÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØÿü');
                if (shouldClear) {
                    await window.authFix.clearInvalidAccount();
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                }
            }
        } catch (error) { console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖÿµÿßÿØŸÇÿ©:', error); }
    });
    console.log('‚úÖ Authentication Fix ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑŸá ÿ®ŸÜÿ¨ÿßÿ≠');
})();
  </script>
  
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <!-- ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ CSS ŸÑŸÑŸÜŸàÿßŸÅÿ∞ ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ© -->
<link rel="stylesheet" href="./enhanced-modals.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet"><!-- Animate.css -->

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <!-- SheetJS for Excel support -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
        :root {
            /* ÿ£ÿ≠ÿ¨ÿßŸÖ ÿßŸÑÿÆÿ∑Ÿàÿ∑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© */
            --font-size-xs: 13px;
            --font-size-sm: 15px;
            --font-size-base: 16px;
            --font-size-md: 18px;
            --font-size-lg: 20px;
            --font-size-xl: 24px;
            --font-size-2xl: 28px;
            --font-size-3xl: 32px;
            
            /* ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© - ŸÖÿ≠ÿ≥ŸëŸÜÿ© */
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --accent-color: #ec4899;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            
            /* ÿßŸÑÿÆŸÑŸÅŸäÿßÿ™ - ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿØÿßŸÉŸÜ */
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-card: #1a1a1a;
            --bg-hover: #252525;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            
            /* ÿßŸÑŸÜÿµŸàÿµ - ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿØÿßŸÉŸÜ */
            --text-primary: #e8e8e8;
            --text-secondary: #b8b8b8;
            --text-tertiary: #8a8a8a;
            --text-dark: #1e293b;
            --text-muted: #6a6a6a;
            
            /* ÿßŸÑÿ≠ÿØŸàÿØ */
            --border-color: #2a2a2a;
            --border-light: #e2e8f0;
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --border-radius-lg: 24px;
            
            /* ÿßŸÑÿ™ÿØÿ±ÿ¨ÿßÿ™ - ŸÖÿ≠ÿ≥ŸëŸÜÿ© */
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --secondary-gradient: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            
            /* ÿßŸÑÿ∏ŸÑÿßŸÑ - ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿØÿßŸÉŸÜ */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.5);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.6);
            --shadow-lg: 0 8px 25px rgba(0,0,0,0.7);
            --shadow-xl: 0 20px 40px rgba(0,0,0,0.8);
            --shadow-colored: 0 10px 40px -10px rgba(99, 102, 241, 0.5);
            
            /* ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÑŸÑÿ´ŸäŸÖ ÿßŸÑÿØÿßŸÉŸÜ */
            --theme-bg-primary: var(--bg-primary);
            --theme-bg-secondary: var(--bg-secondary);
            --theme-bg-card: var(--bg-card);
            --theme-bg-hover: var(--bg-hover);
            --theme-text-primary: var(--text-primary);
            --theme-text-secondary: var(--text-secondary);
            --theme-text-tertiary: var(--text-tertiary);
            --theme-border: var(--border-color);
            --theme-shadow: var(--shadow-md);
        }

        /* ÿßŸÑÿ´ŸäŸÖ ÿßŸÑŸÅÿßÿ™ÿ≠ - ŸÖÿ≠ÿ≥ŸëŸÜ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ */
        [data-theme="light"] {
            /* ÿßŸÑÿÆŸÑŸÅŸäÿßÿ™ - ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÅÿßÿ™ÿ≠ */
            --theme-bg-primary: #f5f5f0;
            --theme-bg-secondary: #fafaf8;
            --theme-bg-card: #ffffff;
            --theme-bg-hover: #ececea;
            
            /* ÿßŸÑŸÜÿµŸàÿµ - ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÅÿßÿ™ÿ≠ - ÿ£ÿ∫ŸÖŸÇ Ÿàÿ£Ÿàÿ∂ÿ≠ */
            --theme-text-primary: #000000;
            --theme-text-secondary: #1a1a1a;
            --theme-text-tertiary: #333333;
            
            /* ÿßŸÑÿ≠ÿØŸàÿØ */
            --theme-border: #d8d8d8;
            
            /* ÿßŸÑÿ∏ŸÑÿßŸÑ - ŸÖÿ≠ÿ≥ŸëŸÜÿ© ŸÑŸÑŸàÿ∂ÿπ ÿßŸÑŸÅÿßÿ™ÿ≠ */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.12);
            --shadow-colored: 0 10px 40px -10px rgba(99, 102, 241, 0.25);
            --theme-shadow: var(--shadow-md);
            
            /* ÿ£ŸÑŸàÿßŸÜ ŸÖÿÆÿµÿµÿ© ŸÑŸÑŸàÿ∂ÿπ ÿßŸÑŸÅÿßÿ™ÿ≠ */
            --light-accent: #eef2ff;
            --light-success: #ecfdf5;
            --light-warning: #fffbeb;
            --light-danger: #fef2f2;
            --light-info: #eff6ff;
        }

        /* üîµ ÿ´ŸäŸÖ ÿ£ÿ≤ÿ±ŸÇ ÿØÿßŸÉŸÜ - Blue Dark */
        [data-theme="blue-dark"] {
            --theme-bg-primary: #0a1628;
            --theme-bg-secondary: #0f1c30;
            --theme-bg-card: #152238;
            --theme-bg-hover: #1a2945;
            
            --theme-text-primary: #e1f0ff;
            --theme-text-secondary: #a8c5e0;
            --theme-text-tertiary: #7a9ec2;
            
            --theme-border: #1e3a5f;
            --shadow-colored: 0 10px 40px -10px rgba(59, 130, 246, 0.5);
            --theme-shadow: 0 4px 12px rgba(0,0,0,0.6);
            
            --primary-color: #3b82f6;
            --secondary-color: #2563eb;
        }

        /* üíö ÿ´ŸäŸÖ ÿ£ÿÆÿ∂ÿ± ÿØÿßŸÉŸÜ - Green Dark */
        [data-theme="green-dark"] {
            --theme-bg-primary: #0a1f0f;
            --theme-bg-secondary: #0e2817;
            --theme-bg-card: #14321f;
            --theme-bg-hover: #1a4028;
            
            --theme-text-primary: #d1fae5;
            --theme-text-secondary: #a7d9c0;
            --theme-text-tertiary: #7db89a;
            
            --theme-border: #1e5438;
            --shadow-colored: 0 10px 40px -10px rgba(16, 185, 129, 0.5);
            --theme-shadow: 0 4px 12px rgba(0,0,0,0.6);
            
            --primary-color: #10b981;
            --secondary-color: #059669;
        }

        /* üß° ÿ´ŸäŸÖ ÿ®ÿ±ÿ™ŸÇÿßŸÑŸä ÿØÿßŸÉŸÜ - Orange Dark */
        [data-theme="orange-dark"] {
            --theme-bg-primary: #1f1208;
            --theme-bg-secondary: #2a1810;
            --theme-bg-card: #351e18;
            --theme-bg-hover: #402520;
            
            --theme-text-primary: #ffe4d1;
            --theme-text-secondary: #d9b8a7;
            --theme-text-tertiary: #b3927d;
            
            --theme-border: #543428;
            --shadow-colored: 0 10px 40px -10px rgba(249, 115, 22, 0.5);
            --theme-shadow: 0 4px 12px rgba(0,0,0,0.6);
            
            --primary-color: #f97316;
            --secondary-color: #ea580c;
        }

        /* üíú ÿ´ŸäŸÖ ÿ®ŸÜŸÅÿ≥ÿ¨Ÿä ÿØÿßŸÉŸÜ - Purple Dark */
        [data-theme="purple-dark"] {
            --theme-bg-primary: #1a0a28;
            --theme-bg-secondary: #240f35;
            --theme-bg-card: #2e1542;
            --theme-bg-hover: #381a50;
            
            --theme-text-primary: #f0d1ff;
            --theme-text-secondary: #c9a8e0;
            --theme-text-tertiary: #a37dc2;
            
            --theme-border: #4a2563;
            --shadow-colored: 0 10px 40px -10px rgba(168, 85, 247, 0.5);
            --theme-shadow: 0 4px 12px rgba(0,0,0,0.6);
            
            --primary-color: #a855f7;
            --secondary-color: #9333ea;
        }

        /* ‚ù§Ô∏è ÿ´ŸäŸÖ ÿ£ÿ≠ŸÖÿ± ÿØÿßŸÉŸÜ - Red Dark */
        [data-theme="red-dark"] {
            --theme-bg-primary: #280a0a;
            --theme-bg-secondary: #350f0f;
            --theme-bg-card: #421515;
            --theme-bg-hover: #501a1a;
            
            --theme-text-primary: #ffd1d1;
            --theme-text-secondary: #e0a8a8;
            --theme-text-tertiary: #c27d7d;
            
            --theme-border: #632525;
            --shadow-colored: 0 10px 40px -10px rgba(239, 68, 68, 0.5);
            --theme-shadow: 0 4px 12px rgba(0,0,0,0.6);
            
            --primary-color: #ef4444;
            --secondary-color: #dc2626;
        }

        /* ü©µ ÿ´ŸäŸÖ ÿ≥ŸÖÿßŸàŸä ŸÅÿßÿ™ÿ≠ - Cyan Light */
        [data-theme="cyan-light"] {
            --theme-bg-primary: #e0f7fa;
            --theme-bg-secondary: #f0fbfc;
            --theme-bg-card: #ffffff;
            --theme-bg-hover: #d0f3f7;
            
            --theme-text-primary: #0e2933;
            --theme-text-secondary: #1a4d5f;
            --theme-text-tertiary: #26718b;
            
            --theme-border: #b0dce5;
            --shadow-colored: 0 10px 40px -10px rgba(6, 182, 212, 0.3);
            --theme-shadow: 0 4px 12px rgba(0,0,0,0.08);
            
            --primary-color: #06b6d4;
            --secondary-color: #0891b2;
        }

        /* üü° ÿ´ŸäŸÖ ÿ∞Ÿáÿ®Ÿä ŸÅÿßÿ™ÿ≠ - Gold Light */
        [data-theme="gold-light"] {
            --theme-bg-primary: #fffbea;
            --theme-bg-secondary: #fffef5;
            --theme-bg-card: #ffffff;
            --theme-bg-hover: #fff8d6;
            
            --theme-text-primary: #2a2008;
            --theme-text-secondary: #4d3810;
            --theme-text-tertiary: #705018;
            
            --theme-border: #e8d89b;
            --shadow-colored: 0 10px 40px -10px rgba(245, 158, 11, 0.3);
            --theme-shadow: 0 4px 12px rgba(0,0,0,0.08);
            
            --primary-color: #f59e0b;
            --secondary-color: #d97706;
        }

        /* üå∏ ÿ´ŸäŸÖ Ÿàÿ±ÿØŸä ŸÅÿßÿ™ÿ≠ - Pink Light */
        [data-theme="pink-light"] {
            --theme-bg-primary: #fce7f3;
            --theme-bg-secondary: #fef1f7;
            --theme-bg-card: #ffffff;
            --theme-bg-hover: #fad1e8;
            
            --theme-text-primary: #2d081f;
            --theme-text-secondary: #501030;
            --theme-text-tertiary: #731842;
            
            --theme-border: #f5c0dd;
            --shadow-colored: 0 10px 40px -10px rgba(236, 72, 153, 0.3);
            --theme-shadow: 0 4px 12px rgba(0,0,0,0.08);
            
            --primary-color: #ec4899;
            --secondary-color: #db2777;
        }

        /* üü¢ ÿ´ŸäŸÖ ÿ£ÿÆÿ∂ÿ± ÿ≤Ÿäÿ™ŸàŸÜŸä - Olive */
        [data-theme="olive"] {
            --theme-bg-primary: #1a1f0a;
            --theme-bg-secondary: #242a0f;
            --theme-bg-card: #2e3515;
            --theme-bg-hover: #38401a;
            
            --theme-text-primary: #e8f0d1;
            --theme-text-secondary: #c9d9a8;
            --theme-text-tertiary: #aac27d;
            
            --theme-border: #4a5425;
            --shadow-colored: 0 10px 40px -10px rgba(132, 204, 22, 0.5);
            --theme-shadow: 0 4px 12px rgba(0,0,0,0.6);
            
            --primary-color: #84cc16;
            --secondary-color: #65a30d;
        }

        /* üî¥ ÿ´ŸäŸÖ ÿ£ÿ≤ÿ±ŸÇ ÿØÿßŸÉŸÜ ŸÖŸÑŸÉŸä - Royal Blue */
        [data-theme="royal-blue"] {
            --theme-bg-primary: #0c1445;
            --theme-bg-secondary: #111b5f;
            --theme-bg-card: #162270;
            --theme-bg-hover: #1b2880;
            
            --theme-text-primary: #d6e4ff;
            --theme-text-secondary: #a8c0e8;
            --theme-text-tertiary: #7a9cd1;
            
            --theme-border: #2438a8;
            --shadow-colored: 0 10px 40px -10px rgba(37, 99, 235, 0.6);
            --theme-shadow: 0 4px 12px rgba(0,0,0,0.7);
            
            --primary-color: #2563eb;
            --secondary-color: #1d4ed8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            font-size: var(--font-size-base);
            background: var(--theme-bg-primary);
            color: var(--theme-text-primary);
            height: 100vh; /* ÿßÿ±ÿ™ŸÅÿßÿπ ÿ´ÿßÿ®ÿ™ */
            overflow: hidden; /* ŸÖŸÜÿπ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ÿ™ŸÖÿßŸÖÿßŸã */
            transition: all 0.3s ease;
        }

        html {
            height: 100vh;
            overflow: hidden;
            scroll-behavior: smooth; /* ÿ™ŸÖÿ±Ÿäÿ± ŸÜÿßÿπŸÖ */
        }

        /* ÿÆŸÑŸÅŸäÿ© ŸÖÿ™ÿ≠ÿ±ŸÉÿ© */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: var(--theme-bg-primary);
            transition: all 0.3s ease;
        }

        .animated-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
            opacity: 0.7;
        }

        [data-theme="light"] .animated-bg::before {
            opacity: 0.1;
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ Ÿàÿ∂Ÿàÿ≠ ÿßŸÑŸÜÿµŸàÿµ ŸÅŸä ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÅÿßÿ™ÿ≠ */
        [data-theme="light"] body,
        [data-theme="light"] .nav-text,
        [data-theme="light"] .btn,
        [data-theme="light"] .stat-label,
        [data-theme="light"] .form-label,
        [data-theme="light"] .modal-title,
        [data-theme="light"] h1,
        [data-theme="light"] h2,
        [data-theme="light"] h3,
        [data-theme="light"] h4,
        [data-theme="light"] h5,
        [data-theme="light"] h6 {
            font-weight: 600 !important;
            color: var(--theme-text-primary) !important;
        }
        
        [data-theme="light"] .stat-value,
        [data-theme="light"] .quick-stat-value {
            font-weight: 800 !important;
            color: #000000 !important;
        }

        [data-theme="light"] .custom-titlebar {
            background: rgba(250, 250, 248, 0.98);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(25px);
        }

        [data-theme="light"] .titlebar-clock {
            background: rgba(102, 126, 234, 0.08);
            border: 1px solid rgba(102, 126, 234, 0.2);
            color: #000000;
            font-weight: 700;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-20px) rotate(1deg); }
            66% { transform: translateY(10px) rotate(-1deg); }
        }

        /* ÿ™ÿµŸÖŸäŸÖ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ÿßŸÑÿπÿßŸÖ ŸÑŸÉŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) transparent;
        }

        *::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        *::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin: 4px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        *::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, 
                #667eea 0%, 
                #764ba2 40%,
                #f093fb 70%,
                #667eea 100%);
            border-radius: 12px;
            border: 2px solid transparent;
            background-clip: padding-box;
            box-shadow: 
                0 0 6px rgba(102, 126, 234, 0.4),
                inset 0 0 6px rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        *::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, 
                #f093fb 0%, 
                #764ba2 40%,
                #667eea 70%,
                #f093fb 100%);
            box-shadow: 
                0 0 16px rgba(102, 126, 234, 0.9),
                inset 0 0 8px rgba(255, 255, 255, 0.3);
            border-width: 1px;
            transform: scaleX(1.1);
        }

        *::-webkit-scrollbar-thumb:active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 
                0 0 20px rgba(102, 126, 234, 1),
                inset 0 0 10px rgba(255, 255, 255, 0.4);
        }

        *::-webkit-scrollbar-corner {
            background: transparent;
        }

        /* ÿ™ÿ£ÿ´Ÿäÿ± ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ÿßŸÑÿ≥ŸÑÿ≥ */
        * {
            scroll-behavior: smooth;
        }

        /* ÿ™ÿ£ÿ´Ÿäÿ± ŸÜÿ®ÿ∂ ŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± */
        @keyframes scrollbarPulse {
            0%, 100% {
                box-shadow: 0 0 6px rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 0 12px rgba(102, 126, 234, 0.8);
            }
        }

        /* ÿ™ÿ£ÿ´Ÿäÿ± ÿ™ŸàŸáÿ¨ ŸÖÿ™ÿ≠ÿ±ŸÉ ŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± */
        @keyframes scrollbarGlow {
            0% {
                box-shadow: 
                    0 0 6px rgba(102, 126, 234, 0.4),
                    0 0 12px rgba(102, 126, 234, 0.2);
            }
            50% {
                box-shadow: 
                    0 0 12px rgba(102, 126, 234, 0.6),
                    0 0 20px rgba(102, 126, 234, 0.4);
            }
            100% {
                box-shadow: 
                    0 0 6px rgba(102, 126, 234, 0.4),
                    0 0 12px rgba(102, 126, 234, 0.2);
            }
        }

        /* ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ŸàŸáÿ¨ ÿπŸÑŸâ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ÿßŸÑŸÜÿ¥ÿ∑ */
        *::-webkit-scrollbar-thumb:hover {
            animation: scrollbarGlow 2s ease-in-out infinite;
        }

        /* ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖÿÆÿµÿµ */
        .custom-titlebar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: var(--theme-bg-secondary);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 10000;
            -webkit-app-region: drag;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            direction: ltr;
        }

        .titlebar-left {
            display: flex;
            align-items: center;
            gap: 15px;
            -webkit-app-region: no-drag;
            min-width: 250px;
        }

        .titlebar-controls {
            display: flex;
            gap: 10px;
        }

        .titlebar-btn {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: white;
        }

        .titlebar-btn i {
            z-index: 1;
            font-size: var(--font-size-sm);
        }

        .titlebar-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .titlebar-btn:active {
            transform: translateY(0);
        }

        .titlebar-btn.close {
            background: linear-gradient(135deg, #ff5f57 0%, #ff3b30 100%);
        }

        .titlebar-btn.close:hover {
            background: linear-gradient(135deg, #ff3b30 0%, #e62117 100%);
            box-shadow: 0 4px 14px rgba(255, 59, 48, 0.7);
        }

        .titlebar-btn.minimize {
            background: linear-gradient(135deg, #ffbd2e 0%, #ffaa00 100%);
        }

        .titlebar-btn.minimize:hover {
            background: linear-gradient(135deg, #ffaa00 0%, #ff9500 100%);
            box-shadow: 0 4px 14px rgba(255, 170, 0, 0.7);
        }

        .titlebar-btn.maximize {
            background: linear-gradient(135deg, #28ca42 0%, #00d844 100%);
        }

        .titlebar-btn.maximize:hover {
            background: linear-gradient(135deg, #00d844 0%, #00c73c 100%);
            box-shadow: 0 4px 14px rgba(0, 216, 68, 0.7);
        }

        .titlebar-center {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
            justify-content: center;
        }

        .titlebar-logo {
            width: 24px;
            height: 24px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: var(--font-size-sm);
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .titlebar-title {
            font-size: var(--font-size-base);
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            user-select: none;
            white-space: nowrap;
        }

        .titlebar-right {
            display: flex;
            align-items: center;
            gap: 12px;
            -webkit-app-region: no-drag;
            min-width: 250px;
            justify-content: flex-end;
        }

        .titlebar-clock {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: var(--theme-bg-primary);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            font-family: 'Cairo', monospace;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .titlebar-clock i {
            color: var(--primary-color);
        }

        .titlebar-refresh {
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .titlebar-refresh:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }

        .titlebar-refresh:active {
            transform: translateY(0);
        }

        .titlebar-refresh i {
            transition: transform 0.6s ease;
        }

        .titlebar-refresh:hover i {
            transform: rotate(360deg);
        }


        /* ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ±ÿ≠Ÿäÿ® */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .welcome-overlay.fade-out {
            animation: fadeOut 0.3s ease;
            opacity: 0;
        }

        .welcome-card {
            background: var(--theme-bg-primary);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 600px;
            width: 90%;
            overflow: hidden;
            animation: slideUp 0.4s ease;
            border: 1px solid var(--theme-border-color);
        }

        .welcome-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            text-align: center;
        }

        .welcome-header h2 {
            color: white;
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .welcome-body {
            padding: 30px;
            text-align: center;
        }

        .welcome-body > p {
            color: var(--theme-text-primary);
            font-size: 1.1rem;
            margin-bottom: 25px;
        }

        .welcome-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 25px 0;
        }

        .welcome-feature {
            background: var(--theme-bg-secondary);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--theme-border-color);
            transition: all 0.3s ease;
        }

        .welcome-feature:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
            border-color: var(--primary-color);
        }

        .welcome-feature span {
            font-size: 2rem;
            display: block;
            margin-bottom: 8px;
        }

        .welcome-feature p {
            color: var(--theme-text-primary);
            font-size: 0.9rem;
            margin: 0;
            font-weight: 500;
        }

        .welcome-note {
            background: var(--info-color);
            background: linear-gradient(135deg, var(--info-color), var(--primary-color));
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            margin: 20px 0 10px 0 !important;
        }

        .welcome-hint {
            color: var(--theme-text-secondary);
            font-size: 0.85rem;
            margin: 5px 0 0 0 !important;
        }

        .welcome-footer {
            padding: 20px 30px 30px;
            text-align: center;
        }

        .welcome-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 40px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .welcome-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(102, 126, 234, 0.6);
        }

        .welcome-btn:active {
            transform: translateY(0);
        }

        /* ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿπÿ© - ŸÖÿÆŸÅŸä ÿπŸÜÿØŸÖÿß ŸäŸÉŸàŸÜ ŸÅŸä top-bar */
        .quick-stats-bar {
            display: none;
        }

        /* ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÅŸä ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÑŸàŸä - ŸÖÿØŸÖÿ¨ÿ© ÿ¨ÿØÿßŸã */
        .top-bar-stats .quick-stat-card {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: linear-gradient(135deg, 
                var(--theme-bg-card) 0%, 
                rgba(102, 126, 234, 0.02) 100%);
            border-radius: 8px;
            border: 1px solid var(--theme-border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            flex-shrink: 0;
            min-width: auto;
        }

        .quick-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, 
                rgba(102, 126, 234, 0.1) 0%, 
                rgba(118, 75, 162, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .quick-stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, 
                rgba(255, 255, 255, 0.1) 0%, 
                transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .quick-stat-card:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 
                0 6px 16px rgba(102, 126, 234, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border-color: rgba(102, 126, 234, 0.4);
        }

        .quick-stat-card:hover::before {
            opacity: 1;
        }

        .quick-stat-card:hover::after {
            opacity: 1;
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }
            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        .top-bar-stats .quick-stat-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: white;
            flex-shrink: 0;
            position: relative;
            z-index: 2;
            box-shadow: 
                0 3px 8px rgba(0, 0, 0, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .quick-stat-icon::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: inherit;
            border-radius: inherit;
            filter: blur(8px);
            opacity: 0.6;
            z-index: -1;
        }

        .top-bar-stats .quick-stat-card:hover .quick-stat-icon {
            transform: scale(1.08) rotate(3deg);
            box-shadow: 
                0 5px 12px rgba(0, 0, 0, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 0.3);
        }

        .products-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #8b5cf6 100%);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .value-icon {
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        .debts-icon {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
        }

        .debtors-icon {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }

        .debt-value-icon {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 50%, #be185d 100%);
            box-shadow: 0 6px 16px rgba(236, 72, 153, 0.4);
        }

        .quick-stat-info {
            flex: 1;
            position: relative;
            z-index: 2;
        }

        .top-bar-stats .quick-stat-label {
            font-size: var(--font-size-xs);
            color: var(--theme-text-secondary);
            margin-bottom: 0.15rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .top-bar-stats .quick-stat-card:hover .quick-stat-label {
            color: var(--primary-color);
        }

        .top-bar-stats .quick-stat-value {
            font-size: var(--font-size-md);
            font-weight: 700;
            background: linear-gradient(135deg, 
                var(--theme-text-primary) 0%, 
                var(--primary-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }

        .top-bar-stats .quick-stat-card:hover .quick-stat-value {
            transform: scale(1.05);
            filter: drop-shadow(0 2px 4px rgba(102, 126, 234, 0.2));
        }

        /* ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ≥ÿßÿπÿ© ÿßŸÑÿ±ŸÇŸÖŸäÿ© - ŸÅŸä ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÑŸàŸä */
        .top-bar-stats .digital-clock-card {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d1b4e 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 0.4rem 0.75rem;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 3px 12px rgba(0, 0, 0, 0.15),
                inset 0 0 20px rgba(102, 126, 234, 0.1);
            flex-shrink: 0;
            min-width: auto;
        }

        .digital-clock-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 30% 50%, rgba(102, 126, 234, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 70% 50%, rgba(118, 75, 162, 0.2) 0%, transparent 50%);
            animation: clockPulse 6s ease-in-out infinite;
        }

        .digital-clock-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                transparent 30%, 
                rgba(255, 255, 255, 0.03) 50%, 
                transparent 70%);
            animation: shine 3s linear infinite;
        }

        @keyframes clockPulse {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                opacity: 0.4;
            }
            50% {
                transform: scale(1.2) rotate(5deg);
                opacity: 0.7;
            }
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }

        .digital-clock {
            width: 100%;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .clock-time {
            font-size: 1.3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff 0%, #a8b3ff 50%, #ffffff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.1em;
            text-shadow: 
                0 0 10px rgba(168, 179, 255, 0.3);
            margin-bottom: 0.3rem;
            filter: drop-shadow(0 2px 6px rgba(102, 126, 234, 0.4));
            position: relative;
        }

        .clock-time::before {
            content: attr(data-time);
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: blur(8px);
            opacity: 0.5;
            z-index: -1;
        }

        @keyframes clockGlow {
            0%, 100% {
                filter: drop-shadow(0 4px 12px rgba(102, 126, 234, 0.5));
            }
            50% {
                filter: drop-shadow(0 6px 20px rgba(102, 126, 234, 0.8));
            }
        }

        .clock-date {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            flex-wrap: nowrap;
        }

        .clock-date span {
            padding: 0.2rem 0.6rem;
            background: linear-gradient(135deg, 
                rgba(102, 126, 234, 0.2) 0%, 
                rgba(118, 75, 162, 0.2) 100%);
            border-radius: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(168, 179, 255, 0.3);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        /* ÿ™ÿµÿ∫Ÿäÿ± ÿßŸÑÿ≥ÿßÿπÿ© ŸÅŸä ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÑŸàŸä */
        .top-bar-stats .clock-time {
            font-size: 1.05rem;
            margin-bottom: 0.2rem;
            letter-spacing: 0.08em;
        }

        .top-bar-stats .clock-date {
            gap: 0.35rem;
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .clock-date span::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.2) 50%, 
                transparent 100%);
            transition: left 0.6s ease;
        }

        .clock-date span:hover::before {
            left: 100%;
        }

        .clock-date span:hover {
            background: linear-gradient(135deg, 
                rgba(102, 126, 234, 0.4) 0%, 
                rgba(118, 75, 162, 0.4) 100%);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 
                0 6px 20px rgba(102, 126, 234, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border-color: rgba(168, 179, 255, 0.5);
        }

        /* ÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ÿßŸÑÿ≠ÿ±ŸÉÿ© ŸÑŸÑÿ•ÿπÿØÿßÿØÿßÿ™ */
        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .clock-date span:active {
            transform: translateY(-1px) scale(1.02);
        }

        /* ÿπÿØÿßÿØ ÿßŸÑÿ≥ŸÑÿ© ŸÅŸä ÿßŸÑÿ™ÿ±ŸàŸäÿ≥ÿ© */
        .cart-header {
            position: relative;
        }

        .cart-badge-info {
            display: flex;
            gap: 0.8rem;
            margin-right: auto;
        }

        .cart-mini-stat {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            background: var(--primary-color);
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
        }

        .cart-mini-stat.total-price {
            background: var(--success-color);
        }

        /* ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ŸÑŸÑÿ¥ÿßÿ¥ÿßÿ™ ÿßŸÑÿµÿ∫Ÿäÿ±ÿ© */
        @media (max-width: 1400px) {
            .digital-clock-card {
                grid-column: span 1;
            }
            
            .clock-time {
                font-size: 2rem;
            }
        }

        @media (max-width: 768px) {
            .quick-stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .digital-clock-card {
                grid-column: span 2;
            }
        }

        /* ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä */
        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
            padding-top: 40px;
            overflow: hidden; /* ŸÖŸÜÿπ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± */
        }

        /* ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä */
        .sidebar {
            width: 280px;
            background: var(--theme-bg-secondary);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: none;
            position: relative;
            z-index: 100;
            transform: translateX(0);
            padding-top: 0;
        }

        .sidebar.collapsed {
            width: 80px;
        }
        
        .sidebar.collapsed .nav-icon {
            margin-left: 0;
        }

        .sidebar.collapsed .nav-text,
        .sidebar.collapsed .logo p,
        .sidebar.collapsed .nav-section-title {
            opacity: 0;
            transform: translateX(-20px);
        }

        .sidebar.collapsed .logo h1 {
            font-size: 1rem;
        }

        /* ÿ±ÿ£ÿ≥ ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä - ŸÖÿÆŸÅŸä */
        .sidebar-header {
            display: none;
        }

        /* ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ™ŸÜŸÇŸÑ */
        .nav-menu {
            flex: 1;
            padding: 2rem 0 1.5rem;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .nav-menu::-webkit-scrollbar {
            width: 6px;
        }

        .nav-menu::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin: 8px 0;
        }

        .nav-menu::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .nav-menu::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            box-shadow: 0 0 8px var(--primary-color);
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            padding: 0 1.5rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--theme-text-secondary);
            transition: all 0.3s ease;
        }

        .nav-item {
            margin: 0.25rem 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.25rem;
            color: var(--theme-text-secondary);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: -1;
        }

        .nav-link:hover::before,
        .nav-link.active::before {
            left: 0;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--text-primary);
            transform: translateX(8px);
            box-shadow: var(--shadow-md);
        }

        .sidebar.collapsed .nav-link:hover,
        .sidebar.collapsed .nav-link.active {
            transform: translateX(0) scale(1.1);
        }

        .nav-icon {
            width: 20px;
            margin-left: 1rem;
            font-size: var(--font-size-lg);
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }

        .nav-link:hover .nav-icon {
            transform: scale(1.1);
        }

        .nav-text {
            font-weight: 500;
            font-size: var(--font-size-base);
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        /* ÿ≤ÿ± ÿßŸÑÿ™ÿ®ÿØŸäŸÑ */
        .sidebar-toggle {
            position: absolute;
            top: 15px;
            left: -20px;
            background: var(--theme-bg-secondary);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--theme-text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            z-index: 101;
        }

        .sidebar-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
        }
        
        [data-theme="light"] .sidebar-toggle {
            background: #ffffff;
            border: 2px solid #e2e8f0;
            color: #4a5568;
        }
        
        [data-theme="light"] .sidebar-toggle:hover {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
        }

        /* ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÑŸàŸä */
        .top-bar {
            background: var(--theme-bg-secondary);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            position: relative;
            z-index: 50;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            flex-shrink: 0;
        }

        .top-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-shrink: 0;
        }

        /* ÿ≠ÿßŸàŸäÿ© ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÅŸä ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÑŸàŸä */
        .top-bar-stats {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex: 1;
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.5) transparent;
            padding: 0.25rem 0;
        }

        .top-bar-stats::-webkit-scrollbar {
            height: 4px;
        }

        .top-bar-stats::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
        }

        .top-bar-stats::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        /* ŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ´ŸäŸÖ */
        .theme-toggle {
            background: var(--theme-bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius-lg);
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--theme-text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.05);
        }

        /* ÿßŸÑÿ®ÿ≠ÿ´ */
        .search-box {
            position: relative;
        }

        .search-input {
            background: var(--theme-bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius-lg);
            padding: 0.75rem 1rem 0.75rem 3rem;
            color: var(--theme-text-primary);
            font-size: 0.875rem;
            width: 300px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--theme-text-secondary);
        }


        /* ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿµŸÅÿ≠ÿßÿ™ */
        .page-content {
            flex: 1;
            padding: 1.5rem 2rem;
            background: var(--theme-bg-primary);
            height: calc(100vh - 80px);
            position: relative;
        }
        
        /* ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ ŸÅŸÇÿ∑ - ÿ®ÿØŸàŸÜ ÿ™ŸÖÿ±Ÿäÿ± */
        .page-content:has(#pos.active) {
            overflow: hidden;
        }
        
        /* ÿ®ÿßŸÇŸä ÿßŸÑÿµŸÅÿ≠ÿßÿ™ - ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ŸÖÿ±Ÿäÿ± */
        .page-content:not(:has(#pos.active)) {
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* ÿ™ÿÆÿµŸäÿµ scrollbar ŸÑŸÄ page-content */
        .page-content::-webkit-scrollbar {
            width: 12px;
        }

        .page-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .page-content::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
        }

        .page-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #764ba2 0%, #f093fb 100%);
        }

        .page {
            display: none !important;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth; /* ÿ™ŸÖÿ±Ÿäÿ± ŸÜÿßÿπŸÖ */
        }

        .page.active {
            display: block !important;
            animation: fadeInUp 0.5s ease-out;
        }
        
        /* ÿµŸÅÿ≠ÿßÿ™ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ Ÿàÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ - ÿ®ÿØŸàŸÜ ŸÇŸäŸàÿØ ÿπÿ±ÿ∂ */
        .page:not(#pos) .section-header {
            margin-bottom: 1.5rem;
        }
        
        /* ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÇŸäŸàÿØ ÿπŸÑŸâ ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ */
        .page:not(#pos) > div[style*="max-width"] {
            max-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* ÿ™ÿÆÿµŸäÿµ scrollbar ŸÑŸÑÿµŸÅÿ≠ÿßÿ™ */
        .page::-webkit-scrollbar {
            width: 10px;
        }

        .page::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .page::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .page::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #764ba2 0%, #f093fb 100%);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ */
        .pos-layout {
            display: grid;
            grid-template-columns: 1fr 550px; /* ÿ™Ÿàÿ≥Ÿäÿπ ÿßŸÑÿ≥ŸÑÿ© ŸÖŸÜ 400px ÿ•ŸÑŸâ 550px */
            gap: 1.5rem;
            height: calc(100vh - 180px); /* ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿßÿ±ÿ™ŸÅÿßÿπ ŸÑÿ™ÿ¨ŸÜÿ® ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑŸÖŸáÿßŸÖ */
            align-items: stretch; /* ÿ™ŸÖÿØŸäÿØ ÿßŸÑÿπŸÜÿßÿµÿ± ÿ®ÿßŸÑŸÉÿßŸÖŸÑ */
        }

        .products-section {
            background: var(--theme-bg-card);
            border-radius: var(--border-radius-lg);
            padding: 1rem;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
            height: calc(100vh - 200px); /* ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿßÿ±ÿ™ŸÅÿßÿπ */
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 200px); /* ŸÑÿß ÿ™ÿ™ÿ¨ÿßŸàÿ≤ ÿßŸÑÿßÿ±ÿ™ŸÅÿßÿπ */
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            gap: 1rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--theme-text-primary);
        }
        
        /* ÿÆÿßŸÜÿ© ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ */
        .pos-search-box {
            position: relative;
            flex: 1;
            max-width: 350px;
        }
        
        .pos-search-box i {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--theme-text-secondary);
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 1;
        }
        
        .pos-search-input {
            width: 100%;
            background: var(--theme-bg-secondary);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius-lg);
            padding: 0.75rem 1rem 0.75rem 2.75rem;
            color: var(--theme-text-primary);
            font-size: 0.9rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Cairo', sans-serif;
        }
        
        .pos-search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
            background: var(--theme-bg-card);
        }
        
        .pos-search-input::placeholder {
            color: var(--theme-text-secondary);
            opacity: 0.7;
        }
        
        [data-theme="light"] .pos-search-input {
            background: #ffffff;
            border: 2px solid #e2e8f0;
            color: #1a202c;
        }
        
        [data-theme="light"] .pos-search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: #ffffff;
        }
        
        [data-theme="light"] .pos-search-box i {
            color: #718096;
        }
        
        @media (max-width: 768px) {
            .section-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .pos-search-box {
                max-width: 100%;
            }
        }

        /* ŸÅŸÑÿßÿ™ÿ± ÿßŸÑŸÅÿ¶ÿßÿ™ */
        .category-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .category-btn {
            background: var(--theme-bg-secondary);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius-lg);
            padding: 0.5rem 1rem;
            color: var(--theme-text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .category-btn:hover,
        .category-btn.active {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* ÿ¥ÿ®ŸÉÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1.5rem;
            flex: 1;
            overflow-y: auto; /* scrollbar ÿØÿßÿÆŸÑŸä ŸÅŸÇÿ∑ */
            overflow-x: hidden;
            padding-right: 0.5rem;
            max-height: 100%; /* ŸÑÿß ÿ™ÿ™ÿ¨ÿßŸàÿ≤ ÿßŸÑÿ≠ÿßŸàŸäÿ© */
        }

        .products-grid::-webkit-scrollbar {
            width: 12px;
        }

        .products-grid::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            margin: 10px 0;
        }

        .products-grid::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, 
                #667eea 0%, 
                #764ba2 50%, 
                #f093fb 100%);
            border-radius: 12px;
            border: 2px solid transparent;
            background-clip: padding-box;
            box-shadow: 
                0 0 8px rgba(102, 126, 234, 0.5),
                inset 0 0 6px rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .products-grid::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, 
                #f093fb 0%, 
                #764ba2 50%, 
                #667eea 100%);
            box-shadow: 
                0 0 16px rgba(102, 126, 234, 0.9),
                inset 0 0 8px rgba(255, 255, 255, 0.3);
            transform: scaleX(1.15);
        }

        .products-grid::-webkit-scrollbar-thumb:active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 0 20px rgba(102, 126, 234, 1);
        }

        /* ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ */
        .product-card {
            background: var(--theme-bg-secondary);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-height: 180px;
            justify-content: center;
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: -1;
        }

        .product-card:hover::before {
            left: 0;
            opacity: 0.1;
        }

        .product-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-color);
        }

        .product-icon {
            font-size: 2.5rem;
            flex-shrink: 0;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .product-name {
            font-weight: 600;
            color: var(--theme-text-primary);
            font-size: 0.9rem;
            line-height: 1.3;
            flex-shrink: 0;
        }

        .product-price {
            color: var(--success-color);
            font-size: 1rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .product-stock {
            font-size: 0.75rem;
            color: var(--theme-text-secondary);
            flex-shrink: 0;
        }

        /* ÿ≥ŸÑÿ© ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ */
        .cart-section {
            background: var(--theme-bg-card);
            border-radius: var(--border-radius-lg);
            padding: 1rem;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* ŸÖÿ≥ÿßŸÅÿ© ÿ®ŸäŸÜ ÿßŸÑÿπŸÜÿßÿµÿ± */
            position: relative;
            height: calc(100vh - 200px); /* ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿßÿ±ÿ™ŸÅÿßÿπ ŸÑÿ™ÿ¨ŸÜÿ® ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑŸÖŸáÿßŸÖ */
            max-height: calc(100vh - 200px); /* ŸÑÿß ÿ™ÿ™ÿ¨ÿßŸàÿ≤ ÿßŸÑÿßÿ±ÿ™ŸÅÿßÿπ */
            overflow: visible; /* ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿ∏ŸáŸàÿ± ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ */
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ÿÆŸÑŸÅŸäÿ© ŸÖÿ™ÿ≠ÿ±ŸÉÿ© ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä */
        .cart-section:not(:hover)::after {
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(99, 102, 241, 0.03) 50%,
                transparent 100%
            );
        }

        /* ŸÖÿ§ÿ¥ÿ± ŸÑŸÑÿ™ŸÅÿßÿπŸÑ */
        .cart-section::before {
            content: 'üëÜ ŸÖÿ±ÿ± ŸÑÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ®Ÿäÿπ';
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.95), rgba(139, 92, 246, 0.95));
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.72rem;
            opacity: 0.9;
            transition: all 0.4s ease;
            pointer-events: none;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            animation: pulseHint 2s ease-in-out infinite;
            z-index: 2;
        }

        /* ŸÖÿ§ÿ¥ÿ± ÿπÿ±ÿ∂ ÿ¢ÿÆÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ */
        .cart-section::after {
            content: '‚¨áÔ∏è ÿπÿ±ÿ∂ ÿ¢ÿÆÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™';
            position: absolute;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.9), rgba(16, 185, 129, 0.9));
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.75rem;
            opacity: 0;
            transition: all 0.4s ease;
            pointer-events: none;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
            z-index: 2;
            white-space: nowrap;
        }

        /* ÿ•ÿ∏Ÿáÿßÿ± ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿπŸÜÿØŸÖÿß ŸÑÿß ŸäŸÉŸàŸÜ hover */
        .cart-section:not(:hover)::after {
            opacity: 0.9;
            animation: slideUpDown 2s ease-in-out infinite;
        }

        @keyframes slideUpDown {
            0%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            50% {
                transform: translateX(-50%) translateY(5px);
            }
        }

        @keyframes pulseHint {
            0%, 100% {
                transform: scale(1);
                opacity: 0.9;
            }
            50% {
                transform: scale(1.05);
                opacity: 1;
            }
        }

        .cart-section:hover::before {
            opacity: 0;
            transform: scale(0.8) translateY(-10px);
        }

        .cart-section:hover::after {
            opacity: 0;
            transform: scale(0.8) translateY(10px);
        }

        /* ÿ•ÿ∏Ÿáÿßÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÜÿßÿµÿ± ÿ®ÿ¥ŸÉŸÑ ÿØÿßÿ¶ŸÖ - ÿ®ÿØŸàŸÜ ÿ•ÿÆŸÅÿßÿ° */
        .cart-section .cart-header,
        .cart-section .remove-btn,
        .cart-section .quantity-controls,
        .cart-section .cart-summary,
        .cart-section .checkout-btn,
        .cart-section .cart-actions {
            opacity: 1;
            pointer-events: all;
            transition: all 0.3s ease;
        }

        /* ÿ™ÿ£ÿ´Ÿäÿ± ÿÆŸÅŸäŸÅ ÿπŸÜÿØ hover */
        .cart-section:hover .cart-header,
        .cart-section:hover .remove-btn,
        .cart-section:hover .quantity-controls,
        .cart-section:hover .cart-summary,
        .cart-section:hover .checkout-btn,
        .cart-section:hover .cart-actions {
            opacity: 1;
            pointer-events: all;
        }

        /* ÿπÿ±ÿ∂ ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿØÿßÿ¶ŸÖÿßŸã */
        .cart-section .cart-count {
            opacity: 1 !important;
            pointer-events: all !important;
        }

        .cart-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0; /* ŸÑÿß ÿ™ÿ™ŸÇŸÑÿµ */
        }

        .cart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--theme-text-primary);
        }

        .cart-count {
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .cart-items {
            flex: 1 1 auto; /* ÿ™ÿ£ÿÆÿ∞ ÿßŸÑŸÖÿ≥ÿßÿ≠ÿ© ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© ŸàŸäŸÖŸÉŸÜŸáÿß ÿßŸÑÿ™ŸÇŸÑÿµ */
            overflow-y: auto; /* scrollbar ÿØÿßÿÆŸÑŸä ŸÅŸÇÿ∑ */
            overflow-x: hidden; /* ŸÖŸÜÿπ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ÿßŸÑÿ£ŸÅŸÇŸä */
            margin-bottom: 0;
            transition: all 0.3s ease;
            padding-right: 8px;
            position: relative;
            scroll-behavior: smooth;
            /* ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ÿ¥ÿ®ŸÉÿ© ŸÖŸÜ ÿπŸÖŸàÿØŸäŸÜ ÿ®ÿπÿ±ÿ∂ ŸÉÿßŸÖŸÑ */
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            align-content: start;
            width: 100%; /* ÿπÿ±ÿ∂ ŸÉÿßŸÖŸÑ ŸÑŸÑÿ≠ÿßŸàŸäÿ© */
            min-height: 0; /* ŸÖŸáŸÖ ÿ¨ÿØÿßŸã: Ÿäÿ≥ŸÖÿ≠ ÿ®ÿßŸÑÿ™ŸÇŸÑÿµ */
            max-height: calc(100vh - 580px); /* ÿßÿ±ÿ™ŸÅÿßÿπ ŸÖÿ≠ÿØÿØ ŸÑÿ∂ŸÖÿßŸÜ ÿ∏ŸáŸàÿ± ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ŸÅŸàŸÇ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑŸÖŸáÿßŸÖ */
        }

        /* ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ÿØÿßÿ¶ŸÖ ÿßŸÑÿ∏ŸáŸàÿ± ŸÖÿπ ÿ™ÿ£ÿ´Ÿäÿ± hover */
        .cart-items::-webkit-scrollbar {
            width: 10px;
        }

        /* ÿ™ÿ£ÿ´Ÿäÿ± ÿßŸÑÿ∏ŸÑ ÿπŸÜÿØ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± */
        .cart-items::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(to bottom, 
                var(--theme-bg-card) 0%, 
                transparent 100%);
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .cart-items::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(to top, 
                var(--theme-bg-card) 0%, 
                transparent 100%);
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ∏ŸÑÿßŸÑ ÿπŸÜÿØ Ÿàÿ¨ŸàÿØ ŸÖÿ≠ÿ™ŸàŸâ ŸÑŸÑÿ™ŸÖÿ±Ÿäÿ± */
        .cart-items.has-scroll::before,
        .cart-items.has-scroll::after {
            opacity: 1;
        }

        /* ÿ™ÿµŸÖŸäŸÖ Scrollbar ÿ¨ŸÖŸäŸÑ Ÿàÿπÿµÿ±Ÿä */
        .cart-items::-webkit-scrollbar {
            width: 10px;
        }

        .cart-items::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin: 8px 0;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.1);
        }

        .cart-items::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            border-radius: 12px;
            border: 2px solid transparent;
            background-clip: padding-box;
            box-shadow: 0 0 6px rgba(102, 126, 234, 0.5);
            transition: all 0.3s ease;
        }

        .cart-items::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #f093fb 0%, #764ba2 50%, #667eea 100%);
            box-shadow: 0 0 12px rgba(102, 126, 234, 0.8);
            transform: scaleX(1.2);
        }

        .cart-items::-webkit-scrollbar-thumb:active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 0 16px rgba(102, 126, 234, 1);
        }

        /* ÿ™Ÿàÿ≥Ÿäÿπ ÿßŸÑÿ≥ŸÑÿ© ÿπŸÜÿØ hover */
        .cart-section:hover {
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.3);
            border-color: var(--primary-color);
            transform: scale(1.02);
        }

        /* ÿ™ÿ£ÿ´Ÿäÿ± ÿßŸÑÿ∂Ÿàÿ° ÿπŸÑŸâ ÿßŸÑÿ≥ŸÑÿ© ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± */
        .cart-section:not(:hover) {
            animation: subtleGlow 3s ease-in-out infinite;
        }

        @keyframes subtleGlow {
            0%, 100% {
                box-shadow: var(--shadow-md);
            }
            50% {
                box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);
            }
        }

        /* ÿ•ÿ®ŸÇÿßÿ° ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ∏ÿßŸáÿ±ÿ© ÿØÿßÿ¶ŸÖÿßŸã */
        .cart-section .cart-items {
            opacity: 1 !important;
        }

        .cart-section .cart-item {
            opacity: 1 !important;
        }

        .cart-empty {
            text-align: center;
            color: var(--theme-text-secondary);
            padding: 2rem 1rem;
            opacity: 1 !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            grid-column: 1 / -1; /* ÿ™ŸÖÿ™ÿØ ÿπÿ®ÿ± ŸÉŸÑ ÿßŸÑÿ£ÿπŸÖÿØÿ© */
        }

        .cart-empty i {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            opacity: 0.5;
        }

        .cart-item {
            background: var(--theme-bg-secondary);
            border-radius: var(--border-radius);
            padding: 0.6rem;
            margin-bottom: 0;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column; /* ÿπŸÖŸàÿØŸä ŸÑŸÑŸÖÿ≠ÿ™ŸàŸâ */
            align-items: stretch;
            gap: 6px;
            opacity: 0.95;
            min-height: auto;
            width: 100%; /* ÿπÿ±ÿ∂ ŸÉÿßŸÖŸÑ ÿØÿßÿÆŸÑ ÿßŸÑÿπŸÖŸàÿØ */
            box-sizing: border-box;
        }

        /* ÿ™ÿ£ÿ´Ÿäÿ± ÿπŸÜÿØŸÖÿß ŸäŸÉŸàŸÜ ÿßŸÑŸÖÿ§ÿ¥ÿ± ÿ®ÿπŸäÿØÿßŸã - ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ Ÿàÿßÿ∂ÿ≠ÿ© */
        .cart-section:not(:hover) .cart-item {
            opacity: 1; /* ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ Ÿàÿßÿ∂ÿ≠ÿ© ÿØÿßÿ¶ŸÖÿßŸã */
            transform: scale(1);
            transition: all 0.4s ease;
            filter: none;
        }

        /* ÿßŸÑÿπŸÜÿßÿµÿ± ÿßŸÑÿ£ÿÆŸäÿ±ÿ© ÿ™ŸÉŸàŸÜ ÿ£Ÿàÿ∂ÿ≠ Ÿàÿ£ŸÉÿ®ÿ± */
        .cart-section:not(:hover) .cart-item:last-child {
            opacity: 1 !important;
            transform: scale(1) !important;
            filter: none !important;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }

        .cart-section:not(:hover) .cart-item:nth-last-child(2) {
            opacity: 1;
            transform: scale(1);
            filter: none;
        }

        .cart-section:not(:hover) .cart-item:nth-last-child(3) {
            opacity: 1;
            transform: scale(1);
            filter: none;
        }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑŸàÿ∂Ÿàÿ≠ ÿπŸÜÿØ hover - ŸÉŸÑ ÿßŸÑÿπŸÜÿßÿµÿ± Ÿàÿßÿ∂ÿ≠ÿ© */
        .cart-section:hover .cart-item {
            opacity: 1 !important;
            transform: scale(1) !important;
            filter: none !important;
        }

        /* ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ */
        .cart-item::before {
            content: 'üì¶';
            font-size: 1.5rem;
            width: 100%;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            border-radius: 8px;
            border: 2px solid rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
            flex-shrink: 0;
            margin-bottom: 4px;
        }

        .cart-section:hover .cart-item::before {
            transform: scale(1.03);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        /* ÿ≠ÿ±ŸÉÿ© ÿ®ÿ≥Ÿäÿ∑ÿ© ŸÑŸÑÿ£ŸäŸÇŸàŸÜÿßÿ™ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä */
        .cart-section:not(:hover) .cart-item::before {
            animation: iconFloat 3s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-3px) rotate(-3deg);
            }
        }

        /* ÿ™ÿ∫ŸäŸäÿ± ÿ£ŸäŸÇŸàŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ */
        .cart-item[data-category="laptops"]::before {
            content: 'üíª';
        }

        .cart-item[data-category="phones"]::before {
            content: 'üì±';
        }

        .cart-item[data-category="accessories"]::before {
            content: 'üéß';
        }

        /* ÿ™ÿÆÿ∑Ÿäÿ∑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ */
        .cart-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            width: 100%;
        }

        /* ÿ•ÿ®ŸÇÿßÿ° ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ∏ÿßŸáÿ±ÿßŸã ÿØÿßÿ¶ŸÖÿßŸã */
        .cart-item .item-info {
            opacity: 1 !important;
            width: 100%;
            text-align: center;
        }

        .cart-item .item-info h4 {
            opacity: 1 !important;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--theme-text-primary);
            margin-bottom: 0.15rem;
            display: block;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        /* ÿ¥ÿßÿ±ÿ© ÿßŸÑŸÉŸÖŸäÿ© - ÿØÿßÿ¶ŸÖÿßŸã ÿ∏ÿßŸáÿ±ÿ© */
        .cart-item .item-info h4::after {
            content: attr(data-quantity) 'x';
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 700;
            margin-right: 4px;
            display: inline-block;
        }

        /* ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ≥ÿπÿ± ÿßŸÑŸÅÿ±ÿØŸä ÿØÿßÿ¶ŸÖÿßŸã */
        .cart-section:not(:hover) .item-price {
            opacity: 1;
            height: auto;
            margin: 0;
            overflow: visible;
        }

        .cart-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }

        .item-header {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 0.5rem;
            width: 100%;
        }

        .item-info h4 {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--theme-text-primary);
            margin-bottom: 0.15rem;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-price {
            font-size: 0.75rem;
            color: var(--success-color);
            font-weight: 500;
            text-align: center;
        }

        .remove-btn {
            background: var(--danger-gradient);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: absolute;
            top: 4px;
            left: 4px;
            font-size: 0.7rem;
        }

        .remove-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-md);
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-top: 4px;
        }

        .qty-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--theme-bg-card);
            border-radius: var(--border-radius-lg);
            padding: 0.3rem 0.5rem;
        }

        .qty-btn {
            background: var(--primary-color);
            border: none;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .qty-btn:hover {
            background: var(--secondary-color);
            transform: scale(1.1);
        }

        .quantity {
            font-weight: 600;
            color: var(--theme-text-primary);
            min-width: 25px;
            text-align: center;
            font-size: 0.85rem;
        }

        .item-total {
            font-weight: 700;
            color: var(--success-color);
            font-size: 0.75rem;
            text-align: center;
            margin-top: 4px;
        }

        /* ŸÖŸÑÿÆÿµ ÿßŸÑÿ≥ŸÑÿ© */
        .cart-summary {
                        display: flex;
                        flex-direction: column;
                        gap: 0.5rem;
                        flex-shrink: 0;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 0.75rem;
            flex-shrink: 0; /* ŸÑÿß ÿ™ÿ™ŸÇŸÑÿµ - ÿ™ÿ®ŸÇŸâ ÿ´ÿßÿ®ÿ™ÿ© */
            overflow: visible; /* ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿ∏ŸáŸàÿ± ŸÉŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ */
        }

        .discount-section {
            margin-bottom: 0.5rem;
        }

        .discount-input {
            width: 100%;
            background: var(--theme-bg-secondary);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            padding: 0.5rem;
            color: var(--theme-text-primary);
            font-size: 0.875rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .discount-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: var(--theme-text-primary);
        }

        .summary-row.total {
            font-size: 1rem;
            font-weight: 700;
            color: var(--theme-text-primary);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }

        .summary-value {
            font-weight: 600;
        }

        /* ÿ∑ÿ±ŸÇ ÿßŸÑÿØŸÅÿπ */
        .payment-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin: 0.75rem 0;
        }

        .payment-btn {
            background: var(--theme-bg-secondary);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            padding: 0.6rem;
            color: var(--theme-text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
        }

        .payment-btn i {
            font-size: 1.2rem;
        }

        .payment-btn:hover,
        .payment-btn.selected {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* ÿ£ÿ≤ÿ±ÿßÿ± ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿßŸÑÿØŸÅÿπ */
        .payment-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 1rem;
            position: relative; /* ÿ™ÿ∫ŸäŸäÿ± ŸÖŸÜ sticky ÿ•ŸÑŸâ relative */
            background: var(--theme-bg-card);
            z-index: 10;
            padding-bottom: 0.5rem;
            flex-shrink: 0; /* ŸÑÿß ÿ™ÿ™ŸÇŸÑÿµ - ÿ™ÿ®ŸÇŸâ ÿ´ÿßÿ®ÿ™ÿ© */
        }

        .payment-action-btn {
            background: var(--theme-bg-secondary);
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: var(--border-radius);
            padding: 1rem 0.75rem;
            color: var(--theme-text-primary);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .payment-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .payment-action-btn:hover:not(:disabled)::before {
            opacity: 1;
        }

        .payment-action-btn i {
            font-size: 1.5rem;
        }

        .payment-action-btn.cash-btn {
            border-color: rgba(34, 197, 94, 0.4);
        }

        .payment-action-btn.cash-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border-color: #22c55e;
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(34, 197, 94, 0.4);
        }

        .payment-action-btn.installment-btn {
            border-color: rgba(99, 102, 241, 0.4);
        }

        .payment-action-btn.installment-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            border-color: #6366f1;
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .payment-action-btn:disabled {
            background: var(--theme-bg-secondary);
            color: var(--theme-text-secondary);
            cursor: not-allowed;
            opacity: 0.5;
            border-color: rgba(255, 255, 255, 0.1);
        }

        .payment-action-btn:disabled::before {
            display: none;
        }

        /* ÿ≤ÿ± ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÇÿØŸäŸÖ - ŸÑŸÑÿ™ŸàÿßŸÅŸÇ */
        .checkout-btn {
            width: 100%;
            background: var(--success-gradient);
            border: none;
            border-radius: var(--border-radius);
            padding: 0.75rem;
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .checkout-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .checkout-btn:disabled {
            background: var(--theme-bg-secondary);
            color: var(--theme-text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        /* ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ */
        .settings-card {
            background: var(--theme-bg-card);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
            animation: slideInUp 0.5s ease forwards;
            opacity: 0;
        }
        
        .settings-card:nth-child(1) { animation-delay: 0.1s; }
        .settings-card:nth-child(2) { animation-delay: 0.2s; }
        .settings-card:nth-child(3) { animation-delay: 0.3s; }
        .settings-card:nth-child(4) { animation-delay: 0.4s; }
        .settings-card:nth-child(5) { animation-delay: 0.5s; }
        .settings-card:nth-child(6) { animation-delay: 0.6s; }

        .settings-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-gradient);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .settings-card:hover {
            transform: translateX(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .settings-card:hover::before {
            transform: scaleY(1);
        }

        .settings-card-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .settings-card:hover .settings-card-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .settings-card-icon.store-icon {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.2));
            color: #22c55e;
        }

        .settings-card-icon.system-icon {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            color: #6366f1;
        }

        .settings-card-icon.backup-icon {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
            color: #3b82f6;
        }

        .settings-card-icon.printing-icon {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(147, 51, 234, 0.2));
            color: #a855f7;
        }

        .settings-card-icon.security-icon {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
            color: #ef4444;
        }

        .settings-card-content {
            flex: 1;
        }

        .settings-card-content h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--theme-text-primary);
        }

        .settings-card-content p {
            font-size: 0.9rem;
            color: var(--theme-text-secondary);
            line-height: 1.5;
        }

        .settings-card-arrow {
            color: var(--theme-text-secondary);
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .settings-card:hover .settings-card-arrow {
            transform: translateX(-5px);
            color: var(--primary-color);
        }

        /* ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿµÿ∫ÿ±ÿ© */
        .info-mini-card {
            background: var(--theme-bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border: 2px solid rgba(255,255,255,0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: slideInFromRight 0.5s ease forwards;
            opacity: 0;
        }
        
        .info-mini-card:nth-child(1) { animation-delay: 0.1s; }
        .info-mini-card:nth-child(2) { animation-delay: 0.2s; }
        .info-mini-card:nth-child(3) { animation-delay: 0.3s; }
        .info-mini-card:nth-child(4) { animation-delay: 0.4s; }

        .info-mini-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .info-mini-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.1);
        }

        .info-mini-card:hover::before {
            transform: scaleX(1);
        }

        .info-mini-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .info-mini-content {
            flex: 1;
        }

        .info-mini-label {
            font-size: 0.85rem;
            color: var(--theme-text-secondary);
            margin-bottom: 0.3rem;
        }

        .info-mini-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--theme-text-primary);
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ÿ®ÿ∑ÿßŸÇÿßÿ™ ŸÜÿ∏ÿ±ÿ© ÿπÿßŸÖÿ© ÿπŸÑŸâ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ */
        .stat-overview-card {
            background: var(--theme-bg-card);
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.05);
            transition: all 0.3s ease;
            animation: slideInUp 0.6s ease forwards;
            opacity: 0;
        }
        
        .stat-overview-card:nth-child(1) { animation-delay: 0.2s; }
        .stat-overview-card:nth-child(2) { animation-delay: 0.3s; }
        .stat-overview-card:nth-child(3) { animation-delay: 0.4s; }
        .stat-overview-card:nth-child(4) { animation-delay: 0.5s; }

        .stat-overview-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.1);
        }

        .stat-overview-header {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-bottom: 2px solid rgba(255,255,255,0.05);
        }

        .stat-overview-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .stat-overview-header h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--theme-text-primary);
            margin: 0;
        }

        .stat-overview-body {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .stat-overview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .stat-overview-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .stat-overview-item span {
            font-size: 0.9rem;
            color: var(--theme-text-secondary);
        }

        .stat-overview-item strong {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--theme-text-primary);
        }

        /* ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿπÿ© */
        .quick-action-btn {
            padding: 1.2rem 1.5rem;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            animation: slideInUp 0.5s ease forwards;
            opacity: 0;
        }
        
        .quick-action-btn:nth-child(1) { animation-delay: 0.6s; }
        .quick-action-btn:nth-child(2) { animation-delay: 0.7s; }
        .quick-action-btn:nth-child(3) { animation-delay: 0.8s; }
        .quick-action-btn:nth-child(4) { animation-delay: 0.9s; }

        .quick-action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .quick-action-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .quick-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .quick-action-btn:active {
            transform: translateY(-1px);
        }

        .quick-action-btn i {
            font-size: 1.2rem;
            position: relative;
            z-index: 1;
        }

        .quick-action-btn span {
            position: relative;
            z-index: 1;
        }

        /* ÿπŸÜŸàÿßŸÜ ŸÅÿ±ÿπŸä ŸÑŸÑŸÇÿ≥ŸÖ */
        .section-subtitle {
            font-size: 0.95rem;
            color: var(--theme-text-secondary);
            margin-top: 0.5rem;
        }

        /* ÿßŸÑÿ¨ÿØÿßŸàŸÑ */
        .table-container {
            background: var(--theme-bg-card);
            border-radius: var(--border-radius-lg);
            overflow: auto;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* ŸÑŸÑÿµŸÅÿ≠ÿßÿ™ ÿ∫Ÿäÿ± POS - ÿßŸÑÿ¨ÿØŸàŸÑ ŸÇÿßÿ®ŸÑ ŸÑŸÑÿ™ŸÖÿ±Ÿäÿ± ÿ®ÿ¥ŸÉŸÑ ŸÉÿßŸÖŸÑ */
        .page:not(#pos) .table-container {
            max-height: none;
        }
        
        /* ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ - ÿ¨ÿØŸàŸÑ ŸÖÿ≠ÿØŸàÿØ ÿßŸÑÿßÿ±ÿ™ŸÅÿßÿπ */
        #pos .table-container {
            max-height: 600px;
        }
        
        /* ÿ™ÿµŸÖŸäŸÖ ÿ¨ÿØŸäÿØ ŸÑŸÑÿµŸÅÿ≠ÿßÿ™ - ÿ®ŸÉÿßŸÖŸÑ ÿßŸÑÿπÿ±ÿ∂ */
        .settings-full-width {
            width: 100%;
            padding: 0;
        }
        
        .settings-content-wrapper {
            background: var(--theme-bg-card);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .settings-section {
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .settings-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .settings-section h3 {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--theme-text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        /* ÿ¥ÿ®ŸÉÿ© responsive ŸÑŸÑÿ•ÿπÿØÿßÿØÿßÿ™ */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        
        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .settings-content-wrapper {
                padding: 1.5rem;
            }
            
            .page-content {
                padding: 1rem;
            }
            
            .section-header {
                flex-direction: column;
                gap: 1rem;
            }
            
            .pos-search-box {
                max-width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑÿµŸÅÿ≠ÿßÿ™ */
        .page:not(#pos) {
            padding-bottom: 2rem;
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ¨ÿØÿßŸàŸÑ ŸÑŸÑÿ™ŸÖÿ±Ÿäÿ± ÿßŸÑÿ£ŸÅŸÇŸä */
        @media (max-width: 1200px) {
            .table-container {
                overflow-x: auto;
            }
        }

        .table-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .table-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, 
                #667eea 0%, 
                #764ba2 50%, 
                #f093fb 100%);
            border-radius: 12px;
            border: 2px solid transparent;
            background-clip: padding-box;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.5);
            transition: all 0.3s ease;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, 
                #f093fb 0%, 
                #764ba2 50%, 
                #667eea 100%);
            box-shadow: 0 0 16px rgba(102, 126, 234, 0.9);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: var(--primary-gradient);
            color: white;
            padding: 1rem;
            text-align: right;
            font-weight: 600;
            font-size: var(--font-size-base);
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: var(--font-size-base);
            color: var(--theme-text-primary);
        }

        .table tr:hover {
            background: rgba(255,255,255,0.05);
        }

        /* ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: var(--font-size-base);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--theme-bg-secondary);
            color: var(--theme-text-secondary);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn-secondary:hover {
            background: var(--theme-bg-card);
            color: var(--theme-text-primary);
        }

        .btn-success {
            background: var(--success-gradient);
            color: white;
        }

        .btn-warning {
            background: var(--warning-gradient);
            color: white;
        }

        .btn-danger {
            background: var(--danger-gradient);
            color: white;
        }

        .action-btn {
            padding: 0.5rem;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            margin: 0 0.25rem;
        }

        .edit-btn {
            background: var(--warning-gradient);
            color: white;
        }

        .delete-btn {
            background: var(--danger-gradient);
            color: white;
        }

        .view-btn {
            background: var(--primary-gradient);
            color: white;
        }

        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-md);
        }

        /* ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--theme-bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            text-align: center;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary-gradient);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            font-size: 2.8rem;
            margin-bottom: 1rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--theme-text-primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--theme-text-secondary);
            font-size: var(--font-size-base);
            font-weight: 500;
        }

        /* ÿ£ŸÜŸÖÿßÿ∑ ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ŸÑŸÑÿµŸäÿßŸÜÿ© */
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: var(--theme-text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-label i {
            color: var(--primary-color);
        }

        .info-value {
            color: var(--theme-text-primary);
            text-align: left;
        }

        /* üí∞ ÿ£ŸÜŸÖÿßÿ∑ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ */
        .expense-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--theme-border);
        }

        .expense-tab-btn {
            flex: 1;
            padding: 1.2rem 2rem;
            background: var(--theme-bg-secondary);
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--theme-text-secondary);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0;
        }

        .expense-tab-btn:hover {
            background: var(--theme-bg-hover);
            color: var(--theme-text-primary);
        }

        .expense-tab-btn.active {
            background: var(--theme-bg-card);
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }

        .expense-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .expense-tab-content.active {
            display: block;
        }

        /* ŸÅŸÑÿßÿ™ÿ± ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± */
        .reports-filters {
            display: flex;
            gap: 2rem;
            padding: 1.5rem;
            background: var(--theme-bg-secondary);
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .filter-group label {
            color: var(--theme-text-primary);
            font-weight: 600;
            white-space: nowrap;
        }

        .filter-group select,
        .filter-group input[type="date"] {
            padding: 0.7rem 1rem;
            background: var(--theme-bg-card);
            border: 1px solid var(--theme-border);
            border-radius: var(--border-radius-sm);
            color: var(--theme-text-primary);
            font-size: var(--font-size-base);
            min-width: 150px;
        }

        .filter-group select:focus,
        .filter-group input[type="date"]:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* ŸÉÿ±Ÿàÿ™ ŸÜŸàÿπ ÿßŸÑŸÖÿµÿ±ŸàŸÅ */
        .expense-type-card {
            background: var(--theme-bg-card);
            border: 1px solid var(--theme-border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .expense-type-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }

        .expense-type-icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
        }

        .expense-type-info h4 {
            color: var(--theme-text-primary);
            margin-bottom: 0.3rem;
            font-size: var(--font-size-md);
        }

        .expense-type-info p {
            color: var(--theme-text-tertiary);
            font-size: var(--font-size-sm);
        }

        /* ÿ¨ÿØÿßŸàŸÑ ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ */
        .expense-row-highlight {
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
        }

        .expense-amount-cell {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .expense-amount-positive {
            color: var(--success-color);
        }

        .expense-amount-negative {
            color: var(--danger-color);
        }

        /* ÿ¥ÿßÿ±ÿ© ŸÜŸàÿπ ÿßŸÑŸÖÿµÿ±ŸàŸÅ */
        .expense-type-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .expense-type-rent {
            background: rgba(139, 92, 246, 0.2);
            color: #8b5cf6;
        }

        .expense-type-utilities {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .expense-type-salary {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .expense-type-maintenance {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .expense-type-other {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
        }

        /* ÿ£ŸäŸÇŸàŸÜÿßÿ™ ŸÜŸàÿπ ÿßŸÑŸÖÿµÿ±ŸàŸÅ */
        .expense-icon-rent::before { content: 'üè†'; margin-left: 5px; }
        .expense-icon-utilities::before { content: '‚ö°'; margin-left: 5px; }
        .expense-icon-salary::before { content: 'üí∞'; margin-left: 5px; }
        .expense-icon-maintenance::before { content: 'üîß'; margin-left: 5px; }
        .expense-icon-other::before { content: 'üìù'; margin-left: 5px; }

        /* ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ© */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--theme-bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }

        .modal-content::-webkit-scrollbar {
            width: 10px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin: 8px 0;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, 
                #667eea 0%, 
                #764ba2 50%, 
                #f093fb 100%);
            border-radius: 12px;
            border: 2px solid transparent;
            background-clip: padding-box;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.5);
            transition: all 0.3s ease;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, 
                #f093fb 0%, 
                #764ba2 50%, 
                #667eea 100%);
            box-shadow: 0 0 16px rgba(102, 126, 234, 0.9);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* ÿ¨ÿπŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ© ŸÅŸä Ÿàÿ≥ÿ∑ ÿßŸÑÿµŸÅÿ≠ÿ© ÿπŸÖŸàÿØŸäÿßŸã Ÿàÿ£ŸÅŸÇŸäÿßŸã */
        .modal.active {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            margin: 0 auto;
            top: auto;
            left: auto;
            right: auto;
            bottom: auto;
            position: relative;
            transform: none;
            /* ŸÑŸÖŸÜÿπ ÿ™ÿ¨ÿßŸàÿ≤ ÿßŸÑÿ¥ÿßÿ¥ÿ© */
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--theme-text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--theme-text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: var(--danger-gradient);
            color: white;
        }

        /* ÿ™ÿ®ŸàŸäÿ®ÿßÿ™ ÿßŸÑÿ™ŸÅÿπŸäŸÑ */
        .activation-tab {
            transition: all 0.3s ease;
        }

        /* ÿßŸÑŸÜŸÖÿßÿ∞ÿ¨ */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--theme-text-primary);
            font-size: var(--font-size-base);
        }

        .form-input, .form-select {
            width: 100%;
            background: var(--theme-bg-secondary);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            padding: 0.75rem;
            color: var(--theme-text-primary);
            font-size: var(--font-size-base);
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* ÿπŸÜÿßÿµÿ± ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿ®ÿßŸÑÿ∑ÿ®ÿßÿπÿ© */
        .form-range {
            width: 100%;
            height: 6px;
            background: var(--theme-bg-secondary);
            border-radius: 10px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .form-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
            transition: all 0.2s ease;
        }

        .form-range::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.6);
        }

        .form-range::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
            transition: all 0.2s ease;
        }

        .form-range::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.6);
        }

        .form-control {
            width: 100%;
            background: var(--theme-bg-secondary);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            padding: 0.75rem;
            color: var(--theme-text-primary);
            font-size: 0.875rem;
            font-family: 'Cairo', sans-serif;
            transition: all 0.3s ease;
            resize: vertical;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        /* ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑŸÜÿ¨ÿßÿ≠ ŸàÿßŸÑÿÆÿ∑ÿ£ */
        .success-message {
            background: var(--success-gradient);
            color: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: center;
            margin-bottom: 1rem;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .error-message {
            background: var(--danger-gradient);
            color: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: center;
            margin-bottom: 1rem;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿµÿØŸäÿ± ŸàÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ */
        .export-import-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .export-btn, .import-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-btn {
            background: var(--success-gradient);
            color: white;
        }

        .import-btn {
            background: var(--warning-gradient);
            color: white;
        }

        .export-btn:hover, .import-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* ÿ£ŸäŸÇŸàŸÜÿßÿ™ ÿßŸÑŸÅÿ¶ÿßÿ™ */
        .category-icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .category-icon-btn {
            background: var(--theme-bg-secondary);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.5rem;
        }

        .category-icon-btn:hover,
        .category-icon-btn.selected {
            background: var(--primary-color);
            color: white;
            transform: scale(1.05);
        }

        /* ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ */
        .installment-form {
            background: var(--theme-bg-secondary);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-top: 2rem;
            display: none;
            border: 2px solid rgba(102, 126, 234, 0.2);
            animation: slideInUp 0.4s ease;
        }
        
        /* ÿÆŸäÿßÿ±ÿßÿ™ ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ */
        .payment-options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            padding: 1.5rem 0;
        }
        
        .payment-option-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--theme-bg-secondary);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius-lg);
            padding: 2.5rem 2rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: 200px;
            width: 100%;
        }
        
        .payment-option-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 0;
        }
        
        .payment-option-card:hover::before {
            opacity: 0.1;
        }
        
        .payment-option-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-color);
        }
        
        .payment-option-card.cash-payment:hover {
            border-color: var(--success-color);
        }
        
        .payment-option-card.installment-payment:hover {
            border-color: var(--warning-color);
        }
        
        .payment-option-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }
        
        .payment-option-card.cash-payment .payment-option-icon {
            background: var(--success-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .payment-option-card.installment-payment .payment-option-icon {
            background: var(--warning-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .payment-option-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--theme-text-primary);
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }
        
        .payment-option-description {
            font-size: 0.9rem;
            color: var(--theme-text-secondary);
            position: relative;
            z-index: 1;
        }
        
        /* ÿ±ÿ£ÿ≥ ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ */
        .installment-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }
        
        .installment-header i {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .installment-header h4 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--theme-text-primary);
            margin: 0;
        }
        
        /* ÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ */
        .form-section {
            background: var(--theme-bg-card);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        /* ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿπŸÖŸÑÿßÿ° */
        .search-customer-wrapper {
            position: relative;
        }
        
        .customer-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--theme-bg-card);
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            margin-top: 0.5rem;
        }
        
        .customer-search-results.active {
            display: block;
        }
        
        .customer-search-item {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .customer-search-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .customer-search-item:last-child {
            border-bottom: none;
        }
        
        .customer-search-name {
            font-weight: 600;
            color: var(--theme-text-primary);
            font-size: var(--font-size-base);
        }
        
        .customer-search-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: var(--font-size-sm);
            color: var(--theme-text-secondary);
        }
        
        .customer-search-info i {
            color: var(--primary-color);
        }
        
        .customer-search-debt {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: var(--font-size-sm);
            color: var(--danger-color);
            font-weight: 600;
        }
        
        .customer-search-empty {
            padding: 1.5rem;
            text-align: center;
            color: var(--theme-text-secondary);
            font-size: var(--font-size-sm);
        }
        
        .form-hint {
            display: block;
            margin-top: 0.5rem;
            font-size: var(--font-size-sm);
            color: var(--theme-text-secondary);
        }
        
        .form-hint i {
            margin-left: 0.25rem;
        }
        
        .section-title i {
            font-size: 1.1rem;
        }
        
        .form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .form-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        .form-hint {
            display: block;
            font-size: 0.75rem;
            color: var(--theme-text-secondary);
            margin-top: 0.35rem;
            font-style: italic;
        }
        
        .required {
            color: var(--danger-color);
            margin-right: 0.25rem;
        }
        
        /* ŸÖŸÑÿÆÿµ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ */
        .installment-summary {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid rgba(102, 126, 234, 0.3);
        }
        
        .summary-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--theme-text-primary);
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }
        
        .summary-title i {
            font-size: 1.3rem;
            color: var(--primary-color);
        }
        
        .summary-items {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .summary-row .summary-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            color: var(--theme-text-secondary);
        }
        
        .summary-row .summary-label i {
            width: 20px;
            text-align: center;
        }
        
        .summary-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            margin: 0.5rem 0;
        }
        
        .summary-row.total-row {
            background: rgba(102, 126, 234, 0.15);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-top: 0.5rem;
        }
        
        .summary-row.total-row .summary-label {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--theme-text-primary);
        }
        
        .summary-row.total-row .summary-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--primary-color);
        }
        
        .summary-row.monthly-row {
            background: var(--success-gradient);
            padding: 1rem;
            border-radius: var(--border-radius);
            color: white;
        }
        
        .summary-row.monthly-row .summary-label {
            font-size: 1rem;
            font-weight: 600;
            color: white;
        }
        
        .summary-row.monthly-row .summary-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
        }
        
        .summary-value.highlight {
            animation: pulse 2s infinite;
        }

        .installment-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿßŸÑÿ´ŸäŸÖ ÿßŸÑŸÅÿßÿ™ÿ≠ */
        [data-theme="light"] .payment-option-card {
            background: #ffffff;
            border: 2px solid #e2e8f0;
        }
        
        [data-theme="light"] .payment-option-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        [data-theme="light"] .form-section {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
        }
        
        [data-theme="light"] .installment-summary {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
            border: 2px solid rgba(102, 126, 234, 0.2);
        }
        
        @media (max-width: 768px) {
            .payment-options-container {
                grid-template-columns: 1fr;
            }
            
            .form-grid-2,
            .form-grid-3 {
                grid-template-columns: 1fr;
            }
        }

        /* ÿ™ÿµŸÖŸäŸÖ ŸÖÿ™ÿ¨ÿßŸàÿ® */
        @media (max-width: 1200px) {
            .pos-layout {
                grid-template-columns: 1fr 350px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
                transform: translateX(-100%);
                position: fixed;
                z-index: 100;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: block;
            }

            .pos-layout {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .search-input {
                width: 200px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* ÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä */
        @keyframes slideInLeft {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        @keyframes slideOutLeft {
            from { transform: translateX(0); }
            to { transform: translateX(-100%); }
        }

        .sidebar.animating-in {
            animation: slideInLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.animating-out {
            animation: slideOutLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© */
        .text-success { color: var(--success-color); }
        .text-warning { color: var(--warning-color); }
        .text-danger { color: var(--danger-color); }
        .text-muted { color: var(--theme-text-secondary); }

        .bg-success { background: var(--success-gradient); }
        .bg-warning { background: var(--warning-gradient); }
        .bg-danger { background: var(--danger-gradient); }

        .border-success { border-color: var(--success-color); }
        .border-warning { border-color: var(--warning-color); }
        .border-danger { border-color: var(--danger-color); }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ */
        .barcode-section {
            display: flex;
            gap: 0.5rem;
            align-items: end;
        }

        .barcode-input {
            flex: 1;
        }

        .generate-barcode-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .generate-barcode-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ */
        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: var(--theme-text-secondary);
        }

        .detail-value {
            font-weight: 500;
            color: var(--theme-text-primary);
        }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑŸÅŸÑÿßÿ™ÿ± */
        .filters-section {
            background: var(--theme-bg-card);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸäŸÜ */
        .debt-status {
            padding: 0.25rem 0.75rem;
            border-radius: var(--border-radius-lg);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .debt-status.active {
            background: var(--success-gradient);
            color: white;
        }

        .debt-status.overdue {
            background: var(--danger-gradient);
            color: white;
        }

        .debt-status.paid {
            background: var(--theme-bg-secondary);
            color: var(--theme-text-secondary);
        }
        
        /* ÿ¥ÿßÿ±ÿ© ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÖÿØŸÖÿ¨ÿ© */
        .merge-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: var(--border-radius);
            font-size: 0.7rem;
            font-weight: 600;
            margin-right: 0.5rem;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }
        
        .merge-badge i {
            font-size: 0.65rem;
        }
        
        /* ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´ */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--theme-bg-card);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: var(--border-radius-lg);
            margin-top: 0.75rem;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
            backdrop-filter: blur(20px);
        }
        
        .search-results.active {
            display: block;
            animation: searchResultsAppear 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes searchResultsAppear {
            from {
                opacity: 0;
                transform: translateY(-15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .search-results::-webkit-scrollbar {
            width: 8px;
        }
        
        .search-results::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin: 8px 0;
        }
        
        .search-results::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .search-results::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            box-shadow: 0 0 10px var(--primary-color);
        }
        
        .search-category {
            padding: 1rem 1.25rem 0.75rem;
            border-bottom: 2px solid rgba(255,255,255,0.05);
            background: rgba(102, 126, 234, 0.03);
        }
        
        .search-category:last-child {
            border-bottom: none;
        }
        
        .search-category-title {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .search-category-title i {
            font-size: 1rem;
        }
        
        .search-category-title .count {
            background: var(--primary-gradient);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-right: 0.25rem;
        }
        
        .search-result-item {
            padding: 1rem 1.25rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            position: relative;
            overflow: hidden;
        }
        
        .search-result-item::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            width: 3px;
            height: 100%;
            background: var(--primary-gradient);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .search-result-item:hover::before {
            transform: scaleY(1);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-item:hover {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%);
            transform: translateX(-4px);
            padding-right: 1.5rem;
        }
        
        .search-result-icon {
            width: 48px;
            height: 48px;
            min-width: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-gradient);
            border-radius: var(--border-radius);
            color: white;
            font-size: 1.25rem;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        
        .search-result-item:hover .search-result-icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        
        .search-result-info {
            flex: 1;
            min-width: 0;
        }
        
        .search-result-title {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--theme-text-primary);
            margin-bottom: 0.35rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color 0.3s ease;
        }
        
        .search-result-item:hover .search-result-title {
            color: var(--primary-color);
        }
        
        .search-result-subtitle {
            font-size: 0.8rem;
            color: var(--theme-text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            transition: color 0.3s ease;
        }
        
        .search-result-subtitle span {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .search-result-item:hover .search-result-subtitle {
            color: var(--theme-text-primary);
        }
        
        .search-result-badge {
            background: var(--theme-bg-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--theme-text-secondary);
            white-space: nowrap;
        }
        
        .search-result-item:hover .search-result-badge {
            background: rgba(255,255,255,0.1);
            color: var(--primary-color);
        }
        
        .search-empty {
            padding: 3rem 2rem;
            text-align: center;
            color: var(--theme-text-secondary);
        }
        
        .search-empty i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
            color: var(--primary-color);
        }
        
        .search-empty p {
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .search-header {
            padding: 1rem 1.25rem;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            background: var(--primary-gradient);
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .search-header i {
            margin-left: 0.5rem;
        }
        
        .search-total {
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿßŸÑÿ´ŸäŸÖ ÿßŸÑŸÅÿßÿ™ÿ≠ */
        [data-theme="light"] .search-results {
            background: #ffffff;
            border: 2px solid #e2e8f0;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        
        [data-theme="light"] .search-category {
            background: #f7fafc;
        }
        
        [data-theme="light"] .search-result-item:hover {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.03) 100%);
        }
        
        [data-theme="light"] .search-result-item:hover .search-result-title {
            color: var(--primary-color);
        }
        
        [data-theme="light"] .search-result-badge {
            background: #edf2f7;
            color: #4a5568;
        }
        
        [data-theme="light"] .search-result-item:hover .search-result-badge {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary-color);
        }
        
        .search-box {
            position: relative;
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿÆÿßÿµÿ© ÿ®ÿßŸÑÿ´ŸäŸÖ ÿßŸÑŸÅÿßÿ™ÿ≠ */
        [data-theme="light"] .form-input,
        [data-theme="light"] .form-select {
            background: #ffffff;
            border: 2px solid #cbd5e0;
            color: #000000;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .form-input:focus,
        [data-theme="light"] .form-select:focus {
            border-color: var(--primary-color);
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .form-input::placeholder {
            color: #718096;
            font-weight: 500;
        }
        
        [data-theme="light"] .form-label {
            color: #1a202c;
            font-weight: 700;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
        }
        
        [data-theme="light"] textarea.form-input {
            border: 2px solid #cbd5e0;
            background: #ffffff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] textarea.form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .stat-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: var(--shadow-md);
        }
        
        [data-theme="light"] .stat-card .stat-label {
            color: #000000;
            font-weight: 700;
        }
        
        [data-theme="light"] .stat-card .stat-value {
            color: #000000;
            font-weight: 800;
        }
        
        [data-theme="light"] .product-card {
            background: #ffffff;
            border: 1px solid #d8d8d8;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }
        
        [data-theme="light"] .product-card .product-name,
        [data-theme="light"] .product-card .product-price,
        [data-theme="light"] .product-card .product-info {
            color: #000000;
            font-weight: 700;
        }
        
        [data-theme="light"] .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }
        
        [data-theme="light"] .sidebar {
            background: #fafaf8;
            border-left: 1px solid #d8d8d8;
            box-shadow: -4px 0 12px rgba(0,0,0,0.06);
        }
        
        [data-theme="light"] .nav-btn {
            color: #4a4a4a;
        }
        
        [data-theme="light"] .nav-btn:hover {
            background: #ececea;
            color: var(--primary-color);
        }
        
        [data-theme="light"] .nav-btn.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
        
        [data-theme="light"] .top-bar {
            background: rgba(250, 250, 248, 0.95);
            border-bottom: 1px solid rgba(0,0,0,0.08);
            backdrop-filter: blur(25px);
        }
        
        [data-theme="light"] .modal-content {
            background: #ffffff;
            border: 1px solid #d8d8d8;
            box-shadow: var(--shadow-xl);
        }
        
        [data-theme="light"] .table {
            background: #ffffff;
        }
        
        [data-theme="light"] .table thead {
            background: #f5f5f0;
            border-bottom: 2px solid #d8d8d8;
        }
        
        [data-theme="light"] .table th {
            color: #000000;
            font-weight: 700;
        }
        
        [data-theme="light"] .table td {
            color: #1a1a1a;
            font-weight: 600;
            border-bottom: 1px solid #e2e8f0;
        }
        
        [data-theme="light"] .table tbody tr:hover {
            background: #f7fafc;
        }
        
        [data-theme="light"] .cart-item {
            background: #ffffff;
            border: 1px solid #e2e8f0;
        }
        
        [data-theme="light"] .cart-item:hover {
            background: #f7fafc;
            border-color: var(--primary-color);
        }
        
        [data-theme="light"] .search-input {
            background: #ffffff;
            border: 2px solid #e2e8f0;
            color: #1a202c;
        }
        
        [data-theme="light"] .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }
        
        [data-theme="light"] .category-btn {
            background: #ffffff;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }
        
        [data-theme="light"] .category-btn:hover {
            background: #edf2f7;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        [data-theme="light"] .category-btn.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-color: transparent;
        }
        
        [data-theme="light"] .action-btn {
            background: #f7fafc;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }
        
        [data-theme="light"] .action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: scale(1.1);
        }
        
        [data-theme="light"] .action-btn.delete-btn:hover {
            background: #fc8181;
            border-color: #fc8181;
        }
        
        [data-theme="light"] .summary-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: var(--shadow-md);
        }
        
        [data-theme="light"] .summary-row {
            color: #4a5568;
            border-bottom: 1px solid #e2e8f0;
        }
        
        [data-theme="light"] .summary-row.total {
            color: var(--primary-color);
            font-weight: bold;
            border-top: 2px solid var(--primary-color);
        }
        
        [data-theme="light"] .category-icon-btn {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            color: #4a5568;
        }
        
        [data-theme="light"] .category-icon-btn:hover {
            background: #edf2f7;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        [data-theme="light"] .category-icon-btn.selected {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-color: transparent;
        }
        
        [data-theme="light"] .toast {
            background: #ffffff;
            color: #1a202c;
            border: 1px solid #e2e8f0;
            box-shadow: var(--shadow-lg);
        }
        
        [data-theme="light"] .toast.success {
            background: #f0fff4;
            border-color: #9ae6b4;
            color: #22543d;
        }
        
        [data-theme="light"] .toast.error {
            background: #fff5f5;
            border-color: #fc8181;
            color: #742a2a;
        }
        
        [data-theme="light"] .toast.info {
            background: #ebf8ff;
            border-color: #90cdf4;
            color: #2c5282;
        }
        
        [data-theme="light"] .export-btn {
            background: #ffffff;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }
        
        [data-theme="light"] .export-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        [data-theme="light"] .debt-status.paid {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        [data-theme="light"] select option {
            background: #ffffff;
            color: #1a202c;
        }
        
        [data-theme="light"] textarea {
            background: #ffffff;
            border: 2px solid #e2e8f0;
            color: #1a202c;
        }
        
        [data-theme="light"] textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }
        
        /* ÿ£ŸÜŸÖÿßÿ∑ ÿÆÿßÿµÿ© ÿ®ÿµŸÅÿ≠ÿ© ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸäŸÜ */
        .card {
            background: var(--theme-bg-card);
            border: 1px solid var(--theme-border);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--theme-shadow);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        [data-theme="light"] .card {
            background: var(--theme-bg-card);
            border: 1px solid var(--theme-border);
            box-shadow: var(--theme-shadow);
        }
        
        [data-theme="light"] .card:hover {
            box-shadow: 0 12px 35px rgba(15, 23, 42, 0.12);
        }
        
        .installment-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .installment-status.paid {
            background: #d4edda;
            color: #155724;
        }
        
        .installment-status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .installment-status.overdue {
            background: #f8d7da;
            color: #721c24;
        }
        
        .payment-btn {
            background: var(--success-gradient);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }
        
        .payment-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(67, 233, 123, 0.4);
        }
        
        .payment-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑ */
        body.compact-mode .pos-layout {
            gap: 1rem;
        }

        body.compact-mode .products-section,
        body.compact-mode .cart-section {
            padding: 1rem;
        }

        body.compact-mode .section-header {
            margin-bottom: 1rem;
        }

        body.compact-mode .product-card {
            padding: 0.75rem;
        }

        body.compact-mode .cart-item {
            padding: 0.75rem;
        }

        body.compact-mode .stat-card {
            padding: 1rem;
        }

        /* ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑÿ±ÿ≥ŸàŸÖ ÿßŸÑŸÖÿ™ÿ≠ÿ±ŸÉÿ© */
        body.no-animations * {
            animation: none !important;
            transition: none !important;
        }

        body.no-animations .page.active {
            animation: none !important;
        }

        /* ÿØÿπŸÖ ÿßŸÑŸÑÿ∫ÿßÿ™ */
        body.rtl {
            direction: rtl;
        }

        body.ltr {
            direction: ltr;
        }

        body.ltr .sidebar {
            left: 0;
            right: auto;
        }

        body.ltr .main-content {
            margin-left: 280px;
            margin-right: 0;
        }

        body.ltr .pos-layout {
            grid-template-columns: 1fr 400px;
        }

        body.ltr .cart-section {
            border-right: none;
            border-left: 1px solid var(--border-color);
        }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ŸÖŸÜÿ™ŸÇŸäÿßÿ™ ÿßŸÑÿ£ŸÑŸàÿßŸÜ */
        input[type="color"] {
            cursor: pointer;
            border: 2px solid var(--border-color) !important;
            transition: all 0.3s ease;
        }

        input[type="color"]:hover {
            border-color: var(--primary-color) !important;
            transform: scale(1.05);
        }

        input[type="color"]:focus {
            outline: none;
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        /* ÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿßŸÑÿØŸäŸÜÿßŸÖŸäŸÉŸäÿ© */
        .btn-primary {
            background: var(--primary-gradient) !important;
        }

        .btn-success {
            background: var(--success-gradient) !important;
        }

        .btn-warning {
            background: var(--warning-gradient) !important;
        }

        .btn-danger {
            background: var(--danger-gradient) !important;
        }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ */
        .settings-card-icon.store-icon {
            background: linear-gradient(135deg, var(--success-color) 0%, rgba(34, 197, 94, 0.2) 100%);
        }

        .settings-card-icon.system-icon {
            background: linear-gradient(135deg, var(--primary-color) 0%, rgba(99, 102, 241, 0.2) 100%);
        }

        .settings-card-icon.backup-icon {
            background: linear-gradient(135deg, var(--info-color) 0%, rgba(59, 130, 246, 0.2) 100%);
        }

        .settings-card-icon.printing-icon {
            background: linear-gradient(135deg, var(--secondary-color) 0%, rgba(168, 85, 247, 0.2) 100%);
        }

        .settings-card-icon.security-icon {
            background: linear-gradient(135deg, var(--danger-color) 0%, rgba(239, 68, 68, 0.2) 100%);
        }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿ®ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿßŸÑÿØŸäŸÜÿßŸÖŸäŸÉŸäÿ© */
        .stat-card {
            border-top: 3px solid var(--primary-color);
        }

        .product-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.15);
        }

        .toast.success {
            background: linear-gradient(135deg, var(--success-color) 0%, rgba(16, 185, 129, 0.9) 100%);
        }

        .toast.error {
            background: linear-gradient(135deg, var(--danger-color) 0%, rgba(239, 68, 68, 0.9) 100%);
        }

        .toast.warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, rgba(245, 158, 11, 0.9) 100%);
        }

        .toast.info {
            background: linear-gradient(135deg, var(--info-color) 0%, rgba(59, 130, 246, 0.9) 100%);
        }

        /* ÿ£ÿ≤ÿ±ÿßÿ± ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ´ŸäŸÖÿßÿ™ */
        .theme-preview-btn {
            width: 100%;
            height: 60px;
            border: none;
            border-radius: 12px;
            font-size: 1.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-preview-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }

        .theme-preview-btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿπÿ±ÿ∂ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ© ŸÑŸÑÿ´ŸäŸÖÿßÿ™ */
        #themeSelect {
            background: var(--theme-bg-card);
            color: var(--theme-text-primary);
            border: 2px solid var(--theme-border);
            font-weight: 500;
        }

        #themeSelect:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        #themeSelect optgroup {
            background: var(--theme-bg-secondary);
            color: var(--theme-text-primary);
            font-weight: bold;
            padding: 0.5rem;
        }

        #themeSelect option {
            background: var(--theme-bg-card);
            color: var(--theme-text-primary);
            padding: 0.5rem;
        }

        /* ============================================
           ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ≠ŸÖÿßŸäÿ© ŸàÿßŸÑÿ£ŸÖÿßŸÜ - Digital Creativity
           ============================================ */

        /* ÿµŸÅÿ≠ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .login-container {
            background: var(--theme-bg-card);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.4s ease;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: var(--primary-gradient);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .login-logo i {
            font-size: 36px;
            color: white;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--theme-text-primary);
            margin-bottom: 8px;
        }

        .login-subtitle {
            font-size: 16px;
            color: var(--theme-text-secondary);
        }

        .login-form {
            margin-top: 30px;
        }

        .login-input-group {
            margin-bottom: 20px;
        }

        .login-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--theme-text-primary);
            font-size: 14px;
        }

        .login-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--theme-border);
            border-radius: 12px;
            font-size: 16px;
            background: var(--theme-bg-secondary);
            color: var(--theme-text-primary);
            transition: all 0.3s;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .login-button {
            width: 100%;
            padding: 14px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
        }

        .login-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ŸÑŸàÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ŸÖÿßŸÜ */
        .security-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        .security-panel.active {
            display: flex;
        }

        .security-content {
            background: var(--theme-bg-card);
            border-radius: 20px;
            width: 95%;
            max-width: 1200px;
            height: 90vh;
            max-height: 800px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            animation: slideUp 0.4s ease;
        }

        .security-header {
            padding: 25px 30px;
            background: var(--primary-gradient);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .security-title {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .security-close {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .security-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .security-tabs {
            display: flex;
            gap: 8px;
            padding: 20px 30px 0;
            background: var(--theme-bg-secondary);
            border-bottom: 2px solid var(--theme-border);
        }

        .security-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--theme-text-secondary);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 12px 12px 0 0;
            transition: all 0.3s;
        }

        .security-tab:hover {
            background: var(--theme-bg-hover);
            color: var(--theme-text-primary);
        }

        .security-tab.active {
            background: var(--theme-bg-card);
            color: var(--primary-color);
        }

        .security-body {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: var(--theme-bg-secondary);
        }

        .security-section {
            background: var(--theme-bg-card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid var(--theme-border);
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--theme-text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .users-table thead {
            background: var(--theme-bg-secondary);
        }

        .users-table th {
            padding: 14px 12px;
            text-align: right;
            font-weight: 600;
            color: var(--theme-text-primary);
            font-size: 14px;
            border-bottom: 2px solid var(--theme-border);
        }

        .users-table td {
            padding: 14px 12px;
            text-align: right;
            color: var(--theme-text-secondary);
            border-bottom: 1px solid var(--theme-border);
        }

        .users-table tr:hover {
            background: var(--theme-bg-hover);
        }

        .user-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-admin {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .badge-user {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .status-active {
            color: var(--success-color);
            font-weight: 600;
        }

        .status-inactive {
            color: var(--danger-color);
            font-weight: 600;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            margin-left: 6px;
            transition: all 0.2s;
        }

        .btn-edit {
            background: var(--info-color);
            color: white;
        }

        .btn-edit:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-delete {
            background: var(--danger-color);
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-add-user {
            background: var(--success-gradient);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-add-user:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .permission-card {
            background: var(--theme-bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--theme-border);
        }

        .permission-card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--theme-text-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .permission-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--theme-border);
        }

        .permission-item:last-child {
            border-bottom: none;
        }

        .permission-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }

        .permission-label {
            font-size: 14px;
            color: var(--theme-text-secondary);
            cursor: pointer;
            flex: 1;
        }

        /* Modal ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ¨ÿØŸäÿØ/ÿßŸÑÿ™ÿπÿØŸäŸÑ */
        .user-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .user-modal.active {
            display: flex;
        }

        .user-modal-content {
            background: var(--theme-bg-card);
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: slideUp 0.3s ease;
        }

        .user-modal-header {
            padding: 25px 30px;
            background: var(--primary-gradient);
            color: white;
            border-radius: 20px 20px 0 0;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .user-modal-title {
            font-size: 22px;
            font-weight: 700;
        }

        .user-modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--theme-text-primary);
            font-size: 14px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--theme-border);
            border-radius: 12px;
            font-size: 15px;
            background: var(--theme-bg-secondary);
            color: var(--theme-text-primary);
            transition: all 0.3s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--theme-border);
        }

        .btn-secondary {
            padding: 12px 24px;
            background: var(--theme-bg-secondary);
            border: 2px solid var(--theme-border);
            border-radius: 12px;
            color: var(--theme-text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: var(--theme-bg-hover);
        }

        .btn-primary {
            padding: 12px 24px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ responsive */
        @media (max-width: 768px) {
            .security-content {
                width: 100%;
                height: 100%;
                max-height: none;
                border-radius: 0;
            }

            .permissions-grid {
                grid-template-columns: 1fr;
            }

            .users-table {
                font-size: 13px;
            }

            .users-table th,
            .users-table td {
                padding: 10px 8px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <!-- ÿ™ÿ≠ÿ≥ŸäŸÜ ÿÆÿ∑Ÿàÿ∑ ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä ŸàÿßŸÑÿ≥ŸÑÿ© -->
  <style>
  /* ÿ¨ÿπŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿÆÿ∑Ÿàÿ∑ ŸàÿßŸÑŸÜÿµŸàÿµ ŸÖÿ™Ÿàÿ≥ÿ∑ÿ© ŸàŸàÿßÿ∂ÿ≠ÿ© ŸÅŸä ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÜÿßÿµÿ± ŸàÿßŸÑÿ¨ÿØÿßŸàŸÑ ŸàÿßŸÑÿµŸÅÿ≠ÿßÿ™ */
  body, html, table, th, td, input, select, button, label, .form-control, .modal, .cart, .product-card, .details-section, .detail-row, .info-row, .product-header, .product-name, .product-category, .product-actions, .empty-state {
      font-size: 1.08em !important;
      font-weight: 600 !important;
      letter-spacing: 0.2px;
  }

  /* ÿ™ŸÉÿ®Ÿäÿ± ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ŸÅŸä ÿßŸÑÿ¨ÿØÿßŸàŸÑ ŸàÿßŸÑÿπŸÜÿßÿµÿ± */
  .table td, .table th, .product-card .info-value, .cart .item-qty, .cart .item-price, .detail-value, .stock, .price {
      font-size: 1.18em !important;
      font-weight: 800 !important;
  }

  /* ÿ™ŸÉÿ®Ÿäÿ± ÿπŸÜÿßŸàŸäŸÜ ÿßŸÑÿ¨ÿØÿßŸàŸÑ ŸàÿßŸÑÿµŸÅÿ≠ÿßÿ™ */
  h1, h2, h3, h4, h5, h6, .modal-title, .page-title {
      font-size: 2em !important;
      font-weight: 900 !important;
  }

  /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿÆÿ∑Ÿàÿ∑ ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä */
  .sidebar, .sidebar-menu, .sidebar .menu-item, .sidebar .menu-link {
      font-size: 1.22em !important;
      font-weight: 800 !important;
      letter-spacing: 0.5px;
  }

  /* ÿ™ŸÉÿ®Ÿäÿ± ÿπŸÜÿßÿµÿ± ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä ŸÖÿπ ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑÿ™ŸÜÿ≥ŸäŸÇ */
  .nav-menu {
      font-size: 1.25rem !important; /* ÿ≤ŸäÿßÿØÿ© ÿ≠ÿ¨ŸÖ ÿßŸÑÿÆÿ∑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä */
      font-family: 'Tajawal', 'Cairo', 'Segoe UI', Arial, sans-serif !important;
  }
  .nav-section-title {
      font-size: 1.35rem !important;
      font-weight: bold !important;
      margin-bottom: 0.5em !important;
      letter-spacing: 0.5px;
  }
  .nav-item {
      margin-bottom: 0.25em !important;
  }
  .nav-link {
      font-size: 1.18rem !important;
      font-weight: 500 !important;
      display: flex;
      align-items: center;
      gap: 0.5em;
      padding: 0.5em 0.75em !important;
      border-radius: 8px !important;
      transition: background 0.2s;
  }
  .nav-link.active,
  .nav-link:hover {
      background: #f3f4f6 !important;
      color: #0f172a !important;
  }
  .nav-icon {
      font-size: 1.5em !important;
      min-width: 1.5em;
      text-align: center;
  }
  .nav-text {
      font-size: 1.15em !important;
      font-weight: 500 !important;
  }
  /* ÿπŸÜÿßÿµÿ± ÿßŸÑÿ≠ŸÖÿßŸäÿ© Ÿàÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ */
  #securityNavItem .nav-link,
  #logoutNavItem .nav-link {
      font-size: 1.18rem !important;
      font-weight: 600 !important;
  }

  /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿÆÿ∑Ÿàÿ∑ ÿßŸÑÿ≥ŸÑÿ© */
  .cart, .cart-list, .cart-item, .cart .item-name, .cart .item-qty, .cart .item-price {
      font-size: 1.08em !important;
      font-weight: 600 !important;
      letter-spacing: 0.2px;
  }
  </style>
  <!-- ÿ™ŸÉÿ®Ÿäÿ± ÿπŸÜÿßÿµÿ± ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿπŸÑŸàŸä (top-bar-stats) -->
  <style>
  /* ÿ™ŸÉÿ®Ÿäÿ± ÿπŸÜÿßÿµÿ± ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿπŸÑŸàŸä (top-bar-stats) */
  .top-bar-stats, .top-bar-stats .quick-stat-card {
      min-height: 70px;
  }
  .top-bar-stats .quick-stat-card {
      padding: 0.7em 1.2em !important;
      border-radius: 12px !important;
      margin: 0 0.3em !important;
      display: flex;
      align-items: center;
      gap: 1em;
  }

  /* --- ÿ™ÿÆÿµŸäÿµ ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿØÿßÿÆŸÑ ÿßŸÑÿ≥ŸÑÿ© --- */
.cart-items {
  display: grid !important;
  grid-template-columns: repeat(2, 1fr) !important;
  gap: 0.7em 0.5em !important;
}
.cart-item {
  min-width: 0;
  max-width: 100%;
  font-size: 0.97rem !important;
  padding: 0.45em 0.5em !important;
  margin-bottom: 0.3em !important;
}
.cart-item .item-header h4,
.cart-item .item-info h4 {
  font-size: 1em !important;
}
.cart-item .item-price,
.cart-item .item-total {
  font-size: 0.98em !important;
}
.cart-item .quantity-controls {
  font-size: 0.97em !important;
}
/* --- ÿ™ŸÉÿ®Ÿäÿ± ŸÜÿµŸàÿµ ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÅÿ±ÿπŸä ŸàÿßŸÑÿÆÿµŸÖ ŸàÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ© ŸàÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸàÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ŸàÿßŸÑÿØŸäŸÜÿßÿ± --- */
.cart-summary .summary-row span:first-child {
  font-size: 1.18em !important;
  font-weight: 600 !important;
}
.cart-summary .summary-value {
  font-size: 1.25em !important;
  font-weight: bold !important;
  color: #0d9488 !important;
  letter-spacing: 0.5px;
}
.cart-summary .total .summary-value {
  font-size: 1.35em !important;
  color: #d97706 !important;
}
.cart-summary .total span:first-child {
  font-size: 1.22em !important;
  color: #d97706 !important;
}
.cart-summary .summary-value {
  direction: ltr;
  unicode-bidi: embed;
}
  .top-bar-stats .quick-stat-icon {
      font-size: 2.1em !important;
      width: 2.2em;
      height: 2.2em;
      display: flex;
      align-items: center;
      justify-content: center;
  }
  .top-bar-stats .quick-stat-label {
      font-size: 1.18em !important;
      font-weight: 800 !important;
      letter-spacing: 0.2px;
  }
  .top-bar-stats .quick-stat-value {
      font-size: 1.35em !important;
      font-weight: 900 !important;
      margin-top: 0.1em;
  }
  /* ÿ™ŸÉÿ®Ÿäÿ± ÿßŸÑÿ≥ÿßÿπÿ© ÿßŸÑÿ±ŸÇŸÖŸäÿ© */
  .top-bar-stats .digital-clock-card {
      min-width: 170px;
      padding: 0.7em 1.2em !important;
  }
  .top-bar-stats .digital-clock .clock-time {
      font-size: 1.45em !important;
      font-weight: 900 !important;
      letter-spacing: 0.2px;
  }
  .top-bar-stats .digital-clock .clock-date {
      font-size: 1.08em !important;
      font-weight: 700 !important;
  }


  /* ========================================
   ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ ÿßŸÑÿ¨ÿ≤ÿ¶Ÿä - Partial Payment
   ======================================== */

.installment-status.partially_paid {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
    display: inline-block;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}

/* ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿ±ÿ≠ŸäŸÑ - Carryforward Info */
.carryforward-info {
    background: #fef3c7;
    border-left: 4px solid #f59e0b;
    padding: 10px 15px;
    margin: 10px 0;
    border-radius: 8px;
    font-size: 0.9em;
}

.carryforward-info i {
    color: #f59e0b;
    margin-left: 8px;
}

/* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© */
.amount-breakdown {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.amount-breakdown .original {
    color: #6b7280;
    font-size: 0.85em;
}

.amount-breakdown .carryforward {
    color: #f59e0b;
    font-size: 0.85em;
    font-weight: 600;
}

.amount-breakdown .total {
    font-weight: bold;
    color: #1f2937;
}
  </style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body data-theme="dark">
  <!-- ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖÿÆÿµÿµ -->
  <div class="custom-titlebar">
   <div class="titlebar-left">
    <div class="titlebar-controls">
    <button class="titlebar-btn close" title="ÿ•ÿ∫ŸÑÿßŸÇ" onclick="window.electronAPI.windowClose()">
     <i class="fas fa-times"></i>
    </button>
    <button class="titlebar-btn maximize" title="ÿ™ŸÉÿ®Ÿäÿ±">
     <i class="fas fa-window-maximize"></i>
    </button>
    <button class="titlebar-btn minimize" title="ÿ™ÿµÿ∫Ÿäÿ±" onclick="window.electronAPI.windowMinimize()">
     <i class="fas fa-window-minimize"></i>
    </button>
    </div>
    <button class="titlebar-refresh" onclick="refreshApp()" title="ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©">
     <i class="fas fa-sync-alt"></i>
     <span>ÿ™ÿ≠ÿØŸäÿ´</span>
    </button>
    <button class="titlebar-refresh" onclick="toggleThemeQuick()" title="ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÖÿ∏Ÿáÿ±" style="margin-right: 0.5rem;">
     <i class="fas fa-palette"></i>
     <span>ÿßŸÑÿ´ŸäŸÖ</span>
    </button>
   </div>
   
   <div class="titlebar-center">
    <div class="titlebar-logo">üíº</div>
    <span class="titlebar-title">ŸÜÿ∏ÿßŸÖ ŸÜŸÇÿßÿ∑ ÿßŸÑÿ®Ÿäÿπ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ - ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿ•ÿ®ÿØÿßÿπ ÿßŸÑÿ±ŸÇŸÖŸä</span>
    <div class="titlebar-clock">
     <i class="fas fa-clock"></i>
     <span id="titlebarClock">00:00:00</span>
    </div>
   </div>
   
    <div class="titlebar-right">
    </div>
  </div>
  
  <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ -->
  <div id="appLoader" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--theme-bg-primary);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    transition: opacity 0.5s ease;
  ">
    <div style="text-align: center;">
      <div style="
        width: 80px;
        height: 80px;
        border: 4px solid rgba(99, 102, 241, 0.3);
        border-top: 4px solid #6366f1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      "></div>
      <h2 style="color: var(--theme-text-primary); margin-bottom: 10px;">ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ...</h2>
      <p id="loaderStatus" style="color: var(--theme-text-secondary); font-size: 14px;">ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ</p>
    </div>
  </div>
  
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  
  
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- üîê ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ≥ÿ±Ÿäÿπ ŸÑŸÑŸÜÿ≥ÿÆ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="quickRegistrationModal" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 999999;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px);
  ">
    <div style="
      background: var(--theme-bg-card);
      border-radius: 24px;
      padding: 2.5rem;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 25px 80px rgba(0,0,0,0.5);
      animation: modalSlideIn 0.3s ease;
      position: relative;
    ">
      <!-- ÿ≤ÿ± ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ -->
      <button onclick="closeQuickRegistrationModal()" style="
        position: absolute;
        top: 1rem;
        left: 1rem;
        background: transparent;
        border: none;
        color: var(--theme-text-secondary);
        font-size: 1.5rem;
        cursor: pointer;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      " onmouseover="this.style.background='var(--theme-bg-hover)'" onmouseout="this.style.background='transparent'">
        <i class="fas fa-times"></i>
      </button>

      <!-- ÿßŸÑÿπŸÜŸàÿßŸÜ -->
      <div style="text-align: center; margin-bottom: 2rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üîê</div>
        <h2 style="color: var(--theme-text-primary); font-size: 1.75rem; margin-bottom: 0.5rem;">
          ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÑŸÑŸÜÿ≥ÿÆ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä
        </h2>
        <p style="color: var(--theme-text-secondary); font-size: 0.95rem; line-height: 1.6;">
          ŸÑŸÑÿßÿ≥ÿ™ŸÅÿßÿØÿ© ŸÖŸÜ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿå Ÿäÿ¨ÿ® ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ£ŸàŸÑÿßŸã
        </p>
      </div>

      <!-- ÿ±ÿ≥ÿßŸÑÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ -->
      <div style="background: rgba(59, 130, 246, 0.1); border-right: 4px solid #3b82f6; padding: 1rem; border-radius: 12px; margin-bottom: 2rem;">
        <p style="color: var(--theme-text-primary); line-height: 1.6; margin: 0; font-size: 0.9rem;">
          <strong>üì± ŸÖŸÑÿßÿ≠ÿ∏ÿ©:</strong> ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ®ŸÉ ÿ•ŸÑŸâ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿπÿ®ÿ± Ÿàÿßÿ™ÿ≥ÿßÿ®. ÿ≥ÿ™ÿ™ŸÑŸÇŸâ ÿ±ŸÖÿ≤ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿÆŸÑÿßŸÑ 24 ÿ≥ÿßÿπÿ©.
        </p>
      </div>

      <!-- ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ -->
      <form id="quickRegisterForm" onsubmit="handleQuickRegisterSubmit(event); return false;">
        <!-- ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ±ÿ®ÿßÿπŸä -->
        <div style="margin-bottom: 1.5rem;">
          <label style="display: block; color: var(--theme-text-primary); font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;">
            <i class="fas fa-user"></i> ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ±ÿ®ÿßÿπŸä
          </label>
          <input 
            type="text" 
            id="quickRegisterFullName" 
            required
            placeholder="ŸÖÿ´ÿßŸÑ: ÿ£ÿ≠ŸÖÿØ ŸÖÿ≠ŸÖÿØ ÿπŸÑŸä ÿ≠ÿ≥ŸÜ"
            style="
              width: 100%;
              padding: 1rem;
              border-radius: 12px;
              border: 2px solid rgba(102, 126, 234, 0.3);
              background: var(--theme-bg-secondary);
              color: var(--theme-text-primary);
              font-size: 1rem;
              transition: border 0.3s ease;
            "
            onfocus="this.style.borderColor='#667eea'"
            onblur="this.style.borderColor='rgba(102, 126, 234, 0.3)'"
          >
        </div>

        <!-- ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ -->
        <div style="margin-bottom: 2rem;">
          <label style="display: block; color: var(--theme-text-primary); font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;">
            <i class="fas fa-phone"></i> ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ
          </label>
          <input 
            type="tel" 
            id="quickRegisterPhone" 
            required
            placeholder="ŸÖÿ´ÿßŸÑ: 07701234567"
            pattern="[0-9]{11}"
            style="
              width: 100%;
              padding: 1rem;
              border-radius: 12px;
              border: 2px solid rgba(102, 126, 234, 0.3);
              background: var(--theme-bg-secondary);
              color: var(--theme-text-primary);
              font-size: 1rem;
              direction: ltr;
              text-align: right;
              transition: border 0.3s ease;
            "
            onfocus="this.style.borderColor='#667eea'"
            onblur="this.style.borderColor='rgba(102, 126, 234, 0.3)'"
          >
          <small style="color: var(--theme-text-secondary); font-size: 0.85rem; margin-top: 0.5rem; display: block;">
            ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ ŸÖŸÉŸàŸÜ ŸÖŸÜ 11 ÿ±ŸÇŸÖ (07XX XXX XXXX)
          </small>
        </div>

        <!-- ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± -->
        <div style="display: flex; gap: 1rem;">
          <button 
            type="button"
            onclick="closeQuickRegistrationModal()"
            style="
              flex: 1;
              padding: 1rem;
              border-radius: 12px;
              border: 2px solid var(--theme-border);
              background: transparent;
              color: var(--theme-text-primary);
              font-size: 1rem;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s ease;
            "
            onmouseover="this.style.background='var(--theme-bg-hover)'"
            onmouseout="this.style.background='transparent'"
          >
            <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
          </button>

          <button 
            type="submit"
            id="quickRegisterBtn"
            style="
              flex: 2;
              padding: 1rem;
              border-radius: 12px;
              border: none;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              font-size: 1rem;
              font-weight: 600;
              cursor: pointer;
              transition: transform 0.2s ease, box-shadow 0.2s ease;
              box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            "
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'"
          >
            <i class="fas fa-paper-plane"></i> ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
          </button>
        </div>
      </form>
    </div>
  </div>

  <style>
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
  </style>

  <div class="animated-bg"></div>
  <div class="app-container"><!-- ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä -->
   <nav class="sidebar" id="sidebar"><button class="sidebar-toggle" id="sidebarToggle"> <i class="fas fa-angle-double-right"></i> </button>
        <!-- ŸÖÿ±ÿ®ÿπ ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä (Ÿäÿ∏Ÿáÿ± ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÅŸÇÿ∑) -->
        <div id="sidebarSearchBoxWrapper" style="display:none; padding: 10px 16px 0 16px;">
            <div class="search-box" style="margin-bottom: 10px;">
                <input type="text" class="search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÇŸàÿßÿ¶ŸÖ..." id="sidebarSearchInput" onkeyup="filterSidebarNavItems()">
                <i class="fas fa-search search-icon"></i>
            </div>
        </div>
    <div class="nav-menu">
     <div class="nav-section">
    <div class="nav-section-title">ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™</div>
    <div class="nav-item" id="posNavItem"><a class="nav-link active" onclick="showPage('pos')"> <i class="fas fa-cash-register nav-icon"></i> <span class="nav-text">ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ</span> </a></div>
    <div class="nav-item" id="invoicesNavItem"><a class="nav-link" onclick="showPage('invoices')"> <i class="fas fa-receipt nav-icon"></i> <span class="nav-text">ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±</span> </a></div>
    <div class="nav-item" id="receiptsManagementNavItem"><a class="nav-link" onclick="showPage('receiptsManagement')"> <i class="fas fa-file-invoice-dollar nav-icon"></i> <span class="nav-text">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ŸäÿµÿßŸÑÿßÿ™</span> </a></div>
     </div>
     <div class="nav-section">
    <div class="nav-section-title">ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</div>
    <div class="nav-item" id="productsNavItem"><a class="nav-link" onclick="showPage('products')"> <i class="fas fa-boxes nav-icon"></i> <span class="nav-text">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</span> </a></div>
    <div class="nav-item" id="inventoryNavItem"><a class="nav-link" onclick="showPage('inventory')"> <i class="fas fa-warehouse nav-icon"></i> <span class="nav-text">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿÆÿ≤ŸÜ</span> </a></div>
    <div class="nav-item" id="maintenanceNavItem"><a class="nav-link" onclick="showPage('maintenance')"> <i class="fas fa-tools nav-icon"></i> <span class="nav-text">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸäÿßŸÜÿ©</span> </a></div>
    <div class="nav-item" id="sparePartsNavItem"><a class="nav-link" onclick="showPage('spareParts')"> <i class="fas fa-cogs nav-icon"></i> <span class="nav-text">ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ±</span> </a></div>
    <div class="nav-item" id="deliveredDevicesNavItem"><a class="nav-link" onclick="showPage('deliveredDevices')"> <i class="fas fa-check-double nav-icon"></i> <span class="nav-text">ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ©</span> </a></div>
     </div>
     <div class="nav-section">
    <div class="nav-section-title">ÿßŸÑŸÖÿßŸÑŸäÿ©</div>
    <div class="nav-item" id="debtsNavItem"><a class="nav-link" onclick="showPage('debts')"> <i class="fas fa-credit-card nav-icon"></i> <span class="nav-text">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿØŸäŸàŸÜ</span> </a></div>
    <div class="nav-item" id="paymentsNavItem"><a class="nav-link" onclick="showPage('payments')"> <i class="fas fa-hand-holding-usd nav-icon"></i> <span class="nav-text">ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™</span> </a></div>
    <div class="nav-item" id="expensesNavItem"><a class="nav-link" onclick="showPage('expenses')"> <i class="fas fa-money-bill-wave nav-icon"></i> <span class="nav-text">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ</span> </a></div>
     </div>
        <div class="nav-item" id="reportsNavItem"><a class="nav-link" onclick="window.reportsManager && window.reportsManager.openReportsModal ? window.reportsManager.openReportsModal() : alert('ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±')"> <i class="fas fa-chart-bar nav-icon"></i> <span class="nav-text">ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±</span> </a></div>
     <div class="nav-section">
    <div class="nav-section-title">ÿßŸÑŸÜÿ∏ÿßŸÖ</div>
    <div class="nav-item" id="printerNavItem"><a class="nav-link" onclick="showPage('printer')"> <i class="fas fa-print nav-icon"></i> <span class="nav-text">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ∑ÿßÿ®ÿπÿ©</span> </a></div>
    <div class="nav-item" id="settingsNavItem"><a class="nav-link" onclick="showPage('settings')"> <i class="fas fa-cog nav-icon"></i> <span class="nav-text">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©</span> </a></div>

    <!-- <div class="nav-item" id="systemManagementNavItem">
        <a class="nav-link" onclick="openSystemManagement()" style="cursor: pointer;">
            <i class="fas fa-tools nav-icon" style="color:#f59e0b"></i>
            <span class="nav-text">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ŸàÿßŸÑÿ•ÿµŸÑÿßÿ≠</span>
        </a>
    </div> -->
     </div>
            <div class="nav-item" id="securityNavItem" style="display:none">
                <a class="nav-link" onclick="window.securityManager && window.securityManager.openSecurityPanel ? window.securityManager.openSecurityPanel() : alert('ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ≠ŸÖÿßŸäÿ©')">
                    <i class="fas fa-shield-alt nav-icon" style="color:#ef4444"></i>
                    <span class="nav-text">ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ≠ŸÖÿßŸäÿ© ŸàÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™</span>
                </a>
            </div>
            <div class="nav-item" id="logoutNavItem" style="display:none">
                <a class="nav-link" onclick="window.securityManager && window.securityManager.logout ? window.securityManager.logout() : alert('ÿ™ÿπÿ∞ÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨')">
                    <i class="fas fa-sign-out-alt nav-icon" style="color:#ef4444"></i>
                    <span class="nav-text">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</span>
                </a>
            </div>
    <script>
    // ÿØÿßŸÑÿ© ŸÖÿ±ŸÉÿ≤Ÿäÿ© ŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä
    window.applyPermissionVisibility = function() {
        const map = [
            {id: 'posNavItem', perm: 'sales_view'},
            {id: 'invoicesNavItem', perm: 'sales_view'},
            {id: 'productsNavItem', perm: 'products_view'},
            {id: 'inventoryNavItem', perm: 'inventory_view'},
            {id: 'debtsNavItem', perm: 'debts_view'},
            {id: 'paymentsNavItem', perm: 'debts_view'},
            {id: 'expensesNavItem', perm: 'settings_view'},
            {id: 'reportsNavItem', perm: 'reports_view'},
            {id: 'printerNavItem', perm: 'settings_view'},
            {id: 'settingsNavItem', perm: 'settings_view'}
        ];
        if (!window.securityManager) return;
        // ÿ•ÿ∏Ÿáÿßÿ± ÿ£Ÿà ÿ•ÿÆŸÅÿßÿ° ÿπŸÜÿßÿµÿ± ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä ÿ≠ÿ≥ÿ® ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        map.forEach(item => {
            const el = document.getElementById(item.id);
            if (el) {
                if (window.securityManager.hasPermission(item.perm)) {
                    el.style.display = '';
                } else {
                    el.style.display = 'none';
                }
            }
        });
        // ÿ≤ÿ± ÿßŸÑÿ≠ŸÖÿßŸäÿ© Ÿàÿ≤ÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿ®ŸáŸÖÿß ŸÖŸÜ updateSidebarButtons

        // ÿ•ÿ∏Ÿáÿßÿ± ŸÖÿ±ÿ®ÿπ ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÅŸÇÿ∑ (ŸàŸÑŸäÿ≥ ÿßŸÑÿ£ÿØŸÖŸÜ/ÿßŸÑŸÖÿØŸäÿ±)
        const searchBoxWrapper = document.getElementById('sidebarSearchBoxWrapper');
        if (searchBoxWrapper) {
            const user = window.securityManager.currentUser;
            if (user && user.role && user.role !== 'admin' && user.role !== 'manager') {
                searchBoxWrapper.style.display = '';
            } else {
                searchBoxWrapper.style.display = 'none';
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜÿØ ÿßŸÑÿ•ÿÆŸÅÿßÿ°
                const input = document.getElementById('sidebarSearchInput');
                if (input) input.value = '';
                if (typeof filterSidebarNavItems === 'function') filterSidebarNavItems();
            }
        }
        // ÿ•ÿπÿßÿØÿ© ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÅŸÑÿ™ÿ±ÿ© ÿ®ÿπÿØ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
        if (typeof filterSidebarNavItems === 'function') filterSidebarNavItems();
    };
        // ÿØÿßŸÑÿ© ŸÅŸÑÿ™ÿ±ÿ© ÿπŸÜÿßÿµÿ± ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ®ÿ≠ÿ´
        window.filterSidebarNavItems = function() {
            const input = document.getElementById('sidebarSearchInput');
            const filter = input ? input.value.trim() : '';
            const navItems = document.querySelectorAll('.nav-menu .nav-item');
            if (!input || !navItems) return;
            navItems.forEach(item => {
                // ÿ™ÿ¨ÿßŸáŸÑ ÿπŸÜÿßÿµÿ± ÿßŸÑÿ≠ŸÖÿßŸäÿ©/ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
                if (item.id === 'securityNavItem' || item.id === 'logoutNavItem') return;
                // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑŸáÿ∞ÿß ÿßŸÑÿπŸÜÿµÿ±
                let perm = null;
                switch(item.id) {
                    case 'posNavItem': perm = 'sales_view'; break;
                    case 'invoicesNavItem': perm = 'sales_view'; break;
                    case 'productsNavItem': perm = 'products_view'; break;
                    case 'inventoryNavItem': perm = 'inventory_view'; break;
                    case 'debtsNavItem': perm = 'debts_view'; break;
                    case 'paymentsNavItem': perm = 'debts_view'; break;
                    case 'expensesNavItem': perm = 'settings_view'; break;
                    case 'reportsNavItem': perm = 'reports_view'; break;
                    case 'printerNavItem': perm = 'settings_view'; break;
                    case 'settingsNavItem': perm = 'settings_view'; break;
                }
                const hasPerm = perm ? (window.securityManager && window.securityManager.hasPermission(perm)) : true;
                const text = item.innerText || '';
                if (hasPerm && (!filter || text.includes(filter))) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        };
    // ÿßÿ≥ÿ™ÿØÿπŸê ÿßŸÑÿØÿßŸÑÿ© ÿ®ÿπÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ/ÿßŸÑÿÆÿ±Ÿàÿ¨
    if (window.securityManager) {
        const origLogin = window.securityManager.handleLogin;
        window.securityManager.handleLogin = function() {
            const res = origLogin.apply(this, arguments);
            window.applyPermissionVisibility();
            return res;
        };
        const origLogout = window.securityManager.logout;
        window.securityManager.logout = function() {
            const res = origLogout.apply(this, arguments);
            window.applyPermissionVisibility();
            return res;
        };
        window.addEventListener('DOMContentLoaded', window.applyPermissionVisibility);
    }
    </script>
    </div>
   </nav><!-- ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä -->
   <main class="main-content"><!-- ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÑŸàŸä -->
    <div class="top-bar">
     <h1 class="page-title" id="currentPageTitle">ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ</h1>
     
     <!-- ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸàÿßŸÑÿ≥ÿßÿπÿ© ŸÅŸä ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÑŸàŸä -->
     <div class="top-bar-stats">
        <!-- ÿßŸÑÿ≥ÿßÿπÿ© ÿßŸÑÿ±ŸÇŸÖŸäÿ© -->
        <div class="quick-stat-card digital-clock-card">
          <div class="digital-clock">
            <div class="clock-time" id="digitalClockTime">00:44:03</div>
            <div class="clock-date">
              <span id="digitalClockDay">ÿßŸÑÿÆŸÖŸäÿ≥</span>
              <span id="digitalClockDate">7 ŸÜŸàŸÅŸÖÿ®ÿ± 2025</span>
            </div>
          </div>
        </div>
        
        <!-- ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ -->
        <div class="quick-stat-card">
          <div class="quick-stat-icon products-icon">
            <i class="fas fa-boxes"></i>
          </div>
          <div class="quick-stat-info">
            <div class="quick-stat-label">ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</div>
            <div class="quick-stat-value" id="quickTotalProducts">28</div>
          </div>
        </div>
        
        <div class="quick-stat-card">
          <div class="quick-stat-icon value-icon">
            <i class="fas fa-dollar-sign"></i>
          </div>
          <div class="quick-stat-info">
            <div class="quick-stat-label">ŸÇŸäŸÖÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</div>
            <div class="quick-stat-value" id="quickTotalValue">223,830 ÿØ</div>
          </div>
        </div>
        
        <div class="quick-stat-card">
          <div class="quick-stat-icon debts-icon">
            <i class="fas fa-file-invoice-dollar"></i>
          </div>
          <div class="quick-stat-info">
            <div class="quick-stat-label">ÿπÿØÿØ ÿßŸÑÿØŸäŸàŸÜ</div>
            <div class="quick-stat-value" id="quickDebtsCount">0</div>
          </div>
        </div>
        
        <div class="quick-stat-card">
          <div class="quick-stat-icon debtors-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="quick-stat-info">
            <div class="quick-stat-label">ÿßŸÑŸÖÿØŸäŸàŸÜŸäŸÜ</div>
            <div class="quick-stat-value" id="quickDebtorsCount">0</div>
          </div>
        </div>
        
        <div class="quick-stat-card">
          <div class="quick-stat-icon debt-value-icon">
            <i class="fas fa-hand-holding-usd"></i>
          </div>
          <div class="quick-stat-info">
            <div class="quick-stat-label">ŸÇŸäŸÖÿ© ÿßŸÑÿØŸäŸàŸÜ</div>
            <div class="quick-stat-value" id="quickDebtsValue">0 ÿØŸäŸÜÿßÿ±</div>
          </div>
        </div>
     </div>
     
         <div class="top-actions">
            <div class="search-box">
                    <input type="text" class="search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ..." id="globalSearchInput" onkeyup="handleGlobalSearch(event)"> 
                    <i class="fas fa-search search-icon"></i>
                    <div id="searchResults" class="search-results"></div>
            </div>
            <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()"> <i class="fas fa-moon"></i> </button>
         </div>
    </div><!-- ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿµŸÅÿ≠ÿßÿ™ -->
    <div class="page-content"><!-- ÿµŸÅÿ≠ÿ© ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ -->
     <div id="pos" class="page active">
      <!-- ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿπÿ© ŸÖŸàÿ¨ŸàÿØÿ© ÿßŸÑÿ¢ŸÜ ŸÅŸä ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÑŸàŸä -->
      <div class="pos-layout">
       <div class="products-section">
        <div class="section-header">
         <div class="section-title"><i class="fas fa-shopping-bag"></i> ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©
         </div>
         <div class="pos-search-box">
             <i class="fas fa-search"></i>
             <input type="text" id="posSearchInput" class="pos-search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÜÿ™ÿ¨..." onkeyup="filterPOSProducts()">
         </div>
        </div>
        <div class="category-filters" id="categoryFilters">
         <div class="category-btn active" data-category="all"><i class="fas fa-th-large"></i> ÿßŸÑŸÉŸÑ
         </div>
        </div>
        <div class="products-grid" id="productsGrid"><!-- ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
        </div>
       </div>
       <div class="cart-section">
        <div class="success-message" id="successMessage"><i class="fas fa-check-circle"></i> ÿ™ŸÖ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ®Ÿäÿπ ÿ®ŸÜÿ¨ÿßÿ≠! üéâ
        </div>
        
        <!-- ‚úÖ ÿ≤ÿ± ŸÖÿ®Ÿäÿπÿßÿ™ ÿßŸÑŸäŸàŸÖ -->
        <button class="btn btn-info" onclick="showTodaySalesReport()" style="width:100%;margin-bottom:0.8rem;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;padding:0.7rem;font-size:0.95rem;font-weight:700;">
          <i class="fas fa-file-invoice-dollar"></i> 
          <span>ŸÖÿ®Ÿäÿπÿßÿ™ ÿßŸÑŸäŸàŸÖ</span>
          <i class="fas fa-chart-line" style="margin-left:0.5rem;"></i>
        </button>
        
        <div class="cart-header">
          <i class="fas fa-shopping-cart"></i> 
          <span class="cart-title">ÿ≥ŸÑÿ© ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™</span>
          <div class="cart-badge-info">
            <div class="cart-mini-stat">
              <i class="fas fa-boxes"></i>
              <span id="cartItemsCount">0</span>
            </div>
            <div class="cart-mini-stat total-price">
              <i class="fas fa-dollar-sign"></i>
              <span id="cartTotalPrice">0</span>
            </div>
          </div>
        </div>
        <div class="cart-items" id="cartItems">
         <div class="cart-empty"><i class="fas fa-shopping-cart"></i>
          <p>ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ©</p><small>ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑÿ•ÿ∂ÿßŸÅÿ™Ÿáÿß</small>
         </div>
        </div>
        <div class="cart-summary">
         <div class="discount-section"><input type="number" class="discount-input" id="discountInput" placeholder="ÿÆÿµŸÖ (%)">
         </div>
         <div class="summary-row"><span>ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÅÿ±ÿπŸä:</span> <span class="summary-value" id="subtotal">0 ÿØŸäŸÜÿßÿ±</span>
         </div>
         <div class="summary-row"><span>ÿßŸÑÿÆÿµŸÖ:</span> <span class="summary-value" id="discountAmount">0 ÿØŸäŸÜÿßÿ±</span>
         </div>
         <div class="summary-row"><span>ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ© (<span id="taxRate">0</span>%):</span> <span class="summary-value" id="taxAmount">0 ÿØŸäŸÜÿßÿ±</span>
         </div>
         <div class="summary-row total"><span>ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÜŸáÿßÿ¶Ÿä:</span> <span class="summary-value" id="finalTotal">0 ÿØŸäŸÜÿßÿ±</span>
         </div>
         <div class="payment-actions">
          <button class="payment-action-btn cash-btn" id="cashPaymentBtn" disabled>
            <i class="fas fa-money-bill-wave"></i>
            <span>ÿØŸÅÿπ ŸÜŸÇÿØŸä</span>
          </button>
          <button class="payment-action-btn installment-btn" id="installmentPaymentBtn" disabled>
            <i class="fas fa-calendar-alt"></i>
            <span>ÿØŸÅÿπ ÿ®ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</span>
          </button>
         </div>
        </div>
       </div>
      </div>
     </div><!-- ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ -->
     <div id="products" class="page">
      <div class="section-header" style="margin-bottom: 1.5rem;">
       <div class="section-title"><i class="fas fa-boxes"></i> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
       </div>
       <div class="pos-search-box">
           <i class="fas fa-search"></i>
           <input type="text" id="productsSearchInput" class="pos-search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™..." onkeyup="filterProducts()">
       </div>
       <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <div class="export-import-buttons">
            <button class="export-btn" onclick="if(window.securityManager.checkPermission('products_export')) exportData('products', 'json')" data-permission="products_export"> <i class="fas fa-download"></i> JSON </button> 
            <button class="export-btn" onclick="if(window.securityManager.checkPermission('products_export')) exportData('products', 'excel')" data-permission="products_export"> <i class="fas fa-file-excel"></i> Excel </button> 
            <button class="export-btn" onclick="if(window.securityManager.checkPermission('products_export')) exportData('products', 'pdf')" data-permission="products_export"> <i class="fas fa-file-pdf"></i> PDF </button> 
            <input type="file" id="importProductsFile" accept=".json,.xlsx,.csv" style="display: none;" onchange="if(window.securityManager.checkPermission('products_import')) importData('products')"> 
            <button class="import-btn" onclick="if(window.securityManager.checkPermission('products_import')) document.getElementById('importProductsFile').click()" data-permission="products_import"> <i class="fas fa-upload"></i> ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ </button>
        </div>
        <button class="btn btn-secondary" onclick="if(window.securityManager.checkPermission('products_add_category')) showAddCategoryModal()" data-permission="products_add_category"> <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿµŸÜŸäŸÅ </button> 
        <button class="btn btn-primary" onclick="if(window.securityManager.checkPermission('products_add')) showAddProductModal()" data-permission="products_add"> <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ </button>
       </div>
      </div>
      
      <div class="stats-grid" style="margin-bottom: 1.5rem;">
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-boxes"></i>
        </div>
        <div class="stat-value" id="totalProducts">
         0
        </div>
        <div class="stat-label">
         ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
        </div>
       </div>
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stat-value" id="totalValue">
         0
        </div>
        <div class="stat-label">
         ŸÇŸäŸÖÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
        </div>
       </div>
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-value" id="lowStockItems">
         0
        </div>
        <div class="stat-label">
         ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÇŸÑŸäŸÑÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
        </div>
       </div>
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-tags"></i>
        </div>
        <div class="stat-value" id="totalCategories">
         0
        </div>
        <div class="stat-label">
         ÿπÿØÿØ ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™
        </div>
       </div>
      </div>
      <div class="table-container">
       <table class="table">
        <thead>
         <tr>
          <th><i class="fas fa-barcode"></i> ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ</th>
          <th><i class="fas fa-tag"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
          <th><i class="fas fa-layer-group"></i> ÿßŸÑÿ™ÿµŸÜŸäŸÅ</th>
          <th><i class="fas fa-money-bill"></i> ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ</th>
          <th><i class="fas fa-coins"></i> ÿ≥ÿπÿ± ÿßŸÑÿ™ŸÉŸÑŸÅÿ©</th>
          <th><i class="fas fa-warehouse"></i> ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</th>
          <th><i class="fas fa-cogs"></i> ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
         </tr>
        </thead>
        <tbody id="productsTableBody"><!-- ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
        </tbody>
       </table>
      </div>
     </div><!-- ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿÆÿ≤ŸÜ -->
     <div id="inventory" class="page">
      <div class="section-header" style="margin-bottom: 1.5rem;">
       <div class="section-title"><i class="fas fa-warehouse"></i> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿÆÿ≤ŸÜ
       </div>
       <div class="pos-search-box">
           <i class="fas fa-search"></i>
           <input type="text" id="inventorySearchInput" class="pos-search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ..." onkeyup="filterInventory()">
       </div>
       <div class="export-import-buttons">
           <button class="export-btn" onclick="printInventoryReport()"> <i class="fas fa-print"></i> ÿ∑ÿ®ÿßÿπÿ© </button>
           <button class="export-btn" onclick="exportData('inventory', 'json')"> <i class="fas fa-download"></i> JSON </button> 
           <button class="export-btn" onclick="exportData('inventory', 'excel')"> <i class="fas fa-file-excel"></i> Excel </button> 
           <button class="export-btn" onclick="exportData('inventory', 'pdf')"> <i class="fas fa-file-pdf"></i> PDF </button> 
           <input type="file" id="importInventoryFile" accept=".json,.xlsx,.csv" style="display: none;" onchange="importData('inventory')"> 
           <button class="import-btn" onclick="document.getElementById('importInventoryFile').click()"> <i class="fas fa-upload"></i> ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ </button>
       </div>
      </div>
      
      <div class="filters-section" style="margin-bottom: 1.5rem;">
       <div class="filters-grid">
        <div class="form-group"><label class="form-label">ŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿµŸÜŸäŸÅ</label> <select class="form-select" id="inventoryCategory"> <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™</option> </select>
        </div>
        <div class="form-group"><label class="form-label">ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</label> <select class="form-select" id="stockStatus"> <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ÿßŸÑÿßÿ™</option> <option value="in-stock">ŸÖÿ™ŸàŸÅÿ±</option> <option value="low-stock">ŸÖÿÆÿ≤ŸàŸÜ ŸÇŸÑŸäŸÑ</option> <option value="out-of-stock">ŸÜŸÅÿØ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</option> </select>
        </div>
       </div>
      </div>
      <div class="stats-grid">
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-value" id="totalProfit">
         0
        </div>
        <div class="stat-label">
         ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ±ÿ®ÿ≠ ÿßŸÑŸÖÿ™ŸàŸÇÿπ
        </div>
       </div>
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-chart-pie"></i>
        </div>
        <div class="stat-value" id="totalCost">
         0
        </div>
        <div class="stat-label">
         ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÉŸÑŸÅÿ©
        </div>
       </div>
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-balance-scale"></i>
        </div>
        <div class="stat-value" id="profitMargin">
         0%
        </div>
        <div class="stat-label">
         ŸáÿßŸÖÿ¥ ÿßŸÑÿ±ÿ®ÿ≠
        </div>
       </div>
      </div>
      <div class="table-container">
       <table class="table">
        <thead>
         <tr>
          <th><i class="fas fa-tag"></i> ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
          <th><i class="fas fa-layer-group"></i> ÿßŸÑÿ™ÿµŸÜŸäŸÅ</th>
          <th><i class="fas fa-warehouse"></i> ÿßŸÑŸÉŸÖŸäÿ©</th>
          <th><i class="fas fa-coins"></i> ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©</th>
          <th><i class="fas fa-money-bill"></i> ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑŸÖÿ™ŸàŸÇÿπÿ©</th>
          <th><i class="fas fa-chart-line"></i> ÿßŸÑÿ±ÿ®ÿ≠ ÿßŸÑŸÖÿ™ŸàŸÇÿπ</th>
          <th><i class="fas fa-info-circle"></i> ÿßŸÑÿ≠ÿßŸÑÿ©</th>
          <th><i class="fas fa-cogs"></i> ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
         </tr>
        </thead>
        <tbody id="inventoryTableBody"><!-- ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿÆÿ≤ŸÜ ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
        </tbody>
       </table>
      </div>
     </div>

     <!-- ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸäÿßŸÜÿ© -->
     <div id="maintenance" class="page">
      <div class="section-header" style="margin-bottom: 1.5rem;">
       <div class="section-title"><i class="fas fa-tools"></i> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸäÿßŸÜÿ©
       </div>
       <div class="pos-search-box">
           <i class="fas fa-search"></i>
           <input type="text" id="maintenanceSearchInput" class="pos-search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑÿµŸäÿßŸÜÿ©..." onkeyup="filterMaintenance()">
       </div>
       <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <div class="export-import-buttons">
            <button class="export-btn" onclick="exportData('maintenance', 'json')"> <i class="fas fa-download"></i> JSON </button> 
            <button class="export-btn" onclick="exportData('maintenance', 'excel')"> <i class="fas fa-file-excel"></i> Excel </button> 
            <button class="export-btn" onclick="exportData('maintenance', 'word')"> <i class="fas fa-file-word"></i> Word </button>
            <button class="export-btn" onclick="exportData('maintenance', 'pdf')"> <i class="fas fa-file-pdf"></i> PDF </button>
            <label class="export-btn" style="cursor: pointer; margin: 0;">
                <i class="fas fa-upload"></i> ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ
                <input type="file" id="maintenanceImportFile" accept=".json,.xlsx,.xls,.csv" style="display: none;" onchange="importMaintenanceData(this)">
            </label>
        </div>
        <button class="btn btn-success" onclick="showAddMaintenanceModal()"> <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿ¨Ÿáÿßÿ≤ ŸÑŸÑÿµŸäÿßŸÜÿ© </button>
       </div>
      </div>
      
      <!-- ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ -->
      <div class="stats-grid" style="margin-bottom: 1.5rem;">
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);"><i class="fas fa-tools"></i></div>
        <div class="stat-value" id="totalMaintenanceDevices">0</div>
        <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ©</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);"><i class="fas fa-check-circle"></i></div>
        <div class="stat-value" id="completedMaintenanceDevices">0</div>
        <div class="stat-label">ÿ™ŸÖÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);"><i class="fas fa-clock"></i></div>
        <div class="stat-value" id="pendingMaintenanceDevices">0</div>
        <div class="stat-label">ŸÇŸäÿØ ÿßŸÑÿµŸäÿßŸÜÿ©</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #6366f1, #4f46e5);"><i class="fas fa-money-bill-wave"></i></div>
        <div class="stat-value" id="totalMaintenanceRevenue">0 ÿØŸäŸÜÿßÿ±</div>
        <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™</div>
       </div>
      </div>

      <!-- ÿßŸÑŸÅŸÑÿßÿ™ÿ± -->
      <!-- ÿßŸÑŸÅŸÑÿßÿ™ÿ± -->
      <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; margin-bottom: 1.5rem; padding: 1rem; background: var(--theme-bg-card); border-radius: 12px; box-shadow: var(--shadow-sm);">
       <div class="filter-group" style="margin: 0;">
        <label><i class="fas fa-filter"></i> ÿ≠ÿßŸÑÿ© ÿßŸÑÿµŸäÿßŸÜÿ©:</label>
        <select id="maintenanceStatusFilter" onchange="filterMaintenanceByStatus()" class="form-control" style="min-width: 150px;">
         <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ©</option>
         <option value="pending">ŸÇŸäÿØ ÿßŸÑÿµŸäÿßŸÜÿ©</option>
         <option value="completed">ÿ™ŸÖÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©</option>
        </select>
       </div>
       <div class="filter-group" style="margin: 0;">
        <label><i class="fas fa-building"></i> ÿßŸÑÿ¥ÿ±ŸÉÿ©:</label>
        <select id="maintenanceCompanyFilter" onchange="filterMaintenanceByCompany()" class="form-control" style="min-width: 150px;">
         <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ¥ÿ±ŸÉÿßÿ™</option>
        </select>
       </div>
       <div class="filter-group" style="margin: 0;">
        <label><i class="fas fa-calendar-alt"></i> ÿßŸÑŸÅÿ™ÿ±ÿ©:</label>
        <select id="maintenancePeriodFilter" onchange="filterMaintenanceByPeriod()" class="form-control" style="min-width: 150px;">
         <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™</option>
         <option value="today">ÿßŸÑŸäŸàŸÖ</option>
         <option value="week">Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</option>
         <option value="month">Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±</option>
         <option value="custom">ŸÅÿ™ÿ±ÿ© ŸÖÿÆÿµÿµÿ©</option>
        </select>
       </div>
       <div id="customMaintenanceDateRange" style="display: none; gap: 0.5rem; align-items: center; margin: 0;">
        <label>ŸÖŸÜ:</label>
        <input type="date" id="maintenanceDateFrom" class="form-control" style="width: auto;">
        <label>ÿ•ŸÑŸâ:</label>
        <input type="date" id="maintenanceDateTo" class="form-control" style="width: auto;">
        <button class="btn btn-primary btn-sm" onclick="applyCustomMaintenanceDateFilter()">ÿ™ÿ∑ÿ®ŸäŸÇ</button>
       </div>
       <div class="filter-group" style="margin: 0;">
        <label><i class="fas fa-dollar-sign"></i> ŸÜÿ∑ÿßŸÇ ÿßŸÑÿ≥ÿπÿ±:</label>
        <select id="maintenancePriceFilter" onchange="filterMaintenanceByPrice()" class="form-control" style="min-width: 150px;">
         <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≥ÿπÿßÿ±</option>
         <option value="0-50000">ÿ£ŸÇŸÑ ŸÖŸÜ 50,000 ÿØŸäŸÜÿßÿ±</option>
         <option value="50000-100000">50,000 - 100,000 ÿØŸäŸÜÿßÿ±</option>
         <option value="100000-200000">100,000 - 200,000 ÿØŸäŸÜÿßÿ±</option>
         <option value="200000+">ÿ£ŸÉÿ´ÿ± ŸÖŸÜ 200,000 ÿØŸäŸÜÿßÿ±</option>
        </select>
       </div>
       <button class="btn btn-secondary btn-sm" onclick="resetMaintenanceFilters()" style="margin-right: auto;">
        <i class="fas fa-redo"></i> ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ
       </button>
      </div>
      
      <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑÿµŸäÿßŸÜÿ© -->
      <div class="table-container">
       <table class="table">
        <thead>
         <tr>
          <th><i class="fas fa-hashtag"></i> #</th>
          <th><i class="fas fa-box"></i> ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
          <th><i class="fas fa-building"></i> ÿßŸÑÿ¥ÿ±ŸÉÿ©</th>
          <th><i class="fas fa-exclamation-triangle"></i> ÿßŸÑÿÆŸÑŸÑ</th>
          <th><i class="fas fa-money-bill"></i> ÿ≥ÿπÿ± ÿßŸÑÿµŸäÿßŸÜÿ©</th>
          <th><i class="fas fa-calendar-check"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ</th>
          <th><i class="fas fa-calendar-alt"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ</th>
          <th><i class="fas fa-info-circle"></i> ÿßŸÑÿ≠ÿßŸÑÿ©</th>
          <th><i class="fas fa-cogs"></i> ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
         </tr>
        </thead>
        <tbody id="maintenanceTableBody">
         <!-- ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ© ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
        </tbody>
       </table>
      </div>
     </div>

     <!-- ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ± -->
     <div id="spareParts" class="page">
      <div class="section-header" style="margin-bottom: 1.5rem;">
       <div class="section-title"><i class="fas fa-cogs"></i> ÿ•ÿØÿßÿ±ÿ© ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ± ŸàÿßŸÑÿ£ÿØŸàÿßÿ™
       </div>
       <div class="pos-search-box">
           <i class="fas fa-search"></i>
           <input type="text" id="sparePartsSearchInput" class="pos-search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ±..." onkeyup="filterSpareParts()">
       </div>
       <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <div class="export-import-buttons">
            <button class="export-btn" onclick="exportData('spareParts', 'json')"> <i class="fas fa-download"></i> JSON </button> 
            <button class="export-btn" onclick="exportData('spareParts', 'excel')"> <i class="fas fa-file-excel"></i> Excel </button> 
            <button class="export-btn" onclick="exportData('spareParts', 'word')"> <i class="fas fa-file-word"></i> Word </button>
            <button class="export-btn" onclick="exportData('spareParts', 'pdf')"> <i class="fas fa-file-pdf"></i> PDF </button>
            <label class="export-btn" style="cursor: pointer; margin: 0;">
                <i class="fas fa-upload"></i> ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ
                <input type="file" id="sparePartsImportFile" accept=".json,.xlsx,.xls,.csv" style="display: none;" onchange="importSparePartsData(this)">
            </label>
        </div>
        <button class="btn btn-success" onclick="showAddSparePartModal()"> <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ∑ÿπÿ© ÿ∫Ÿäÿßÿ± </button>
       </div>
      </div>
      
      <!-- ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ -->
      <div class="stats-grid" style="margin-bottom: 1.5rem;">
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #6366f1, #4f46e5);"><i class="fas fa-cogs"></i></div>
        <div class="stat-value" id="totalSparePartsCount">0</div>
        <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÇÿ∑ÿπ</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);"><i class="fas fa-boxes"></i></div>
        <div class="stat-value" id="totalSparePartsQuantity">0</div>
        <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÖŸäÿ©</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);"><i class="fas fa-exclamation-triangle"></i></div>
        <div class="stat-value" id="lowStockSparePartsCount">0</div>
        <div class="stat-label">ŸÇÿ∑ÿπ ŸÇŸÑŸäŸÑÿ© ÿßŸÑŸÉŸÖŸäÿ©</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);"><i class="fas fa-money-bill-wave"></i></div>
        <div class="stat-value" id="totalSparePartsValue">0 ÿØŸäŸÜÿßÿ±</div>
        <div class="stat-label">ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©</div>
       </div>
      </div>

      <!-- ÿ™ŸÜÿ®ŸäŸáÿßÿ™ ÿßŸÑŸÉŸÖŸäÿßÿ™ ÿßŸÑŸÇŸÑŸäŸÑÿ© -->
      <div id="lowStockAlert" style="display: none; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);">
       <div style="display: flex; align-items: center; gap: 1rem;">
        <i class="fas fa-exclamation-triangle" style="font-size: 2rem;"></i>
        <div>
         <h3 style="margin: 0; font-size: 1.1rem;">ÿ™ŸÜÿ®ŸäŸá: ŸÇÿ∑ÿπ ŸÇŸÑŸäŸÑÿ© ÿßŸÑŸÉŸÖŸäÿ©</h3>
         <p style="margin: 0.5rem 0 0 0; opacity: 0.9;" id="lowStockAlertMessage">ŸäŸàÿ¨ÿØ ŸÇÿ∑ÿπ ÿ∫Ÿäÿßÿ± ÿ®ŸÉŸÖŸäÿßÿ™ ŸÇŸÑŸäŸÑÿ© ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿ•ÿπÿßÿØÿ© ÿ∑ŸÑÿ®</p>
        </div>
        <button onclick="filterSparePartsByStock('low')" style="margin-right: auto; background: white; color: #ef4444; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-weight: bold; cursor: pointer;">
         <i class="fas fa-eye"></i> ÿπÿ±ÿ∂ ÿßŸÑŸÇÿ∑ÿπ
        </button>
       </div>
      </div>

      <!-- ÿßŸÑŸÅŸÑÿßÿ™ÿ± -->
      <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; margin-bottom: 1.5rem; padding: 1rem; background: var(--theme-bg-card); border-radius: 12px; box-shadow: var(--shadow-sm);">
       <div class="filter-group" style="margin: 0;">
        <label><i class="fas fa-filter"></i> ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ:</label>
        <select id="sparePartsStockFilter" onchange="filterSparePartsByStock()" class="form-control" style="min-width: 150px;">
         <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÇÿ∑ÿπ</option>
         <option value="available">ŸÖÿ™ŸàŸÅÿ±</option>
         <option value="low">ŸÉŸÖŸäÿ© ŸÇŸÑŸäŸÑÿ©</option>
         <option value="out">ŸÜŸÅÿ∞ÿ™ ÿßŸÑŸÉŸÖŸäÿ©</option>
        </select>
       </div>
       <div class="filter-group" style="margin: 0;">
        <label><i class="fas fa-tag"></i> ÿßŸÑÿ™ÿµŸÜŸäŸÅ:</label>
        <select id="sparePartsCategoryFilter" onchange="filterSparePartsByCategory()" class="form-control" style="min-width: 150px;">
         <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™</option>
        </select>
       </div>
       <div class="filter-group" style="margin: 0;">
        <label><i class="fas fa-dollar-sign"></i> ŸÜÿ∑ÿßŸÇ ÿßŸÑÿ≥ÿπÿ±:</label>
        <select id="sparePartsPriceFilter" onchange="filterSparePartsByPrice()" class="form-control" style="min-width: 150px;">
         <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≥ÿπÿßÿ±</option>
         <option value="0-10000">ÿ£ŸÇŸÑ ŸÖŸÜ 10,000 ÿØŸäŸÜÿßÿ±</option>
         <option value="10000-50000">10,000 - 50,000 ÿØŸäŸÜÿßÿ±</option>
         <option value="50000-100000">50,000 - 100,000 ÿØŸäŸÜÿßÿ±</option>
         <option value="100000+">ÿ£ŸÉÿ´ÿ± ŸÖŸÜ 100,000 ÿØŸäŸÜÿßÿ±</option>
        </select>
       </div>
       <button class="btn btn-secondary btn-sm" onclick="resetSparePartsFilters()" style="margin-right: auto;">
        <i class="fas fa-redo"></i> ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ
       </button>
      </div>
      
      <!-- ÿ¨ÿØŸàŸÑ ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ± -->
      <div class="table-container">
       <table class="table">
        <thead>
         <tr>
          <th><i class="fas fa-hashtag"></i> #</th>
          <th><i class="fas fa-cog"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ∑ÿπÿ©</th>
          <th><i class="fas fa-tag"></i> ÿßŸÑÿ™ÿµŸÜŸäŸÅ</th>
          <th><i class="fas fa-barcode"></i> ÿ±ŸÖÿ≤ ÿßŸÑŸÇÿ∑ÿπÿ©</th>
          <th><i class="fas fa-boxes"></i> ÿßŸÑŸÉŸÖŸäÿ©</th>
          <th><i class="fas fa-shopping-cart"></i> ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°</th>
          <th><i class="fas fa-money-bill"></i> ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ</th>
          <th><i class="fas fa-store"></i> ÿ≥ÿπÿ± ÿßŸÑŸÖŸÅÿ±ÿØ</th>
          <th><i class="fas fa-warehouse"></i> ÿ≥ÿπÿ± ÿßŸÑÿ¨ŸÖŸÑÿ©</th>
          <th><i class="fas fa-chart-line"></i> ÿßŸÑÿ±ÿ®ÿ≠ ÿßŸÑŸÖÿ™ŸàŸÇÿπ</th>
          <th><i class="fas fa-info-circle"></i> ÿßŸÑÿ≠ÿßŸÑÿ©</th>
          <th><i class="fas fa-cogs"></i> ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
         </tr>
        </thead>
        <tbody id="sparePartsTableBody">
         <!-- ÿ®ŸäÿßŸÜÿßÿ™ ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ± ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
        </tbody>
       </table>
      </div>
     </div>

     <!-- ÿµŸÅÿ≠ÿ© ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ© -->
     <div id="deliveredDevices" class="page">
      <div class="section-header" style="margin-bottom: 1.5rem;">
       <div class="section-title"><i class="fas fa-check-double"></i> ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ© ŸàÿßŸÑŸÖŸÜÿ¨ÿ≤ÿ©
       </div>
       <div class="pos-search-box">
           <i class="fas fa-search"></i>
           <input type="text" id="deliveredDevicesSearchInput" class="pos-search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ©..." onkeyup="filterDeliveredDevices()">
       </div>
       <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <div class="export-import-buttons">
            <button class="export-btn" onclick="exportData('deliveredDevices', 'json')"> <i class="fas fa-download"></i> JSON </button> 
            <button class="export-btn" onclick="exportData('deliveredDevices', 'excel')"> <i class="fas fa-file-excel"></i> Excel </button> 
            <button class="export-btn" onclick="exportData('deliveredDevices', 'word')"> <i class="fas fa-file-word"></i> Word </button>
            <button class="export-btn" onclick="exportData('deliveredDevices', 'pdf')"> <i class="fas fa-file-pdf"></i> PDF </button>
        </div>
       </div>
      </div>
      
      <!-- ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ -->
      <div class="stats-grid" style="margin-bottom: 1.5rem;">
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);"><i class="fas fa-check-circle"></i></div>
        <div class="stat-value" id="totalDeliveredDevices">0</div>
        <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ©</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #6366f1, #4f46e5);"><i class="fas fa-money-bill-wave"></i></div>
        <div class="stat-value" id="totalDeliveredRevenue">0 ÿØŸäŸÜÿßÿ±</div>
        <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);"><i class="fas fa-calendar-week"></i></div>
        <div class="stat-value" id="weekDeliveredDevices">0</div>
        <div class="stat-label">ÿ™ÿ≥ŸÑŸäŸÖÿßÿ™ Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"><i class="fas fa-chart-line"></i></div>
        <div class="stat-value" id="avgDeliveryTime">0 ŸäŸàŸÖ</div>
        <div class="stat-label">ŸÖÿ™Ÿàÿ≥ÿ∑ ŸàŸÇÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©</div>
       </div>
      </div>

      <!-- ÿßŸÑŸÅŸÑÿßÿ™ÿ± -->
      <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; margin-bottom: 1.5rem; padding: 1rem; background: var(--theme-bg-card); border-radius: 12px; box-shadow: var(--shadow-sm);">
       <div class="filter-group" style="margin: 0;">
        <label><i class="fas fa-calendar-alt"></i> ÿßŸÑŸÅÿ™ÿ±ÿ©:</label>
        <select id="deliveredPeriodFilter" onchange="filterDeliveredByPeriod()" class="form-control" style="min-width: 150px;">
         <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™</option>
         <option value="today">ÿßŸÑŸäŸàŸÖ</option>
         <option value="week">Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</option>
         <option value="month">Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±</option>
         <option value="custom">ŸÅÿ™ÿ±ÿ© ŸÖÿÆÿµÿµÿ©</option>
        </select>
       </div>
       <div id="customDeliveredDateRange" style="display: none; gap: 0.5rem; align-items: center; margin: 0;">
        <label>ŸÖŸÜ:</label>
        <input type="date" id="deliveredDateFrom" class="form-control" style="width: auto;">
        <label>ÿ•ŸÑŸâ:</label>
        <input type="date" id="deliveredDateTo" class="form-control" style="width: auto;">
        <button class="btn btn-primary btn-sm" onclick="applyCustomDeliveredDateFilter()">ÿ™ÿ∑ÿ®ŸäŸÇ</button>
       </div>
       <div class="filter-group" style="margin: 0;">
        <label><i class="fas fa-credit-card"></i> ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ:</label>
        <select id="paymentMethodFilter" onchange="filterDeliveredByPayment()" class="form-control" style="min-width: 150px;">
         <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ∑ÿ±ŸÇ</option>
         <option value="cash">ŸÜŸÇÿØÿßŸã</option>
         <option value="card">ÿ®ÿ∑ÿßŸÇÿ©</option>
         <option value="transfer">ÿ™ÿ≠ŸàŸäŸÑ</option>
         <option value="mixed">ŸÖÿÆÿ™ŸÑÿ∑</option>
        </select>
       </div>
       <button class="btn btn-secondary btn-sm" onclick="resetDeliveredFilters()" style="margin-right: auto;">
        <i class="fas fa-redo"></i> ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ
       </button>
      </div>
      
      <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ© -->
      <div class="table-container">
       <table class="table">
        <thead>
         <tr>
          <th><i class="fas fa-hashtag"></i> #</th>
          <th><i class="fas fa-box"></i> ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
          <th><i class="fas fa-building"></i> ÿßŸÑÿ¥ÿ±ŸÉÿ©</th>
          <th><i class="fas fa-exclamation-triangle"></i> ÿßŸÑÿÆŸÑŸÑ</th>
          <th><i class="fas fa-money-bill"></i> ÿ≥ÿπÿ± ÿßŸÑÿµŸäÿßŸÜÿ©</th>
          <th><i class="fas fa-cogs"></i> ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ±</th>
          <th><i class="fas fa-calculator"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</th>
          <th><i class="fas fa-hand-holding-usd"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖ</th>
          <th><i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ</th>
          <th><i class="fas fa-credit-card"></i> ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ</th>
          <th><i class="fas fa-cogs"></i> ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
         </tr>
        </thead>
        <tbody id="deliveredDevicesTableBody">
         <!-- ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ© ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
        </tbody>
       </table>
      </div>
     </div>

     <!-- ÿµŸÅÿ≠ÿ© ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± -->
     <div id="invoices" class="page">
      <div class="section-header" style="margin-bottom: 1.5rem;">
       <div class="section-title"><i class="fas fa-receipt"></i> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
       </div>
       <div class="pos-search-box">
           <i class="fas fa-search"></i>
           <input type="text" id="invoicesSearchInput" class="pos-search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±..." onkeyup="filterInvoices()">
       </div>
       <div class="export-import-buttons">
           <button class="export-btn" onclick="if(window.securityManager.checkPermission('reports_export')) exportData('invoices', 'json')" data-permission="reports_export"> <i class="fas fa-download"></i> JSON </button> 
           <button class="export-btn" onclick="if(window.securityManager.checkPermission('reports_export')) exportData('invoices', 'excel')" data-permission="reports_export"> <i class="fas fa-file-excel"></i> Excel </button> 
           <button class="export-btn" onclick="if(window.securityManager.checkPermission('reports_export')) exportData('invoices', 'pdf')" data-permission="reports_export"> <i class="fas fa-file-pdf"></i> PDF </button> 
           <input type="file" id="importInvoicesFile" accept=".json,.xlsx,.csv" style="display: none;" onchange="importData('invoices')"> 
           <button class="import-btn" onclick="document.getElementById('importInvoicesFile').click()" data-permission="settings_restore" style="display: none;"> <i class="fas fa-upload"></i> ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ </button>
       </div>
      </div>
      
      <div class="stats-grid" style="margin-bottom: 1.5rem;">
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-receipt"></i>
        </div>
        <div class="stat-value" id="totalInvoices">
         0
        </div>
        <div class="stat-label">
         ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
        </div>
       </div>
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-value" id="totalSales">
         0
        </div>
        <div class="stat-label">
         ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™
        </div>
       </div>
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-calendar-day"></i>
        </div>
        <div class="stat-value" id="todaySales">
         0
        </div>
        <div class="stat-label">
         ŸÖÿ®Ÿäÿπÿßÿ™ ÿßŸÑŸäŸàŸÖ
        </div>
       </div>
      </div>
      <div class="table-container">
       <table class="table">
        <thead>
         <tr>
          <th><i class="fas fa-hashtag"></i> ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</th>
          <th><i class="fas fa-calendar"></i> ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
          <th><i class="fas fa-user"></i> ÿßŸÑÿπŸÖŸäŸÑ</th>
          <th><i class="fas fa-money-bill"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
          <th><i class="fas fa-credit-card"></i> ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ</th>
          <th><i class="fas fa-user-tag"></i> ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
          <th><i class="fas fa-cogs"></i> ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
         </tr>
        </thead>
        <tbody id="invoicesTableBody"><!-- ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
        </tbody>
       </table>
      </div>
     </div><!-- ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿØŸäŸàŸÜ -->
     
     <!-- ‚úÖ ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ŸäÿµÿßŸÑÿßÿ™ -->
     <div id="receiptsManagement" class="page">
      <div class="section-header" style="margin-bottom: 1.5rem;">
       <div class="section-title"><i class="fas fa-file-invoice-dollar"></i> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ŸäÿµÿßŸÑÿßÿ™
       </div>
       <div class="pos-search-box">
           <i class="fas fa-search"></i>
           <input type="text" id="receiptsSearchInput" class="pos-search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ•ŸäÿµÿßŸÑÿßÿ™..." onkeyup="filterReceipts()">
       </div>
       <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <div class="export-import-buttons">
            <button class="export-btn" onclick="exportData('receipts', 'json')"> <i class="fas fa-download"></i> JSON </button> 
            <button class="export-btn" onclick="exportData('receipts', 'excel')"> <i class="fas fa-file-excel"></i> Excel </button> 
            <button class="export-btn" onclick="exportData('receipts', 'pdf')"> <i class="fas fa-file-pdf"></i> PDF </button> 
        </div>
        <select id="receiptsDateFilter" class="filter-select" onchange="filterReceipts()">
          <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ</option>
          <option value="today">ÿßŸÑŸäŸàŸÖ</option>
          <option value="yesterday">ÿßŸÑÿ£ŸÖÿ≥</option>
          <option value="thisWeek">Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</option>
          <option value="thisMonth">Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±</option>
          <option value="custom">ÿ™ÿßÿ±ŸäÿÆ ŸÖÿÆÿµÿµ</option>
        </select>
        <select id="receiptsTypeFilter" class="filter-select" onchange="filterReceipts()">
          <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÜŸàÿßÿπ</option>
          <option value="ŸÜŸÇÿØŸä">ŸÜŸÇÿØŸä</option>
          <option value="ÿ£ŸÇÿ≥ÿßÿ∑">ÿ£ŸÇÿ≥ÿßÿ∑</option>
        </select>
        <select id="receiptsUserFilter" class="filter-select" onchange="filterReceipts()">
          <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</option>
        </select>
        <button class="btn btn-primary" onclick="mergeReceipts()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
          <i class="fas fa-compress-alt"></i> ÿØŸÖÿ¨ ÿ•ŸäÿµÿßŸÑÿßÿ™ ÿßŸÑŸäŸàŸÖ
        </button>
       </div>
      </div>
      
      <div class="stats-grid" style="margin-bottom: 1.5rem;">
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-file-invoice"></i>
        </div>
        <div class="stat-value" id="totalReceipts">
         0
        </div>
        <div class="stat-label">
         ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•ŸäÿµÿßŸÑÿßÿ™
        </div>
       </div>
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);"><i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-value" id="totalCashReceipts">
         0
        </div>
        <div class="stat-label">
         ŸÖÿ®Ÿäÿπÿßÿ™ ŸÜŸÇÿØŸä
        </div>
       </div>
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><i class="fas fa-calendar-alt"></i>
        </div>
        <div class="stat-value" id="totalInstallmentReceipts">
         0
        </div>
        <div class="stat-label">
         ŸÖÿ®Ÿäÿπÿßÿ™ ÿ£ŸÇÿ≥ÿßÿ∑
        </div>
       </div>
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #FA8BFF 0%, #2BD2FF 90%, #2BFF88 100%);"><i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stat-value" id="totalReceiptsAmount">
         0
        </div>
        <div class="stat-label">
         ÿßŸÑÿØÿÆŸÑ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
        </div>
       </div>
      </div>
      
      <div class="table-container">
       <table class="table">
        <thead>
         <tr>
          <th><i class="fas fa-hashtag"></i> ÿ±ŸÇŸÖ ÿßŸÑÿ•ŸäÿµÿßŸÑ</th>
          <th><i class="fas fa-calendar"></i> ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
          <th><i class="fas fa-clock"></i> ÿßŸÑŸàŸÇÿ™</th>
          <th><i class="fas fa-user"></i> ÿßŸÑÿπŸÖŸäŸÑ</th>
          <th><i class="fas fa-money-bill"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
          <th><i class="fas fa-credit-card"></i> ÿßŸÑŸÜŸàÿπ</th>
          <th><i class="fas fa-user-tag"></i> ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
          <th><i class="fas fa-layer-group"></i> ŸÖÿØŸÖÿ¨</th>
          <th><i class="fas fa-cogs"></i> ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
         </tr>
        </thead>
        <tbody id="receiptsTableBody"><!-- ÿßŸÑÿ•ŸäÿµÿßŸÑÿßÿ™ ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
        </tbody>
       </table>
      </div>
     </div>
     
     <div id="debts" class="page">
      <div class="section-header" style="margin-bottom: 1.5rem;">
       <div class="section-title"><i class="fas fa-credit-card"></i> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿØŸäŸàŸÜ ŸàÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
       </div>
       <div class="pos-search-box">
           <i class="fas fa-search"></i>
           <input type="text" id="debtsSearchInput" class="pos-search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿØŸäŸàŸÜ..." onkeyup="filterDebts()">
       </div>
       <div class="export-import-buttons">
           <button class="export-btn" onclick="if(window.securityManager.checkPermission('debts_export')) exportData('debts', 'json')" data-permission="debts_export"> <i class="fas fa-download"></i> JSON </button> 
           <button class="export-btn" onclick="if(window.securityManager.checkPermission('debts_export')) exportData('debts', 'excel')" data-permission="debts_export"> <i class="fas fa-file-excel"></i> Excel </button> 
           <button class="export-btn" onclick="if(window.securityManager.checkPermission('debts_export')) exportData('debts', 'pdf')" data-permission="debts_export"> <i class="fas fa-file-pdf"></i> PDF </button> 
           <input type="file" id="importDebtsFile" accept=".json,.xlsx,.csv" style="display: none;" onchange="importData('debts')"> 
           <button class="import-btn" onclick="document.getElementById('importDebtsFile').click()" data-permission="settings_restore" style="display: none;"> <i class="fas fa-upload"></i> ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ </button>
       </div>
       <button class="btn btn-primary" onclick="showAddManualDebtModal()" style="margin-right: 1rem;"> <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿØŸäŸÜ ÿ¨ÿØŸäÿØ </button>
      </div>
      
      <div class="stats-grid" style="margin-bottom: 1.5rem;">
       <div class="stat-card" onclick="filterDebtsByStatus('all')" style="cursor: pointer;" title="ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑÿØŸäŸàŸÜ">
        <div class="stat-icon"><i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-value" id="totalDebts">
         0
        </div>
        <div class="stat-label">
         ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿØŸäŸàŸÜ
        </div>
       </div>
       <div class="stat-card" onclick="filterDebtsByStatus('active')" style="cursor: pointer;" title="ÿπÿ±ÿ∂ ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÜÿ¥ÿ∑ÿ©">
        <div class="stat-icon"><i class="fas fa-users"></i>
        </div>
        <div class="stat-value" id="debtCustomers">
         0
        </div>
        <div class="stat-label">
         ÿπÿØÿØ ÿßŸÑÿπŸÖŸÑÿßÿ°
        </div>
       </div>
       <div class="stat-card" onclick="filterDebtsByStatus('overdue')" style="cursor: pointer;" title="ÿπÿ±ÿ∂ ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÖÿ™ÿ£ÿÆÿ±ÿ©">
        <div class="stat-icon"><i class="fas fa-calendar-check"></i>
        </div>
        <div class="stat-value" id="overdueDebts">
         0
        </div>
        <div class="stat-label">
         ÿØŸäŸàŸÜ ŸÖÿ™ÿ£ÿÆÿ±ÿ©
        </div>
       </div>
       <div class="stat-card" onclick="filterDebtsByStatus('paid')" style="cursor: pointer;" title="ÿπÿ±ÿ∂ ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÖÿ≥ÿØÿØÿ©">
        <div class="stat-icon"><i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-value" id="paidDebts">
         0
        </div>
        <div class="stat-label">
         ÿØŸäŸàŸÜ ŸÖÿ≥ÿØÿØÿ©
        </div>
       </div>
      </div>
      <div class="table-container">
       <table class="table">
        <thead>
         <tr>
          <th><i class="fas fa-user"></i> ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ</th>
          <th><i class="fas fa-phone"></i> ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</th>
          <th><i class="fas fa-money-bill-wave"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ</th>
          <th><i class="fas fa-money-bill"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</th>
          <th><i class="fas fa-calendar-alt"></i> ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä</th>
          <th><i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ</th>
          <th><i class="fas fa-info-circle"></i> ÿßŸÑÿ≠ÿßŸÑÿ©</th>
          <th><i class="fas fa-cogs"></i> ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
         </tr>
        </thead>
        <tbody id="debtsTableBody"><!-- ÿßŸÑÿØŸäŸàŸÜ ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
        </tbody>
       </table>
      </div>
     </div><!-- ÿµŸÅÿ≠ÿ© ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸäŸÜ ÿßŸÑŸÉÿßŸÖŸÑÿ© -->
     <div id="debtDetailsPage" class="page">
      <div class="section-header">
       <div class="section-title">
        <button class="btn btn-secondary" onclick="navigateTo('debts')" style="margin-left: 10px;">
         <i class="fas fa-arrow-right"></i> ÿ±ÿ¨Ÿàÿπ
        </button>
        <i class="fas fa-user-circle"></i> ÿ™ŸÅÿßÿµŸäŸÑ ÿØŸäŸÜ ÿßŸÑÿπŸÖŸäŸÑ
       </div>
      </div>
      
      <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ -->
      <div class="stats-grid" id="debtCustomerInfo">
       <!-- ÿ≥ÿ™ÿ∏Ÿáÿ± ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ ŸáŸÜÿß -->
      </div>
      
      <!-- ŸÖŸÑÿÆÿµ ÿßŸÑÿØŸäŸÜ -->
      <div class="stat-card" id="debtSummaryCard" style="margin: 20px 0; padding: 30px;">
       <!-- ŸÖŸÑÿÆÿµ ÿßŸÑÿØŸäŸÜ -->
      </div>
      
      <!-- ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ© -->
      <div class="card" style="margin: 20px 0;">
       <h3 style="margin-bottom: 20px; color: var(--primary-color);"><i class="fas fa-file-invoice"></i> ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ©</h3>
       <div id="debtInvoiceDetails">
        <!-- ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© -->
       </div>
      </div>
      
      <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© -->
      <div class="card" style="margin: 20px 0;">
       <h3 style="margin-bottom: 20px; color: var(--primary-color);"><i class="fas fa-calendar-alt"></i> ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©</h3>
       <div class="table-container">
        <table class="table">
         <thead>
          <tr>
           <th><i class="fas fa-hashtag"></i> ÿßŸÑÿ¥Ÿáÿ±</th>
           <th><i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ</th>
           <th><i class="fas fa-money-bill"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇ</th>
           <th><i class="fas fa-check-circle"></i> ÿßŸÑÿ≠ÿßŸÑÿ©</th>
           <th><i class="fas fa-calendar-check"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿØŸÅÿπ</th>
           <th><i class="fas fa-cogs"></i> ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
          </tr>
         </thead>
         <tbody id="installmentsTableBody">
          <!-- ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
         </tbody>
        </table>
       </div>
      </div>
      
      <!-- ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ -->
      <div class="card" style="margin: 20px 0;">
       <h3 style="margin-bottom: 20px; color: var(--primary-color);"><i class="fas fa-history"></i> ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™</h3>
       <div class="table-container">
        <table class="table">
         <thead>
          <tr>
           <th><i class="fas fa-calendar"></i> ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
           <th><i class="fas fa-money-bill-wave"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
           <th><i class="fas fa-hashtag"></i> ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÖÿ≥ÿØÿØ</th>
           <th><i class="fas fa-sticky-note"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</th>
          </tr>
         </thead>
         <tbody id="paymentsHistoryBody">
          <!-- ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ -->
         </tbody>
        </table>
       </div>
      </div>
     </div>
     
     <!-- üíµ ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ÿßŸÑÿ¥ÿßŸÖŸÑÿ© -->
     <div id="payments" class="page">
      <div class="section-header" style="margin-bottom: 1.5rem;">
       <div class="section-title"><i class="fas fa-hand-holding-usd"></i> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ŸàÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
       </div>
       <div class="pos-search-box">
           <i class="fas fa-search"></i>
           <input type="text" id="paymentsSearchInput" class="pos-search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™..." onkeyup="filterPayments()">
       </div>
       <div class="export-import-buttons">
           <button class="export-btn" onclick="if(window.securityManager.checkPermission('debts_export')) exportPaymentsAsJSON()" data-permission="debts_export"> <i class="fas fa-download"></i> JSON </button> 
           <button class="export-btn" onclick="if(window.securityManager.checkPermission('debts_export')) exportPaymentsAsExcel()" data-permission="debts_export"> <i class="fas fa-file-excel"></i> Excel </button> 
           <button class="export-btn" onclick="if(window.securityManager.checkPermission('debts_export')) exportPaymentsAsPDF()" data-permission="debts_export"> <i class="fas fa-file-pdf"></i> PDF </button> 
       </div>
       <button class="btn btn-primary" onclick="refreshPaymentsPage()" style="margin-right: 1rem;"> <i class="fas fa-sync-alt"></i> ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ </button>
      </div>
      
      <!-- ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿπÿ© -->
      <div class="stats-grid" style="margin-bottom: 1.5rem;">
       <div class="stat-card" onclick="filterPaymentsByStatus('all')" style="cursor: pointer;" title="ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™">
        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-list"></i></div>
        <div class="stat-value" id="totalPaymentsCount">0</div>
        <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</div>
       </div>
       <div class="stat-card" onclick="filterPaymentsByStatus('paid')" style="cursor: pointer;" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ÿßŸÑŸÖÿØŸÅŸàÿπÿ©">
        <div class="stat-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);"><i class="fas fa-check-circle"></i></div>
        <div class="stat-value" id="paidPaymentsCount">0</div>
        <div class="stat-label">ÿ£ŸÇÿ≥ÿßÿ∑ ŸÖÿ≥ÿØÿØÿ©</div>
       </div>
       <div class="stat-card" onclick="filterPaymentsByStatus('overdue')" style="cursor: pointer;" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿ£ÿÆÿ±ÿ©">
        <div class="stat-icon" style="background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);"><i class="fas fa-exclamation-triangle"></i></div>
        <div class="stat-value" id="overduePaymentsCount">0</div>
        <div class="stat-label">ÿ£ŸÇÿ≥ÿßÿ∑ ŸÖÿ™ÿ£ÿÆÿ±ÿ©</div>
       </div>
       <div class="stat-card" onclick="filterPaymentsByStatus('upcoming')" style="cursor: pointer;" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ÿßŸÑŸÇÿßÿØŸÖÿ©">
        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><i class="fas fa-clock"></i></div>
        <div class="stat-value" id="upcomingPaymentsCount">0</div>
        <div class="stat-label">ÿ£ŸÇÿ≥ÿßÿ∑ ŸÇÿßÿØŸÖÿ©</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"><i class="fas fa-money-bill-wave"></i></div>
        <div class="stat-value" id="totalPaidAmount">0 ÿØ</div>
        <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≥ÿØÿØ</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"><i class="fas fa-hourglass-half"></i></div>
        <div class="stat-value" id="totalRemainingAmount">0 ÿØ</div>
        <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</div>
       </div>
      </div>
      
      <!-- ŸÅŸÑÿßÿ™ÿ± ŸÖÿ™ŸÇÿØŸÖÿ© -->
      <div class="filter-section" style="background: var(--theme-bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--theme-border-color);">
       <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
        <i class="fas fa-filter" style="color: var(--primary-color); font-size: 1.2rem;"></i>
        <h3 style="margin: 0; color: var(--text-primary); font-size: 1.1rem; font-weight: 600;">ÿßŸÑŸÅŸÑÿßÿ™ÿ± ŸàÿßŸÑÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ©</h3>
       </div>
       
       <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <!-- ŸÅŸÑÿ™ÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸÖŸÜ -->
        <div class="form-group">
         <label for="paymentsDateFrom" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          <i class="fas fa-calendar-alt" style="color: var(--primary-color);"></i>
          <span>ŸÖŸÜ ÿ™ÿßÿ±ŸäÿÆ</span>
         </label>
         <input type="date" id="paymentsDateFrom" class="form-control" onchange="applyPaymentsFilters()">
        </div>
        
        <!-- ŸÅŸÑÿ™ÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿ•ŸÑŸâ -->
        <div class="form-group">
         <label for="paymentsDateTo" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          <i class="fas fa-calendar-alt" style="color: var(--primary-color);"></i>
          <span>ÿ•ŸÑŸâ ÿ™ÿßÿ±ŸäÿÆ</span>
         </label>
         <input type="date" id="paymentsDateTo" class="form-control" onchange="applyPaymentsFilters()">
        </div>
        
        <!-- ŸÅŸÑÿ™ÿ± ÿßŸÑÿ≠ÿßŸÑÿ© -->
        <div class="form-group">
         <label for="paymentsStatusFilter" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          <i class="fas fa-tasks" style="color: var(--primary-color);"></i>
          <span>ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØ</span>
         </label>
         <select id="paymentsStatusFilter" class="form-control" onchange="applyPaymentsFilters()">
          <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ÿßŸÑÿßÿ™</option>
          <option value="paid">ŸÖÿ≥ÿØÿØ</option>
          <option value="overdue">ŸÖÿ™ÿ£ÿÆÿ±</option>
          <option value="upcoming">ŸÇÿßÿØŸÖ</option>
          <option value="pending">ŸÖÿπŸÑŸÇ</option>
          <option value="partially_paid">ÿ™ÿ≥ÿØŸäÿØ ÿ¨ÿ≤ÿ¶Ÿä</option>
         </select>
        </div>
        
        <!-- üî• ŸÅŸÑÿ™ÿ± ÿßŸÑÿ£ÿ¥Ÿáÿ± - ÿ¨ÿØŸäÿØ -->
        <div class="form-group">
         <label for="paymentsMonthFilter" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          <i class="fas fa-calendar-alt" style="color: var(--primary-color);"></i>
          <span>ŸÅŸÑÿ™ÿ± ÿ≠ÿ≥ÿ® ÿßŸÑÿ¥Ÿáÿ±</span>
         </label>
         <select id="paymentsMonthFilter" class="form-control" onchange="applyPaymentsFilters()">
          <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¥Ÿáÿ±</option>
          <option value="1">ÿßŸÑÿ¥Ÿáÿ± 1</option>
          <option value="2">ÿßŸÑÿ¥Ÿáÿ± 2</option>
          <option value="3">ÿßŸÑÿ¥Ÿáÿ± 3</option>
          <option value="4">ÿßŸÑÿ¥Ÿáÿ± 4</option>
          <option value="5">ÿßŸÑÿ¥Ÿáÿ± 5</option>
          <option value="6">ÿßŸÑÿ¥Ÿáÿ± 6</option>
          <option value="7">ÿßŸÑÿ¥Ÿáÿ± 7</option>
          <option value="8">ÿßŸÑÿ¥Ÿáÿ± 8</option>
          <option value="9">ÿßŸÑÿ¥Ÿáÿ± 9</option>
          <option value="10">ÿßŸÑÿ¥Ÿáÿ± 10</option>
          <option value="11">ÿßŸÑÿ¥Ÿáÿ± 11</option>
          <option value="12">ÿßŸÑÿ¥Ÿáÿ± 12</option>
          <option value="13+">ÿßŸÑÿ¥Ÿáÿ± 13+</option>
         </select>
        </div>
        
        <!-- ŸÅŸÑÿ™ÿ± ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® -->
        <div class="form-group">
         <label for="paymentsSortFilter" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          <i class="fas fa-sort" style="color: var(--primary-color);"></i>
          <span>ÿ™ÿ±ÿ™Ÿäÿ® ÿ≠ÿ≥ÿ®</span>
         </label>
         <select id="paymentsSortFilter" class="form-control" onchange="applyPaymentsFilters()">
          <option value="date_desc">ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã</option>
          <option value="date_asc">ÿßŸÑÿ£ŸÇÿØŸÖ ÿ£ŸàŸÑÿßŸã</option>
          <option value="amount_desc">ÿßŸÑŸÖÿ®ŸÑÿ∫ (ÿßŸÑÿ£ÿπŸÑŸâ ÿ£ŸàŸÑÿßŸã)</option>
          <option value="amount_asc">ÿßŸÑŸÖÿ®ŸÑÿ∫ (ÿßŸÑÿ£ŸÇŸÑ ÿ£ŸàŸÑÿßŸã)</option>
          <option value="customer_asc">ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ (ÿ£-Ÿä)</option>
          <option value="customer_desc">ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ (Ÿä-ÿ£)</option>
         </select>
        </div>
       </div>
       
       <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÉŸÖ -->
       <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
        <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÅŸÑÿ™ÿ±ÿ© -->
        <button class="btn btn-secondary" onclick="resetPaymentsFilters()">
         <i class="fas fa-redo"></i> ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÅŸÑÿßÿ™ÿ±
        </button>
        
        <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿµÿØŸäÿ± -->
        <button class="btn btn-info" onclick="exportPaymentsReport()">
         <i class="fas fa-file-excel"></i> ÿ™ÿµÿØŸäÿ± Excel
        </button>
        
        <!-- ŸÇÿßÿ¶ŸÖÿ© ŸÖŸÜÿ≥ÿØŸÑÿ© ŸÑŸÑÿ∑ÿ®ÿßÿπÿ© -->
        <div class="dropdown" style="position: relative; display: inline-block;">
         <button class="btn btn-primary" onclick="togglePrintMenu()" style="display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-print"></i> ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
          <i class="fas fa-chevron-down" style="font-size: 0.8rem;"></i>
         </button>
         <div id="printMenuDropdown" style="display: none; position: absolute; background: var(--theme-bg-primary); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 250px; z-index: 1000; margin-top: 5px;">
          <div style="padding: 8px 0;">
           <button onclick="printCompletePaymentsReport(); togglePrintMenu();" style="width: 100%; text-align: right; padding: 10px 15px; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-primary); transition: background 0.2s;" onmouseover="this.style.background='var(--theme-bg-secondary)'" onmouseout="this.style.background='transparent'">
            <i class="fas fa-file-invoice" style="width: 20px; color: #667eea;"></i>
            <span>ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÉÿßŸÖŸÑ</span>
           </button>
           
           <div style="height: 1px; background: var(--border-color); margin: 5px 0;"></div>
           
           <button onclick="printPaymentsStat('total'); togglePrintMenu();" style="width: 100%; text-align: right; padding: 10px 15px; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-primary); transition: background 0.2s;" onmouseover="this.style.background='var(--theme-bg-secondary)'" onmouseout="this.style.background='transparent'">
            <i class="fas fa-list-ol" style="width: 20px; color: #667eea;"></i>
            <span>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</span>
           </button>
           
           <button onclick="printPaymentsStat('paid'); togglePrintMenu();" style="width: 100%; text-align: right; padding: 10px 15px; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-primary); transition: background 0.2s;" onmouseover="this.style.background='var(--theme-bg-secondary)'" onmouseout="this.style.background='transparent'">
            <i class="fas fa-check-circle" style="width: 20px; color: #10b981;"></i>
            <span>ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ≥ÿØÿØÿ©</span>
           </button>
           
           <button onclick="printPaymentsStat('overdue'); togglePrintMenu();" style="width: 100%; text-align: right; padding: 10px 15px; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-primary); transition: background 0.2s;" onmouseover="this.style.background='var(--theme-bg-secondary)'" onmouseout="this.style.background='transparent'">
            <i class="fas fa-exclamation-triangle" style="width: 20px; color: #ef4444;"></i>
            <span>ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ™ÿ£ÿÆÿ±ÿ©</span>
           </button>
           
           <button onclick="printPaymentsStat('upcoming'); togglePrintMenu();" style="width: 100%; text-align: right; padding: 10px 15px; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-primary); transition: background 0.2s;" onmouseover="this.style.background='var(--theme-bg-secondary)'" onmouseout="this.style.background='transparent'">
            <i class="fas fa-clock" style="width: 20px; color: #f59e0b;"></i>
            <span>ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÇÿßÿØŸÖÿ©</span>
           </button>
           
           <button onclick="printPaymentsStat('paidAmount'); togglePrintMenu();" style="width: 100%; text-align: right; padding: 10px 15px; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-primary); transition: background 0.2s;" onmouseover="this.style.background='var(--theme-bg-secondary)'" onmouseout="this.style.background='transparent'">
            <i class="fas fa-money-bill-wave" style="width: 20px; color: #06b6d4;"></i>
            <span>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿØÿØÿ©</span>
           </button>
           
           <button onclick="printPaymentsStat('remainingAmount'); togglePrintMenu();" style="width: 100%; text-align: right; padding: 10px 15px; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-primary); transition: background 0.2s;" onmouseover="this.style.background='var(--theme-bg-secondary)'" onmouseout="this.style.background='transparent'">
            <i class="fas fa-coins" style="width: 20px; color: #8b5cf6;"></i>
            <span>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©</span>
           </button>
          </div>
         </div>
        </div>
        
        <script>
         // ÿØÿßŸÑÿ© ŸÑÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
         function togglePrintMenu() {
          const menu = document.getElementById('printMenuDropdown');
          if (menu) {
           menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
          }
         }
         
         // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨Ÿáÿß
         document.addEventListener('click', function(event) {
          const menu = document.getElementById('printMenuDropdown');
          const printBtn = event.target.closest('.dropdown');
          if (menu && !printBtn && menu.style.display === 'block') {
           menu.style.display = 'none';
          }
         });
        </script>
       </div>
      </div>
      
      <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ -->
      <div class="table-container">
       <table class="table">
        <thead>
         <tr>
          <th><i class="fas fa-hashtag"></i> ÿ±ŸÇŸÖ ÿßŸÑŸÇÿ≥ÿ∑</th>
          <th><i class="fas fa-user"></i> ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ</th>
          <th><i class="fas fa-phone"></i> ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</th>
          <th><i class="fas fa-money-bill-wave"></i> ŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÇÿ≥ÿ∑</th>
          <th><i class="fas fa-calendar-alt"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ</th>
          <th><i class="fas fa-calendar-check"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ÿØŸäÿØ</th>
          <th><i class="fas fa-info-circle"></i> ÿßŸÑÿ≠ÿßŸÑÿ©</th>
          <th><i class="fas fa-cog"></i> ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
         </tr>
        </thead>
        <tbody id="paymentsTableBody">
         <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ° ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
        </tbody>
       </table>
       <div id="noPaymentsMessage" style="display: none; text-align: center; padding: 3rem; color: var(--text-secondary);">
        <i class="fas fa-inbox" style="font-size: 4rem; color: var(--text-secondary); opacity: 0.3; margin-bottom: 1rem;"></i>
        <p style="font-size: 1.2rem; font-weight: 600;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿ≥ÿØŸäÿØÿßÿ™</p>
        <p style="font-size: 0.95rem;">ÿßÿ®ÿØÿ£ ÿ®ÿ•ÿ∂ÿßŸÅÿ© ÿØŸäŸàŸÜ ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ŸáŸÜÿß</p>
       </div>
      </div>
      
      <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© -->
      <div style="background: var(--info-bg); color: var(--info-color); padding: 1rem; border-radius: 8px; margin-top: 1.5rem; border: 1px solid var(--info-border);">
       <div style="display: flex; align-items: center; gap: 0.75rem;">
        <i class="fas fa-info-circle" style="font-size: 1.5rem;"></i>
        <div>
         <strong>ŸÖÿπŸÑŸàŸÖÿ© ŸÖŸÅŸäÿØÿ©:</strong> ŸäŸÖŸÉŸÜŸÉ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÑŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿßŸÑÿ©. ŸÉŸÖÿß ŸäŸÖŸÉŸÜŸÉ ÿ∑ÿ®ÿßÿπÿ© ÿ•ŸäÿµÿßŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØ ŸÑŸÉŸÑ ŸÇÿ≥ÿ∑ ŸÖÿ≥ÿØÿØ.
        </div>
       </div>
      </div>
     </div>
     
     <!-- üí∞ ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ÿßŸÑŸÖÿ™ŸÉÿßŸÖŸÑÿ© -->
     <div id="payments" class="page">
      <div class="section-header" style="margin-bottom: 1.5rem;">
       <div class="section-title"><i class="fas fa-hand-holding-usd"></i> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ŸàÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
       </div>
       <div class="pos-search-box">
           <i class="fas fa-search"></i>
           <input type="text" id="paymentsSearchInput" class="pos-search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿπŸÖŸäŸÑÿå ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ..." onkeyup="filterPayments()">
       </div>
       <button class="btn btn-success" onclick="refreshPaymentsPage()" style="margin-right: 1rem;">
         <i class="fas fa-sync-alt"></i> ÿ™ÿ≠ÿØŸäÿ´
       </button>
      </div>
      
      <!-- ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿπÿ© -->
      <div class="stats-grid" style="margin-bottom: 1.5rem;">
       <div class="stat-card" onclick="filterPaymentsByStatus('all')" style="cursor: pointer;" title="ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™">
        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-calendar-alt"></i>
        </div>
        <div class="stat-value" id="totalPaymentsCount">
         0
        </div>
        <div class="stat-label">
         ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
        </div>
       </div>
       
       <div class="stat-card" onclick="filterPaymentsByStatus('paid')" style="cursor: pointer;" title="ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ≥ÿØÿØÿ©">
        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);"><i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-value" id="paidPaymentsCount">
         0
        </div>
        <div class="stat-label">
         ÿ£ŸÇÿ≥ÿßÿ∑ ŸÖÿ≥ÿØÿØÿ©
        </div>
       </div>
       
       <div class="stat-card" onclick="filterPaymentsByStatus('overdue')" style="cursor: pointer;" title="ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ™ÿ£ÿÆÿ±ÿ©">
        <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);"><i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-value" id="overduePaymentsCount">
         0
        </div>
        <div class="stat-label">
         ÿ£ŸÇÿ≥ÿßÿ∑ ŸÖÿ™ÿ£ÿÆÿ±ÿ©
        </div>
       </div>
       
       <div class="stat-card" onclick="filterPaymentsByStatus('upcoming')" style="cursor: pointer;" title="ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÇÿßÿØŸÖÿ©">
        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);"><i class="fas fa-clock"></i>
        </div>
        <div class="stat-value" id="upcomingPaymentsCount">
         0
        </div>
        <div class="stat-label">
         ÿ£ŸÇÿ≥ÿßÿ∑ ŸÇÿßÿØŸÖÿ©
        </div>
       </div>
       
       <div class="stat-card" style="cursor: default;">
        <div class="stat-icon" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);"><i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-value" id="totalPaidAmount">
         0 ÿØ
        </div>
        <div class="stat-label">
         ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿØÿØÿ©
        </div>
       </div>
       
       <div class="stat-card" style="cursor: default;">
        <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"><i class="fas fa-coins"></i>
        </div>
        <div class="stat-value" id="totalRemainingAmount">
         0 ÿØ
        </div>
        <div class="stat-label">
         ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©
        </div>
       </div>
      </div>
      
      <!-- ŸÅŸÑÿßÿ™ÿ± ŸÖÿ™ŸÇÿØŸÖÿ© -->
      <div class="card" style="margin-bottom: 1.5rem; padding: 20px;">
       <h3 style="margin-bottom: 15px; color: var(--primary-color); display: flex; align-items: center; gap: 10px;">
        <i class="fas fa-filter"></i> ŸÅŸÑÿßÿ™ÿ± ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ©
       </h3>
       
       <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
        <!-- ŸÅŸÑÿ™ÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸÖŸÜ -->
        <div class="form-group">
         <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
          <i class="fas fa-calendar-day"></i> ŸÖŸÜ ÿ™ÿßÿ±ŸäÿÆ:
         </label>
         <input type="date" id="paymentsDateFrom" class="form-control" onchange="applyPaymentsFilters()">
        </div>
        
        <!-- ŸÅŸÑÿ™ÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿ•ŸÑŸâ -->
        <div class="form-group">
         <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
          <i class="fas fa-calendar-day"></i> ÿ•ŸÑŸâ ÿ™ÿßÿ±ŸäÿÆ:
         </label>
         <input type="date" id="paymentsDateTo" class="form-control" onchange="applyPaymentsFilters()">
        </div>
        
        <!-- ŸÅŸÑÿ™ÿ± ÿßŸÑÿ≠ÿßŸÑÿ© -->
        <div class="form-group">
         <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
          <i class="fas fa-info-circle"></i> ÿßŸÑÿ≠ÿßŸÑÿ©:
         </label>
         <select id="paymentsStatusFilter" class="form-control" onchange="applyPaymentsFilters()">
          <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ÿßŸÑÿßÿ™</option>
          <option value="paid">ŸÖÿ≥ÿØÿØÿ©</option>
          <option value="pending">ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±</option>
          <option value="overdue">ŸÖÿ™ÿ£ÿÆÿ±ÿ©</option>
          <option value="upcoming">ŸÇÿßÿØŸÖÿ©</option>
          <option value="partially_paid">ÿ™ÿ≥ÿØŸäÿØ ÿ¨ÿ≤ÿ¶Ÿä</option>
         </select>
        </div>
        
        <!-- üî• ŸÅŸÑÿ™ÿ± ÿßŸÑÿ£ÿ¥Ÿáÿ± - ÿ¨ÿØŸäÿØ -->
        <div class="form-group">
         <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
          <i class="fas fa-calendar-alt"></i> ÿßŸÑÿ¥Ÿáÿ±:
         </label>
         <select id="paymentsMonthFilter" class="form-control" onchange="applyPaymentsFilters()">
          <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¥Ÿáÿ±</option>
          <option value="1">ÿßŸÑÿ¥Ÿáÿ± 1</option>
          <option value="2">ÿßŸÑÿ¥Ÿáÿ± 2</option>
          <option value="3">ÿßŸÑÿ¥Ÿáÿ± 3</option>
          <option value="4">ÿßŸÑÿ¥Ÿáÿ± 4</option>
          <option value="5">ÿßŸÑÿ¥Ÿáÿ± 5</option>
          <option value="6">ÿßŸÑÿ¥Ÿáÿ± 6</option>
          <option value="7">ÿßŸÑÿ¥Ÿáÿ± 7</option>
          <option value="8">ÿßŸÑÿ¥Ÿáÿ± 8</option>
          <option value="9">ÿßŸÑÿ¥Ÿáÿ± 9</option>
          <option value="10">ÿßŸÑÿ¥Ÿáÿ± 10</option>
          <option value="11">ÿßŸÑÿ¥Ÿáÿ± 11</option>
          <option value="12">ÿßŸÑÿ¥Ÿáÿ± 12</option>
          <option value="13+">ÿßŸÑÿ¥Ÿáÿ± 13+</option>
         </select>
        </div>
        
        <!-- ŸÅŸÑÿ™ÿ± ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® -->
        <div class="form-group">
         <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
          <i class="fas fa-sort"></i> ÿ™ÿ±ÿ™Ÿäÿ® ÿ≠ÿ≥ÿ®:
         </label>
         <select id="paymentsSortFilter" class="form-control" onchange="applyPaymentsFilters()">
          <option value="date_desc">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ (ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã)</option>
          <option value="date_asc">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ (ÿßŸÑÿ£ŸÇÿØŸÖ ÿ£ŸàŸÑÿßŸã)</option>
          <option value="amount_desc">ÿßŸÑŸÖÿ®ŸÑÿ∫ (ÿßŸÑÿ£ŸÉÿ®ÿ± ÿ£ŸàŸÑÿßŸã)</option>
          <option value="amount_asc">ÿßŸÑŸÖÿ®ŸÑÿ∫ (ÿßŸÑÿ£ÿµÿ∫ÿ± ÿ£ŸàŸÑÿßŸã)</option>
          <option value="customer_asc">ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ (ÿ£-Ÿä)</option>
          <option value="customer_desc">ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ (Ÿä-ÿ£)</option>
         </select>
        </div>
       </div>
       
       <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÉŸÖ -->
       <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
        <button class="btn btn-secondary" onclick="resetPaymentsFilters()">
         <i class="fas fa-redo"></i> ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÅŸÑÿßÿ™ÿ±
        </button>
        <button class="btn btn-info" onclick="exportPaymentsReport()">
         <i class="fas fa-file-excel"></i> ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± Excel
        </button>
        <button class="btn btn-primary" onclick="printPaymentsReport()">
         <i class="fas fa-print"></i> ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
        </button>
       </div>
      </div>
      
      <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ -->
      <div class="table-container">
       <table class="table">
        <thead>
         <tr>
          <th><i class="fas fa-user"></i> ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ</th>
          <th><i class="fas fa-phone"></i> ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</th>
          <th><i class="fas fa-hashtag"></i> ÿ±ŸÇŸÖ ÿßŸÑŸÇÿ≥ÿ∑</th>
          <th><i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ</th>
          <th><i class="fas fa-money-bill"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇ</th>
          <th><i class="fas fa-calendar-check"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿØŸÅÿπ</th>
          <th><i class="fas fa-info-circle"></i> ÿßŸÑÿ≠ÿßŸÑÿ©</th>
          <th><i class="fas fa-cogs"></i> ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
         </tr>
        </thead>
        <tbody id="paymentsTableBody">
         <tr>
          <td colspan="8" style="text-align: center; padding: 30px;">
           <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary-color);"></i>
           <p style="margin-top: 10px; color: var(--text-secondary);">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™...</p>
          </td>
         </tr>
        </tbody>
       </table>
      </div>
      
      <!-- ÿ±ÿ≥ÿßŸÑÿ© ÿπÿØŸÖ Ÿàÿ¨ŸàÿØ ÿ®ŸäÿßŸÜÿßÿ™ -->
      <div id="noPaymentsMessage" style="display: none; text-align: center; padding: 50px; background: var(--theme-bg-secondary); border-radius: 12px; margin-top: 20px;">
       <i class="fas fa-inbox" style="font-size: 48px; color: var(--text-secondary); opacity: 0.5;"></i>
       <p style="margin-top: 15px; font-size: 18px; color: var(--text-secondary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿ≥ÿØŸäÿØÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©</p>
       <p style="color: var(--text-secondary); opacity: 0.7;">ŸÇŸÖ ÿ®ÿ•ÿ∂ÿßŸÅÿ© ÿØŸäŸàŸÜ ÿ¨ÿØŸäÿØÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ŸáŸÜÿß</p>
      </div>
     </div>
     
     <!-- üí∞ ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ ÿßŸÑÿ¥ÿßŸÖŸÑÿ© -->
     <div id="expenses" class="page">
      <div class="section-header" style="margin-bottom: 1.5rem;">
       <div class="section-title"><i class="fas fa-money-bill-wave"></i> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ ŸàÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™
       </div>
       <div class="pos-search-box">
           <i class="fas fa-search"></i>
           <input type="text" id="expensesSearchInput" class="pos-search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ..." onkeyup="filterExpenses()">
       </div>
       <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <div class="export-import-buttons">
            <button class="export-btn" onclick="exportData('expenses', 'json')"> <i class="fas fa-download"></i> JSON </button> 
            <button class="export-btn" onclick="exportData('expenses', 'excel')"> <i class="fas fa-file-excel"></i> Excel </button> 
            <button class="export-btn" onclick="exportData('expenses', 'pdf')"> <i class="fas fa-file-pdf"></i> PDF </button>
        </div>
        <button class="btn btn-success" onclick="showAddExpenseModal()"> <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿµÿ±ŸàŸÅ </button>
        <button class="btn btn-primary" onclick="showAddPurchaseModal()"> <i class="fas fa-cart-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ </button>
       </div>
      </div>
      
      <!-- ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ¥ÿßŸÖŸÑÿ© -->
      <div class="stats-grid" style="margin-bottom: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
        <div class="stat-value" id="totalExpensesAmount">0 ÿØŸäŸÜÿßÿ±</div>
        <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-check-circle" style="color: var(--success-color);"></i></div>
        <div class="stat-value" id="totalPaidAmount" style="color: var(--success-color);">0 ÿØŸäŸÜÿßÿ±</div>
        <div class="stat-label">ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπÿ©</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-exclamation-circle" style="color: var(--warning-color);"></i></div>
        <div class="stat-value" id="totalRemainingAmount" style="color: var(--warning-color);">0 ÿØŸäŸÜÿßÿ±</div>
        <div class="stat-label">ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
        <div class="stat-value" id="totalPurchasesAmount">0 ÿØŸäŸÜÿßÿ±</div>
        <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-calendar-alt"></i></div>
        <div class="stat-value" id="monthlyExpensesAmount">0 ÿØŸäŸÜÿßÿ±</div>
        <div class="stat-label">ŸÖÿµÿßÿ±ŸäŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-receipt"></i></div>
        <div class="stat-value" id="totalExpensesCount">0</div>
        <div class="stat-label">ÿπÿØÿØ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™</div>
       </div>
      </div>
      
      <!-- Tabs ŸÑŸÑÿ™ÿ®ÿØŸäŸÑ ÿ®ŸäŸÜ ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ ŸàÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ -->
      <div class="expense-tabs">
       <button class="expense-tab-btn active" onclick="switchExpenseTab('general')">
        <i class="fas fa-money-bill-wave"></i> ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ ÿßŸÑÿπÿßŸÖÿ©
       </button>
       <button class="expense-tab-btn" onclick="switchExpenseTab('purchases')">
        <i class="fas fa-shopping-cart"></i> ŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™
       </button>
       <button class="expense-tab-btn" onclick="switchExpenseTab('reports')">
        <i class="fas fa-chart-line"></i> ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±
       </button>
      </div>
      
      <!-- ÿ™ÿ®ŸàŸäÿ® ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ ÿßŸÑÿπÿßŸÖÿ© -->
      <div id="generalExpensesTab" class="expense-tab-content active">
       <div class="table-container">
        <table class="table">
         <thead>
          <tr>
           <th><i class="fas fa-hashtag"></i> #</th>
           <th><i class="fas fa-list"></i> ŸÜŸàÿπ ÿßŸÑŸÖÿµÿ±ŸàŸÅ</th>
           <th><i class="fas fa-money-bill"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÉŸÑŸä</th>
           <th><i class="fas fa-check-circle" style="color: var(--success-color);"></i> ÿßŸÑŸÖÿØŸÅŸàÿπ</th>
           <th><i class="fas fa-exclamation-circle" style="color: var(--warning-color);"></i> ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</th>
           <th><i class="fas fa-calendar"></i> ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
           <th><i class="fas fa-sticky-note"></i> ÿßŸÑŸàÿµŸÅ</th>
           <th><i class="fas fa-user"></i> ÿßŸÑŸÖÿ∂ÿßŸÅ ÿ®Ÿàÿßÿ≥ÿ∑ÿ©</th>
           <th><i class="fas fa-cogs"></i> ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
          </tr>
         </thead>
         <tbody id="generalExpensesTableBody">
          <!-- ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ ÿßŸÑÿπÿßŸÖÿ© ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
         </tbody>
        </table>
       </div>
      </div>
      
      <!-- ÿ™ÿ®ŸàŸäÿ® ŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ -->
      <div id="purchasesTab" class="expense-tab-content">
       <div class="table-container">
        <table class="table">
         <thead>
          <tr>
           <th><i class="fas fa-hashtag"></i> ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</th>
           <th><i class="fas fa-building"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ±ÿØ</th>
           <th><i class="fas fa-phone"></i> Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖŸàÿ±ÿØ</th>
           <th><i class="fas fa-money-bill"></i> ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
           <th><i class="fas fa-boxes"></i> ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</th>
           <th><i class="fas fa-calendar"></i> ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
           <th><i class="fas fa-cogs"></i> ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
          </tr>
         </thead>
         <tbody id="purchasesTableBody">
          <!-- ŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
         </tbody>
        </table>
       </div>
      </div>
      
      <!-- ÿ™ÿ®ŸàŸäÿ® ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± -->
      <div id="reportsTab" class="expense-tab-content">
       <!-- ŸÅŸÑÿ™ÿ± ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± -->
       <div class="reports-filters">
        <div class="filter-group">
         <label><i class="fas fa-calendar"></i> ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©:</label>
         <select id="reportsPeriodFilter" onchange="updateExpensesReports()">
          <option value="today">ÿßŸÑŸäŸàŸÖ</option>
          <option value="week">Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</option>
          <option value="month" selected>Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±</option>
          <option value="year">Ÿáÿ∞ÿß ÿßŸÑÿπÿßŸÖ</option>
          <option value="custom">ŸÅÿ™ÿ±ÿ© ŸÖÿÆÿµÿµÿ©</option>
         </select>
        </div>
        <div class="filter-group" id="customDateRangeGroup" style="display: none;">
         <label>ŸÖŸÜ:</label>
         <input type="date" id="reportsDateFrom">
         <label>ÿ•ŸÑŸâ:</label>
         <input type="date" id="reportsDateTo">
         <button class="btn btn-primary" onclick="updateExpensesReports()">ÿ™ÿ∑ÿ®ŸäŸÇ</button>
        </div>
       </div>
       
       <!-- ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± -->
       <div class="stats-grid" style="margin: 2rem 0;">
        <div class="stat-card">
         <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);"><i class="fas fa-money-bill-wave"></i></div>
         <div class="stat-value" id="reportTotalExpenses">0 ÿØŸäŸÜÿßÿ±</div>
         <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ</div>
        </div>
        <div class="stat-card">
         <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);"><i class="fas fa-shopping-cart"></i></div>
         <div class="stat-value" id="reportTotalPurchases">0 ÿØŸäŸÜÿßÿ±</div>
         <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™</div>
        </div>
        <div class="stat-card">
         <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"><i class="fas fa-home"></i></div>
         <div class="stat-value" id="reportRentExpenses">0 ÿØŸäŸÜÿßÿ±</div>
         <div class="stat-label">ŸÖÿµÿßÿ±ŸäŸÅ ÿßŸÑÿ•Ÿäÿ¨ÿßÿ±</div>
        </div>
        <div class="stat-card">
         <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);"><i class="fas fa-bolt"></i></div>
         <div class="stat-value" id="reportUtilitiesExpenses">0 ÿØŸäŸÜÿßÿ±</div>
         <div class="stat-label">ŸÖÿµÿßÿ±ŸäŸÅ ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ°/ÿßŸÑŸÖÿßÿ°</div>
        </div>
       </div>
       
       <!-- ÿ¨ÿØŸàŸÑ ÿ™ŸÅÿµŸäŸÑŸä ŸÑŸÑŸÖÿµÿßÿ±ŸäŸÅ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜŸàÿπ -->
       <div class="card" style="margin-top: 2rem;">
        <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-chart-pie"></i> ÿ™ŸÅÿµŸäŸÑ ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜŸàÿπ</h3>
        <div class="table-container">
         <table class="table">
          <thead>
           <tr>
            <th><i class="fas fa-list"></i> ŸÜŸàÿπ ÿßŸÑŸÖÿµÿ±ŸàŸÅ</th>
            <th><i class="fas fa-hashtag"></i> ÿßŸÑÿπÿØÿØ</th>
            <th><i class="fas fa-money-bill"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</th>
            <th><i class="fas fa-percent"></i> ÿßŸÑŸÜÿ≥ÿ®ÿ©</th>
           </tr>
          </thead>
          <tbody id="expensesByTypeTableBody">
           <!-- ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
          </tbody>
         </table>
        </div>
       </div>
       
       <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ¥ÿ™ÿ±ÿßÿ© -->
       <div class="card" style="margin-top: 2rem;">
        <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-boxes"></i> ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ¥ÿ™ÿ±ÿßÿ© ŸÅŸä ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©</h3>
        <div class="table-container">
         <table class="table">
          <thead>
           <tr>
            <th><i class="fas fa-box"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
            <th><i class="fas fa-building"></i> ÿßŸÑŸÖŸàÿ±ÿØ</th>
            <th><i class="fas fa-sort-numeric-up"></i> ÿßŸÑŸÉŸÖŸäÿ©</th>
            <th><i class="fas fa-money-bill"></i> ÿßŸÑÿ≥ÿπÿ±</th>
            <th><i class="fas fa-money-bill-wave"></i> ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</th>
            <th><i class="fas fa-calendar"></i> ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
           </tr>
          </thead>
          <tbody id="purchasedProductsTableBody">
           <!-- ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ¥ÿ™ÿ±ÿßÿ© ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </div>
     
     <!-- ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ∑ÿßÿ®ÿπÿ© -->
     <div id="printer" class="page">
      <div class="section-header">
       <div class="section-title"><i class="fas fa-print"></i> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ©
       </div>
       <div style="display: flex; gap: 1rem;">
        <button class="btn btn-primary" onclick="testPrintReceipt()">
         <i class="fas fa-print"></i> ÿ∑ÿ®ÿßÿπÿ© ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©
        </button>
        <button class="btn btn-success" onclick="savePrinterSettings()">
         <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
        </button>
        <button class="btn btn-secondary" onclick="resetPrinterSettings()">
         <i class="fas fa-undo"></i> ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
        </button>
        <button class="btn btn-info" onclick="refreshPrintersList()">
         <i class="fas fa-sync"></i> ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∑ÿßÿ®ÿπÿßÿ™
        </button>
       </div>
      </div>

      <div class="stats-grid">
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-print"></i></div>
        <div class="stat-value" id="totalPrints">0</div>
        <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ∑ÿ®Ÿàÿπÿßÿ™</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
        <div class="stat-value" id="todayPrints">0</div>
        <div class="stat-label">ŸÖÿ∑ÿ®Ÿàÿπÿßÿ™ ÿßŸÑŸäŸàŸÖ</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-cog"></i></div>
        <div class="stat-value" id="activePrinterType">A4</div>
        <div class="stat-label">ŸÜŸàÿπ ÿßŸÑÿ∑ÿßÿ®ÿπÿ© ÿßŸÑŸÜÿ¥ÿ∑</div>
       </div>
       <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-receipt"></i></div>
        <div class="stat-value" id="activeTemplateType">ŸÜŸÇÿØŸä</div>
        <div class="stat-label">ÿßŸÑŸÇÿßŸÑÿ® ÿßŸÑŸÜÿ¥ÿ∑</div>
       </div>
      </div>

      <!-- ŸÇÿ≥ŸÖ ÿßŸÑÿ∑ÿßÿ®ÿπÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÑÿ© -->
      <div class="table-container" style="margin-top: 2rem;">
       <div style="padding: 1.5rem;">
        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
         <i class="fas fa-printer"></i> ÿßŸÑÿ∑ÿßÿ®ÿπÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÑÿ©
        </h3>
        <div id="connectedPrintersList" style="min-height: 100px;">
         <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
          <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
          <p>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ∑ÿßÿ®ÿπÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÑÿ©...</p>
         </div>
        </div>
       </div>
      </div>

      <!-- ŸÇÿ≥ŸÖ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿßÿ®ÿπÿ© ŸàÿßŸÑŸÖÿπÿßŸäŸÜÿ© -->
      <div style="display: grid; grid-template-columns: 400px 1fr; gap: 2rem; margin-top: 2rem;">
       
       <!-- ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ -->
       <div class="table-container" style="height: fit-content;">
        <div style="padding: 1.5rem;">
         <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-cog"></i> ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÇÿßŸÑÿ®
         </h3>

         <!-- ÿßÿÆÿ™Ÿäÿßÿ± ŸÜŸàÿπ ÿßŸÑŸÇÿßŸÑÿ® -->
         <div class="form-group">
          <label class="form-label">
           <i class="fas fa-file-invoice"></i> ŸÜŸàÿπ ÿßŸÑŸÇÿßŸÑÿ®
          </label>
          <select class="form-select" id="receiptTemplate" onchange="updateReceiptPreview()">
           <option value="cash">ÿ•ŸäÿµÿßŸÑ ŸÜŸÇÿØŸä</option>
           <option value="installment">ÿ•ŸäÿµÿßŸÑ ÿ™ŸÇÿ≥Ÿäÿ∑</option>
          </select>
         </div>

         <!-- ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ∑ÿßÿ®ÿπÿ© -->
         <div class="form-group">
          <label class="form-label">
           <i class="fas fa-print"></i> ÿßŸÑÿ∑ÿßÿ®ÿπÿ© ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©
          </label>
          <select class="form-select" id="selectedPrinter">
           <option value="">ÿßŸÑÿ∑ÿßÿ®ÿπÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©</option>
          </select>
         </div>

         <!-- ŸÜŸàÿπ ÿßŸÑÿ∑ÿßÿ®ÿπÿ© -->
         <div class="form-group">
          <label class="form-label">
           <i class="fas fa-print"></i> ŸÜŸàÿπ ÿßŸÑÿ∑ÿßÿ®ÿπÿ©
          </label>
          <select class="form-select" id="printerType" onchange="updateReceiptPreview()">
           <option value="a4">ÿ∑ÿßÿ®ÿπÿ© A4</option>
           <option value="thermal-80">ÿ∑ÿßÿ®ÿπÿ© ÿ≠ÿ±ÿßÿ±Ÿäÿ© 80mm</option>
           <option value="thermal-58">ÿ∑ÿßÿ®ÿπÿ© ÿ≠ÿ±ÿßÿ±Ÿäÿ© 58mm</option>
          </select>
         </div>

         <hr style="margin: 1.5rem 0; border-color: var(--border-color);">

         <!-- ÿ£ÿ≠ÿ¨ÿßŸÖ ÿßŸÑÿÆÿ∑Ÿàÿ∑ -->
         <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-text-height"></i> ÿ£ÿ≠ÿ¨ÿßŸÖ ÿßŸÑÿÆÿ∑Ÿàÿ∑
         </h4>

         <!-- ÿ≠ÿ¨ŸÖ ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖÿ™ÿ¨ÿ± -->
         <div class="form-group">
          <label class="form-label">ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖÿ™ÿ¨ÿ± (px)</label>
          <input type="range" class="form-range" id="storeTitleSize" min="14" max="32" value="24" 
                 oninput="updateReceiptPreview(); document.getElementById('storeTitleSizeValue').textContent = this.value">
          <span id="storeTitleSizeValue" style="font-weight: bold;">24</span>
         </div>

         <!-- ÿ≠ÿ¨ŸÖ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ± -->
         <div class="form-group">
          <label class="form-label">ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ± (px)</label>
          <input type="range" class="form-range" id="storeInfoSize" min="10" max="20" value="14" 
                 oninput="updateReceiptPreview(); document.getElementById('storeInfoSizeValue').textContent = this.value">
          <span id="storeInfoSizeValue" style="font-weight: bold;">14</span>
         </div>

         <!-- ÿ≠ÿ¨ŸÖ ŸÜÿµ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© -->
         <div class="form-group">
          <label class="form-label">ŸÜÿµ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© (px)</label>
          <input type="range" class="form-range" id="invoiceTextSize" min="10" max="18" value="13" 
                 oninput="updateReceiptPreview(); document.getElementById('invoiceTextSizeValue').textContent = this.value">
          <span id="invoiceTextSizeValue" style="font-weight: bold;">13</span>
         </div>

         <!-- ÿ≠ÿ¨ŸÖ ÿßŸÑÿ¨ÿØŸàŸÑ -->
         <div class="form-group">
          <label class="form-label">ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ (px)</label>
          <input type="range" class="form-range" id="tableTextSize" min="10" max="18" value="12" 
                 oninput="updateReceiptPreview(); document.getElementById('tableTextSizeValue').textContent = this.value">
          <span id="tableTextSizeValue" style="font-weight: bold;">12</span>
         </div>

         <!-- ÿ≠ÿ¨ŸÖ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä -->
         <div class="form-group">
          <label class="form-label">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä (px)</label>
          <input type="range" class="form-range" id="totalTextSize" min="12" max="22" value="16" 
                 oninput="updateReceiptPreview(); document.getElementById('totalTextSizeValue').textContent = this.value">
          <span id="totalTextSizeValue" style="font-weight: bold;">16</span>
         </div>

         <hr style="margin: 1.5rem 0; border-color: var(--border-color);">

         <!-- ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ•ŸäÿµÿßŸÑ -->
         <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-paint-brush"></i> ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ•ŸäÿµÿßŸÑ
         </h4>

         <!-- ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ÿ®ŸäŸÜ ÿßŸÑÿ£ÿ≥ÿ∑ÿ± -->
         <div class="form-group">
          <label class="form-label">ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ÿ®ŸäŸÜ ÿßŸÑÿ£ÿ≥ÿ∑ÿ±</label>
          <input type="range" class="form-range" id="lineHeight" min="1" max="2" step="0.1" value="1.4" 
                 oninput="updateReceiptPreview(); document.getElementById('lineHeightValue').textContent = this.value">
          <span id="lineHeightValue" style="font-weight: bold;">1.4</span>
         </div>

         <!-- ÿßŸÑŸáŸàÿßŸÖÿ¥ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ© -->
         <div class="form-group">
          <label class="form-label">ÿßŸÑŸáŸàÿßŸÖÿ¥ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ© (px)</label>
          <input type="range" class="form-range" id="sidePadding" min="5" max="30" value="15" 
                 oninput="updateReceiptPreview(); document.getElementById('sidePaddingValue').textContent = this.value">
          <span id="sidePaddingValue" style="font-weight: bold;">15</span>
         </div>

         <hr style="margin: 1.5rem 0; border-color: var(--border-color);">

         <!-- ÿÆŸäÿßÿ±ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© -->
         <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-sliders-h"></i> ÿÆŸäÿßÿ±ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©
         </h4>

         <!-- ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™ -->
         <div class="form-group">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
           <input type="checkbox" id="showDateTime" checked onchange="updateReceiptPreview()">
           <span>ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™</span>
          </label>
         </div>

         <!-- ÿ•ÿ∏Ÿáÿßÿ± ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© -->
         <div class="form-group">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
           <input type="checkbox" id="showInvoiceNumber" checked onchange="updateReceiptPreview()">
           <span>ÿ•ÿ∏Ÿáÿßÿ± ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</span>
          </label>
         </div>

         <!-- ŸÜÿµ ÿßŸÑÿ™ÿ∞ŸäŸäŸÑ ÿßŸÑŸÖÿÆÿµÿµ -->
         <div class="form-group">
          <label class="form-label">ŸÜÿµ ÿßŸÑÿ™ÿ∞ŸäŸäŸÑ ÿßŸÑŸÖÿÆÿµÿµ</label>
          <textarea class="form-control" id="customFooter" rows="2" 
                    placeholder="ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ≤Ÿäÿßÿ±ÿ™ŸÉŸÖ" oninput="updateReceiptPreview()"></textarea>
         </div>

         <hr style="margin: 1.5rem 0; border-color: var(--border-color);">

         <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ± -->
         <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-store"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ±
         </h4>

         <!-- ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ™ÿ¨ÿ± -->
         <div class="form-group">
          <label class="form-label">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ™ÿ¨ÿ±</label>
          <input type="text" class="form-control" id="storeName" 
                 value="ŸÖÿπÿ±ÿ∂ ŸäÿπŸÇŸàÿ® ŸÑŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ©"
                 placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ™ÿ¨ÿ±" oninput="updateReceiptPreview()">
         </div>

         <!-- ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖÿ™ÿ¨ÿ± -->
         <div class="form-group">
          <label class="form-label">ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖÿ™ÿ¨ÿ±</label>
          <input type="text" class="form-control" id="storeAddress" 
                 value="ÿ®ÿßÿ® ÿßŸÑŸáÿßÿ¥ŸÖŸäÿ© ŸÇÿ±ÿ® ŸÖÿØÿ±ÿ≥ÿ© ÿßŸÑŸÉÿ±ÿßÿ±"
                 placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ" oninput="updateReceiptPreview()">
         </div>

         <!-- Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖÿ™ÿ¨ÿ± -->
         <div class="form-group">
          <label class="form-label">Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖÿ™ÿ¨ÿ±</label>
          <input type="text" class="form-control" id="storePhone" 
                 value="07803092185"
                 placeholder="ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ" oninput="updateReceiptPreview()">
         </div>

         <!-- ŸÖÿ≥ÿßÿ± ÿßŸÑŸÑŸàÿ¨Ÿà -->
         <div class="form-group">
          <label class="form-label">ŸÖÿ≥ÿßÿ± ÿßŸÑŸÑŸàÿ¨Ÿà</label>
          <input type="text" class="form-control" id="storeLogo" 
                 value="yaqoub_logo.png"
                 placeholder="ÿßÿ≥ŸÖ ŸÖŸÑŸÅ ÿßŸÑŸÑŸàÿ¨Ÿà" oninput="updateReceiptPreview()">
          <small style="color: var(--text-secondary); font-size: 0.85rem;">
           ÿ∂ÿπ ŸÖŸÑŸÅ ÿßŸÑÿµŸàÿ±ÿ© ŸÅŸä ŸÖÿ¨ŸÑÿØ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸàÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖŸáÿß ŸáŸÜÿß
          </small>
         </div>

         <!-- ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÑŸàÿ¨Ÿà -->
         <div class="form-group">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
           <input type="checkbox" id="showLogo" checked onchange="updateReceiptPreview()">
           <span>ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÑŸàÿ¨Ÿà ŸÅŸä ÿßŸÑÿ•ŸäÿµÿßŸÑ</span>
          </label>
         </div>

         <hr style="margin: 1.5rem 0; border-color: var(--border-color);">

         <!-- ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ -->
         <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-sticky-note"></i> ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿßŸÑŸáÿßŸÖÿ©
         </h4>

         <!-- ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© 1 -->
         <div class="form-group">
          <label class="form-label">ŸÖŸÑÿßÿ≠ÿ∏ÿ© 1</label>
          <input type="text" class="form-control" id="note1" 
                 value="ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖŸàÿ¨ŸàÿØ ŸáŸà ŸàÿµŸÑ ÿ£ŸÖÿßŸÜÿ©"
                 oninput="updateReceiptPreview()">
         </div>

         <!-- ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© 2 -->
         <div class="form-group">
          <label class="form-label">ŸÖŸÑÿßÿ≠ÿ∏ÿ© 2</label>
          <input type="text" class="form-control" id="note2" 
                 value="ÿßŸÑÿ≥ÿπÿ± ŸÖÿ≠ŸÖŸä 24 ÿ≥ÿßÿπÿ©"
                 oninput="updateReceiptPreview()">
         </div>

         <!-- ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© 3 -->
         <div class="form-group">
          <label class="form-label">ŸÖŸÑÿßÿ≠ÿ∏ÿ© 3</label>
          <input type="text" class="form-control" id="note3" 
                 value="ÿßŸÑŸÖÿ®ÿßÿπ ŸÑÿß Ÿäÿ±ÿ¨ÿπ ŸàŸÑÿß Ÿäÿ®ÿØŸÑ"
                 oninput="updateReceiptPreview()">
         </div>

         <!-- ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© 4 -->
         <div class="form-group">
          <label class="form-label">ŸÖŸÑÿßÿ≠ÿ∏ÿ© 4</label>
          <input type="text" class="form-control" id="note4" 
                 value="ÿßŸÑÿÆÿ∑ÿ£ ŸàÿßŸÑÿ≥ŸáŸà ŸÖÿ±ÿ¨Ÿàÿπ ŸÑŸÑÿ∑ÿ±ŸÅŸäŸÜ"
                 oninput="updateReceiptPreview()">
         </div>

         <!-- ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© 5 -->
         <div class="form-group">
          <label class="form-label">ŸÖŸÑÿßÿ≠ÿ∏ÿ© 5</label>
          <input type="text" class="form-control" id="note5" 
                 value="ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿßŸÑŸÖÿµŸÜÿπÿ© ŸÖÿ≥ÿ§ŸàŸÑÿ© ÿπŸÜ ÿßŸÑÿ∂ŸÖÿßŸÜ"
                 oninput="updateReceiptPreview()">
         </div>

         <!-- ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© 6 -->
         <div class="form-group">
          <label class="form-label">ŸÖŸÑÿßÿ≠ÿ∏ÿ© 6</label>
          <input type="text" class="form-control" id="note6" 
                 value="ŸÉÿ≥ÿ± ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿ∫Ÿäÿ± ÿØÿßÿÆŸÑ ÿ®ÿßŸÑÿ∂ŸÖÿßŸÜ"
                 oninput="updateReceiptPreview()">
         </div>

         <hr style="margin: 1.5rem 0; border-color: var(--border-color);">

         <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ© -->
         <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-tools"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©
         </h4>

         <!-- ÿßÿ≥ŸÖ ŸÖÿ≥ÿ§ŸàŸÑ ÿßŸÑÿµŸäÿßŸÜÿ© -->
         <div class="form-group">
          <label class="form-label">ÿßÿ≥ŸÖ ŸÖÿ≥ÿ§ŸàŸÑ ÿßŸÑÿµŸäÿßŸÜÿ©</label>
          <input type="text" class="form-control" id="maintenanceName" 
                 value="ÿ≠ŸÖÿ≤Ÿá ÿßÿ®Ÿà ÿ≠Ÿàÿ±ÿßÿ°"
                 oninput="updateReceiptPreview()">
         </div>

         <!-- ŸÜŸàÿπ ÿßŸÑÿÆÿØŸÖÿ© -->
         <div class="form-group">
          <label class="form-label">ŸÜŸàÿπ ÿÆÿØŸÖÿ© ÿßŸÑÿµŸäÿßŸÜÿ©</label>
          <input type="text" class="form-control" id="maintenanceService" 
                 value="ÿµŸäÿßŸÜÿ© ÿßŸÑÿ≥ÿ®ÿßŸÑÿ™"
                 oninput="updateReceiptPreview()">
         </div>

         <!-- Ÿáÿßÿ™ŸÅ ÿßŸÑÿµŸäÿßŸÜÿ© -->
         <div class="form-group">
          <label class="form-label">Ÿáÿßÿ™ŸÅ ÿßŸÑÿµŸäÿßŸÜÿ©</label>
          <input type="text" class="form-control" id="maintenancePhone" 
                 value="+964 785 570 6118"
                 oninput="updateReceiptPreview()">
         </div>

         <!-- ÿ•ÿ∏Ÿáÿßÿ± ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ© -->
         <div class="form-group">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
           <input type="checkbox" id="showMaintenance" checked onchange="updateReceiptPreview()">
           <span>ÿ•ÿ∏Ÿáÿßÿ± ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©</span>
          </label>
         </div>

        </div>
       </div>

       <!-- ŸÖÿπÿßŸäŸÜÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ© -->
       <div class="table-container">
        <div style="padding: 1.5rem;">
         <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between;">
          <span><i class="fas fa-eye"></i> ŸÖÿπÿßŸäŸÜÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©</span>
          <span style="font-size: 0.9rem; color: var(--text-secondary);">
           ÿ™ÿ≠ÿØŸäÿ´ ÿ™ŸÑŸÇÿßÿ¶Ÿä
          </span>
         </h3>
         
         <!-- ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿπÿßŸäŸÜÿ© -->
         <div style="background: var(--bg-secondary); padding: 2rem; border-radius: 12px; display: flex; justify-content: center; align-items: flex-start; min-height: 600px; max-height: 800px; overflow-y: auto;">
          <div id="receiptPreview" style="background: white; color: black; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border-radius: 4px; max-width: 100%; overflow: hidden;">
           <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ° ÿßŸÑŸÖÿπÿßŸäŸÜÿ© ŸáŸÜÿß -->
          </div>
         </div>

        </div>
       </div>

      </div>

     </div>

     <!-- ÿµŸÅÿ≠ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπÿßŸÖÿ© -->
     <div id="settings" class="page">
      <div class="section-header" style="margin-bottom: 2rem;">
       <div class="section-title"><i class="fas fa-cog"></i> ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©</div>
       <div class="section-subtitle">ÿ•ÿØÿßÿ±ÿ© ÿ¨ŸÖŸäÿπ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ ŸÖŸÜ ŸÖŸÉÿßŸÜ Ÿàÿßÿ≠ÿØ</div>
      </div>

      <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ© ÿπŸÜ ÿßŸÑŸÜÿ∏ÿßŸÖ -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div class="info-mini-card">
          <div class="info-mini-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
            <i class="fas fa-box"></i>
          </div>
          <div class="info-mini-content">
            <div class="info-mini-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</div>
            <div class="info-mini-value" id="settingsProductCount">0</div>
          </div>
        </div>
        
        <div class="info-mini-card">
          <div class="info-mini-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
            <i class="fas fa-layer-group"></i>
          </div>
          <div class="info-mini-content">
            <div class="info-mini-label">ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™</div>
            <div class="info-mini-value" id="settingsCategoryCount">0</div>
          </div>
        </div>
        
        <div class="info-mini-card">
          <div class="info-mini-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
            <i class="fas fa-receipt"></i>
          </div>
          <div class="info-mini-content">
            <div class="info-mini-label">ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±</div>
            <div class="info-mini-value" id="settingsInvoiceCount">0</div>
          </div>
        </div>
        
        <div class="info-mini-card">
          <div class="info-mini-icon" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
            <i class="fas fa-money-bill-wave"></i>
          </div>
          <div class="info-mini-content">
            <div class="info-mini-label">ŸÇŸäŸÖÿ© ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™</div>
            <div class="info-mini-value" id="settingsSalesValue">0 ÿØ.ÿπ</div>
          </div>
        </div>
      </div>

      <!-- ŸÇÿ≥ŸÖ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© -->
      <div style="margin-bottom: 2rem;">
        <h3 style="font-size: 1.3rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--theme-text-primary); display: flex; align-items: center; gap: 0.75rem;">
          <span style="width: 4px; height: 24px; background: var(--primary-gradient); border-radius: 2px;"></span>
          <i class="fas fa-sliders-h"></i>
          ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
        </h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem;">
          
          <!-- ÿ®ÿ∑ÿßŸÇÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ± -->
          <div class="settings-card" onclick="showSettingsPage('store')">
            <div class="settings-card-icon store-icon">
              <i class="fas fa-store"></i>
            </div>
            <div class="settings-card-content">
              <h3>ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ±</h3>
              <p>ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ±ÿå ÿßŸÑÿπŸÜŸàÿßŸÜÿå ÿßŸÑÿ∂ÿ±ÿßÿ¶ÿ® ŸàÿßŸÑŸÅÿ±Ÿàÿπ</p>
            </div>
            <div class="settings-card-arrow">
              <i class="fas fa-chevron-left"></i>
            </div>
          </div>

          <!-- ÿ®ÿ∑ÿßŸÇÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ -->
          <div class="settings-card" onclick="showSettingsPage('system')">
            <div class="settings-card-icon system-icon">
              <i class="fas fa-desktop"></i>
            </div>
            <div class="settings-card-content">
              <h3>ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ</h3>
              <p>ÿßŸÑŸÖÿ∏Ÿáÿ±ÿå ÿßŸÑŸÑÿ∫ÿ©ÿå ÿßŸÑÿπŸÖŸÑÿ© Ÿàÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπÿ±ÿ∂</p>
            </div>
            <div class="settings-card-arrow">
              <i class="fas fa-chevron-left"></i>
            </div>
          </div>

          <!-- ÿ®ÿ∑ÿßŸÇÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© -->
          <div class="settings-card" onclick="showSettingsPage('printing')">
            <div class="settings-card-icon printing-icon">
              <i class="fas fa-print"></i>
            </div>
            <div class="settings-card-content">
              <h3>ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©</h3>
              <p>ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ŸàÿßŸÑÿ∑ÿßÿ®ÿπÿßÿ™</p>
            </div>
            <div class="settings-card-arrow">
              <i class="fas fa-chevron-left"></i>
            </div>
          </div>

          <!-- ÿ®ÿ∑ÿßŸÇÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ -->
          <div class="settings-card" onclick="showSettingsPage('account')">
            <div class="settings-card-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
              <i class="fas fa-user-circle"></i>
            </div>
            <div class="settings-card-content">
              <h3>ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</h3>
              <p>ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿå ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸàÿßŸÑÿ¥ÿ±ŸÉÿ©</p>
            </div>
            <div class="settings-card-arrow">
              <i class="fas fa-chevron-left"></i>
            </div>
          </div>

        </div>
      </div>

      <!-- ŸÇÿ≥ŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä -->
      <div style="margin-bottom: 2rem;">
        <h3 style="font-size: 1.3rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--theme-text-primary); display: flex; align-items: center; gap: 0.75rem;">
          <span style="width: 4px; height: 24px; background: var(--primary-gradient); border-radius: 2px;"></span>
          <i class="fas fa-database"></i>
          ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä
        </h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem;">
          
          <!-- ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© -->
          <div class="settings-card" onclick="showSettingsPage('backup')">
            <div class="settings-card-icon backup-icon">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="settings-card-content">
              <h3>ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©</h3>
              <p>ÿ•ŸÜÿ¥ÿßÿ° Ÿàÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™</p>
            </div>
            <div class="settings-card-arrow">
              <i class="fas fa-chevron-left"></i>
            </div>
          </div>

          <!-- ÿ®ÿ∑ÿßŸÇÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ŸÖÿßŸÜ -->
          <div class="settings-card" onclick="showSettingsPage('security')">
            <div class="settings-card-icon security-icon">
              <i class="fas fa-shield-alt"></i>
            </div>
            <div class="settings-card-content">
              <h3>ÿßŸÑÿ£ŸÖÿßŸÜ ŸàÿßŸÑÿÆÿµŸàÿµŸäÿ©</h3>
              <p>ŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÖÿ±Ÿàÿ± ŸàÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™</p>
            </div>
            <div class="settings-card-arrow">
              <i class="fas fa-chevron-left"></i>
            </div>
          </div>

        </div>
      </div>

      <!-- ŸÇÿ≥ŸÖ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸàÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± -->
      <div style="margin-bottom: 2rem;">
        <h3 style="font-size: 1.3rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--theme-text-primary); display: flex; align-items: center; gap: 0.75rem;">
          <span style="width: 4px; height: 24px; background: var(--primary-gradient); border-radius: 2px;"></span>
          <i class="fas fa-chart-line"></i>
          ŸÜÿ∏ÿ±ÿ© ÿπÿßŸÖÿ© ÿπŸÑŸâ ÿßŸÑŸÜÿ∏ÿßŸÖ
        </h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
          
          <!-- ÿ®ÿ∑ÿßŸÇÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ -->
          <div class="stat-overview-card">
            <div class="stat-overview-header">
              <div class="stat-overview-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                <i class="fas fa-warehouse"></i>
              </div>
              <h4>ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</h4>
            </div>
            <div class="stat-overview-body">
              <div class="stat-overview-item">
                <span>ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÜÿ¥ÿ∑ÿ©</span>
                <strong id="activeProductsCount">0</strong>
              </div>
              <div class="stat-overview-item">
                <span>ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÇÿßÿ±ÿ®ÿ™ ÿßŸÑŸÜŸÅÿßÿ∞</span>
                <strong id="lowStockCount" style="color: #fbbf24;">0</strong>
              </div>
              <div class="stat-overview-item">
                <span>ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÜŸÅÿ∞ÿ™</span>
                <strong id="outOfStockCount" style="color: #ef4444;">0</strong>
              </div>
            </div>
          </div>

          <!-- ÿ®ÿ∑ÿßŸÇÿ© ŸÖŸÑÿÆÿµ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ -->
          <div class="stat-overview-card">
            <div class="stat-overview-header">
              <div class="stat-overview-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                <i class="fas fa-chart-bar"></i>
              </div>
              <h4>ŸÖŸÑÿÆÿµ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™</h4>
            </div>
            <div class="stat-overview-body">
              <div class="stat-overview-item">
                <span>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±</span>
                <strong id="totalInvoicesCount">0</strong>
              </div>
              <div class="stat-overview-item">
                <span>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™</span>
                <strong id="totalSalesAmount">0 ÿØ.ÿπ</strong>
              </div>
              <div class="stat-overview-item">
                <span>ŸÖÿ™Ÿàÿ≥ÿ∑ ŸÇŸäŸÖÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</span>
                <strong id="averageInvoice">0 ÿØ.ÿπ</strong>
              </div>
            </div>
          </div>

          <!-- ÿ®ÿ∑ÿßŸÇÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸäŸàŸÜ -->
          <div class="stat-overview-card">
            <div class="stat-overview-header">
              <div class="stat-overview-icon" style="background: linear-gradient(135deg, #fa709a, #fee140);">
                <i class="fas fa-file-invoice-dollar"></i>
              </div>
              <h4>ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸäŸàŸÜ</h4>
            </div>
            <div class="stat-overview-body">
              <div class="stat-overview-item">
                <span>ÿπÿØÿØ ÿßŸÑŸÖÿØŸäŸÜŸäŸÜ</span>
                <strong id="totalDebtorsCount">0</strong>
              </div>
              <div class="stat-overview-item">
                <span>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿØŸäŸàŸÜ</span>
                <strong id="totalDebtsAmount">0 ÿØ.ÿπ</strong>
              </div>
                            <div class="stat-overview-item">
                                <span>ÿØŸäŸàŸÜ ŸÖÿ™ÿ£ÿÆÿ±ÿ©</span>
                                <strong id="overdueDebtsCount" style="color: #ef4444;">0</strong>
                            </div>
                            <div class="stat-overview-item">
                                <span>ÿØŸäŸàŸÜ ŸÖÿ¥ÿØÿØÿ©</span>
                                <strong id="severeDebtsCount" style="color: #b91c1c;">0</strong>
                            </div>
            </div>
          </div>

          <!-- ÿ®ÿ∑ÿßŸÇÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ -->
          <div class="stat-overview-card">
            <div class="stat-overview-header">
              <div class="stat-overview-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                <i class="fas fa-info-circle"></i>
              </div>
              <h4>ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ</h4>
            </div>
            <div class="stat-overview-body">
              <div class="stat-overview-item">
                <span>ÿ•ÿµÿØÿßÿ± ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</span>
                <strong>v2.0.0</strong>
              </div>
              <div class="stat-overview-item">
                <span>ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©</span>
                <strong id="lastBackupDate">ŸÑÿß ÿ™Ÿàÿ¨ÿØ</strong>
              </div>
              <div class="stat-overview-item">
                <span>ÿ≠ÿßŸÑÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ</span>
                <strong style="color: #22c55e;">
                  <i class="fas fa-check-circle"></i> ŸäÿπŸÖŸÑ ÿ®ÿ¥ŸÉŸÑ ÿ¨ŸäÿØ
                </strong>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- ŸÇÿ≥ŸÖ ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿπÿ© -->
      <div>
        <h3 style="font-size: 1.3rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--theme-text-primary); display: flex; align-items: center; gap: 0.75rem;">
          <span style="width: 4px; height: 24px; background: var(--primary-gradient); border-radius: 2px;"></span>
          <i class="fas fa-bolt"></i>
          ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ©
        </h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          
          <button class="quick-action-btn" onclick="showSettingsPage('backup')" style="background: linear-gradient(135deg, #667eea, #764ba2);">
            <i class="fas fa-download"></i>
            <span>ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
          </button>

          <button class="quick-action-btn" onclick="window.print()" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
            <i class="fas fa-print"></i>
            <span>ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±</span>
          </button>

          <button class="quick-action-btn" onclick="refreshApp()" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
            <i class="fas fa-sync-alt"></i>
            <span>ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
          </button>

          <button class="quick-action-btn" onclick="showSettingsPage('system')" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
            <i class="fas fa-palette"></i>
            <span>ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÖÿ∏Ÿáÿ±</span>
          </button>

        </div>
      </div>

     </div>

     <!-- ÿµŸÅÿ≠ÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ± -->
     <div id="settings-store" class="page" style="display: none;">
      <div class="section-header">
       <button class="btn btn-secondary" onclick="showPage('settings')" style="margin-left: 1rem;">
         <i class="fas fa-arrow-right"></i> ÿ±ÿ¨Ÿàÿπ
       </button>
       <div class="section-title"><i class="fas fa-store"></i> ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ±</div>
      </div>

      <div class="settings-full-width">
        <div class="settings-content-wrapper">
          
          <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ± ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-info-circle"></i> ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
            </h3>
            
            <div class="form-group">
              <label class="form-label"><i class="fas fa-store"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ™ÿ¨ÿ±</label>
              <input type="text" class="form-input" id="settingsStoreName" placeholder="ÿßÿ≥ŸÖ ŸÖÿ™ÿ¨ÿ±ŸÉ">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-user"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖÿßŸÑŸÉ</label>
              <input type="text" class="form-input" id="settingsOwnerName" placeholder="ÿßÿ≥ŸÖ ŸÖÿßŸÑŸÉ ÿßŸÑŸÖÿ™ÿ¨ÿ±">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-file-alt"></i> ÿ±ŸÇŸÖ ÿßŸÑÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿä</label>
              <input type="text" class="form-input" id="settingsCommercialReg" placeholder="ÿ±ŸÇŸÖ ÿßŸÑÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿä">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-certificate"></i> ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑÿ∂ÿ±Ÿäÿ®Ÿä</label>
              <input type="text" class="form-input" id="settingsTaxNumber" placeholder="ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑÿ∂ÿ±Ÿäÿ®Ÿä ŸÑŸÑŸÖÿ™ÿ¨ÿ±">
            </div>
          </div>

          <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-address-card"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ
            </h3>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-map-marker-alt"></i> ÿßŸÑÿπŸÜŸàÿßŸÜ ÿßŸÑŸÉÿßŸÖŸÑ</label>
              <textarea class="form-input" id="settingsStoreAddress" rows="3" placeholder="ÿßŸÑŸÖÿØŸäŸÜÿ© - ÿßŸÑÿ≠Ÿä - ÿßŸÑÿ¥ÿßÿ±ÿπ"></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="form-group">
                <label class="form-label"><i class="fas fa-phone"></i> ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ 1</label>
                <input type="tel" class="form-input" id="settingsStorePhone1" placeholder="07XXXXXXXXX">
              </div>

              <div class="form-group">
                <label class="form-label"><i class="fas fa-phone"></i> ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ 2</label>
                <input type="tel" class="form-input" id="settingsStorePhone2" placeholder="07XXXXXXXXX">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-envelope"></i> ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</label>
              <input type="email" class="form-input" id="settingsStoreEmail" placeholder="info@store.com">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fab fa-whatsapp"></i> ÿ±ŸÇŸÖ ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®</label>
              <input type="tel" class="form-input" id="settingsWhatsapp" placeholder="07XXXXXXXXX">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-globe"></i> ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</label>
              <input type="url" class="form-input" id="settingsWebsite" placeholder="https://yourstore.com">
            </div>
          </div>

          <!-- ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿßŸÑŸäÿ© -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-dollar-sign"></i> ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿßŸÑŸäÿ©
            </h3>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-percentage"></i> ŸÖÿπÿØŸÑ ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ© (%)</label>
              <input type="number" class="form-input" id="settingsTaxRate" value="0" min="0" max="100" step="0.1">
              <small style="color: var(--theme-text-secondary); margin-top: 0.5rem; display: block;">
                ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ Ÿáÿ∞Ÿá ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ© ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
              </small>
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-coins"></i> ÿßŸÑÿπŸÖŸÑÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©</label>
              <select class="form-select" id="settingsDefaultCurrency">
                <option value="IQD">ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä (IQD)</option>
                <option value="USD">ÿØŸàŸÑÿßÿ± ÿ£ŸÖÿ±ŸäŸÉŸä (USD)</option>
                <option value="EUR">ŸäŸàÿ±Ÿà (EUR)</option>
                <option value="GBP">ÿ¨ŸÜŸäŸá ÿßÿ≥ÿ™ÿ±ŸÑŸäŸÜŸä (GBP)</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-money-bill"></i> ÿ£ŸÇŸÑ ŸÖÿ®ŸÑÿ∫ ŸÑŸÑÿØŸäŸàŸÜ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠</label>
              <input type="number" class="form-input" id="settingsMinDebtAmount" value="0">
            </div>
          </div>

          <!-- ÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿπŸÖŸÑ -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-clock"></i> ÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿπŸÖŸÑ
            </h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="form-group">
                <label class="form-label">ŸàŸÇÿ™ ÿßŸÑŸÅÿ™ÿ≠</label>
                <input type="time" class="form-input" id="settingsOpenTime" value="09:00">
              </div>

              <div class="form-group">
                <label class="form-label">ŸàŸÇÿ™ ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ</label>
                <input type="time" class="form-input" id="settingsCloseTime" value="22:00">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">ÿ£ŸäÿßŸÖ ÿßŸÑÿπÿ∑ŸÑ</label>
              <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" id="closedFriday" style="width: auto;">
                  <span>ÿßŸÑÿ¨ŸÖÿπÿ©</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" id="closedSaturday" style="width: auto;">
                  <span>ÿßŸÑÿ≥ÿ®ÿ™</span>
                </label>
              </div>
            </div>
          </div>

          <!-- ÿßŸÑÿ¥ÿπÿßÿ± -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-image"></i> ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ™ÿ¨ÿ±
            </h3>

            <div class="form-group">
              <label class="form-label">ÿ±ŸÅÿπ ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ™ÿ¨ÿ±</label>
              <input type="file" class="form-input" id="settingsStoreLogo" accept="image/*">
              <small style="color: var(--theme-text-secondary); margin-top: 0.5rem; display: block;">
                ÿ≥Ÿäÿ∏Ÿáÿ± ÿßŸÑÿ¥ÿπÿßÿ± ÿπŸÑŸâ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖÿ∑ÿ®Ÿàÿπÿ© (ŸäŸÅÿ∂ŸÑ ÿµŸàÿ±ÿ© ÿ®ÿÆŸÑŸÅŸäÿ© ÿ¥ŸÅÿßŸÅÿ© PNG)
              </small>
            </div>
          </div>

          <div class="form-actions">
            <button class="btn btn-primary" onclick="saveStoreSettings()">
              <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
            </button>
            <button class="btn btn-secondary" onclick="showPage('settings')">
              <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
            </button>
          </div>

        </div>
      </div>
     </div>

     <!-- ÿµŸÅÿ≠ÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ -->
     <div id="settings-system" class="page" style="display: none;">
      <div class="section-header">
       <button class="btn btn-secondary" onclick="showPage('settings')" style="margin-left: 1rem;">
         <i class="fas fa-arrow-right"></i> ÿ±ÿ¨Ÿàÿπ
       </button>
       <div class="section-title"><i class="fas fa-desktop"></i> ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ</div>
      </div>

      <div class="settings-full-width">
        <div class="settings-content-wrapper">
          
          <!-- ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ∏Ÿáÿ± -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-palette"></i> ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ∏Ÿáÿ±
            </h3>

            <div class="form-group">
              <label class="form-label">ÿßÿÆÿ™ÿ± ŸÖÿ∏Ÿáÿ± ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÉÿßŸÖŸÑ</label>
              <select class="form-select" id="themeSelect" onchange="changeTheme(this.value)" style="font-size: 1rem;">
                <optgroup label="ÿßŸÑÿ´ŸäŸÖÿßÿ™ ÿßŸÑŸÉŸÑÿßÿ≥ŸäŸÉŸäÿ©">
                  <option value="dark">üåô ÿßŸÑŸÖÿ∏Ÿáÿ± ÿßŸÑÿØÿßŸÉŸÜ (ŸÉŸÑÿßÿ≥ŸäŸÉŸä)</option>
                  <option value="light">‚òÄÔ∏è ÿßŸÑŸÖÿ∏Ÿáÿ± ÿßŸÑŸÅÿßÿ™ÿ≠ (ŸÉŸÑÿßÿ≥ŸäŸÉŸä)</option>
                </optgroup>
                
                <optgroup label="ÿßŸÑÿ´ŸäŸÖÿßÿ™ ÿßŸÑÿØÿßŸÉŸÜÿ© ÿßŸÑŸÖŸÑŸàŸÜÿ©">
                  <option value="blue-dark">üîµ ÿ£ÿ≤ÿ±ŸÇ ÿØÿßŸÉŸÜ (Blue Dark)</option>
                  <option value="green-dark">üíö ÿ£ÿÆÿ∂ÿ± ÿØÿßŸÉŸÜ (Green Dark)</option>
                  <option value="orange-dark">üß° ÿ®ÿ±ÿ™ŸÇÿßŸÑŸä ÿØÿßŸÉŸÜ (Orange Dark)</option>
                  <option value="purple-dark">üíú ÿ®ŸÜŸÅÿ≥ÿ¨Ÿä ÿØÿßŸÉŸÜ (Purple Dark)</option>
                  <option value="red-dark">‚ù§Ô∏è ÿ£ÿ≠ŸÖÿ± ÿØÿßŸÉŸÜ (Red Dark)</option>
                  <option value="olive">üü¢ ÿ≤Ÿäÿ™ŸàŸÜŸä ÿØÿßŸÉŸÜ (Olive)</option>
                  <option value="royal-blue">üî¥ ÿ£ÿ≤ÿ±ŸÇ ŸÖŸÑŸÉŸä (Royal Blue)</option>
                </optgroup>
                
                <optgroup label="ÿßŸÑÿ´ŸäŸÖÿßÿ™ ÿßŸÑŸÅÿßÿ™ÿ≠ÿ© ÿßŸÑŸÖŸÑŸàŸÜÿ©">
                  <option value="cyan-light">ü©µ ÿ≥ŸÖÿßŸàŸä ŸÅÿßÿ™ÿ≠ (Cyan Light)</option>
                  <option value="gold-light">üü° ÿ∞Ÿáÿ®Ÿä ŸÅÿßÿ™ÿ≠ (Gold Light)</option>
                  <option value="pink-light">üå∏ Ÿàÿ±ÿØŸä ŸÅÿßÿ™ÿ≠ (Pink Light)</option>
                </optgroup>
              </select>
              <small style="color: var(--theme-text-secondary); margin-top: 0.5rem; display: block;">
                ÿßÿÆÿ™ÿ± ÿßŸÑÿ´ŸäŸÖ ÿßŸÑŸÖŸÅÿ∂ŸÑ - ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿπŸÑŸâ ŸÉÿßŸÖŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÅŸàÿ±ÿßŸã
              </small>
              
              <!-- ŸÖÿπÿßŸäŸÜÿ© ÿ≥ÿ±Ÿäÿπÿ© ŸÑŸÑÿ´ŸäŸÖÿßÿ™ -->
              <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.75rem; margin-top: 1rem; padding: 1rem; background: var(--theme-bg-hover); border-radius: 12px;">
                <button onclick="changeTheme('dark')" class="theme-preview-btn" style="background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%); color: #e8e8e8;" title="ÿßŸÑÿØÿßŸÉŸÜ ÿßŸÑŸÉŸÑÿßÿ≥ŸäŸÉŸä">
                  üåô
                </button>
                <button onclick="changeTheme('light')" class="theme-preview-btn" style="background: linear-gradient(135deg, #f5f5f0 0%, #ffffff 100%); color: #1a1a1a; border: 1px solid #d8d8d8;" title="ÿßŸÑŸÅÿßÿ™ÿ≠ ÿßŸÑŸÉŸÑÿßÿ≥ŸäŸÉŸä">
                  ‚òÄÔ∏è
                </button>
                <button onclick="changeTheme('blue-dark')" class="theme-preview-btn" style="background: linear-gradient(135deg, #0a1628 0%, #152238 100%); color: #e1f0ff;" title="ÿ£ÿ≤ÿ±ŸÇ ÿØÿßŸÉŸÜ">
                  üîµ
                </button>
                <button onclick="changeTheme('green-dark')" class="theme-preview-btn" style="background: linear-gradient(135deg, #0a1f0f 0%, #14321f 100%); color: #d1fae5;" title="ÿ£ÿÆÿ∂ÿ± ÿØÿßŸÉŸÜ">
                  üíö
                </button>
                <button onclick="changeTheme('orange-dark')" class="theme-preview-btn" style="background: linear-gradient(135deg, #1f1208 0%, #351e18 100%); color: #ffe4d1;" title="ÿ®ÿ±ÿ™ŸÇÿßŸÑŸä ÿØÿßŸÉŸÜ">
                  üß°
                </button>
                <button onclick="changeTheme('purple-dark')" class="theme-preview-btn" style="background: linear-gradient(135deg, #1a0a28 0%, #2e1542 100%); color: #f0d1ff;" title="ÿ®ŸÜŸÅÿ≥ÿ¨Ÿä ÿØÿßŸÉŸÜ">
                  üíú
                </button>
                <button onclick="changeTheme('red-dark')" class="theme-preview-btn" style="background: linear-gradient(135deg, #280a0a 0%, #421515 100%); color: #ffd1d1;" title="ÿ£ÿ≠ŸÖÿ± ÿØÿßŸÉŸÜ">
                  ‚ù§Ô∏è
                </button>
                <button onclick="changeTheme('cyan-light')" class="theme-preview-btn" style="background: linear-gradient(135deg, #e0f7fa 0%, #ffffff 100%); color: #0e2933; border: 1px solid #b0dce5;" title="ÿ≥ŸÖÿßŸàŸä ŸÅÿßÿ™ÿ≠">
                  ü©µ
                </button>
                <button onclick="changeTheme('gold-light')" class="theme-preview-btn" style="background: linear-gradient(135deg, #fffbea 0%, #ffffff 100%); color: #2a2008; border: 1px solid #e8d89b;" title="ÿ∞Ÿáÿ®Ÿä ŸÅÿßÿ™ÿ≠">
                  üü°
                </button>
                <button onclick="changeTheme('pink-light')" class="theme-preview-btn" style="background: linear-gradient(135deg, #fce7f3 0%, #ffffff 100%); color: #2d081f; border: 1px solid #f5c0dd;" title="Ÿàÿ±ÿØŸä ŸÅÿßÿ™ÿ≠">
                  üå∏
                </button>
                <button onclick="changeTheme('olive')" class="theme-preview-btn" style="background: linear-gradient(135deg, #1a1f0a 0%, #2e3515 100%); color: #e8f0d1;" title="ÿ≤Ÿäÿ™ŸàŸÜŸä">
                  üü¢
                </button>
                <button onclick="changeTheme('royal-blue')" class="theme-preview-btn" style="background: linear-gradient(135deg, #0c1445 0%, #162270 100%); color: #d6e4ff;" title="ÿ£ÿ≤ÿ±ŸÇ ŸÖŸÑŸÉŸä">
                  üî¥
                </button>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">ŸÖÿ¨ŸÖŸàÿπÿ© ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</label>
              <select class="form-select" id="colorSchemeSelect" onchange="previewColorScheme(this.value)">
                <option value="default">ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä (ÿ®ŸÜŸÅÿ≥ÿ¨Ÿä Ÿàÿ±ÿØŸä)</option>
                <option value="blue">ÿ£ÿ≤ÿ±ŸÇ ÿπÿµÿ±Ÿä üíô</option>
                <option value="green">ÿ£ÿÆÿ∂ÿ± ÿ∑ÿ®ŸäÿπŸä üíö</option>
                <option value="orange">ÿ®ÿ±ÿ™ŸÇÿßŸÑŸä ÿØÿßŸÅÿ¶ üß°</option>
                <option value="red">ÿ£ÿ≠ŸÖÿ± ŸÜÿßÿ±Ÿä ‚ù§Ô∏è</option>
                <option value="purple">ÿ®ŸÜŸÅÿ≥ÿ¨Ÿä ŸÖŸÑŸÉŸä üíú</option>
                <option value="cyan">ÿ≥ŸÖÿßŸàŸä ŸÖŸÜÿπÿ¥ ü©µ</option>
                <option value="amber">ŸÉŸáÿ±ŸÖÿßŸÜŸä ÿ∞Ÿáÿ®Ÿä üü°</option>
                <option value="teal">ÿ™ÿ±ŸÉŸàÿßÿ≤ ŸáÿßÿØÿ¶ üîµ</option>
              </select>
              <small style="color: var(--theme-text-secondary); margin-top: 0.5rem; display: block;">
                ÿßÿÆÿ™ÿ± ŸÖÿ¨ŸÖŸàÿπÿ© ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ© ŸÑÿØŸäŸÉ - ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇŸáÿß ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿπŸÜÿßÿµÿ± ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
              </small>
            </div>

            <div class="form-group">
              <label class="form-label">ÿ™ÿÆÿµŸäÿµ ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ©</label>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1rem;">
                
                <div>
                  <label style="font-size: 0.875rem; color: var(--theme-text-secondary); display: block; margin-bottom: 0.5rem;">
                    <i class="fas fa-palette"></i> ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä
                  </label>
                  <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="color" id="primaryColorPicker" value="#6366f1" style="width: 60px; height: 40px; border: none; border-radius: 8px; cursor: pointer;">
                    <input type="text" id="primaryColorInput" value="#6366f1" class="form-input" style="flex: 1;" placeholder="#6366f1">
                  </div>
                </div>

                <div>
                  <label style="font-size: 0.875rem; color: var(--theme-text-secondary); display: block; margin-bottom: 0.5rem;">
                    <i class="fas fa-palette"></i> ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ´ÿßŸÜŸàŸä
                  </label>
                  <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="color" id="secondaryColorPicker" value="#8b5cf6" style="width: 60px; height: 40px; border: none; border-radius: 8px; cursor: pointer;">
                    <input type="text" id="secondaryColorInput" value="#8b5cf6" class="form-input" style="flex: 1;" placeholder="#8b5cf6">
                  </div>
                </div>

                <div>
                  <label style="font-size: 0.875rem; color: var(--theme-text-secondary); display: block; margin-bottom: 0.5rem;">
                    <i class="fas fa-check-circle"></i> ŸÑŸàŸÜ ÿßŸÑŸÜÿ¨ÿßÿ≠
                  </label>
                  <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="color" id="successColorPicker" value="#10b981" style="width: 60px; height: 40px; border: none; border-radius: 8px; cursor: pointer;">
                    <input type="text" id="successColorInput" value="#10b981" class="form-input" style="flex: 1;" placeholder="#10b981">
                  </div>
                </div>

                <div>
                  <label style="font-size: 0.875rem; color: var(--theme-text-secondary); display: block; margin-bottom: 0.5rem;">
                    <i class="fas fa-exclamation-triangle"></i> ŸÑŸàŸÜ ÿßŸÑÿ™ÿ≠ÿ∞Ÿäÿ±
                  </label>
                  <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="color" id="warningColorPicker" value="#f59e0b" style="width: 60px; height: 40px; border: none; border-radius: 8px; cursor: pointer;">
                    <input type="text" id="warningColorInput" value="#f59e0b" class="form-input" style="flex: 1;" placeholder="#f59e0b">
                  </div>
                </div>

                <div>
                  <label style="font-size: 0.875rem; color: var(--theme-text-secondary); display: block; margin-bottom: 0.5rem;">
                    <i class="fas fa-times-circle"></i> ŸÑŸàŸÜ ÿßŸÑÿÆÿ∑ÿ±
                  </label>
                  <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="color" id="dangerColorPicker" value="#ef4444" style="width: 60px; height: 40px; border: none; border-radius: 8px; cursor: pointer;">
                    <input type="text" id="dangerColorInput" value="#ef4444" class="form-input" style="flex: 1;" placeholder="#ef4444">
                  </div>
                </div>

                <div>
                  <label style="font-size: 0.875rem; color: var(--theme-text-secondary); display: block; margin-bottom: 0.5rem;">
                    <i class="fas fa-info-circle"></i> ŸÑŸàŸÜ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™
                  </label>
                  <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="color" id="infoColorPicker" value="#3b82f6" style="width: 60px; height: 40px; border: none; border-radius: 8px; cursor: pointer;">
                    <input type="text" id="infoColorInput" value="#3b82f6" class="form-input" style="flex: 1;" placeholder="#3b82f6">
                  </div>
                </div>

              </div>
              <button class="btn btn-secondary" onclick="resetDefaultColors()" style="margin-top: 1rem;">
                <i class="fas fa-undo"></i> ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
              </button>
            </div>

            <div class="form-group">
              <label class="form-label">ÿ≠ÿ¨ŸÖ ÿßŸÑÿÆÿ∑</label>
              <select class="form-select" id="fontSizeSelect">
                <option value="small">ÿµÿ∫Ÿäÿ±</option>
                <option value="medium" selected>ŸÖÿ™Ÿàÿ≥ÿ∑</option>
                <option value="large">ŸÉÿ®Ÿäÿ±</option>
              </select>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="compactModeCheck" style="width: auto;">
                <span>ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿØŸÖÿ¨ (ÿπÿ±ÿ∂ ÿ£ŸÉÿ´ÿ± ŸÉÿ´ÿßŸÅÿ©)</span>
              </label>
            </div>
          </div>

          <!-- ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÑÿ∫ÿ© ŸàÿßŸÑÿ™ŸÜÿ≥ŸäŸÇ -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-language"></i> ÿßŸÑŸÑÿ∫ÿ© ŸàÿßŸÑÿ™ŸÜÿ≥ŸäŸÇ
            </h3>

            <div class="form-group">
              <label class="form-label">ŸÑÿ∫ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</label>
              <select class="form-select" id="languageSelect">
                <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© üáÆüá∂</option>
                <option value="en">English üá¨üáß</option>
                <option value="ku">ŸÉŸàÿ±ÿØ€å üè¥</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</label>
              <select class="form-select" id="dateFormatSelect">
                <option value="DD/MM/YYYY">ŸäŸàŸÖ/ÿ¥Ÿáÿ±/ÿ≥ŸÜÿ©</option>
                <option value="MM/DD/YYYY">ÿ¥Ÿáÿ±/ŸäŸàŸÖ/ÿ≥ŸÜÿ©</option>
                <option value="YYYY-MM-DD">ÿ≥ŸÜÿ©-ÿ¥Ÿáÿ±-ŸäŸàŸÖ</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑŸàŸÇÿ™</label>
              <select class="form-select" id="timeFormatSelect">
                <option value="12">12 ÿ≥ÿßÿπÿ© (AM/PM)</option>
                <option value="24">24 ÿ≥ÿßÿπÿ©</option>
              </select>
            </div>
          </div>

          <!-- ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ÿØÿßÿ° -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-tachometer-alt"></i> ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ÿØÿßÿ°
            </h3>

            <div class="form-group">
              <label class="form-label">ÿπÿØÿØ ÿßŸÑÿπŸÜÿßÿµÿ± ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ©</label>
              <select class="form-select" id="itemsPerPageSelect">
                <option value="10">10 ÿπŸÜÿßÿµÿ±</option>
                <option value="25" selected>25 ÿπŸÜÿµÿ±</option>
                <option value="50">50 ÿπŸÜÿµÿ±</option>
                <option value="100">100 ÿπŸÜÿµÿ±</option>
              </select>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="animationsCheck" checked style="width: auto;">
                <span>ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ÿßŸÑŸÖÿ™ÿ≠ÿ±ŸÉÿ©</span>
              </label>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="autosaveCheck" checked style="width: auto;">
                <span>ÿßŸÑÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÉŸÑ 5 ÿØŸÇÿßÿ¶ŸÇ</span>
              </label>
            </div>
          </div>

          <!-- ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-cash-register"></i> ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ
            </h3>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="barcodeSound" checked style="width: auto;">
                <span>ÿ™ÿ¥ÿ∫ŸäŸÑ ÿµŸàÿ™ ÿπŸÜÿØ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ</span>
              </label>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="autoPrint" style="width: auto;">
                <span>ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ÿπÿØ ÿßŸÑÿ®Ÿäÿπ</span>
              </label>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="clearCartAfterSale" checked style="width: auto;">
                <span>ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ŸÑÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ÿπÿØ ÿßŸÑÿ®Ÿäÿπ</span>
              </label>
            </div>
          </div>

          <div class="form-actions">
            <button class="btn btn-primary" onclick="saveSystemSettings()">
              <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
            </button>
            <button class="btn btn-secondary" onclick="showPage('settings')">
              <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
            </button>
          </div>

        </div>
      </div>
     </div>

     <!-- ÿµŸÅÿ≠ÿ© ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© -->
     <div id="settings-backup" class="page" style="display: none;">
      <div class="section-header">
       <button class="btn btn-secondary" onclick="showPage('settings')" style="margin-left: 1rem;">
         <i class="fas fa-arrow-right"></i> ÿ±ÿ¨Ÿàÿπ
       </button>
       <div class="section-title"><i class="fas fa-database"></i> ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©</div>
      </div>

      <div class="settings-full-width">
        <div class="settings-content-wrapper">
          
          <!-- ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-download"></i> ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
            </h3>

            <div style="background: rgba(34, 197, 94, 0.1); border-right: 4px solid #22c55e; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
              <h4 style="color: #22c55e; margin-bottom: 0.5rem;">
                <i class="fas fa-info-circle"></i> ŸÜÿµŸäÿ≠ÿ© ŸÖŸáŸÖÿ©
              </h4>
              <p style="color: var(--theme-text-secondary); line-height: 1.6;">
                ŸÇŸÖ ÿ®ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ÿ¥ŸÉŸÑ ÿØŸàÿ±Ÿä (ŸäŸàŸÖŸäÿßŸã ÿ£Ÿà ÿ£ÿ≥ÿ®ŸàÿπŸäÿßŸã) ŸÑŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿ¢ŸÖŸÜÿ©.
              </p>
            </div>

                        <div style="display: grid; gap: 1rem;">
                            <button class="btn btn-success" onclick="systemExportBackup('full')" style="padding: 1.5rem; font-size: 1.1rem;">
                                <i class="fas fa-download"></i> ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÉÿßŸÖŸÑÿ©
                            </button>

                            <button class="btn" style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 1.5rem;" onclick="systemExportBackup('selective')">
                                <i class="fas fa-database"></i> ŸÜÿ≥ÿÆ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸÇÿ∑ (ŸÖŸÜÿ™ÿ¨ÿßÿ™ÿå ŸÅŸàÿßÿ™Ÿäÿ±ÿå ÿØŸäŸàŸÜ)
                            </button>
                        </div>
          </div>

          <!-- ÿßÿ≥ÿ™ÿπÿßÿØÿ© ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-upload"></i> ÿßÿ≥ÿ™ÿπÿßÿØÿ© ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
            </h3>

            <div style="background: rgba(251, 191, 36, 0.1); border-right: 4px solid #fbbf24; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
              <h4 style="color: #fbbf24; margin-bottom: 0.5rem;">
                <i class="fas fa-exclamation-triangle"></i> ÿ™ÿ≠ÿ∞Ÿäÿ±
              </h4>
              <p style="color: var(--theme-text-secondary); line-height: 1.6;">
                ÿßÿ≥ÿ™ÿπÿßÿØÿ© ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ≥Ÿäÿ§ÿØŸä ÿ•ŸÑŸâ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÇÿ®ŸÑ ÿßŸÑÿßÿ≥ÿ™ÿπÿßÿØÿ©.
              </p>
            </div>

            <input type="file" id="backupFileInput" accept=".json" style="display: none;" onchange="handleBackupRestore(event)">
            
            <button class="btn btn-warning" onclick="document.getElementById('backupFileInput').click()" style="width: 100%; padding: 1.5rem; font-size: 1.1rem;">
              <i class="fas fa-upload"></i> ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
            </button>
          </div>

          <!-- ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-clock"></i> ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
            </h3>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="autoBackupEnabled" style="width: auto;">
                <span>ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä</span>
              </label>
            </div>

            <div class="form-group">
              <label class="form-label">ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä</label>
              <select class="form-select" id="autoBackupFrequency">
                <option value="daily">ŸäŸàŸÖŸäÿßŸã</option>
                <option value="weekly">ÿ£ÿ≥ÿ®ŸàÿπŸäÿßŸã</option>
                <option value="monthly">ÿ¥Ÿáÿ±ŸäÿßŸã</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">ŸÖŸàŸÇÿπ ÿ≠ŸÅÿ∏ ÿßŸÑŸÜÿ≥ÿÆ</label>
              <div style="display: flex; gap: 1rem;">
                <input type="text" class="form-input" id="backupLocation" readonly value="ÿßŸÑŸÖÿ¨ŸÑÿØ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä">
                <button class="btn btn-secondary" onclick="chooseBackupLocation()">
                  <i class="fas fa-folder-open"></i> ÿ™ÿ∫ŸäŸäÿ±
                </button>
              </div>
            </div>

            <button class="btn btn-primary" onclick="saveBackupSettings()">
              <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä
            </button>
          </div>

          <!-- ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑ ÿßŸÑŸÖÿµŸÜÿπ -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-exclamation-circle"></i> ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑ ÿßŸÑŸÖÿµŸÜÿπ
            </h3>

            <div style="background: rgba(239, 68, 68, 0.1); border-right: 4px solid #ef4444; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
              <h4 style="color: #ef4444; margin-bottom: 0.5rem;">
                <i class="fas fa-skull-crossbones"></i> ÿÆÿ∑ÿ± - ÿπŸÖŸÑŸäÿ© ÿ∫Ÿäÿ± ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ÿ±ÿßÿ¨ÿπ
              </h4>
              <p style="color: var(--theme-text-secondary); line-height: 1.6; margin-bottom: 1rem;">
                Ÿáÿ∞Ÿá ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ≥ÿ™ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ Ÿàÿ™ÿπŸäÿØ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÑÿ≠ÿßŸÑÿ™Ÿá ÿßŸÑÿ£ŸàŸÑŸâ. 
                ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞Ÿá ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ®ÿπÿØ ÿ™ŸÜŸÅŸäÿ∞Ÿáÿß!
              </p>
              <ul style="color: var(--theme-text-secondary); line-height: 1.8; margin-right: 1.5rem;">
                <li>üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸàÿßŸÑŸÅÿ¶ÿßÿ™</li>
                <li>üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸàÿ±ÿØŸäŸÜ ŸàÿßŸÑÿπŸÖŸÑÿßÿ°</li>
                <li>üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ŸàÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±</li>
                <li>üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿØŸäŸàŸÜ ŸàÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</li>
                <li>üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸàÿßŸÑÿ™ÿÆÿµŸäÿµÿßÿ™</li>
                <li>üóëÔ∏è ŸÖÿ≥ÿ≠ ŸÇŸàÿßÿπÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ</li>
              </ul>
            </div>

            <div style="display: grid; gap: 1rem;">
              <button class="btn btn-warning" onclick="clearSampleData()" style="padding: 1rem; font-size: 1rem;">
                <i class="fas fa-broom"></i> ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ© ŸÅŸÇÿ∑
              </button>
              
              <button class="btn btn-danger" onclick="confirmFactoryReset()" style="padding: 1.5rem; font-size: 1.1rem;">
                <i class="fas fa-trash-alt"></i> ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑ ÿßŸÑŸÖÿµŸÜÿπ ÿßŸÑŸÉÿßŸÖŸÑÿ© (ÿ≠ÿ∞ŸÅ ŸÉŸÑ ÿ¥Ÿäÿ°)
              </button>
            </div>
          </div>

        </div>
      </div>
     </div>

     <!-- ÿµŸÅÿ≠ÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ -->
     <div id="settings-account" class="page" style="display: none;">
      <div class="section-header">
       <button class="btn btn-secondary" onclick="showPage('settings')" style="margin-left: 1rem;">
         <i class="fas fa-arrow-right"></i> ÿ±ÿ¨Ÿàÿπ
       </button>
       <div class="section-title"><i class="fas fa-user-circle"></i> ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</div>
      </div>

      <div class="settings-full-width">
        <div class="settings-content-wrapper">
        
        <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ© -->
        <div class="settings-section">
          <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--theme-text-primary); display: flex; align-items: center; gap: 0.75rem;">
            <span style="width: 4px; height: 28px; background: var(--primary-gradient); border-radius: 2px;"></span>
            <i class="fas fa-building"></i>
            ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ©
          </h3>
          
          <div style="background: linear-gradient(135deg, var(--theme-bg-secondary) 0%, var(--theme-bg-hover) 100%); border-radius: 20px; padding: 2.5rem; border: 2px solid rgba(102, 126, 234, 0.2); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);">
            
            <!-- ÿ¥ÿπÿßÿ± ÿßŸÑÿ¥ÿ±ŸÉÿ© -->
            <div style="text-align: center; margin-bottom: 2rem;">
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);">
                <i class="fas fa-building" style="font-size: 3rem; color: white;"></i>
              </div>
              <h2 style="font-size: 2rem; font-weight: 700; color: var(--theme-text-primary); margin: 0 0 0.5rem 0;">
                ÿßŸÑÿ•ÿ®ÿØÿßÿπ ÿßŸÑÿ±ŸÇŸÖŸä
              </h2>
              <p style="font-size: 1.1rem; color: var(--theme-text-secondary); margin: 0;">
                Digital Innovation Company
              </p>
            </div>

            <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
              
              <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.1);">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                  <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-phone" style="font-size: 1.25rem; color: white;"></i>
                  </div>
                  <div>
                    <p style="font-size: 0.875rem; color: var(--theme-text-secondary); margin: 0 0 0.25rem 0;">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</p>
                    <p style="font-size: 1.25rem; font-weight: 600; color: var(--theme-text-primary); margin: 0; direction: ltr; text-align: right;">07813798636</p>
                  </div>
                </div>
              </div>

              <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.1);">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                  <div style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="fab fa-whatsapp" style="font-size: 1.25rem; color: white;"></i>
                  </div>
                  <div>
                    <p style="font-size: 0.875rem; color: var(--theme-text-secondary); margin: 0 0 0.25rem 0;">Ÿàÿßÿ™ÿ≥ÿßÿ®</p>
                    <a href="https://wa.me/9647813798636?text=ŸÖÿ±ÿ≠ÿ®ÿßŸãÿå ÿ£ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿ™ÿ¨ÿØŸäÿØ ÿßÿ¥ÿ™ÿ±ÿßŸÉŸä ŸÅŸä ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÉÿßÿ¥Ÿäÿ±" target="_blank" style="font-size: 1.25rem; font-weight: 600; color: #25D366; margin: 0; direction: ltr; text-align: right; text-decoration: none; display: block;">
                      +964 781 379 8636
                    </a>
                  </div>
                </div>
              </div>

            </div>

            <!-- ÿ≤ÿ± ÿßŸÑÿ™ŸàÿßÿµŸÑ -->
            <div style="margin-top: 2rem;">
              <a href="https://wa.me/9647813798636?text=ŸÖÿ±ÿ≠ÿ®ÿßŸãÿå ÿ£ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿ™ÿ¨ÿØŸäÿØ ÿßÿ¥ÿ™ÿ±ÿßŸÉŸä ŸÅŸä ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÉÿßÿ¥Ÿäÿ±" target="_blank" class="btn btn-primary" style="width: 100%; padding: 1.25rem; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; gap: 0.75rem; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); border: none;">
                <i class="fab fa-whatsapp" style="font-size: 1.5rem;"></i>
                <span>ÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÜÿß ÿπÿ®ÿ± ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®</span>
              </a>
            </div>
          </div>
        </div>

        <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÖÿ≥ÿ¨ŸÑ -->
        <div class="settings-section">
          <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--theme-text-primary); display: flex; align-items: center; gap: 0.75rem;">
            <span style="width: 4px; height: 28px; background: var(--primary-gradient); border-radius: 2px;"></span>
            <i class="fas fa-user-circle"></i>
            ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
          </h3>
          
          <div style="background: linear-gradient(135deg, var(--theme-bg-secondary) 0%, var(--theme-bg-hover) 100%); border-radius: 20px; padding: 2.5rem; border: 2px solid rgba(102, 126, 234, 0.2); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);">
            
            <!-- ÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ -->
            <div style="text-align: center; margin-bottom: 2rem;">
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);">
                <i class="fas fa-user" style="font-size: 3rem; color: white;"></i>
              </div>
              <h2 id="userDisplayName" style="font-size: 1.75rem; font-weight: 700; color: var(--theme-text-primary); margin: 0 0 0.5rem 0;">
                ---
              </h2>
              <p id="userDisplayStatus" style="font-size: 1rem; color: var(--theme-text-secondary); margin: 0;">
                ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...
              </p>
            </div>

            <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ® -->
            <div style="display: grid; gap: 1rem; margin-bottom: 2rem;">
              
              <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: var(--theme-text-secondary);">
                    <i class="fas fa-phone"></i> ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ:
                  </span>
                  <strong id="userDisplayPhone" style="color: var(--theme-text-primary); direction: ltr;">---</strong>
                </div>
              </div>

              <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: var(--theme-text-secondary);">
                    <i class="fas fa-key"></i> ÿ±ŸÖÿ≤ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ:
                  </span>
                  <strong id="userDisplayCode" style="color: #667eea; font-family: 'Courier New', monospace; letter-spacing: 2px;">---</strong>
                </div>
              </div>

              <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: var(--theme-text-secondary);">
                    <i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ:
                  </span>
                  <strong id="userDisplayDate" style="color: var(--theme-text-primary);">---</strong>
                </div>
              </div>

              <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: var(--theme-text-secondary);">
                    <i class="fas fa-check-circle"></i> ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®:
                  </span>
                  <strong id="userDisplayStatusBadge" style="color: #10b981;">
                    <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #10b981; margin-left: 5px;"></span>
                    ŸÖŸÅÿπŸëŸÑ
                  </strong>
                </div>
              </div>

            </div>

            <!-- ÿ≤ÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ -->
            <button 
              onclick="handleLogout()"
              style="
                width: 100%;
                padding: 1.25rem;
                border-radius: 12px;
                border: 2px solid #ef4444;
                background: transparent;
                color: #ef4444;
                font-size: 1.1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.75rem;
              "
              onmouseover="this.style.background='rgba(239, 68, 68, 0.1)'"
              onmouseout="this.style.background='transparent'"
            >
              <i class="fas fa-sign-out-alt"></i>
              <span>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</span>
            </button>
          </div>
        </div>

        <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸàÿßŸÑÿ≠ÿ≥ÿßÿ® -->
        <div style="margin-bottom: 3rem;">
          <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--theme-text-primary); display: flex; align-items: center; gap: 0.75rem;">
            <span style="width: 4px; height: 28px; background: var(--primary-gradient); border-radius: 2px;"></span>
            <i class="fas fa-user"></i>
            ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ®
          </h3>
          
          <div style="background: linear-gradient(135deg, var(--theme-bg-secondary) 0%, var(--theme-bg-hover) 100%); border-radius: 20px; padding: 2.5rem; border: 2px solid rgba(102, 126, 234, 0.2); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);">
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
              
              <!-- ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿπÿ±ŸäŸÅ -->
              <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.1);">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <i class="fas fa-fingerprint" style="font-size: 1.25rem; color: white;"></i>
                  </div>
                  <div style="flex: 1; min-width: 0;">
                    <p style="font-size: 0.875rem; color: var(--theme-text-secondary); margin: 0 0 0.5rem 0;">ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (UID)</p>
                    <p id="accountUserUID" style="font-size: 0.95rem; font-weight: 600; color: var(--theme-text-primary); margin: 0; font-family: 'Courier New', monospace; overflow: hidden; text-overflow: ellipsis;">
                      ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...
                    </p>
                  </div>
                  <button onclick="copyToClipboard(document.getElementById('accountUserUID').textContent)" class="btn btn-sm" style="padding: 0.5rem; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3);" title="ŸÜÿ≥ÿÆ">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
              </div>

              <!-- ÿßŸÑÿ±ŸÖÿ≤ ÿßŸÑÿ≥ÿ±Ÿä -->
              <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.1);">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <i class="fas fa-key" style="font-size: 1.25rem; color: white;"></i>
                  </div>
                  <div style="flex: 1; min-width: 0;">
                    <p style="font-size: 0.875rem; color: var(--theme-text-secondary); margin: 0 0 0.5rem 0;">ÿßŸÑÿ±ŸÖÿ≤ ÿßŸÑÿ≥ÿ±Ÿä</p>
                    <p id="accountUserSecret" style="font-size: 1.1rem; font-weight: 600; color: var(--theme-text-primary); margin: 0; font-family: 'Courier New', monospace; letter-spacing: 2px;">
                      **********
                    </p>
                  </div>
                  <button onclick="copyToClipboard(document.getElementById('accountUserSecret').getAttribute('data-secret'))" class="btn btn-sm" style="padding: 0.5rem; background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.3);" title="ŸÜÿ≥ÿÆ">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
              </div>

              <!-- ÿ™ÿßÿ±ŸäÿÆ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ® -->
              <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.1);">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <div style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <i class="fas fa-calendar-alt" style="font-size: 1.25rem; color: white;"></i>
                  </div>
                  <div style="flex: 1; min-width: 0;">
                    <p style="font-size: 0.875rem; color: var(--theme-text-secondary); margin: 0 0 0.5rem 0;">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ</p>
                    <p id="accountCreatedDate" style="font-size: 1rem; font-weight: 600; color: var(--theme-text-primary); margin: 0;">
                      --/--/----
                    </p>
                  </div>
                </div>
              </div>

              <!-- ÿßŸÑŸÖŸÜÿµÿ© -->
              <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.1);">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <div style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <i class="fas fa-desktop" style="font-size: 1.25rem; color: white;"></i>
                  </div>
                  <div style="flex: 1; min-width: 0;">
                    <p style="font-size: 0.875rem; color: var(--theme-text-secondary); margin: 0 0 0.5rem 0;">ÿßŸÑŸÖŸÜÿµÿ©</p>
                    <p id="accountPlatform" style="font-size: 1rem; font-weight: 600; color: var(--theme-text-primary); margin: 0;">
                      Windows
                    </p>
                  </div>
                </div>
              </div>

            </div>

            <!-- ÿ™ŸÜÿ®ŸäŸá -->
            <div style="margin-top: 2rem; padding: 1.25rem; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px; display: flex; align-items: start; gap: 1rem;">
              <i class="fas fa-info-circle" style="color: #f59e0b; font-size: 1.25rem; flex-shrink: 0; margin-top: 0.25rem;"></i>
              <div>
                <p style="font-weight: 600; color: var(--theme-text-primary); margin: 0 0 0.5rem 0;">
                  <i class="fas fa-lock"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÖŸáŸÖÿ©
                </p>
                <p style="font-size: 0.95rem; color: var(--theme-text-secondary); margin: 0; line-height: 1.6;">
                  ÿßÿ≠ÿ™ŸÅÿ∏ ÿ®ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (UID) ŸàÿßŸÑÿ±ŸÖÿ≤ ÿßŸÑÿ≥ÿ±Ÿä ŸÅŸä ŸÖŸÉÿßŸÜ ÿ¢ŸÖŸÜ. ÿ≥ÿ™ÿ≠ÿ™ÿßÿ¨ŸáŸÖÿß ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÖŸÜ ÿ¨Ÿáÿßÿ≤ ÿ¢ÿÆÿ± ÿ£Ÿà ÿπŸÜÿØ ÿ•ÿπÿßÿØÿ© ÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ.
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ -->
        <div style="margin-bottom: 3rem;">
          <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--theme-text-primary); display: flex; align-items: center; gap: 0.75rem;">
            <span style="width: 4px; height: 28px; background: var(--primary-gradient); border-radius: 2px;"></span>
            <i class="fas fa-crown"></i>
            ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ
          </h3>
          
          <div style="background: linear-gradient(135deg, var(--theme-bg-secondary) 0%, var(--theme-bg-hover) 100%); border-radius: 20px; padding: 2.5rem; border: 2px solid rgba(102, 126, 234, 0.2); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);">
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
              
              <!-- ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ -->
              <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.1);">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-star" style="font-size: 1.25rem; color: white;"></i>
                  </div>
                  <div>
                    <p style="font-size: 0.875rem; color: var(--theme-text-secondary); margin: 0 0 0.5rem 0;">ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ</p>
                    <p id="accountSubscriptionType" style="font-size: 1.1rem; font-weight: 700; color: #f59e0b; margin: 0;">
                      ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä
                    </p>
                  </div>
                </div>
              </div>

              <!-- ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ© -->
              <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.1);">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <div id="accountDaysIcon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-clock" style="font-size: 1.25rem; color: white;"></i>
                  </div>
                  <div>
                    <p style="font-size: 0.875rem; color: var(--theme-text-secondary); margin: 0 0 0.5rem 0;">ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</p>
                    <p id="accountDaysLeft" style="font-size: 1.5rem; font-weight: 700; color: #10b981; margin: 0;">
                      30 ŸäŸàŸÖ
                    </p>
                  </div>
                </div>
              </div>

              <!-- ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ© -->
              <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.1);">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-calendar-check" style="font-size: 1.25rem; color: white;"></i>
                  </div>
                  <div>
                    <p style="font-size: 0.875rem; color: var(--theme-text-secondary); margin: 0 0 0.5rem 0;">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ©</p>
                    <p id="accountStartDate" style="font-size: 1rem; font-weight: 600; color: var(--theme-text-primary); margin: 0;">
                      --/--/----
                    </p>
                  </div>
                </div>
              </div>

              <!-- ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° -->
              <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.1);">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-calendar-times" style="font-size: 1.25rem; color: white;"></i>
                  </div>
                  <div>
                    <p style="font-size: 0.875rem; color: var(--theme-text-secondary); margin: 0 0 0.5rem 0;">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°</p>
                    <p id="accountEndDate" style="font-size: 1rem; font-weight: 600; color: var(--theme-text-primary); margin: 0;">
                      --/--/----
                    </p>
                  </div>
                </div>
              </div>

            </div>

            <!-- ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÇÿØŸÖ -->
            <div style="margin-bottom: 2rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <span style="font-size: 0.875rem; color: var(--theme-text-secondary);">ŸÖÿØÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ©</span>
                <span id="accountProgressPercent" style="font-size: 0.875rem; font-weight: 600; color: var(--theme-text-primary);">0%</span>
              </div>
              <div style="background: var(--theme-bg-tertiary); border-radius: 10px; height: 12px; overflow: hidden;">
                <div id="accountProgressBar" style="background: linear-gradient(90deg, #10b981 0%, #059669 100%); height: 100%; width: 0%; transition: all 0.5s ease; border-radius: 10px;"></div>
              </div>
            </div>

            <!-- ÿ≤ÿ± ÿßŸÑÿ™ÿ¨ÿØŸäÿØ -->
            <button onclick="showActivationModal()" class="btn btn-primary" style="width: 100%; padding: 1.25rem; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
              <i class="fas fa-sync-alt"></i>
              <span>ÿ™ÿ¨ÿØŸäÿØ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ</span>
            </button>
          </div>
        </div>

        <!-- ÿ™ŸÜÿ®ŸäŸá: ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä ÿßŸÜÿ™ŸÇŸÑ ÿ•ŸÑŸâ ÿµŸÅÿ≠ÿ© ŸÖÿÆÿµÿµÿ© -->
        <div class="settings-section">
          <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.05)); border: 2px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 2.5rem; text-align: center; box-shadow: 0 4px 16px rgba(59, 130, 246, 0.15);">
            <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);">
              <i class="fas fa-cloud" style="font-size: 3rem; color: white;"></i>
            </div>
            
            <h3 style="font-size: 1.75rem; font-weight: 700; color: var(--theme-text-primary); margin-bottom: 1rem;">
              <i class="fas fa-arrow-circle-left" style="color: #3b82f6;"></i> ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä ÿßŸÜÿ™ŸÇŸÑ ÿ•ŸÑŸâ ÿµŸÅÿ≠ÿ© ŸÖÿÆÿµÿµÿ©
            </h3>
            
            <p style="font-size: 1.1rem; color: var(--theme-text-secondary); line-height: 1.8; margin-bottom: 2rem; max-width: 600px; margin-left: auto; margin-right: auto;">
              ŸÑÿ™ÿ≥ŸáŸäŸÑ ÿßŸÑŸàÿµŸàŸÑ Ÿàÿ™ŸàŸÅŸäÿ± ŸÖŸäÿ≤ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©ÿå ÿ™ŸÖ ŸÜŸÇŸÑ ÿ¨ŸÖŸäÿπ ŸÖŸäÿ≤ÿßÿ™ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿå ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑÿå ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿ•ŸÑŸâ ÿµŸÅÿ≠ÿ© ŸÖÿ™ÿÆÿµÿµÿ©.
            </p>

            <div style="max-width: 400px; margin: 0 auto;">
              <button class="btn btn-primary" onclick="showSettingsPage('cloud-data')" style="width: 100%; padding: 1.5rem; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem;">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>ÿßŸÑÿ∞Ÿáÿßÿ® ÿ•ŸÑŸâ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ŸàÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
              </button>

              <div style="background: rgba(59, 130, 246, 0.1); border-radius: 10px; padding: 1rem; text-align: right;">
                <p style="color: var(--theme-text-secondary); font-size: 0.9rem; margin: 0; line-height: 1.6;">
                  <i class="fas fa-info-circle" style="color: #3b82f6;"></i> ÿ≥ÿ™ÿ¨ÿØ ŸáŸÜÿßŸÉ: ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑÿå ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑÿå ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆÿå ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÜÿ≥ÿÆÿå ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸàÿßŸÑÿ≥ÿ¨ŸÑ ÿßŸÑŸÉÿßŸÖŸÑ
                </p>
              </div>
            </div>
          </div>
        </div>

      </div>
     </div>


     <!-- ÿµŸÅÿ≠ÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© -->
     <div id="settings-printing" class="page" style="display: none;">
      <div class="section-header">
       <button class="btn btn-secondary" onclick="showPage('settings')" style="margin-left: 1rem;">
         <i class="fas fa-arrow-right"></i> ÿ±ÿ¨Ÿàÿπ
       </button>
       <div class="section-title"><i class="fas fa-print"></i> ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©</div>
      </div>

      <div class="settings-full-width">
        <div class="settings-content-wrapper">
          
          <!-- ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿßÿ®ÿπÿ© -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-print"></i> ÿßŸÑÿ∑ÿßÿ®ÿπÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
            </h3>

            <div class="form-group">
              <label class="form-label">ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ∑ÿßÿ®ÿπÿ©</label>
              <select class="form-select" id="defaultPrinterSelect">
                <option value="">ÿßŸÑÿ∑ÿßÿ®ÿπÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÑŸÑŸÜÿ∏ÿßŸÖ</option>
                <option value="printer1">Thermal Printer POS-80</option>
                <option value="printer2">HP LaserJet Pro</option>
              </select>
              <button class="btn btn-secondary" onclick="refreshPrinters()" style="margin-top: 0.5rem;">
                <i class="fas fa-sync"></i> ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ÿßÿ®ÿπÿßÿ™
              </button>
            </div>

            <div class="form-group">
              <label class="form-label">ÿ≠ÿ¨ŸÖ ÿßŸÑŸàÿ±ŸÇÿ©</label>
              <select class="form-select" id="paperSizeSelect">
                <option value="58mm">58mm (Thermal)</option>
                <option value="80mm" selected>80mm (Thermal)</option>
                <option value="A4">A4</option>
                <option value="A5">A5</option>
              </select>
            </div>
          </div>

          <!-- ÿ™ÿµŸÖŸäŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-receipt"></i> ÿ™ÿµŸÖŸäŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
            </h3>

            <div class="form-group">
              <label class="form-label">ÿ≠ÿ¨ŸÖ ÿÆÿ∑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</label>
              <select class="form-select" id="invoiceFontSize">
                <option value="small">ÿµÿ∫Ÿäÿ± (10px)</option>
                <option value="medium" selected>ŸÖÿ™Ÿàÿ≥ÿ∑ (12px)</option>
                <option value="large">ŸÉÿ®Ÿäÿ± (14px)</option>
                <option value="xlarge">ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã (16px)</option>
              </select>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="showLogoOnInvoice" checked style="width: auto;">
                <span>ÿ•ÿ∏Ÿáÿßÿ± ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ™ÿ¨ÿ± ÿπŸÑŸâ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</span>
              </label>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="showBarcodeOnInvoice" checked style="width: auto;">
                <span>ÿ•ÿ∏Ÿáÿßÿ± ÿ®ÿßÿ±ŸÉŸàÿØ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</span>
              </label>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="showTaxOnInvoice" checked style="width: auto;">
                <span>ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ© ÿπŸÑŸâ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</span>
              </label>
            </div>

            <div class="form-group">
              <label class="form-label">ŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸÅŸä ŸÜŸáÿßŸäÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</label>
              <textarea class="form-input" id="invoiceFooterNote" rows="3" placeholder="ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ≤Ÿäÿßÿ±ÿ™ŸÉŸÖ - ŸÜÿ™ŸÖŸÜŸâ ŸÑŸÉŸÖ ŸäŸàŸÖÿßŸã ÿ≥ÿπŸäÿØÿßŸã"></textarea>
            </div>
          </div>

          <!-- ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© -->
          <div style="margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-magic"></i> ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿäÿ©
            </h3>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="autoPrintInvoice" style="width: auto;">
                <span>ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ÿπÿØ ŸÉŸÑ ÿπŸÖŸÑŸäÿ© ÿ®Ÿäÿπ</span>
              </label>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="printCopies" style="width: auto;">
                <span>ÿ∑ÿ®ÿßÿπÿ© ŸÜÿ≥ÿÆÿ™ŸäŸÜ (ŸÜÿ≥ÿÆÿ© ŸÑŸÑÿπŸÖŸäŸÑ ŸàŸÜÿ≥ÿÆÿ© ŸÑŸÑÿ£ÿ±ÿ¥ŸäŸÅ)</span>
              </label>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="openCashDrawer" style="width: auto;">
                <span>ŸÅÿ™ÿ≠ ÿØÿ±ÿ¨ ÿßŸÑŸÜŸÇŸàÿØ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ÿπÿØ ÿßŸÑÿ®Ÿäÿπ</span>
              </label>
            </div>

            <button class="btn" style="background: linear-gradient(135deg, #667eea, #764ba2); width: 100%; padding: 1.2rem; margin-top: 1rem;" onclick="printTestPage()">
              <i class="fas fa-file-pdf"></i> ÿ∑ÿ®ÿßÿπÿ© ÿµŸÅÿ≠ÿ© ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©
            </button>
          </div>

          <div class="form-actions">
            <button class="btn btn-primary" onclick="savePrintingSettings()">
              <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
            </button>
            <button class="btn btn-secondary" onclick="showPage('settings')">
              <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
            </button>
          </div>

        </div>
      </div>
     </div>

     <!-- ÿµŸÅÿ≠ÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ŸÖÿßŸÜ -->
     <div id="settings-security" class="page" style="display: none;">
      <div class="section-header">
       <button class="btn btn-secondary" onclick="showPage('settings')" style="margin-left: 1rem;">
         <i class="fas fa-arrow-right"></i> ÿ±ÿ¨Ÿàÿπ
       </button>
       <div class="section-title"><i class="fas fa-shield-alt"></i> ÿßŸÑÿ£ŸÖÿßŸÜ ŸàÿßŸÑÿÆÿµŸàÿµŸäÿ©</div>
      </div>

      <div class="settings-full-width">
        <div class="settings-content-wrapper">
          
          <!-- ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-key"></i> ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
            </h3>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="enablePassword" style="width: auto;">
                <span>ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≠ŸÖÿßŸäÿ© ÿ®ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ±</span>
              </label>
            </div>

            <div id="passwordFields" style="display: none;">
              <div class="form-group">
                <label class="form-label">ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ≠ÿßŸÑŸäÿ©</label>
                <input type="password" class="form-input" id="currentPassword">
              </div>

              <div class="form-group">
                <label class="form-label">ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©</label>
                <input type="password" class="form-input" id="newPassword">
              </div>

              <div class="form-group">
                <label class="form-label">ÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
                <input type="password" class="form-input" id="confirmPassword">
              </div>

              <button class="btn btn-warning" onclick="changePassword()">
                <i class="fas fa-key"></i> ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
              </button>
            </div>
          </div>

          <!-- ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-user-shield"></i> ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
            </h3>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="requirePasswordForDelete" checked style="width: auto;">
                <span>ÿ∑ŸÑÿ® ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿπŸÜÿØ ÿßŸÑÿ≠ÿ∞ŸÅ</span>
              </label>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="requirePasswordForReports" style="width: auto;">
                <span>ÿ∑ŸÑÿ® ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑŸÖÿßŸÑŸäÿ©</span>
              </label>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="requirePasswordForSettings" checked style="width: auto;">
                <span>ÿ∑ŸÑÿ® ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</span>
              </label>
            </div>
          </div>

          <!-- ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ¥ÿßÿ∑ÿßÿ™ -->
          <div class="settings-section">
            <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);">
              <i class="fas fa-history"></i> ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ¥ÿßÿ∑ÿßÿ™
            </h3>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="enableActivityLog" checked style="width: auto;">
                <span>ÿ™ŸÅÿπŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ¥ÿßÿ∑ÿßÿ™</span>
              </label>
              <small style="color: var(--theme-text-secondary); margin-top: 0.5rem; display: block;">
                ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ (ÿßŸÑÿ®Ÿäÿπÿå ÿßŸÑÿ≠ÿ∞ŸÅÿå ÿßŸÑÿ™ÿπÿØŸäŸÑ)
              </small>
            </div>

            <div class="form-group">
              <label class="form-label">ŸÖÿØÿ© ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿßŸÑÿ≥ÿ¨ŸÑ</label>
              <select class="form-select" id="logRetentionPeriod">
                <option value="30">30 ŸäŸàŸÖ</option>
                <option value="90" selected>90 ŸäŸàŸÖ</option>
                <option value="180">180 ŸäŸàŸÖ</option>
                <option value="365">ÿ≥ŸÜÿ© ŸÉÿßŸÖŸÑÿ©</option>
                <option value="0">ÿ®ÿØŸàŸÜ ÿ≠ÿØ</option>
              </select>
            </div>

            <button class="btn btn-secondary" onclick="viewActivityLog()">
              <i class="fas fa-list"></i> ÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ¥ÿßÿ∑ÿßÿ™
            </button>
          </div>

          <div class="form-actions">
            <button class="btn btn-primary" onclick="saveSecuritySettings()">
              <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
            </button>
            <button class="btn btn-secondary" onclick="showPage('settings')">
              <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
            </button>
          </div>

        </div>
      </div>
     </div>
     <div id="settings-cloud-data" class="page" style="display: none;">
      <div class="section-header" style="margin-bottom: 2rem;">
       <button class="btn btn-secondary" onclick="showPage('settings')" style="margin-left: 1rem;">
         <i class="fas fa-arrow-right"></i> ÿ±ÿ¨Ÿàÿπ
       </button>
       <div class="section-title">
         <i class="fas fa-cloud" style="color: #3b82f6;"></i> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ŸàÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
       </div>
       <div class="section-subtitle">ÿ•ÿØÿßÿ±ÿ© ŸÉÿßŸÖŸÑÿ© ŸÑŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿå ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿå ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ŸàÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©</div>
      </div>

      <div class="settings-full-width">
        <div class="settings-content-wrapper">

          <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ© -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div class="info-mini-card">
          <div class="info-mini-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
            <i class="fas fa-cloud-upload-alt"></i>
          </div>
          <div class="info-mini-content">
            <div class="info-mini-label">ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ÿ≥ÿ≠ÿßÿ®Ÿäÿ©</div>
            <div class="info-mini-value" id="cloudLastBackupDate">ŸÑÿß ÿ™Ÿàÿ¨ÿØ</div>
          </div>
        </div>
        
        <div class="info-mini-card">
          <div class="info-mini-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
            <i class="fas fa-database"></i>
          </div>
          <div class="info-mini-content">
            <div class="info-mini-label">ÿ≠ÿ¨ŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</div>
            <div class="info-mini-value" id="cloudBackupSize">0 KB</div>
          </div>
        </div>
        
        <div class="info-mini-card">
          <div class="info-mini-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
            <i class="fas fa-user-circle"></i>
          </div>
          <div class="info-mini-content">
            <div class="info-mini-label">ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®</div>
            <div class="info-mini-value" id="cloudAccountStatus">ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ</div>
          </div>
        </div>
        
        <div class="info-mini-card">
          <div class="info-mini-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
            <i class="fas fa-history"></i>
          </div>
          <div class="info-mini-content">
            <div class="info-mini-label">ÿπÿØÿØ ÿßŸÑŸÜÿ≥ÿÆ</div>
            <div class="info-mini-value" id="cloudBackupCount">0</div>
          </div>
        </div>
      </div>

          <!-- ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™ -->
          <div style="background: var(--theme-bg-secondary); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(255,255,255,0.05);">
        
        <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™ -->
        <div style="display: flex; gap: 0.5rem; border-bottom: 2px solid rgba(255,255,255,0.1); margin-bottom: 2rem; flex-wrap: wrap;">
          <button class="cloud-tab-btn active" onclick="switchCloudTab('login')" data-tab="login">
            <i class="fas fa-user-lock"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
          </button>
          <button class="cloud-tab-btn" onclick="switchCloudTab('backup')" data-tab="backup">
            <i class="fas fa-cloud-upload-alt"></i> ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆ
          </button>
          <button class="cloud-tab-btn" onclick="switchCloudTab('restore')" data-tab="restore">
            <i class="fas fa-cloud-download-alt"></i> ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÜÿ≥ÿÆ
          </button>
          <button class="cloud-tab-btn" onclick="switchCloudTab('settings')" data-tab="settings">
            <i class="fas fa-cog"></i> ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
          </button>
          <button class="cloud-tab-btn" onclick="switchCloudTab('history')" data-tab="history">
            <i class="fas fa-history"></i> ÿßŸÑÿ≥ÿ¨ŸÑ
          </button>
        </div>

        <!-- ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™ -->
        <div id="cloudTabContent">
          
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- ÿ™ÿ®ŸàŸäÿ®ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <div id="cloudTab-login" class="cloud-tab-panel active">
            
            <!-- ÿ≠ÿßŸÑÿ©: ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ -->
            <div id="cloudLoginForm" style="display: block;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; box-shadow: 0 8px 32px rgba(59, 130, 246, 0.4);">
                  <i class="fas fa-cloud" style="font-size: 4rem; color: white;"></i>
                </div>
                <h2 style="font-size: 2rem; font-weight: 700; color: var(--theme-text-primary); margin: 0 0 0.5rem 0;">
                  ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÑÿ≥ÿ≠ÿßÿ®ÿ©
                </h2>
                <p style="font-size: 1.1rem; color: var(--theme-text-secondary); margin: 0;">
                  ŸÇŸÖ ÿ®ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ŸÜÿ≥ÿÆŸÉ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿ©
                </p>
              </div>

              <div style="max-width: 500px; margin: 0 auto;">
                
                <!-- ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ -->
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                  <button class="btn" style="flex: 1; padding: 1rem; background: linear-gradient(135deg, #3b82f6, #2563eb);" onclick="showCloudRegisterForm()">
                    <i class="fas fa-user-plus"></i> ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ
                  </button>
                  <button class="btn btn-secondary" style="flex: 1; padding: 1rem;" onclick="showCloudLoginForm()">
                    <i class="fas fa-sign-in-alt"></i> ŸÑÿØŸä ÿ≠ÿ≥ÿßÿ®
                  </button>
                </div>

                <!-- ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ¨ÿØŸäÿØ -->
                <div id="cloudRegisterFormPanel" style="display: none;">
                  <h3 style="margin-bottom: 1.5rem; color: var(--theme-text-primary);">
                    <i class="fas fa-user-plus"></i> ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ
                  </h3>
                  
                  <div style="background: rgba(59, 130, 246, 0.1); border-right: 4px solid #3b82f6; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <p style="color: var(--theme-text-secondary); line-height: 1.6; margin: 0;">
                      ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑÿå ÿ≥ÿ™ÿ™ŸÑŸÇŸâ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ŸÖŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿπÿ®ÿ± ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ® ÿÆŸÑÿßŸÑ 24 ÿ≥ÿßÿπÿ©.
                    </p>
                  </div>

                  <form id="cloudRegisterForm" onsubmit="handleCloudRegisterSubmit(event); return false;">
                    <div class="form-group">
                      <label class="form-label">ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ</label>
                      <input type="text" class="form-input" id="cloudRegFullName" required>
                    </div>

                    <div class="form-group">
                      <label class="form-label">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ (11 ÿ±ŸÇŸÖ)</label>
                      <input type="tel" class="form-input" id="cloudRegPhone" pattern="[0-9]{11}" required placeholder="07XXXXXXXXX">
                    </div>

                    <div style="display: flex; gap: 1rem;">
                      <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-paper-plane"></i> ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®
                      </button>
                      <button type="button" class="btn btn-secondary" onclick="hideCloudRegisterForm()">
                        <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                      </button>
                    </div>
                  </form>
                </div>

                <!-- ŸÜŸÖŸàÿ∞ÿ¨ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ -->
                <div id="cloudLoginFormPanel" style="display: none;">
                  <h3 style="margin-bottom: 1.5rem; color: var(--theme-text-primary);">
                    <i class="fas fa-sign-in-alt"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                  </h3>

                  <div style="background: rgba(251, 191, 36, 0.1); border-right: 4px solid #fbbf24; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <p style="color: var(--theme-text-secondary); line-height: 1.6; margin: 0;">
                      ÿ£ÿØÿÆŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ≠ÿ≥ÿßÿ®ŸÉ ÿßŸÑÿ∞Ÿä ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑŸá ŸÖŸÜ ŸÇÿ®ŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ©.
                    </p>
                  </div>

                  <form id="cloudLoginFormSubmit" onsubmit="handleCloudLoginSubmit(event); return false;">
                    <div class="form-group">
                      <label class="form-label">ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ</label>
                      <input type="text" class="form-input" id="cloudLoginFullName" required>
                    </div>

                    <div class="form-group">
                      <label class="form-label">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ (11 ÿ±ŸÇŸÖ)</label>
                      <input type="tel" class="form-input" id="cloudLoginPhone" pattern="[0-9]{11}" required placeholder="07XXXXXXXXX">
                    </div>

                    <div class="form-group">
                      <label class="form-label">ÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ (6 ÿ£ÿ±ŸÇÿßŸÖ)</label>
                      <input type="text" class="form-input" id="cloudLoginActivationCode" pattern="[0-9]{6}" required placeholder="XXXXXX">
                    </div>

                    <div style="display: flex; gap: 1rem;">
                      <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-sign-in-alt"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                      </button>
                      <button type="button" class="btn btn-secondary" onclick="hideCloudLoginForm()">
                        <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                      </button>
                    </div>
                  </form>
                </div>

              </div>
            </div>

            <!-- ÿ≠ÿßŸÑÿ©: ŸÖÿ≥ÿ¨ŸÑ ŸàŸÖŸÅÿπŸëŸÑ -->
            <div id="cloudLoggedInPanel" style="display: none;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <div style="background: linear-gradient(135deg, #10b981, #059669); width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; box-shadow: 0 8px 32px rgba(16, 185, 129, 0.4);">
                  <i class="fas fa-user-check" style="font-size: 4rem; color: white;"></i>
                </div>
                <h2 id="cloudUserDisplayName" style="font-size: 2rem; font-weight: 700; color: var(--theme-text-primary); margin: 0 0 0.5rem 0;">
                  ŸÖÿ±ÿ≠ÿ®ÿßŸã
                </h2>
                <p style="font-size: 1.1rem; color: #10b981; margin: 0;">
                  <i class="fas fa-check-circle"></i> ÿ≠ÿ≥ÿßÿ®ŸÉ ŸÖŸèŸÅÿπŸëŸÑ ŸàŸÖÿ™ÿµŸÑ ÿ®ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
                </p>
              </div>

              <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ® -->
              <div style="max-width: 600px; margin: 0 auto;">
                <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(255,255,255,0.05);">
                  
                  <div style="display: grid; gap: 1rem;">
                    <div style="display: flex; justify-content: space-between; padding: 1rem; background: var(--theme-bg-secondary); border-radius: 8px;">
                      <span style="color: var(--theme-text-secondary);">
                        <i class="fas fa-user"></i> ÿßŸÑÿßÿ≥ŸÖ:
                      </span>
                      <strong id="cloudUserName" style="color: var(--theme-text-primary);">---</strong>
                    </div>

                    <div style="display: flex; justify-content: space-between; padding: 1rem; background: var(--theme-bg-secondary); border-radius: 8px;">
                      <span style="color: var(--theme-text-secondary);">
                        <i class="fas fa-phone"></i> ÿßŸÑŸáÿßÿ™ŸÅ:
                      </span>
                      <strong id="cloudUserPhone" style="color: var(--theme-text-primary); direction: ltr;">---</strong>
                    </div>

                    <div style="display: flex; justify-content: space-between; padding: 1rem; background: var(--theme-bg-secondary); border-radius: 8px;">
                      <span style="color: var(--theme-text-secondary);">
                        <i class="fas fa-fingerprint"></i> ÿßŸÑŸÖÿπÿ±ŸëŸÅ:
                      </span>
                      <strong id="cloudUserUID" style="color: var(--theme-text-secondary); font-size: 0.85rem; font-family: monospace;">---</strong>
                    </div>

                    <div style="display: flex; justify-content: space-between; padding: 1rem; background: var(--theme-bg-secondary); border-radius: 8px;">
                      <span style="color: var(--theme-text-secondary);">
                        <i class="fas fa-calendar"></i> ŸÖÿ≥ÿ¨ŸÑ ŸÖŸÜÿ∞:
                      </span>
                      <strong id="cloudUserRegisteredAt" style="color: var(--theme-text-primary);">---</strong>
                    </div>
                  </div>

                </div>

                <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ -->
                <div style="display: grid; gap: 1rem;">
                  <button class="btn btn-warning" onclick="handleCloudLogout()">
                    <i class="fas fa-sign-out-alt"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
                  </button>
                  
                  <button class="btn btn-secondary" onclick="switchCloudTab('backup')">
                    <i class="fas fa-cloud-upload-alt"></i> ÿßŸÜÿ™ŸÇŸÑ ÿ•ŸÑŸâ ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
                  </button>
                </div>
              </div>
            </div>

            <!-- ÿ≠ÿßŸÑÿ©: ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÅÿπŸäŸÑ -->
            <div id="cloudWaitingActivation" style="display: none;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <div style="background: linear-gradient(135deg, #f59e0b, #d97706); width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; box-shadow: 0 8px 32px rgba(245, 158, 11, 0.4); animation: pulse 2s infinite;">
                  <i class="fas fa-clock" style="font-size: 4rem; color: white;"></i>
                </div>
                <h2 style="font-size: 2rem; font-weight: 700; color: var(--theme-text-primary); margin: 0 0 0.5rem 0;">
                  ‚è≥ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÅÿπŸäŸÑ
                </h2>
                <p style="font-size: 1.1rem; color: var(--theme-text-secondary); margin: 0;">
                  ÿ∑ŸÑÿ®ŸÉ ŸÇŸäÿØ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ŸÖŸÜ ŸÇÿ®ŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ©
                </p>
              </div>

              <div style="max-width: 500px; margin: 0 auto;">
                
                <div style="background: rgba(245, 158, 11, 0.1); border-right: 4px solid #f59e0b; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                  <h4 style="color: #f59e0b; margin-bottom: 0.75rem;">
                    <i class="fas fa-info-circle"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÖŸáŸÖÿ©
                  </h4>
                  <ul style="color: var(--theme-text-secondary); line-height: 1.8; margin: 0; padding-right: 1.5rem;">
                    <li>ÿ≥ÿ™ÿ™ŸÑŸÇŸâ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ŸÖŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿπÿ®ÿ± ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®</li>
                    <li>ÿπÿßÿØÿ©Ÿã Ÿäÿ™ŸÖ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿÆŸÑÿßŸÑ 24 ÿ≥ÿßÿπÿ©</li>
                    <li>ŸäŸÖŸÉŸÜŸÉ ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ ŸÖŸÜ ÿßŸÑÿ≤ÿ± ÿ£ÿØŸÜÿßŸá</li>
                  </ul>
                </div>

                <div style="display: grid; gap: 1rem;">
                  <button class="btn btn-primary" onclick="checkCloudActivationStatus()">
                    <i class="fas fa-sync-alt"></i> ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ
                  </button>
                  
                  <button class="btn btn-secondary" onclick="cancelCloudRegistration()">
                    <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ∑ŸÑÿ®
                  </button>
                </div>

              </div>
            </div>

          </div>

          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- ÿ™ÿ®ŸàŸäÿ®ÿ© ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <div id="cloudTab-backup" class="cloud-tab-panel">
            
            <!-- ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ -->
            <div id="cloudBackupLoginRequired" style="display: none;">
              <div style="text-align: center; padding: 3rem;">
                <div style="background: rgba(239, 68, 68, 0.1); width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                  <i class="fas fa-lock" style="font-size: 3rem; color: #ef4444;"></i>
                </div>
                <h3 style="font-size: 1.5rem; color: var(--theme-text-primary); margin-bottom: 1rem;">
                  Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã
                </h3>
                <p style="color: var(--theme-text-secondary); margin-bottom: 2rem;">
                  ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ŸÖŸäÿ≤ÿ© ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©ÿå Ÿäÿ¨ÿ® ÿπŸÑŸäŸÉ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                </p>
                <button class="btn btn-primary" onclick="switchCloudTab('login')">
                  <i class="fas fa-sign-in-alt"></i> ÿßŸÑÿ∞Ÿáÿßÿ® ÿ•ŸÑŸâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                </button>
              </div>
            </div>

            <!-- Ÿàÿßÿ¨Ÿáÿ© ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆ -->
            <div id="cloudBackupPanel" style="display: none;">
              
              <h3 style="font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--theme-text-primary);">
                <i class="fas fa-cloud-upload-alt"></i> ÿ±ŸÅÿπ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
              </h3>

              <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© -->
              <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid rgba(255,255,255,0.05);">
                <div style="display: grid; gap: 1rem;">
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--theme-text-secondary);">
                      <i class="fas fa-clock"></i> ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©:
                    </span>
                    <strong id="cloudBackupLastDate" style="color: var(--theme-text-primary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--theme-text-secondary);">
                      <i class="fas fa-database"></i> ÿ≠ÿ¨ŸÖ ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ©:
                    </span>
                    <strong id="cloudBackupLastSize" style="color: var(--theme-text-primary);">0 KB</strong>
                  </div>
                </div>
              </div>

              <!-- ŸÜÿµŸäÿ≠ÿ© -->
              <div style="background: rgba(59, 130, 246, 0.1); border-right: 4px solid #3b82f6; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                <h4 style="color: #3b82f6; margin-bottom: 0.5rem;">
                  <i class="fas fa-lightbulb"></i> ŸÜÿµŸäÿ≠ÿ©
                </h4>
                <p style="color: var(--theme-text-secondary); line-height: 1.6; margin: 0;">
                  ŸÇŸÖ ÿ®ÿ±ŸÅÿπ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ÿ¥ŸÉŸÑ ÿØŸàÿ±Ÿä ŸÑŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿ¢ŸÖŸÜÿ© ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©. ŸäŸÖŸÉŸÜŸÉ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÖŸÜ ÿ™ÿ®ŸàŸäÿ®ÿ© "ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™".
                </p>
              </div>

              <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ±ŸÅÿπ -->
              <div style="display: grid; gap: 1rem;">
                <button class="btn btn-success" style="padding: 1.5rem; font-size: 1.1rem;" onclick="uploadBackupToFirebase(false)">
                  <i class="fas fa-cloud-upload-alt"></i> ÿ±ŸÅÿπ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿßŸÑÿ¢ŸÜ
                </button>

                <button class="btn btn-secondary" onclick="refreshCloudBackupInfo()">
                  <i class="fas fa-sync-alt"></i> ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™
                </button>
              </div>

            </div>

          </div>

          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- ÿ™ÿ®ŸàŸäÿ®ÿ© ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÜÿ≥ÿÆ -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <div id="cloudTab-restore" class="cloud-tab-panel">
            
            <!-- ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ -->
            <div id="cloudRestoreLoginRequired" style="display: none;">
              <div style="text-align: center; padding: 3rem;">
                <div style="background: rgba(239, 68, 68, 0.1); width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                  <i class="fas fa-lock" style="font-size: 3rem; color: #ef4444;"></i>
                </div>
                <h3 style="font-size: 1.5rem; color: var(--theme-text-primary); margin-bottom: 1rem;">
                  Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã
                </h3>
                <p style="color: var(--theme-text-secondary); margin-bottom: 2rem;">
                  ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ŸÖŸäÿ≤ÿ© ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©ÿå Ÿäÿ¨ÿ® ÿπŸÑŸäŸÉ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                </p>
                <button class="btn btn-primary" onclick="switchCloudTab('login')">
                  <i class="fas fa-sign-in-alt"></i> ÿßŸÑÿ∞Ÿáÿßÿ® ÿ•ŸÑŸâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                </button>
              </div>
            </div>

            <!-- Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ -->
            <div id="cloudRestorePanel" style="display: none;">
              
              <h3 style="font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--theme-text-primary);">
                <i class="fas fa-cloud-download-alt"></i> ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
              </h3>

              <!-- ÿ™ÿ≠ÿ∞Ÿäÿ± -->
              <div style="background: rgba(239, 68, 68, 0.1); border-right: 4px solid #ef4444; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                <h4 style="color: #ef4444; margin-bottom: 0.5rem;">
                  <i class="fas fa-exclamation-triangle"></i> ÿ™ÿ≠ÿ∞Ÿäÿ± ŸÖŸáŸÖ
                </h4>
                <p style="color: var(--theme-text-secondary); line-height: 1.6; margin: 0;">
                  ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ≥Ÿäÿ§ÿØŸä ÿ•ŸÑŸâ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ <strong>ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©</strong>. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÇÿ®ŸÑ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ.
                </p>
              </div>

              <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ -->
              <div style="display: grid; gap: 1rem;">
                <button class="btn btn-primary" style="padding: 1.5rem; font-size: 1.1rem;" onclick="downloadBackupFromFirebase()">
                  <i class="fas fa-cloud-download-alt"></i> ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
                </button>

                <button class="btn btn-secondary" onclick="showCloudBackupHistory()">
                  <i class="fas fa-history"></i> ÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
                </button>
              </div>

            </div>

          </div>

          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- ÿ™ÿ®ŸàŸäÿ®ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <div id="cloudTab-settings" class="cloud-tab-panel">
            
            <h3 style="font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--theme-text-primary);">
              <i class="fas fa-cog"></i> ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä
            </h3>

            <!-- ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä -->
            <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(255,255,255,0.05);">
              
              <h4 style="font-size: 1.25rem; margin-bottom: 1.5rem; color: var(--theme-text-primary);">
                <i class="fas fa-robot"></i> ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
              </h4>

              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" id="cloudAutoBackupEnabled" style="width: auto;" checked>
                  <span style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-cloud" style="color: #3b82f6;"></i>
                    <strong>ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</strong>
                  </span>
                </label>
                <p style="color: var(--theme-text-secondary); font-size: 0.85rem; margin: 0.5rem 0 0 2rem; line-height: 1.5;">
                  Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ŸÅŸä ŸÉŸÑ ŸÖÿ±ÿ© ÿ™ŸÅÿ™ÿ≠ ŸÅŸäŸáÿß ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ (ŸÖÿπ ÿ≠ÿØ ÿ£ÿØŸÜŸâ 6 ÿ≥ÿßÿπÿßÿ™ ÿ®ŸäŸÜ ÿßŸÑŸÜÿ≥ÿÆ)
                </p>
              </div>

              <div class="form-group">
                <label class="form-label">ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä</label>
                <select class="form-select" id="cloudAutoBackupFrequency">
                  <option value="startup">ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ (ŸÖÿπ ÿ≠ÿØ ÿ£ÿØŸÜŸâ 6 ÿ≥ÿßÿπÿßÿ™)</option>
                  <option value="hourly">ŸÉŸÑ ÿ≥ÿßÿπÿ©</option>
                  <option value="daily">ŸäŸàŸÖŸäÿßŸã</option>
                  <option value="weekly">ÿ£ÿ≥ÿ®ŸàÿπŸäÿßŸã</option>
                </select>
              </div>

              <button class="btn btn-primary" onclick="saveCloudSettings()">
                <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
              </button>

            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÉÿßŸÖŸÑÿ© -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(37, 99, 235, 0.05)); border: 2px solid rgba(59, 130, 246, 0.2); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1);">
              
              <h4 style="font-size: 1.25rem; margin-bottom: 1.5rem; color: var(--theme-text-primary);">
                <i class="fas fa-database"></i> ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÉÿßŸÖŸÑÿ© ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
              </h4>

              <!-- ÿ¥ÿ±ÿ≠ -->
              <div style="background: rgba(59, 130, 246, 0.1); border-right: 4px solid #3b82f6; padding: 1.25rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h5 style="color: #3b82f6; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                  <i class="fas fa-info-circle"></i> ŸÖÿß ÿßŸÑÿ∞Ÿä ÿ≥Ÿäÿ™ŸÖ ÿ±ŸÅÿπŸáÿü
                </h5>
                <ul style="color: var(--theme-text-secondary); line-height: 1.8; margin: 0.5rem 0 0 0; padding-right: 1.5rem; font-size: 0.95rem;">
                  <li>ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸàÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™</li>
                  <li>ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± Ÿàÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™</li>
                  <li>ÿßŸÑÿØŸäŸàŸÜ ŸàÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ŸàÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™</li>
                  <li>ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™ ŸàÿßŸÑŸÖÿµÿ±ŸàŸÅÿßÿ™</li>
                  <li>ÿßŸÑÿπŸÖŸÑÿßÿ° ŸàÿßŸÑŸÖŸàÿ±ÿØŸäŸÜ</li>
                  <li>ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿÆÿ≤ŸÜÿ© ŸÅŸä ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</li>
                </ul>
              </div>

              <!-- ÿÆŸäÿßÿ± ÿßŸÑÿ±ŸÅÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä -->
              <div class="form-group" style="background: var(--theme-bg-tertiary); padding: 1.5rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 1.5rem;">
                <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer;">
                  <input type="checkbox" id="autoUploadAllData" style="width: auto; margin-top: 0.25rem;">
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                      <i class="fas fa-sync-alt" style="color: #3b82f6;"></i>
                      <strong style="font-size: 1.05rem;">ÿ±ŸÅÿπ ÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</strong>
                    </div>
                    <p style="color: var(--theme-text-secondary); font-size: 0.9rem; margin: 0; line-height: 1.6;">
                      ÿπŸÜÿØ ÿßŸÑÿ™ŸÅÿπŸäŸÑÿå ÿ≥Ÿäÿ™ŸÖ ÿ±ŸÅÿπ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿπŸÜÿØ ŸÉŸÑ ÿ™ÿ∫ŸäŸäÿ± (ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ÿå ŸÅÿßÿ™Ÿàÿ±ÿ©ÿå ÿ™ÿ≥ÿØŸäÿØÿå ÿ•ŸÑÿÆ)
                    </p>
                  </div>
                </label>
              </div>

              <!-- ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿ±ŸÅÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä -->
              <div id="autoUploadFrequencyPanel" style="display: none; background: var(--theme-bg-tertiary); padding: 1.5rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 1.5rem;">
                <label class="form-label">
                  <i class="fas fa-clock"></i> ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿ±ŸÅÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
                </label>
                <select class="form-select" id="autoUploadFrequency">
                  <option value="immediate">ŸÅŸàÿ±Ÿä (ÿ®ÿπÿØ ŸÉŸÑ ÿπŸÖŸÑŸäÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©)</option>
                  <option value="5min" selected>ŸÉŸÑ 5 ÿØŸÇÿßÿ¶ŸÇ</option>
                  <option value="15min">ŸÉŸÑ 15 ÿØŸÇŸäŸÇÿ©</option>
                  <option value="30min">ŸÉŸÑ 30 ÿØŸÇŸäŸÇÿ©</option>
                  <option value="hourly">ŸÉŸÑ ÿ≥ÿßÿπÿ©</option>
                  <option value="daily">ŸäŸàŸÖŸäÿßŸã</option>
                </select>
                <p style="color: var(--theme-text-secondary); font-size: 0.85rem; margin: 0.5rem 0 0 0;">
                  <i class="fas fa-lightbulb"></i> ŸÜŸàÿµŸä ÿ®ŸÄ "ŸÉŸÑ 5 ÿØŸÇÿßÿ¶ŸÇ" ŸÑÿ™Ÿàÿßÿ≤ŸÜ ÿ®ŸäŸÜ ÿßŸÑÿ£ŸÖÿßŸÜ ŸàÿßŸÑÿ£ÿØÿßÿ°
                </p>
              </div>

              <!-- ÿ≤ÿ± ÿßŸÑÿ±ŸÅÿπ ÿßŸÑŸäÿØŸàŸä -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <button class="btn" style="background: linear-gradient(135deg, #10b981, #059669); padding: 1.25rem; font-size: 1rem;" onclick="manualUploadAllData()">
                  <i class="fas fa-cloud-upload-alt"></i> ÿ±ŸÅÿπ ŸäÿØŸàŸä ÿßŸÑÿ¢ŸÜ
                </button>
                <button class="btn btn-secondary" style="padding: 1.25rem;" onclick="saveDataUploadSettings()">
                  <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
                </button>
              </div>

              <!-- ÿ¢ÿÆÿ± ÿ±ŸÅÿπ -->
              <div id="lastDataUploadInfo" style="margin-top: 1.5rem; padding: 1rem; background: var(--theme-bg-secondary); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--theme-text-secondary); font-size: 0.9rem;">
                  <i class="fas fa-clock"></i> ÿ¢ÿÆÿ± ÿ±ŸÅÿπ ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™:
                </span>
                <strong id="lastDataUploadTime" style="color: var(--theme-text-primary); font-size: 0.95rem;">ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ±ŸÅÿπ ÿ®ÿπÿØ</strong>
              </div>

            </div>

            <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ Firebase -->
            <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 2rem; border: 1px solid rgba(255,255,255,0.05);">
              
              <h4 style="font-size: 1.25rem; margin-bottom: 1.5rem; color: var(--theme-text-primary);">
                <i class="fas fa-info-circle"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
              </h4>

              <div style="display: grid; gap: 1rem;">
                <div style="display: flex; justify-content: space-between; padding: 1rem; background: var(--theme-bg-secondary); border-radius: 8px;">
                  <span style="color: var(--theme-text-secondary);">
                    <i class="fas fa-database"></i> ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:
                  </span>
                  <strong id="firebaseDbName" style="color: var(--theme-text-primary); font-size: 0.85rem;">Firebase Realtime Database</strong>
                </div>

                <div style="display: flex; justify-content: space-between; padding: 1rem; background: var(--theme-bg-secondary); border-radius: 8px;">
                  <span style="color: var(--theme-text-secondary);">
                    <i class="fas fa-link"></i> ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ:
                  </span>
                  <strong id="firebaseConnectionStatus" style="color: #10b981;">
                    <i class="fas fa-check-circle"></i> ŸÖÿ™ÿµŸÑ
                  </strong>
                </div>
              </div>

            </div>

          </div>

          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- ÿ™ÿ®ŸàŸäÿ®ÿ© ÿßŸÑÿ≥ÿ¨ŸÑ -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <div id="cloudTab-history" class="cloud-tab-panel">
            
            <h3 style="font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--theme-text-primary);">
              <i class="fas fa-history"></i> ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿ©
            </h3>

            <div style="margin-bottom: 1.5rem;">
              <button class="btn btn-secondary" onclick="loadCloudBackupHistory()">
                <i class="fas fa-sync-alt"></i> ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≥ÿ¨ŸÑ
              </button>
            </div>

            <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑÿ≥ÿ¨ŸÑ -->
            <div id="cloudBackupHistoryList" style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.05);">
              <p style="text-align: center; color: var(--theme-text-secondary); padding: 2rem;">
                <i class="fas fa-info-circle"></i> ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ≥ÿ≠ÿßÿ®Ÿäÿ© ÿ®ÿπÿØ
              </p>
            </div>

          </div>

        </div>

      </div>
      </div>
     </div>
     </div>
     <!-- ŸÜŸáÿßŸäÿ© ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ŸàÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ -->

     <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
     <!-- ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©  -->
     <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
     <div id="cloudManagement" class="page" style="display: none;">
      <div class="section-header" style="margin-bottom: 2rem;">
       <div class="section-title">
         <i class="fas fa-cloud" style="color: #3b82f6;"></i> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
       </div>
       <div class="section-subtitle">ÿ•ÿØÿßÿ±ÿ© ŸÉÿßŸÖŸÑÿ© ŸÑŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä Ÿàÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</div>
      </div>

      <div class="settings-full-width">
        <div class="settings-content-wrapper">

      <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ© -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div class="info-mini-card">
          <div class="info-mini-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
            <i class="fas fa-cloud-upload-alt"></i>
          </div>
          <div class="info-mini-content">
            <div class="info-mini-label">ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ÿ≥ÿ≠ÿßÿ®Ÿäÿ©</div>
            <div class="info-mini-value" id="cloudLastBackupDate">ŸÑÿß ÿ™Ÿàÿ¨ÿØ</div>
          </div>
        </div>
        
        <div class="info-mini-card">
          <div class="info-mini-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
            <i class="fas fa-database"></i>
          </div>
          <div class="info-mini-content">
            <div class="info-mini-label">ÿ≠ÿ¨ŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</div>
            <div class="info-mini-value" id="cloudBackupSize">0 KB</div>
          </div>
        </div>
        
        <div class="info-mini-card">
          <div class="info-mini-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
            <i class="fas fa-user-circle"></i>
          </div>
          <div class="info-mini-content">
            <div class="info-mini-label">ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®</div>
            <div class="info-mini-value" id="cloudAccountStatus">ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ</div>
          </div>
        </div>
        
        <div class="info-mini-card">
          <div class="info-mini-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
            <i class="fas fa-history"></i>
          </div>
          <div class="info-mini-content">
            <div class="info-mini-label">ÿπÿØÿØ ÿßŸÑŸÜÿ≥ÿÆ</div>
            <div class="info-mini-value" id="cloudBackupCount">0</div>
          </div>
        </div>
      </div>

      <!-- ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™ -->
      <div style="background: var(--theme-bg-secondary); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(255,255,255,0.05);">
        
        <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™ -->
        <div style="display: flex; gap: 0.5rem; border-bottom: 2px solid rgba(255,255,255,0.1); margin-bottom: 2rem; flex-wrap: wrap;">
          <button class="cloud-tab-btn active" onclick="switchCloudTab('login')" data-tab="login">
            <i class="fas fa-user-lock"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
          </button>
          <button class="cloud-tab-btn" onclick="switchCloudTab('backup')" data-tab="backup">
            <i class="fas fa-cloud-upload-alt"></i> ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆ
          </button>
          <button class="cloud-tab-btn" onclick="switchCloudTab('restore')" data-tab="restore">
            <i class="fas fa-cloud-download-alt"></i> ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÜÿ≥ÿÆ
          </button>
          <button class="cloud-tab-btn" onclick="switchCloudTab('settings')" data-tab="settings">
            <i class="fas fa-cog"></i> ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
          </button>
          <button class="cloud-tab-btn" onclick="switchCloudTab('history')" data-tab="history">
            <i class="fas fa-history"></i> ÿßŸÑÿ≥ÿ¨ŸÑ
          </button>
        </div>

        <!-- ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™ -->
        <div id="cloudTabContent">
          
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- ÿ™ÿ®ŸàŸäÿ®ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <div id="cloudTab-login" class="cloud-tab-panel active">
            
            <!-- ÿ≠ÿßŸÑÿ©: ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ -->
            <div id="cloudLoginForm" style="display: block;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; box-shadow: 0 8px 32px rgba(59, 130, 246, 0.4);">
                  <i class="fas fa-cloud" style="font-size: 4rem; color: white;"></i>
                </div>
                <h2 style="font-size: 2rem; font-weight: 700; color: var(--theme-text-primary); margin: 0 0 0.5rem 0;">
                  ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÑÿ≥ÿ≠ÿßÿ®ÿ©
                </h2>
                <p style="font-size: 1.1rem; color: var(--theme-text-secondary); margin: 0;">
                  ŸÇŸÖ ÿ®ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ŸÜÿ≥ÿÆŸÉ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿ©
                </p>
              </div>

              <div style="max-width: 500px; margin: 0 auto;">
                
                <!-- ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ -->
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                  <button class="btn" style="flex: 1; padding: 1rem; background: linear-gradient(135deg, #3b82f6, #2563eb);" onclick="showCloudRegisterForm()">
                    <i class="fas fa-user-plus"></i> ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ
                  </button>
                  <button class="btn btn-secondary" style="flex: 1; padding: 1rem;" onclick="showCloudLoginForm()">
                    <i class="fas fa-sign-in-alt"></i> ŸÑÿØŸä ÿ≠ÿ≥ÿßÿ®
                  </button>
                </div>

                <!-- ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ¨ÿØŸäÿØ -->
                <div id="cloudRegisterFormPanel" style="display: none;">
                  <h3 style="margin-bottom: 1.5rem; color: var(--theme-text-primary);">
                    <i class="fas fa-user-plus"></i> ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ
                  </h3>
                  
                  <div style="background: rgba(59, 130, 246, 0.1); border-right: 4px solid #3b82f6; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <p style="color: var(--theme-text-secondary); line-height: 1.6; margin: 0;">
                      ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑÿå ÿ≥ÿ™ÿ™ŸÑŸÇŸâ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ŸÖŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿπÿ®ÿ± ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ® ÿÆŸÑÿßŸÑ 24 ÿ≥ÿßÿπÿ©.
                    </p>
                  </div>

                  <form id="cloudRegisterForm" onsubmit="handleCloudRegisterSubmit(event); return false;">
                    <div class="form-group">
                      <label class="form-label">ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ</label>
                      <input type="text" class="form-input" id="cloudRegFullName" required>
                    </div>

                    <div class="form-group">
                      <label class="form-label">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ (11 ÿ±ŸÇŸÖ)</label>
                      <input type="tel" class="form-input" id="cloudRegPhone" pattern="[0-9]{11}" required placeholder="07XXXXXXXXX">
                    </div>

                    <div style="display: flex; gap: 1rem;">
                      <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-paper-plane"></i> ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®
                      </button>
                      <button type="button" class="btn btn-secondary" onclick="hideCloudRegisterForm()">
                        <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                      </button>
                    </div>
                  </form>
                </div>

                <!-- ŸÜŸÖŸàÿ∞ÿ¨ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ -->
                <div id="cloudLoginFormPanel" style="display: none;">
                  <h3 style="margin-bottom: 1.5rem; color: var(--theme-text-primary);">
                    <i class="fas fa-sign-in-alt"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                  </h3>

                  <div style="background: rgba(251, 191, 36, 0.1); border-right: 4px solid #fbbf24; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <p style="color: var(--theme-text-secondary); line-height: 1.6; margin: 0;">
                      ÿ£ÿØÿÆŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ≠ÿ≥ÿßÿ®ŸÉ ÿßŸÑÿ∞Ÿä ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑŸá ŸÖŸÜ ŸÇÿ®ŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ©.
                    </p>
                  </div>

                  <form id="cloudLoginFormSubmit" onsubmit="handleCloudLoginSubmit(event); return false;">
                    <div class="form-group">
                      <label class="form-label">ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ</label>
                      <input type="text" class="form-input" id="cloudLoginFullName" required>
                    </div>

                    <div class="form-group">
                      <label class="form-label">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ (11 ÿ±ŸÇŸÖ)</label>
                      <input type="tel" class="form-input" id="cloudLoginPhone" pattern="[0-9]{11}" required placeholder="07XXXXXXXXX">
                    </div>

                    <div class="form-group">
                      <label class="form-label">ÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ (6 ÿ£ÿ±ŸÇÿßŸÖ)</label>
                      <input type="text" class="form-input" id="cloudLoginActivationCode" pattern="[0-9]{6}" required placeholder="XXXXXX">
                    </div>

                    <div style="display: flex; gap: 1rem;">
                      <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-sign-in-alt"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                      </button>
                      <button type="button" class="btn btn-secondary" onclick="hideCloudLoginForm()">
                        <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                      </button>
                    </div>
                  </form>
                </div>

              </div>
            </div>

            <!-- ÿ≠ÿßŸÑÿ©: ŸÖÿ≥ÿ¨ŸÑ ŸàŸÖŸÅÿπŸëŸÑ -->
            <div id="cloudLoggedInPanel" style="display: none;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <div style="background: linear-gradient(135deg, #10b981, #059669); width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; box-shadow: 0 8px 32px rgba(16, 185, 129, 0.4);">
                  <i class="fas fa-user-check" style="font-size: 4rem; color: white;"></i>
                </div>
                <h2 id="cloudUserDisplayName" style="font-size: 2rem; font-weight: 700; color: var(--theme-text-primary); margin: 0 0 0.5rem 0;">
                  ŸÖÿ±ÿ≠ÿ®ÿßŸã
                </h2>
                <p style="font-size: 1.1rem; color: #10b981; margin: 0;">
                  <i class="fas fa-check-circle"></i> ÿ≠ÿ≥ÿßÿ®ŸÉ ŸÖŸèŸÅÿπŸëŸÑ ŸàŸÖÿ™ÿµŸÑ ÿ®ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
                </p>
              </div>

              <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ® -->
              <div style="max-width: 600px; margin: 0 auto;">
                <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(255,255,255,0.05);">
                  
                  <div style="display: grid; gap: 1rem;">
                    <div style="display: flex; justify-content: space-between; padding: 1rem; background: var(--theme-bg-secondary); border-radius: 8px;">
                      <span style="color: var(--theme-text-secondary);">
                        <i class="fas fa-user"></i> ÿßŸÑÿßÿ≥ŸÖ:
                      </span>
                      <strong id="cloudUserName" style="color: var(--theme-text-primary);">---</strong>
                    </div>

                    <div style="display: flex; justify-content: space-between; padding: 1rem; background: var(--theme-bg-secondary); border-radius: 8px;">
                      <span style="color: var(--theme-text-secondary);">
                        <i class="fas fa-phone"></i> ÿßŸÑŸáÿßÿ™ŸÅ:
                      </span>
                      <strong id="cloudUserPhone" style="color: var(--theme-text-primary); direction: ltr;">---</strong>
                    </div>

                    <div style="display: flex; justify-content: space-between; padding: 1rem; background: var(--theme-bg-secondary); border-radius: 8px;">
                      <span style="color: var(--theme-text-secondary);">
                        <i class="fas fa-fingerprint"></i> ÿßŸÑŸÖÿπÿ±ŸëŸÅ:
                      </span>
                      <strong id="cloudUserUID" style="color: var(--theme-text-secondary); font-size: 0.85rem; font-family: monospace;">---</strong>
                    </div>

                    <div style="display: flex; justify-content: space-between; padding: 1rem; background: var(--theme-bg-secondary); border-radius: 8px;">
                      <span style="color: var(--theme-text-secondary);">
                        <i class="fas fa-calendar"></i> ŸÖÿ≥ÿ¨ŸÑ ŸÖŸÜÿ∞:
                      </span>
                      <strong id="cloudUserRegisteredAt" style="color: var(--theme-text-primary);">---</strong>
                    </div>
                  </div>

                </div>

                <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ -->
                <div style="display: grid; gap: 1rem;">
                  <button class="btn btn-warning" onclick="handleCloudLogout()">
                    <i class="fas fa-sign-out-alt"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
                  </button>
                  
                  <button class="btn btn-secondary" onclick="switchCloudTab('backup')">
                    <i class="fas fa-cloud-upload-alt"></i> ÿßŸÜÿ™ŸÇŸÑ ÿ•ŸÑŸâ ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
                  </button>
                </div>
              </div>
            </div>

            <!-- ÿ≠ÿßŸÑÿ©: ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÅÿπŸäŸÑ -->
            <div id="cloudWaitingActivation" style="display: none;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <div style="background: linear-gradient(135deg, #f59e0b, #d97706); width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; box-shadow: 0 8px 32px rgba(245, 158, 11, 0.4); animation: pulse 2s infinite;">
                  <i class="fas fa-clock" style="font-size: 4rem; color: white;"></i>
                </div>
                <h2 style="font-size: 2rem; font-weight: 700; color: var(--theme-text-primary); margin: 0 0 0.5rem 0;">
                  ‚è≥ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÅÿπŸäŸÑ
                </h2>
                <p style="font-size: 1.1rem; color: var(--theme-text-secondary); margin: 0;">
                  ÿ∑ŸÑÿ®ŸÉ ŸÇŸäÿØ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ŸÖŸÜ ŸÇÿ®ŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ©
                </p>
              </div>

              <div style="max-width: 500px; margin: 0 auto;">
                
                <div style="background: rgba(245, 158, 11, 0.1); border-right: 4px solid #f59e0b; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                  <h4 style="color: #f59e0b; margin-bottom: 0.75rem;">
                    <i class="fas fa-info-circle"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÖŸáŸÖÿ©
                  </h4>
                  <ul style="color: var(--theme-text-secondary); line-height: 1.8; margin: 0; padding-right: 1.5rem;">
                    <li>ÿ≥ÿ™ÿ™ŸÑŸÇŸâ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ŸÖŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿπÿ®ÿ± ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®</li>
                    <li>ÿπÿßÿØÿ©Ÿã Ÿäÿ™ŸÖ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿÆŸÑÿßŸÑ 24 ÿ≥ÿßÿπÿ©</li>
                    <li>ŸäŸÖŸÉŸÜŸÉ ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ ŸÖŸÜ ÿßŸÑÿ≤ÿ± ÿ£ÿØŸÜÿßŸá</li>
                  </ul>
                </div>

                <div style="display: grid; gap: 1rem;">
                  <button class="btn btn-primary" onclick="checkCloudActivationStatus()">
                    <i class="fas fa-sync-alt"></i> ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ
                  </button>
                  
                  <button class="btn btn-secondary" onclick="cancelCloudRegistration()">
                    <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ∑ŸÑÿ®
                  </button>
                </div>

              </div>
            </div>

          </div>

          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- ÿ™ÿ®ŸàŸäÿ®ÿ© ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <div id="cloudTab-backup" class="cloud-tab-panel">
            
            <!-- ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ -->
            <div id="cloudBackupLoginRequired" style="display: none;">
              <div style="text-align: center; padding: 3rem;">
                <div style="background: rgba(239, 68, 68, 0.1); width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                  <i class="fas fa-lock" style="font-size: 3rem; color: #ef4444;"></i>
                </div>
                <h3 style="font-size: 1.5rem; color: var(--theme-text-primary); margin-bottom: 1rem;">
                  Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã
                </h3>
                <p style="color: var(--theme-text-secondary); margin-bottom: 2rem;">
                  ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ŸÖŸäÿ≤ÿ© ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©ÿå Ÿäÿ¨ÿ® ÿπŸÑŸäŸÉ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                </p>
                <button class="btn btn-primary" onclick="switchCloudTab('login')">
                  <i class="fas fa-sign-in-alt"></i> ÿßŸÑÿ∞Ÿáÿßÿ® ÿ•ŸÑŸâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                </button>
              </div>
            </div>

            <!-- Ÿàÿßÿ¨Ÿáÿ© ÿ±ŸÅÿπ ÿßŸÑŸÜÿ≥ÿÆ -->
            <div id="cloudBackupPanel" style="display: none;">
              
              <h3 style="font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--theme-text-primary);">
                <i class="fas fa-cloud-upload-alt"></i> ÿ±ŸÅÿπ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
              </h3>

              <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© -->
              <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid rgba(255,255,255,0.05);">
                <div style="display: grid; gap: 1rem;">
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--theme-text-secondary);">
                      <i class="fas fa-clock"></i> ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©:
                    </span>
                    <strong id="cloudBackupLastDate" style="color: var(--theme-text-primary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--theme-text-secondary);">
                      <i class="fas fa-database"></i> ÿ≠ÿ¨ŸÖ ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ©:
                    </span>
                    <strong id="cloudBackupLastSize" style="color: var(--theme-text-primary);">0 KB</strong>
                  </div>
                </div>
              </div>

              <!-- ŸÜÿµŸäÿ≠ÿ© -->
              <div style="background: rgba(59, 130, 246, 0.1); border-right: 4px solid #3b82f6; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                <h4 style="color: #3b82f6; margin-bottom: 0.5rem;">
                  <i class="fas fa-lightbulb"></i> ŸÜÿµŸäÿ≠ÿ©
                </h4>
                <p style="color: var(--theme-text-secondary); line-height: 1.6; margin: 0;">
                  ŸÇŸÖ ÿ®ÿ±ŸÅÿπ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ÿ¥ŸÉŸÑ ÿØŸàÿ±Ÿä ŸÑŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿ¢ŸÖŸÜÿ© ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©. ŸäŸÖŸÉŸÜŸÉ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÖŸÜ ÿ™ÿ®ŸàŸäÿ®ÿ© "ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™".
                </p>
              </div>

              <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ±ŸÅÿπ -->
              <div style="display: grid; gap: 1rem;">
                <button class="btn btn-success" style="padding: 1.5rem; font-size: 1.1rem;" onclick="uploadBackupToFirebase(false)">
                  <i class="fas fa-cloud-upload-alt"></i> ÿ±ŸÅÿπ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿßŸÑÿ¢ŸÜ
                </button>

                <button class="btn btn-secondary" onclick="refreshCloudBackupInfo()">
                  <i class="fas fa-sync-alt"></i> ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™
                </button>
              </div>

            </div>

          </div>

          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- ÿ™ÿ®ŸàŸäÿ®ÿ© ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÜÿ≥ÿÆ -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <div id="cloudTab-restore" class="cloud-tab-panel">
            
            <!-- ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ -->
            <div id="cloudRestoreLoginRequired" style="display: none;">
              <div style="text-align: center; padding: 3rem;">
                <div style="background: rgba(239, 68, 68, 0.1); width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                  <i class="fas fa-lock" style="font-size: 3rem; color: #ef4444;"></i>
                </div>
                <h3 style="font-size: 1.5rem; color: var(--theme-text-primary); margin-bottom: 1rem;">
                  Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã
                </h3>
                <p style="color: var(--theme-text-secondary); margin-bottom: 2rem;">
                  ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ŸÖŸäÿ≤ÿ© ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©ÿå Ÿäÿ¨ÿ® ÿπŸÑŸäŸÉ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                </p>
                <button class="btn btn-primary" onclick="switchCloudTab('login')">
                  <i class="fas fa-sign-in-alt"></i> ÿßŸÑÿ∞Ÿáÿßÿ® ÿ•ŸÑŸâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                </button>
              </div>
            </div>

            <!-- Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ -->
            <div id="cloudRestorePanel" style="display: none;">
              
              <h3 style="font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--theme-text-primary);">
                <i class="fas fa-cloud-download-alt"></i> ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
              </h3>

              <!-- ÿ™ÿ≠ÿ∞Ÿäÿ± -->
              <div style="background: rgba(239, 68, 68, 0.1); border-right: 4px solid #ef4444; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                <h4 style="color: #ef4444; margin-bottom: 0.5rem;">
                  <i class="fas fa-exclamation-triangle"></i> ÿ™ÿ≠ÿ∞Ÿäÿ± ŸÖŸáŸÖ
                </h4>
                <p style="color: var(--theme-text-secondary); line-height: 1.6; margin: 0;">
                  ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ≥Ÿäÿ§ÿØŸä ÿ•ŸÑŸâ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ <strong>ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©</strong>. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÇÿ®ŸÑ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ.
                </p>
              </div>

              <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ -->
              <div style="display: grid; gap: 1rem;">
                <button class="btn btn-primary" style="padding: 1.5rem; font-size: 1.1rem;" onclick="downloadBackupFromFirebase()">
                  <i class="fas fa-cloud-download-alt"></i> ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
                </button>

                <button class="btn btn-secondary" onclick="showCloudBackupHistory()">
                  <i class="fas fa-history"></i> ÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
                </button>
              </div>

            </div>

          </div>

          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- ÿ™ÿ®ŸàŸäÿ®ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <div id="cloudTab-settings" class="cloud-tab-panel">
            
            <h3 style="font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--theme-text-primary);">
              <i class="fas fa-cog"></i> ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä
            </h3>

            <!-- ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä -->
            <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(255,255,255,0.05);">
              
              <h4 style="font-size: 1.25rem; margin-bottom: 1.5rem; color: var(--theme-text-primary);">
                <i class="fas fa-robot"></i> ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
              </h4>

              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" id="cloudAutoBackupEnabled" style="width: auto;" checked>
                  <span style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-cloud" style="color: #3b82f6;"></i>
                    <strong>ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</strong>
                  </span>
                </label>
                <p style="color: var(--theme-text-secondary); font-size: 0.85rem; margin: 0.5rem 0 0 2rem; line-height: 1.5;">
                  Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ŸÅŸä ŸÉŸÑ ŸÖÿ±ÿ© ÿ™ŸÅÿ™ÿ≠ ŸÅŸäŸáÿß ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ (ŸÖÿπ ÿ≠ÿØ ÿ£ÿØŸÜŸâ 6 ÿ≥ÿßÿπÿßÿ™ ÿ®ŸäŸÜ ÿßŸÑŸÜÿ≥ÿÆ)
                </p>
              </div>

              <div class="form-group">
                <label class="form-label">ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä</label>
                <select class="form-select" id="cloudAutoBackupFrequency">
                  <option value="startup">ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ (ŸÖÿπ ÿ≠ÿØ ÿ£ÿØŸÜŸâ 6 ÿ≥ÿßÿπÿßÿ™)</option>
                  <option value="hourly">ŸÉŸÑ ÿ≥ÿßÿπÿ©</option>
                  <option value="daily">ŸäŸàŸÖŸäÿßŸã</option>
                  <option value="weekly">ÿ£ÿ≥ÿ®ŸàÿπŸäÿßŸã</option>
                </select>
              </div>

              <button class="btn btn-primary" onclick="saveCloudSettings()">
                <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
              </button>

            </div>

            <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ Firebase -->
            <div style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 2rem; border: 1px solid rgba(255,255,255,0.05);">
              
              <h4 style="font-size: 1.25rem; margin-bottom: 1.5rem; color: var(--theme-text-primary);">
                <i class="fas fa-info-circle"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
              </h4>

              <div style="display: grid; gap: 1rem;">
                <div style="display: flex; justify-content: space-between; padding: 1rem; background: var(--theme-bg-secondary); border-radius: 8px;">
                  <span style="color: var(--theme-text-secondary);">
                    <i class="fas fa-database"></i> ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:
                  </span>
                  <strong id="firebaseDbName" style="color: var(--theme-text-primary); font-size: 0.85rem;">Firebase Realtime Database</strong>
                </div>

                <div style="display: flex; justify-content: space-between; padding: 1rem; background: var(--theme-bg-secondary); border-radius: 8px;">
                  <span style="color: var(--theme-text-secondary);">
                    <i class="fas fa-link"></i> ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ:
                  </span>
                  <strong id="firebaseConnectionStatus" style="color: #10b981;">
                    <i class="fas fa-check-circle"></i> ŸÖÿ™ÿµŸÑ
                  </strong>
                </div>
              </div>

            </div>

          </div>

          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <!-- ÿ™ÿ®ŸàŸäÿ®ÿ© ÿßŸÑÿ≥ÿ¨ŸÑ -->
          <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
          <div id="cloudTab-history" class="cloud-tab-panel">
            
            <h3 style="font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--theme-text-primary);">
              <i class="fas fa-history"></i> ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿ©
            </h3>

            <div style="margin-bottom: 1.5rem;">
              <button class="btn btn-secondary" onclick="loadCloudBackupHistory()">
                <i class="fas fa-sync-alt"></i> ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≥ÿ¨ŸÑ
              </button>
            </div>

            <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑÿ≥ÿ¨ŸÑ -->
            <div id="cloudBackupHistoryList" style="background: var(--theme-bg-tertiary); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.05);">
              <p style="text-align: center; color: var(--theme-text-secondary); padding: 2rem;">
                <i class="fas fa-info-circle"></i> ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ≥ÿ≠ÿßÿ®Ÿäÿ© ÿ®ÿπÿØ
              </p>
            </div>

          </div>

        </div>

        </div>
      </div>

      </div>

     </div>

    </div>
   </main>
  </div><!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ -->
  <div id="addProductModal" class="modal">
   <div class="modal-content">
    <div class="modal-header">
     <h3 class="modal-title"><i class="fas fa-plus-circle"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ</h3><button class="close-btn" onclick="closeModal('addProductModal')"> <i class="fas fa-times"></i> </button>
    </div>
    <form id="addProductForm">
     <div class="form-grid">
      <div class="form-group"><label class="form-label"> <i class="fas fa-tag"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ </label> <input type="text" class="form-input" id="productName" required>
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-barcode"></i> ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ </label>
       <div class="barcode-section"><input type="text" class="form-input barcode-input" id="productBarcode"> <button type="button" class="generate-barcode-btn" onclick="generateBarcode()"> <i class="fas fa-magic"></i> ÿ™ŸàŸÑŸäÿØ </button>
       </div>
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-layer-group"></i> ÿßŸÑÿ™ÿµŸÜŸäŸÅ </label> <select class="form-select" id="productCategory" required> <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅ</option> </select>
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-truck"></i> ÿßŸÑŸÖŸàÿ±ÿØ </label> <input type="text" class="form-input" id="productSupplier">
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-coins"></i> ÿ≥ÿπÿ± ÿßŸÑÿ™ŸÉŸÑŸÅÿ© (ŸÖŸÅÿ±ÿØ) </label> <input type="number" class="form-input" id="productCostRetail" required>
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-coins"></i> ÿ≥ÿπÿ± ÿßŸÑÿ™ŸÉŸÑŸÅÿ© (ÿ¨ŸÖŸÑÿ©) </label> <input type="number" class="form-input" id="productCostWholesale">
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-money-bill"></i> ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ (ŸÖŸÅÿ±ÿØ) </label> <input type="number" class="form-input" id="productPriceRetail" required>
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-money-bill"></i> ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ (ÿ¨ŸÖŸÑÿ©) </label> <input type="number" class="form-input" id="productPriceWholesale">
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-warehouse"></i> ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© </label> <input type="number" class="form-input" id="productStock" required>
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-exclamation-triangle"></i> ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑŸÑŸÖÿÆÿ≤ŸàŸÜ </label> <input type="number" class="form-input" id="productMinStock" value="10">
      </div>
     </div>
     <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="closeModal('addProductModal')"> <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ° </button> <button type="submit" class="btn btn-primary"> <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÜÿ™ÿ¨ </button>
     </div>
    </form>
   </div>
  </div><!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿπÿØŸäŸÑ ŸÖŸÜÿ™ÿ¨ -->
  <div id="editProductModal" class="modal">
   <div class="modal-content">
    <div class="modal-header">
     <h3 class="modal-title"><i class="fas fa-edit"></i> ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨</h3><button class="close-btn" onclick="closeModal('editProductModal')"> <i class="fas fa-times"></i> </button>
    </div>
    <form id="editProductForm" onsubmit="handleEditProduct(event)">
     <input type="hidden" id="editProductId">
     <div class="form-grid">
      <div class="form-group"><label class="form-label"> <i class="fas fa-tag"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ </label> <input type="text" class="form-input" id="editProductName" required>
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-barcode"></i> ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ </label> <input type="text" class="form-input" id="editProductBarcode">
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-layer-group"></i> ÿßŸÑÿ™ÿµŸÜŸäŸÅ </label> <select class="form-select" id="editProductCategory" required> <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅ</option> </select>
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-truck"></i> ÿßŸÑŸÖŸàÿ±ÿØ </label> <input type="text" class="form-input" id="editProductSupplier">
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-coins"></i> ÿ≥ÿπÿ± ÿßŸÑÿ™ŸÉŸÑŸÅÿ© (ŸÖŸÅÿ±ÿØ) </label> <input type="number" class="form-input" id="editProductCostRetail" required>
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-coins"></i> ÿ≥ÿπÿ± ÿßŸÑÿ™ŸÉŸÑŸÅÿ© (ÿ¨ŸÖŸÑÿ©) </label> <input type="number" class="form-input" id="editProductCostWholesale">
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-money-bill"></i> ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ (ŸÖŸÅÿ±ÿØ) </label> <input type="number" class="form-input" id="editProductPriceRetail" required>
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-money-bill"></i> ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ (ÿ¨ŸÖŸÑÿ©) </label> <input type="number" class="form-input" id="editProductPriceWholesale">
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-warehouse"></i> ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© </label> <input type="number" class="form-input" id="editProductStock" required>
      </div>
      <div class="form-group"><label class="form-label"> <i class="fas fa-exclamation-triangle"></i> ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑŸÑŸÖÿÆÿ≤ŸàŸÜ </label> <input type="number" class="form-input" id="editProductMinStock">
      </div>
     </div>
     <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="closeModal('editProductModal')"> <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ° </button> <button type="submit" class="btn btn-success"> <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ </button>
     </div>
    </form>
   </div>
  </div><!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿµŸÜŸäŸÅ -->
  <div id="addCategoryModal" class="modal">
   <div class="modal-content">
    <div class="modal-header">
     <h3 class="modal-title"><i class="fas fa-plus-circle"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿµŸÜŸäŸÅ ÿ¨ÿØŸäÿØ</h3><button class="close-btn" onclick="closeModal('addCategoryModal')"> <i class="fas fa-times"></i> </button>
    </div>
    <form id="addCategoryForm">
     <div class="form-group"><label class="form-label"> <i class="fas fa-tag"></i> ÿßÿ≥ŸÖ ÿßŸÑÿ™ÿµŸÜŸäŸÅ </label> <input type="text" class="form-input" id="categoryName" required>
     </div>
     <div class="form-group"><label class="form-label"> <i class="fas fa-icons"></i> ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ£ŸäŸÇŸàŸÜÿ© </label>
      <div class="category-icon-grid" id="categoryIconGrid"><!-- ÿßŸÑÿ£ŸäŸÇŸàŸÜÿßÿ™ ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
      </div><input type="hidden" id="selectedCategoryIcon" value="fas fa-box">
     </div>
     <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="closeModal('addCategoryModal')"> <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ° </button> <button type="submit" class="btn btn-primary"> <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿµŸÜŸäŸÅ </button>
     </div>
    </form>
   </div>
  </div><!-- ŸÜÿßŸÅÿ∞ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ -->
  <div id="paymentModal" class="modal">
   <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
    <div class="modal-header">
     <h3 class="modal-title"><i class="fas fa-credit-card"></i> ÿßÿÆÿ™Ÿäÿßÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ</h3>
     <button class="close-btn" onclick="closeModal('paymentModal')">
         <i class="fas fa-times"></i>
     </button>
    </div>
    
    <!-- ÿÆŸäÿßÿ±ÿßÿ™ ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ -->
    <div class="payment-options-container">
        <button class="payment-option-card cash-payment" onclick="processCashPayment()">
            <div class="payment-option-icon">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="payment-option-title">ÿØŸÅÿπ ŸÜŸÇÿØŸä</div>
            <div class="payment-option-description">ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ®Ÿäÿπ ŸÅŸàÿ±ÿßŸã ÿ®ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÜŸÇÿØŸä</div>
        </button>
        
        <button class="payment-option-card installment-payment" onclick="showInstallmentForm()">
            <div class="payment-option-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="payment-option-title">ÿØŸÅÿπ ÿ®ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</div>
            <div class="payment-option-description">ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿπŸÑŸâ ÿπÿØÿ© ÿ£ÿ¥Ÿáÿ±</div>
        </button>
    </div>
    
    <!-- ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ -->
    <div id="installmentForm" class="installment-form">
        <div class="installment-header">
            <i class="fas fa-user-edit"></i>
            <h4>ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ ŸàÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</h4>
        </div>
        
        <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ -->
        <div class="form-section">
            <div class="section-title">
                <i class="fas fa-user-circle"></i>
                <span>ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ</span>
            </div>
            
            <!-- ÿÆŸäÿßÿ± ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿπŸÖŸäŸÑ ŸÖÿØŸäŸÜ -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-search"></i>
                    ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿπŸÖŸäŸÑ ŸÖÿØŸäŸÜ ŸÖŸàÿ¨ŸàÿØ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
                </label>
                <div class="search-customer-wrapper">
                    <input type="text" 
                           class="form-input" 
                           id="searchExistingCustomer" 
                           placeholder="ÿßÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖ ÿ£Ÿà ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ..."
                           oninput="searchDebtCustomers(this.value)">
                    <div id="customerSearchResults" class="customer-search-results"></div>
                </div>
                <small class="form-hint">
                    <i class="fas fa-info-circle"></i>
                    ÿßÿÆÿ™ÿ± ÿπŸÖŸäŸÑ ŸÖŸàÿ¨ŸàÿØ ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿØŸäŸÜ ÿ•ŸÑŸâ ÿ≠ÿ≥ÿßÿ®Ÿáÿå ÿ£Ÿà ÿ£ÿØÿÆŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÖŸäŸÑ ÿ¨ÿØŸäÿØ
                </small>
            </div>
            
            <div class="form-grid-2">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-user"></i>
                        ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ
                        <span class="required">*</span>
                    </label>
                    <input type="text" class="form-input" id="customerName" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ" required>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-phone"></i>
                        ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ
                        <span class="required">*</span>
                    </label>
                    <input type="text" class="form-input" id="customerPhone" placeholder="07XX XXX XXXX" required>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-map-marker-alt"></i>
                    ÿßŸÑÿπŸÜŸàÿßŸÜ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
                </label>
                <input type="text" class="form-input" id="customerAddress" placeholder="ÿ£ÿØÿÆŸÑ ÿπŸÜŸàÿßŸÜ ÿßŸÑÿπŸÖŸäŸÑ">
            </div>
        </div>
        
        <!-- ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ -->
        <div class="form-section">
            <div class="section-title">
                <i class="fas fa-calculator"></i>
                <span>ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</span>
            </div>
            
            <!-- ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ© -->
            <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05)); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-right: 4px solid var(--primary-color);">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <i class="fas fa-sliders-h" style="color: var(--primary-color);"></i>
                    <span style="font-weight: 600; color: var(--theme-text-primary); font-size: 0.95rem;">Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ</span>
                </div>
                <div class="form-group" style="margin: 0;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; user-select: none;">
                        <input type="checkbox" id="advancedEditMode" onchange="toggleAdvancedEditMode()" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 0.9rem; color: var(--theme-text-secondary);">
                            ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ± ÿπŸÑŸâ ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ (ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸäÿå ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿå ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä)
                        </span>
                    </label>
                    <small class="form-hint" style="margin-top: 0.5rem; margin-right: 1.75rem;">
                        <i class="fas fa-info-circle"></i>
                        ÿ™ŸÅÿπŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑÿÆŸäÿßÿ± Ÿäÿ™Ÿäÿ≠ ŸÑŸÉ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÉÿßŸÖŸÑ ŸÅŸä ŸÇŸäŸÖ ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ŸàÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
                    </small>
                </div>
            </div>
            
            <div class="form-grid-3">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-calendar"></i>
                        ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ±
                    </label>
                    <input type="number" class="form-input" id="installmentMonths" min="1" max="60" value="12" onchange="calculateInstallment()">
                    <small class="form-hint">ŸÖŸÜ 1 ÿ•ŸÑŸâ 60 ÿ¥Ÿáÿ±</small>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-money-bill-wave"></i>
                        ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ∂ÿßŸÅŸä
                    </label>
                    <input type="number" class="form-input" id="additionalAmount" value="0" min="0" step="1000" placeholder="0" onchange="calculateInstallment()">
                    <small class="form-hint">ÿßŸÑÿ≤ŸäÿßÿØÿ© ÿπŸÑŸâ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä</small>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-hand-holding-usd"></i>
                        ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©
                    </label>
                    <input type="number" class="form-input" id="downPayment" value="0" min="0" step="1000" placeholder="0" onchange="calculateInstallment()">
                    <small class="form-hint">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ ŸÖŸÇÿØŸÖÿßŸã</small>
                </div>
            </div>
            
            <!-- ÿ™ÿßÿ±ŸäÿÆ ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-calendar-alt"></i>
                    ÿ™ÿßÿ±ŸäÿÆ ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
                </label>
                <input type="date" class="form-input" id="installmentStartDate">
                <small class="form-hint">ÿ≠ÿØÿØ ÿ™ÿßÿ±ŸäÿÆ ÿ®ÿØÿßŸäÿ© ÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</small>
            </div>
            
            <!-- ÿ≠ŸÇŸàŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ (ŸÖÿÆŸÅŸäÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂ŸäÿßŸã) -->
            <div id="advancedEditFields" style="display: none; margin-top: 1rem;">
                <div style="background: rgba(255, 193, 7, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-right: 4px solid var(--warning-color);">
                    <div style="display: flex; gap: 0.5rem; align-items: start;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--warning-color); margin-top: 0.2rem;"></i>
                        <div style="flex: 1;">
                            <p style="margin: 0; font-size: 0.85rem; color: var(--theme-text-primary); line-height: 1.4;">
                                <strong>Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ ŸÖŸÅÿπŸëŸÑ:</strong> ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ŸÖÿ®ÿßÿ¥ÿ±ÿ©. 
                                ÿ£Ÿä ÿ™ÿ∫ŸäŸäÿ± ÿ≥ÿ™ŸÇŸàŸÖ ÿ®Ÿá ÿ≥Ÿäÿ§ÿ´ÿ± ÿπŸÑŸâ ÿ®ÿßŸÇŸä ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="form-grid-3">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-shopping-cart"></i>
                            ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä
                        </label>
                        <input type="number" class="form-input" id="customOriginalAmount" placeholder="ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä" step="1000" min="0" oninput="recalculateFromOriginal()">
                        <small class="form-hint">
                            <i class="fas fa-sync-alt"></i> ÿ≥Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ŸàÿßŸÑŸÇÿ≥ÿ∑
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-wallet"></i>
                            ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
                        </label>
                        <input type="number" class="form-input" id="customTotalAmount" placeholder="ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä" step="1000" min="0" oninput="recalculateFromTotal()">
                        <small class="form-hint">
                            <i class="fas fa-sync-alt"></i> ÿ≥Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-calendar-check"></i>
                            ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä
                        </label>
                        <input type="number" class="form-input" id="customMonthlyAmount" placeholder="ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä" step="100" min="0" oninput="recalculateFromMonthly()">
                        <small class="form-hint">
                            <i class="fas fa-sync-alt"></i> ÿ≥Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ŸÖŸÑÿÆÿµ ÿßŸÑÿ≠ÿ≥ÿßÿ® -->
        <div class="installment-summary">
            <div class="summary-title">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>ŸÖŸÑÿÆÿµ ÿßŸÑÿ≠ÿ≥ÿßÿ®</span>
            </div>
            <div class="summary-items">
                <div class="summary-row">
                    <span class="summary-label">
                        <i class="fas fa-shopping-cart"></i>
                        ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä
                    </span>
                    <span class="summary-value" id="originalAmount">0 ÿØŸäŸÜÿßÿ±</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">
                        <i class="fas fa-plus-circle"></i>
                        ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ∂ÿßŸÅŸä
                    </span>
                    <span class="summary-value text-warning" id="addedProfit">0 ÿØŸäŸÜÿßÿ±</span>
                </div>
                <div class="summary-row" id="downPaymentRow" style="display: none;">
                    <span class="summary-label">
                        <i class="fas fa-hand-holding-usd"></i>
                        ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©
                    </span>
                    <span class="summary-value text-success" id="downPaymentDisplay">0 ÿØŸäŸÜÿßÿ±</span>
                </div>
                <div class="summary-divider"></div>
                <div class="summary-row total-row">
                    <span class="summary-label">
                        <i class="fas fa-wallet"></i>
                        ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
                    </span>
                    <span class="summary-value" id="totalInstallmentAmount">0 ÿØŸäŸÜÿßÿ±</span>
                </div>
                <div class="summary-row monthly-row">
                    <span class="summary-label">
                        <i class="fas fa-calendar-check"></i>
                        ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä
                    </span>
                    <span class="summary-value highlight" id="monthlyPayment">0 ÿØŸäŸÜÿßÿ±</span>
                </div>
            </div>
        </div>
        
        <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ -->
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('paymentModal')">
                <i class="fas fa-times"></i>
                ÿ•ŸÑÿ∫ÿßÿ°
            </button>
            <button type="button" class="btn btn-primary" onclick="processInstallmentPayment()">
                <i class="fas fa-check-circle"></i>
                ÿ≠ŸÅÿ∏ Ÿàÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ®Ÿäÿπ
            </button>
        </div>
    </div>
   </div>
  </div><!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ -->
  <div id="productDetailsModal" class="modal">
   <div class="modal-content">
    <div class="modal-header">
     <h3 class="modal-title"><i class="fas fa-info-circle"></i> ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨</h3><button class="close-btn" onclick="closeModal('productDetailsModal')"> <i class="fas fa-times"></i> </button>
    </div>
    <div id="productDetailsContent"><!-- ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
    </div>
   </div>
  </div><!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© -->
  <div id="invoiceDetailsModal" class="modal">
   <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
     <h3 class="modal-title"><i class="fas fa-file-invoice"></i> ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</h3><button class="close-btn" onclick="closeModal('invoiceDetailsModal')"> <i class="fas fa-times"></i> </button>
    </div>
    <div id="invoiceDetailsContent"><!-- ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
    </div>
   </div>
  </div><!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸäŸÜ -->
  <div id="debtDetailsModal" class="modal">
   <div class="modal-content">
    <div class="modal-header">
     <h3 class="modal-title"><i class="fas fa-user-circle"></i> ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿπŸÖŸäŸÑ ŸàÿßŸÑÿØŸäŸÜ</h3><button class="close-btn" onclick="closeModal('debtDetailsModal')"> <i class="fas fa-times"></i> </button>
    </div>
    <div id="debtDetailsContent"><!-- ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸäŸÜ ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
    </div>
   </div>
  </div><!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ≥ÿØŸäÿØ ÿßŸÑÿØŸäŸÜ -->
  <div id="payDebtModal" class="modal">
   <div class="modal-content">
    <div class="modal-header">
     <h3 class="modal-title"><i class="fas fa-money-check-alt"></i> ÿ™ÿ≥ÿØŸäÿØ ÿØŸäŸÜ</h3><button class="close-btn" onclick="closeModal('payDebtModal')"> <i class="fas fa-times"></i> </button>
    </div>
    <form id="payDebtForm">
     <div class="form-group"><label class="form-label">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</label> <input type="text" class="form-input" id="remainingDebtAmount" readonly>
     </div>
     <div class="form-group"><label class="form-label">ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ™ÿ≥ÿØŸäÿØ</label> <input type="number" class="form-input" id="paymentAmount" required>
     </div>
     <div class="form-group"><label class="form-label">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</label> <textarea class="form-input" id="paymentNotes" rows="3"></textarea>
     </div>
     <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="closeModal('payDebtModal')"> <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ° </button> <button type="submit" class="btn btn-success"> <i class="fas fa-check"></i> ÿ™ÿ≥ÿØŸäÿØ </button>
     </div>
    </form>
   </div>
  </div><!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ≥ÿØŸäÿØ ŸÇÿ≥ÿ∑ ÿ¥Ÿáÿ±Ÿä -->
  <div id="payInstallmentModal" class="modal">
   <div class="modal-content">
    <div class="modal-header">
     <h3 class="modal-title"><i class="fas fa-money-check-alt"></i> ÿ™ÿ≥ÿØŸäÿØ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä</h3><button class="close-btn" onclick="closeModal('payInstallmentModal')"> <i class="fas fa-times"></i> </button>
    </div>
    <form id="payInstallmentForm" onsubmit="handlePayInstallment(event)">
     <div class="form-group"><label class="form-label">ÿßŸÑÿ¥Ÿáÿ±</label> <input type="text" class="form-input" id="installmentMonthDisplay" readonly>
     </div>
     <div class="form-group">
      <label class="form-label">ŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÇÿ≥ÿ∑ <span style="color: var(--theme-text-secondary); font-size: 0.85em;">(ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿπÿØŸäŸÑ)</span></label>
      <input type="number" class="form-input" id="installmentAmountInput" placeholder="ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿá ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã" step="1" min="0" required style="font-size: 1.1em; font-weight: 600; color: var(--primary-color);">
     </div>
     <div class="form-group"><label class="form-label">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label> <textarea class="form-input" id="installmentNotes" rows="3" placeholder="ÿ£ÿ∂ŸÅ ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ•ÿ∞ÿß ÿ£ÿ±ÿØÿ™..."></textarea>
     </div>
     <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="closeModal('payInstallmentModal')"> <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ° </button> <button type="submit" class="btn btn-success"> <i class="fas fa-check"></i> ÿ™ÿ≥ÿØŸäÿØ </button>
     </div>
    </form>
   </div>
  </div><!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∞ŸÅ -->
  <div id="confirmDeleteModal" class="modal">
   <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
     <h3 class="modal-title" style="color: var(--danger-color);"><i class="fas fa-exclamation-triangle"></i> ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ≠ÿ∞ŸÅ ÿßŸÑÿØŸäŸÜ</h3><button class="close-btn" onclick="closeModal('confirmDeleteModal')"> <i class="fas fa-times"></i> </button>
    </div>
    <div style="padding: 1rem 0;">
     <div style="background: var(--danger-gradient); opacity: 0.1; padding: 2rem; border-radius: 12px; text-align: center; margin-bottom: 1.5rem;"><i class="fas fa-exclamation-circle" style="font-size: 4rem; color: var(--danger-color);"></i>
     </div>
     <div style="text-align: center; margin-bottom: 1.5rem;">
      <h4 style="font-size: 1.25rem; margin-bottom: 0.5rem; color: var(--theme-text-primary);">ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿØŸäŸÜÿü</h4>
      <p style="color: var(--theme-text-secondary); font-size: 0.95rem;">ÿßŸÑÿπŸÖŸäŸÑ: <strong id="deleteDebtCustomerName" style="color: var(--theme-text-primary);"></strong></p>
     </div>
     <div style="background: var(--theme-bg-secondary); border-right: 4px solid var(--danger-color); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
      <p style="font-weight: 600; margin-bottom: 0.75rem; color: var(--danger-color);"><i class="fas fa-info-circle"></i> ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ:</p>
      <ul style="list-style: none; padding-right: 1.5rem; color: var(--theme-text-secondary); font-size: 0.9rem;">
       <li style="margin-bottom: 0.5rem;"><i class="fas fa-check" style="color: var(--danger-color); margin-left: 0.5rem;"></i> ÿ¨ŸÖŸäÿπ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿØŸäŸÜ</li>
       <li style="margin-bottom: 0.5rem;"><i class="fas fa-check" style="color: var(--danger-color); margin-left: 0.5rem;"></i> ÿ¨ŸÖŸäÿπ ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</li>
       <li style="margin-bottom: 0.5rem;"><i class="fas fa-check" style="color: var(--danger-color); margin-left: 0.5rem;"></i> ÿ¨ŸÖŸäÿπ ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™</li>
      </ul>
      <p style="margin-top: 1rem; font-weight: 600; color: var(--danger-color); font-size: 0.9rem;"><i class="fas fa-exclamation-triangle"></i> Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá!</p>
     </div>
    </div>
    <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="closeModal('confirmDeleteModal')"> <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ° </button> <button type="button" class="btn btn-danger" onclick="executeDeleteDebt()" style="background: var(--danger-gradient);"> <i class="fas fa-trash-alt"></i> ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∞ŸÅ </button>
    </div>
   </div>
  </div>

  <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ŸàÿßŸÑÿ•ÿµŸÑÿßÿ≠ -->
  <div id="systemManagementModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h3 class="modal-title">
          <i class="fas fa-tools"></i> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ŸàÿßŸÑÿ•ÿµŸÑÿßÿ≠
        </h3>
        <button class="close-btn" onclick="closeModal('systemManagementModal')" style="color: white;">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body" style="padding: 2rem;">
        <!-- ÿ≠ÿßŸÑÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
          <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-info-circle"></i> ÿ≠ÿßŸÑÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ
          </h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div style="background: rgba(255, 255, 255, 0.2); padding: 1rem; border-radius: 8px; backdrop-filter: blur(10px);">
              <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.25rem;">ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</div>
              <div id="systemStatusUID" style="font-weight: bold; font-size: 1.1rem;">---</div>
            </div>
            <div style="background: rgba(255, 255, 255, 0.2); padding: 1rem; border-radius: 8px; backdrop-filter: blur(10px);">
              <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.25rem;">ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®</div>
              <div id="systemStatusAccount" style="font-weight: bold; font-size: 1.1rem;">---</div>
            </div>
            <div style="background: rgba(255, 255, 255, 0.2); padding: 1rem; border-radius: 8px; backdrop-filter: blur(10px);">
              <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.25rem;">ÿ•ÿµÿØÿßÿ± ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</div>
              <div id="systemStatusVersion" style="font-weight: bold; font-size: 1.1rem;">---</div>
            </div>
            <div style="background: rgba(255, 255, 255, 0.2); padding: 1rem; border-radius: 8px; backdrop-filter: blur(10px);">
              <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.25rem;">ÿ≠ÿßŸÑÿ© Firebase</div>
              <div id="systemStatusFirebase" style="font-weight: bold; font-size: 1.1rem;">---</div>
            </div>
          </div>
        </div>

        <!-- ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿ•ÿµŸÑÿßÿ≠ -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
          <!-- ŸÅÿ≠ÿµ ÿßŸÑÿ≠ÿ≥ÿßÿ® -->
          <div style="background: var(--theme-bg-secondary); border: 2px solid var(--theme-border); border-radius: 12px; padding: 1.5rem; transition: all 0.3s ease;">
            <h5 style="color: var(--theme-text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-search" style="color: #3b82f6;"></i> ŸÅÿ≠ÿµ ÿßŸÑÿ≠ÿ≥ÿßÿ®
            </h5>
            <p style="color: var(--theme-text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©</p>
            <button onclick="systemCheckAccount()" class="btn btn-primary" style="width: 100%; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
              <i class="fas fa-search"></i> ŸÅÿ≠ÿµ ÿßŸÑÿ¢ŸÜ
            </button>
          </div>

          <!-- ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ -->
          <div style="background: var(--theme-bg-secondary); border: 2px solid var(--theme-border); border-radius: 12px; padding: 1.5rem; transition: all 0.3s ease;">
            <h5 style="color: var(--theme-text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-wrench" style="color: #10b981;"></i> ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
            </h5>
            <p style="color: var(--theme-text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">ÿ≠ŸÑ ŸÖÿ¥ÿßŸÉŸÑ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©</p>
            <button onclick="systemFixRegistration()" class="btn btn-success" style="width: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
              <i class="fas fa-wrench"></i> ÿ•ÿµŸÑÿßÿ≠
            </button>
          </div>

          <!-- ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿÆŸÅŸäŸÅÿ© -->
          <div style="background: var(--theme-bg-secondary); border: 2px solid var(--theme-border); border-radius: 12px; padding: 1.5rem; transition: all 0.3s ease;">
            <h5 style="color: var(--theme-text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-sync" style="color: #6366f1;"></i> ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿÆŸÅŸäŸÅÿ©
            </h5>
            <p style="color: var(--theme-text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿπ ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</p>
            <button onclick="systemSoftReset()" class="btn" style="width: 100%; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white;">
              <i class="fas fa-sync"></i> ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ
            </button>
          </div>

          <!-- ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÉÿßŸÖŸÑÿ© -->
          <div style="background: var(--theme-bg-secondary); border: 2px solid var(--theme-border); border-radius: 12px; padding: 1.5rem; transition: all 0.3s ease;">
            <h5 style="color: var(--theme-text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i> ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÉÿßŸÖŸÑÿ©
            </h5>
            <p style="color: var(--theme-text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</p>
            <button onclick="systemFullReset()" class="btn btn-danger" style="width: 100%; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
              <i class="fas fa-exclamation-triangle"></i> ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÉÿßŸÖŸÑÿ©
            </button>
          </div>

          <!-- ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿßŸÑÿµÿßŸÑÿ≠ÿ© -->
          <div style="background: var(--theme-bg-secondary); border: 2px solid var(--theme-border); border-radius: 12px; padding: 1.5rem; transition: all 0.3s ease;">
            <h5 style="color: var(--theme-text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-trash-alt" style="color: #f59e0b;"></i> ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿßŸÑÿµÿßŸÑÿ≠ÿ©
            </h5>
            <p style="color: var(--theme-text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">ÿ•ÿ≤ÿßŸÑÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑÿ™ÿßŸÑŸÅÿ©</p>
            <button onclick="systemClearInvalidData()" class="btn" style="width: 100%; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
              <i class="fas fa-trash-alt"></i> ŸÖÿ≥ÿ≠
            </button>
          </div>

          <!-- ÿ™ÿµÿØŸäÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© -->
          <div style="background: var(--theme-bg-secondary); border: 2px solid var(--theme-border); border-radius: 12px; padding: 1.5rem; transition: all 0.3s ease;">
            <h5 style="color: var(--theme-text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-download" style="color: #8b5cf6;"></i> ÿ™ÿµÿØŸäÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
            </h5>
            <p style="color: var(--theme-text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">ÿ≠ŸÅÿ∏ ŸÜÿ≥ÿÆÿ© ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©</p>
            <button onclick="systemExportBackup()" class="btn" style="width: 100%; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;">
              <i class="fas fa-download"></i> ÿ™ÿµÿØŸäÿ±
            </button>
          </div>
        </div>

        <!-- ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ -->
        <div style="margin-bottom: 1rem;">
          <h4 style="color: var(--theme-text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-list"></i> ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™
          </h4>
          <div id="systemConsoleLog" style="background: #1f2937; color: #e5e7eb; padding: 1.5rem; border-radius: 8px; max-height: 250px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.9rem; line-height: 1.6;">
            <div style="color: #3b82f6;">‚ÑπÔ∏è ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿπŸÖŸÑŸäÿßÿ™...</div>
          </div>
        </div>

        <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± -->
        <div style="text-align: center; padding: 1rem; border-top: 2px solid var(--theme-border); color: var(--theme-text-secondary); font-size: 0.9rem;">
          <p style="margin-bottom: 0.5rem;">
            <strong style="color: var(--theme-text-primary);">Digital Creativity Company</strong>
          </p>
          <p>ŸÜÿ∏ÿßŸÖ ŸÜŸÇÿßÿ∑ ÿßŸÑÿ®Ÿäÿπ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ - ŸÉÿßÿ¥ ÿ®ÿ±Ÿà</p>
          <p style="margin-top: 0.5rem;">ÿßŸÑŸÖÿ∑Ÿàÿ±: ŸÉÿ±ÿßÿ± | 07813798636</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÜŸÇÿØŸä ÿßŸÑÿ≠ÿØŸäÿ´ÿ© -->
  <div id="cashPaymentModal" class="modal">
   <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
     <h3 class="modal-title" style="color: white;">
      <i class="fas fa-money-bill-wave"></i> ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ®Ÿäÿπ ŸÜŸÇÿØÿßŸã
     </h3>
     <button class="close-btn" onclick="closeCashPaymentModal()" style="color: white;">
      <i class="fas fa-times"></i>
     </button>
    </div>
    
    <div style="padding: 2rem;">
     <!-- ŸÖŸÑÿÆÿµ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ -->
     <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
      <div style="text-align: center; margin-bottom: 1rem;">
       <i class="fas fa-shopping-cart" style="font-size: 2.5rem; color: var(--primary-color);"></i>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
       <span style="color: var(--theme-text-secondary);">
        <i class="fas fa-box"></i> ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™:
       </span>
       <span id="cashModalItemCount" style="font-weight: 600; color: var(--theme-text-primary);">0</span>
      </div>
      <div style="height: 1px; background: rgba(102, 126, 234, 0.2); margin: 1rem 0;"></div>
      <div style="display: flex; justify-content: space-between; align-items: center;">
       <span style="color: var(--theme-text-secondary); font-size: 0.9rem;">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ÿµŸÑŸä:</span>
       <span id="cashModalOriginalTotal" style="font-weight: 600; color: var(--theme-text-primary); font-size: 1.1rem;">0 ÿØŸäŸÜÿßÿ±</span>
      </div>
     </div>
     
     <!-- ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ≥ÿπÿ± ÿßŸÑŸÜŸáÿßÿ¶Ÿä (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä) -->
     <div style="background: var(--theme-bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
      <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
       <i class="fas fa-edit" style="color: var(--warning-color);"></i>
       <h4 style="font-size: 1rem; color: var(--theme-text-primary);">ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ≥ÿπÿ± ÿßŸÑŸÜŸáÿßÿ¶Ÿä (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</h4>
      </div>
      
      <div class="form-group" style="margin-bottom: 1rem;">
       <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
        <i class="fas fa-dollar-sign"></i>
        ÿßŸÑÿ≥ÿπÿ± ÿßŸÑŸÜŸáÿßÿ¶Ÿä ÿ®ÿπÿØ ÿßŸÑÿ™ÿπÿØŸäŸÑ
       </label>
       <div style="position: relative;">
        <input type="number" 
               class="form-input" 
               id="cashModalFinalPrice" 
               placeholder="ÿßÿ™ÿ±ŸÉ ŸÅÿßÿ±ÿ∫ÿßŸã ŸÑŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä"
               step="1000"
               min="0"
               oninput="updateCashPaymentPreview()"
               style="padding-right: 3rem; font-size: 1.2rem; font-weight: 600; border: 2px solid rgba(102, 126, 234, 0.3);">
        <span style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--theme-text-secondary); font-weight: 600;">ÿØŸäŸÜÿßÿ±</span>
       </div>
       <small class="form-hint" style="display: flex; align-items: center; gap: 0.3rem; margin-top: 0.5rem;">
        <i class="fas fa-info-circle"></i>
        ÿßÿ™ÿ±ŸÉ ÿßŸÑÿ≠ŸÇŸÑ ŸÅÿßÿ±ÿ∫ÿßŸã ŸÑŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸäÿå ÿ£Ÿà ÿ£ÿØÿÆŸÑ ŸÖÿ®ŸÑÿ∫ÿßŸã ŸÖÿÆÿ™ŸÑŸÅÿßŸã
       </small>
      </div>
      
      <!-- ÿπÿ±ÿ∂ ÿßŸÑŸÅÿ±ŸÇ -->
      <div id="cashPriceDifferenceDisplay" style="display: none; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
       <div style="display: flex; justify-content: space-between; align-items: center;">
        <span id="cashDifferenceLabel" style="display: flex; align-items: center; gap: 0.5rem;">
         <i class="fas fa-exchange-alt"></i> ÿßŸÑŸÅÿ±ŸÇ:
        </span>
        <span id="cashDifferenceAmount" style="font-weight: 700; font-size: 1.1rem;"></span>
       </div>
      </div>
     </div>
     
     <!-- ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ÿßŸÑÿ∞Ÿä ÿ≥ŸäŸèÿ∑ÿ®ÿπ -->
     <div style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(56, 142, 60, 0.1)); padding: 1.5rem; border-radius: 12px; border: 2px solid rgba(76, 175, 80, 0.3); margin-bottom: 1.5rem;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
       <span style="color: var(--theme-text-secondary); display: flex; align-items: center; gap: 0.5rem;">
        <i class="fas fa-print"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ∞Ÿä ÿ≥ŸäŸèÿ∑ÿ®ÿπ:
       </span>
       <span id="cashModalFinalAmount" style="font-weight: 700; font-size: 1.5rem; color: var(--success-color);">0 ÿØŸäŸÜÿßÿ±</span>
      </div>
     </div>
     
     <!-- ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ™Ÿàÿ∂Ÿäÿ≠Ÿäÿ© -->
     <div style="background: rgba(255, 193, 7, 0.1); padding: 1rem; border-radius: 8px; border-right: 4px solid var(--warning-color); margin-bottom: 1.5rem;">
      <div style="display: flex; gap: 0.75rem;">
       <i class="fas fa-lightbulb" style="color: var(--warning-color); font-size: 1.2rem;"></i>
       <div style="flex: 1;">
        <p style="margin: 0; font-size: 0.9rem; color: var(--theme-text-primary); line-height: 1.5;">
         ŸäŸÖŸÉŸÜŸÉ ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ≥ÿπÿ± ÿßŸÑŸÜŸáÿßÿ¶Ÿä ÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿßÿ¨ÿ© (ŸÖÿ´ŸÑ ŸÖŸÜÿ≠ ÿÆÿµŸÖ ÿ•ÿ∂ÿßŸÅŸä ÿ£Ÿà ÿ•ÿ∂ÿßŸÅÿ© ÿ±ÿ≥ŸàŸÖ). 
         ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ∞Ÿä ÿ™ÿØÿÆŸÑŸá ŸáŸà ŸÖÿß ÿ≥Ÿäÿ∏Ÿáÿ± ŸÅŸä ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑŸÖÿ∑ÿ®Ÿàÿπÿ©.
        </p>
       </div>
      </div>
     </div>
     
     <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ -->
     <div class="form-actions" style="display: flex; gap: 1rem;">
      <button type="button" class="btn btn-secondary" onclick="closeCashPaymentModal()" style="flex: 1;">
       <i class="fas fa-times"></i>
       ÿ•ŸÑÿ∫ÿßÿ°
      </button>
      <button type="button" class="btn btn-success" onclick="confirmCashPayment()" style="flex: 2; background: linear-gradient(135deg, #4CAF50, #388E3C); font-size: 1.1rem; padding: 1rem;">
       <i class="fas fa-check-circle"></i>
       ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ®Ÿäÿπ ŸàÿßŸÑÿ∑ÿ®ÿßÿπÿ©
      </button>
     </div>
    </div>
   </div>
  </div>

  <!-- ŸÜÿßŸÅÿ∞ÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ¨ÿØŸäÿØ -->
  <div id="userInfoModal" class="modal">
   <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
     <h3 class="modal-title" style="color: var(--success-color);"><i class="fas fa-user-check"></i> ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ ÿ®ŸÜÿ¨ÿßÿ≠</h3>
     <button class="close-btn" onclick="closeModal('userInfoModal')"> <i class="fas fa-times"></i> </button>
    </div>
    <div style="padding: 1.5rem 0;">
     <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); padding: 2rem; border-radius: 12px; text-align: center; margin-bottom: 1.5rem;">
      <i class="fas fa-user-circle" style="font-size: 4rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
      <h4 style="font-size: 1.2rem; margin-bottom: 0.5rem; color: var(--theme-text-primary);">ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ≠ÿ≥ÿßÿ®ŸÉ</h4>
      <p style="color: var(--theme-text-secondary); font-size: 0.9rem;">ÿßÿ≠ÿ™ŸÅÿ∏ ÿ®Ÿáÿ∞Ÿá ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÅŸä ŸÖŸÉÿßŸÜ ÿ¢ŸÖŸÜ</p>
     </div>
     
     <div style="background: var(--theme-bg-secondary); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
      <div style="margin-bottom: 1.5rem;">
       <label style="display: block; font-size: 0.9rem; color: var(--theme-text-secondary); margin-bottom: 0.5rem;">
        <i class="fas fa-fingerprint"></i> ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (UID)
       </label>
       <div style="background: var(--theme-bg-card); padding: 1rem; border-radius: 8px; border: 2px solid rgba(102, 126, 234, 0.3); display: flex; align-items: center; gap: 1rem;">
        <code id="userUID" style="flex: 1; color: var(--primary-color); font-size: 1.1rem; font-weight: 600;"></code>
        <button onclick="copyToClipboard(document.getElementById('userUID').textContent)" class="btn btn-sm" style="padding: 0.5rem 1rem; background: var(--primary-gradient);">
         <i class="fas fa-copy"></i> ŸÜÿ≥ÿÆ
        </button>
       </div>
      </div>
      
      <div style="margin-bottom: 1.5rem;">
       <label style="display: block; font-size: 0.9rem; color: var(--theme-text-secondary); margin-bottom: 0.5rem;">
        <i class="fas fa-key"></i> ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ≥ÿ±Ÿä (Secret Key)
       </label>
       <div style="background: var(--theme-bg-card); padding: 1rem; border-radius: 8px; border: 2px solid rgba(240, 147, 251, 0.3); display: flex; align-items: center; gap: 1rem;">
        <code id="userSecret" style="flex: 1; color: #f093fb; font-size: 1.1rem; font-weight: 600;"></code>
        <button onclick="copyToClipboard(document.getElementById('userSecret').textContent)" class="btn btn-sm" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #f093fb, #f5576c);">
         <i class="fas fa-copy"></i> ŸÜÿ≥ÿÆ
        </button>
       </div>
      </div>
      
      <div style="background: linear-gradient(135deg, rgba(67, 233, 123, 0.1), rgba(56, 249, 215, 0.1)); padding: 1rem; border-radius: 8px; border-right: 4px solid #43e97b;">
       <p style="margin: 0; font-size: 0.95rem; color: var(--theme-text-primary);">
        <i class="fas fa-gift" style="color: #43e97b; margin-left: 0.5rem;"></i>
        <strong>ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©:</strong> <span id="trialDaysDisplay"></span> ŸäŸàŸÖ
       </p>
      </div>
     </div>
     
     <div style="background: var(--theme-bg-secondary); border-right: 4px solid var(--warning-color); padding: 1rem; border-radius: 8px;">
      <p style="font-weight: 600; margin-bottom: 0.5rem; color: var(--warning-color);"><i class="fas fa-exclamation-triangle"></i> ÿ™ŸÜÿ®ŸäŸá ŸáÿßŸÖ:</p>
      <ul style="list-style: none; padding-right: 1.5rem; color: var(--theme-text-secondary); font-size: 0.85rem; margin: 0;">
       <li style="margin-bottom: 0.25rem;">‚Ä¢ ÿßÿ≠ŸÅÿ∏ UID ŸàÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ≥ÿ±Ÿä ŸÅŸä ŸÖŸÉÿßŸÜ ÿ¢ŸÖŸÜ</li>
       <li style="margin-bottom: 0.25rem;">‚Ä¢ ÿ≥ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸäŸáŸÖÿß ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÖŸÜ ÿ£Ÿä ÿ¨Ÿáÿßÿ≤</li>
       <li style="margin-bottom: 0.25rem;">‚Ä¢ ŸäŸÖŸÉŸÜŸÉ ÿ™ŸÅÿπŸäŸÑ ÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖÿØŸÅŸàÿπ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ</li>
      </ul>
     </div>
    </div>
    <div class="form-actions">
     <button type="button" class="btn btn-primary" onclick="closeModal('userInfoModal')">
      <i class="fas fa-check"></i> ŸÅŸáŸÖÿ™ÿå ÿßÿ®ÿØÿ£ ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ
     </button>
    </div>
   </div>
  </div>

  <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ -->
  <div id="activationModal" class="modal">
   <div class="modal-content" style="max-width: 550px;">
    <div class="modal-header">
     <h3 class="modal-title" style="color: var(--warning-color);"><i class="fas fa-crown"></i> ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ</h3>
     <button class="close-btn" onclick="closeActivationModal()"> <i class="fas fa-times"></i> </button>
    </div>
    <div style="padding: 1.5rem 0;">
     
     <!-- ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ -->
     <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1)); padding: 1.5rem; border-radius: 12px; text-align: center; margin-bottom: 1.5rem; border: 2px solid rgba(245, 158, 11, 0.3);">
      <i class="fas fa-hourglass-end" style="font-size: 3rem; color: var(--warning-color); margin-bottom: 1rem;"></i>
      <h4 style="font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--theme-text-primary);">ÿßŸÜÿ™Ÿáÿ™ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ</h4>
      <p style="color: var(--theme-text-secondary); font-size: 0.9rem; margin: 0;">ŸÑŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ŸÅŸä ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇÿå Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÅÿπŸäŸÑ ÿßÿ¥ÿ™ÿ±ÿßŸÉŸÉ</p>
     </div>

     <!-- ÿ™ÿ®ŸàŸäÿ®ÿßÿ™ ÿßŸÑÿ™ŸÅÿπŸäŸÑ -->
     <div style="margin-bottom: 1.5rem;">
      <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
       <button onclick="showActivationTab('code')" id="codeTabBtn" class="btn" style="flex: 1; background: var(--primary-gradient); padding: 0.75rem;">
        <i class="fas fa-ticket-alt"></i> ÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ
       </button>
       <button onclick="showActivationTab('login')" id="loginTabBtn" class="btn btn-secondary" style="flex: 1; padding: 0.75rem;">
        <i class="fas fa-sign-in-alt"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
       </button>
      </div>

      <!-- ÿ™ÿ®ŸàŸäÿ® ÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ -->
      <div id="codeTab" class="activation-tab">
       <div style="background: var(--theme-bg-secondary); border-radius: 12px; padding: 1.5rem;">
        <div style="margin-bottom: 1rem;">
         <label style="display: block; font-size: 0.9rem; color: var(--theme-text-secondary); margin-bottom: 0.5rem;">
          <i class="fas fa-ticket-alt"></i> ÿ£ÿØÿÆŸÑ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ
         </label>
         <input type="text" id="activationCodeInput" placeholder="ŸÖÿ´ÿßŸÑ: ABC123XYZ456" style="width: 100%; padding: 1rem; border-radius: 8px; border: 2px solid rgba(102, 126, 234, 0.3); background: var(--theme-bg-card); color: var(--theme-text-primary); font-size: 1.1rem; font-weight: 600; text-align: center; letter-spacing: 2px; text-transform: uppercase;" maxlength="20">
        </div>
        
        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); padding: 1rem; border-radius: 8px; border-right: 4px solid #10b981; margin-bottom: 1rem;">
         <p style="margin: 0; font-size: 0.85rem; color: var(--theme-text-secondary);">
          <i class="fas fa-info-circle" style="color: #10b981; margin-left: 0.5rem;"></i>
          ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ ÿ£Ÿà ŸÖŸÜ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ
         </p>
        </div>

        <button onclick="activateWithCode()" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1rem;">
         <i class="fas fa-check-circle"></i> ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ¢ŸÜ
        </button>
       </div>
      </div>

      <!-- ÿ™ÿ®ŸàŸäÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ -->
      <div id="loginTab" class="activation-tab" style="display: none;">
       <div style="background: var(--theme-bg-secondary); border-radius: 12px; padding: 1.5rem;">
        <div style="margin-bottom: 1rem;">
         <label style="display: block; font-size: 0.9rem; color: var(--theme-text-secondary); margin-bottom: 0.5rem;">
          <i class="fas fa-fingerprint"></i> ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (UID)
         </label>
         <input type="text" id="loginUIDInput" placeholder="ÿ£ÿØÿÆŸÑ UID ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ" style="width: 100%; padding: 1rem; border-radius: 8px; border: 2px solid rgba(102, 126, 234, 0.3); background: var(--theme-bg-card); color: var(--theme-text-primary); font-size: 1rem;">
        </div>
        
        <div style="margin-bottom: 1rem;">
         <label style="display: block; font-size: 0.9rem; color: var(--theme-text-secondary); margin-bottom: 0.5rem;">
          <i class="fas fa-key"></i> ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ≥ÿ±Ÿä
         </label>
         <input type="password" id="loginSecretInput" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ≥ÿ±Ÿä" style="width: 100%; padding: 1rem; border-radius: 8px; border: 2px solid rgba(240, 147, 251, 0.3); background: var(--theme-bg-card); color: var(--theme-text-primary); font-size: 1rem;">
        </div>

        <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); padding: 1rem; border-radius: 8px; border-right: 4px solid var(--primary-color); margin-bottom: 1rem;">
         <p style="margin: 0; font-size: 0.85rem; color: var(--theme-text-secondary);">
          <i class="fas fa-shield-alt" style="color: var(--primary-color); margin-left: 0.5rem;"></i>
          ÿßÿ≥ÿ™ÿÆÿØŸÖ UID ŸàÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ≥ÿ±Ÿä ÿßŸÑÿ∞Ÿä ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ§Ÿá ÿπŸÜÿØ ÿ£ŸàŸÑ ÿ™ÿ¥ÿ∫ŸäŸÑ
         </p>
        </div>

        <button onclick="loginWithCredentials()" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1rem;">
         <i class="fas fa-sign-in-alt"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                </button>
                <button onclick="createLocalUserIfNeeded()" class="btn btn-success" style="width: 100%; margin-top: 0.5rem; padding: 1rem; font-size: 1rem;">
                    <i class="fas fa-user-plus"></i> ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ
        </button>
        <!-- ŸÜŸÖŸàÿ∞ÿ¨ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ¨ÿØŸäÿØ -->
        <div id="userDetailsForm" style="display:block; margin-top:1.5rem; background:rgb(23,25,27); border-radius:10px; padding:1.2rem; border:1px solid rgb(229,231,235);">
            <h4 style="margin-bottom:1rem; color:var(--primary-gradient); font-weight:700; letter-spacing:1px; text-shadow:0 2px 8px rgba(99,102,241,0.10); font-family:'Cairo',sans-serif;"><i class="fas fa-user"></i> ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</h4>
            <div class="form-group" style="margin-bottom:1rem;">
                <label style="color:var(--theme-text-secondary); font-weight:600; margin-bottom:0.3rem; display:block; font-family:'Cairo',sans-serif; font-size:1.08rem;"><i class="fas fa-user"></i> ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ±ÿ®ÿßÿπŸä</label>
                <input type="text" id="newUserFullName" class="form-input" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ±ÿ®ÿßÿπŸä" required style="background:var(--theme-bg-card); color:var(--theme-text-primary); border:2px solid var(--theme-border,#d8d8d8); border-radius:8px; padding:1.1rem 0.9rem; font-size:1.13rem; font-weight:600; font-family:'Cairo',sans-serif; transition:box-shadow 0.2s;">
            </div>
            <div class="form-group" style="margin-bottom:1rem;">
                <label style="color:var(--theme-text-secondary); font-weight:600; margin-bottom:0.3rem; display:block; font-family:'Cairo',sans-serif; font-size:1.08rem;"><i class="fas fa-phone"></i> ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</label>
                <input type="tel" id="newUserPhone" class="form-input" placeholder="07XX XXX XXXX" required style="background:var(--theme-bg-card); color:var(--theme-text-primary); border:2px solid var(--theme-border,#d8d8d8); border-radius:8px; padding:1.1rem 0.9rem; font-size:1.13rem; font-weight:600; font-family:'Cairo',sans-serif; transition:box-shadow 0.2s;">
            </div>
            <div class="form-group" style="margin-bottom:1rem;">
                <label style="color:var(--theme-text-secondary); font-weight:600; margin-bottom:0.3rem; display:block; font-family:'Cairo',sans-serif; font-size:1.08rem;"><i class="fas fa-map-marker-alt"></i> ÿßŸÑÿπŸÜŸàÿßŸÜ</label>
                <input type="text" id="newUserAddress" class="form-input" placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ ÿßŸÑŸÉÿßŸÖŸÑ" required style="background:var(--theme-bg-card); color:var(--theme-text-primary); border:2px solid var(--theme-border,#d8d8d8); border-radius:8px; padding:1.1rem 0.9rem; font-size:1.13rem; font-weight:600; font-family:'Cairo',sans-serif; transition:box-shadow 0.2s;">
            </div>
            <div class="form-group" style="margin-bottom:1rem;">
                <label style="color:var(--theme-text-secondary); font-weight:600; margin-bottom:0.3rem; display:block; font-family:'Cairo',sans-serif; font-size:1.08rem;"><i class="fas fa-store"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ™ÿ¨ÿ±</label>
                <input type="text" id="newUserStoreName" class="form-input" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ™ÿ¨ÿ±/ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©" required style="background:var(--theme-bg-card); color:var(--theme-text-primary); border:2px solid var(--theme-border,#d8d8d8); border-radius:8px; padding:1.1rem 0.9rem; font-size:1.13rem; font-weight:600; font-family:'Cairo',sans-serif; transition:box-shadow 0.2s;">
            </div>
            <div class="form-group" style="margin-bottom:1rem; display:flex; align-items:center; gap:0.7rem;">
                <label style="color:var(--theme-text-secondary); font-weight:500;"><i class="fas fa-map-marked-alt"></i> ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿ¨ÿ∫ÿ±ÿßŸÅŸä</label>
                <button type="button" class="btn btn-info" style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;padding:0.5rem 1.2rem;border-radius:7px;font-weight:600;box-shadow:0 2px 8px rgba(59,130,246,0.10);" onclick="getUserLocation()"><i class="fas fa-map-marker-alt"></i> ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ</button>
                <span id="locationStatus" style="font-size:0.95rem; color:#059669; margin-right:8px;"></span>
            </div>
            <input type="hidden" id="newUserLat">
            <input type="hidden" id="newUserLng">
            <div style="margin-top:1.2rem; display:flex; gap:0.7rem;">
                <button type="button" class="btn btn-success" style="width: 100%; margin-bottom: 0.5rem; padding: 1rem; font-size: 1rem; border-radius: 8px; background: linear-gradient(135deg,#10b981,#059669); color: #fff; font-weight: 700;" onclick="saveNewUserDetails()"><i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ Ÿàÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ®</button>
                <button type="button" class="btn btn-secondary" style="width: 100%; padding: 1rem; font-size: 1rem; border-radius: 8px; background: linear-gradient(135deg,#64748b,#334155); color: #fff; font-weight: 700;" onclick="hideUserDetailsForm()">ÿ•ŸÑÿ∫ÿßÿ°</button>
            </div>
        </div>
        </button>
       </div>
      </div>
     </div>

     <!-- ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© -->
     <div style="background: var(--theme-bg-secondary); border-radius: 8px; padding: 1rem;">
      <p style="font-weight: 600; margin-bottom: 0.5rem; color: var(--theme-text-primary); font-size: 0.9rem;">
       <i class="fas fa-question-circle" style="color: var(--primary-color);"></i> ŸáŸÑ ÿ™ÿ≠ÿ™ÿßÿ¨ ŸÖÿ≥ÿßÿπÿØÿ©ÿü
      </p>
      <ul style="list-style: none; padding-right: 1.5rem; color: var(--theme-text-secondary); font-size: 0.8rem; margin: 0;">
       <li style="margin-bottom: 0.25rem;">‚Ä¢ ÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ±ŸÖÿ≤ ÿ™ŸÅÿπŸäŸÑ</li>
       <li style="margin-bottom: 0.25rem;">‚Ä¢ ÿ•ÿ∞ÿß ŸÉŸÜÿ™ ÿ™ŸÖŸÑŸÉ ÿ≠ÿ≥ÿßÿ® ÿ≥ÿßÿ®ŸÇÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ UID ŸàÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ≥ÿ±Ÿä</li>
       <li>‚Ä¢ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©: 30 ŸäŸàŸÖ ŸÖŸÜ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°</li>
      </ul>
     </div>
    </div>
   </div>
  </div>

  <!-- üí∞ ŸÜÿßŸÅÿ∞ÿ© ŸÖŸÜÿ®ÿ´ŸÇÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÖÿµÿ±ŸàŸÅ ÿ¨ÿØŸäÿØ -->
  <div id="addExpenseModal" class="modal">
   <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
     <h3 class="modal-title"><i class="fas fa-plus-circle"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿµÿ±ŸàŸÅ ÿ¨ÿØŸäÿØ</h3>
     <button class="close-btn" onclick="closeAddExpenseModal()"> <i class="fas fa-times"></i> </button>
    </div>
    <div class="modal-body">
     <div class="form-group">
      <label><i class="fas fa-list"></i> ŸÜŸàÿπ ÿßŸÑŸÖÿµÿ±ŸàŸÅ</label>
      <select id="expenseType" class="form-control" required>
       <option value="">ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑŸÖÿµÿ±ŸàŸÅ</option>
       <option value="rent">üè† ÿ•Ÿäÿ¨ÿßÿ±</option>
       <option value="utilities">‚ö° ŸÉŸáÿ±ÿ®ÿßÿ°/ŸÖÿßÿ°</option>
       <option value="salary">üí∞ ÿ±Ÿàÿßÿ™ÿ®</option>
       <option value="maintenance">üîß ÿµŸäÿßŸÜÿ©</option>
       <option value="transportation">üöó ŸÜŸÇŸÑ ŸàŸÖŸàÿßÿµŸÑÿßÿ™</option>
       <option value="supplies">üì¶ ŸÑŸàÿßÿ≤ŸÖ ŸÖŸÉÿ™ÿ®Ÿäÿ©</option>
       <option value="marketing">üì¢ ÿ™ÿ≥ŸàŸäŸÇ Ÿàÿ•ÿπŸÑÿßŸÜ</option>
       <option value="insurance">üõ°Ô∏è ÿ™ÿ£ŸÖŸäŸÜÿßÿ™</option>
       <option value="taxes">üìä ÿ∂ÿ±ÿßÿ¶ÿ® Ÿàÿ±ÿ≥ŸàŸÖ</option>
       <option value="other">üìù ÿ£ÿÆÿ±Ÿâ</option>
      </select>
     </div>
     <div class="form-group">
      <label><i class="fas fa-money-bill"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÉŸÑŸä (ÿØŸäŸÜÿßÿ±)</label>
      <input type="number" id="expenseAmount" class="form-control" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÉŸÑŸä" min="0" required oninput="updateExpensePaidRemaining()">
     </div>
     
     <!-- ÿ≠ŸÇŸàŸÑ ÿßŸÑÿØŸÅÿπ ÿßŸÑÿ¨ÿ≤ÿ¶Ÿä -->
     <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
      <div class="form-group">
       <label><i class="fas fa-check-circle" style="color: var(--success-color);"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ (ÿØŸäŸÜÿßÿ±)</label>
       <input type="number" id="expensePaid" class="form-control" placeholder="ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ" min="0" oninput="updateExpensePaidRemaining()">
       <small style="color: var(--theme-text-tertiary); display: block; margin-top: 0.3rem;">ÿßÿ™ÿ±ŸÉ ŸÅÿßÿ±ÿ∫ÿßŸã ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿØŸÅÿπ</small>
      </div>
      <div class="form-group">
       <label><i class="fas fa-exclamation-circle" style="color: var(--warning-color);"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä (ÿØŸäŸÜÿßÿ±)</label>
       <input type="number" id="expenseRemaining" class="form-control" placeholder="ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä" readonly style="background: var(--theme-bg-secondary); cursor: not-allowed;">
       <small style="color: var(--theme-text-tertiary); display: block; margin-top: 0.3rem;">Ÿäÿ™ŸÖ ÿ≠ÿ≥ÿßÿ®Ÿá ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã</small>
      </div>
     </div>
     
     <div class="form-group">
      <label><i class="fas fa-sticky-note"></i> ÿßŸÑŸàÿµŸÅ</label>
      <textarea id="expenseDescription" class="form-control" rows="3" placeholder="ŸàÿµŸÅ ÿ™ŸÅÿµŸäŸÑŸä ŸÑŸÑŸÖÿµÿ±ŸàŸÅ"></textarea>
     </div>
     <div class="form-group">
      <label><i class="fas fa-calendar"></i> ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</label>
      <input type="date" id="expenseDate" class="form-control" required>
     </div>
     <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeAddExpenseModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
      <button class="btn btn-primary" onclick="saveExpense()"><i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿµÿ±ŸàŸÅ</button>
     </div>
    </div>
   </div>
  </div>

  <!-- üõí ŸÜÿßŸÅÿ∞ÿ© ŸÖŸÜÿ®ÿ´ŸÇÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ -->
  <div id="addPurchaseModal" class="modal">
   <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
     <h3 class="modal-title"><i class="fas fa-cart-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™</h3>
     <button class="close-btn" onclick="closeAddPurchaseModal()"> <i class="fas fa-times"></i> </button>
    </div>
    <div class="modal-body">
     <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸàÿ±ÿØ -->
     <div style="background: var(--theme-bg-secondary); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem;">
      <h4 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="fas fa-building"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸàÿ±ÿØ</h4>
      <div class="form-row">
       <div class="form-group" style="flex: 1;">
        <label><i class="fas fa-building"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ±ÿØ</label>
        <input type="text" id="supplierName" class="form-control" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ±ÿØ" required>
       </div>
       <div class="form-group" style="flex: 1;">
        <label><i class="fas fa-phone"></i> ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</label>
        <input type="tel" id="supplierPhone" class="form-control" placeholder="07XX XXX XXXX">
       </div>
      </div>
      <div class="form-row">
       <div class="form-group" style="flex: 1;">
        <label><i class="fas fa-hashtag"></i> ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</label>
        <input type="text" id="invoiceNumber" class="form-control" placeholder="ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)">
       </div>
       <div class="form-group" style="flex: 1;">
        <label><i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</label>
        <input type="date" id="purchaseDate" class="form-control" required>
       </div>
      </div>
     </div>

     <!-- ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© -->
     <div style="margin-bottom: 1.5rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
       <h4 style="color: var(--primary-color);"><i class="fas fa-boxes"></i> ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</h4>
       <button class="btn btn-success" onclick="addPurchaseItem()"><i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨</button>
      </div>
      <div id="purchaseItemsContainer">
       <!-- ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
      </div>
     </div>

     <!-- ŸÖŸÑÿÆÿµ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© -->
     <div style="background: var(--theme-bg-secondary); padding: 1.5rem; border-radius: var(--border-radius);">
      <div class="summary-row">
       <span style="font-size: 1.2rem; font-weight: bold;">ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:</span>
       <span id="purchaseTotalAmount" style="font-size: 1.3rem; font-weight: bold; color: var(--primary-color);">0 ÿØŸäŸÜÿßÿ±</span>
      </div>
     </div>

     <div class="modal-footer" style="margin-top: 1.5rem;">
      <button class="btn btn-secondary" onclick="closeAddPurchaseModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
      <button class="btn btn-primary" onclick="savePurchase()"><i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™</button>
     </div>
    </div>
   </div>
  </div>

  <!-- üìù ŸÜÿßŸÅÿ∞ÿ© ŸÖŸÜÿ®ÿ´ŸÇÿ© ŸÑÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ -->
  <div id="viewPurchaseModal" class="modal">
   <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
     <h3 class="modal-title"><i class="fas fa-file-invoice"></i> ÿ™ŸÅÿßÿµŸäŸÑ ŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™</h3>
     <button class="close-btn" onclick="closeViewPurchaseModal()"> <i class="fas fa-times"></i> </button>
    </div>
    <div class="modal-body" id="purchaseDetailsContent">
     <!-- ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
    </div>
   </div>
  </div>

  <!-- üí≥ ŸÜÿßŸÅÿ∞ÿ© ŸÖŸÜÿ®ÿ´ŸÇÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿØŸäŸÜ ŸäÿØŸàŸäÿßŸã -->
  <div id="addManualDebtModal" class="modal">
   <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
     <h3 class="modal-title"><i class="fas fa-user-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿØŸäŸÜ ÿ¨ÿØŸäÿØ</h3>
     <button class="close-btn" onclick="closeAddManualDebtModal()"> <i class="fas fa-times"></i> </button>
    </div>
    <div class="modal-body">
     <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ -->
     <div style="background: var(--theme-bg-secondary); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem;">
      <h4 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="fas fa-user"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ</h4>
      <div class="form-row" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
       <div class="form-group">
        <label><i class="fas fa-user"></i> ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ</label>
        <input type="text" id="manualDebtCustomerName" class="form-control" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ" required>
       </div>
       <div class="form-group">
        <label><i class="fas fa-phone"></i> ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</label>
        <input type="tel" id="manualDebtCustomerPhone" class="form-control" placeholder="07XX XXX XXXX" required>
       </div>
       <div class="form-group">
        <label><i class="fas fa-map-marker-alt"></i> ÿßŸÑÿπŸÜŸàÿßŸÜ</label>
        <input type="text" id="manualDebtCustomerAddress" class="form-control" placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑÿπŸÖŸäŸÑ">
       </div>
       <div class="form-group">
        <label><i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿØŸäŸÜ</label>
        <input type="date" id="manualDebtDate" class="form-control" required>
       </div>
      </div>
     </div>

     <!-- ŸÇÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ -->
     <div style="background: var(--theme-bg-secondary); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem;">
      <h4 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="fas fa-shopping-cart"></i> ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</h4>
      
      <!-- ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ -->
      <div class="form-group">
       <label><i class="fas fa-search"></i> ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÜÿ™ÿ¨</label>
       <div style="position: relative;">
        <input type="text" id="manualDebtProductSearch" class="form-control" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÜÿ™ÿ¨..." oninput="searchProductsForDebt(this.value)">
        <div id="manualDebtProductSearchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: var(--theme-bg-primary); border: 1px solid var(--theme-border-color); border-radius: var(--border-radius); max-height: 200px; overflow-y: auto; z-index: 1000; display: none; margin-top: 5px;"></div>
       </div>
      </div>
      
      <!-- ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ŸäÿØŸàŸäÿßŸã -->
      <div class="form-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: end; margin-bottom: 1rem;">
       <div class="form-group" style="margin: 0;">
        <label><i class="fas fa-box"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨</label>
        <input type="text" id="manualDebtProductName" class="form-control" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨">
       </div>
       <div class="form-group" style="margin: 0;">
        <label><i class="fas fa-tag"></i> ÿßŸÑÿ≥ÿπÿ±</label>
        <input type="number" id="manualDebtProductPrice" class="form-control" placeholder="ÿßŸÑÿ≥ÿπÿ±" min="0">
       </div>
       <div class="form-group" style="margin: 0;">
        <label><i class="fas fa-sort-numeric-up"></i> ÿßŸÑŸÉŸÖŸäÿ©</label>
        <input type="number" id="manualDebtProductQty" class="form-control" placeholder="ÿßŸÑŸÉŸÖŸäÿ©" min="1" value="1">
       </div>
       <button type="button" class="btn btn-success" onclick="addManualDebtProduct()" style="padding: 0.75rem 1.5rem;">
        <i class="fas fa-plus"></i>
       </button>
      </div>
      
      <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ∂ÿßŸÅÿ© -->
      <div id="manualDebtProductsContainer" style="display: none; margin-top: 1rem;">
       <h5 style="margin-bottom: 0.75rem; color: var(--theme-text-secondary);"><i class="fas fa-list"></i> ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ∂ÿßŸÅÿ©</h5>
       <div class="table-container" style="max-height: 300px; overflow-y: auto;">
        <table class="table">
         <thead>
          <tr>
           <th>ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
           <th>ÿßŸÑÿ≥ÿπÿ±</th>
           <th>ÿßŸÑŸÉŸÖŸäÿ©</th>
           <th>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</th>
           <th>ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
          </tr>
         </thead>
         <tbody id="manualDebtProductsTable">
         </tbody>
        </table>
       </div>
      </div>
     </div>

     <!-- ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸäŸÜ -->
     <div style="background: var(--theme-bg-secondary); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem;">
      <h4 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="fas fa-money-bill-wave"></i> ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸäŸÜ</h4>
      <div class="form-row" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
       <div class="form-group">
        <label><i class="fas fa-money-bill"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä (ÿØŸäŸÜÿßÿ±)</label>
        <input type="number" id="manualDebtTotalAmount" class="form-control" placeholder="ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä" min="0" onchange="calculateManualDebtInstallments()" required>
       </div>
       <div class="form-group">
        <label><i class="fas fa-hand-holding-usd"></i> ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ© (ÿØŸäŸÜÿßÿ±)</label>
        <input type="number" id="manualDebtDownPayment" class="form-control" placeholder="0" min="0" value="0" onchange="calculateManualDebtInstallments()">
       </div>
       <div class="form-group">
        <label><i class="fas fa-calendar-alt"></i> ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ±</label>
        <input type="number" id="manualDebtMonths" class="form-control" placeholder="ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ±" min="1" max="60" onchange="calculateManualDebtInstallments()" required>
       </div>
       <div class="form-group">
        <label><i class="fas fa-plus-circle"></i> ŸÖÿ®ŸÑÿ∫ ÿ•ÿ∂ÿßŸÅŸä (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
        <input type="number" id="manualDebtAdditionalAmount" class="form-control" placeholder="0" min="0" value="0" onchange="calculateManualDebtInstallments()">
       </div>
       <div class="form-group">
        <label><i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</label>
        <input type="date" id="manualDebtStartDate" class="form-control">
       </div>
      </div>
      <div class="form-group">
       <label><i class="fas fa-sticky-note"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
       <textarea id="manualDebtNotes" class="form-control" rows="2" placeholder="ÿ£Ÿä ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ÿπŸÜ ÿßŸÑÿØŸäŸÜ"></textarea>
      </div>
     </div>

     <!-- ŸÖŸÑÿÆÿµ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ -->
     <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid rgba(99, 102, 241, 0.3);">
      <h4 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="fas fa-calculator"></i> ŸÖŸÑÿÆÿµ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™</h4>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
       <div style="text-align: center;">
        <div style="font-size: 0.9rem; color: var(--theme-text-tertiary); margin-bottom: 0.5rem;">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</div>
        <div id="manualDebtRemainingAmount" style="font-size: 1.5rem; font-weight: bold; color: var(--danger-color);">0 ÿØŸäŸÜÿßÿ±</div>
       </div>
       <div style="text-align: center;">
        <div style="font-size: 0.9rem; color: var(--theme-text-tertiary); margin-bottom: 0.5rem;">ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä</div>
        <div id="manualDebtMonthlyAmount" style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">0 ÿØŸäŸÜÿßÿ±</div>
       </div>
       <div style="text-align: center;">
        <div style="font-size: 0.9rem; color: var(--theme-text-tertiary); margin-bottom: 0.5rem;">ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÜŸáÿßÿ¶Ÿä</div>
        <div id="manualDebtFinalTotal" style="font-size: 1.5rem; font-weight: bold; color: var(--success-color);">0 ÿØŸäŸÜÿßÿ±</div>
       </div>
      </div>
     </div>

     <div class="modal-footer" style="margin-top: 1.5rem;">
      <button class="btn btn-secondary" onclick="closeAddManualDebtModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
      <button class="btn btn-primary" onclick="saveManualDebt()"><i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸäŸÜ</button>
     </div>
    </div>
   </div>
  </div>

  <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿπÿØŸäŸÑ ÿØŸäŸÜ ŸÖŸàÿ¨ŸàÿØ -->
  <div id="editDebtModal" class="modal">
   <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
     <h3 class="modal-title"><i class="fas fa-edit"></i> ÿ™ÿπÿØŸäŸÑ ÿØŸäŸÜ ÿßŸÑÿπŸÖŸäŸÑ</h3>
     <button class="close-btn" onclick="closeEditDebtModal()"> <i class="fas fa-times"></i> </button>
    </div>
    <div class="modal-body">
     <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ -->
     <div style="background: var(--theme-bg-secondary); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem;">
      <h4 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="fas fa-user"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ</h4>
      <div class="form-row" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
       <div class="form-group">
        <label><i class="fas fa-user"></i> ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ</label>
        <input type="text" id="editDebtCustomerName" class="form-control" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ" required>
       </div>
       <div class="form-group">
        <label><i class="fas fa-phone"></i> ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</label>
        <input type="tel" id="editDebtCustomerPhone" class="form-control" placeholder="07XX XXX XXXX" required>
       </div>
       <div class="form-group">
        <label><i class="fas fa-map-marker-alt"></i> ÿßŸÑÿπŸÜŸàÿßŸÜ</label>
        <input type="text" id="editDebtCustomerAddress" class="form-control" placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑÿπŸÖŸäŸÑ">
       </div>
       <div class="form-group">
        <label><i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿØŸäŸÜ</label>
        <input type="date" id="editDebtDate" class="form-control" required>
       </div>
      </div>
     </div>

     <!-- ŸÇÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ -->
     <div style="background: var(--theme-bg-secondary); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem;">
      <h4 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="fas fa-shopping-cart"></i> ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</h4>
      
      <!-- ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ -->
      <div class="form-group">
       <label><i class="fas fa-search"></i> ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÜÿ™ÿ¨</label>
       <div style="position: relative;">
        <input type="text" id="editDebtProductSearch" class="form-control" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÜÿ™ÿ¨..." oninput="searchProductsForEditDebt(this.value)">
        <div id="editDebtProductSearchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: var(--theme-bg-primary); border: 1px solid var(--theme-border-color); border-radius: var(--border-radius); max-height: 200px; overflow-y: auto; z-index: 1000; display: none; margin-top: 5px;"></div>
       </div>
      </div>
      
      <!-- ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ŸäÿØŸàŸäÿßŸã -->
      <div class="form-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: end; margin-bottom: 1rem;">
       <div class="form-group" style="margin: 0;">
        <label><i class="fas fa-box"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨</label>
        <input type="text" id="editDebtProductName" class="form-control" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨">
       </div>
       <div class="form-group" style="margin: 0;">
        <label><i class="fas fa-tag"></i> ÿßŸÑÿ≥ÿπÿ±</label>
        <input type="number" id="editDebtProductPrice" class="form-control" placeholder="ÿßŸÑÿ≥ÿπÿ±" min="0">
       </div>
       <div class="form-group" style="margin: 0;">
        <label><i class="fas fa-sort-numeric-up"></i> ÿßŸÑŸÉŸÖŸäÿ©</label>
        <input type="number" id="editDebtProductQty" class="form-control" placeholder="ÿßŸÑŸÉŸÖŸäÿ©" min="1" value="1">
       </div>
       <button type="button" class="btn btn-success" onclick="addEditDebtProduct()" style="padding: 0.75rem 1.5rem;">
        <i class="fas fa-plus"></i>
       </button>
      </div>
      
      <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ∂ÿßŸÅÿ© -->
      <div id="editDebtProductsContainer" style="display: none; margin-top: 1rem;">
       <h5 style="margin-bottom: 0.75rem; color: var(--theme-text-secondary);"><i class="fas fa-list"></i> ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ∂ÿßŸÅÿ©</h5>
       <div class="table-container" style="max-height: 300px; overflow-y: auto;">
        <table class="table">
         <thead>
          <tr>
           <th>ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
           <th>ÿßŸÑÿ≥ÿπÿ±</th>
           <th>ÿßŸÑŸÉŸÖŸäÿ©</th>
           <th>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</th>
           <th>ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
          </tr>
         </thead>
         <tbody id="editDebtProductsTable">
         </tbody>
        </table>
       </div>
      </div>
     </div>

     <!-- ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸäŸÜ -->
     <div style="background: var(--theme-bg-secondary); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem;">
      <h4 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="fas fa-money-bill-wave"></i> ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸäŸÜ</h4>
      <div class="form-row" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
       <div class="form-group">
        <label><i class="fas fa-money-bill"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä (ÿØŸäŸÜÿßÿ±)</label>
        <input type="number" id="editDebtTotalAmount" class="form-control" placeholder="ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä" min="0" onchange="calculateEditDebtInstallments()" required>
       </div>
       <div class="form-group">
        <label><i class="fas fa-hand-holding-usd"></i> ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ© (ÿØŸäŸÜÿßÿ±)</label>
        <input type="number" id="editDebtDownPayment" class="form-control" placeholder="0" min="0" value="0" onchange="calculateEditDebtInstallments()">
       </div>
       <div class="form-group">
        <label><i class="fas fa-calendar-alt"></i> ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ±</label>
        <input type="number" id="editDebtMonths" class="form-control" placeholder="ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ±" min="1" max="60" onchange="calculateEditDebtInstallments()" required>
       </div>
       <div class="form-group">
        <label><i class="fas fa-plus-circle"></i> ŸÖÿ®ŸÑÿ∫ ÿ•ÿ∂ÿßŸÅŸä (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
        <input type="number" id="editDebtAdditionalAmount" class="form-control" placeholder="0" min="0" value="0" onchange="calculateEditDebtInstallments()">
       </div>
       <div class="form-group">
        <label><i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</label>
        <input type="date" id="editDebtStartDate" class="form-control">
       </div>
      </div>
      <div class="form-group">
       <label><i class="fas fa-sticky-note"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
       <textarea id="editDebtNotes" class="form-control" rows="2" placeholder="ÿ£Ÿä ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ÿπŸÜ ÿßŸÑÿØŸäŸÜ"></textarea>
      </div>
     </div>

     <!-- ŸÖŸÑÿÆÿµ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ -->
     <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid rgba(99, 102, 241, 0.3);">
      <h4 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="fas fa-calculator"></i> ŸÖŸÑÿÆÿµ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™</h4>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
       <div style="text-align: center;">
        <div style="font-size: 0.9rem; color: var(--theme-text-tertiary); margin-bottom: 0.5rem;">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</div>
        <div id="editDebtRemainingAmount" style="font-size: 1.5rem; font-weight: bold; color: var(--danger-color);">0 ÿØŸäŸÜÿßÿ±</div>
       </div>
       <div style="text-align: center;">
        <div style="font-size: 0.9rem; color: var(--theme-text-tertiary); margin-bottom: 0.5rem;">ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä</div>
        <div id="editDebtMonthlyAmount" style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">0 ÿØŸäŸÜÿßÿ±</div>
       </div>
       <div style="text-align: center;">
        <div style="font-size: 0.9rem; color: var(--theme-text-tertiary); margin-bottom: 0.5rem;">ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÜŸáÿßÿ¶Ÿä</div>
        <div id="editDebtFinalTotal" style="font-size: 1.5rem; font-weight: bold; color: var(--success-color);">0 ÿØŸäŸÜÿßÿ±</div>
       </div>
      </div>
     </div>

     <div class="modal-footer" style="margin-top: 1.5rem;">
      <button class="btn btn-secondary" onclick="closeEditDebtModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
      <button class="btn btn-primary" onclick="updateDebt()"><i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™</button>
     </div>
    </div>
   </div>
  </div>

  <script>
        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
        let cart = [];
        let products = [];
        let categories = [];
        let salesData = [];
        let debtsData = [];
        let selectedPaymentMethod = 'ŸÜŸÇÿØŸä';
        let isLoading = false;
        let currentCategory = 'all';
        let currentTheme = 'dark';
        let sidebarCollapsed = false;
        
        // üí∞ ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ
        let expensesData = [];
        let purchasesData = [];
        let currentExpenseTab = 'general';
        let purchaseItems = [];
        
        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿ™ÿ≥ÿØŸäÿØ ÿßŸÑŸÇÿ≥ÿ∑
        let currentInstallmentDebtId = null;
        let currentInstallmentMonth = null;
        
        // ŸÖÿ™ÿ∫Ÿäÿ± ÿ≠ÿ∞ŸÅ ÿßŸÑÿØŸäŸÜ
        let debtToDelete = null;
        
        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿØŸäŸÜ
        let manualDebtProducts = [];
        let editDebtProducts = [];
        let currentEditDebtId = null;

        // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
        const defaultConfig = {
            store_name: 'ŸÖÿ™ÿ¨ÿ± ÿßŸÑÿ™ŸÇŸÜŸäÿ© ÿßŸÑÿ≠ÿØŸäÿ´ÿ©',
            store_address: 'ÿ®ÿ∫ÿØÿßÿØ - ÿßŸÑŸÖŸÜÿµŸàÿ±',
            store_phone: '07803092185',
            tax_rate: '0'
        };

        // ÿ£ŸäŸÇŸàŸÜÿßÿ™ ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©
        const availableIcons = [
            // ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿßÿ™ Ÿàÿ≠Ÿàÿßÿ≥Ÿäÿ®
            'fas fa-laptop', 'fas fa-desktop', 'fas fa-tablet-alt', 'fas fa-mobile-alt',
            'fas fa-keyboard', 'fas fa-mouse', 'fas fa-headphones', 'fas fa-microphone',
            'fas fa-camera', 'fas fa-video', 'fas fa-webcam', 'fas fa-gamepad',
            'fas fa-headset', 'fas fa-microchip', 'fas fa-memory', 'fas fa-hdd',
            'fas fa-sim-card', 'fas fa-sd-card', 'fas fa-save', 'fas fa-compact-disc',
            'fas fa-server', 'fas fa-database', 'fas fa-network-wired', 'fas fa-ethernet',
            'fas fa-wifi', 'fas fa-bluetooth', 'fas fa-satellite-dish', 'fas fa-router',
            'fas fa-usb', 'fas fa-plug', 'fas fa-power-off', 'fas fa-print',
            'fas fa-scanner', 'fas fa-fax', 'fas fa-calculator', 'fas fa-cash-register',
            
            // ÿ£ÿ¨Ÿáÿ≤ÿ© ŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ© ŸÖŸÜÿ≤ŸÑŸäÿ©
            'fas fa-tv', 'fas fa-blender', 'fas fa-lightbulb', 'fas fa-fan', 
            'fas fa-snowflake', 'fas fa-fire', 'fas fa-temperature-high', 'fas fa-temperature-low',
            'fas fa-thermometer-half', 'fas fa-wind', 'fas fa-bolt', 'fas fa-charging-station',
            'fas fa-battery-full', 'fas fa-battery-half', 'fas fa-battery-quarter', 'fas fa-solar-panel',
            'fas fa-broadcast-tower', 'fas fa-satellite', 'fas fa-coffee', 'fas fa-mug-hot',
            'fas fa-blender-phone', 'fas fa-utensils', 'fas fa-sink', 'fas fa-toilet',
            'fas fa-shower', 'fas fa-bath', 'fas fa-pump-soap', 'fas fa-spray-can',
            
            // ŸÖŸÉÿ™ÿ®Ÿäÿßÿ™ ŸàŸÇÿ±ÿ∑ÿßÿ≥Ÿäÿ©
            'fas fa-book', 'fas fa-book-open', 'fas fa-bookmark', 'fas fa-books',
            'fas fa-pen', 'fas fa-pencil-alt', 'fas fa-pen-fancy', 'fas fa-pen-nib',
            'fas fa-marker', 'fas fa-highlighter', 'fas fa-eraser', 'fas fa-ruler',
            'fas fa-ruler-combined', 'fas fa-ruler-horizontal', 'fas fa-ruler-vertical', 'fas fa-drafting-compass',
            'fas fa-paperclip', 'fas fa-thumbtack', 'fas fa-sticky-note', 'fas fa-clipboard',
            'fas fa-clipboard-list', 'fas fa-paste', 'fas fa-file', 'fas fa-file-alt',
            'fas fa-folder', 'fas fa-folder-open', 'fas fa-archive', 'fas fa-envelope',
            'fas fa-envelope-open', 'fas fa-stamp', 'fas fa-stapler', 'fas fa-scissors',
            
            // ÿ£ÿ´ÿßÿ´ ŸàŸÖŸÉÿßÿ™ÿ®
            'fas fa-chair', 'fas fa-couch', 'fas fa-bed', 'fas fa-door-open',
            'fas fa-door-closed', 'fas fa-table', 'fas fa-desktop', 'fas fa-lamp',
            'fas fa-warehouse', 'fas fa-store', 'fas fa-store-alt', 'fas fa-building',
            
            // ŸÖŸÑÿßÿ®ÿ≥ Ÿàÿ•ŸÉÿ≥ÿ≥Ÿàÿßÿ±ÿßÿ™
            'fas fa-tshirt', 'fas fa-hat-cowboy', 'fas fa-hat-wizard', 'fas fa-glasses',
            'fas fa-sunglasses', 'fas fa-ring', 'fas fa-gem', 'fas fa-crown',
            'fas fa-user-tie', 'fas fa-shoe-prints', 'fas fa-socks', 'fas fa-mitten',
            'fas fa-watch', 'fas fa-clock', 'fas fa-stopwatch', 'fas fa-hourglass',
            
            // ÿ±Ÿäÿßÿ∂ÿ© ŸàŸÑŸäÿßŸÇÿ©
            'fas fa-dumbbell', 'fas fa-running', 'fas fa-walking', 'fas fa-biking',
            'fas fa-swimming-pool', 'fas fa-bicycle', 'fas fa-football-ball', 'fas fa-basketball-ball',
            'fas fa-baseball-ball', 'fas fa-volleyball-ball', 'fas fa-table-tennis', 'fas fa-bowling-ball',
            'fas fa-skating', 'fas fa-skiing', 'fas fa-snowboarding', 'fas fa-heart',
            
            // ÿ£ÿØŸàÿßÿ™ ŸàÿµŸäÿßŸÜÿ©
            'fas fa-tools', 'fas fa-wrench', 'fas fa-screwdriver', 'fas fa-hammer',
            'fas fa-toolbox', 'fas fa-cog', 'fas fa-cogs', 'fas fa-paint-roller',
            'fas fa-brush', 'fas fa-magic', 'fas fa-spray-can', 'fas fa-fire-extinguisher',
            'fas fa-flashlight', 'fas fa-oil-can', 'fas fa-tape', 'fas fa-shield-alt',
            
            // ÿ∑ÿ®Ÿäÿ© Ÿàÿµÿ≠Ÿäÿ©
            'fas fa-medkit', 'fas fa-first-aid', 'fas fa-pills', 'fas fa-prescription-bottle',
            'fas fa-syringe', 'fas fa-thermometer', 'fas fa-heartbeat', 'fas fa-stethoscope',
            'fas fa-hospital', 'fas fa-ambulance', 'fas fa-wheelchair', 'fas fa-hand-holding-medical',
            
            // ÿ≥Ÿäÿßÿ±ÿßÿ™ ŸàŸÖÿ±ŸÉÿ®ÿßÿ™
            'fas fa-car', 'fas fa-car-side', 'fas fa-car-alt', 'fas fa-truck',
            'fas fa-motorcycle', 'fas fa-bus', 'fas fa-taxi', 'fas fa-shuttle-van',
            'fas fa-oil-can', 'fas fa-gas-pump', 'fas fa-tire', 'fas fa-wheel',
            
            // ÿ∑ÿπÿßŸÖ ŸàŸÖÿ¥ÿ±Ÿàÿ®ÿßÿ™
            'fas fa-utensils', 'fas fa-utensil-spoon', 'fas fa-utensil-fork', 'fas fa-pizza-slice',
            'fas fa-hamburger', 'fas fa-hotdog', 'fas fa-ice-cream', 'fas fa-cake',
            'fas fa-birthday-cake', 'fas fa-cookie', 'fas fa-apple-alt', 'fas fa-lemon',
            'fas fa-carrot', 'fas fa-pepper-hot', 'fas fa-cheese', 'fas fa-bread-slice',
            'fas fa-coffee', 'fas fa-mug-hot', 'fas fa-wine-glass', 'fas fa-glass-martini',
            'fas fa-beer', 'fas fa-wine-bottle', 'fas fa-flask', 'fas fa-blender',
            
            // ÿ≠ŸäŸàÿßŸÜÿßÿ™ ŸàŸÜÿ®ÿßÿ™ÿßÿ™
            'fas fa-dog', 'fas fa-cat', 'fas fa-fish', 'fas fa-dove',
            'fas fa-spider', 'fas fa-frog', 'fas fa-horse', 'fas fa-crow',
            'fas fa-seedling', 'fas fa-tree', 'fas fa-leaf', 'fas fa-cannabis',
            
            // ÿ™ÿ±ŸÅŸäŸá ŸàŸÅŸÜŸàŸÜ
            'fas fa-music', 'fas fa-guitar', 'fas fa-drum', 'fas fa-film',
            'fas fa-photo-video', 'fas fa-palette', 'fas fa-paint-brush', 'fas fa-theater-masks',
            'fas fa-ticket-alt', 'fas fa-trophy', 'fas fa-medal', 'fas fa-award',
            
            // ÿ™ÿπŸÑŸäŸÖ ŸàÿπŸÑŸàŸÖ
            'fas fa-graduation-cap', 'fas fa-school', 'fas fa-chalkboard', 'fas fa-chalkboard-teacher',
            'fas fa-user-graduate', 'fas fa-flask', 'fas fa-microscope', 'fas fa-atom',
            'fas fa-dna', 'fas fa-vial', 'fas fa-vials', 'fas fa-magnet',
            
            // ÿπÿßŸÖÿ© ŸàŸÖÿ™ŸÜŸàÿπÿ©
            'fas fa-box', 'fas fa-boxes', 'fas fa-cube', 'fas fa-cubes',
            'fas fa-shopping-bag', 'fas fa-shopping-cart', 'fas fa-shopping-basket', 'fas fa-gift',
            'fas fa-tag', 'fas fa-tags', 'fas fa-barcode', 'fas fa-qrcode',
            'fas fa-star', 'fas fa-crown', 'fas fa-gem', 'fas fa-key',
            'fas fa-lock', 'fas fa-unlock', 'fas fa-shield-alt', 'fas fa-home',
            'fas fa-map-marker-alt', 'fas fa-phone', 'fas fa-envelope', 'fas fa-globe',
            'fas fa-flag', 'fas fa-bell', 'fas fa-comment', 'fas fa-comments',
            'fas fa-umbrella', 'fas fa-sun', 'fas fa-moon', 'fas fa-cloud',
            'fas fa-snowflake', 'fas fa-rainbow', 'fas fa-fire', 'fas fa-water'
        ];

        // ŸÖÿπÿßŸÑÿ¨ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑŸÄ Data SDK
        const dataHandler = {
            async onDataChanged(data) {
                // ÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜŸàÿπ
                products = data.filter(item => item.type === 'product');
                categories = data.filter(item => item.type === 'category');
                salesData = data.filter(item => item.type === 'sale');
                debtsData = data.filter(item => item.type === 'debt');
                
                console.log('Data changed - debtsData:', debtsData);
                
                // ‚úÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸäŸàŸÜ ŸÅŸä localStorage ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
                await ensureDebtsInLocalStorage();
                
                // ÿ•ÿµŸÑÿßÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØŸäŸàŸÜ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
                if (typeof fixDebtsData === 'function' && debtsData && debtsData.length > 0) {
                    console.log('üîß Running automatic debt data repair on data change...');
                    await fixDebtsData();
                }
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿßÿ™
                updateAllViews();
            }
        };

        // ==================== ÿØŸàÿßŸÑ Firebase ŸàÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ====================
        
        // ÿØŸàÿßŸÑ ŸÖÿ≥ÿßÿπÿØÿ© ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸàÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ
        function generateRandomKey(len = 10) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let s = '';
            for (let i = 0; i < len; i++) s += chars.charAt(Math.floor(Math.random() * chars.length));
            return s;
        }

        // ÿ•ÿ∏Ÿáÿßÿ± ŸÜŸÖŸàÿ∞ÿ¨ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        window.createLocalUserIfNeeded = function() {
            document.getElementById('userDetailsForm').style.display = 'block';
        };

        // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨
        window.hideUserDetailsForm = function() {
            document.getElementById('userDetailsForm').style.display = 'none';
        };

        // ÿ≤ÿ± ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿ¨ÿ∫ÿ±ÿßŸÅŸä
        window.getUserLocation = function() {
            const status = document.getElementById('locationStatus');
            status.textContent = 'ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ...';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    document.getElementById('newUserLat').value = pos.coords.latitude;
                    document.getElementById('newUserLng').value = pos.coords.longitude;
                    status.textContent = 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ ÿ®ŸÜÿ¨ÿßÿ≠';
                }, function(err) {
                    let msg = 'ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ';
                    if (window && window.process && window.process.type === 'renderer') {
                        msg += ' - ŸÇÿØ ÿ™ÿ≠ÿ™ÿßÿ¨ ŸÑÿ™ŸÅÿπŸäŸÑ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÖŸàŸÇÿπ ŸÖŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿ£Ÿà ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÉŸÖÿ≥ÿ§ŸàŸÑ.';
                    } else if (err && err.code === 1) {
                        msg += ' - ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿ•ÿ∞ŸÜ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≥ŸÖÿßÿ≠ ŸÑŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ®ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖŸàŸÇÿπ.';
                    } else if (err && err.code === 2) {
                        msg += ' - ÿßŸÑŸÖŸàŸÇÿπ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ÿ£Ÿà GPS.';
                    } else if (err && err.code === 3) {
                        msg += ' - ÿßŸÜÿ™Ÿáÿ™ ŸÖŸáŸÑÿ© ÿßŸÑÿ∑ŸÑÿ®. ÿ≠ÿßŸàŸÑ ŸÖÿ¨ÿØÿØŸãÿß.';
                    }
                    status.textContent = msg;
                });
            } else {
                status.textContent = 'ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ÿ£Ÿà ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÑÿß ŸäÿØÿπŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ. ÿ•ÿ∞ÿß ŸÉŸÜÿ™ ÿ™ÿ≥ÿ™ÿÆÿØŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿ≥ÿ∑ÿ≠ ŸÖŸÉÿ™ÿ®ÿå ŸÇÿØ ÿ™ÿ≠ÿ™ÿßÿ¨ ŸÑÿ™ŸÅÿπŸäŸÑ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÖŸàŸÇÿπ ŸÖŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ.';
            }
        };

        // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ Ÿàÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ®
        window.saveNewUserDetails = async function() {
            // ‚úÖ ŸÅÿ≠ÿµ Firebase ÿ£ŸàŸÑÿßŸã
            if (!window.database || typeof database === 'undefined') {
                console.error('‚ùå Firebase ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ');
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                
                // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ÿπÿßÿØÿ© ÿ™ŸáŸäÿ¶ÿ© Firebase
                if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                    try {
                        window.database = firebase.database();
                        console.log('‚úÖ ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ŸáŸäÿ¶ÿ© Firebase ÿ®ŸÜÿ¨ÿßÿ≠');
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                        // ÿ•ÿπÿßÿØÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑÿØÿßŸÑÿ© ÿ®ÿπÿØ ÿ´ÿßŸÜŸäÿ©
                        setTimeout(() => window.saveNewUserDetails(), 1000);
                        return;
                    } catch (error) {
                        console.error('‚ùå ŸÅÿ¥ŸÑ ÿ•ÿπÿßÿØÿ© ÿ™ŸáŸäÿ¶ÿ© Firebase:', error);
                    }
                }
                
                alert('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™!\n\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ:\n1. ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™\n2. ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ\n3. ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿØÿπŸÖ ÿßŸÑŸÅŸÜŸä ÿ•ÿ∞ÿß ÿßÿ≥ÿ™ŸÖÿ±ÿ™ ÿßŸÑŸÖÿ¥ŸÉŸÑÿ©');
                return;
            }

            const fullName = document.getElementById('newUserFullName').value.trim();
            const phone = document.getElementById('newUserPhone').value.trim();
            const address = document.getElementById('newUserAddress').value.trim();
            const storeName = document.getElementById('newUserStoreName').value.trim();
            const lat = document.getElementById('newUserLat').value;
            const lng = document.getElementById('newUserLng').value;

            if (!fullName || !phone || !address || !storeName) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }

            try {
                let uid = localStorage.getItem('app_uid');
                let secret = localStorage.getItem('app_secret');
                
                if (uid && secret) {
                    // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØŸÖ Ÿàÿ¨ŸàÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ®ŸÇÿßŸã
                    try {
                        const snap = await database.ref(`users/${uid}`).once('value');
                        if (snap.exists()) {
                            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                            return;
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖŸàÿ¨ŸàÿØ:', error);
                        // ŸÜÿ™ÿßÿ®ÿπ ŸÑÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ
                    }
                }

                // ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ
                console.log('üîÑ ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ...');
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                
                const newUserRef = database.ref('users').push();
                uid = newUserRef.key;
                secret = generateRandomKey(10);

                // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ£ŸäÿßŸÖ ÿßŸÑÿ™ÿ¨ÿ±ÿ®ÿ©
                let trialDays = 30; // ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
                try {
                    const appSettingsSnap = await database.ref('appSettings/trialDays').once('value');
                    if (appSettingsSnap.exists()) {
                        trialDays = Number(appSettingsSnap.val());
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ£ŸäÿßŸÖ ÿßŸÑÿ™ÿ¨ÿ±ÿ®ÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©:', error);
                }

                const createdAt = Date.now();
                const trialUntil = createdAt + (trialDays * 24 * 60 * 60 * 1000);

                const userObj = {
                    profile: {
                        uid,
                        secret,
                        fullName,
                        phone,
                        address,
                        storeName,
                        lat: lat || null,
                        lng: lng || null,
                        createdAt,
                        deviceInfo: {
                            platform: navigator.platform || '',
                            userAgent: navigator.userAgent || '',
                            appVersion: localStorage.getItem('app_version') || '2.0.0'
                        }
                    },
                    trialUntil,
                    subscription: null,
                    status: 'active',
                    createdBy: 'desktop_app'
                };

                // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä Firebase
                await database.ref(`users/${uid}`).set(userObj);
                
                // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸäÿßŸã
                localStorage.setItem('app_uid', uid);
                localStorage.setItem('app_secret', secret);
                window.currentUser = userObj;
                window.currentUser.uid = uid;
                
                console.log('‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ®ŸÜÿ¨ÿßÿ≠');
                console.log('üìù UID:', uid);
                
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                
                // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨
                const formElement = document.getElementById('userDetailsForm');
                if (formElement) {
                    formElement.style.display = 'none';
                }
                
                // ÿ•ÿ∏Ÿáÿßÿ± ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ®
                showModal('userInfoModal');
                
                const uidElement = document.getElementById('userUID');
                const secretElement = document.getElementById('userSecret');
                const trialElement = document.getElementById('trialDaysDisplay');
                
                if (uidElement) uidElement.textContent = uid;
                if (secretElement) secretElement.textContent = secret;
                if (trialElement) trialElement.textContent = trialDays;
                
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', error);
                console.error('ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿÆÿ∑ÿ£:', error.message, error.stack);
                
                let errorMessage = 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ®.';
                
                if (error.code === 'PERMISSION_DENIED') {
                    errorMessage = '‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.';
                } else if (error.message && error.message.includes('network')) {
                    errorMessage = '‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ.';
                } else if (error.message) {
                    errorMessage = `‚ö†Ô∏è ÿÆÿ∑ÿ£: ${error.message}`;
                }
                
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                alert(errorMessage + '\n\nÿßŸÑÿ±ÿ¨ÿßÿ°:\n1. ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™\n2. ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ\n3. ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿØÿπŸÖ ÿßŸÑŸÅŸÜŸä: 07813798636');
            }
        };

        async function checkSubscriptionAndGate() {
            const uid = localStorage.getItem('app_uid');
            if (!uid) {
                showActivationModal();
                return false;
            }

            try {
                const userSnap = await database.ref(`users/${uid}`).once('value');
                if (!userSnap.exists()) {
                    showActivationModal();
                    return false;
                }

                const user = userSnap.val();
                const now = Date.now();
                const trialUntil = user.trialUntil;
                const sub = user.subscription;

                if ((sub && sub.validUntil && sub.validUntil > now) || (trialUntil && trialUntil > now)) {
                    window.currentUser = user;
                    window.currentUser.uid = uid;
                    console.log('‚úÖ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿ≥ÿßÿ±Ÿä');
                    return true;
                } else {
                    console.log('‚ö†Ô∏è ÿßŸÜÿ™Ÿáÿ™ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ');
                    showActivationModal();
                    return false;
                }
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ:', error);
                return false;
            }
        }

        // ÿ•ÿ∏Ÿáÿßÿ± ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ
        function showActivationModal() {
            showModal('activationModal');
            // ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ™ÿ®ŸàŸäÿ® ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
            showActivationTab('code');
        }

        // ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ
        function closeActivationModal() {
            closeModal('activationModal');
        }

        // ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ®ŸäŸÜ ÿ™ÿ®ŸàŸäÿ®ÿßÿ™ ÿßŸÑÿ™ŸÅÿπŸäŸÑ
        function showActivationTab(tab) {
            const codeTab = document.getElementById('codeTab');
            const loginTab = document.getElementById('loginTab');
            const codeBtn = document.getElementById('codeTabBtn');
            const loginBtn = document.getElementById('loginTabBtn');

            if (tab === 'code') {
                codeTab.style.display = 'block';
                loginTab.style.display = 'none';
                codeBtn.className = 'btn';
                codeBtn.style.background = 'var(--primary-gradient)';
                loginBtn.className = 'btn btn-secondary';
                loginBtn.style.background = '';
            } else {
                codeTab.style.display = 'none';
                loginTab.style.display = 'block';
                loginBtn.className = 'btn';
                loginBtn.style.background = 'var(--primary-gradient)';
                codeBtn.className = 'btn btn-secondary';
                codeBtn.style.background = '';
            }
        }

        // ÿ™ŸÅÿπŸäŸÑ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ
        async function activateWithCode() {
            const code = document.getElementById('activationCodeInput').value.trim().toUpperCase();
            
            if (!code) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }

            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±

            try {
                await redeemCode(code);
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ŸÅÿπŸäŸÑ:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ UID Ÿà Secret
        async function loginWithCredentials() {
            const uid = document.getElementById('loginUIDInput').value.trim();
            const secret = document.getElementById('loginSecretInput').value.trim();

            if (!uid || !secret) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }

            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±

            try {
                await handleLogin(uid, secret);
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        // ŸÜÿßŸÅÿ∞ÿ© ÿ∑ŸÑÿ® ÿßŸÑÿ™ŸÅÿπŸäŸÑ / ÿØÿÆŸàŸÑ ÿ®ÿ≥Ÿäÿ∑ (ŸÖŸèÿ≠ÿØŸëÿ´ÿ©)
        function showActivationPrompt() {
            showActivationModal();
        }

        async function handleLogin(uid, secret) {
            try {
                const snap = await database.ref(`users/${uid}/profile`).once('value');
                if (!snap.exists()) {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    return;
                }
                const profile = snap.val();
                if (profile.secret !== secret) {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    return;
                }
                
                // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸäÿßŸã
                localStorage.setItem('app_uid', uid);
                localStorage.setItem('app_secret', secret);
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                const userSnap = await database.ref(`users/${uid}`).once('value');
                window.currentUser = userSnap.val();
                window.currentUser.uid = uid;
                
                console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                
                // ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ
                closeActivationModal();
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ÿ®ÿπÿØ ÿ´ÿßŸÜŸäÿ©
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        async function redeemCode(code) {
            try {
                const codeSnap = await database.ref(`subscriptionCodes/${code}`).once('value');
                if (!codeSnap.exists()) {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    return;
                }
                
                const codeData = codeSnap.val();
                if (codeData.used) {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    return;
                }

                const uid = localStorage.getItem('app_uid');
                if (!uid) {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    return;
                }

                const validDays = Number(codeData.days || 30);
                const validUntil = Date.now() + (validDays * 24 * 60 * 60 * 1000);

                await database.ref(`users/${uid}/subscription`).set({
                    type: codeData.type || 'custom',
                    validUntil,
                    activatedByCode: code,
                    activatedAt: Date.now()
                });

                await database.ref(`subscriptionCodes/${code}`).update({
                    used: true,
                    usedBy: uid,
                    usedAt: Date.now()
                });

                console.log('‚úÖ ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿ®ŸÜÿ¨ÿßÿ≠');
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                
                // ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ
                closeActivationModal();
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ÿ®ÿπÿØ ÿ´ÿßŸÜŸäÿ™ŸäŸÜ
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßÿ≥ÿ™ÿ±ÿØÿßÿØ ÿßŸÑÿ±ŸÖÿ≤:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        // ===============================================
        // üß™ ÿØŸàÿßŸÑ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± - TEST FUNCTIONS
        // ===============================================

        /**
         * ÿßÿÆÿ™ÿ®ÿßÿ± ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿ®ÿ¨ÿπŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖŸÜÿ™ŸáŸä ŸÖÿ§ŸÇÿ™ÿßŸã
         * ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ: ÿßŸÅÿ™ÿ≠ Console (F12) ŸàÿßŸÉÿ™ÿ®: testExpiredSubscription()
         */
        window.testExpiredSubscription = async function() {
            console.log('üß™ ÿ®ÿØÿ° ÿßÿÆÿ™ÿ®ÿßÿ± ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ...');
            
            const uid = localStorage.getItem('app_uid');
            if (!uid) {
                console.error('‚ùå ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ');
                alert('ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ±');
                return;
            }

            try {
                // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿµŸÑŸäÿ© ŸÖÿ§ŸÇÿ™ÿßŸã
                const originalSnap = await database.ref(`users/${uid}`).once('value');
                const originalData = originalSnap.val();
                
                console.log('üíæ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿµŸÑŸäÿ© ŸÖÿ§ŸÇÿ™ÿßŸã');
                window._testBackup = originalData;

                // ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÉŸÖŸÜÿ™ŸáŸä
                const yesterday = Date.now() - (24 * 60 * 60 * 1000); // ÿ£ŸÖÿ≥
                
                await database.ref(`users/${uid}`).update({
                    trialUntil: yesterday,
                    subscription: {
                        type: 'expired_test',
                        validUntil: yesterday,
                        activatedAt: yesterday - (30 * 24 * 60 * 60 * 1000)
                    }
                });

                console.log('‚úÖ ÿ™ŸÖ ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÉŸÖŸÜÿ™ŸáŸä');
                console.log('üîÑ ÿ¨ÿßÿ±Ÿä ÿ•ÿπÿßÿØÿ© ŸÅÿ≠ÿµ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ...');
                
                // ÿ•ÿπÿßÿØÿ© ŸÅÿ≠ÿµ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ
                const result = await checkSubscriptionAndGate();
                
                if (!result) {
                    console.log('‚úÖ ÿ™ŸÖ ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!');
                    console.log('üí° ŸÑÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿµŸÑŸäÿ©ÿå ÿßŸÉÿ™ÿ®: restoreOriginalSubscription()');
                }
                
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±:', error);
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±: ' + error.message);
            }
        };

        /**
         * ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿµŸÑŸäÿ© ÿ®ÿπÿØ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±
         * ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ: ÿßŸÅÿ™ÿ≠ Console ŸàÿßŸÉÿ™ÿ®: restoreOriginalSubscription()
         */
        window.restoreOriginalSubscription = async function() {
            if (!window._testBackup) {
                console.warn('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÑÿßÿ≥ÿ™ÿπÿßÿØÿ©');
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÑÿßÿ≥ÿ™ÿπÿßÿØÿ©');
                return;
            }

            const uid = localStorage.getItem('app_uid');
            if (!uid) {
                console.error('‚ùå ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ');
                return;
            }

            try {
                console.log('üîÑ ÿ¨ÿßÿ±Ÿä ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿµŸÑŸäÿ©...');
                
                await database.ref(`users/${uid}`).update({
                    trialUntil: window._testBackup.trialUntil,
                    subscription: window._testBackup.subscription || null
                });

                console.log('‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿµŸÑŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                console.log('üîÑ ÿ¨ÿßÿ±Ÿä ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©...');
                
                delete window._testBackup;
                
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ≥ÿ™ÿπÿßÿØÿ©:', error);
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + error.message);
            }
        };

        /**
         * ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ ŸÖÿ®ÿßÿ¥ÿ±ÿ© (ÿ®ÿØŸàŸÜ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™)
         * ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ: ÿßŸÅÿ™ÿ≠ Console ŸàÿßŸÉÿ™ÿ®: showActivationModalTest()
         */
        window.showActivationModalTest = function() {
            console.log('ü™ü ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ ŸÑŸÑŸÖÿπÿßŸäŸÜÿ©...');
            showActivationModal();
        };

        /**
         * ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≠ÿßŸÑŸäÿ©
         * ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ: ÿßŸÅÿ™ÿ≠ Console ŸàÿßŸÉÿ™ÿ®: checkCurrentSubscription()
         */
        window.checkCurrentSubscription = async function() {
            const uid = localStorage.getItem('app_uid');
            if (!uid) {
                console.error('‚ùå ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ');
                return;
            }

            try {
                const userSnap = await database.ref(`users/${uid}`).once('value');
                if (!userSnap.exists()) {
                    console.error('‚ùå ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                    return;
                }

                const user = userSnap.val();
                const now = Date.now();
                const trialUntil = user.trialUntil;
                const sub = user.subscription;

                console.log('üìä ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≠ÿßŸÑŸäÿ©:');
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.log('üÜî UID:', uid);
                console.log('üìÖ ÿßŸÑÿ¢ŸÜ:', new Date(now).toLocaleString('en-US'));
                console.log('');
                
                if (trialUntil) {
                    const trialDaysLeft = Math.ceil((trialUntil - now) / (1000 * 60 * 60 * 24));
                    console.log('üéÅ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©:');
                    console.log('   ÿ™ŸÜÿ™ŸáŸä ŸÅŸä:', new Date(trialUntil).toLocaleString('en-US'));
                    console.log('   ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©:', trialDaysLeft > 0 ? trialDaysLeft + ' ŸäŸàŸÖ' : 'ŸÖŸÜÿ™ŸáŸäÿ© ‚ùå');
                }
                
                console.log('');
                
                if (sub && sub.validUntil) {
                    const subDaysLeft = Math.ceil((sub.validUntil - now) / (1000 * 60 * 60 * 24));
                    console.log('üíé ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑŸÖÿØŸÅŸàÿπ:');
                    console.log('   ÿßŸÑŸÜŸàÿπ:', sub.type || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ');
                    console.log('   ŸäŸÜÿ™ŸáŸä ŸÅŸä:', new Date(sub.validUntil).toLocaleString('en-US'));
                    console.log('   ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©:', subDaysLeft > 0 ? subDaysLeft + ' ŸäŸàŸÖ' : 'ŸÖŸÜÿ™ŸáŸä ‚ùå');
                    if (sub.activatedByCode) {
                        console.log('   ÿ™ŸÖ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿ®ÿßŸÑÿ±ŸÖÿ≤:', sub.activatedByCode);
                    }
                } else {
                    console.log('üíé ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑŸÖÿØŸÅŸàÿπ: ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                }
                
                console.log('');
                
                const isValid = (sub && sub.validUntil && sub.validUntil > now) || (trialUntil && trialUntil > now);
                console.log('‚úÖ ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©:', isValid ? 'ÿ≥ÿßÿ±Ÿä ‚úì' : 'ŸÖŸÜÿ™ŸáŸä ‚úó');
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÅÿ≠ÿµ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ:', error);
            }
        };

        // ÿ∑ÿ®ÿßÿπÿ© ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ŸÅŸä Console
        console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #667eea; font-weight: bold;');
        console.log('%cüß™ ÿØŸàÿßŸÑ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©:', 'color: #667eea; font-size: 16px; font-weight: bold;');
        console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #667eea; font-weight: bold;');
        console.log('%c1Ô∏è‚É£ testExpiredSubscription()', 'color: #10b981; font-weight: bold;');
        console.log('   ÿ¨ÿπŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖŸÜÿ™ŸáŸä ŸÑÿßÿÆÿ™ÿ®ÿßÿ± ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ');
        console.log('');
        console.log('%c2Ô∏è‚É£ restoreOriginalSubscription()', 'color: #f59e0b; font-weight: bold;');
        console.log('   ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿµŸÑŸäÿ© ÿ®ÿπÿØ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±');
        console.log('');
        console.log('%c3Ô∏è‚É£ showActivationModalTest()', 'color: #8b5cf6; font-weight: bold;');
        console.log('   ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ŸÅÿπŸäŸÑ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÑŸÑŸÖÿπÿßŸäŸÜÿ©');
        console.log('');
        console.log('%c4Ô∏è‚É£ checkCurrentSubscription()', 'color: #06b6d4; font-weight: bold;');
        console.log('   ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≠ÿßŸÑŸä');
        console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #667eea; font-weight: bold;');

        // ===============================================
        // ŸÜŸáÿßŸäÿ© ÿØŸàÿßŸÑ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±
        // ===============================================

        // ÿØŸàÿßŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä
        async function saveProductForCurrentUser(productObj) {
            const uid = localStorage.getItem('app_uid');
            if (!uid) throw new Error('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ•Ÿäÿ¨ÿßÿØ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
            
            const key = database.ref(`users/${uid}/products`).push().key;
            productObj.createdAt = Date.now();
            productObj.product_id = key;
            
            await database.ref(`users/${uid}/products/${key}`).set(productObj);
            
            // ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÜÿ¥ÿßÿ∑
            const actKey = database.ref(`users/${uid}/activities`).push().key;
            await database.ref(`users/${uid}/activities/${actKey}`).set({
                type: 'product_create',
                ref: key,
                productName: productObj.product_name || '',
                createdAt: Date.now()
            });
            
            console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÜÿ™ÿ¨:', key);
            return key;
        }

        async function saveSaleForCurrentUser(saleObj) {
            const uid = localStorage.getItem('app_uid');
            if (!uid) throw new Error('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ•Ÿäÿ¨ÿßÿØ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
            
            const key = database.ref(`users/${uid}/sales`).push().key;
            saleObj.createdAt = Date.now();
            saleObj.sale_id = key;
            
            await database.ref(`users/${uid}/sales/${key}`).set(saleObj);
            
            // ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÜÿ¥ÿßÿ∑
            const actKey = database.ref(`users/${uid}/activities`).push().key;
            await database.ref(`users/${uid}/activities/${actKey}`).set({
                type: 'sale_create',
                ref: key,
                totalAmount: saleObj.total_amount || 0,
                createdAt: Date.now()
            });
            
            console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®Ÿäÿπ:', key);
            return key;
        }

        async function saveDebtForCurrentUser(debtObj) {
            const uid = localStorage.getItem('app_uid');
            if (!uid) throw new Error('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ•Ÿäÿ¨ÿßÿØ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
            
            const key = database.ref(`users/${uid}/debts`).push().key;
            debtObj.createdAt = Date.now();
            debtObj.debt_id = key;
            
            await database.ref(`users/${uid}/debts/${key}`).set(debtObj);
            
            // ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÜÿ¥ÿßÿ∑
            const actKey = database.ref(`users/${uid}/activities`).push().key;
            await database.ref(`users/${uid}/activities/${actKey}`).set({
                type: 'debt_create',
                ref: key,
                customerName: debtObj.customer_name || '',
                totalAmount: debtObj.total_amount || 0,
                createdAt: Date.now()
            });
            
            console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸäŸÜ:', key);
            return key;
        }

        // ‚úÖ ÿØÿßŸÑÿ© ŸÑÿ∂ŸÖÿßŸÜ ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸäŸàŸÜ ŸÅŸä localStorage ÿ®ÿ¥ŸÉŸÑ ÿ•ÿ∂ÿßŸÅŸä
        async function ensureDebtsInLocalStorage() {
            try {
                if (debtsData && debtsData.length > 0) {
                    const debtsToSave = debtsData.map(debt => ({
                        ...debt,
                        type: 'debt'
                    }));
                    
                    // ÿ≠ŸÅÿ∏ ŸÅŸä debtsData
                    localStorage.setItem('debtsData', JSON.stringify(debtsToSave));
                    
                    // ÿ≠ŸÅÿ∏ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÅŸä cached_debts
                    localStorage.setItem('cached_debts', JSON.stringify(debtsToSave));
                    
                    console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸäŸàŸÜ ŸÅŸä localStorage (ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©):', debtsToSave.length);
                } else {
                    console.log('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿØŸäŸàŸÜ ŸÑŸÑÿ≠ŸÅÿ∏');
                }
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸäŸàŸÜ ŸÅŸä localStorage:', error);
            }
        }

        // ‚úÖ ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿØŸäŸàŸÜ ŸÖŸÜ localStorage
        async function loadDebtsFromLocalStorage() {
            try {
                // 1. ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÜ debtsData
                const savedDebts = localStorage.getItem('debtsData');
                if (savedDebts) {
                    const parsed = JSON.parse(savedDebts);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        console.log('‚úÖ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿØŸäŸàŸÜ ŸÅŸä debtsData:', parsed.length);
                        debtsData = parsed.map(d => ({...d, type: 'debt'}));
                    }
                }
                
                // 2. ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÜ cached_debts ŸÉŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
                const cachedDebts = localStorage.getItem('cached_debts');
                if (cachedDebts) {
                    const parsed = JSON.parse(cachedDebts);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        console.log('üì¶ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿØŸäŸàŸÜ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÅŸä cached_debts:', parsed.length);
                        // ÿØŸÖÿ¨ ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÖÿπ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
                        parsed.forEach(debt => {
                            const exists = debtsData.find(d => {
                                const id1 = d.id || d.debt_id || d.__backendId;
                                const id2 = debt.id || debt.debt_id || debt.__backendId;
                                return id1 === id2;
                            });
                            if (!exists) {
                                debtsData.push({...debt, type: 'debt'});
                                console.log('‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿØŸäŸÜ ŸÖŸÜ cached_debts:', debt.customer_name);
                            }
                        });
                    }
                }
                
                console.log(`‚úÖ ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÖÿ≠ŸÖŸÑÿ©: ${debtsData.length}`);
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿØŸäŸàŸÜ ŸÖŸÜ localStorage:', error);
            }
        }

        async function loadUserDataFromFirebase() {
            const uid = localStorage.getItem('app_uid');
            if (!uid) return;

            try {
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
                const productsSnap = await database.ref(`users/${uid}/products`).once('value');
                if (productsSnap.exists()) {
                    const productsObj = productsSnap.val();
                    products = Object.keys(productsObj).map(key => ({
                        ...productsObj[key],
                        product_id: key,
                        type: 'product'
                    }));
                }

                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™
                const salesSnap = await database.ref(`users/${uid}/sales`).once('value');
                if (salesSnap.exists()) {
                    const salesObj = salesSnap.val();
                    salesData = Object.keys(salesObj).map(key => ({
                        ...salesObj[key],
                        sale_id: key,
                        type: 'sale'
                    }));
                }

                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿØŸäŸàŸÜ
                const debtsSnap = await database.ref(`users/${uid}/debts`).once('value');
                if (debtsSnap.exists()) {
                    const debtsObj = debtsSnap.val();
                    debtsData = Object.keys(debtsObj).map(key => ({
                        ...debtsObj[key],
                        debt_id: key,
                        type: 'debt'
                    }));
                }

                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™
                const categoriesSnap = await database.ref(`users/${uid}/categories`).once('value');
                if (categoriesSnap.exists()) {
                    const categoriesObj = categoriesSnap.val();
                    categories = Object.keys(categoriesObj).map(key => ({
                        ...categoriesObj[key],
                        category_id: key,
                        type: 'category'
                    }));
                }

                console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ Firebase');
                updateAllViews();
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
            }
        }

        // ==================== ŸÜŸáÿßŸäÿ© ÿØŸàÿßŸÑ Firebase ====================

        // ==================== ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© ŸÖÿπ Firestore ====================
        
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÅÿ±ŸäÿØ
        function getUserId() {
            let userId = localStorage.getItem('user_id');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('user_id', userId);
            }
            return userId;
        }

        // ÿØÿßŸÑÿ© ÿπÿßŸÖÿ© ŸÑÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä Firestore
        async function syncToFirestore(collection, docId, data) {
            try {
                if (!window.firestore) {
                    console.warn('‚ö†Ô∏è Firestore ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠');
                    return { success: false, error: 'Firestore ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠' };
                }

                const userId = getUserId();
                const docRef = window.firestore
                    .collection('users')
                    .doc(userId)
                    .collection(collection)
                    .doc(docId);

                await docRef.set({
                    ...data,
                    lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: userId
                }, { merge: true });

                console.log(`‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ${collection}/${docId} ŸÅŸä Firestore`);
                return { success: true };
            } catch (error) {
                console.error(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ${collection}:`, error);
                return { success: false, error: error.message };
            }
        }

        // ÿØÿßŸÑÿ© ŸÑÿ≠ÿ∞ŸÅ ŸÖŸÜ Firestore
        async function deleteFromFirestore(collection, docId) {
            try {
                if (!window.firestore) return { success: false };

                const userId = getUserId();
                await window.firestore
                    .collection('users')
                    .doc(userId)
                    .collection(collection)
                    .doc(docId)
                    .delete();

                console.log(`üóëÔ∏è ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${collection}/${docId} ŸÖŸÜ Firestore`);
                return { success: true };
            } catch (error) {
                console.error(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ${collection}:`, error);
                return { success: false, error: error.message };
            }
        }

        // ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
        async function syncProductToFirestore(product) {
            return await syncToFirestore('products', product.id.toString(), {
                id: product.id,
                name: product.name,
                category: product.category,
                category_id: product.category_id,
                barcode: product.barcode,
                price: product.price,
                cost: product.cost,
                stock: product.stock,
                min_stock: product.min_stock,
                unit: product.unit,
                description: product.description,
                image: product.image,
                is_active: product.is_active,
                created_at: product.created_at || new Date().toISOString()
            });
        }

        // ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
        async function syncCategoryToFirestore(category) {
            return await syncToFirestore('categories', category.id.toString(), {
                id: category.id,
                name: category.name,
                description: category.description,
                icon: category.icon,
                color: category.color,
                created_at: category.created_at || new Date().toISOString()
            });
        }

        // ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
        async function syncSaleToFirestore(sale) {
            return await syncToFirestore('sales', sale.invoice_id || sale.id.toString(), {
                id: sale.id,
                invoice_id: sale.invoice_id,
                items: typeof sale.items === 'string' ? sale.items : JSON.stringify(sale.items),
                subtotal: sale.subtotal,
                tax_amount: sale.tax_amount,
                discount: sale.discount,
                discount_amount: sale.discount_amount,
                additional_amount: sale.additional_amount,
                final_total: sale.final_total,
                payment_method: sale.payment_method,
                payment_type: sale.payment_type,
                customer_name: sale.customer_name,
                customer_phone: sale.customer_phone,
                timestamp: sale.timestamp,
                created_at: sale.created_at || new Date().toISOString()
            });
        }

        // ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿØŸäŸàŸÜ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
        async function syncDebtToFirestore(debt) {
            return await syncToFirestore('debts', debt.id.toString(), {
                id: debt.id,
                invoice_id: debt.invoice_id,
                customer_name: debt.customer_name,
                customer_phone: debt.customer_phone,
                customer_address: debt.customer_address,
                total_amount: debt.total_amount,
                paid_amount: debt.paid_amount,
                remaining_amount: debt.remaining_amount,
                monthly_amount: debt.monthly_amount,
                new_monthly_amount: debt.new_monthly_amount,
                installment_months: debt.installment_months,
                installments: debt.installments,
                status: debt.status,
                created_at: debt.created_at,
                next_payment_date: debt.next_payment_date,
                linked_invoices: debt.linked_invoices,
                merge_count: debt.merge_count,
                merge_method: debt.merge_method,
                payment_history: debt.payment_history
            });
        }

        // ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firestore ŸàÿØŸÖÿ¨Ÿáÿß ŸÖÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
        async function fetchFromFirestore(collection) {
            try {
                if (!window.firestore) {
                    console.warn('‚ö†Ô∏è Firestore ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠');
                    return [];
                }

                const userId = getUserId();
                const snapshot = await window.firestore
                    .collection('users')
                    .doc(userId)
                    .collection(collection)
                    .get();

                const data = [];
                snapshot.forEach(doc => {
                    data.push({ ...doc.data(), firestoreId: doc.id });
                });

                console.log(`‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ${data.length} ÿ≥ÿ¨ŸÑ ŸÖŸÜ ${collection}`);
                return data;
            } catch (error) {
                console.error(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ${collection}:`, error);
                return [];
            }
        }

        // ÿØŸÖÿ¨ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿ±ÿ¨ÿπÿ© ŸÖÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© (ÿ®ÿØŸàŸÜ ÿ≠ÿ∞ŸÅ)
        async function mergeDataWithLocal(collection, firestoreData, localDataArray, idField = 'id') {
            console.log(`üîÑ ÿØŸÖÿ¨ ÿ®ŸäÿßŸÜÿßÿ™ ${collection}...`);
            console.log(`üì¶ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©: ${localDataArray.length} ÿ≥ÿ¨ŸÑ`);
            console.log(`‚òÅÔ∏è ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firestore: ${firestoreData.length} ÿ≥ÿ¨ŸÑ`);

            let addedCount = 0;
            let updatedCount = 0;

            for (const firestoreItem of firestoreData) {
                const itemId = firestoreItem[idField];
                const existingIndex = localDataArray.findIndex(item => item[idField] == itemId);

                if (existingIndex === -1) {
                    // ÿπŸÜÿµÿ± ÿ¨ÿØŸäÿØ - ÿ•ÿ∂ÿßŸÅÿ©
                    localDataArray.push(firestoreItem);
                    addedCount++;
                    console.log(`‚ûï ÿ•ÿ∂ÿßŸÅÿ© ${collection}: ${itemId}`);
                } else {
                    // ÿπŸÜÿµÿ± ŸÖŸàÿ¨ŸàÿØ - ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿ£ÿ≠ÿØÿ´
                    const localItem = localDataArray[existingIndex];
                    const localModified = new Date(localItem.lastModified || localItem.created_at || 0);
                    const firestoreModified = new Date(
                        firestoreItem.lastModified?.toDate?.() || 
                        firestoreItem.lastModified || 
                        firestoreItem.created_at || 
                        0
                    );

                    if (firestoreModified > localModified) {
                        localDataArray[existingIndex] = { ...localItem, ...firestoreItem };
                        updatedCount++;
                        console.log(`üîÑ ÿ™ÿ≠ÿØŸäÿ´ ${collection}: ${itemId}`);
                    }
                }
            }

            console.log(`‚úÖ ${collection}: ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ${addedCount} Ÿàÿ™ÿ≠ÿØŸäÿ´ ${updatedCount}`);
            return { added: addedCount, updated: updatedCount };
        }

        // ÿ≠ŸÅÿ∏ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÉÿßŸÖŸÑÿ©
        async function createFullBackup() {
            try {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±

                const userId = getUserId();
                const backupId = 'backup_' + new Date().toISOString().replace(/[:.]/g, '-');

                // ÿ¨ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                const backupData = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    userId: userId,
                    data: {
                        products: await dataSDK.queryByField('type', 'product'),
                        categories: await dataSDK.queryByField('type', 'category'),
                        sales: salesData || [],
                        debts: debtsData || [],
                        settings: {
                            store: JSON.parse(localStorage.getItem('storeSettings') || '{}'),
                            system: JSON.parse(localStorage.getItem('systemSettings') || '{}'),
                            printer: JSON.parse(localStorage.getItem('printerSettings') || '{}'),
                            theme: localStorage.getItem('currentTheme'),
                            customColors: JSON.parse(localStorage.getItem('customColors') || '{}')
                        }
                    }
                };

                // ÿ≠ŸÅÿ∏ ŸÅŸä Firestore
                await window.firestore
                    .collection('users')
                    .doc(userId)
                    .collection('backups')
                    .doc(backupId)
                    .set(backupData);

                console.log('‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©:', backupId);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                
                return { success: true, backupId };
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return { success: false, error: error.message };
            }
        }

        // ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
        async function restoreFromBackup(backupId) {
            try {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±

                const userId = getUserId();
                const backupDoc = await window.firestore
                    .collection('users')
                    .doc(userId)
                    .collection('backups')
                    .doc(backupId)
                    .get();

                if (!backupDoc.exists) {
                    throw new Error('ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
                }

                const backupData = backupDoc.data();
                console.log('üì¶ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿ±ÿ¨ÿπÿ©:', backupData);

                // ÿØŸÖÿ¨ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                let totalAdded = 0;
                let totalUpdated = 0;

                // ÿØŸÖÿ¨ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
                if (backupData.data.products) {
                    const localProducts = await dataSDK.queryByField('type', 'product');
                    const result = await mergeDataWithLocal('products', backupData.data.products, localProducts);
                    totalAdded += result.added;
                    totalUpdated += result.updated;
                    
                    // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿØŸÖŸàÿ¨ÿ©
                    for (const product of localProducts) {
                        await dataSDK.save({ ...product, type: 'product' });
                    }
                }

                // ÿØŸÖÿ¨ ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™
                if (backupData.data.categories) {
                    const localCategories = await dataSDK.queryByField('type', 'category');
                    const result = await mergeDataWithLocal('categories', backupData.data.categories, localCategories);
                    totalAdded += result.added;
                    totalUpdated += result.updated;
                    
                    for (const category of localCategories) {
                        await dataSDK.save({ ...category, type: 'category' });
                    }
                }

                // ÿØŸÖÿ¨ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™
                if (backupData.data.sales) {
                    salesData = salesData || [];
                    const result = await mergeDataWithLocal('sales', backupData.data.sales, salesData, 'invoice_id');
                    totalAdded += result.added;
                    totalUpdated += result.updated;
                }

                // ÿØŸÖÿ¨ ÿßŸÑÿØŸäŸàŸÜ
                if (backupData.data.debts) {
                    debtsData = debtsData || [];
                    const result = await mergeDataWithLocal('debts', backupData.data.debts, debtsData);
                    totalAdded += result.added;
                    totalUpdated += result.updated;
                }

                // ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä - ŸäŸÖŸÉŸÜ ÿ™ÿÆÿ∑ŸäŸá)
                if (backupData.data.settings && confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿ£Ÿäÿ∂ÿßŸãÿü')) {
                    if (backupData.data.settings.store) {
                        localStorage.setItem('storeSettings', JSON.stringify(backupData.data.settings.store));
                    }
                    if (backupData.data.settings.system) {
                        localStorage.setItem('systemSettings', JSON.stringify(backupData.data.settings.system));
                    }
                    if (backupData.data.settings.printer) {
                        localStorage.setItem('printerSettings', JSON.stringify(backupData.data.settings.printer));
                    }
                    if (backupData.data.settings.theme) {
                        localStorage.setItem('currentTheme', backupData.data.settings.theme);
                    }
                    if (backupData.data.settings.customColors) {
                        localStorage.setItem('customColors', JSON.stringify(backupData.data.settings.customColors));
                    }
                }

                console.log('‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
                if (confirm('ÿ™ŸÖ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿ®ŸÜÿ¨ÿßÿ≠! ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©ÿü')) {
                    location.reload();
                }

                return { success: true, added: totalAdded, updated: totalUpdated };
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return { success: false, error: error.message };
            }
        }

        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
        async function getBackupsList() {
            try {
                const userId = getUserId();
                const snapshot = await window.firestore
                    .collection('users')
                    .doc(userId)
                    .collection('backups')
                    .orderBy('timestamp', 'desc')
                    .get();

                const backups = [];
                snapshot.forEach(doc => {
                    backups.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                return backups;
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©:', error);
                return [];
            }
        }

        // ==================== ŸÜŸáÿßŸäÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ====================

        // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
        function updateLoaderStatus(message) {
            const statusEl = document.getElementById('loaderStatus');
            if (statusEl) {
                statusEl.textContent = message;
            }
            console.log('üìä', message);
        }

        /* ============================================
           ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ≠ŸÖÿßŸäÿ© ŸàÿßŸÑÿ£ŸÖÿßŸÜ ÿßŸÑŸÖÿ™ŸÉÿßŸÖŸÑ
           Digital Creativity - Kraar Al-Shaabari
           ============================================ */

        // ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ£ŸÖÿßŸÜ ŸàÿßŸÑŸÖÿµÿßÿØŸÇÿ©
        class SecurityManager {
            constructor() {
                this.currentUser = null;
                this.users = [];
                this.auditLog = []; // ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™
                this.init();
            }
            
            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä
            getCurrentUsername() {
                return this.currentUser ? this.currentUser.username : 'ŸÜÿ∏ÿßŸÖ';
            }
            
            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            getCurrentUserFullName() {
                return this.currentUser ? this.currentUser.name : 'ÿßŸÑŸÜÿ∏ÿßŸÖ';
            }
            
            // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπŸÖŸÑŸäÿ© ŸÅŸä ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©
            logOperation(action, details = {}) {
                const logEntry = {
                    id: 'log_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    timestamp: new Date().toISOString(),
                    user: this.getCurrentUsername(),
                    userName: this.getCurrentUserFullName(),
                    userRole: this.currentUser ? this.currentUser.role : 'system',
                    action: action,
                    details: details
                };
                
                this.auditLog.push(logEntry);
                
                // ÿ≠ŸÅÿ∏ ÿßŸÑÿ≥ÿ¨ŸÑ ŸÅŸä localStorage
                try {
                    // ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿ¢ÿÆÿ± 1000 ÿπŸÖŸÑŸäÿ© ŸÅŸÇÿ∑
                    if (this.auditLog.length > 1000) {
                        this.auditLog = this.auditLog.slice(-1000);
                    }
                    localStorage.setItem('audit_log', JSON.stringify(this.auditLog));
                } catch (error) {
                    console.warn('ÿ™ÿ≠ÿ∞Ÿäÿ±: ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ŸÅÿ∏ ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™', error);
                }
                
                console.log('üìù ÿπŸÖŸÑŸäÿ© ÿ¨ÿØŸäÿØÿ©:', action, 'ÿ®Ÿàÿßÿ≥ÿ∑ÿ©:', this.getCurrentUserFullName());
                
                return logEntry;
            }
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™
            loadAuditLog() {
                try {
                    const savedLog = localStorage.getItem('audit_log');
                    if (savedLog) {
                        this.auditLog = JSON.parse(savedLog);
                    }
                } catch (error) {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™:', error);
                    this.auditLog = [];
                }
            }

            init() {
                console.log('üîê ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ£ŸÖÿßŸÜ...');
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™
                this.loadAuditLog();
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÖŸÜ localStorage
                const savedUsers = localStorage.getItem('app_users');
                if (savedUsers) {
                    try {
                        this.users = JSON.parse(savedUsers);
                        console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ:', this.users.length, 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ');
                    } catch (error) {
                        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜÿå ÿ≥Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ');
                        this.createDefaultAdmin();
                    }
                } else {
                    console.log('üìù ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä...');
                    this.createDefaultAdmin();
                }

                console.log('üë• ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸàŸÜ ÿßŸÑŸÖÿ™ÿßÿ≠ŸàŸÜ:');
                this.users.forEach(u => {
                    console.log(`  - ${u.username} (${u.role}) - ${u.active ? 'ŸÜÿ¥ÿ∑' : 'ŸÖÿπÿ∑ŸÑ'}`);
                });

                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ¨ŸÑÿ≥ÿ© ŸÜÿ¥ÿ∑ÿ©
                const sessionUser = sessionStorage.getItem('current_user');
                if (sessionUser) {
                    this.currentUser = JSON.parse(sessionUser);
                    this.startInactivityTimer();
                    console.log('‚úÖ ÿ¨ŸÑÿ≥ÿ© ŸÜÿ¥ÿ∑ÿ©:', this.currentUser.username);
                    
                    // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ÿßŸÑÿ¨ŸÑÿ≥ÿ©
                    this.logOperation('ÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ÿßŸÑÿ¨ŸÑÿ≥ÿ©', { username: this.currentUser.username });
                }
            }

            createDefaultAdmin() {
                this.users = [{
                    id: '1',
                    username: 'admin',
                    password: 'admin123',
                    name: 'ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿπÿßŸÖ',
                    role: 'admin',
                    active: true,
                    permissions: this.getAllPermissions(),
                    created_at: new Date().toISOString()
                }];
                this.saveUsers();
                console.log('‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿØŸäÿ±: admin / admin123');
            }

            getAllPermissions() {
                return {
                    // Dashboard
                    dashboard_products_count: true,
                    dashboard_inventory_value: true,
                    dashboard_debts_count: true,
                    dashboard_debts_value: true,
                    dashboard_revenue: true,
                    dashboard_profit: true,

                    // ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä
                    sidebar_pos: true,
                    sidebar_invoices: true,
                    sidebar_products: true,
                    sidebar_inventory: true,
                    sidebar_debts: true,
                    sidebar_reports: true,
                    sidebar_printer: true,
                    sidebar_settings: true,

                    // ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿßÿ™
                    sales_view: true,
                    products_view: true,
                    inventory_view: true,
                    debts_view: true,
                    reports_view: true,
                    settings_view: true,

                    // ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
                    products_add: true,
                    products_edit: true,
                    products_delete: true,
                    products_export: true,
                    products_import: true,
                    products_add_category: true,
                    products_stock_management: true,

                    // ÿßŸÑŸÖÿÆÿ≤ŸÜ
                    inventory_add: true,
                    inventory_edit: true,
                    inventory_delete: true,
                    inventory_adjust: true,
                    inventory_history: true,
                    inventory_export: true,

                    // ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ
                    pos_access: true,
                    pos_sell: true,
                    pos_add_to_cart: true,
                    pos_installment: true,
                    pos_discount: true,
                    pos_print: true,
                    pos_cancel: true,

                    // ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
                    invoices_view: true,
                    invoices_delete: true,
                    invoices_export: true,

                    // ÿßŸÑÿØŸäŸàŸÜ
                    debts_view_details: true,
                    debts_payment: true,
                    debts_delete: true,
                    debts_export: true,
                    debts_reminders: true,

                    // ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±
                    reports_sales: true,
                    reports_inventory: true,
                    reports_debts: true,
                    reports_profit: true,
                    reports_export: true,

                    // ÿßŸÑÿ∑ÿßÿ®ÿπÿ© ŸàÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
                    printer_configure: true,
                    printer_test: true,
                    settings_edit: true,
                    settings_backup: true,
                    settings_restore: true
                };
            }

            // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
            saveUsers() {
                localStorage.setItem('app_users', JSON.stringify(this.users));
            }

            // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
            login(username, password) {
                console.log('üîç ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä ÿßŸÑŸÇÿßÿπÿØÿ©...');
                console.log('   ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÖÿØÿÆŸÑ:', username);
                console.log('   ÿπÿØÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÉŸÑŸä:', this.users.length);
                
                // ÿ∑ÿ®ÿßÿπÿ© ÿ™ŸÅÿßÿµŸäŸÑ ŸÉŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑŸÑŸÖŸÇÿßÿ±ŸÜÿ©
                this.users.forEach((u, index) => {
                    console.log(`   [${index}] username: "${u.username}", active: ${u.active}`);
                });
                
                const user = this.users.find(u => 
                    u.username === username && 
                    u.password === password && 
                    u.active
                );

                if (user) {
                    console.log('‚úÖ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', user.name);
                    this.currentUser = user;
                    sessionStorage.setItem('current_user', JSON.stringify(user));
                    sessionStorage.setItem('is_logged_in', 'true');
                    sessionStorage.setItem('login_time', new Date().toISOString());
                    this.startInactivityTimer();
                    
                    // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπŸÖŸÑŸäÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                    this.logOperation('ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ', { 
                        username: username,
                        role: user.role,
                        loginTime: new Date().toISOString()
                    });
                    
                    return { success: true, user };
                }

                console.error('‚ùå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
                console.log('   ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ:');
                console.log('   - ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿµÿ≠Ÿäÿ≠ÿü');
                console.log('   - ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿµÿ≠Ÿäÿ≠ÿ©ÿü');
                console.log('   - ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÜÿ¥ÿ∑ÿü');
                
                // ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ŸÅÿßÿ¥ŸÑÿ©
                this.auditLog.push({
                    id: 'log_' + Date.now(),
                    timestamp: new Date().toISOString(),
                    user: username,
                    userName: 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ',
                    userRole: 'unknown',
                    action: 'ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ŸÅÿßÿ¥ŸÑÿ©',
                    details: { username: username }
                });
                
                return { success: false, message: 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£Ÿà ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©' };
            }

            // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
            logout() {
                // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπŸÖŸÑŸäÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÇÿ®ŸÑ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                const username = this.currentUser ? this.currentUser.username : 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                this.logOperation('ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨', { username: username });
                
                this.currentUser = null;
                sessionStorage.removeItem('current_user');
                sessionStorage.removeItem('is_logged_in');
                sessionStorage.removeItem('login_time');
                this.stopInactivityTimer();
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
                window.location.reload();
            }

            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©
            hasPermission(permission) {
                if (!this.currentUser) return false;
                if (this.currentUser.role === 'admin') return true;
                return this.currentUser.permissions && this.currentUser.permissions[permission] === true;
            }

            // ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
            addUser(userData) {
                const newUser = {
                    id: Date.now().toString(),
                    ...userData,
                    created_at: new Date().toISOString(),
                    active: true
                };
                this.users.push(newUser);
                this.saveUsers();
                return { success: true, user: newUser };
            }

            updateUser(userId, userData) {
                const index = this.users.findIndex(u => u.id === userId);
                if (index !== -1) {
                    this.users[index] = { ...this.users[index], ...userData };
                    this.saveUsers();
                    
                    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸà ŸÜŸÅÿ≥Ÿá
                    if (this.currentUser && this.currentUser.id === userId) {
                        this.currentUser = this.users[index];
                        sessionStorage.setItem('current_user', JSON.stringify(this.currentUser));
                    }
                    
                    return { success: true, user: this.users[index] };
                }
                return { success: false, message: 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ' };
            }

            deleteUser(userId) {
                // ŸÖŸÜÿπ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä
                const user = this.users.find(u => u.id === userId);
                if (user && user.id === '1') {
                    return { success: false, message: 'ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä' };
                }

                const index = this.users.findIndex(u => u.id === userId);
                if (index !== -1) {
                    this.users.splice(index, 1);
                    this.saveUsers();
                    return { success: true };
                }
                return { success: false, message: 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ' };
            }

            toggleUserStatus(userId) {
                // ŸÖŸÜÿπ ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä
                const user = this.users.find(u => u.id === userId);
                if (user && user.id === '1') {
                    return { success: false, message: 'ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä' };
                }

                const index = this.users.findIndex(u => u.id === userId);
                if (index !== -1) {
                    this.users[index].active = !this.users[index].active;
                    this.saveUsers();
                    return { success: true, user: this.users[index] };
                }
                return { success: false, message: 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ' };
            }

            getUsers() {
                return this.users;
            }

            // ŸÖÿ§ŸÇÿ™ ÿπÿØŸÖ ÿßŸÑŸÜÿ¥ÿßÿ∑
            startInactivityTimer() {
                this.stopInactivityTimer();
                this.inactivityTimer = setTimeout(() => {
                    alert('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ÿ≥ÿ®ÿ® ÿπÿØŸÖ ÿßŸÑŸÜÿ¥ÿßÿ∑');
                    this.logout();
                }, 30 * 60 * 1000); // 30 ÿØŸÇŸäŸÇÿ©
            }

            stopInactivityTimer() {
                if (this.inactivityTimer) {
                    clearTimeout(this.inactivityTimer);
                    this.inactivityTimer = null;
                }
            }

            // ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑ ŸÖÿ§ŸÇÿ™ ÿπÿØŸÖ ÿßŸÑŸÜÿ¥ÿßÿ∑
            resetInactivityTimer() {
                if (this.currentUser) {
                    this.startInactivityTimer();
                }
            }

            // ÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
            showLoginPage() {
                const loginOverlay = document.getElementById('loginOverlay');
                if (loginOverlay) {
                    loginOverlay.style.display = 'flex';
                }
            }

            // ÿ•ÿÆŸÅÿßÿ° ÿµŸÅÿ≠ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
            hideLoginPage() {
                const loginOverlay = document.getElementById('loginOverlay');
                if (loginOverlay) {
                    loginOverlay.style.display = 'none';
                }
            }

            // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÖŸÜ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨
            handleLogin() {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value;

                console.log('üîë ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ:', username);

                if (!username || !password) {
                    alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸàŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±');
                    return;
                }

                console.log('üìã ÿπÿØÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖÿ™ÿßÿ≠ŸäŸÜ:', this.users.length);
                console.log('üë§ ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ≥ÿ™ÿÆÿØŸÖ:', username);

                const result = this.login(username, password);
                
                console.log('üìä ŸÜÿ™Ÿäÿ¨ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ:', result);

                if (result.success) {
                    console.log('‚úÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÜÿßÿ¨ÿ≠!');
                    this.hideLoginPage();
                    this.applyPermissions();
                    this.updateSidebarButtons();
                    
                    // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                    if (typeof loadAllData === 'function') {
                        loadAllData();
                    }
                    
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                } else {
                    console.error('‚ùå ŸÅÿ¥ŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ:', result.message);
                    alert(result.message);
                }
            }

            // ŸÅÿ™ÿ≠ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ£ŸÖÿßŸÜ
            openSecurityPanel() {
                if (!this.currentUser || this.currentUser.role !== 'admin') {
                    alert('Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑŸÖÿØŸäÿ±ŸäŸÜ ŸÅŸÇÿ∑');
                    return;
                }

                const panel = document.getElementById('securityPanel');
                if (panel) {
                    panel.classList.add('active');
                    this.loadUsersTable();
                }
            }

            // ÿ•ÿ∫ŸÑÿßŸÇ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ£ŸÖÿßŸÜ
            closeSecurityPanel() {
                const panel = document.getElementById('securityPanel');
                if (panel) {
                    panel.classList.remove('active');
                }
            }

            // ÿ™ÿ®ÿØŸäŸÑ ÿπŸÑÿßŸÖÿßÿ™ ÿßŸÑÿ™ÿ®ŸàŸäÿ®
            switchSecurityTab(tab) {
                // ÿ•ÿÆŸÅÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ÿ™ŸàŸäÿßÿ™
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                });

                // ÿ•ÿ≤ÿßŸÑÿ© active ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
                document.querySelectorAll('.security-tab').forEach(btn => {
                    btn.classList.remove('active');
                });

                // ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®
                const content = document.getElementById(tab + 'Tab');
                if (content) {
                    content.style.display = 'block';
                }

                // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≤ÿ±
                const btn = document.querySelector(`.security-tab[onclick*="${tab}"]`);
                if (btn) {
                    btn.classList.add('active');
                }
            }

            // ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
            loadUsersTable() {
                const tbody = document.getElementById('usersTableBody');
                if (!tbody) return;

                tbody.innerHTML = '';
                this.users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.username}</td>
                        <td><span class="user-badge badge-${user.role}">${user.role === 'admin' ? 'ŸÖÿØŸäÿ±' : 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ'}</span></td>
                        <td><span class="status-${user.active ? 'active' : 'inactive'}">${user.active ? 'ŸÜÿ¥ÿ∑' : 'ŸÖÿπÿ∑ŸÑ'}</span></td>
                        <td>${new Date(user.created_at).toLocaleDateString('en-GB')}</td>
                        <td>
                            <button class="action-btn btn-edit" onclick="window.securityManager.editUser('${user.id}')">
                                <i class="fas fa-edit"></i> ÿ™ÿπÿØŸäŸÑ
                            </button>
                            ${user.id !== '1' ? `
                                <button class="action-btn btn-delete" onclick="window.securityManager.deleteUserConfirm('${user.id}')">
                                    <i class="fas fa-trash"></i> ÿ≠ÿ∞ŸÅ
                                </button>
                            ` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // ŸÅÿ™ÿ≠ ŸÜŸÖŸàÿ∞ÿ¨ ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ
            openUserModal(userId = null) {
                const modal = document.getElementById('userModal');
                const modalTitle = document.getElementById('userModalTitle');
                const form = document.getElementById('userForm');
                
                if (!modal || !modalTitle || !form) return;

                form.reset();
                document.getElementById('userId').value = '';

                if (userId) {
                    // Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿπÿØŸäŸÑ
                    const user = this.users.find(u => u.id === userId);
                    if (user) {
                        modalTitle.textContent = 'ÿ™ÿπÿØŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ';
                        document.getElementById('userId').value = user.id;
                        document.getElementById('userName').value = user.name;
                        document.getElementById('userUsername').value = user.username;
                        document.getElementById('userRole').value = user.role;
                        
                        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
                        this.loadUserPermissions(user.permissions || {});
                    }
                } else {
                    // Ÿàÿ∂ÿπ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©
                    modalTitle.textContent = 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ';
                    this.loadUserPermissions(this.getAllPermissions());
                }

                modal.classList.add('active');
            }

            closeUserModal() {
                const modal = document.getElementById('userModal');
                if (modal) {
                    modal.classList.remove('active');
                }
            }

            // ÿ™ÿ≠ŸÖŸäŸÑ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨
            loadUserPermissions(permissions) {
                Object.keys(permissions).forEach(key => {
                    const checkbox = document.getElementById('perm_' + key);
                    if (checkbox) {
                        checkbox.checked = permissions[key] === true;
                    }
                });
            }

            // ÿ¨ŸÖÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ŸÖŸÜ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨
            getPermissionsFromForm() {
                const permissions = {};
                const allPermissions = this.getAllPermissions();
                
                Object.keys(allPermissions).forEach(key => {
                    const checkbox = document.getElementById('perm_' + key);
                    if (checkbox) {
                        permissions[key] = checkbox.checked;
                    }
                });
                
                return permissions;
            }

            // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            saveUser() {
                const userId = document.getElementById('userId').value;
                const name = document.getElementById('userName').value.trim();
                const username = document.getElementById('userUsername').value.trim();
                const password = document.getElementById('userPassword').value;
                const role = document.getElementById('userRole').value;

                if (!name || !username) {
                    alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿßÿ≥ŸÖ Ÿàÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
                    return;
                }

                if (!userId && !password) {
                    alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ¨ÿØŸäÿØ');
                    return;
                }

                const permissions = this.getPermissionsFromForm();

                const userData = {
                    name,
                    username,
                    role,
                    permissions
                };

                if (password) {
                    userData.password = password;
                }

                let result;
                if (userId) {
                    result = this.updateUser(userId, userData);
                } else {
                    result = this.addUser(userData);
                }

                if (result.success) {
                    this.closeUserModal();
                    this.loadUsersTable();
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                } else {
                    alert(result.message);
                }
            }

            // ÿ™ÿπÿØŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ
            editUser(userId) {
                this.openUserModal(userId);
            }

            // ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ∞ŸÅ ŸÖÿ≥ÿ™ÿÆÿØŸÖ
            deleteUserConfirm(userId) {
                if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿü')) {
                    const result = this.deleteUser(userId);
                    if (result.success) {
                        this.loadUsersTable();
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    } else {
                        alert(result.message);
                    }
                }
            }

            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿπŸÑŸâ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
            applyPermissions() {
                if (!this.currentUser) return;

                console.log('üîê ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑÿ¥ÿßŸÖŸÑÿ© ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', this.currentUser.username);
                console.log('üìã ÿßŸÑÿØŸàÿ±:', this.currentUser.role);

                // Dashboard Stats - ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
                this.toggleElement('quickTotalProducts', 'dashboard_products_count');
                this.toggleElement('quickInventoryValue', 'dashboard_inventory_value');
                this.toggleElement('quickTotalDebts', 'dashboard_debts_count');
                this.toggleElement('quickDebtsValue', 'dashboard_debts_value');

                // Sidebar - ÿßŸÑŸÇŸàÿßÿ¶ŸÖ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©
                this.toggleElement('posNavItem', 'sidebar_pos');
                this.toggleElement('invoicesNavItem', 'sidebar_invoices');
                this.toggleElement('productsNavItem', 'sidebar_products');
                this.toggleElement('inventoryNavItem', 'sidebar_inventory');
                this.toggleElement('debtsNavItem', 'sidebar_debts');
                this.toggleElement('reportsNavItem', 'sidebar_reports');
                this.toggleElement('printerNavItem', 'sidebar_printer');
                this.toggleElement('settingsNavItem', 'sidebar_settings');

                // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÜÿßÿµÿ± ÿßŸÑÿ™Ÿä ŸÑŸáÿß data-permission
                this.applyPermissionsToElements();
                
                // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿπŸÜÿßÿµÿ± ÿßŸÑÿØŸäŸÜÿßŸÖŸäŸÉŸäÿ©
                this.applyDynamicPermissions();
                
                console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
            }

            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿπŸÜÿßÿµÿ± ÿßŸÑÿØŸäŸÜÿßŸÖŸäŸÉŸäÿ©
            applyDynamicPermissions() {
                // ÿ•ÿπÿßÿØÿ© ÿ±ÿ≥ŸÖ ÿßŸÑÿ¨ÿØÿßŸàŸÑ ŸÖÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
                if (typeof renderProductsTable === 'function') {
                    setTimeout(() => renderProductsTable(), 100);
                }
                
                if (typeof renderDebtsTable === 'function') {
                    setTimeout(() => renderDebtsTable(), 100);
                }
                
                if (typeof renderInvoicesTable === 'function') {
                    setTimeout(() => renderInvoicesTable(), 100);
                }
                
                if (typeof renderInventoryTable === 'function') {
                    setTimeout(() => renderInventoryTable(), 100);
                }
            }

            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÜÿßÿµÿ±
            applyPermissionsToElements() {
                // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÜÿßÿµÿ± ÿßŸÑÿ™Ÿä ŸÑŸáÿß data-permission
                const elements = document.querySelectorAll('[data-permission]');
                console.log(`üîç ÿπÿØÿØ ÿßŸÑÿπŸÜÿßÿµÿ± ÿßŸÑŸÖÿ≠ŸÖŸäÿ©: ${elements.length}`);
                
                let hiddenCount = 0;
                let shownCount = 0;
                
                elements.forEach(element => {
                    const permission = element.getAttribute('data-permission');
                    
                    // ŸÑŸÑŸÖÿ™ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖÿ™ÿπÿØÿØÿ© (ŸÖÿ´ŸÑ: perm1,perm2)
                    const permissions = permission.split(',').map(p => p.trim());
                    
                    // Ÿäÿ≠ÿ™ÿßÿ¨ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿ£Ÿà Ÿàÿßÿ≠ÿØÿ© ŸÖŸÜŸáÿßÿü
                    const requireAll = element.getAttribute('data-require-all') === 'true';
                    
                    let hasAccess = false;
                    if (requireAll) {
                        // Ÿäÿ≠ÿ™ÿßÿ¨ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
                        hasAccess = permissions.every(perm => this.hasPermission(perm));
                    } else {
                        // Ÿäÿ≠ÿ™ÿßÿ¨ ÿ£Ÿä ÿµŸÑÿßÿ≠Ÿäÿ© Ÿàÿßÿ≠ÿØÿ©
                        hasAccess = permissions.some(perm => this.hasPermission(perm));
                    }
                    
                    if (hasAccess) {
                        element.style.display = '';
                        element.disabled = false;
                        element.classList.remove('permission-hidden');
                        shownCount++;
                    } else {
                        element.style.display = 'none';
                        element.disabled = true;
                        element.classList.add('permission-hidden');
                        hiddenCount++;
                    }
                });
                
                console.log(`  ‚úÖ ÿπŸÜÿßÿµÿ± ŸÖÿ±ÿ¶Ÿäÿ©: ${shownCount}`);
                console.log(`  ‚ùå ÿπŸÜÿßÿµÿ± ŸÖÿÆŸÅŸäÿ©: ${hiddenCount}`);
            }

            toggleElement(elementId, permission) {
                const element = document.getElementById(elementId);
                if (element) {
                    const hasAccess = this.hasPermission(permission);
                    element.style.display = hasAccess ? '' : 'none';
                    
                    if (!hasAccess) {
                        element.disabled = true;
                    }
                }
            }

            // ŸÅÿ≠ÿµ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ© ŸÇÿ®ŸÑ ÿ™ŸÜŸÅŸäÿ∞ ÿ£Ÿä ÿπŸÖŸÑŸäÿ©
            checkPermission(permission, showAlert = true) {
                if (!this.currentUser) {
                    if (showAlert) alert('Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
                    console.warn('‚ö†Ô∏è ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑŸàÿµŸàŸÑ ÿ®ÿØŸàŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ');
                    return false;
                }

                if (this.currentUser.role === 'admin') {
                    return true;
                }

                const hasAccess = this.hasPermission(permission);
                
                if (!hasAccess) {
                    if (showAlert) {
                        alert('ÿπÿ∞ÿ±ÿßŸãÿå ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ™ŸÜŸÅŸäÿ∞ Ÿáÿ∞Ÿá ÿßŸÑÿπŸÖŸÑŸäÿ©');
                    }
                    
                    // ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑŸàÿµŸàŸÑ ÿßŸÑŸÖÿ±ŸÅŸàÿ∂ÿ©
                    this.logOperation('ŸÖÿ≠ÿßŸàŸÑÿ© ŸàÿµŸàŸÑ ŸÖÿ±ŸÅŸàÿ∂ÿ©', {
                        permission: permission,
                        username: this.currentUser.username
                    });
                    
                    console.warn(`‚õî ŸÖÿ≠ÿßŸàŸÑÿ© ŸàÿµŸàŸÑ ŸÖÿ±ŸÅŸàÿ∂ÿ©: ${permission} ŸÖŸÜ ŸÇÿ®ŸÑ ${this.currentUser.username}`);
                }

                return hasAccess;
            }
            
            // ŸÅÿ≠ÿµ ŸÖÿ™ÿπÿØÿØ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ (Ÿäÿ≠ÿ™ÿßÿ¨ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™)
            checkMultiplePermissions(permissions, showAlert = true) {
                if (!Array.isArray(permissions)) {
                    permissions = [permissions];
                }
                
                for (const permission of permissions) {
                    if (!this.checkPermission(permission, false)) {
                        if (showAlert) {
                            alert(`ÿπÿ∞ÿ±ÿßŸãÿå ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿµŸÑÿßÿ≠Ÿäÿ©: ${permission}`);
                        }
                        return false;
                    }
                }
                
                return true;
            }
            
            // ŸÅÿ≠ÿµ ÿ£Ÿä ÿµŸÑÿßÿ≠Ÿäÿ© (Ÿäÿ≠ÿ™ÿßÿ¨ Ÿàÿßÿ≠ÿØÿ© ŸÅŸÇÿ∑ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™)
            checkAnyPermission(permissions, showAlert = true) {
                if (!Array.isArray(permissions)) {
                    permissions = [permissions];
                }
                
                for (const permission of permissions) {
                    if (this.checkPermission(permission, false)) {
                        return true;
                    }
                }
                
                if (showAlert) {
                    alert('ÿπÿ∞ÿ±ÿßŸãÿå ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿ£Ÿä ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©');
                }
                
                return false;
            }
            
            // ŸÅÿ≠ÿµ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÇÿ±ÿßÿ°ÿ© ŸÅŸÇÿ∑ (view only)
            isViewOnly(module) {
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ adminÿå ŸÅŸÑŸäÿ≥ view only
                if (this.currentUser && this.currentUser.role === 'admin') {
                    return false;
                }
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸàÿ≠ÿØÿ©
                const viewPermissions = {
                    'products': 'products_view',
                    'debts': 'debts_view',
                    'inventory': 'inventory_view',
                    'sales': 'sales_view'
                };
                
                const editPermissions = {
                    'products': ['products_add', 'products_edit', 'products_delete'],
                    'debts': ['debts_payment', 'debts_delete'],
                    'inventory': ['inventory_add', 'inventory_edit', 'inventory_delete'],
                    'sales': ['pos_sell']
                };
                
                const viewPerm = viewPermissions[module];
                const editPerms = editPermissions[module];
                
                // ŸÑŸá ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿπÿ±ÿ∂
                const hasView = this.hasPermission(viewPerm);
                
                // ŸÑŸá ÿ£Ÿä ÿµŸÑÿßÿ≠Ÿäÿ© ÿ™ÿπÿØŸäŸÑÿü
                let hasEdit = false;
                if (editPerms) {
                    hasEdit = editPerms.some(perm => this.hasPermission(perm));
                }
                
                // view only = ŸÑŸá ÿµŸÑÿßÿ≠Ÿäÿ© ÿπÿ±ÿ∂ ŸÑŸÉŸÜ ŸÑŸäÿ≥ ŸÑŸá ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿ™ÿπÿØŸäŸÑ
                return hasView && !hasEdit;
            }

            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä
            getCurrentUser() {
                return this.currentUser;
            }

            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä
            getCurrentUsername() {
                return this.currentUser ? this.currentUser.username : 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
            }

            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÉÿßŸÖŸÑ
            getCurrentUserFullName() {
                return this.currentUser ? this.currentUser.name : 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
            }

            // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπŸÖŸÑŸäÿ© (Audit Trail)
            logActivity(activity) {
                const log = {
                    timestamp: new Date().toISOString(),
                    username: this.getCurrentUsername(),
                    fullName: this.getCurrentUserFullName(),
                    role: this.currentUser ? this.currentUser.role : 'unknown',
                    action: activity.action || 'unknown',
                    module: activity.module || 'general',
                    details: activity.details || {},
                    description: activity.description || ''
                };

                // ÿ≠ŸÅÿ∏ ÿßŸÑÿ≥ÿ¨ŸÑ
                const logs = JSON.parse(localStorage.getItem('activity_logs') || '[]');
                logs.push(log);
                
                // ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿ¢ÿÆÿ± 1000 ÿ≥ÿ¨ŸÑ ŸÅŸÇÿ∑
                if (logs.length > 1000) {
                    logs.shift();
                }
                
                localStorage.setItem('activity_logs', JSON.stringify(logs));
                
                console.log('üìù ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ©:', log);
                
                return log;
            }

            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™
            getActivityLogs(filters = {}) {
                const logs = JSON.parse(localStorage.getItem('activity_logs') || '[]');
                
                if (filters.username) {
                    return logs.filter(log => log.username === filters.username);
                }
                
                if (filters.module) {
                    return logs.filter(log => log.module === filters.module);
                }
                
                if (filters.startDate && filters.endDate) {
                    return logs.filter(log => {
                        const logDate = new Date(log.timestamp);
                        return logDate >= filters.startDate && logDate <= filters.endDate;
                    });
                }
                
                return logs;
            }

            // ÿ™ÿ≠ÿØŸäÿ´ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä
            updateSidebarButtons() {
                const securityBtn = document.getElementById('securityNavItem');
                const logoutBtn = document.getElementById('logoutNavItem');

                if (this.currentUser) {
                    if (logoutBtn) logoutBtn.style.display = '';
                    
                    if (this.currentUser.role === 'admin') {
                        if (securityBtn) securityBtn.style.display = '';
                    } else {
                        if (securityBtn) securityBtn.style.display = 'none';
                    }
                } else {
                    if (securityBtn) securityBtn.style.display = 'none';
                    if (logoutBtn) logoutBtn.style.display = 'none';
                }
            }
        }

        // ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ£ŸÖÿßŸÜ ÿßŸÑÿπÿßŸÖ
        window.securityManager = new SecurityManager();

        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        window.addEventListener('DOMContentLoaded', () => {
            // ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑ ŸÖÿ§ŸÇÿ™ ÿπÿØŸÖ ÿßŸÑŸÜÿ¥ÿßÿ∑ ÿπŸÜÿØ ÿ£Ÿä ŸÜÿ¥ÿßÿ∑
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
                document.addEventListener(event, () => {
                    if (window.securityManager) {
                        window.securityManager.resetInactivityTimer();
                    }
                }, true);
            });

            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
            if (!sessionStorage.getItem('is_logged_in')) {
                window.securityManager.showLoginPage();
            } else {
                window.securityManager.applyPermissions();
                window.securityManager.updateSidebarButtons();
            }
        });

        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
        async function initApp() {
            try {
                console.log('üöÄ ÿ®ÿØÿ° ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ...');
                updateLoaderStatus('ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ...');
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™
                const isOnline = navigator.onLine;
                console.log('ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ:', isOnline ? '‚úÖ ŸÖÿ™ÿµŸÑ' : '‚ö†Ô∏è ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ');
                
                // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ŸáŸäÿ¶ÿ© Firebase ŸàÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿ™ÿµŸÑÿßŸã)
                if (isOnline) {
                    try {
                        console.log('ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÄ Firebase...');
                        updateLoaderStatus('ÿ¨ÿßÿ±Ÿç ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ...');
                        await Promise.race([
                            Promise.all([
                                createLocalUserIfNeeded(),
                                checkSubscriptionAndGate(),
                                loadUserDataFromFirebase()
                            ]),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('timeout')), 5000)
                            )
                        ]);
                        console.log('‚úÖ ÿ™ŸÖ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÄ Firebase');
                    } catch (error) {
                        console.warn('‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÄ Firebase (ÿ≥ŸäÿπŸÖŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ®ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ):', error.message);
                        // ÿßŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ÿ®ÿØŸàŸÜ Firebase
                    }
                } else {
                    console.log('‚ö†Ô∏è ŸÑÿß ŸäŸàÿ¨ÿØ ÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ - ÿßŸÑÿπŸÖŸÑ ÿ®ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿ≠ŸÑŸä');
                }

                // ÿ™ŸáŸäÿ¶ÿ© Data SDK (ŸÖÿ≠ŸÑŸä - ŸÑÿß Ÿäÿ≠ÿ™ÿßÿ¨ ÿ•ŸÜÿ™ÿ±ŸÜÿ™)
                console.log('ÿ™ŸáŸäÿ¶ÿ© ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©...');
                updateLoaderStatus('ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
                if (window.dataSdk) {
                    const initResult = await window.dataSdk.init(dataHandler);
                    if (!initResult.isOk) {
                        console.error('‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                        return;
                    }
                    console.log('‚úÖ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©');
                } else {
                    console.error('‚ùå Data SDK ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ!');
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    return;
                }

                // ÿ™ŸáŸäÿ¶ÿ© Element SDK
                if (window.elementSdk) {
                    await window.elementSdk.init({
                        defaultConfig,
                        onConfigChange: async (config) => {
                            try {
                                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπŸÜÿßÿµÿ± ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸàÿ¨ŸàÿØÿ©
                                const storeNameEl = document.getElementById('storeName');
                                const taxRateEl = document.getElementById('taxRate');
                                
                                if (storeNameEl) {
                                    storeNameEl.textContent = config.store_name || defaultConfig.store_name;
                                }
                                
                                if (taxRateEl) {
                                    taxRateEl.textContent = config.tax_rate || defaultConfig.tax_rate;
                                }
                                
                                // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                                if (typeof updateInvoicePreview === 'function') {
                                    updateInvoicePreview(config);
                                }
                                
                                // ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑÿÆÿµ ÿßŸÑÿ≥ŸÑÿ©
                                if (typeof updateCartSummary === 'function') {
                                    updateCartSummary();
                                }
                            } catch (err) {
                                console.warn('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™:', err);
                            }
                        },
                        mapToCapabilities: (config) => ({
                            recolorables: [],
                            borderables: [],
                            fontEditable: undefined,
                            fontSizeable: undefined
                        }),
                        mapToEditPanelValues: (config) => new Map([
                            ['store_name', config.store_name || defaultConfig.store_name],
                            ['store_address', config.store_address || defaultConfig.store_address],
                            ['store_phone', config.store_phone || defaultConfig.store_phone],
                            ['tax_rate', config.tax_rate || defaultConfig.tax_rate]
                        ])
                    });
                }

                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸàŸÑ ŸÖÿ±ÿ© ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ
                const isFirstRun = !localStorage.getItem('appInitialized');
                const hasFactoryReset = localStorage.getItem('factoryResetDone') === 'true';
                
                // ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ© ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿ£ŸàŸÑ ŸÖÿ±ÿ© ŸàŸÑŸäÿ≥ ÿ®ÿπÿØ ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑ ÿßŸÑŸÖÿµŸÜÿπ
                updateLoaderStatus('ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
                if (!hasFactoryReset) {
                    if (categories.length === 0) {
                        console.log('ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ¶ÿßÿ™ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©...');
                        updateLoaderStatus('ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©...');
                        await addSampleCategories();
                    }
                    
                    if (products.length === 0) {
                        console.log('ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©...');
                        await addSampleProducts();
                    }
                }
                
                // ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©
                console.log('ŸÅÿ≠ÿµ Ÿàÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©...');
                updateLoaderStatus('ŸÅÿ≠ÿµ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
                await fixOldDebtsData();
                
                // ‚úÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿØŸäŸàŸÜ ŸÖŸÜ localStorage ŸÉŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
                console.log('ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿØŸäŸàŸÜ ŸÖŸÜ localStorage...');
                await loadDebtsFromLocalStorage();

                // ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿßÿ®ÿπÿ©
                console.log('ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿßÿ®ÿπÿ©...');
                updateLoaderStatus('ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™...');
                loadPrinterSettings();
                
                // ÿ™ÿ≠ŸÖŸäŸÑ Ÿàÿ™ÿ∑ÿ®ŸäŸÇ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
                console.log('ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™...');
                loadAllSettings();

                console.log('ÿ•ÿπÿØÿßÿØ ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´...');
                setupEventListeners();
                
                console.log('ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπÿ±Ÿàÿ∂...');
                updateLoaderStatus('ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©...');
                updateAllViews();
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿπÿ©
                console.log('ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™...');
                updateQuickStats();
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿ®ÿ∑ÿßŸÇÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸàÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ (ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿ™ÿµŸÑÿßŸã)
                if (isOnline) {
                    updateUserSubscriptionCard();
                }
                
                // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ≥ÿßÿπÿ© ŸÅŸä ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÜŸàÿßŸÜ
                startTitlebarClock();
                
                // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ≥ÿßÿπÿ© ÿßŸÑÿ±ŸÇŸÖŸäÿ©
                updateDigitalClock();
                setInterval(updateDigitalClock, 1000);
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÉŸÑ 5 ÿ´ŸàÿßŸÜŸä
                setInterval(updateQuickStats, 5000);
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÉŸÑ ÿØŸÇŸäŸÇÿ© (ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿ™ÿµŸÑÿßŸã)
                if (isOnline) {
                    setInterval(updateUserSubscriptionCard, 60000);
                }
                
                // ÿ±ÿ≥ÿßŸÑÿ© ŸÑŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿ≠ŸÑŸä
                if (!isOnline) {
                    console.log('‚ö†Ô∏è ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸäÿπŸÖŸÑ ÿ®ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿ≠ŸÑŸä (ÿ®ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ)');
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                }
                
                console.log('‚úÖ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ®ŸÜÿ¨ÿßÿ≠!');
                
                // ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
                const loader = document.getElementById('appLoader');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => {
                        loader.style.display = 'none';
                    }, 500);
                }
                
                // ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ±ÿ≠Ÿäÿ® ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑÿ¨ÿØÿØ
                if (isFirstRun) {
                    localStorage.setItem('appInitialized', 'true');
                    setTimeout(() => {
                        showWelcomeMessage();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ:', error);
                
                // ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ≠ÿ™Ÿâ ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿ∑ÿ£
                const loader = document.getElementById('appLoader');
                if (loader) {
                    const statusEl = document.getElementById('loaderStatus');
                    if (statusEl) {
                        statusEl.textContent = 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ - Ÿäÿ±ÿ¨Ÿâ ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ';
                        statusEl.style.color = 'var(--danger-color)';
                    }
                }
                
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        // Ÿàÿ∏ŸäŸÅÿ© ÿßŸÑÿ≥ÿßÿπÿ© ŸÅŸä ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÜŸàÿßŸÜ
        function startTitlebarClock() {
            function updateClock() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                const clockElement = document.getElementById('titlebarClock');
                if (clockElement) {
                    clockElement.textContent = `${hours}:${minutes}:${seconds}`;
                }
            }
            
            updateClock();
            setInterval(updateClock, 1000);
        }

        // Ÿàÿ∏ŸäŸÅÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
        function refreshApp() {
            const btn = event.target.closest('.titlebar-refresh');
            const icon = btn.querySelector('i');
            
            // ÿ™ÿ£ÿ´Ÿäÿ± ÿßŸÑÿØŸàÿ±ÿßŸÜ
            icon.style.transform = 'rotate(360deg)';
            btn.disabled = true;
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            setTimeout(async () => {
                try {
                    await updateAllViews();
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                } catch (error) {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                }
                
                icon.style.transform = 'rotate(0deg)';
                btn.disabled = false;
            }, 800);
        }

        // ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿµŸÜŸäŸÅÿßÿ™ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©
        async function addSampleCategories() {
            const sampleCategories = [
                { type: 'category', category_id: '1', category_name: 'ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿßÿ™', category_icon: 'fas fa-laptop', timestamp: new Date().toISOString() },
                { type: 'category', category_id: '2', category_name: 'ÿ•ŸÉÿ≥ÿ≥Ÿàÿßÿ±ÿßÿ™', category_icon: 'fas fa-headphones', timestamp: new Date().toISOString() },
                { type: 'category', category_id: '3', category_name: 'ÿ£ÿ¨Ÿáÿ≤ÿ© ÿ∞ŸÉŸäÿ©', category_icon: 'fas fa-mobile-alt', timestamp: new Date().toISOString() }
            ];

            if (window.dataSdk) {
                for (const category of sampleCategories) {
                    await window.dataSdk.create(category);
                }
            }
        }

        // ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©
        async function addSampleProducts() {
            const sampleProducts = [
                { 
                    type: 'product', 
                    product_id: '1', 
                    product_name: 'ŸÑÿßÿ®ÿ™Ÿàÿ® Dell XPS 13', 
                    product_barcode: '1234567890123',
                    product_price_retail: 2500000, 
                    product_price_wholesale: 2300000,
                    product_cost_retail: 2000000, 
                    product_cost_wholesale: 1800000,
                    stock_quantity: 10,
                    min_stock: 5,
                    product_category: '1',
                    supplier: 'ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿ™ŸÇŸÜŸäÿ© ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ©',
                    timestamp: new Date().toISOString() 
                },
                { 
                    type: 'product', 
                    product_id: '2', 
                    product_name: 'Ÿáÿßÿ™ŸÅ Samsung Galaxy S23', 
                    product_barcode: '2345678901234',
                    product_price_retail: 1200000, 
                    product_price_wholesale: 1100000,
                    product_cost_retail: 900000, 
                    product_cost_wholesale: 800000,
                    stock_quantity: 25,
                    min_stock: 10,
                    product_category: '3',
                    supplier: 'ŸÖŸàÿ≤ÿπ ÿ≥ÿßŸÖÿ≥ŸàŸÜÿ¨',
                    timestamp: new Date().toISOString() 
                },
                { 
                    type: 'product', 
                    product_id: '3', 
                    product_name: 'ÿ≥ŸÖÿßÿπÿßÿ™ Sony WH-1000XM4', 
                    product_barcode: '3456789012345',
                    product_price_retail: 150000, 
                    product_price_wholesale: 140000,
                    product_cost_retail: 100000, 
                    product_cost_wholesale: 90000,
                    stock_quantity: 50,
                    min_stock: 15,
                    product_category: '2',
                    supplier: 'ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿµŸàÿ™Ÿäÿßÿ™',
                    timestamp: new Date().toISOString() 
                }
            ];

            if (window.dataSdk) {
                for (const product of sampleProducts) {
                    await window.dataSdk.create(product);
                }
            }
        }
        
        // ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ŸÑŸÑÿØŸäŸàŸÜ
        async function fixOldDebtsData() {
            console.log('Checking and fixing old debts data...');
            
            for (const debt of debtsData) {
                let needsUpdate = false;
                const updates = {};
                
                // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ£ŸàŸÑÿßŸã
                const relatedSale = salesData.find(s => s.invoice_id === debt.invoice_id);
                
                // ÿ•ÿµŸÑÿßÿ≠ total_amount
                if (!debt.total_amount) {
                    if (debt.final_total) {
                        updates.total_amount = debt.final_total;
                    } else if (relatedSale && relatedSale.final_total) {
                        updates.total_amount = relatedSale.final_total;
                    }
                    if (updates.total_amount) needsUpdate = true;
                }
                
                // ÿ•ÿµŸÑÿßÿ≠ remaining_amount
                if (debt.remaining_amount === undefined || debt.remaining_amount === null) {
                    const totalAmt = updates.total_amount || debt.total_amount || debt.final_total || 0;
                    updates.remaining_amount = totalAmt;
                    needsUpdate = true;
                }
                
                // ÿ•ÿµŸÑÿßÿ≠ monthly_amount
                if (!debt.monthly_amount) {
                    const totalAmt = updates.total_amount || debt.total_amount || debt.final_total || 0;
                    const months = debt.installment_months || relatedSale?.installment_months || 1;
                    
                    if (relatedSale && relatedSale.monthly_amount) {
                        updates.monthly_amount = relatedSale.monthly_amount;
                    } else if (totalAmt > 0 && months > 0) {
                        updates.monthly_amount = totalAmt / months;
                    }
                    
                    if (updates.monthly_amount) needsUpdate = true;
                }
                
                // ÿ•ÿµŸÑÿßÿ≠ installment_months
                if (!debt.installment_months && relatedSale?.installment_months) {
                    updates.installment_months = relatedSale.installment_months;
                    needsUpdate = true;
                }
                
                // ÿ•ŸÜÿ¥ÿßÿ° ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
                if ((!debt.installments || debt.installments.length === 0) && debt.installment_months > 0) {
                    const monthlyAmt = updates.monthly_amount || debt.monthly_amount || 0;
                    const installments = [];
                    
                    for (let i = 1; i <= debt.installment_months; i++) {
                        installments.push({
                            month: i,
                            amount: monthlyAmt,
                            due_date: new Date(new Date(debt.timestamp).getTime() + (i * 30 * 24 * 60 * 60 * 1000)).toISOString(),
                            status: 'pending',
                            paid_date: null,
                            paid_amount: 0
                        });
                    }
                    
                    updates.installments = installments;
                    needsUpdate = true;
                }
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                if (needsUpdate && window.dataSdk && (debt.id || debt.__backendId)) {
                    const debtId = debt.id || debt.__backendId;
                    console.log('Updating debt:', debtId, updates);
                    await window.dataSdk.update(debtId, updates);
                    
                    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÉÿßÿ¶ŸÜ ÿßŸÑŸÖÿ≠ŸÑŸä
                    Object.assign(debt, updates);
                }
            }
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            if (window.dataSdk) {
                const allData = await window.dataSdk.query();
                if (allData.isOk) {
                    debtsData = allData.data.filter(item => item.type === 'debt');
                    console.log('Reloaded debts data:', debtsData);
                    
                    // ÿ•ÿµŸÑÿßÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑÿ™Ÿä ŸÇÿØ ÿ™ŸÉŸàŸÜ ŸÅÿßŸÇÿØÿ© ŸÑŸÑŸÇŸäŸÖ
                    await fixDebtsData();
                    
                    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂
                    renderDebtsTable();
                    updateStatistics();
                }
            }
        }
        
        // ÿ•ÿµŸÑÿßÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑÿ™ÿßŸÑŸÅÿ© ÿ£Ÿà ÿßŸÑŸÜÿßŸÇÿµÿ©
        async function fixDebtsData() {
            console.log('=== Fixing Debts Data ===');
            let fixedCount = 0;
            
            for (let debt of debtsData) {
                let needsUpdate = false;
                const updates = {};
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ total_amount
                if (!debt.total_amount || debt.total_amount === 0) {
                    // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸäŸá ŸÖŸÜ final_total
                    if (debt.final_total) {
                        updates.total_amount = debt.final_total;
                        needsUpdate = true;
                    }
                    // ÿ£Ÿà ŸÖŸÜ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ©
                    else if (debt.invoice_id) {
                        const relatedSale = salesData.find(s => s.invoice_id === debt.invoice_id);
                        if (relatedSale && relatedSale.final_total) {
                            updates.total_amount = relatedSale.final_total;
                            updates.final_total = relatedSale.final_total;
                            needsUpdate = true;
                        }
                    }
                    // ÿ£Ÿà ŸÖŸÜ ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
                    else if (debt.monthly_amount && debt.installment_months) {
                        const calculated = debt.monthly_amount * debt.installment_months;
                        updates.total_amount = calculated;
                        updates.final_total = calculated;
                        needsUpdate = true;
                    }
                }
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ monthly_amount
                if (!debt.monthly_amount || debt.monthly_amount === 0) {
                    if (debt.total_amount && debt.installment_months) {
                        updates.monthly_amount = debt.total_amount / debt.installment_months;
                        needsUpdate = true;
                    }
                }
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ installments
                if (!debt.installments || debt.installments.length === 0) {
                    if (debt.installment_months && debt.monthly_amount) {
                        const installments = [];
                        const startDate = new Date(debt.timestamp || Date.now());
                        
                        for (let i = 1; i <= debt.installment_months; i++) {
                            const dueDate = new Date(startDate);
                            dueDate.setMonth(dueDate.getMonth() + i);
                            
                            installments.push({
                                month: i,
                                amount: debt.monthly_amount,
                                due_date: dueDate.toISOString(),
                                status: 'pending',
                                paid_date: null,
                                paid_amount: 0
                            });
                        }
                        
                        updates.installments = installments;
                        needsUpdate = true;
                    }
                }
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≥ÿ¨ŸÑ ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ±
                if (needsUpdate && (debt.id || debt.__backendId)) {
                    console.log(`Fixing debt for ${debt.customer_name}:`, updates);
                    await window.dataSdk.update(debt.id || debt.__backendId, updates);
                    Object.assign(debt, updates);
                    fixedCount++;
                }
            }
            
            if (fixedCount > 0) {
                console.log(`‚úÖ Fixed ${fixedCount} debt records`);
            } else {
                console.log('‚úì All debt records are OK');
            }
            console.log('=======================');
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑŸàÿßÿ¨Ÿáÿßÿ™
        function updateAllViews() {
            renderProducts();
            renderCategoryFilters();
            renderProductsTable();
            renderInventoryTable();
            renderInvoicesTable();
            renderDebtsTable();
            updateStatistics();
            updateCartCount();
            populateCategorySelects();
            updateQuickStats();
            updateSettingsStats();
            
            // ‚úÖ ÿ™ÿ≠ÿØŸäÿ´ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ•ŸäÿµÿßŸÑÿßÿ™
            if (typeof renderReceiptsTable === 'function') {
                renderReceiptsTable();
            }
        }

        // ÿπÿ±ÿ∂ ŸÅŸÑÿßÿ™ÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™
        function renderCategoryFilters() {
            const filtersContainer = document.getElementById('categoryFilters');
            if (!filtersContainer) return;
            
            const allBtn = `
                <div class="category-btn ${currentCategory === 'all' ? 'active' : ''}" data-category="all">
                    <i class="fas fa-th-large"></i> ÿßŸÑŸÉŸÑ
                </div>
            `;
            
            const categoryBtns = categories.map(category => `
                <div class="category-btn ${currentCategory === category.category_id ? 'active' : ''}" data-category="${category.category_id}">
                    <i class="${category.category_icon}"></i> ${category.category_name}
                </div>
            `).join('');
            
            filtersContainer.innerHTML = allBtn + categoryBtns;
            
            // ÿ•ÿπÿßÿØÿ© ÿ±ÿ®ÿ∑ ÿßŸÑÿ£ÿ≠ÿØÿßÿ´
            filtersContainer.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCategory = btn.dataset.category;
                    renderProducts();
                });
            });
        }

        // ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            if (!grid) return;
            
            const filteredProducts = currentCategory === 'all' 
                ? products 
                : products.filter(p => p.product_category === currentCategory);
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ŸÖŸÜ ÿÆÿßŸÜÿ© ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ
            const posSearchTerm = document.getElementById('posSearchInput')?.value.toLowerCase() || '';
            const searchedProducts = posSearchTerm 
                ? filteredProducts.filter(p => 
                    p.product_name.toLowerCase().includes(posSearchTerm) ||
                    p.product_barcode?.toLowerCase().includes(posSearchTerm) ||
                    p.supplier?.toLowerCase().includes(posSearchTerm)
                  )
                : filteredProducts;
            
            grid.innerHTML = searchedProducts.map(product => {
                const category = categories.find(c => c.category_id === product.product_category);
                const icon = category ? category.category_icon : 'fas fa-box';
                const stockStatus = product.stock_quantity < product.min_stock ? 'ŸÖÿÆÿ≤ŸàŸÜ ŸÇŸÑŸäŸÑ' : `ŸÖÿ™ŸàŸÅÿ± (${product.stock_quantity})`;
                const stockClass = product.stock_quantity < product.min_stock ? 'text-warning' : 'text-success';
                
                return `
                    <div class="product-card animate__animated animate__fadeInUp" onclick="addToCart('${product.product_id}')">
                        <div class="product-icon">
                            <i class="${icon}"></i>
                        </div>
                        <div class="product-name">${product.product_name}</div>
                        <div class="product-price">${formatCurrency(product.product_price_retail)}</div>
                        <div class="product-stock ${stockClass}">${stockStatus}</div>
                    </div>
                `;
            }).join('');
        }

        // ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ŸÑŸÑÿ≥ŸÑÿ©
        function addToCart(productId) {
            // ŸÅÿ≠ÿµ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ© ÿ£ŸàŸÑÿßŸã
            if (window.securityManager && !window.securityManager.checkPermission('pos_add_to_cart')) {
                return;
            }
            
            const product = products.find(p => p.product_id === productId);
            if (!product) return;
            
            if (product.stock_quantity <= 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            const existingItem = cart.find(item => item.product_id === productId);
            
            if (existingItem) {
                if (existingItem.quantity >= product.stock_quantity) {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    return;
                }
                existingItem.quantity += 1;
            } else {
                cart.push({ 
                    product_id: productId,
                    product_name: product.product_name,
                    product_price: product.product_price_retail,
                    quantity: 1 
                });
            }
            
            console.log('‚ûï Product added to cart:', product.product_name);
            
            renderCart();
            updateCartSummary();
            updateCartCount();
            
            // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑÿ£ÿ≥ŸÅŸÑ ÿ®ÿπÿØ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©
            console.log('‚è∞ Setting timeout for scroll...');
            setTimeout(() => {
                console.log('‚è∞ Timeout executed, scrolling...');
                scrollCartToBottom();
            }, 500);
            
            // ÿ™ÿ£ÿ´Ÿäÿ± ÿ®ÿµÿ±Ÿä
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }



        // ÿπÿ±ÿ∂ ÿßŸÑÿ≥ŸÑÿ©
        function renderCart() {
            const cartContainer = document.getElementById('cartItems');
            if (!cartContainer) return;
            
            if (cart.length === 0) {
                cartContainer.innerHTML = `
                    <div class="cart-empty">
                        <i class="fas fa-shopping-cart"></i>
                        <p>ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ©</p>
                        <small>ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑÿ•ÿ∂ÿßŸÅÿ™Ÿáÿß</small>
                    </div>
                `;
                return;
            }
            
            cartContainer.innerHTML = cart.map(item => {
                const product = products.find(p => p.product_id === item.product_id);
                const category = product ? product.category : 'other';
                
                return `
                <div class="cart-item animate__animated animate__fadeInRight" data-category="${category}">
                    <div class="cart-item-content">
                        <div class="item-header">
                            <div class="item-info">
                                <h4 data-quantity="${item.quantity}">${item.product_name}</h4>
                                <div class="item-price">${formatCurrency(item.product_price)}</div>
                            </div>
                            <button class="remove-btn" onclick="removeFromCart('${item.product_id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="quantity-controls">
                            <div class="qty-controls">
                                <button class="qty-btn" onclick="updateQuantity('${item.product_id}', -1)">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span class="quantity">${item.quantity}</span>
                                <button class="qty-btn" onclick="updateQuantity('${item.product_id}', 1)">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="item-total">${formatCurrency(item.product_price * item.quantity)}</div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            console.log('üì¶ Cart rendered with', cart.length, 'items');
            
            // ÿ™ŸÖÿ±Ÿäÿ± ÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÑÿ£ÿ≥ŸÅŸÑ ŸÅŸàÿ±ÿßŸã
            scrollCartToBottom();
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÖÿ≠ÿ™ŸàŸâ ŸÑŸÑÿ™ŸÖÿ±Ÿäÿ± Ÿàÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÉŸÑÿßÿ≥
            setTimeout(() => {
                const hasScroll = cartContainer.scrollHeight > cartContainer.clientHeight;
                if (hasScroll) {
                    cartContainer.classList.add('has-scroll');
                } else {
                    cartContainer.classList.remove('has-scroll');
                }
                
                console.log('üîÑ Confirming scroll...');
                // ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ
                scrollCartToBottom();
            }, 100);
            
            // ÿ™ŸÖÿ±Ÿäÿ± ÿ•ÿ∂ÿßŸÅŸä ÿ®ÿπÿØ ÿ™ÿ£ÿÆŸäÿ± ÿ£ÿ∑ŸàŸÑ
            setTimeout(() => {
                console.log('üîÑ Final scroll confirmation...');
                scrollCartToBottom();
            }, 300);
        }

        // ÿØÿßŸÑÿ© ŸÑŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑÿ£ÿ≥ŸÅŸÑ ÿßŸÑÿ≥ŸÑÿ© - ŸÖÿ≠ÿ≥ŸëŸÜÿ©
        function scrollCartToBottom() {
            const cartContainer = document.getElementById('cartItems');
            if (!cartContainer) {
                console.log('‚ùå cartContainer not found');
                return;
            }
            
            console.log('üîÑ Scrolling to bottom...');
            console.log('ScrollHeight:', cartContainer.scrollHeight);
            console.log('ClientHeight:', cartContainer.clientHeight);
            
            // ÿ™ŸÖÿ±Ÿäÿ± ŸÅŸàÿ±Ÿä ŸÑŸÑÿ£ÿ≥ŸÅŸÑ
            setTimeout(() => {
                const maxScroll = cartContainer.scrollHeight - cartContainer.clientHeight;
                console.log('MaxScroll:', maxScroll);
                
                if (maxScroll > 0) {
                    cartContainer.scrollTop = maxScroll;
                    console.log('‚úÖ Scrolled to:', cartContainer.scrollTop);
                }
            }, 50);
        }

        // ÿØÿßŸÑÿ© ŸÑŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑÿ£ÿπŸÑŸâ ÿßŸÑÿ≥ŸÑÿ©
        function scrollCartToTop() {
            const cartContainer = document.getElementById('cartItems');
            if (!cartContainer) return;
            
            cartContainer.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿπÿØÿßÿØ ÿßŸÑÿ≥ŸÑÿ©
        function updateCartCount() {
            const cartCount = document.getElementById('cartCount');
            if (cartCount) {
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                cartCount.textContent = totalItems;
                
                if (totalItems > 0) {
                    cartCount.classList.add('pulse');
                } else {
                    cartCount.classList.remove('pulse');
                }
            }
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÉŸÖŸäÿ©
        function updateQuantity(productId, change) {
            const item = cart.find(item => item.product_id === productId);
            const product = products.find(p => p.product_id === productId);
            
            if (item && product) {
                const newQuantity = item.quantity + change;
                
                if (newQuantity <= 0) {
                    removeFromCart(productId);
                } else if (newQuantity > product.stock_quantity) {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                } else {
                    item.quantity = newQuantity;
                    renderCart();
                    updateCartSummary();
                    updateCartCount();
                }
            }
        }

        // ÿ≠ÿ∞ŸÅ ŸÖŸÜ ÿßŸÑÿ≥ŸÑÿ©
        function removeFromCart(productId) {
            cart = cart.filter(item => item.product_id !== productId);
            renderCart();
            updateCartSummary();
            updateCartCount();
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑÿÆÿµ ÿßŸÑÿ≥ŸÑÿ©
        function updateCartSummary() {
            const subtotal = cart.reduce((sum, item) => sum + (item.product_price * item.quantity), 0);
            const discountPercent = parseFloat(document.getElementById('discountInput')?.value) || 0;
            const discountAmount = subtotal * (discountPercent / 100);
            const afterDiscount = subtotal - discountAmount;
            const taxRate = parseFloat(getCurrentTaxRate()) / 100;
            const taxAmount = afterDiscount * taxRate;
            const finalTotal = afterDiscount + taxAmount;
            
            updateElement('subtotal', formatCurrency(subtotal));
            updateElement('discountAmount', formatCurrency(discountAmount));
            updateElement('taxAmount', formatCurrency(taxAmount));
            updateElement('finalTotal', formatCurrency(finalTotal));
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ≥ŸÑÿ© ŸÅŸä ÿßŸÑÿ±ÿ£ÿ≥
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            updateElement('cartItemsCount', totalItems);
            updateElement('cartTotalPrice', formatCurrency(finalTotal));
            
            // ÿ™ŸÅÿπŸäŸÑ/ÿ™ÿπÿ∑ŸäŸÑ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿØŸÅÿπ ÿßŸÑÿ¨ÿØŸäÿØÿ©
            const cashPaymentBtn = document.getElementById('cashPaymentBtn');
            const installmentPaymentBtn = document.getElementById('installmentPaymentBtn');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            const isEmpty = cart.length === 0;
            
            if (cashPaymentBtn) {
                cashPaymentBtn.disabled = isEmpty;
            }
            if (installmentPaymentBtn) {
                installmentPaymentBtn.disabled = isEmpty;
            }
            if (checkoutBtn) {
                checkoutBtn.disabled = isEmpty;
            }
        }
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿπÿ©
        function updateQuickStats() {
            // ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
            const totalProducts = products.length;
            updateElement('quickTotalProducts', totalProducts);
            
            // ŸÇŸäŸÖÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ (ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ≥ÿπÿ± ÿßŸÑÿ™ŸÉŸÑŸÅÿ© √ó ÿßŸÑŸÉŸÖŸäÿ©)
            const totalValue = products.reduce((sum, p) => {
                const costPrice = p.product_cost_retail || p.purchase_price || 0;
                const quantity = p.stock_quantity || p.product_quantity || 0;
                return sum + (costPrice * quantity);
            }, 0);
            updateElement('quickTotalValue', formatCurrency(totalValue));
            
            // ÿπÿØÿØ ÿßŸÑÿØŸäŸàŸÜ
            const totalDebts = debtsData.length;
            updateElement('quickDebtsCount', totalDebts);
            
            // ÿπÿØÿØ ÿßŸÑŸÖÿØŸäŸàŸÜŸäŸÜ (ÿßŸÑÿ£ÿ¥ÿÆÿßÿµ ÿßŸÑŸÅÿ±ŸäÿØŸäŸÜ)
            const uniqueDebtors = new Set(debtsData.map(d => d.customer_name)).size;
            updateElement('quickDebtorsCount', uniqueDebtors);
            
            // ŸÇŸäŸÖÿ© ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ© - ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ÿ®ÿØŸÇÿ©
            const totalDebtsValue = debtsData.reduce((sum, d) => {
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ ŸÖŸÜ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
                let paidAmount = 0;
                if (d.installments && Array.isArray(d.installments) && d.installments.length > 0) {
                    d.installments.forEach(inst => {
                        if (inst.status === 'paid') {
                            paidAmount += parseFloat(inst.paid_amount || inst.amount || 0);
                        }
                    });
                } else if (d.paid_amount !== undefined && d.paid_amount !== null) {
                    paidAmount = parseFloat(d.paid_amount) || 0;
                }
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä
                const totalAmount = parseFloat(d.total_amount || d.final_total || 0);
                const remainingAmount = totalAmount - paidAmount;
                
                return sum + (remainingAmount > 0 ? remainingAmount : 0);
            }, 0);
            updateElement('quickDebtsValue', formatCurrency(totalDebtsValue));
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸàÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÅŸä ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©
        async function updateUserSubscriptionCard() {
            try {
                const uid = localStorage.getItem('app_uid');
                if (!uid) {
                    console.warn('‚ö†Ô∏è ŸÑÿß ŸäŸàÿ¨ÿØ UID ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
                    return;
                }

                // ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ Firebase
                const userSnap = await database.ref(`users/${uid}`).once('value');
                if (!userSnap.exists()) {
                    console.warn('‚ö†Ô∏è ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä Firebase');
                    return;
                }

                const user = userSnap.val();
                const profile = user.profile || {};
                const subscription = user.subscription;
                const trialUntil = user.trialUntil;
                const now = Date.now();

                // ÿ™ÿ≠ÿØŸäÿ´ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ UID ŸÖÿÆÿ™ÿµÿ±)
                const displayName = uid.substring(0, 12) + '...';
                updateElement('userDisplayName', displayName);

                // ÿ™ÿ≠ÿØŸäÿØ ŸÜŸàÿπ Ÿàÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ
                let subscriptionType = 'ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä';
                let endDate = 0;
                let startDate = profile.createdAt || now;
                let daysLeft = 0;
                let statusColor = '#10b981'; // ÿ£ÿÆÿ∂ÿ± ŸÑŸÑŸÜÿ¥ÿ∑

                if (subscription && subscription.validUntil) {
                    // ÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖÿØŸÅŸàÿπ
                    endDate = Number(subscription.validUntil);
                    startDate = subscription.activatedAt || startDate;
                    
                    // ÿ™ÿ≠ÿØŸäÿØ ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ
                    if (subscription.type === 'monthly') {
                        subscriptionType = 'ÿ¥Ÿáÿ±Ÿä';
                    } else if (subscription.type === 'yearly') {
                        subscriptionType = 'ÿ≥ŸÜŸàŸä';
                    } else {
                        subscriptionType = subscription.type || 'ŸÖÿÆÿµÿµ';
                    }
                } else if (trialUntil) {
                    // ŸÅÿ™ÿ±ÿ© ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©
                    endDate = Number(trialUntil);
                    subscriptionType = 'ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä';
                }

                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©
                if (endDate > 0) {
                    daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                }

                // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÑŸàŸÜ ÿ≠ÿ≥ÿ® ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©
                if (daysLeft <= 0) {
                    statusColor = '#ef4444'; // ÿ£ÿ≠ŸÖÿ± ŸÑŸÑŸÖŸÜÿ™ŸáŸä
                    subscriptionType = 'ŸÖŸÜÿ™ŸáŸä';
                } else if (daysLeft <= 7) {
                    statusColor = '#f59e0b'; // ÿ®ÿ±ÿ™ŸÇÿßŸÑŸä ŸÑŸÑŸÇÿ±Ÿäÿ® ŸÖŸÜ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°
                } else {
                    statusColor = '#10b981'; // ÿ£ÿÆÿ∂ÿ± ŸÑŸÑŸÜÿ¥ÿ∑
                }

                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπŸÜÿßÿµÿ±
                const typeEl = document.getElementById('subscriptionType');
                if (typeEl) {
                    typeEl.textContent = subscriptionType;
                    typeEl.style.color = statusColor;
                    typeEl.style.background = statusColor + '20'; // ÿ¥ŸÅÿßŸÅŸäÿ© 20%
                }

                const daysLeftEl = document.getElementById('subscriptionDaysLeft');
                if (daysLeftEl) {
                    if (daysLeft > 0) {
                        daysLeftEl.textContent = daysLeft + ' ŸäŸàŸÖ';
                        daysLeftEl.style.color = statusColor;
                    } else {
                        daysLeftEl.textContent = 'ŸÖŸÜÿ™ŸáŸä';
                        daysLeftEl.style.color = '#ef4444';
                    }
                }

                // ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ
                const formatDate = (timestamp) => {
                    if (!timestamp) return '--/--/----';
                    const date = new Date(timestamp);
                    return date.toLocaleDateString('ar-IQ', { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit' 
                    });
                };

                updateElement('subscriptionStartDate', formatDate(startDate));
                updateElement('subscriptionEndDate', formatDate(endDate));

                // ÿ™ÿ≠ÿØŸäÿ´ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ£Ÿäÿ∂ÿßŸã
                updateAccountPage(user, uid, daysLeft, statusColor);

                console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ÿ∑ÿßŸÇÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');

            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', error);
            }
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿµŸÅÿ≠ÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        function updateAccountPage(user, uid, daysLeft, statusColor) {
            try {
                const profile = user.profile || {};
                const subscription = user.subscription;
                const trialUntil = user.trialUntil;
                const now = Date.now();

                // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ®
                updateElement('accountUserUID', uid);
                
                const secretEl = document.getElementById('accountUserSecret');
                if (secretEl && profile.secret) {
                    secretEl.textContent = profile.secret;
                    secretEl.setAttribute('data-secret', profile.secret);
                }

                const formatDate = (timestamp) => {
                    if (!timestamp) return '--/--/----';
                    const date = new Date(timestamp);
                    return date.toLocaleDateString('ar-IQ', { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit' 
                    });
                };

                updateElement('accountCreatedDate', formatDate(profile.createdAt));
                updateElement('accountPlatform', profile.deviceInfo?.platform || 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ');

                // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ
                let subscriptionType = 'ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä';
                let startDate = profile.createdAt || now;
                let endDate = trialUntil || 0;

                if (subscription && subscription.validUntil) {
                    endDate = Number(subscription.validUntil);
                    startDate = subscription.activatedAt || startDate;
                    
                    if (subscription.type === 'monthly') {
                        subscriptionType = 'ÿ¥Ÿáÿ±Ÿä';
                    } else if (subscription.type === 'yearly') {
                        subscriptionType = 'ÿ≥ŸÜŸàŸä';
                    } else {
                        subscriptionType = subscription.type || 'ŸÖÿÆÿµÿµ';
                    }
                }

                if (daysLeft <= 0) {
                    subscriptionType = 'ŸÖŸÜÿ™ŸáŸä';
                }

                updateElement('accountSubscriptionType', subscriptionType);
                updateElement('accountStartDate', formatDate(startDate));
                updateElement('accountEndDate', formatDate(endDate));

                // ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©
                const daysLeftEl = document.getElementById('accountDaysLeft');
                if (daysLeftEl) {
                    if (daysLeft > 0) {
                        daysLeftEl.textContent = daysLeft + ' ŸäŸàŸÖ';
                        daysLeftEl.style.color = statusColor;
                    } else {
                        daysLeftEl.textContent = 'ŸÖŸÜÿ™ŸáŸä';
                        daysLeftEl.style.color = '#ef4444';
                    }
                }

                // ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑÿ£ŸäÿßŸÖ
                const daysIconEl = document.getElementById('accountDaysIcon');
                if (daysIconEl) {
                    if (daysLeft <= 0) {
                        daysIconEl.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                    } else if (daysLeft <= 7) {
                        daysIconEl.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                    } else {
                        daysIconEl.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    }
                }

                // ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÇÿØŸÖ
                const totalDays = subscription?.type === 'yearly' ? 365 : 30;
                const usedDays = totalDays - daysLeft;
                const progressPercent = Math.min(100, Math.max(0, (usedDays / totalDays) * 100));
                
                updateElement('accountProgressPercent', Math.round(progressPercent) + '%');
                
                const progressBar = document.getElementById('accountProgressBar');
                if (progressBar) {
                    progressBar.style.width = progressPercent + '%';
                    
                    if (progressPercent >= 90) {
                        progressBar.style.background = 'linear-gradient(90deg, #ef4444 0%, #dc2626 100%)';
                    } else if (progressPercent >= 70) {
                        progressBar.style.background = 'linear-gradient(90deg, #f59e0b 0%, #d97706 100%)';
                    } else {
                        progressBar.style.background = 'linear-gradient(90deg, #10b981 0%, #059669 100%)';
                    }
                }

            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®:', error);
            }
        }

        // ÿØÿßŸÑÿ© ŸÜÿ≥ÿÆ ÿßŸÑŸÜÿµ
        function copyToClipboard(text) {
            if (!text || text === 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...' || text === '**********') {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }

            navigator.clipboard.writeText(text).then(() => {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }).catch(err => {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÜÿ≥ÿÆ:', err);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            });
        }
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
        function updateSettingsStats() {
                        // ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÖÿ¥ÿØÿØÿ© (ÿØŸäŸàŸÜ ŸÖÿ™ÿ£ÿÆÿ±ÿ© ÿ£ŸÉÿ´ÿ± ŸÖŸÜ 30 ŸäŸàŸÖ)
                        const severeDebts = debtsData.filter(d => {
                            if (!d.installments || d.installments.length === 0) return false;
                            const now = new Date();
                            return d.installments.some(inst => {
                                if (inst.paid) return false;
                                const dueDate = new Date(inst.due_date);
                                return (now - dueDate) > (30 * 24 * 60 * 60 * 1000);
                            });
                        }).length;
                        updateElement('severeDebtsCount', severeDebts);
            // ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
            updateElement('settingsProductCount', products.length);
            
            // ÿπÿØÿØ ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™
            updateElement('settingsCategoryCount', categories.length);
            
            // ÿπÿØÿØ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
            updateElement('settingsInvoiceCount', salesData.length);
            
            // ŸÇŸäŸÖÿ© ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™
            const totalSales = salesData.reduce((sum, s) => sum + (s.total_amount || 0), 0);
            updateElement('settingsSalesValue', formatCurrency(totalSales));
            
            // ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÜÿ¥ÿ∑ÿ©
            const activeProducts = products.filter(p => (p.stock_quantity || 0) > 0).length;
            updateElement('activeProductsCount', activeProducts);
            
            // ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÇÿßÿ±ÿ®ÿ™ ÿßŸÑŸÜŸÅÿßÿ∞
            const lowStockProducts = products.filter(p => {
                const qty = p.stock_quantity || 0;
                const min = p.min_stock_quantity || 10;
                return qty > 0 && qty <= min;
            }).length;
            updateElement('lowStockCount', lowStockProducts);
            
            // ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÜŸÅÿ∞ÿ™
            const outOfStockProducts = products.filter(p => (p.stock_quantity || 0) === 0).length;
            updateElement('outOfStockCount', outOfStockProducts);
            
            // ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
            updateElement('totalInvoicesCount', salesData.length);
            
            // ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™
            updateElement('totalSalesAmount', formatCurrency(totalSales));
            
            // ŸÖÿ™Ÿàÿ≥ÿ∑ ŸÇŸäŸÖÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
            const averageInvoice = salesData.length > 0 ? totalSales / salesData.length : 0;
            updateElement('averageInvoice', formatCurrency(averageInvoice));
            
            // ÿπÿØÿØ ÿßŸÑŸÖÿØŸäŸÜŸäŸÜ
            const uniqueDebtors = new Set(debtsData.map(d => d.customer_name)).size;
            updateElement('totalDebtorsCount', uniqueDebtors);
            
            // ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿØŸäŸàŸÜ - ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ÿ®ÿØŸÇÿ©
            const totalDebts = debtsData.reduce((sum, d) => {
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ ŸÖŸÜ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
                let paidAmount = 0;
                if (d.installments && Array.isArray(d.installments) && d.installments.length > 0) {
                    d.installments.forEach(inst => {
                        if (inst.status === 'paid') {
                            paidAmount += parseFloat(inst.paid_amount || inst.amount || 0);
                        }
                    });
                } else if (d.paid_amount !== undefined && d.paid_amount !== null) {
                    paidAmount = parseFloat(d.paid_amount) || 0;
                }
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä
                const totalAmount = parseFloat(d.total_amount || d.final_total || 0);
                const remainingAmount = totalAmount - paidAmount;
                
                return sum + (remainingAmount > 0 ? remainingAmount : 0);
            }, 0);
            updateElement('totalDebtsAmount', formatCurrency(totalDebts));
            
            // ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÖÿ™ÿ£ÿÆÿ±ÿ©
            const overdueDebts = debtsData.filter(d => {
                if (!d.installments || d.installments.length === 0) return false;
                const now = new Date();
                return d.installments.some(inst => {
                    if (inst.paid) return false;
                    const dueDate = new Date(inst.due_date);
                    return dueDate < now;
                });
            }).length;
            updateElement('overdueDebtsCount', overdueDebts);
            
            // ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
            const lastBackup = localStorage.getItem('lastBackupDate');
            if (lastBackup) {
                const date = new Date(lastBackup);
                updateElement('lastBackupDate', date.toLocaleDateString('en-GB'));
            }
        }
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≥ÿßÿπÿ© ÿßŸÑÿ±ŸÇŸÖŸäÿ©
        function updateDigitalClock() {
            const now = new Date();
            
            // ÿßŸÑŸàŸÇÿ™
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timeString = `${hours}:${minutes}:${seconds}`;
            updateElement('digitalClockTime', timeString);
            
            // ÿßŸÑŸäŸàŸÖ
            const days = ['ÿßŸÑÿ£ÿ≠ÿØ', 'ÿßŸÑÿßÿ´ŸÜŸäŸÜ', 'ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°', 'ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°', 'ÿßŸÑÿÆŸÖŸäÿ≥', 'ÿßŸÑÿ¨ŸÖÿπÿ©', 'ÿßŸÑÿ≥ÿ®ÿ™'];
            const dayName = days[now.getDay()];
            updateElement('digitalClockDay', dayName);
            
            // ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
            const day = now.getDate();
            const months = ['ŸäŸÜÿßŸäÿ±', 'ŸÅÿ®ÿ±ÿßŸäÿ±', 'ŸÖÿßÿ±ÿ≥', 'ÿ£ÿ®ÿ±ŸäŸÑ', 'ŸÖÿßŸäŸà', 'ŸäŸàŸÜŸäŸà', 
                          'ŸäŸàŸÑŸäŸà', 'ÿ£ÿ∫ÿ≥ÿ∑ÿ≥', 'ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±', 'ÿ£ŸÉÿ™Ÿàÿ®ÿ±', 'ŸÜŸàŸÅŸÖÿ®ÿ±', 'ÿØŸäÿ≥ŸÖÿ®ÿ±'];
            const month = months[now.getMonth()];
            const year = now.getFullYear();
            const dateString = `${day} ${month} ${year}`;
            updateElement('digitalClockDate', dateString);
        }

        // ÿ•ÿπÿØÿßÿØ ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´
        function setupEventListeners() {
            // ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
            }

            // ÿÆÿµŸÖ
            const discountInput = document.getElementById('discountInput');
            if (discountInput) {
                discountInput.addEventListener('input', updateCartSummary);
            }
            
            // ÿßŸÑÿ®ÿ≠ÿ´
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', renderProducts);
            }
            
            // ÿ∑ÿ±ŸÇ ÿßŸÑÿØŸÅÿπ
            document.querySelectorAll('.payment-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.payment-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedPaymentMethod = btn.dataset.method;
                });
            });
            
            // ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿØŸÅÿπ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÅŸä ÿßŸÑÿ≥ŸÑÿ©
            const cashPaymentBtn = document.getElementById('cashPaymentBtn');
            if (cashPaymentBtn) {
                cashPaymentBtn.addEventListener('click', async () => {
                    console.log('üíµ ÿ™ŸÖ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿ≤ÿ± ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÜŸÇÿØŸä ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±');
                    console.log('ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑÿ≥ŸÑÿ©:', cart.length);
                    
                    if (cart.length === 0) {
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                        return;
                    }
                    
                    // ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÜŸÇÿØŸä ÿßŸÑÿ≠ÿØŸäÿ´ÿ©
                    console.log('‚úÖ ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÜŸÇÿØŸä ÿßŸÑÿ≠ÿØŸäÿ´ÿ©...');
                    showCashPaymentModal();
                });
            }
            
            const installmentPaymentBtn = document.getElementById('installmentPaymentBtn');
            if (installmentPaymentBtn) {
                installmentPaymentBtn.addEventListener('click', () => {
                    console.log('üìÖ ÿ™ŸÖ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿ≤ÿ± ÿßŸÑÿØŸÅÿπ ÿ®ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑');
                    console.log('ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑÿ≥ŸÑÿ©:', cart.length);
                    
                    if (cart.length === 0) {
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                        return;
                    }
                    
                    console.log('‚úÖ ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑...');
                    showModal('paymentModal');
                    showInstallmentForm();
                });
            }
            
            // ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ®Ÿäÿπ - ÿßŸÑÿ≤ÿ± ÿßŸÑŸÇÿØŸäŸÖ (ŸÑŸÑÿ™ŸàÿßŸÅŸÇ)
            const checkoutBtn = document.getElementById('checkoutBtn');
            if (checkoutBtn) {
                checkoutBtn.addEventListener('click', () => {
                    console.log('üõçÔ∏è ÿ™ŸÖ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿ≤ÿ± ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ®Ÿäÿπ');
                    console.log('ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑÿ≥ŸÑÿ©:', cart.length);
                    
                    if (cart.length === 0) {
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                        return;
                    }
                    
                    console.log('‚úÖ ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ∑ÿ±ŸÇ ÿßŸÑÿØŸÅÿπ...');
                    showModal('paymentModal');
                });
            }

            // ŸÜŸÖÿßÿ∞ÿ¨
            const addProductForm = document.getElementById('addProductForm');
            if (addProductForm) {
                addProductForm.addEventListener('submit', handleAddProduct);
            }

            const addCategoryForm = document.getElementById('addCategoryForm');
            if (addCategoryForm) {
                addCategoryForm.addEventListener('submit', handleAddCategory);
            }

            const payDebtForm = document.getElementById('payDebtForm');
            if (payDebtForm) {
                payDebtForm.addEventListener('submit', handlePayDebt);
            }

            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
            const installmentInputs = ['installmentMonths', 'additionalAmount', 'downPayment'];
            installmentInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculateInstallment);
                }
            });
            
            // ŸÅŸÑÿßÿ™ÿ± ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
            const inventoryCategory = document.getElementById('inventoryCategory');
            const stockStatus = document.getElementById('stockStatus');
            if (inventoryCategory) inventoryCategory.addEventListener('change', renderInventoryTable);
            if (stockStatus) stockStatus.addEventListener('change', renderInventoryTable);
            
            // ÿ•ÿÆŸÅÿßÿ° ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨Ÿáÿß
            document.addEventListener('click', (e) => {
                // ÿ•ÿÆŸÅÿßÿ° ŸÜÿ™ÿßÿ¶ÿ¨ ÿ®ÿ≠ÿ´ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
                const searchBox = document.querySelector('.search-box');
                const searchResults = document.getElementById('searchResults');
                if (searchResults && searchBox && !searchBox.contains(e.target)) {
                    searchResults.classList.remove('active');
                }
                
                // ÿ•ÿÆŸÅÿßÿ° ŸÜÿ™ÿßÿ¶ÿ¨ ÿ®ÿ≠ÿ´ ÿßŸÑÿπŸÖŸÑÿßÿ°
                const customerSearchWrapper = document.querySelector('.search-customer-wrapper');
                const customerSearchResults = document.getElementById('customerSearchResults');
                if (customerSearchResults && customerSearchWrapper && !customerSearchWrapper.contains(e.target)) {
                    customerSearchResults.classList.remove('active');
                }
            });
        }

        // ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebarToggle');
            
            if (sidebar && toggleBtn) {
                sidebarCollapsed = !sidebarCollapsed;
                
                if (sidebarCollapsed) {
                    sidebar.classList.add('collapsed');
                    toggleBtn.innerHTML = '<i class="fas fa-angle-double-left"></i>';
                } else {
                    sidebar.classList.remove('collapsed');
                    toggleBtn.innerHTML = '<i class="fas fa-angle-double-right"></i>';
                }
            }
        }

        // ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿ´ŸäŸÖ
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');
            
            if (currentTheme === 'dark') {
                body.setAttribute('data-theme', 'light');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                currentTheme = 'light';
            } else {
                body.setAttribute('data-theme', 'dark');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                currentTheme = 'dark';
            }
            
            // ÿ≠ŸÅÿ∏ ÿßŸÑÿ´ŸäŸÖ ŸÅŸä ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÖÿ≠ŸÑŸä
            localStorage.setItem('theme', currentTheme);
        }

        // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ÿ•ŸÑŸâ ÿµŸÅÿ≠ÿ© ÿ®ÿ¥ŸÉŸÑ ÿ®ÿ±ŸÖÿ¨Ÿä (ÿ®ÿØŸàŸÜ event)
        function navigateTo(pageId) {
            // ÿ•ÿÆŸÅÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÅÿ≠ÿßÿ™
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }
        }

        // ÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ©
        function showPage(pageId) {
            console.log('üìÑ Showing page:', pageId);
            
            // ÿ•ÿÆŸÅÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÅÿ≠ÿßÿ™ (ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© ŸàÿßŸÑŸÅÿ±ÿπŸäÿ©)
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none';
            });
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.style.display = 'block';
                targetPage.classList.add('active');
                console.log('‚úÖ Page shown:', pageId);
            } else {
                console.error('‚ùå Page not found:', pageId);
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸÜŸÇŸÑ
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // ÿ•ÿ∂ÿßŸÅÿ© active ŸÑŸÑÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ≠ÿßŸÑŸä
            const activeLink = document.querySelector(`.nav-link[onclick*="'${pageId}'"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿπŸÜÿßÿµÿ± ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ©
            if (window.securityManager) {
                setTimeout(() => {
                    window.securityManager.applyPermissionsToElements();
                }, 100);
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿπŸÜŸàÿßŸÜ ÿßŸÑÿµŸÅÿ≠ÿ©
            const pageTitles = {
                'pos': 'ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ',
                'products': 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™',
                'inventory': 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿÆÿ≤ŸÜ',
                'maintenance': 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸäÿßŸÜÿ©',
                'spareParts': 'ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ±',
                'deliveredDevices': 'ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ©',
                'invoices': 'ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±',
                'debts': 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿØŸäŸàŸÜ',
                'payments': 'ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ŸàÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑',
                'expenses': 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ',
                'printer': 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ∑ÿßÿ®ÿπÿ©',
                'settings': 'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©'
            };
            
            const titleElement = document.getElementById('currentPageTitle');
            if (titleElement) {
                titleElement.textContent = pageTitles[pageId] || 'ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ';
            }
            
            // ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿÆÿßÿµÿ© ÿ®ÿßŸÑÿµŸÅÿ≠ÿßÿ™
            if (pageId === 'printer') {
                // ÿ™ŸáŸäÿ¶ÿ© ÿµŸÅÿ≠ÿ© ÿßŸÑÿ∑ÿßÿ®ÿπÿ©
                setTimeout(() => {
                    initPrinterPage();
                }, 100);
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ© ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿµŸÅÿ≠ÿ©
            if (pageId === 'maintenance') {
                setTimeout(() => {
                    displayMaintenanceData();
                    updateMaintenanceStats();
                }, 100);
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ŸÇÿ∑ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿµŸÅÿ≠ÿ©
            if (pageId === 'spareParts') {
                setTimeout(() => {
                    displaySparePartsData();
                    updateSparePartsStats();
                    checkStockAlerts();
                }, 100);
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ© ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿµŸÅÿ≠ÿ©
            if (pageId === 'deliveredDevices') {
                setTimeout(() => {
                    displayDeliveredDevicesData();
                    updateDeliveredStats();
                }, 100);
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
            if (pageId === 'settings') {
                setTimeout(() => {
                    updateSettingsStats();
                }, 100);
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®
            if (pageId === 'settings-account') {
                setTimeout(() => {
                    updateCloudSubscriptionUI();
                }, 100);
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
            if (pageId === 'settings-backup') {
                setTimeout(() => {
                    updateRegistrationUI();
                }, 100);
            }
        }

        // ÿ•ÿ∏Ÿáÿßÿ± ŸÜÿßŸÅÿ∞ÿ© ŸÖŸÜÿ®ÿ´ŸÇÿ©
        function showModal(modalId) {
            console.log('ü™ü ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ©:', modalId);
            const modal = document.getElementById(modalId);
            
            if (modal) {
                modal.classList.add('active');
                console.log('‚úÖ ÿ™ŸÖ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                
                // ÿ•ÿπÿØÿßÿØ ÿÆÿßÿµ ŸÑŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ™ÿµŸÜŸäŸÅ
                if (modalId === 'addCategoryModal') {
                    renderCategoryIcons();
                }
                
                // ÿ•ÿπÿØÿßÿØ ÿÆÿßÿµ ŸÑŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿØŸÅÿπ
                if (modalId === 'paymentModal') {
                    // ÿ•ÿÆŸÅÿßÿ° ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
                    const installmentForm = document.getElementById('installmentForm');
                    if (installmentForm) {
                        installmentForm.style.display = 'none';
                    }
                    console.log('üí≥ ÿ¨ÿßŸáÿ≤ ŸÑÿßÿÆÿ™Ÿäÿßÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ');
                }
            } else {
                console.error('‚ùå ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©:', modalId);
            }
        }

        // ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ŸÖŸÜÿ®ÿ´ŸÇÿ©
        function closeModal(modalId) {
            console.log('üö™ ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ©:', modalId);
            const modal = document.getElementById(modalId);
            
            if (modal) {
                modal.classList.remove('active');
                console.log('‚úÖ ÿ™ŸÖ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©');
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÜŸÖÿßÿ∞ÿ¨
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                }
                
                // ÿ•ÿÆŸÅÿßÿ° ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿπŸÜÿØ ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿØŸÅÿπ
                if (modalId === 'paymentModal') {
                    const installmentForm = document.getElementById('installmentForm');
                    if (installmentForm) {
                        installmentForm.style.display = 'none';
                    }
                }
            } else {
                console.error('‚ùå ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©:', modalId);
            }
        }

        // ÿ•ÿ∏Ÿáÿßÿ± ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨
        function showAddProductModal() {
            showModal('addProductModal');
        }

        // ÿ•ÿ∏Ÿáÿßÿ± ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿµŸÜŸäŸÅ
        function showAddCategoryModal() {
            showModal('addCategoryModal');
        }

        // ÿπÿ±ÿ∂ ÿ£ŸäŸÇŸàŸÜÿßÿ™ ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™
        function renderCategoryIcons() {
            const iconGrid = document.getElementById('categoryIconGrid');
            if (!iconGrid) return;
            
            iconGrid.innerHTML = availableIcons.map(icon => `
                <div class="category-icon-btn" data-icon="${icon}" onclick="selectCategoryIcon('${icon}')">
                    <i class="${icon}"></i>
                </div>
            `).join('');
            
            // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
            selectCategoryIcon('fas fa-box');
        }

        // ÿßÿÆÿ™Ÿäÿßÿ± ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑÿ™ÿµŸÜŸäŸÅ
        function selectCategoryIcon(icon) {
            document.querySelectorAll('.category-icon-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            const selectedBtn = document.querySelector(`[data-icon="${icon}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
                document.getElementById('selectedCategoryIcon').value = icon;
            }
        }

        // ÿ™ŸàŸÑŸäÿØ ÿ®ÿßÿ±ŸÉŸàÿØ
        function generateBarcode() {
            const barcodeInput = document.getElementById('productBarcode');
            if (barcodeInput) {
                const barcode = Date.now().toString() + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                barcodeInput.value = barcode;
            }
        }

        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨
        async function handleAddProduct(event) {
            event.preventDefault();
            
            // ŸÅÿ≠ÿµ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©
            if (!window.securityManager.checkPermission('products_add')) {
                return;
            }
            
            if (isLoading) return;
            setLoading(true);
            
            const productData = {
                type: 'product',
                product_id: Date.now().toString(),
                product_name: document.getElementById('productName').value,
                product_barcode: document.getElementById('productBarcode').value || generateBarcodeString(),
                product_cost_retail: parseFloat(document.getElementById('productCostRetail').value),
                product_cost_wholesale: parseFloat(document.getElementById('productCostWholesale').value) || parseFloat(document.getElementById('productCostRetail').value),
                product_price_retail: parseFloat(document.getElementById('productPriceRetail').value),
                product_price_wholesale: parseFloat(document.getElementById('productPriceWholesale').value) || parseFloat(document.getElementById('productPriceRetail').value),
                stock_quantity: parseInt(document.getElementById('productStock').value),
                min_stock: parseInt(document.getElementById('productMinStock').value),
                product_category: document.getElementById('productCategory').value,
                supplier: document.getElementById('productSupplier').value || '',
                timestamp: new Date().toISOString(),
                // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                created_by: window.securityManager.getCurrentUsername(),
                created_by_name: window.securityManager.getCurrentUserFullName(),
                created_at: new Date().toISOString()
            };

            if (window.dataSdk) {
                const result = await window.dataSdk.create(productData);
                if (result.isOk) {
                    // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ©
                    window.securityManager.logOperation('ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨', {
                        productId: productData.product_id,
                        productName: productData.product_name,
                        barcode: productData.product_barcode
                    });
                    
                    closeModal('addProductModal');
                    document.getElementById('addProductForm').reset();
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                } else {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                }
            }
            
            setLoading(false);
        }

        // ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨
        function showEditProductModal(productId) {
            const product = products.find(p => p.product_id === productId);
            if (!product) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            // ŸÖŸÑÿ° ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨
            document.getElementById('editProductId').value = productId;
            document.getElementById('editProductName').value = product.product_name;
            document.getElementById('editProductBarcode').value = product.product_barcode || '';
            document.getElementById('editProductCategory').value = product.product_category || '';
            document.getElementById('editProductSupplier').value = product.supplier || '';
            document.getElementById('editProductCostRetail').value = product.product_cost_retail;
            document.getElementById('editProductCostWholesale').value = product.product_cost_wholesale || '';
            document.getElementById('editProductPriceRetail').value = product.product_price_retail;
            document.getElementById('editProductPriceWholesale').value = product.product_price_wholesale || '';
            document.getElementById('editProductStock').value = product.stock_quantity;
            document.getElementById('editProductMinStock').value = product.min_stock;
            
            // ŸÖŸÑÿ° ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™
            populateCategorySelects();
            document.getElementById('editProductCategory').value = product.product_category || '';
            
            showModal('editProductModal');
        }

        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨
        async function handleEditProduct(event) {
            event.preventDefault();
            
            // ŸÅÿ≠ÿµ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©
            if (!window.securityManager.checkPermission('products_edit')) {
                return;
            }
            
            if (isLoading) return;
            setLoading(true);
            
            const productId = document.getElementById('editProductId').value;
            const product = products.find(p => p.product_id === productId);
            
            if (!product) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                setLoading(false);
                return;
            }
            
            const updatedData = {
                product_name: document.getElementById('editProductName').value,
                product_barcode: document.getElementById('editProductBarcode').value,
                product_category: document.getElementById('editProductCategory').value,
                supplier: document.getElementById('editProductSupplier').value || '',
                product_cost_retail: parseFloat(document.getElementById('editProductCostRetail').value),
                product_cost_wholesale: parseFloat(document.getElementById('editProductCostWholesale').value) || parseFloat(document.getElementById('editProductCostRetail').value),
                product_price_retail: parseFloat(document.getElementById('editProductPriceRetail').value),
                product_price_wholesale: parseFloat(document.getElementById('editProductPriceWholesale').value) || parseFloat(document.getElementById('editProductPriceRetail').value),
                stock_quantity: parseInt(document.getElementById('editProductStock').value),
                min_stock: parseInt(document.getElementById('editProductMinStock').value),
                // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿπÿØŸäŸÑ
                modified_by: window.securityManager.getCurrentUsername(),
                modified_by_name: window.securityManager.getCurrentUserFullName(),
                modified_at: new Date().toISOString()
            };
            
            if (window.dataSdk && (product.id || product.__backendId)) {
                const updateId = product.id || product.__backendId;
                const result = await window.dataSdk.update(updateId, updatedData);
                
                if (result.isOk) {
                    // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ©
                    window.securityManager.logOperation('ÿ™ÿπÿØŸäŸÑ ŸÖŸÜÿ™ÿ¨', {
                        productId: product.product_id,
                        productName: updatedData.product_name,
                        barcode: updatedData.product_barcode
                    });
                    
                    closeModal('editProductModal');
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                } else {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                }
            }
            
            setLoading(false);
        }

        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿµŸÜŸäŸÅ
        async function handleAddCategory(event) {
            event.preventDefault();
            
            if (isLoading) return;
            setLoading(true);
            
            const categoryName = document.getElementById('categoryName').value;
            const categoryIcon = document.getElementById('selectedCategoryIcon').value;
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            if (!categoryName || !categoryName.trim()) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                setLoading(false);
                return;
            }
            
            const categoryData = {
                type: 'category',
                category_id: Date.now().toString(),
                category_name: categoryName.trim(),
                category_icon: categoryIcon || 'fas fa-box',
                timestamp: new Date().toISOString()
            };

            try {
                if (window.dataSdk) {
                    const result = await window.dataSdk.create(categoryData);
                    if (result.isOk) {
                        // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ™ÿµŸÜŸäŸÅ ŸÑŸÑŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
                        categories.push(categoryData);
                        
                        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
                        updateAllViews();
                        
                        // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© Ÿàÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨
                        closeModal('addCategoryModal');
                        document.getElementById('addCategoryForm').reset();
                        
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    } else {
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    }
                } else {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                }
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ™ÿµŸÜŸäŸÅ:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
            
            setLoading(false);
        }

        // ÿ™ŸàŸÑŸäÿØ ÿ®ÿßÿ±ŸÉŸàÿØ ŸÉŸÜÿµ
        function generateBarcodeString() {
            return Date.now().toString() + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        }

        // ŸÖŸÑÿ° ŸÇŸàÿßÿ¶ŸÖ ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™
        function populateCategorySelects() {
            const selects = ['productCategory', 'inventoryCategory'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    
                    if (selectId === 'inventoryCategory') {
                        select.innerHTML = '<option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™</option>';
                    } else {
                        select.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅ</option>';
                    }
                    
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.category_id;
                        option.textContent = category.category_name;
                        select.appendChild(option);
                    });
                    
                    if (currentValue) {
                        select.value = currentValue;
                    }
                }
            });
        }

        // ÿπÿ±ÿ∂ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
        function renderProductsTable() {
            const tbody = document.getElementById('productsTableBody');
            if (!tbody) return;
            
            // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ - ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã
            const sortedProducts = [...products].sort((a, b) => {
                const dateA = new Date(a.created_at || a.timestamp || 0);
                const dateB = new Date(b.created_at || b.timestamp || 0);
                return dateB.getTime() - dateA.getTime();
            });
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
            const searchTerm = document.getElementById('productsSearchInput')?.value.toLowerCase() || '';
            const filteredProducts = searchTerm 
                ? sortedProducts.filter(product => 
                    (product.product_name && product.product_name.toLowerCase().includes(searchTerm)) ||
                    (product.product_barcode && product.product_barcode.toLowerCase().includes(searchTerm)) ||
                    (product.supplier && product.supplier.toLowerCase().includes(searchTerm))
                  )
                : sortedProducts;
            
            tbody.innerHTML = filteredProducts.map(product => {
                const category = categories.find(c => c.category_id === product.product_category);
                const categoryName = category ? category.category_name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                const stockClass = product.stock_quantity < product.min_stock ? 'text-warning' : 'text-success';

                // ÿ•ŸÜÿ¥ÿßÿ° ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
                let actionButtons = '';
                
                // ÿ≤ÿ± ÿßŸÑÿπÿ±ÿ∂ (ŸÖÿ™ÿßÿ≠ ŸÑŸÑÿ¨ŸÖŸäÿπ)
                actionButtons += `<button class="action-btn view-btn" onclick="showProductDetails('${product.product_id}')" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ"><i class="fas fa-eye"></i></button>`;
                
                // ÿ≤ÿ± ÿßŸÑÿ™ÿπÿØŸäŸÑ (Ÿäÿ≠ÿ™ÿßÿ¨ ÿµŸÑÿßÿ≠Ÿäÿ©)
                if (window.securityManager && window.securityManager.hasPermission('products_edit')) {
                    actionButtons += `<button class="action-btn edit-btn" onclick="if(window.securityManager.checkPermission('products_edit')) showEditProductModal('${product.product_id}')" title="ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨" data-permission="products_edit"><i class="fas fa-edit"></i></button>`;
                }
                
                // ÿ≤ÿ± ÿßŸÑÿ≠ÿ∞ŸÅ (Ÿäÿ≠ÿ™ÿßÿ¨ ÿµŸÑÿßÿ≠Ÿäÿ©)
                if (window.securityManager && window.securityManager.hasPermission('products_delete')) {
                    actionButtons += `<button class="action-btn delete-btn" onclick="if(window.securityManager.checkPermission('products_delete')) deleteProduct('${product.product_id}')" title="ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨" data-permission="products_delete"><i class="fas fa-trash"></i></button>`;
                }

                return `
                    <tr>
                        <td>${product.product_barcode || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="${category ? category.category_icon : 'fas fa-box'}"></i>
                                ${product.product_name}
                            </div>
                        </td>
                        <td>${categoryName}</td>
                        <td>${formatCurrency(product.product_price_retail)}</td>
                        <td>${formatCurrency(product.product_cost_retail)}</td>
                        <td>
                            <span class="${stockClass}">
                                ${product.stock_quantity}
                            </span>
                        </td>
                        <td>
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ÿπÿ±ÿ∂ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
        function renderInventoryTable() {
            const tbody = document.getElementById('inventoryTableBody');
            if (!tbody) return;
            
            const categoryFilter = document.getElementById('inventoryCategory')?.value || 'all';
            const statusFilter = document.getElementById('stockStatus')?.value || 'all';
            const searchTerm = document.getElementById('inventorySearchInput')?.value.toLowerCase() || '';
            
            // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ - ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã
            let filteredProducts = [...products].sort((a, b) => {
                const dateA = new Date(a.created_at || a.timestamp || 0);
                const dateB = new Date(b.created_at || b.timestamp || 0);
                return dateB.getTime() - dateA.getTime();
            });
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(product => 
                    (product.product_name && product.product_name.toLowerCase().includes(searchTerm)) ||
                    (product.product_barcode && product.product_barcode.toLowerCase().includes(searchTerm)) ||
                    (product.supplier && product.supplier.toLowerCase().includes(searchTerm))
                );
            }
            
            if (categoryFilter !== 'all') {
                filteredProducts = filteredProducts.filter(p => p.product_category === categoryFilter);
            }
            
            if (statusFilter !== 'all') {
                filteredProducts = filteredProducts.filter(p => {
                    if (statusFilter === 'in-stock') return p.stock_quantity > p.min_stock;
                    if (statusFilter === 'low-stock') return p.stock_quantity <= p.min_stock && p.stock_quantity > 0;
                    if (statusFilter === 'out-of-stock') return p.stock_quantity === 0;
                    return true;
                });
            }
            
            tbody.innerHTML = filteredProducts.map(product => {
                const category = categories.find(c => c.category_id === product.product_category);
                const categoryName = category ? category.category_name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                const totalCost = product.stock_quantity * product.product_cost_retail;
                const totalValue = product.stock_quantity * product.product_price_retail;
                const profit = totalValue - totalCost;
                
                let status = 'ŸÖÿ™ŸàŸÅÿ±';
                let statusClass = 'text-success';
                
                if (product.stock_quantity === 0) {
                    status = 'ŸÜŸÅÿØ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ';
                    statusClass = 'text-danger';
                } else if (product.stock_quantity <= product.min_stock) {
                    status = 'ŸÖÿÆÿ≤ŸàŸÜ ŸÇŸÑŸäŸÑ';
                    statusClass = 'text-warning';
                }
                
                return `
                    <tr data-product-id="${product.product_id}">
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="${category ? category.category_icon : 'fas fa-box'}"></i>
                                ${product.product_name}
                            </div>
                        </td>
                        <td>${categoryName}</td>
                        <td>${product.stock_quantity}</td>
                        <td>${formatCurrency(totalCost)}</td>
                        <td>${formatCurrency(totalValue)}</td>
                        <td class="text-success">${formatCurrency(profit)}</td>
                        <td>
                            <span class="${statusClass}">${status}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ÿπÿ±ÿ∂ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
        function renderInvoicesTable() {
            const tbody = document.getElementById('invoicesTableBody');
            if (!tbody) return;
            
            // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ - ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã
            const sortedSales = [...salesData].sort((a, b) => {
                const dateA = new Date(a.timestamp || a.date || a.created_at || 0);
                const dateB = new Date(b.timestamp || b.date || b.created_at || 0);
                return dateB.getTime() - dateA.getTime();
            });
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
            const searchTerm = document.getElementById('invoicesSearchInput')?.value.toLowerCase() || '';
            const filteredSales = searchTerm 
                ? sortedSales.filter(sale => 
                    (sale.invoice_id && sale.invoice_id.toLowerCase().includes(searchTerm)) ||
                    (sale.customer_name && sale.customer_name.toLowerCase().includes(searchTerm)) ||
                    (sale.payment_method && sale.payment_method.toLowerCase().includes(searchTerm)) ||
                    (sale.created_by_name && sale.created_by_name.toLowerCase().includes(searchTerm))
                  )
                : sortedSales;
            
            tbody.innerHTML = filteredSales.map(sale => {
                // ÿ™ÿ≠ÿØŸäÿØ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ∞Ÿä ÿ£ŸÜÿ¥ÿ£ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                const createdByName = sale.created_by_name || sale.created_by || 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                const createdByRole = sale.created_by_role || (sale.created_by === 'admin' ? 'ŸÖÿØŸäÿ±' : 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ');
                
                // ÿ•ŸÜÿ¥ÿßÿ° ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™
                const isInstallmentInvoice = sale.payment_type === 'ÿ£ŸÇÿ≥ÿßÿ∑';
                
                let actionButtons = `
                    <button class="action-btn view-btn" onclick="showInvoiceDetails('${sale.invoice_id}')" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-btn view-btn" onclick="${isInstallmentInvoice ? `printInvoiceFromDetails('${sale.invoice_id}', true)` : `printInvoice('${sale.invoice_id}')`}" title="ÿ∑ÿ®ÿßÿπÿ©">
                        <i class="fas fa-print"></i>
                    </button>
                `;
                
                // ÿ•ÿ∂ÿßŸÅÿ© ÿ≤ÿ± ÿßŸÑÿ≠ÿ∞ŸÅ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÑÿØŸäŸá ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©
                if (window.securityManager && window.securityManager.hasPermission('invoices_delete')) {
                    actionButtons += `
                        <button class="action-btn delete-btn" 
                                onclick="if(window.securityManager.checkPermission('invoices_delete')) confirmDeleteInvoice('${sale.invoice_id}', '${sale.customer_name || 'ÿπŸÖŸäŸÑ ŸÜŸÇÿØŸä'}')" 
                                title="ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©"
                                data-permission="invoices_delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                }
                
                return `
                    <tr>
                        <td>${sale.invoice_id}</td>
                        <td>${new Date(sale.timestamp).toLocaleDateString('en-GB')}</td>
                        <td>${sale.customer_name || 'ÿπŸÖŸäŸÑ ŸÜŸÇÿØŸä'}</td>
                        <td>${formatCurrency(sale.final_total)}</td>
                        <td>
                            <span style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-${sale.payment_method === 'ŸÜŸÇÿØŸä' ? 'money-bill-wave' : 'credit-card'}"></i>
                                ${sale.payment_type || sale.payment_method}
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.3rem;">
                                <i class="fas fa-user" style="color: #666; font-size: 0.9em;"></i>
                                <span style="font-weight: 500;">${createdByName}</span>
                                <span style="color: #999; font-size: 0.85em;">(${createdByRole})</span>
                            </div>
                        </td>
                        <td>
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ÿπÿ±ÿ∂ ÿ¨ÿØŸàŸÑ ÿßŸÑÿØŸäŸàŸÜ
        // ŸÖÿ™ÿ∫Ÿäÿ± ÿπÿßŸÖ ŸÑÿ≠ŸÅÿ∏ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÅŸÑÿ™ÿ± ÿßŸÑÿ≠ÿßŸÑŸäÿ©
        let currentDebtFilter = 'all';
        
        function renderDebtsTable() {
            const tbody = document.getElementById('debtsTableBody');
            if (!tbody) return;
            
            console.log('Rendering debts:', debtsData);
            console.log('Current filter:', currentDebtFilter);
            
            // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ - ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã
            const sortedDebts = [...debtsData].sort((a, b) => {
                const dateA = new Date(a.timestamp || a.date || a.created_at || 0);
                const dateB = new Date(b.timestamp || b.date || b.created_at || 0);
                return dateB.getTime() - dateA.getTime();
            });
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿØŸäŸàŸÜ
            const searchTerm = document.getElementById('debtsSearchInput')?.value.toLowerCase() || '';
            let filteredDebts = searchTerm 
                ? sortedDebts.filter(debt => 
                    (debt.customer_name && debt.customer_name.toLowerCase().includes(searchTerm)) ||
                    (debt.customer_phone && debt.customer_phone.toLowerCase().includes(searchTerm)) ||
                    (debt.customer_address && debt.customer_address.toLowerCase().includes(searchTerm))
                  )
                : sortedDebts;
            
            // üî• ÿ™ÿ∑ÿ®ŸäŸÇ ŸÅŸÑÿ™ÿ± ÿßŸÑÿ≠ÿßŸÑÿ©
            if (currentDebtFilter !== 'all') {
                filteredDebts = filteredDebts.filter(debt => {
                    // ÿ≠ÿ≥ÿßÿ® ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸäŸÜ
                    let paidAmount = 0;
                    let totalMonths = 0;
                    let paidMonths = 0;
                    
                    if (debt.installments && Array.isArray(debt.installments) && debt.installments.length > 0) {
                        totalMonths = debt.installments.length;
                        debt.installments.forEach(inst => {
                            if (inst.status === 'paid') {
                                paidAmount += parseFloat(inst.paid_amount || inst.amount || 0);
                                paidMonths++;
                            }
                        });
                    } else if (debt.paid_amount !== undefined && debt.paid_amount !== null) {
                        paidAmount = parseFloat(debt.paid_amount) || 0;
                        totalMonths = debt.installment_months || 0;
                    }
                    
                    const totalAmount = debt.total_amount || debt.final_total || 0;
                    const remainingAmount = totalAmount - paidAmount;
                    const isPaid = paidMonths === totalMonths && totalMonths > 0;
                    
                    // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ™ÿ£ÿÆŸäÿ± ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÅÿπŸÑŸäÿ©
                    let isOverdue = false;
                    if (debt.installments && Array.isArray(debt.installments) && debt.installments.length > 0) {
                        const unpaidOverdue = debt.installments.filter(inst => {
                            if (inst.status === 'paid') return false;
                            const dueDate = new Date(inst.due_date);
                            return dueDate < new Date();
                        });
                        isOverdue = unpaidOverdue.length > 0;
                    } else {
                        const checkDate = debt.due_date || debt.start_date || debt.date;
                        if (checkDate) {
                            const dueDate = new Date(checkDate);
                            isOverdue = dueDate < new Date() && remainingAmount > 0 && !isPaid;
                        }
                    }
                    
                    // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÅŸÑÿ™ÿ± ÿßŸÑŸÖŸÜÿßÿ≥ÿ®
                    if (currentDebtFilter === 'paid') {
                        return isPaid;
                    } else if (currentDebtFilter === 'overdue') {
                        return isOverdue;
                    } else if (currentDebtFilter === 'active') {
                        return !isPaid && !isOverdue;
                    }
                    
                    return true;
                });
            }
            
            console.log('Filtered debts:', filteredDebts.length);
            
            tbody.innerHTML = filteredDebts.map(debt => {
                console.log('Debt data:', debt);
                
                // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
                const totalAmount = debt.total_amount || debt.final_total || 0;
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ ŸÖŸÜ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
                let paidAmount = 0;
                let paidMonths = 0;
                
                if (debt.installments && Array.isArray(debt.installments) && debt.installments.length > 0) {
                    debt.installments.forEach(inst => {
                        if (inst.status === 'paid') {
                            paidAmount += parseFloat(inst.paid_amount || inst.amount || 0);
                            paidMonths++;
                        }
                    });
                } else if (debt.paid_amount !== undefined && debt.paid_amount !== null) {
                    paidAmount = parseFloat(debt.paid_amount) || 0;
                }
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä
                let remainingAmount = totalAmount - paidAmount;
                if (remainingAmount < 0) remainingAmount = 0;
                
                // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä
                let monthlyAmount = debt.monthly_amount || 0;
                
                // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ŸÇÿ≥ÿ∑ ÿ¥Ÿáÿ±Ÿä ŸÖÿ≠ÿ≥Ÿàÿ®ÿå ÿßÿ≠ÿ≥ÿ®Ÿá ŸÖŸÜ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
                if (!monthlyAmount && totalAmount > 0 && debt.installment_months > 0) {
                    monthlyAmount = totalAmount / debt.installment_months;
                }
                
                // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ±
                let totalMonths = debt.installment_months || 0;
                if (debt.installments && Array.isArray(debt.installments)) {
                    totalMonths = debt.installments.length;
                }
                
                let isPaid = paidMonths === totalMonths && totalMonths > 0;
                
                // ÿ≠ÿ≥ÿßÿ® ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ£ÿÆŸäÿ± ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÅÿπŸÑŸäÿ©
                let isOverdue = false;
                if (debt.installments && Array.isArray(debt.installments) && debt.installments.length > 0) {
                    // ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ŸÇÿ≥ÿßÿ∑ ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπÿ© ŸàŸÖÿ™ÿ£ÿÆÿ±ÿ©
                    const unpaidOverdue = debt.installments.filter(inst => {
                        if (inst.status === 'paid') return false;
                        const dueDate = new Date(inst.due_date);
                        return dueDate < new Date();
                    });
                    isOverdue = unpaidOverdue.length > 0;
                } else {
                    // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ÿ£ŸÇÿ≥ÿßÿ∑ÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ due_date ÿ£Ÿà start_date
                    const checkDate = debt.due_date || debt.start_date || debt.date;
                    if (checkDate) {
                        const dueDate = new Date(checkDate);
                        isOverdue = dueDate < new Date() && remainingAmount > 0 && !isPaid;
                    }
                }
                
                console.log('Debt:', debt.customer_name, '- Total:', totalAmount, 'Paid:', paidAmount, 'Remaining:', remainingAmount, 'Monthly:', monthlyAmount);
                console.log('Paid months:', paidMonths, '/', totalMonths, 'isPaid:', isPaid, 'isOverdue:', isOverdue);
                
                let status = `${paidMonths}/${totalMonths} ÿ¥Ÿáÿ±`;
                let statusClass = 'debt-status active';
                
                if (isPaid) {
                    status = 'ŸÖÿ≥ÿØÿØ';
                    statusClass = 'debt-status paid';
                } else if (isOverdue) {
                    status = `ŸÖÿ™ÿ£ÿÆÿ± (${paidMonths}/${totalMonths})`;
                    statusClass = 'debt-status overdue';
                }
                
                return `
                    <tr data-debt-id="${debt.id || debt.__backendId}">
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-user"></i>
                                ${debt.customer_name}
                                ${debt.merge_count && debt.merge_count > 0 ? `
                                    <span class="merge-badge" title="ÿ™ŸÖ ÿØŸÖÿ¨ ${debt.merge_count} ${debt.merge_count === 1 ? 'ÿØŸäŸÜ' : 'ÿØŸäŸàŸÜ'} ÿ•ÿ∂ÿßŸÅŸäÿ©">
                                        <i class="fas fa-layer-group"></i>
                                        ${debt.merge_count}
                                    </span>
                                ` : ''}
                            </div>
                        </td>
                        <td>${debt.customer_phone}</td>
                        <td>${formatCurrency(paidAmount)}</td>
                        <td>${formatCurrency(remainingAmount)}</td>
                        <td>${formatCurrency(monthlyAmount)}</td>
                        <td>${debt.start_date ? new Date(debt.start_date).toLocaleDateString('en-GB') : (debt.date ? new Date(debt.date).toLocaleDateString('en-GB') : '-')}</td>
                        <td>
                            <span class="${statusClass}">${status}</span>
                        </td>
                        <td>
                            ${window.securityManager && window.securityManager.hasPermission('debts_view_details') ? `
                            <button class="action-btn view-btn" onclick="if(window.securityManager.checkPermission('debts_view_details')) showDebtDetails('${debt.id || debt.__backendId || debt.debt_id}')" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ" data-permission="debts_view_details">
                                <i class="fas fa-eye"></i>
                            </button>
                            ` : ''}
                            ${!isPaid && window.securityManager && window.securityManager.hasPermission('debts_edit') ? `
                            <button class="action-btn edit-btn" onclick="if(window.securityManager.checkPermission('debts_edit')) showEditDebtModal('${debt.id || debt.__backendId || debt.debt_id}')" title="ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿØŸäŸÜ" data-permission="debts_edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            ` : ''}
                            ${!isPaid && window.securityManager && window.securityManager.hasPermission('debts_payment') ? `
                                <button class="action-btn edit-btn" onclick="if(window.securityManager.checkPermission('debts_payment')) showQuickPayModal('${debt.id || debt.__backendId || debt.debt_id}')" title="ÿ™ÿ≥ÿØŸäÿØ ŸÇÿ≥ÿ∑" data-permission="debts_payment">
                                    <i class="fas fa-money-bill-wave"></i>
                                </button>
                            ` : ''}
                            ${window.securityManager && window.securityManager.hasPermission('debts_delete') ? `
                            <button class="action-btn delete-btn" onclick="if(window.securityManager.checkPermission('debts_delete')) confirmDeleteDebt('${debt.id || debt.__backendId || debt.debt_id}', '${debt.customer_name}')" title="ÿ≠ÿ∞ŸÅ ÿßŸÑÿØŸäŸÜ" data-permission="debts_delete">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
            updateDebtsStats();
        }
        
        // üî• ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿØŸäŸàŸÜ
        function updateDebtsStats() {
            console.log('üîÑ ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿØŸäŸàŸÜ...');
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
            let totalDebtsAmount = 0;
            let uniqueCustomers = new Set();
            let overdueCount = 0;
            let paidCount = 0;
            let activeCount = 0;
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿπŸÖŸÑÿßÿ° ŸÖŸÜ debtsData (ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸäÿØŸàŸäÿ© ŸàÿßŸÑÿ™ŸÇÿ≥Ÿäÿ∑ ŸÖŸÜ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ)
            debtsData.forEach(debt => {
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
                const debtTotal = debt.total_amount || debt.final_total || 0;
                totalDebtsAmount += debtTotal;
                
                // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿπŸÖŸäŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÖÿ¨ŸÖŸàÿπÿ© ÿßŸÑŸÅÿ±ŸäÿØÿ© (ÿ≠ÿ≥ÿ® ÿßŸÑŸáÿßÿ™ŸÅ)
                if (debt.customer_phone) {
                    uniqueCustomers.add(debt.customer_phone);
                }
                
                // ÿ≠ÿ≥ÿßÿ® ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸäŸÜ
                let paidAmount = 0;
                let totalMonths = 0;
                let paidMonths = 0;
                
                if (debt.installments && Array.isArray(debt.installments) && debt.installments.length > 0) {
                    totalMonths = debt.installments.length;
                    debt.installments.forEach(inst => {
                        if (inst.status === 'paid') {
                            paidAmount += parseFloat(inst.paid_amount || inst.amount || 0);
                            paidMonths++;
                        }
                    });
                } else if (debt.paid_amount !== undefined && debt.paid_amount !== null) {
                    paidAmount = parseFloat(debt.paid_amount) || 0;
                    totalMonths = debt.installment_months || 0;
                }
                
                const isPaid = paidMonths === totalMonths && totalMonths > 0;
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ™ÿ£ÿÆŸäÿ±
                let isOverdue = false;
                if (debt.installments && Array.isArray(debt.installments) && debt.installments.length > 0) {
                    const unpaidOverdue = debt.installments.filter(inst => {
                        if (inst.status === 'paid') return false;
                        const dueDate = new Date(inst.due_date);
                        return dueDate < new Date();
                    });
                    isOverdue = unpaidOverdue.length > 0;
                } else {
                    const checkDate = debt.due_date || debt.start_date || debt.date;
                    if (checkDate) {
                        const dueDate = new Date(checkDate);
                        const remainingAmount = debtTotal - paidAmount;
                        isOverdue = dueDate < new Date() && remainingAmount > 0 && !isPaid;
                    }
                }
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿØÿßÿØÿßÿ™
                if (isPaid) {
                    paidCount++;
                } else if (isOverdue) {
                    overdueCount++;
                } else {
                    activeCount++;
                }
            });
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿπŸÖŸÑÿßÿ° ŸÖŸÜ salesData (ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ÿ®ÿßŸÑÿ™ŸÇÿ≥Ÿäÿ∑ ŸÖŸÜ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™Ÿä ŸÑŸÖ ÿ™Ÿèÿ∂ÿßŸÅ ŸÑŸÄ debtsData)
            if (typeof salesData !== 'undefined' && Array.isArray(salesData)) {
                salesData.forEach(sale => {
                    // ŸÅŸÇÿ∑ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ÿ®ÿßŸÑÿ™ŸÇÿ≥Ÿäÿ∑
                    if (sale.payment_method === 'installment' && sale.customer_phone) {
                        // ÿ™ÿ≠ŸÇŸÇ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿπŸÖŸäŸÑ ŸÖŸàÿ¨ŸàÿØ ŸÅŸä debtsData
                        const existsInDebts = debtsData.some(debt => debt.customer_phone === sale.customer_phone);
                        if (!existsInDebts) {
                            uniqueCustomers.add(sale.customer_phone);
                        }
                    }
                });
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπŸÜÿßÿµÿ± ŸÅŸä ÿßŸÑŸàÿßÿ¨Ÿáÿ©
            const totalDebtsEl = document.getElementById('totalDebts');
            const debtCustomersEl = document.getElementById('debtCustomers');
            const overdueDebtsEl = document.getElementById('overdueDebts');
            const paidDebtsEl = document.getElementById('paidDebts');
            
            if (totalDebtsEl) totalDebtsEl.textContent = toEnglishDigits(formatCurrency(totalDebtsAmount));
            if (debtCustomersEl) debtCustomersEl.textContent = toEnglishDigits(uniqueCustomers.size);
            if (overdueDebtsEl) overdueDebtsEl.textContent = toEnglishDigits(overdueCount);
            if (paidDebtsEl) paidDebtsEl.textContent = toEnglishDigits(paidCount);
            
            console.log('‚úÖ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™:', {
                total: totalDebtsAmount,
                customers: uniqueCustomers.size,
                overdue: overdueCount,
                paid: paidCount,
                active: activeCount
            });
        }
        
        // üî• ÿØÿßŸÑÿ© ÿ¨ÿØŸäÿØÿ© ŸÑŸÑŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿßŸÑÿ©
        function filterDebtsByStatus(status) {
            console.log('üîç ÿ™ÿ∑ÿ®ŸäŸÇ ŸÅŸÑÿ™ÿ±:', status);
            currentDebtFilter = status;
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ¥ŸÉŸÑ ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™ ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸÜÿ¥ÿ∑ÿ©
            document.querySelectorAll('#debts .stat-card').forEach(card => {
                card.style.transform = 'scale(1)';
                card.style.boxShadow = '';
            });
            
            // ÿ•ÿ®ÿ±ÿßÿ≤ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©
            const activeCard = event?.currentTarget;
            if (activeCard) {
                activeCard.style.transform = 'scale(1.05)';
                activeCard.style.boxShadow = '0 8px 24px rgba(0,0,0,0.15)';
            }
            
            renderDebtsTable();
            updateDebtsStats();
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿ™Ÿàÿ∂Ÿäÿ≠Ÿäÿ©
            const filterMessages = {
                'all': 'ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑÿØŸäŸàŸÜ',
                'paid': 'ÿπÿ±ÿ∂ ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÖÿ≥ÿØÿØÿ© ŸÅŸÇÿ∑',
                'overdue': 'ÿπÿ±ÿ∂ ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÖÿ™ÿ£ÿÆÿ±ÿ© ŸÅŸÇÿ∑',
                'active': 'ÿπÿ±ÿ∂ ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÜÿ¥ÿ∑ÿ© ŸÅŸÇÿ∑'
            };
            
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }
        
        // ‚úÖ ==== ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ŸäÿµÿßŸÑÿßÿ™ ====
        
        // ŸÖÿ™ÿ∫Ÿäÿ± ŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑÿ•ŸäÿµÿßŸÑÿßÿ™ ÿßŸÑŸÖÿØŸÖÿ¨ÿ©
        let mergedReceiptsBatches = JSON.parse(localStorage.getItem('mergedReceiptsBatches') || '[]');
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ•ŸäÿµÿßŸÑÿßÿ™
        function updateReceiptsStats() {
            const totalReceipts = salesData.length;
            const cashReceipts = salesData.filter(s => s.payment_method === 'ŸÜŸÇÿØŸä' || s.payment_type === 'ŸÜŸÇÿØŸä');
            const installmentReceipts = salesData.filter(s => s.payment_method === 'ÿ£ŸÇÿ≥ÿßÿ∑' || s.payment_type === 'ÿ£ŸÇÿ≥ÿßÿ∑');
            
            const totalCash = cashReceipts.reduce((sum, s) => sum + (s.final_total || s.total || 0), 0);
            const totalInstallment = installmentReceipts.reduce((sum, s) => sum + (s.final_total || s.total || 0), 0);
            const totalAmount = totalCash + totalInstallment;
            
            const totalReceiptsEl = document.getElementById('totalReceipts');
            const totalCashReceiptsEl = document.getElementById('totalCashReceipts');
            const totalInstallmentReceiptsEl = document.getElementById('totalInstallmentReceipts');
            const totalReceiptsAmountEl = document.getElementById('totalReceiptsAmount');
            
            if (totalReceiptsEl) totalReceiptsEl.textContent = toEnglishDigits(totalReceipts);
            if (totalCashReceiptsEl) totalCashReceiptsEl.textContent = toEnglishDigits(formatCurrency(totalCash));
            if (totalInstallmentReceiptsEl) totalInstallmentReceiptsEl.textContent = toEnglishDigits(formatCurrency(totalInstallment));
            if (totalReceiptsAmountEl) totalReceiptsAmountEl.textContent = toEnglishDigits(formatCurrency(totalAmount));
        }
        
        // ÿπÿ±ÿ∂ ÿ¨ÿØŸàŸÑ ÿßŸÑÿ•ŸäÿµÿßŸÑÿßÿ™
        function renderReceiptsTable() {
            const tableBody = document.getElementById('receiptsTableBody');
            if (!tableBody) return;
            
            // ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            const searchInput = document.getElementById('receiptsSearchInput');
            const dateFilterSelect = document.getElementById('receiptsDateFilter');
            const typeFilterSelect = document.getElementById('receiptsTypeFilter');
            const userFilterSelect = document.getElementById('receiptsUserFilter');
            
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const dateFilter = dateFilterSelect ? dateFilterSelect.value : 'all';
            const typeFilter = typeFilterSelect ? typeFilterSelect.value : 'all';
            const userFilter = userFilterSelect ? userFilterSelect.value : 'all';
            
            let filteredReceipts = [...salesData];
            
            // ŸÅŸÑÿ™ÿ± ÿßŸÑÿ®ÿ≠ÿ´
            if (searchTerm) {
                filteredReceipts = filteredReceipts.filter(receipt => {
                    const searchableText = `
                        ${receipt.invoice_id || ''}
                        ${receipt.customer_name || ''}
                        ${receipt.created_by_name || ''}
                    `.toLowerCase();
                    return searchableText.includes(searchTerm);
                });
            }
            
            // ŸÅŸÑÿ™ÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
            if (dateFilter !== 'all') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                filteredReceipts = filteredReceipts.filter(receipt => {
                    const receiptDate = new Date(receipt.timestamp || receipt.created_at || receipt.date);
                    receiptDate.setHours(0, 0, 0, 0);
                    
                    switch(dateFilter) {
                        case 'today':
                            return receiptDate.getTime() === today.getTime();
                        case 'yesterday':
                            const yesterday = new Date(today);
                            yesterday.setDate(yesterday.getDate() - 1);
                            return receiptDate.getTime() === yesterday.getTime();
                        case 'thisWeek':
                            const weekStart = new Date(today);
                            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                            return receiptDate >= weekStart;
                        case 'thisMonth':
                            return receiptDate.getMonth() === today.getMonth() && 
                                   receiptDate.getFullYear() === today.getFullYear();
                        default:
                            return true;
                    }
                });
            }
            
            // ŸÅŸÑÿ™ÿ± ÿßŸÑŸÜŸàÿπ
            if (typeFilter !== 'all') {
                filteredReceipts = filteredReceipts.filter(receipt => 
                    receipt.payment_method === typeFilter || receipt.payment_type === typeFilter
                );
            }
            
            // ŸÅŸÑÿ™ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            if (userFilter !== 'all') {
                filteredReceipts = filteredReceipts.filter(receipt => 
                    receipt.created_by === userFilter
                );
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸÑÿ™ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
            updateUsersFilter();
            
            // ÿ™ÿ±ÿ™Ÿäÿ® ÿπŸÉÿ≥Ÿä (ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã)
            filteredReceipts.sort((a, b) => {
                const dateA = new Date(a.timestamp || a.created_at || a.date);
                const dateB = new Date(b.timestamp || b.created_at || b.date);
                return dateB - dateA;
            });
            
            // ÿ•ŸÜÿ¥ÿßÿ° HTML
            const html = filteredReceipts.map(receipt => {
                const receiptDate = new Date(receipt.timestamp || receipt.created_at || receipt.date);
                const dateStr = toEnglishDigits(receiptDate.toLocaleDateString('en-GB'));
                const timeStr = toEnglishDigits(receiptDate.toLocaleTimeString('ar-IQ', { hour: '2-digit', minute: '2-digit' }));
                const type = receipt.payment_method || receipt.payment_type || 'ŸÜŸÇÿØŸä';
                const typeClass = type === 'ŸÜŸÇÿØŸä' ? 'badge-success' : 'badge-warning';
                const isMerged = receipt.merged_batch_id ? true : false;
                const mergedIcon = isMerged ? '<i class="fas fa-check-circle" style="color: #10b981;"></i>' : '<i class="fas fa-times-circle" style="color: #ef4444;"></i>';
                
                return `
                    <tr>
                        <td><strong>${toEnglishDigits(receipt.invoice_id || 'N/A')}</strong></td>
                        <td>${dateStr}</td>
                        <td>${timeStr}</td>
                        <td>${receipt.customer_name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                        <td><strong>${toEnglishDigits(formatCurrency(receipt.final_total || receipt.total || 0))}</strong></td>
                        <td><span class="badge ${typeClass}">${type}</span></td>
                        <td>${receipt.created_by_name || receipt.created_by || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                        <td style="text-align: center;">${mergedIcon}</td>
                        <td>
                            <button class="action-btn view-btn" onclick="viewReceiptDetails('${receipt.invoice_id}')" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit-btn" onclick="printReceipt('${receipt.invoice_id}')" title="ÿ∑ÿ®ÿßÿπÿ©">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tableBody.innerHTML = html || '<tr><td colspan="9" style="text-align: center;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ŸäÿµÿßŸÑÿßÿ™</td></tr>';
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
            updateReceiptsStats();
        }
        
        // ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸÑÿ™ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
        function updateUsersFilter() {
            const userFilter = document.getElementById('receiptsUserFilter');
            if (!userFilter) return;
            
            const users = new Set();
            salesData.forEach(receipt => {
                const user = receipt.created_by || 'unknown';
                const userName = receipt.created_by_name || user;
                users.add(JSON.stringify({id: user, name: userName}));
            });
            
            const currentValue = userFilter.value;
            userFilter.innerHTML = '<option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</option>';
            
            Array.from(users).forEach(userStr => {
                const user = JSON.parse(userStr);
                const userName = user.name === 'unknown' || user.name === user.id ? 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ' : user.name;
                userFilter.innerHTML += `<option value="${user.id}">${userName}</option>`;
            });
            
            userFilter.value = currentValue;
        }
        
        // ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑÿ•ŸäÿµÿßŸÑÿßÿ™
        function filterReceipts() {
            renderReceiptsTable();
        }
        
        // ÿØŸÖÿ¨ ÿ•ŸäÿµÿßŸÑÿßÿ™ ÿßŸÑŸäŸàŸÖ
        function mergeReceipts() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            // ŸÅŸÑÿ™ÿ±ÿ© ÿ•ŸäÿµÿßŸÑÿßÿ™ ÿßŸÑŸäŸàŸÖ
            const todayReceipts = salesData.filter(receipt => {
                const receiptDate = new Date(receipt.timestamp || receipt.created_at || receipt.date);
                receiptDate.setHours(0, 0, 0, 0);
                return receiptDate.getTime() === today.getTime() && !receipt.merged_batch_id;
            });
            
            if (todayReceipts.length === 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            // ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿØŸÖÿ¨
            if (!confirm(`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿØŸÖÿ¨ ${toEnglishDigits(todayReceipts.length)} ÿ•ŸäÿµÿßŸÑ ŸÑŸÑŸäŸàŸÖ ÿßŸÑÿ≠ÿßŸÑŸäÿü`)) {
                return;
            }
            
            // ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿπÿ±ŸÅ ŸÅÿ±ŸäÿØ ŸÑŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖÿØŸÖÿ¨ÿ©
            const batchId = 'batch_' + Date.now();
            const batchDate = today.toISOString();
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
            let cashTotal = 0;
            let installmentTotal = 0;
            let cashCount = 0;
            let installmentCount = 0;
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ŸäÿµÿßŸÑÿßÿ™ ÿ®ŸÖÿπÿ±ŸÅ ÿßŸÑÿØŸÅÿπÿ©
            todayReceipts.forEach(receipt => {
                receipt.merged_batch_id = batchId;
                receipt.merged_date = batchDate;
                
                const total = receipt.final_total || receipt.total || 0;
                if (receipt.payment_method === 'ŸÜŸÇÿØŸä' || receipt.payment_type === 'ŸÜŸÇÿØŸä') {
                    cashTotal += total;
                    cashCount++;
                } else {
                    installmentTotal += total;
                    installmentCount++;
                }
            });
            
            // ÿ•ŸÜÿ¥ÿßÿ° ŸÉÿßÿ¶ŸÜ ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖÿØŸÖÿ¨ÿ©
            const mergedBatch = {
                batch_id: batchId,
                date: batchDate,
                receipts_count: todayReceipts.length,
                cash_total: cashTotal,
                cash_count: cashCount,
                installment_total: installmentTotal,
                installment_count: installmentCount,
                grand_total: cashTotal + installmentTotal,
                created_at: Date.now(),
                created_by: window.securityManager ? window.securityManager.getCurrentUsername() : 'unknown'
            };
            
            // ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸÅÿπÿ©
            mergedReceiptsBatches.push(mergedBatch);
            localStorage.setItem('mergedReceiptsBatches', JSON.stringify(mergedReceiptsBatches));
            
            // ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ŸÅŸä salesData
            if (typeof saveToLocalStorage === 'function') {
                saveToLocalStorage('salesData', salesData);
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ dataSdk ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿ™ÿßÿ≠ÿßŸã
            if (window.dataSdk) {
                todayReceipts.forEach(async receipt => {
                    try {
                        await window.dataSdk.update(receipt.id || receipt.__backendId, receipt);
                    } catch (error) {
                        console.error('Error updating receipt:', error);
                    }
                });
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
            renderReceiptsTable();
            
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }
        
        // ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿ•ŸäÿµÿßŸÑ
        function viewReceiptDetails(invoiceId) {
            const receipt = salesData.find(s => s.invoice_id === invoiceId);
            if (!receipt) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            const items = receipt.items ? JSON.parse(receipt.items) : [];
            const itemsHtml = items.map(item => `‚Ä¢ ${item.product_name}: ${formatCurrency(item.product_price)} √ó ${item.quantity}`).join('\n');
            
            alert(`üìÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ•ŸäÿµÿßŸÑ\n\n` +
                  `ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©: ${invoiceId}\n` +
                  `ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: ${new Date(receipt.timestamp || receipt.created_at).toLocaleString('en-US')}\n` +
                  `ÿßŸÑÿπŸÖŸäŸÑ: ${receipt.customer_name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}\n` +
                  `ÿßŸÑŸÖÿ®ŸÑÿ∫: ${formatCurrency(receipt.final_total || receipt.total || 0)}\n` +
                  `ÿßŸÑŸÜŸàÿπ: ${receipt.payment_method || receipt.payment_type}\n` +
                  `ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${receipt.created_by_name || receipt.created_by || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}\n\n` +
                  `ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™:\n${itemsHtml || 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™'}`);
        }
        
        // ÿ∑ÿ®ÿßÿπÿ© ÿ•ŸäÿµÿßŸÑ
        function printReceipt(invoiceId) {
            const receipt = salesData.find(s => s.invoice_id === invoiceId);
            if (!receipt) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿØÿßŸÑÿ© ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
            if (typeof printInvoice === 'function') {
                printInvoice(receipt);
            } else {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
        function updateStatistics() {
            // ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
            const totalProducts = products.length;
            const totalValue = products.reduce((sum, p) => sum + (p.stock_quantity * p.product_cost_retail), 0);
            const lowStockItems = products.filter(p => p.stock_quantity <= p.min_stock).length;
            const totalCategories = categories.length;
            
            updateElement('totalProducts', totalProducts);
            updateElement('totalValue', formatCurrency(totalValue));
            updateElement('lowStockItems', lowStockItems);
            updateElement('totalCategories', totalCategories);
            
            // ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
            const totalCost = products.reduce((sum, p) => sum + (p.stock_quantity * p.product_cost_retail), 0);
            const totalProfit = products.reduce((sum, p) => sum + (p.stock_quantity * (p.product_price_retail - p.product_cost_retail)), 0);
            const profitMargin = totalCost > 0 ? ((totalProfit / totalCost) * 100).toFixed(1) : 0;
            
            updateElement('totalCost', formatCurrency(totalCost));
            updateElement('totalProfit', formatCurrency(totalProfit));
            updateElement('profitMargin', profitMargin + '%');
            
            // ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
            const totalInvoices = salesData.length;
            const totalSales = salesData.reduce((sum, s) => sum + s.final_total, 0);
            const today = new Date().toDateString();
            const todaySales = salesData
                .filter(s => new Date(s.timestamp).toDateString() === today)
                .reduce((sum, s) => sum + s.final_total, 0);
            
            updateElement('totalInvoices', totalInvoices);
            updateElement('totalSales', formatCurrency(totalSales));
            updateElement('todaySales', formatCurrency(todaySales));
            
            // ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿØŸäŸàŸÜ - ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä (ÿßŸÑŸÖÿ™ŸÜÿßŸÇÿµ)
            console.log('Calculating debt statistics from:', debtsData);
            const totalDebts = debtsData.reduce((sum, d) => {
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ ŸÖŸÜ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
                let paidAmount = 0;
                if (d.installments && Array.isArray(d.installments) && d.installments.length > 0) {
                    d.installments.forEach(inst => {
                        if (inst.status === 'paid') {
                            paidAmount += parseFloat(inst.paid_amount || inst.amount || 0);
                        }
                    });
                } else if (d.paid_amount !== undefined && d.paid_amount !== null) {
                    paidAmount = parseFloat(d.paid_amount) || 0;
                }
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä
                const totalAmount = d.total_amount || d.final_total || 0;
                const remainingAmount = totalAmount - paidAmount;
                
                console.log('Debt:', d.customer_name, 'Total:', totalAmount, 'Paid:', paidAmount, 'Remaining:', remainingAmount);
                return sum + (remainingAmount > 0 ? remainingAmount : 0);
            }, 0);
            console.log('Total remaining debts calculated:', totalDebts);
            const debtCustomers = [...new Set(debtsData.map(d => d.customer_phone))].length;
            const overdueDebts = debtsData.filter(d => {
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿ£ÿÆŸäÿ±
                let paidAmount = 0;
                if (d.installments && Array.isArray(d.installments)) {
                    d.installments.forEach(inst => {
                        if (inst.status === 'paid') {
                            paidAmount += parseFloat(inst.paid_amount || inst.amount || 0);
                        }
                    });
                }
                const totalAmount = d.total_amount || d.final_total || 0;
                const remaining = totalAmount - paidAmount;
                return new Date(d.due_date) < new Date() && remaining > 0;
            }).length;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÖÿ≥ÿØÿØÿ© ÿ®ÿßŸÑŸÉÿßŸÖŸÑ (ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ŸÖÿ≥ÿØÿØÿ©)
            const paidDebts = debtsData.filter(d => {
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
                if (d.installments && Array.isArray(d.installments) && d.installments.length > 0) {
                    // ŸÖÿ≥ÿØÿØ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ = ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ŸÖÿØŸÅŸàÿπÿ©
                    return d.installments.every(inst => inst.status === 'paid');
                } else {
                    // ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØ ÿ£ŸÇÿ≥ÿßÿ∑ÿå ŸÜÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä
                    const remaining = d.remaining_amount !== undefined ? d.remaining_amount : (d.total_amount || d.final_total || 0);
                    return remaining <= 0;
                }
            }).length;
            
            console.log('Debts statistics - Total:', totalDebts, 'Customers:', debtCustomers, 'Overdue:', overdueDebts, 'Paid:', paidDebts);
            
            updateElement('totalDebts', formatCurrency(totalDebts));
            updateElement('debtCustomers', debtCustomers);
            updateElement('overdueDebts', overdueDebts);
            updateElement('paidDebts', paidDebts);
        }

        // ÿ•ÿ∏Ÿáÿßÿ± ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
        function showInstallmentForm() {
            document.getElementById('installmentForm').style.display = 'block';
            calculateInstallment();
        }
        
        // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿπŸÖŸÑÿßÿ° ÿßŸÑŸÖÿØŸäŸÜŸäŸÜ
        function searchDebtCustomers(query) {
            console.log('üîç ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿπŸÖŸÑÿßÿ°:', query);
            
            const resultsContainer = document.getElementById('customerSearchResults');
            if (!resultsContainer) return;
            
            // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ®ÿ≠ÿ´ ŸÅÿßÿ±ÿ∫ÿßŸã
            if (!query || query.trim().length < 2) {
                resultsContainer.classList.remove('active');
                resultsContainer.innerHTML = '';
                return;
            }
            
            const searchTerm = query.trim().toLowerCase();
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿØŸäŸàŸÜ ÿπŸÜ ÿßŸÑÿπŸÖŸÑÿßÿ°
            const matchingCustomers = debtsData.filter(debt => {
                const name = (debt.customer_name || '').toLowerCase();
                const phone = (debt.customer_phone || '').toLowerCase();
                
                return name.includes(searchTerm) || phone.includes(searchTerm);
            });
            
            // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ŸÉÿ±ÿßÿ±ÿßÿ™ (ŸÜŸÅÿ≥ ÿßŸÑÿπŸÖŸäŸÑ ŸÇÿØ ŸäŸÉŸàŸÜ ŸÑŸá ÿπÿØÿ© ÿØŸäŸàŸÜ)
            const uniqueCustomers = [];
            const seenPhones = new Set();
            
            matchingCustomers.forEach(debt => {
                const phone = debt.customer_phone || debt.customer_name;
                if (!seenPhones.has(phone)) {
                    seenPhones.add(phone);
                    
                    // ÿ≠ÿ≥ÿßÿ® ÿ•ÿ¨ŸÖÿßŸÑŸä ÿØŸäŸàŸÜ Ÿáÿ∞ÿß ÿßŸÑÿπŸÖŸäŸÑ
                    const customerDebts = debtsData.filter(d => 
                        d.customer_phone === debt.customer_phone || 
                        (d.customer_name === debt.customer_name && !d.customer_phone)
                    );
                    
                    const totalRemaining = customerDebts.reduce((sum, d) => {
                        const totalAmount = parseFloat(d.total_amount || d.final_total || 0);
                        const paidAmount = parseFloat(d.paid_amount || 0);
                        const remaining = totalAmount - paidAmount;
                        return sum + (remaining > 0 ? remaining : 0);
                    }, 0);
                    
                    uniqueCustomers.push({
                        name: debt.customer_name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ',
                        phone: debt.customer_phone || '',
                        address: debt.customer_address || '',
                        totalRemaining: totalRemaining,
                        debtsCount: customerDebts.length
                    });
                }
            });
            
            console.log('üìä ÿπÿØÿØ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨:', uniqueCustomers.length);
            
            // ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨
            if (uniqueCustomers.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="customer-search-empty">
                        <i class="fas fa-search"></i>
                        <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÖÿ∑ÿßÿ®ŸÇÿ©</p>
                    </div>
                `;
                resultsContainer.classList.add('active');
            } else {
                resultsContainer.innerHTML = uniqueCustomers.map(customer => `
                    <div class="customer-search-item" onclick="selectExistingCustomer('${escapeHtml(customer.name)}', '${escapeHtml(customer.phone)}', '${escapeHtml(customer.address)}')">
                        <div class="customer-search-name">
                            <i class="fas fa-user"></i>
                            ${customer.name}
                        </div>
                        <div class="customer-search-info">
                            <span>
                                <i class="fas fa-phone"></i>
                                ${customer.phone || 'ŸÑÿß ŸäŸàÿ¨ÿØ'}
                            </span>
                            ${customer.address ? `
                            <span>
                                <i class="fas fa-map-marker-alt"></i>
                                ${customer.address}
                            </span>
                            ` : ''}
                        </div>
                        <div class="customer-search-debt">
                            <i class="fas fa-exclamation-circle"></i>
                            ÿßŸÑŸÖÿ™ÿ®ŸÇŸä: ${formatCurrency(customer.totalRemaining)}
                            (${customer.debtsCount} ${customer.debtsCount === 1 ? 'ÿØŸäŸÜ' : 'ÿØŸäŸàŸÜ'})
                        </div>
                    </div>
                `).join('');
                resultsContainer.classList.add('active');
            }
        }
        
        // ÿßÿÆÿ™Ÿäÿßÿ± ÿπŸÖŸäŸÑ ŸÖŸàÿ¨ŸàÿØ
        function selectExistingCustomer(name, phone, address) {
            console.log('‚úÖ ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿπŸÖŸäŸÑ:', { name, phone, address });
            
            // ŸÖŸÑÿ° ÿßŸÑÿ≠ŸÇŸàŸÑ
            const customerNameInput = document.getElementById('customerName');
            const customerPhoneInput = document.getElementById('customerPhone');
            const customerAddressInput = document.getElementById('customerAddress');
            const searchInput = document.getElementById('searchExistingCustomer');
            
            if (customerNameInput) customerNameInput.value = name;
            if (customerPhoneInput) customerPhoneInput.value = phone;
            if (customerAddressInput) customerAddressInput.value = address;
            if (searchInput) searchInput.value = '';
            
            // ÿ•ÿÆŸÅÿßÿ° ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´
            const resultsContainer = document.getElementById('customerSearchResults');
            if (resultsContainer) {
                resultsContainer.classList.remove('active');
                resultsContainer.innerHTML = '';
            }
            
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }
        
        // ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑÿ™ÿ¨ŸÜÿ® XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
        function calculateInstallment() {
            const subtotal = cart.reduce((sum, item) => sum + (item.product_price * item.quantity), 0);
            const discountPercent = parseFloat(document.getElementById('discountInput')?.value) || 0;
            const discountAmount = subtotal * (discountPercent / 100);
            const afterDiscount = subtotal - discountAmount;
            const taxRate = parseFloat(getCurrentTaxRate()) / 100;
            const taxAmount = afterDiscount * taxRate;
            const originalAmount = afterDiscount + taxAmount;
            
            const months = parseInt(document.getElementById('installmentMonths')?.value) || 12;
            const additionalAmount = parseFloat(document.getElementById('additionalAmount')?.value) || 0;
            const downPayment = parseFloat(document.getElementById('downPayment')?.value) || 0;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ŸÇÿ®ŸÑ ÿÆÿµŸÖ ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©
            const totalBeforeDown = originalAmount + additionalAmount;
            
            // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ÿ®ÿπÿØ ÿÆÿµŸÖ ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©
            const remainingAmount = totalBeforeDown - downPayment;
            
            // ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä = ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä / ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ±
            const monthlyPayment = remainingAmount > 0 ? remainingAmount / months : 0;
            
            updateElement('originalAmount', formatCurrency(originalAmount));
            updateElement('addedProfit', formatCurrency(additionalAmount));
            updateElement('totalInstallmentAmount', formatCurrency(totalBeforeDown));
            updateElement('monthlyPayment', formatCurrency(monthlyPayment));
            
            // ÿπÿ±ÿ∂/ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©
            const downPaymentRow = document.getElementById('downPaymentRow');
            if (downPayment > 0) {
                downPaymentRow.style.display = 'flex';
                updateElement('downPaymentDisplay', formatCurrency(downPayment));
            } else {
                downPaymentRow.style.display = 'none';
            }
        }

        // ÿ™ÿ®ÿØŸäŸÑ Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ
        function toggleAdvancedEditMode() {
            const checkbox = document.getElementById('advancedEditMode');
            const advancedFields = document.getElementById('advancedEditFields');
            
            if (checkbox.checked) {
                console.log('‚úÖ ÿ™ŸÅÿπŸäŸÑ Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ ŸÅŸä ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑');
                advancedFields.style.display = 'block';
                
                // ÿ™ÿπÿ®ÿ¶ÿ© ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÅŸä ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ©
                const subtotal = cart.reduce((sum, item) => sum + (item.product_price * item.quantity), 0);
                const discountPercent = parseFloat(document.getElementById('discountInput')?.value) || 0;
                const discountAmount = subtotal * (discountPercent / 100);
                const afterDiscount = subtotal - discountAmount;
                const taxRate = parseFloat(getCurrentTaxRate()) / 100;
                const taxAmount = afterDiscount * taxRate;
                const originalAmount = afterDiscount + taxAmount;
                
                const additionalAmount = parseFloat(document.getElementById('additionalAmount')?.value) || 0;
                const downPayment = parseFloat(document.getElementById('downPayment')?.value) || 0;
                const totalBeforeDown = originalAmount + additionalAmount;
                const remainingAmount = totalBeforeDown - downPayment;
                const months = parseInt(document.getElementById('installmentMonths')?.value) || 12;
                const monthlyPayment = remainingAmount > 0 ? remainingAmount / months : 0;
                
                // ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÇŸäŸÖ ŸÅŸä ÿßŸÑÿ≠ŸÇŸàŸÑ (ŸÉŸÇŸäŸÖ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© - placeholder)
                document.getElementById('customOriginalAmount').placeholder = formatNumber(originalAmount);
                document.getElementById('customTotalAmount').placeholder = formatNumber(totalBeforeDown);
                document.getElementById('customMonthlyAmount').placeholder = formatNumber(monthlyPayment);
                
                // ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿ£ÿµŸÑŸäÿ©
                window.installmentOriginalValues = {
                    originalAmount,
                    totalAmount: totalBeforeDown,
                    monthlyAmount: monthlyPayment,
                    months
                };
            } else {
                console.log('‚ùå ÿ•ŸÑÿ∫ÿßÿ° Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ');
                advancedFields.style.display = 'none';
                
                // ŸÖÿ≥ÿ≠ ŸÇŸäŸÖ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ©
                document.getElementById('customOriginalAmount').value = '';
                document.getElementById('customTotalAmount').value = '';
                document.getElementById('customMonthlyAmount').value = '';
                
                // ÿ•ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
                calculateInstallment();
            }
        }
        
        // ÿ•ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ® ŸÖŸÜ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä
        function recalculateFromOriginal() {
            const customOriginal = parseFloat(document.getElementById('customOriginalAmount').value);
            if (!customOriginal || customOriginal <= 0) {
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÅÿßÿ±ÿ∫ÿßŸãÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿπÿßÿØŸä
                calculateInstallment();
                return;
            }
            
            console.log('üîÑ ÿ•ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ® ŸÖŸÜ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä:', customOriginal);
            
            const additionalAmount = parseFloat(document.getElementById('additionalAmount')?.value) || 0;
            const downPayment = parseFloat(document.getElementById('downPayment')?.value) || 0;
            const months = parseInt(document.getElementById('installmentMonths')?.value) || 12;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
            const totalAmount = customOriginal + additionalAmount;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä
            const remainingAmount = totalAmount - downPayment;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä
            const monthlyAmount = remainingAmount > 0 ? remainingAmount / months : 0;
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂
            updateElement('originalAmount', formatCurrency(customOriginal));
            updateElement('addedProfit', formatCurrency(additionalAmount));
            updateElement('totalInstallmentAmount', formatCurrency(totalAmount));
            updateElement('monthlyPayment', formatCurrency(monthlyAmount));
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ£ÿÆÿ±Ÿâ
            document.getElementById('customTotalAmount').value = '';
            document.getElementById('customTotalAmount').placeholder = formatNumber(totalAmount);
            document.getElementById('customMonthlyAmount').value = '';
            document.getElementById('customMonthlyAmount').placeholder = formatNumber(monthlyAmount);
            
            // ÿπÿ±ÿ∂/ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©
            const downPaymentRow = document.getElementById('downPaymentRow');
            if (downPayment > 0) {
                downPaymentRow.style.display = 'flex';
                updateElement('downPaymentDisplay', formatCurrency(downPayment));
            } else {
                downPaymentRow.style.display = 'none';
            }
            
            // ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÇŸäŸÖ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿπŸÜÿØ ÿßŸÑÿ≠ŸÅÿ∏
            window.customInstallmentValues = {
                originalAmount: customOriginal,
                totalAmount,
                monthlyAmount,
                remainingAmount
            };
        }
        
        // ÿ•ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ® ŸÖŸÜ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
        function recalculateFromTotal() {
            const customTotal = parseFloat(document.getElementById('customTotalAmount').value);
            if (!customTotal || customTotal <= 0) {
                calculateInstallment();
                return;
            }
            
            console.log('üîÑ ÿ•ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ® ŸÖŸÜ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:', customTotal);
            
            const downPayment = parseFloat(document.getElementById('downPayment')?.value) || 0;
            const months = parseInt(document.getElementById('installmentMonths')?.value) || 12;
            const additionalAmount = parseFloat(document.getElementById('additionalAmount')?.value) || 0;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä (ÿπŸÉÿ≥Ÿä)
            const originalAmount = customTotal - additionalAmount;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä
            const remainingAmount = customTotal - downPayment;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä
            const monthlyAmount = remainingAmount > 0 ? remainingAmount / months : 0;
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂
            updateElement('originalAmount', formatCurrency(originalAmount));
            updateElement('addedProfit', formatCurrency(additionalAmount));
            updateElement('totalInstallmentAmount', formatCurrency(customTotal));
            updateElement('monthlyPayment', formatCurrency(monthlyAmount));
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ£ÿÆÿ±Ÿâ
            document.getElementById('customOriginalAmount').value = '';
            document.getElementById('customOriginalAmount').placeholder = formatNumber(originalAmount);
            document.getElementById('customMonthlyAmount').value = '';
            document.getElementById('customMonthlyAmount').placeholder = formatNumber(monthlyAmount);
            
            // ÿπÿ±ÿ∂/ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©
            const downPaymentRow = document.getElementById('downPaymentRow');
            if (downPayment > 0) {
                downPaymentRow.style.display = 'flex';
                updateElement('downPaymentDisplay', formatCurrency(downPayment));
            } else {
                downPaymentRow.style.display = 'none';
            }
            
            // ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÇŸäŸÖ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿπŸÜÿØ ÿßŸÑÿ≠ŸÅÿ∏
            window.customInstallmentValues = {
                originalAmount,
                totalAmount: customTotal,
                monthlyAmount,
                remainingAmount
            };
        }
        
        // ÿ•ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ® ŸÖŸÜ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä
        function recalculateFromMonthly() {
            const customMonthly = parseFloat(document.getElementById('customMonthlyAmount').value);
            if (!customMonthly || customMonthly <= 0) {
                calculateInstallment();
                return;
            }
            
            console.log('üîÑ ÿ•ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ® ŸÖŸÜ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä:', customMonthly);
            
            const downPayment = parseFloat(document.getElementById('downPayment')?.value) || 0;
            const additionalAmount = parseFloat(document.getElementById('additionalAmount')?.value) || 0;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä ŸÖŸÜ ÿßŸÑÿ≥ŸÑÿ©
            const cartTotal = cart.reduce((sum, item) => sum + (item.product_price * item.quantity), 0);
            const originalAmount = cartTotal;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
            const totalAmount = originalAmount + additionalAmount;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ÿ®ÿπÿØ ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©
            const remainingAmount = totalAmount - downPayment;
            
            // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä
            const calculatedMonths = Math.ceil(remainingAmount / customMonthly);
            
            console.log('üìä ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™:');
            console.log('  ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä:', originalAmount);
            console.log('  ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ∂ÿßŸÅŸä:', additionalAmount);
            console.log('  ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:', totalAmount);
            console.log('  ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©:', downPayment);
            console.log('  ÿßŸÑŸÖÿ™ÿ®ŸÇŸä:', remainingAmount);
            console.log('  ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä:', customMonthly);
            console.log('  ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑŸÖÿ≠ÿ≥Ÿàÿ®:', calculatedMonths);
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ŸÇŸÑ ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ±
            document.getElementById('installmentMonths').value = calculatedMonths;
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂
            updateElement('originalAmount', formatCurrency(originalAmount));
            updateElement('addedProfit', formatCurrency(additionalAmount));
            updateElement('totalInstallmentAmount', formatCurrency(totalAmount));
            updateElement('monthlyPayment', formatCurrency(customMonthly));
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ£ÿÆÿ±Ÿâ
            document.getElementById('customOriginalAmount').value = '';
            document.getElementById('customOriginalAmount').placeholder = formatNumber(originalAmount);
            document.getElementById('customTotalAmount').value = '';
            document.getElementById('customTotalAmount').placeholder = formatNumber(totalAmount);
            
            // ÿπÿ±ÿ∂/ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©
            const downPaymentRow = document.getElementById('downPaymentRow');
            if (downPayment > 0) {
                downPaymentRow.style.display = 'flex';
                updateElement('downPaymentDisplay', formatCurrency(downPayment));
            } else {
                downPaymentRow.style.display = 'none';
            }
            
            // ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÇŸäŸÖ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿπŸÜÿØ ÿßŸÑÿ≠ŸÅÿ∏
            window.customInstallmentValues = {
                originalAmount,
                totalAmount,
                monthlyAmount: customMonthly,
                remainingAmount,
                installmentMonths: calculatedMonths
            };
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿ™Ÿàÿ∂Ÿäÿ≠Ÿäÿ©
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }
        
        // ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿ®ÿØŸàŸÜ ÿπŸÖŸÑÿ©
        function formatNumber(num) {
            if (isNaN(num) || num === null || num === undefined) return '0';
            return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÜŸÇÿØŸä
        async function processCashPayment(customFinalAmount = null) {
            console.log('üõí ÿ®ÿØÿ° ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÜŸÇÿØŸä...');
            console.log('ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑÿ≥ŸÑÿ©:', cart.length);
            console.log('ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿÆÿµÿµ:', customFinalAmount);
            
            if (cart.length === 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿÆÿµÿµ ŸÖÿ§ŸÇÿ™ÿßŸã ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
            if (customFinalAmount !== null && customFinalAmount > 0) {
                window.customCashAmount = customFinalAmount;
            }
            
            const success = await processPayment('ŸÜŸÇÿØŸä', 'ŸÜŸÇÿØŸä');
            
            if (success) {
                console.log('‚úÖ ÿ™ŸÖ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÜŸÇÿØŸä ÿ®ŸÜÿ¨ÿßÿ≠');
                // ÿ∑ÿ®ÿßÿπÿ© ÿµÿßŸÖÿ™ÿ© ÿ®ÿπÿØ ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÜŸÇÿØŸä ŸÅŸÇÿ∑
                if (window.lastSaleInvoiceId) {
                    printInvoice(window.lastSaleInvoiceId, true);
                }
                closeModal('paymentModal');
                resetInstallmentForm();
                
                // ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿÆÿµÿµ
                window.customCashAmount = null;
            } else {
                console.log('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÜŸÇÿØŸä');
            }
        }

        // ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÜŸÇÿØŸä
        function showCashPaymentModal() {
            console.log('ü™ü ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÜŸÇÿØŸä ÿßŸÑÿ≠ÿØŸäÿ´ÿ©');
            
            if (cart.length === 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
            const subtotal = cart.reduce((sum, item) => sum + (item.product_price * item.quantity), 0);
            const discountPercent = parseFloat(document.getElementById('discountInput')?.value) || 0;
            const discountAmount = subtotal * (discountPercent / 100);
            const afterDiscount = subtotal - discountAmount;
            const taxRate = parseFloat(getCurrentTaxRate()) / 100;
            const taxAmount = afterDiscount * taxRate;
            const finalTotal = afterDiscount + taxAmount;
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            document.getElementById('cashModalItemCount').textContent = cart.length;
            document.getElementById('cashModalOriginalTotal').textContent = formatCurrency(finalTotal);
            document.getElementById('cashModalFinalAmount').textContent = formatCurrency(finalTotal);
            document.getElementById('cashModalFinalPrice').value = '';
            
            // ÿ•ÿÆŸÅÿßÿ° ÿπÿ±ÿ∂ ÿßŸÑŸÅÿ±ŸÇ
            document.getElementById('cashPriceDifferenceDisplay').style.display = 'none';
            
            // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä
            window.cashModalOriginalAmount = finalTotal;
            
            // ÿπÿ±ÿ∂ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            showModal('cashPaymentModal');
        }
        
        // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÜŸÇÿØŸä
        function updateCashPaymentPreview() {
            const finalPriceInput = document.getElementById('cashModalFinalPrice');
            const finalPriceValue = parseFloat(finalPriceInput.value) || 0;
            const originalAmount = window.cashModalOriginalAmount || 0;
            
            const differenceDisplay = document.getElementById('cashPriceDifferenceDisplay');
            const differenceLabel = document.getElementById('cashDifferenceLabel');
            const differenceAmount = document.getElementById('cashDifferenceAmount');
            const finalAmountDisplay = document.getElementById('cashModalFinalAmount');
            
            if (finalPriceValue > 0) {
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÅÿ±ŸÇ
                const difference = finalPriceValue - originalAmount;
                
                // ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜŸáÿßÿ¶Ÿä
                finalAmountDisplay.textContent = formatCurrency(finalPriceValue);
                
                // ÿπÿ±ÿ∂ ÿßŸÑŸÅÿ±ŸÇ
                differenceDisplay.style.display = 'block';
                
                if (difference > 0) {
                    // ÿ≤ŸäÿßÿØÿ©
                    differenceDisplay.style.background = 'rgba(244, 67, 54, 0.1)';
                    differenceDisplay.style.border = '2px solid rgba(244, 67, 54, 0.3)';
                    differenceLabel.innerHTML = '<i class="fas fa-arrow-up"></i> ÿ≤ŸäÿßÿØÿ©:';
                    differenceLabel.style.color = 'var(--danger-color)';
                    differenceAmount.textContent = formatCurrency(difference);
                    differenceAmount.style.color = 'var(--danger-color)';
                } else if (difference < 0) {
                    // ÿÆÿµŸÖ
                    differenceDisplay.style.background = 'rgba(76, 175, 80, 0.1)';
                    differenceDisplay.style.border = '2px solid rgba(76, 175, 80, 0.3)';
                    differenceLabel.innerHTML = '<i class="fas fa-arrow-down"></i> ÿÆÿµŸÖ:';
                    differenceLabel.style.color = 'var(--success-color)';
                    differenceAmount.textContent = formatCurrency(Math.abs(difference));
                    differenceAmount.style.color = 'var(--success-color)';
                } else {
                    // ŸÑÿß ŸäŸàÿ¨ÿØ ŸÅÿ±ŸÇ
                    differenceDisplay.style.display = 'none';
                }
            } else {
                // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä
                finalAmountDisplay.textContent = formatCurrency(originalAmount);
                differenceDisplay.style.display = 'none';
            }
        }
        
        // ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÜŸÇÿØŸä
        function closeCashPaymentModal() {
            closeModal('cashPaymentModal');
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÇŸäŸÖ
            document.getElementById('cashModalFinalPrice').value = '';
            document.getElementById('cashPriceDifferenceDisplay').style.display = 'none';
        }
        
        // ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÜŸÇÿØŸä
        async function confirmCashPayment() {
            const finalPriceInput = document.getElementById('cashModalFinalPrice');
            const finalPriceValue = parseFloat(finalPriceInput.value) || 0;
            const originalAmount = window.cashModalOriginalAmount || 0;
            
            console.log('‚úÖ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÜŸÇÿØŸä');
            console.log('ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä:', originalAmount);
            console.log('ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿÆÿµÿµ:', finalPriceValue);
            
            // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            closeCashPaymentModal();
            
            // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿØŸÅÿπ ŸÖÿπ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿÆÿµÿµ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
            if (finalPriceValue > 0) {
                await processCashPayment(finalPriceValue);
            } else {
                await processCashPayment(null);
            }
        }


        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿØŸÅÿπ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
        async function processInstallmentPayment() {
            console.log('üõí ÿ®ÿØÿ° ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿØŸÅÿπ ÿ®ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑...');
            console.log('ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑÿ≥ŸÑÿ©:', cart.length);
            
            if (cart.length === 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            
            if (!customerName || !customerPhone) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            const customerAddress = document.getElementById('customerAddress')?.value.trim() || '';
            let newInstallmentMonths = parseInt(document.getElementById('installmentMonths')?.value) || 12;
            const additionalAmount = parseFloat(document.getElementById('additionalAmount')?.value) || 0;
            const downPayment = parseFloat(document.getElementById('downPayment')?.value) || 0;
            const installmentStartDate = document.getElementById('installmentStartDate')?.value || null;
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÇŸäŸÖ ŸÖÿÆÿµÿµÿ© ŸÖŸÜ Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ
            let newTotalAmount, newRemainingAmount, newMonthlyAmount, finalTotal;
            
            if (window.customInstallmentValues && 
                window.customInstallmentValues.totalAmount > 0 && 
                window.customInstallmentValues.monthlyAmount > 0) {
                console.log('‚úÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÇŸäŸÖ ÿßŸÑŸÖÿÆÿµÿµÿ© ŸÖŸÜ Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ');
                console.log('ÿßŸÑŸÇŸäŸÖ ÿßŸÑŸÖÿÆÿµÿµÿ©:', window.customInstallmentValues);
                
                finalTotal = window.customInstallmentValues.originalAmount || 0;
                newTotalAmount = window.customInstallmentValues.totalAmount;
                newRemainingAmount = window.customInstallmentValues.remainingAmount;
                newMonthlyAmount = window.customInstallmentValues.monthlyAmount;
                
                // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑŸÖÿ≠ÿ≥Ÿàÿ® ŸÖŸÜ ÿßŸÑŸÇŸäŸÖ ÿßŸÑŸÖÿÆÿµÿµÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
                if (window.customInstallmentValues.installmentMonths) {
                    newInstallmentMonths = window.customInstallmentValues.installmentMonths;
                    console.log('üìÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑŸÖÿ≠ÿ≥Ÿàÿ®:', newInstallmentMonths);
                }
                
                // ŸÖÿ≥ÿ≠ ÿßŸÑŸÇŸäŸÖ ÿßŸÑŸÖÿÆÿµÿµÿ© ÿ®ÿπÿØ ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ
                window.customInstallmentValues = null;
            } else {
                console.log('üìä ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÇŸäŸÖ ŸÖŸÜ ÿßŸÑÿ≥ŸÑÿ© (ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿπÿßÿØŸä)');
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ŸàÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÖŸÜ ÿßŸÑÿ≥ŸÑÿ©
                const subtotal = cart.reduce((sum, item) => sum + (item.product_price * item.quantity), 0);
                const discountPercent = parseFloat(document.getElementById('discountInput')?.value) || 0;
                const discountAmount = subtotal * (discountPercent / 100);
                const afterDiscount = subtotal - discountAmount;
                const taxRate = parseFloat(getCurrentTaxRate()) / 100;
                const taxAmount = afterDiscount * taxRate;
                finalTotal = afterDiscount + taxAmount;

                // ŸÑÿß ŸÜŸàÿ≤ÿπ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ∂ÿßŸÅŸä ÿπŸÑŸâ ÿ£ÿ≥ÿπÿßÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
                // ŸÜÿ≠ÿ™ŸÅÿ∏ ÿ®ÿßŸÑÿ£ÿ≥ÿπÿßÿ± ÿßŸÑÿ£ÿµŸÑŸäÿ© ŸÉŸÖÿß ŸáŸä

                // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä = ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä + ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ∂ÿßŸÅŸä
                newTotalAmount = finalTotal + additionalAmount;
                // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ÿ®ÿπÿØ ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©
                newRemainingAmount = newTotalAmount - downPayment;
                // ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä = ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä / ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ±
                newMonthlyAmount = newRemainingAmount / newInstallmentMonths;
            }
            
            console.log('ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ:', { customerName, customerPhone, customerAddress });
            console.log('ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑÿ¨ÿØŸäÿØÿ©:', { 
                finalTotal,
                additionalAmount,
                downPayment,
                newTotalAmount, 
                newRemainingAmount,
                newMonthlyAmount, 
                newInstallmentMonths
            });
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            if (isNaN(newTotalAmount) || newTotalAmount <= 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            if (isNaN(newMonthlyAmount) || newMonthlyAmount <= 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿØŸäŸÜ ŸÖŸàÿ¨ŸàÿØ ŸÑŸáÿ∞ÿß ÿßŸÑÿπŸÖŸäŸÑ
            const existingDebt = debtsData.find(debt => 
                debt.customer_phone === customerPhone && 
                debt.status === 'ŸÜÿ¥ÿ∑'
            );
            
            if (existingDebt) {
                console.log('üìã ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿØŸäŸÜ ŸÖŸàÿ¨ŸàÿØ ŸÑŸÑÿπŸÖŸäŸÑ - ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿØŸÖÿ¨');
                console.log('ÿßŸÑÿØŸäŸÜ ÿßŸÑÿ≠ÿßŸÑŸä:', existingDebt);
                // ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿØŸÖÿ¨
                const confirmMerge = confirm(
                    `ŸÑÿØŸâ ÿßŸÑÿπŸÖŸäŸÑ "${customerName}" ÿØŸäŸÜ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ.\n\n` +
                    `ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ÿßŸÑÿ≠ÿßŸÑŸä: ${formatCurrency(existingDebt.remaining_amount || 0)}\n` +
                    `ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©: ${getUnpaidInstallmentsCount(existingDebt)} ÿ¥Ÿáÿ±\n\n` +
                    `ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿØŸäŸÜ ÿßŸÑÿ¨ÿØŸäÿØ ÿ•ŸÑŸâ ÿ≠ÿ≥ÿßÿ®Ÿá ÿßŸÑÿ≠ÿßŸÑŸäÿü\n` +
                    `(ÿ≥Ÿäÿ™ŸÖ ÿØŸÖÿ¨ ÿßŸÑÿØŸäŸàŸÜ ŸÅŸä ÿ≥ÿ¨ŸÑ Ÿàÿßÿ≠ÿØ)`
                );
                if (!confirmMerge) {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    return;
                }
                // ÿØŸÖÿ¨ ÿßŸÑÿØŸäŸÜ ÿßŸÑÿ¨ÿØŸäÿØ ŸÖÿπ ÿßŸÑÿØŸäŸÜ ÿßŸÑŸÖŸàÿ¨ŸàÿØ
                const success = await mergeDebtToExisting(
                    existingDebt,
                    {
                        newTotalAmount,
                        newRemainingAmount,
                        newMonthlyAmount,
                        newInstallmentMonths,
                        additionalAmount,
                        downPayment,
                        customerAddress,
                        cart: [...cart],
                        finalTotal: newTotalAmount - downPayment, // üî• ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ÿßŸÑÿµÿ≠Ÿäÿ≠ (ÿ®ÿπÿØ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸàÿßŸÑÿÆÿµŸÖ)
                        originalSubtotal: finalTotal, // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä ŸÑŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
                        start_date: installmentStartDate
                    }
                );
                // ŸÖŸÑÿßÿ≠ÿ∏ÿ©: window.lastSaleInvoiceId ÿ™ŸÖ ÿ™ÿπŸäŸäŸÜŸá ÿØÿßÿÆŸÑ mergeDebtToExisting ÿ®ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©
                // ŸÑÿß ŸÜÿ≥ÿ™ÿ®ÿØŸÑŸá ŸáŸÜÿß ÿ®ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑŸÇÿØŸäŸÖÿ©
                if (success) {
                    // ‚úÖ ŸÅŸÇÿ∑ ÿ∑ÿ®ÿßÿπÿ© ŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ™ŸÇÿ≥Ÿäÿ∑ ÿ®ÿπÿØ ÿßŸÑÿ®Ÿäÿπ (ÿ®ÿØŸàŸÜ ÿ•ŸäÿµÿßŸÑ ÿ™ÿ≥ÿØŸäÿØ)
                    if (window.lastSaleInvoiceId) {
                        printInstallmentInvoice(window.lastSaleInvoiceId, true, {
                            customer_name: customerName,
                            customer_phone: customerPhone,
                            customer_address: customerAddress,
                            installment_months: newInstallmentMonths,
                            monthly_amount: newMonthlyAmount,
                            down_payment: downPayment,
                            additional_amount: additionalAmount,
                            remaining_amount: newRemainingAmount,
                            // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸàÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑÿ¨ÿØŸäÿØÿ©
                            new_items: [...cart],
                            new_subtotal: cart.reduce((sum, item) => sum + (item.product_price * item.quantity), 0),
                            new_final_total: newTotalAmount - downPayment // üî• ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ÿßŸÑÿµÿ≠Ÿäÿ≠ (ÿ®ÿπÿØ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸàÿßŸÑÿÆÿµŸÖ)
                        });
                    }
                    closeModal('paymentModal');
                    resetInstallmentForm();
                } else {
                    console.log('‚ùå ŸÅÿ¥ŸÑ ÿØŸÖÿ¨ ÿßŸÑÿØŸäŸÜ');
                }
            } else {
                console.log('üìù ÿ•ŸÜÿ¥ÿßÿ° ÿØŸäŸÜ ÿ¨ÿØŸäÿØ ŸÑŸÑÿπŸÖŸäŸÑ');
                // ÿ•ŸÜÿ¥ÿßÿ° ÿØŸäŸÜ ÿ¨ÿØŸäÿØ
                const success = await processPayment('ÿ£ŸÇÿ≥ÿßÿ∑', 'ÿ£ŸÇÿ≥ÿßÿ∑', {
                    customer_name: customerName,
                    customer_phone: customerPhone,
                    customer_address: customerAddress,
                    installment_months: newInstallmentMonths,
                    additional_amount: additionalAmount,
                    down_payment: downPayment,
                    monthly_amount: newMonthlyAmount,
                    total_amount: newTotalAmount,
                    remaining_amount: newRemainingAmount,
                    start_date: installmentStartDate,
                    advanced_control_used: window.customInstallmentValues ? true : false,
                    debt_date: new Date().toISOString()
                });
                // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ£ÿÆŸäÿ±ÿ© ÿ®ÿπÿØ ŸÉŸÑ ÿπŸÖŸÑŸäÿ© ÿ®Ÿäÿπ ÿ£ŸÇÿ≥ÿßÿ∑
                if (Array.isArray(salesData) && salesData.length > 0) {
                    // ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ¢ÿÆÿ± ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ£ŸÇÿ≥ÿßÿ∑ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ§Ÿáÿß ŸÑŸáÿ∞ÿß ÿßŸÑÿπŸÖŸäŸÑ
                    const lastInstallmentSale = salesData.filter(s => s.customer_phone === customerPhone && s.payment_type === 'ÿ£ŸÇÿ≥ÿßÿ∑').sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                    if (lastInstallmentSale && lastInstallmentSale.invoice_id) {
                        window.lastSaleInvoiceId = lastInstallmentSale.invoice_id;
                    }
                }
                if (success) {
                    // ‚úÖ ŸÅŸÇÿ∑ ÿ∑ÿ®ÿßÿπÿ© ŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ™ŸÇÿ≥Ÿäÿ∑ ÿ®ÿπÿØ ÿßŸÑÿ®Ÿäÿπ (ÿ®ÿØŸàŸÜ ÿ•ŸäÿµÿßŸÑ ÿ™ÿ≥ÿØŸäÿØ)
                    if (window.lastSaleInvoiceId) {
                        printInstallmentInvoice(window.lastSaleInvoiceId, true, {
                            customer_name: customerName,
                            customer_phone: customerPhone,
                            customer_address: customerAddress,
                            installment_months: newInstallmentMonths,
                            monthly_amount: newMonthlyAmount,
                            down_payment: downPayment,
                            additional_amount: additionalAmount,
                            remaining_amount: newRemainingAmount
                        });
                    }
                    console.log('‚úÖ ÿ™ŸÖ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿØŸÅÿπ ÿ®ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿ®ŸÜÿ¨ÿßÿ≠');
                    closeModal('paymentModal');
                    resetInstallmentForm();
                } else {
                    console.log('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿØŸÅÿπ ÿ®ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑');
                }
            }
// ÿ∑ÿ®ÿßÿπÿ© ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ™ŸÇÿ≥Ÿäÿ∑ ŸÖŸÅÿµŸÑÿ© (ŸÜÿ∑ÿßŸÇ ÿπÿßŸÖ)
function printInstallmentInvoice(invoiceId, silent = false, extraData = {}) {
    window.printInstallmentInvoice = printInstallmentInvoice;
    (async () => {
        const settings = JSON.parse(localStorage.getItem('printerSettings') || '{}');
        let sale = null;
        let foundSource = '';
        console.log('üñ®Ô∏è ÿ®ÿØÿ° ÿ∑ÿ®ÿßÿπÿ© ŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑:', invoiceId);
        console.log('üì¶ ÿ®ŸäÿßŸÜÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©:', extraData);

        // 1. ÿ¨ŸÑÿ® ŸÖŸÜ salesData
        if (typeof salesData !== 'undefined' && Array.isArray(salesData)) {
            sale = salesData.find(s => s.invoice_id === invoiceId);
            if (sale) foundSource = 'salesData';
        }
        // 2. ÿ¨ŸÑÿ® ŸÖŸÜ window.dataSdk (ŸÖÿ™ÿ≤ÿßŸÖŸÜ ÿ£Ÿà ÿ∫Ÿäÿ± ŸÖÿ™ÿ≤ÿßŸÖŸÜ)
        if ((!sale || !sale.items) && window.dataSdk && typeof window.dataSdk.getAll === 'function') {
            let allSales = [];
            try {
                const result = window.dataSdk.getAll();
                if (result && typeof result.then === 'function') {
                    allSales = await result;
                } else {
                    allSales = result;
                }
            } catch {}
            if (Array.isArray(allSales)) {
                const found = allSales.find(s => s.invoice_id === invoiceId);
                if (found) { sale = found; foundSource = 'dataSdk'; }
            }
        }
        // 3. ÿ¨ŸÑÿ® ŸÖŸÜ window.invoicesDB (Ÿàÿßÿ¨Ÿáÿ© ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™)
        if ((!sale || !sale.items) && window.invoicesDB && typeof window.invoicesDB.getById === 'function') {
            try {
                const invoice = await window.invoicesDB.getById(invoiceId);
                if (invoice) { sale = invoice; foundSource = 'invoicesDB'; }
            } catch {}
        }
        // 4. ÿ¨ŸÑÿ® ŸÖŸÜ extraData (ÿ•ÿ∞ÿß ÿßÿ≠ÿ™ŸàŸâ ÿπŸÑŸâ ŸÉŸÑ ÿ¥Ÿäÿ°)
        if (!sale && extraData && extraData.items && extraData.final_total) {
            sale = { ...extraData, invoice_id: invoiceId };
            foundSource = 'extraData';
        }
        if (!sale) {
            console.error('‚ùå ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ© ŸÅŸä ÿ£Ÿä ŸÖÿµÿØÿ±:', invoiceId);
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            return;
        }
        console.log('‚úÖ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖŸÜ:', foundSource, sale);

        // ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ items ŸÖÿµŸÅŸàŸÅÿ©
        if (typeof sale.items === 'string') {
            try { sale.items = JSON.parse(sale.items); } catch { sale.items = []; }
        }
        if (!Array.isArray(sale.items)) sale.items = [];

        // ÿØŸÖÿ¨ ÿ®ŸäÿßŸÜÿßÿ™ extraData ŸÅŸàŸÇ ÿ®ŸäÿßŸÜÿßÿ™ sale (ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© ŸÑŸÑÿ£ÿ≠ÿØÿ´)
        if (extraData && typeof extraData === 'object') {
            for (const key of Object.keys(extraData)) {
                if (extraData[key] !== undefined && extraData[key] !== null && extraData[key] !== '') {
                    sale[key] = extraData[key];
                }
            }
        }

        // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
        const requiredFields = ['customer_name','installment_months','monthly_amount','final_total'];
        for (const field of requiredFields) {
            if (!sale[field]) {
                console.warn('‚ö†Ô∏è ÿßŸÑÿ≠ŸÇŸÑ ŸÜÿßŸÇÿµ ŸÑŸÑÿ∑ÿ®ÿßÿπÿ©:', field, sale);
            }
        }

        // ÿ™ŸàŸÑŸäÿØ HTML ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
        const receiptContent = generateInstallmentInvoiceReceipt(sale, settings);
        const printHtml = `<!DOCTYPE html><html dir="rtl" lang="ar"><head><meta charset="UTF-8"><title>ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ™ŸÇÿ≥Ÿäÿ∑ ${sale.invoice_id}</title><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet"><style>* { margin: 0; padding: 0; box-sizing: border-box; } body { font-family: 'Cairo', sans-serif; direction: rtl; background: white; } @media print { body { margin: 0; } @page { margin: 0; } }</style></head><body>${receiptContent}</body></html>`;

        // ÿ•ÿ¨ÿ®ÿßÿ± ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿµÿßŸÖÿ™ÿ© ÿØÿßÿ¶ŸÖŸãÿß
        if (typeof window.safePrintInvoice === 'function') {
            window.safePrintInvoice(printHtml, {
                silent: true,
                pageSize: 'A4',
                printBackground: true
            });
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        } else {
            // fallback: ŸÜÿßŸÅÿ∞ÿ© ÿ∑ÿ®ÿßÿπÿ© ÿπÿßÿØŸäÿ©
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printHtml);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); }, 500);
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }
        if (typeof updatePrintStats === 'function') updatePrintStats();
    })();
}
// ÿ™ÿπÿ±ŸäŸÅ ÿßŸÑÿØÿßŸÑÿ© ŸÅŸä window ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÅŸÇÿ∑ ÿ®ÿπÿØ ÿßŸÑÿØÿßŸÑÿ©
if (typeof window !== 'undefined') {
  window.printInstallmentInvoice = printInstallmentInvoice;
}
        // ÿ™ŸàŸÑŸäÿØ ŸÖÿ≠ÿ™ŸàŸâ ŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ™ŸÇÿ≥Ÿäÿ∑
        function generateInstallmentInvoiceReceipt(sale, settings) {
            // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑÿ≥ÿßÿπÿ© - ÿπÿ±ÿ®Ÿä ŸÖÿπ ÿ£ÿ±ŸÇÿßŸÖ ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©
            const saleDate = new Date(sale.timestamp || sale.created_at || Date.now());
            
            const dateOptions = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            const dateStrArabic = saleDate.toLocaleDateString('ar-IQ', dateOptions);
            const dateStr = toEnglishDigits(dateStrArabic);
            
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true
            };
            const timeStrArabic = saleDate.toLocaleTimeString('ar-IQ', timeOptions);
            const timeStr = toEnglishDigits(timeStrArabic);
            
            // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ŸÖŸÜ installment_details ÿ£Ÿà ŸÖŸÜ ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
            const installmentDetails = sale.installment_details || {};
            const originalSubtotal = installmentDetails.original_subtotal || sale.subtotal || 0;
            const additionalAmount = installmentDetails.additional_amount || sale.additional_amount || 0;
            const downPayment = installmentDetails.down_payment || sale.down_payment || 0;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿ®ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿµÿ≠Ÿäÿ≠
            const totalAmount = originalSubtotal + additionalAmount; // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä
            const remainingAmount = totalAmount - downPayment; // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä
            const finalTotal = remainingAmount; // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜŸáÿßÿ¶Ÿä = ÿßŸÑŸÖÿ™ÿ®ŸÇŸä
            const monthlyAmount = installmentDetails.monthly_amount || sale.monthly_amount || (remainingAmount / (installmentDetails.installment_months || sale.installment_months || 1));
            const installmentMonths = installmentDetails.installment_months || sale.installment_months || 0;
            const startDate = installmentDetails.start_date || sale.start_date || null;
            const advancedControlUsed = installmentDetails.advanced_control_used || installmentDetails.custom_values_used || false;
            
            let html = `<div style="width:210mm;min-height:297mm;margin:0 auto;padding:12mm 10mm;font-family:'Cairo',sans-serif;background:#fff;color:#222;line-height:1.4;font-size:11px;box-sizing:border-box;">
            
            <!-- ÿßŸÑŸáŸäÿØÿ± ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜ -->
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;padding-bottom:6px;border-bottom:2px solid #6366f1;">
                <!-- ÿßŸÑŸäÿ≥ÿßÿ±: ÿßŸÑÿ¥ÿπÿßÿ± Ÿàÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ -->
                <div style="flex:0 0 35%;display:flex;align-items:center;gap:10px;">
                    ${logoBase64 && logoBase64.startsWith('data:image') ? `<img src="${logoBase64}" alt="Logo" style="max-width:50px;max-height:50px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.15);" onerror="this.style.display='none'" />` : ''}
                    <h1 style="margin:0;font-size:1.3rem;font-weight:bold;color:#2d3748;">${settings?.store_name || 'ŸäÿπŸÇŸàÿ® ŸÑŸÑÿßÿ¨Ÿáÿ≤Ÿá ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ¶ŸäŸá'}</h1>
                </div>
                <!-- ÿßŸÑŸäŸÖŸäŸÜ: ÿßŸÑÿπŸÜŸàÿßŸÜ ŸàÿßŸÑŸáÿßÿ™ŸÅ -->
                <div style="flex:0 0 60%;text-align:left;">
                    <div style="font-size:0.95rem;color:#374151;font-weight:600;margin-bottom:2px;">${settings?.store_address || 'ÿ®ÿßÿ® ÿßŸÑŸáÿßÿ¥ŸÖŸäŸá ŸÇÿ±ÿ® ŸÖÿØÿ±ÿ≥Ÿá ÿßŸÑŸÉÿ±ÿßÿ±'}</div>
                    <div style="font-size:0.9rem;color:#6366f1;font-weight:600;">üìû ${settings?.store_phone || '07803092185'}</div>
                </div>
            </div>
            
            <!-- ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸàŸÖÿπŸÑŸàŸÖÿßÿ™Ÿáÿß -->
            <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:6px;padding:6px 10px;margin-bottom:8px;color:#fff;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <div style="font-size:1.05rem;font-weight:bold;">üìã ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ™ŸÇÿ≥Ÿäÿ∑</div>
                        <div style="font-size:0.85rem;opacity:0.95;">ÿ±ŸÇŸÖ: ${toEnglishDigits(sale.invoice_id || '')}</div>
                    </div>
                    <div style="text-align:left;font-size:0.85rem;">
                        <div>üìÖ ${dateStr}</div>
                        <div>üïê ${timeStr}</div>
                    </div>
                </div>
            </div>
            
            <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ - ÿµŸÅ Ÿàÿßÿ≠ÿØ -->
            <div style="background:#f8fafc;border-radius:6px;padding:6px 8px;margin-bottom:8px;border:1px solid #e2e8f0;">
                <div style="font-weight:bold;color:#1e293b;margin-bottom:4px;font-size:0.95rem;">üë§ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ</div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:0.9rem;">
                    <div><strong>ÿßŸÑÿßÿ≥ŸÖ:</strong> ${sale.customer_name || ''}</div>
                    <div><strong>ÿßŸÑŸáÿßÿ™ŸÅ:</strong> ${sale.customer_phone || ''}</div>
                    <div><strong>ÿßŸÑÿπŸÜŸàÿßŸÜ:</strong> ${sale.customer_address || ''}</div>
                </div>
            </div>
            
            <!-- ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ - ŸÖÿ∂ÿ∫Ÿàÿ∑ -->
            <div style="background:#f0f9ff;border-radius:6px;padding:6px 8px;margin-bottom:8px;border:1px solid #bae6fd;">
                <div style="font-weight:bold;color:#0c4a6e;margin-bottom:4px;font-size:0.95rem;">üí≥ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</div>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;font-size:0.85rem;">
                    <div style="background:#dbeafe;padding:4px;border-radius:4px;text-align:center;">
                        <div style="font-weight:600;color:#1e40af;font-size:0.8rem;">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä</div>
                        <div style="font-weight:bold;color:#1e3a8a;">${toEnglishDigits(originalSubtotal.toLocaleString('en'))}</div>
                    </div>
                    ${additionalAmount > 0 ? `<div style="background:#fce7f3;padding:4px;border-radius:4px;text-align:center;">
                        <div style="font-weight:600;color:#9f1239;font-size:0.8rem;">ŸÖÿ®ŸÑÿ∫ ÿ•ÿ∂ÿßŸÅŸä</div>
                        <div style="font-weight:bold;color:#be123c;">+${toEnglishDigits(additionalAmount.toLocaleString('en'))}</div>
                    </div>` : ''}
                    <div style="background:#e0e7ff;padding:4px;border-radius:4px;text-align:center;">
                        <div style="font-weight:600;color:#3730a3;font-size:0.8rem;">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä</div>
                        <div style="font-weight:bold;color:#4338ca;">${toEnglishDigits(totalAmount.toLocaleString('en'))}</div>
                    </div>
                    ${downPayment > 0 ? `<div style="background:#d1fae5;padding:4px;border-radius:4px;text-align:center;">
                        <div style="font-weight:600;color:#065f46;font-size:0.8rem;">ÿØŸÅÿπÿ© ŸÖŸÇÿØŸÖÿ©</div>
                        <div style="font-weight:bold;color:#047857;">-${toEnglishDigits(downPayment.toLocaleString('en'))}</div>
                    </div>` : ''}
                    <div style="background:#fee2e2;padding:4px;border-radius:4px;text-align:center;grid-column:span 2;">
                        <div style="font-weight:600;color:#7f1d1d;font-size:0.9rem;">üí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</div>
                        <div style="font-weight:bold;color:#991b1b;font-size:1.1rem;">${toEnglishDigits(finalTotal.toLocaleString('en'))} ÿØŸäŸÜÿßÿ±</div>
                    </div>
                    <div style="background:#fef3c7;padding:4px;border-radius:4px;text-align:center;">
                        <div style="font-weight:600;color:#78350f;font-size:0.8rem;">ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ±</div>
                        <div style="font-weight:bold;color:#92400e;">${toEnglishDigits(installmentMonths)}</div>
                    </div>
                    <div style="background:#ffedd5;padding:4px;border-radius:4px;text-align:center;">
                        <div style="font-weight:600;color:#7c2d12;font-size:0.8rem;">ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä</div>
                        <div style="font-weight:bold;color:#9a3412;">${toEnglishDigits(monthlyAmount.toLocaleString('en'))}</div>
                    </div>
                    ${startDate ? `<div style="background:#e0e7ff;padding:4px;border-radius:4px;text-align:center;">
                        <div style="font-weight:600;color:#3730a3;font-size:0.8rem;">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ©</div>
                        <div style="font-weight:bold;color:#4338ca;font-size:0.8rem;">${toEnglishDigits(new Date(startDate).toLocaleDateString('ar-IQ', { day: 'numeric', month: 'long', year: 'numeric' }))}</div>
                    </div>` : ''}
                    ${advancedControlUsed ? `<div style="background:#ede9fe;padding:4px;border-radius:4px;text-align:center;grid-column:1/-1;">
                        <div style="font-weight:600;color:#5b21b6;font-size:0.8rem;">‚öôÔ∏è ÿ™ÿ≠ŸÉŸÖ ŸÖÿ™ŸÇÿØŸÖ</div>
                    </div>` : ''}
                </div>
            </div>
            
            <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ - ŸÖÿ∂ÿ∫Ÿàÿ∑ -->
            <div style="margin-bottom:8px;">
                <table style="width:100%;border-collapse:collapse;font-size:0.9rem;border:1px solid #e5e7eb;">
                <thead>
                    <tr style="background:#6366f1;color:#fff;">
                        <th style="padding:4px 6px;width:6%;text-align:center;border:1px solid rgba(255,255,255,0.2);">#</th>
                        <th style="padding:4px 6px;width:44%;text-align:right;border:1px solid rgba(255,255,255,0.2);">ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
                        <th style="padding:4px 6px;width:12%;text-align:center;border:1px solid rgba(255,255,255,0.2);">ÿßŸÑŸÉŸÖŸäÿ©</th>
                        <th style="padding:4px 6px;width:18%;text-align:center;border:1px solid rgba(255,255,255,0.2);">ÿßŸÑÿ≥ÿπÿ±</th>
                        <th style="padding:4px 6px;width:20%;text-align:center;border:1px solid rgba(255,255,255,0.2);">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</th>
                    </tr>
                </thead>
                <tbody>`;
            
            let items = sale.items;
            if (typeof items === 'string') {
                try { items = JSON.parse(items); } catch { items = []; }
            }
            
            items.forEach((item, index) => {
                const name = item.product_name || item.name || '‚Äî';
                const price = item.product_price || item.price || 0;
                const qty = item.quantity || 1;
                const total = price * qty;
                html += `<tr style="background:${index%2===0?'#fff':'#f9fafb'};">
                    <td style="padding:4px 6px;text-align:center;border:1px solid #e5e7eb;font-weight:600;">${toEnglishDigits(index+1)}</td>
                    <td style="padding:4px 6px;text-align:right;border:1px solid #e5e7eb;">${name}</td>
                    <td style="padding:4px 6px;text-align:center;border:1px solid #e5e7eb;font-weight:600;">${toEnglishDigits(qty)}</td>
                    <td style="padding:4px 6px;text-align:center;border:1px solid #e5e7eb;font-weight:600;">${toEnglishDigits(price.toLocaleString('en'))}</td>
                    <td style="padding:4px 6px;text-align:center;border:1px solid #e5e7eb;font-weight:bold;color:#10b981;">${toEnglishDigits(total.toLocaleString('en'))}</td>
                </tr>`;
            });
            
            html += `</tbody></table></div>
            
                        <!-- ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ - ŸÖÿ∑ÿ®Ÿàÿπ -->
                        <div style="background:#f3f4f6;border-radius:6px;padding:6px 8px;margin-bottom:8px;border:1px solid #d1d5db;">
                            <div style="font-weight:bold;color:#6366f1;margin-bottom:4px;font-size:0.95rem;"><i class="fas fa-history"></i> ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™</div>
                            <table style="width:100%;border-collapse:collapse;font-size:0.9rem;border:1px solid #e5e7eb;">
                                <thead>
                                    <tr style="background:#6366f1;color:#fff;">
                                        <th style="padding:4px 6px;text-align:center;">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                                        <th style="padding:4px 6px;text-align:center;">ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
                                        <th style="padding:4px 6px;text-align:center;"># ÿßŸÑÿ¥Ÿáÿ±</th>
                                        <th style="padding:4px 6px;text-align:center;">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(Array.isArray(sale.payments) && sale.payments.length > 0) ? sale.payments.map(payment => {
                                        // ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇ ŸÑŸáÿ∞ÿß ÿßŸÑÿ™ÿ≥ÿØŸäÿØ
                                        let inst = Array.isArray(sale.installments) ? sale.installments.find(inst => inst.month === payment.month) : null;
                                        let autoNote = '';
                                        // ÿ£ŸàŸÑŸàŸäÿ©: ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØ ŸÖŸÜ payment.notesÿå ÿ´ŸÖ ŸÖŸÜ ÿßŸÑŸÇÿ≥ÿ∑ÿå ÿ´ŸÖ ÿ™ŸàŸÑŸäÿØ ÿ™ŸÑŸÇÿßÿ¶Ÿä
                                        if (payment.notes && payment.notes.trim() !== '') {
                                            autoNote = payment.notes;
                                        } else if (inst && inst.notes && inst.notes.trim() !== '') {
                                            autoNote = inst.notes;
                                        } else if (payment.payment_type === 'partial' && (payment.difference > 0 || (inst && inst.status === 'partially_paid'))) {
                                            // ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÇÿ≥ÿ∑ ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØ difference ŸÅŸä payment
                                            let paidAmount = payment.amount;
                                            let difference = payment.difference;
                                            if ((!difference || difference === 0) && inst) {
                                                difference = (inst.amount || 0) - (inst.paid_amount || 0);
                                                paidAmount = inst.paid_amount || payment.amount;
                                            }
                                            autoNote = `ÿ™ŸÖ ÿØŸÅÿπ ÿ¨ÿ≤ÿ° ŸÖŸÜ ÿßŸÑŸÇÿ≥ÿ∑ (${typeof formatCurrency === 'function' ? formatCurrency(paidAmount) : toEnglishDigits((paidAmount||0).toLocaleString('en'))})ÿå ÿßŸÑŸÖÿ™ÿ®ŸÇŸä (${typeof formatCurrency === 'function' ? formatCurrency(difference) : toEnglishDigits((difference||0).toLocaleString('en'))}) ÿ™ŸÖ ÿ™ÿ±ÿ≠ŸäŸÑŸá ÿ•ŸÑŸâ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÇÿßÿØŸÖ.`;
                                        } else if ((payment.payment_type === 'full' || (inst && inst.status === 'paid')) && (!payment.difference || payment.difference === 0)) {
                                            autoNote = 'ÿ™ÿ≥ÿØŸäÿØ ŸÉÿßŸÖŸÑ';
                                        } else {
                                            autoNote = '-';
                                        }
                                        // ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿßŸÑÿ™ÿ±ÿ≠ŸäŸÑ ÿ•ÿ∞ÿß Ÿàÿ¨ÿØÿ™
                                        if (inst && inst.carryforward_received && inst.carryforward_received > 0 && inst.carryforward_from_month) {
                                            autoNote += `<br><span style='color:#f59e0b;'>‚Üê ŸÖÿ±ÿ≠ŸÑ ŸÖŸÜ ÿßŸÑÿ¥Ÿáÿ± ${toEnglishDigits(inst.carryforward_from_month)}: ${toEnglishDigits(inst.carryforward_received.toLocaleString('en'))} ÿØ.ÿπ</span>`;
                                        }
                                        const dateStr = payment.date ? new Date(payment.date).toLocaleString('en-US') : '-';
                                        const amountStr = typeof formatCurrency === 'function' ? formatCurrency(payment.amount) : toEnglishDigits((payment.amount||0).toLocaleString('en'));
                                        return `<tr><td style="padding:4px 6px;text-align:center;">${dateStr}</td><td style="padding:4px 6px;text-align:center;color:#059669;font-weight:bold;">${amountStr}</td><td style="padding:4px 6px;text-align:center;">${toEnglishDigits(payment.month)}</td><td style="padding:4px 6px;text-align:right;">${autoNote}</td></tr>`;
                                    }).join('') : `<tr><td colspan="4" style="text-align:center;color:#aaa;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿ≥ÿØŸäÿØÿßÿ™</td></tr>`}
                                </tbody>
                            </table>
                        </div>

                        <!-- ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ¨ÿØŸäÿØÿßÿ™ - ŸÖÿ∑ÿ®Ÿàÿπ -->
                        ${(Array.isArray(sale.renewals) && sale.renewals.length > 0) || (Array.isArray(sale.installment_renewals) && sale.installment_renewals.length > 0) ? `
                        <div style="background:#fef9c3;border-radius:6px;padding:6px 8px;margin-bottom:8px;border:1px solid #fde68a;">
                            <div style="font-weight:bold;color:#eab308;margin-bottom:4px;font-size:0.95rem;"><i class='fas fa-redo'></i> ÿ≥ÿ¨ŸÑ ÿ™ÿ¨ÿØŸäÿØ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</div>
                            <table style="width:100%;border-collapse:collapse;font-size:0.9rem;border:1px solid #e5e7eb;">
                                <thead>
                                    <tr style="background:#eab308;color:#fff;">
                                        <th style="padding:4px 6px;text-align:center;">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                                        <th style="padding:4px 6px;text-align:center;">ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
                                        <th style="padding:4px 6px;text-align:center;">ŸÜŸàÿπ ÿßŸÑÿ™ÿ¨ÿØŸäÿØ</th>
                                        <th style="padding:4px 6px;text-align:center;">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿßŸÑÿ™ÿ¨ÿØŸäÿØ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${((sale.renewals || sale.installment_renewals) || []).map(renewal => {
                                        const dateStr = renewal.date ? new Date(renewal.date).toLocaleString('en-US') : '-';
                                        const amountStr = typeof formatCurrency === 'function' ? formatCurrency(renewal.amount) : toEnglishDigits((renewal.amount||0).toLocaleString('en'));
                                        const typeStr = renewal.type || renewal.renewal_type || '-';
                                        const noteStr = renewal.notes || renewal.renewal_notes || '-';
                                        return `<tr><td style="padding:4px 6px;text-align:center;">${dateStr}</td><td style="padding:4px 6px;text-align:center;color:#b45309;font-weight:bold;">${amountStr}</td><td style="padding:4px 6px;text-align:center;">${typeStr}</td><td style="padding:4px 6px;text-align:right;">${noteStr}</td></tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        ` : ''}

                        <!-- ŸÖŸÑÿÆÿµ ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ - ŸÖÿ∂ÿ∫Ÿàÿ∑ -->
            <div style="background:#fef3c7;border-radius:6px;padding:6px 8px;margin-bottom:8px;border:1px solid #fde68a;">
                <div style="font-weight:bold;color:#78350f;margin-bottom:4px;font-size:0.95rem;">üí∞ ŸÖŸÑÿÆÿµ ÿßŸÑŸÖÿ®ÿßŸÑÿ∫</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:0.9rem;">
                    <div style="display:flex;justify-content:space-between;padding:3px 6px;background:#e0f2fe;border-radius:4px;">
                        <span>ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿ¨ÿ≤ÿ¶Ÿä:</span>
                        <strong>${toEnglishDigits(originalSubtotal.toLocaleString('en'))}</strong>
                    </div>
                    ${additionalAmount > 0 ? `<div style="display:flex;justify-content:space-between;padding:3px 6px;background:#fce7f3;border-radius:4px;">
                        <span>ŸÖÿ®ŸÑÿ∫ ÿ•ÿ∂ÿßŸÅŸä:</span>
                        <strong style="color:#be123c;">+${toEnglishDigits(additionalAmount.toLocaleString('en'))}</strong>
                    </div>` : ''}
                    ${downPayment > 0 ? `<div style="display:flex;justify-content:space-between;padding:3px 6px;background:#d1fae5;border-radius:4px;">
                        <span>ÿØŸÅÿπÿ© ŸÖŸÇÿØŸÖÿ©:</span>
                        <strong style="color:#047857;">-${toEnglishDigits(downPayment.toLocaleString('en'))}</strong>
                    </div>` : ''}
                    <div style="grid-column:1/-1;display:flex;justify-content:space-between;padding:6px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:4px;color:#fff;">
                        <span style="font-size:1rem;font-weight:bold;">üíµ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä:</span>
                        <strong style="font-size:1.1rem;">${toEnglishDigits(finalTotal.toLocaleString('en'))} ÿØŸäŸÜÿßÿ±</strong>
                    </div>
                </div>
            </div>
            
            <!-- ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ŸÖÿ∂ÿ∫Ÿàÿ∑ÿ© -->
            <div style="background:#fffbeb;border-radius:6px;padding:6px 8px;margin-bottom:8px;border:1px solid #fbbf24;">
                <div style="font-weight:bold;color:#b91c1c;margin-bottom:4px;font-size:0.9rem;">‚ö†Ô∏è ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ŸáÿßŸÖÿ©</div>
                <ol style="font-size:0.8rem;padding-right:18px;margin:0;line-height:1.5;">
                    <li>ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖŸàÿ¨ŸàÿØ ŸáŸà ŸàÿµŸÑ ÿ£ŸÖÿßŸÜÿ©</li>
                    <li>ÿßŸÑÿ≥ÿπÿ± ŸÖÿ≠ŸÖŸä 24 ÿ≥ÿßÿπÿ©</li>
                    <li>ÿßŸÑŸÖÿ®ÿßÿπ ŸÑÿß Ÿäÿ±ÿ¨ÿπ ŸàŸÑÿß Ÿäÿ®ÿØŸÑ</li>
                    <li>ÿßŸÑÿÆÿ∑ÿ£ ŸàÿßŸÑÿ≥ŸáŸà ŸÖÿ±ÿ¨Ÿàÿπ ŸÑŸÑÿ∑ÿ±ŸÅŸäŸÜ</li>
                    <li>ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿßŸÑŸÖÿµŸÜÿπÿ© ŸÖÿ≥ÿ§ŸàŸÑÿ© ÿπŸÜ ÿßŸÑÿ∂ŸÖÿßŸÜ</li>
                    <li>ŸÉÿ≥ÿ± ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿ∫Ÿäÿ± ÿØÿßÿÆŸÑ ÿ®ÿßŸÑÿ∂ŸÖÿßŸÜ</li>
                    <li style="margin-top:4px;">
                        <div style="background:#e0f2fe;padding:4px 6px;border-radius:4px;border:1px solid #bae6fd;">
                            <strong style="color:#0c4a6e;">üë®‚Äçüîß ÿßŸÑÿµŸäÿßŸÜÿ©:</strong> ÿ≠ŸÖÿ≤Ÿá ÿßÿ®Ÿà ÿ≠Ÿàÿ±ÿßÿ° - ÿµŸäÿßŸÜÿ© ÿßŸÑÿ≥ÿ®ÿßŸÑÿ™
                            <div style="direction:ltr;text-align:left;font-weight:bold;color:#0c4a6e;margin-top:2px;">
                                üì± <span style="letter-spacing:1px;">+964 785 570 6118</span>
                            </div>
                        </div>
                    </li>
                </ol>
            </div>
            
            <!-- ÿßŸÑÿ™ŸàŸÇŸäÿπÿßÿ™ -->
            <div style="display:flex;justify-content:space-between;gap:30px;margin-top:10px;">
                <div style="flex:1;text-align:center;">
                    <div style="font-size:0.9rem;font-weight:bold;margin-bottom:15px;">‚úçÔ∏è ÿ™ŸàŸÇŸäÿπ ÿßŸÑÿ®ÿßÿ¶ÿπ</div>
                    <div style="border-bottom:1px dashed #9ca3af;"></div>
                </div>
                <div style="flex:1;text-align:center;">
                    <div style="font-size:0.9rem;font-weight:bold;margin-bottom:15px;">‚úçÔ∏è ÿ™ŸàŸÇŸäÿπ ÿßŸÑÿπŸÖŸäŸÑ</div>
                    <div style="border-bottom:1px dashed #9ca3af;"></div>
                </div>
            </div>
            
            <!-- ÿßŸÑÿÆÿ™ÿßŸÖ -->
            <div style="text-align:center;margin-top:10px;padding-top:6px;border-top:2px solid #e5e7eb;">
                <p style="margin:2px 0;font-size:0.95rem;font-weight:bold;color:#6366f1;">üåü ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ™ÿπÿßŸÖŸÑŸÉŸÖ ŸÖÿπŸÜÿß üåü</p>
                <p style="margin:2px 0;font-size:0.85rem;color:#6b7280;">ŸÜÿ™ÿ∑ŸÑÿπ ŸÑÿÆÿØŸÖÿ™ŸÉŸÖ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ</p>
            </div>
            </div>`;
            return html;
        }
         }
        
        // ÿØŸÖÿ¨ ÿßŸÑÿØŸäŸÜ ÿßŸÑÿ¨ÿØŸäÿØ ŸÖÿπ ÿßŸÑÿØŸäŸÜ ÿßŸÑŸÖŸàÿ¨ŸàÿØ
        async function mergeDebtToExisting(existingDebt, newDebtData) {
            console.log('üîó ÿ®ÿØÿ° ÿπŸÖŸÑŸäÿ© ÿØŸÖÿ¨ ÿßŸÑÿØŸäŸàŸÜ...');
            
            try {
                setLoading(true);
                
                // ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿ£ŸàŸÑÿßŸã
                const subtotal = cart.reduce((sum, item) => sum + (item.product_price * item.quantity), 0);
                const discountPercent = parseFloat(document.getElementById('discountInput')?.value) || 0;
                const discountAmount = subtotal * (discountPercent / 100);
                const afterDiscount = subtotal - discountAmount;
                const taxRate = parseFloat(getCurrentTaxRate()) / 100;
                const taxAmount = afterDiscount * taxRate;
                
                // Always use a deep copy of the latest cart for the new sale
                const latestCart = Array.isArray(newDebtData.cart) ? JSON.parse(JSON.stringify(newDebtData.cart)) : (Array.isArray(cart) ? JSON.parse(JSON.stringify(cart)) : []);
                
                // üî• ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ÿßŸÑÿµÿ≠Ÿäÿ≠ ŸÑŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                // Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ = ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä + ÿßŸÑÿ•ÿ∂ÿßŸÅŸä - ÿßŸÑŸÖŸÇÿØŸÖÿ©
                const correctFinalTotal = newDebtData.finalTotal || (newDebtData.newTotalAmount - newDebtData.downPayment);
                
                const saleData = {
                    type: 'sale',
                    invoice_id: 'INV-' + Date.now(),
                    items: JSON.stringify(latestCart),
                    subtotal: subtotal,
                    tax: taxAmount,
                    discount: discountAmount,
                    final_total: correctFinalTotal, // üî• ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ÿßŸÑÿµÿ≠Ÿäÿ≠
                    payment_method: 'ÿ£ŸÇÿ≥ÿßÿ∑',
                    payment_type: 'ÿ£ŸÇÿ≥ÿßÿ∑',
                    timestamp: new Date().toISOString(),
                    customer_name: existingDebt.customer_name,
                    customer_phone: existingDebt.customer_phone,
                    customer_address: newDebtData.customerAddress || existingDebt.customer_address,
                    linked_debt_id: existingDebt.id || existingDebt.invoice_id,
                    // üî• ÿ≠ŸÅÿ∏ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÉÿßŸÖŸÑÿ©
                    installment_months: newDebtData.newInstallmentMonths,
                    monthly_amount: newDebtData.newMonthlyAmount,
                    additional_amount: newDebtData.additionalAmount || 0,
                    down_payment: newDebtData.downPayment || 0,
                    remaining_amount: newDebtData.newRemainingAmount,
                    start_date: newDebtData.start_date,
                    // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ∞Ÿä ÿ£ŸÜÿ¥ÿ£ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                    created_by: window.securityManager ? window.securityManager.getCurrentUsername() : 'unknown',
                    created_by_name: window.securityManager ? window.securityManager.getCurrentUserFullName() : 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ',
                    created_by_role: window.securityManager && window.securityManager.currentUser ? window.securityManager.currentUser.role : 'unknown',
                    created_at: new Date().toISOString()
                };
                
                console.log('üíæ ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©...');
                const saleResult = await window.dataSdk.create(saleData);
                let newInvoiceId = saleData.invoice_id;
                if (!saleResult.isOk) {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    setLoading(false);
                    return false;
                }
                // Ensure the new invoice id is available for printing
                window.lastSaleInvoiceId = newInvoiceId;
                console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:', newInvoiceId);
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
                console.log('üì¶ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ...');
                await updateProductStock();
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ© ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ≥ÿØÿØÿ©
                const unpaidInstallments = (existingDebt.installments || []).filter(
                    inst => inst.status === 'pending'
                );
                
                console.log('üìä ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ≥ÿØÿØÿ©:', unpaidInstallments.length);
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ÿßŸÑÿ≠ÿßŸÑŸä
                const currentRemainingAmount = parseFloat(existingDebt.remaining_amount) || 0;
                
                // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ¨ÿØŸäÿØ
                const mergedTotalAmount = parseFloat(existingDebt.total_amount) + newDebtData.newTotalAmount;
                const mergedRemainingAmount = currentRemainingAmount + newDebtData.newRemainingAmount;
                
                // ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä ÿßŸÑŸÇÿØŸäŸÖ (ŸÖŸÜ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©)
                const oldMonthlyAmount = unpaidInstallments.length > 0 
                    ? parseFloat(unpaidInstallments[0].amount) 
                    : parseFloat(existingDebt.monthly_amount) || 0;
                
                // ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä ÿßŸÑÿ¨ÿØŸäÿØ (ŸÖŸÜ ÿßŸÑÿØŸäŸÜ ÿßŸÑÿ¨ÿØŸäÿØ)
                const newMonthlyAmount = newDebtData.newMonthlyAmount;
                
                // ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑÿ™Ÿä ÿ≥Ÿäÿ™ŸÖ ÿØŸÖÿ¨ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ŸÅŸäŸáÿß (ÿßŸÑÿ£ŸÇŸÑ ÿ®ŸäŸÜ ÿßŸÑŸÇÿØŸäŸÖ ŸàÿßŸÑÿ¨ÿØŸäÿØ)
                const overlappingMonths = Math.min(unpaidInstallments.length, newDebtData.newInstallmentMonths);
                
                // ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑÿ•ÿ∂ÿßŸÅŸäÿ© (ŸÖŸÜ ÿßŸÑÿØŸäŸÜ ÿßŸÑÿ£ÿ∑ŸàŸÑ)
                const remainingOldMonths = unpaidInstallments.length - overlappingMonths;
                const remainingNewMonths = newDebtData.newInstallmentMonths - overlappingMonths;
                
                console.log('üßÆ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑŸÖÿØŸÖÿ¨ÿ© (ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©):');
                console.log('  ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÇÿØŸäŸÖ:', existingDebt.total_amount);
                console.log('  ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ¨ÿØŸäÿØ:', newDebtData.newTotalAmount);
                console.log('  ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿØŸÖÿ¨:', mergedTotalAmount);
                console.log('  ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ÿßŸÑÿ≠ÿßŸÑŸä:', currentRemainingAmount);
                console.log('  ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ÿßŸÑÿ¨ÿØŸäÿØ:', newDebtData.newRemainingAmount);
                console.log('  ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ÿßŸÑŸÖÿØŸÖÿ¨:', mergedRemainingAmount);
                console.log('  ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä ÿßŸÑŸÇÿØŸäŸÖ:', oldMonthlyAmount);
                console.log('  ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä ÿßŸÑÿ¨ÿØŸäÿØ:', newMonthlyAmount);
                console.log('  ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ© ÿßŸÑŸÇÿØŸäŸÖÿ©:', unpaidInstallments.length);
                console.log('  ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©:', newDebtData.newInstallmentMonths);
                console.log('  ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑŸÖÿ™ÿØÿßÿÆŸÑÿ© (ŸÇÿ≥ÿ∑ ŸÖÿ≤ÿØŸàÿ¨):', overlappingMonths);
                console.log('  ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑÿ•ÿ∂ÿßŸÅŸäÿ© ŸÖŸÜ ÿßŸÑŸÇÿØŸäŸÖ:', remainingOldMonths);
                console.log('  ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑÿ•ÿ∂ÿßŸÅŸäÿ© ŸÖŸÜ ÿßŸÑÿ¨ÿØŸäÿØ:', remainingNewMonths);
                
                // ÿ≠ÿ≥ÿßÿ® ÿ•ÿ¨ŸÖÿßŸÑŸä ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ±
                const totalMonths = overlappingMonths + Math.max(remainingOldMonths, remainingNewMonths);
                
                // ÿ•ŸÜÿ¥ÿßÿ° ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿØŸÖÿ¨ (ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©)
                const mergedInstallments = [];
                
                // 1. ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ≥ÿØÿØÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© (ŸÑŸÑÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆŸä)
                const paidInstallments = (existingDebt.installments || []).filter(
                    inst => inst.status === 'paid'
                );
                
                mergedInstallments.push(...paidInstallments);
                
                let monthCounter = paidInstallments.length + 1;
                
                // 2. ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑŸÖÿ™ÿØÿßÿÆŸÑÿ© (ŸÇÿ≥ÿ∑ ŸÇÿØŸäŸÖ + ŸÇÿ≥ÿ∑ ÿ¨ÿØŸäÿØ)
                for (let i = 0; i < overlappingMonths; i++) {
                    const oldInstallment = unpaidInstallments[i];
                    const dueDate = oldInstallment.due_date || new Date(Date.now() + (monthCounter * 30 * 24 * 60 * 60 * 1000)).toISOString();
                    
                    mergedInstallments.push({
                        month: monthCounter,
                        amount: oldMonthlyAmount + newMonthlyAmount, // ‚úÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÇÿ≥ÿ∑ŸäŸÜ
                        old_amount: oldMonthlyAmount,
                        new_amount: newMonthlyAmount,
                        due_date: dueDate,
                        status: 'pending',
                        paid_date: null,
                        paid_amount: 0,
                        installment_type: 'merged', // ŸÇÿ≥ÿ∑ ŸÖÿØŸÖÿ¨
                        merge_info: `${formatCurrency(oldMonthlyAmount)} + ${formatCurrency(newMonthlyAmount)}`,
                        added_at: new Date().toISOString()
                    });
                    
                    monthCounter++;
                }
                
                // 3. ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑÿ•ÿ∂ÿßŸÅŸäÿ© ŸÖŸÜ ÿßŸÑÿØŸäŸÜ ÿßŸÑŸÇÿØŸäŸÖ (ÿ•ŸÜ Ÿàÿ¨ÿØÿ™)
                for (let i = overlappingMonths; i < unpaidInstallments.length; i++) {
                    const oldInstallment = unpaidInstallments[i];
                    const dueDate = oldInstallment.due_date || new Date(Date.now() + (monthCounter * 30 * 24 * 60 * 60 * 1000)).toISOString();
                    
                    mergedInstallments.push({
                        month: monthCounter,
                        amount: oldMonthlyAmount, // ‚úÖ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑŸÇÿØŸäŸÖ ŸÅŸÇÿ∑
                        due_date: dueDate,
                        status: 'pending',
                        paid_date: null,
                        paid_amount: 0,
                        installment_type: 'old_only', // ŸÖŸÜ ÿßŸÑÿØŸäŸÜ ÿßŸÑŸÇÿØŸäŸÖ ŸÅŸÇÿ∑
                        original_debt: 'ŸÖŸàÿ¨ŸàÿØ',
                        added_at: new Date().toISOString()
                    });
                    
                    monthCounter++;
                }
                
                // 4. ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑÿ•ÿ∂ÿßŸÅŸäÿ© ŸÖŸÜ ÿßŸÑÿØŸäŸÜ ÿßŸÑÿ¨ÿØŸäÿØ (ÿ•ŸÜ Ÿàÿ¨ÿØÿ™)
                for (let i = overlappingMonths; i < newDebtData.newInstallmentMonths; i++) {
                    const dueDate = new Date(Date.now() + (monthCounter * 30 * 24 * 60 * 60 * 1000));
                    
                    mergedInstallments.push({
                        month: monthCounter,
                        amount: newMonthlyAmount, // ‚úÖ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¨ÿØŸäÿØ ŸÅŸÇÿ∑
                        due_date: dueDate.toISOString(),
                        status: 'pending',
                        paid_date: null,
                        paid_amount: 0,
                        installment_type: 'new_only', // ŸÖŸÜ ÿßŸÑÿØŸäŸÜ ÿßŸÑÿ¨ÿØŸäÿØ ŸÅŸÇÿ∑
                        original_debt: 'ÿ¨ÿØŸäÿØ',
                        added_at: new Date().toISOString()
                    });
                    
                    monthCounter++;
                }
                
                console.log('üìã ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿØŸÖÿ¨:');
                console.log('  ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ≥ÿØÿØÿ©:', paidInstallments.length);
                console.log('  ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿØŸÖÿ¨ÿ© (ŸÇÿØŸäŸÖ+ÿ¨ÿØŸäÿØ):', overlappingMonths);
                console.log('  ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÇÿØŸäŸÖÿ© ŸÅŸÇÿ∑:', remainingOldMonths);
                console.log('  ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÅŸÇÿ∑:', remainingNewMonths);
                console.log('  ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑:', mergedInstallments.length);
                
                // ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ÿ¨ŸÑ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ©
                const linkedInvoices = Array.isArray(existingDebt.linked_invoices) ? [...existingDebt.linked_invoices] : [existingDebt.invoice_id];
                if (!linkedInvoices.includes(newInvoiceId)) linkedInvoices.push(newInvoiceId);
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿØŸäŸÜ ÿßŸÑŸÖŸàÿ¨ŸàÿØ
                const updatedDebtData = {
                    total_amount: mergedTotalAmount,
                    final_total: mergedTotalAmount,
                    remaining_amount: mergedRemainingAmount,
                    paid_amount: parseFloat(existingDebt.paid_amount) + newDebtData.downPayment,
                    monthly_amount: oldMonthlyAmount, // ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑŸÇÿØŸäŸÖ ÿßŸÑÿ£ÿµŸÑŸä (ŸÑŸÑŸÖÿ±ÿ¨ÿπ)
                    new_monthly_amount: newMonthlyAmount, // ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¨ÿØŸäÿØ ÿßŸÑŸÖÿ∂ÿßŸÅ
                    installment_months: totalMonths,
                    additional_amount: parseFloat(existingDebt.additional_amount) + newDebtData.additionalAmount,
                    installments: mergedInstallments,
                    customer_address: newDebtData.customerAddress || existingDebt.customer_address,
                    linked_invoices: linkedInvoices,
                    last_updated: new Date().toISOString(),
                    merge_count: (existingDebt.merge_count || 0) + 1,
                    merge_method: 'addition' // ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© (ŸàŸÑŸäÿ≥ ÿßŸÑÿ™Ÿàÿ≠ŸäÿØ)
                };
                
                console.log('üíæ ÿ™ÿ≠ÿØŸäÿ´ ÿ≥ÿ¨ŸÑ ÿßŸÑÿØŸäŸÜ...');
                const updateResult = await window.dataSdk.update(existingDebt.id, updatedDebtData);
                
                if (updateResult.isOk) {
                    console.log('‚úÖ ÿ™ŸÖ ÿØŸÖÿ¨ ÿßŸÑÿØŸäŸÜ ÿ®ŸÜÿ¨ÿßÿ≠');
                    
                    // ÿ±ÿ≥ÿßŸÑÿ© ÿ™Ÿàÿ∂Ÿäÿ≠Ÿäÿ© ŸÖŸÅÿµŸÑÿ©
                    let message = `ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿØŸäŸÜ ÿßŸÑÿ¨ÿØŸäÿØ ÿ®ŸÜÿ¨ÿßÿ≠!\n\n`;
                    message += `üìä ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ:\n`;
                    message += `ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ÿßŸÑŸÉŸÑŸä: ${formatCurrency(mergedRemainingAmount)}\n`;
                    message += `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ÿ¥Ÿáÿ±: ${totalMonths} ÿ¥Ÿáÿ±\n\n`;
                    
                    if (overlappingMonths > 0) {
                        const mergedAmount = oldMonthlyAmount + newMonthlyAmount;
                        message += `üí∞ ÿßŸÑÿ£ÿ¥Ÿáÿ± ${paidInstallments.length + 1}-${paidInstallments.length + overlappingMonths}:\n`;
                        message += `   ${formatCurrency(oldMonthlyAmount)} + ${formatCurrency(newMonthlyAmount)} = ${formatCurrency(mergedAmount)}\n\n`;
                    }
                    
                    if (remainingOldMonths > 0) {
                        message += `üí∞ ÿßŸÑÿ£ÿ¥Ÿáÿ± ${paidInstallments.length + overlappingMonths + 1}-${paidInstallments.length + overlappingMonths + remainingOldMonths}:\n`;
                        message += `   ${formatCurrency(oldMonthlyAmount)} (ÿßŸÑÿØŸäŸÜ ÿßŸÑŸÇÿØŸäŸÖ ŸÅŸÇÿ∑)\n\n`;
                    }
                    
                    if (remainingNewMonths > 0) {
                        const startMonth = paidInstallments.length + overlappingMonths + remainingOldMonths + 1;
                        message += `üí∞ ÿßŸÑÿ£ÿ¥Ÿáÿ± ${startMonth}-${startMonth + remainingNewMonths - 1}:\n`;
                        message += `   ${formatCurrency(newMonthlyAmount)} (ÿßŸÑÿØŸäŸÜ ÿßŸÑÿ¨ÿØŸäÿØ ŸÅŸÇÿ∑)\n`;
                    }
                    
                    showSuccessMessage(message);
                    
                    clearCart();
                    updateQuickStats();
                    setLoading(false);
                    return true;
                } else {
                    console.error('‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿØŸäŸÜ');
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    setLoading(false);
                    return false;
                }
                
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿØŸÖÿ¨ ÿßŸÑÿØŸäŸàŸÜ:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                setLoading(false);
                return false;
            }
        }
        
        // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ≥ÿØÿØÿ©
        function getUnpaidInstallmentsCount(debt) {
            if (!debt.installments || !Array.isArray(debt.installments)) {
                return debt.installment_months || 0;
            }
            return debt.installments.filter(inst => inst.status === 'pending').length;
        }
        
        // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
        function resetInstallmentForm() {
            const installmentForm = document.getElementById('installmentForm');
            if (installmentForm) {
                installmentForm.style.display = 'none';
            }
            
            // ŸÖÿ≥ÿ≠ ÿ≠ŸÇŸàŸÑ ÿßŸÑÿπŸÖŸäŸÑ
            const customerName = document.getElementById('customerName');
            const customerPhone = document.getElementById('customerPhone');
            const customerAddress = document.getElementById('customerAddress');
            const additionalAmount = document.getElementById('additionalAmount');
            const downPayment = document.getElementById('downPayment');
            const installmentMonths = document.getElementById('installmentMonths');
            
            if (customerName) customerName.value = '';
            if (customerPhone) customerPhone.value = '';
            if (customerAddress) customerAddress.value = '';
            if (additionalAmount) additionalAmount.value = '0';
            if (downPayment) downPayment.value = '0';
            if (installmentMonths) installmentMonths.value = '12';
            
            // ŸÖÿ≥ÿ≠ ÿ≠ŸÇŸàŸÑ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ
            const advancedEditMode = document.getElementById('advancedEditMode');
            const customOriginalAmount = document.getElementById('customOriginalAmount');
            const customTotalAmount = document.getElementById('customTotalAmount');
            const customMonthlyAmount = document.getElementById('customMonthlyAmount');
            const advancedEditFields = document.getElementById('advancedEditFields');
            
            if (advancedEditMode) advancedEditMode.checked = false;
            if (customOriginalAmount) customOriginalAmount.value = '';
            if (customTotalAmount) customTotalAmount.value = '';
            if (customMonthlyAmount) customMonthlyAmount.value = '';
            if (advancedEditFields) advancedEditFields.style.display = 'none';
            
            // ŸÖÿ≥ÿ≠ ÿßŸÑŸÇŸäŸÖ ÿßŸÑŸÖÿÆÿµÿµÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©
            window.customInstallmentValues = null;
            
            console.log('üîÑ ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ');
        }

        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿØŸÅÿπ
        async function processPayment(paymentMethod, paymentType, extraData = {}) {
            console.log('üí∞ ÿ®ÿØÿ° ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿØŸÅÿπ...');
            console.log('ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ:', paymentMethod);
            console.log('ŸÜŸàÿπ ÿßŸÑÿØŸÅÿπ:', paymentType);
            console.log('ÿßŸÑÿ≥ŸÑÿ©:', cart);
            
            if (cart.length === 0) {
                console.error('‚ùå ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ©!');
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return false;
            }
            
            if (isLoading) {
                console.warn('‚ö†Ô∏è ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÇŸäÿØ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞ ÿ®ÿßŸÑŸÅÿπŸÑ');
                return false;
            }
            
            setLoading(true);
            
            try {
                const subtotal = cart.reduce((sum, item) => sum + (item.product_price * item.quantity), 0);
                const discountPercent = parseFloat(document.getElementById('discountInput')?.value) || 0;
                const discountAmount = subtotal * (discountPercent / 100);
                const afterDiscount = subtotal - discountAmount;
                const taxRate = parseFloat(getCurrentTaxRate()) / 100;
                const taxAmount = afterDiscount * taxRate;
                let finalTotal = afterDiscount + taxAmount;
                let additionalDiscount = 0;

                // --- ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ∂ÿßŸÅŸä ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ---
                let priceDifference = 0;
                let shouldDistribute = false;
                let newFinalTotal = finalTotal;
                if (window.customCashAmount && window.customCashAmount > 0 && paymentType === 'ŸÜŸÇÿØŸä') {
                    // ÿ®Ÿäÿπ ŸÜŸÇÿØŸä ŸÖÿπ ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ≥ÿπÿ± ÿßŸÑŸÜŸáÿßÿ¶Ÿä
                    const originalTotal = finalTotal;
                    newFinalTotal = window.customCashAmount;
                    priceDifference = newFinalTotal - originalTotal;
                    additionalDiscount = originalTotal - newFinalTotal;
                    shouldDistribute = priceDifference !== 0;
                    finalTotal = newFinalTotal;
                } else if (paymentType === 'ÿ£ŸÇÿ≥ÿßÿ∑') {
                    // ÿ®Ÿäÿπ ÿ™ŸÇÿ≥Ÿäÿ∑: ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿ£ÿ≥ÿπÿßÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ£ÿµŸÑŸäÿ©
                    const additionalAmount = parseFloat(extraData.additional_amount) || 0;
                    const downPayment = parseFloat(extraData.down_payment) || 0;
                    
                    // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä = ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä + ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ∂ÿßŸÅŸä
                    const totalAmount = finalTotal + additionalAmount;
                    
                    // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ÿßŸÑŸÖÿ™ÿ®ŸÇŸä = ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä - ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©
                    newFinalTotal = totalAmount - downPayment;
                    
                    // ŸÑÿß ŸÜŸàÿ≤ÿπ ÿ£Ÿä ÿ¥Ÿäÿ° ÿπŸÑŸâ ÿ£ÿ≥ÿπÿßÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
                    shouldDistribute = false;
                    
                    finalTotal = newFinalTotal;
                    
                    console.log('üìä ÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑:');
                    console.log('  ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä:', subtotal + taxAmount - discountAmount);
                    console.log('  ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ∂ÿßŸÅŸä:', additionalAmount);
                    console.log('  ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä:', totalAmount);
                    console.log('  ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©:', downPayment);
                    console.log('  ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ÿßŸÑŸÖÿ™ÿ®ŸÇŸä:', finalTotal);
                }

                if (shouldDistribute && cart.length > 0) {
                    // ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÅÿ±ŸÇ ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ®ÿßŸÑÿ™ÿ≥ÿßŸàŸä
                    const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
                    const perUnitDiff = priceDifference / totalQuantity;
                    let distributed = 0;
                    cart.forEach((item, idx) => {
                        // ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÅÿ±ŸÇ ÿπŸÑŸâ ŸÉŸÑ Ÿàÿ≠ÿØÿ©
                        let addForThis = perUnitDiff * item.quantity;
                        // ŸÅŸä ÿ¢ÿÆÿ± ŸÖŸÜÿ™ÿ¨ÿå ÿπÿßŸÑÿ¨ ÿßŸÑŸÅÿ±ŸàŸÇÿßÿ™ ÿßŸÑŸÜÿßÿ™ÿ¨ÿ© ÿπŸÜ ÿßŸÑŸÉÿ≥Ÿàÿ±
                        if (idx === cart.length - 1) {
                            addForThis += priceDifference - (perUnitDiff * totalQuantity);
                        }
                        item.product_price = Math.round((item.product_price + addForThis / item.quantity));
                        distributed += addForThis;
                    });
                }

                console.log('üìä ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™:');
                console.log('  ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÅÿ±ÿπŸä:', subtotal);
                console.log('  ÿßŸÑÿÆÿµŸÖ:', discountAmount);
                console.log('  ÿßŸÑÿÆÿµŸÖ ÿßŸÑÿ•ÿ∂ÿßŸÅŸä:', additionalDiscount);
                console.log('  ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©:', taxAmount);
                console.log('  ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÜŸáÿßÿ¶Ÿä:', finalTotal);

                const saleData = {
                    type: 'sale',
                    invoice_id: 'INV-' + Date.now(),
                    items: JSON.stringify(cart),
                    subtotal: subtotal,
                    tax: taxAmount,
                    discount: discountAmount,
                    additional_discount: additionalDiscount,
                    final_total: finalTotal, // üî• Ÿáÿ∞ÿß ÿßŸÑÿ¢ŸÜ Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿµÿ≠Ÿäÿ≠ ÿ®ÿπÿØ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸàÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©
                    payment_method: paymentMethod,
                    payment_type: paymentType,
                    timestamp: new Date().toISOString(),
                    // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ∞Ÿä ÿ£ŸÜÿ¥ÿ£ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                    created_by: window.securityManager ? window.securityManager.getCurrentUsername() : 'unknown',
                    created_by_name: window.securityManager ? window.securityManager.getCurrentUserFullName() : 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ',
                    created_by_role: window.securityManager && window.securityManager.currentUser ? window.securityManager.currentUser.role : 'unknown',
                    created_at: new Date().toISOString(),
                    // ÿ≠ŸÅÿ∏ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ®Ÿäÿπ ÿ®ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÉÿßŸÖŸÑÿ© - ŸÖÿ≠ÿØÿ´
                    installment_details: paymentType === 'ÿ£ŸÇÿ≥ÿßÿ∑' ? {
                        // ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
                        original_subtotal: subtotal,
                        original_total: subtotal + taxAmount - discountAmount, // ÿßŸÑŸÖÿ®ŸÑÿ∫ ŸÇÿ®ŸÑ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸàÿßŸÑÿØŸÅÿπÿ©
                        total_amount: extraData.total_amount || (subtotal + taxAmount - discountAmount + (extraData.additional_amount || 0)),
                        additional_amount: extraData.additional_amount || 0,
                        down_payment: extraData.down_payment || 0,
                        remaining_amount: extraData.remaining_amount || 0,
                        
                        // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
                        installment_months: extraData.installment_months || 0,
                        monthly_amount: extraData.monthly_amount || 0,
                        start_date: extraData.start_date || null,
                        debt_date: extraData.debt_date || null,
                        
                        // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ
                        advanced_control_used: extraData.advanced_control_used || false,
                        custom_values_used: window.customInstallmentValues ? true : false,
                        
                        // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ
                        customer_name: extraData.customer_name || '',
                        customer_phone: extraData.customer_phone || '',
                        customer_address: extraData.customer_address || '',
                        
                        // ÿßŸÑÿ∑ÿßÿ®ÿπ ÿßŸÑÿ≤ŸÖŸÜŸä
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    } : null,
                    // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ ÿπŸÑŸâ ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© (ŸÑŸÑÿ®Ÿäÿπ ÿ®ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑)
                    customer_name: paymentType === 'ÿ£ŸÇÿ≥ÿßÿ∑' ? extraData.customer_name : undefined,
                    customer_phone: paymentType === 'ÿ£ŸÇÿ≥ÿßÿ∑' ? extraData.customer_phone : undefined,
                    customer_address: paymentType === 'ÿ£ŸÇÿ≥ÿßÿ∑' ? extraData.customer_address : undefined,
                    installment_months: paymentType === 'ÿ£ŸÇÿ≥ÿßÿ∑' ? extraData.installment_months : undefined,
                    monthly_amount: paymentType === 'ÿ£ŸÇÿ≥ÿßÿ∑' ? extraData.monthly_amount : undefined,
                    additional_amount: paymentType === 'ÿ£ŸÇÿ≥ÿßÿ∑' ? extraData.additional_amount : undefined,
                    down_payment: paymentType === 'ÿ£ŸÇÿ≥ÿßÿ∑' ? extraData.down_payment : undefined,
                    remaining_amount: paymentType === 'ÿ£ŸÇÿ≥ÿßÿ∑' ? extraData.remaining_amount : undefined,
                    start_date: paymentType === 'ÿ£ŸÇÿ≥ÿßÿ∑' ? extraData.start_date : undefined,
                    ...extraData
                };

                console.log('üìÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ®Ÿäÿπ:', saleData);

                if (window.dataSdk) {
                    console.log('üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®Ÿäÿπ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
                    const result = await window.dataSdk.create(saleData);

                    if (result.isOk) {
                        console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®Ÿäÿπ ÿ®ŸÜÿ¨ÿßÿ≠');

                        // ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ®Ÿäÿπ ŸÖÿπ Firestore
                        if (window.syncSaleToFirestore) {
                            const saleWithId = { ...saleData, id: result.id };
                            window.syncSaleToFirestore(saleWithId).catch(e => console.warn('‚ö†Ô∏è ŸÅÿ¥ŸÑ ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ®Ÿäÿπ:', e));
                        }

                        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
                        console.log('üì¶ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ...');
                        await updateProductStock();
                        console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ');

                        // ÿ•ŸÜÿ¥ÿßÿ° ÿØŸäŸÜ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿØŸÅÿπ ÿ®ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
                        if (paymentType === 'ÿ£ŸÇÿ≥ÿßÿ∑') {
                            console.log('üí≥ ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ÿ¨ŸÑ ÿØŸäŸÜ...');
                            console.log('=== Creating Debt Record ===');
                            console.log('finalTotal:', finalTotal);
                            console.log('extraData:', extraData);

                            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ extraData (ÿ™ŸÖ ÿ≠ÿ≥ÿßÿ®Ÿáÿß ŸÅŸä processInstallmentPayment)
                            const totalAmount = parseFloat(extraData.total_amount) || parseFloat(finalTotal) || 0;
                            const monthlyAmount = parseFloat(extraData.monthly_amount) || 0;
                            const installmentMonths = parseInt(extraData.installment_months) || 1;
                            const remainingAmount = parseFloat(extraData.remaining_amount) || totalAmount;
                            const downPayment = parseFloat(extraData.down_payment) || 0;
                            const additionalAmount = parseFloat(extraData.additional_amount) || 0;

                            console.log('Parsed values:');
                            console.log('  totalAmount:', totalAmount);
                            console.log('  monthlyAmount:', monthlyAmount);
                            console.log('  installmentMonths:', installmentMonths);
                            console.log('  remainingAmount:', remainingAmount);
                            console.log('  downPayment:', downPayment);
                            console.log('  additionalAmount:', additionalAmount);

                            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                            if (totalAmount === 0 || monthlyAmount === 0 || installmentMonths === 0) {
                                console.error('‚ùå Invalid debt data!');
                                console.error('  totalAmount:', totalAmount);
                                console.error('  monthlyAmount:', monthlyAmount);
                                console.error('  installmentMonths:', installmentMonths);
                                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                                setLoading(false);
                                return false;
                            }

                            // ÿ•ŸÜÿ¥ÿßÿ° ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
                            const installments = [];
                            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ™ÿßÿ±ŸäÿÆ ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸãÿå Ÿàÿ•ŸÑÿß ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ≠ÿßŸÑŸä
                            const startDate = extraData.start_date ? new Date(extraData.start_date) : new Date();
                            
                            for (let i = 1; i <= installmentMonths; i++) {
                                const dueDate = new Date(startDate);
                                dueDate.setMonth(dueDate.getMonth() + (i - 1));
                                installments.push({
                                    month: i,
                                    amount: monthlyAmount,
                                    due_date: dueDate.toISOString(),
                                    status: 'pending',
                                    paid_date: null,
                                    paid_amount: 0
                                });
                            }

                            const debtData = {
                                type: 'debt',
                                invoice_id: saleData.invoice_id,
                                customer_name: extraData.customer_name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ',
                                customer_phone: extraData.customer_phone || '',
                                customer_address: extraData.customer_address || '',
                                total_amount: totalAmount,
                                final_total: finalTotal, // üî• ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ÿßŸÑÿµÿ≠Ÿäÿ≠
                                remaining_amount: remainingAmount,
                                paid_amount: downPayment,
                                monthly_amount: monthlyAmount,
                                installment_months: installmentMonths,
                                additional_amount: additionalAmount,
                                down_payment: downPayment,
                                installments: installments,
                                start_date: extraData.start_date || null,
                                due_date: installments[0].due_date,
                                status: 'ŸÜÿ¥ÿ∑',
                                timestamp: extraData.debt_date ? new Date(extraData.debt_date).toISOString() : new Date().toISOString(),
                                created_at: extraData.debt_date ? new Date(extraData.debt_date).toISOString() : new Date().toISOString()
                            };

                            console.log('‚úÖ Final debt data to be saved:', debtData);
                            console.log('Installments array:', installments);

                            const savedDebt = await window.dataSdk.create(debtData);
                            console.log('‚úÖ Debt saved successfully:', savedDebt);

                            // ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿØŸäŸÜ ŸÖÿπ Firestore
                            if (window.syncDebtToFirestore && savedDebt.isOk) {
                                const debtWithId = { ...debtData, id: savedDebt.id };
                                window.syncDebtToFirestore(debtWithId).catch(e => console.warn('‚ö†Ô∏è ŸÅÿ¥ŸÑ ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿØŸäŸÜ:', e));
                            }

                            console.log('=========================');
                        }

                        console.log('üéâ ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠...');
                        showSuccessMessage('ÿ™ŸÖ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ®Ÿäÿπ ÿ®ŸÜÿ¨ÿßÿ≠!');

                        console.log('üõí ÿ•ŸÅÿ±ÿßÿ∫ ÿßŸÑÿ≥ŸÑÿ©...');
                        clearCart();
                        console.log('‚úÖ ÿ™ŸÖ ÿ•ŸÅÿ±ÿßÿ∫ ÿßŸÑÿ≥ŸÑÿ©');

                        console.log('üìä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™...');
                        updateQuickStats();

                        // ÿ≠ŸÅÿ∏ ŸÖÿπÿ±ŸÅ ÿ¢ÿÆÿ± ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ§Ÿáÿß ŸÑŸÑÿ∑ÿ®ÿßÿπÿ© ŸÑÿßÿ≠ŸÇÿßŸã
                        window.lastSaleInvoiceId = saleData.invoice_id;

                        setLoading(false);
                        console.log('‚úÖ ÿ™ŸÖ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                        return true;

                    } else {
                        console.error('‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®Ÿäÿπ:', result);
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                        setLoading(false);
                        return false;
                    }
                } else {
                    console.error('‚ùå dataSdk ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±');
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    setLoading(false);
                    return false;
                }

            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿØŸÅÿπ:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                setLoading(false);
                return false;
            }
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿÆÿ≤ŸàŸÜ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
        async function updateProductStock() {
            for (const item of cart) {
                const product = products.find(p => p.product_id === item.product_id);
                if (product && window.dataSdk && product.id) {
                    const newQuantity = (product.stock_quantity || product.product_quantity || 0) - item.quantity;
                    await window.dataSdk.update(product.id, { 
                        stock_quantity: newQuantity,
                        product_quantity: newQuantity
                    });
                    
                    // ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä ÿßŸÑŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ÿ£Ÿäÿ∂ÿßŸã
                    product.stock_quantity = newQuantity;
                    product.product_quantity = newQuantity;
                }
            }
            
            // üî• ŸÅÿ≠ÿµ ŸÅŸàÿ±Ÿä ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ®ÿπÿØ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
            if (window.NotificationsSystemV4 && window.NotificationsSystemV4.engine) {
                setTimeout(() => {
                    console.log('üîç ŸÅÿ≠ÿµ ŸÅŸàÿ±Ÿä ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ®ÿπÿØ ÿßŸÑÿ®Ÿäÿπ...');
                    window.NotificationsSystemV4.engine.performCheck();
                }, 1000);
            }
        }

        // ÿ≠ÿ∞ŸÅ ŸÖŸÜÿ™ÿ¨
        async function deleteProduct(productId) {
            // ŸÅÿ≠ÿµ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©
            if (!window.securityManager.checkPermission('products_delete')) {
                return;
            }
            
            const product = products.find(p => p.product_id === productId);
            
            if (!product) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            // ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∞ŸÅ
            if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨: ${product.product_name}ÿü`)) {
                return;
            }
            
            if (window.dataSdk && product.id) {
                const result = await window.dataSdk.delete(product.id);
                if (result.isOk) {
                    // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ©
                    window.securityManager.logOperation('ÿ≠ÿ∞ŸÅ ŸÖŸÜÿ™ÿ¨', {
                        productId: product.product_id,
                        productName: product.product_name,
                        barcode: product.product_barcode
                    });
                    
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    updateQuickStats();
                } else {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                }
            } else {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        // ÿ•ÿ∏Ÿáÿßÿ± ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨
        function showProductDetails(productId) {
            const product = products.find(p => p.product_id === productId);
            const category = categories.find(c => c.category_id === product.product_category);
            
            if (product) {
                const content = `
                    <div class="detail-row">
                        <span class="detail-label">ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨:</span>
                        <span class="detail-value">${product.product_name}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ:</span>
                        <span class="detail-value">${product.product_barcode || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ÿßŸÑÿ™ÿµŸÜŸäŸÅ:</span>
                        <span class="detail-value">${category ? category.category_name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ÿßŸÑŸÖŸàÿ±ÿØ:</span>
                        <span class="detail-value">${product.supplier || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ÿ≥ÿπÿ± ÿßŸÑÿ™ŸÉŸÑŸÅÿ© (ŸÖŸÅÿ±ÿØ):</span>
                        <span class="detail-value">${formatCurrency(product.product_cost_retail)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ (ŸÖŸÅÿ±ÿØ):</span>
                        <span class="detail-value">${formatCurrency(product.product_price_retail)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©:</span>
                        <span class="detail-value">${product.stock_quantity}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑŸÑŸÖÿÆÿ≤ŸàŸÜ:</span>
                        <span class="detail-value">${product.min_stock}</span>
                    </div>
                `;
                
                document.getElementById('productDetailsContent').innerHTML = content;
                showModal('productDetailsModal');
            }
        }

        // Helper functions
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                }).catch(err => {
                    console.error('ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ≥ÿÆ:', err);
                });
            } else {
                // ÿ∑ÿ±ŸäŸÇÿ© ÿ®ÿØŸäŸÑÿ© ŸÑŸÑŸÖÿ™ÿµŸÅÿ≠ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                } catch (err) {
                    console.error('ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ≥ÿÆ:', err);
                }
                document.body.removeChild(textarea);
            }
        }

        function formatCurrency(amount) {
            // ÿßŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ÿßŸÑŸÇŸäŸÖ ÿ∫Ÿäÿ± ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©
            const num = parseFloat(amount) || 0;
            // Always show numbers in English
            return toEnglishDigits(new Intl.NumberFormat('en-US', {
                style: 'decimal',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(num)) + ' ÿØŸäŸÜÿßÿ±';
        }

        function formatDate(dateString) {
            if (!dateString) return '--/--/----';
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-IQ', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit' 
            });
        }

        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) {
                // Always show numbers in English
                if (typeof value === 'number' || (typeof value === 'string' && /[0-9Ÿ†-Ÿ©]/.test(value))) {
                    element.textContent = toEnglishDigits(value);
                } else {
                    element.textContent = value;
                }
            }
        }

        function getCurrentTaxRate() {
            return document.getElementById('taxRate')?.textContent || '0';
        }

        function setLoading(loading) {
            isLoading = loading;
        }

        function clearCart() {
            console.log('üßπ ÿ•ŸÅÿ±ÿßÿ∫ ÿßŸÑÿ≥ŸÑÿ©...');
            console.log('ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÇÿ®ŸÑ ÿßŸÑÿ•ŸÅÿ±ÿßÿ∫:', cart.length);
            
            cart = [];
            
            console.log('ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ±ÿßÿ∫:', cart.length);
            console.log('üìã ÿ™ÿ≠ÿØŸäÿ´ ÿπÿ±ÿ∂ ÿßŸÑÿ≥ŸÑÿ©...');
            
            renderCart();
            updateCartSummary();
            updateCartCount();
            
            // ÿ™ÿπÿ∑ŸäŸÑ ÿ≤ÿ± ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ®Ÿäÿπ
            const checkoutBtn = document.getElementById('checkoutBtn');
            if (checkoutBtn) {
                checkoutBtn.disabled = true;
                console.log('üîí ÿ™ŸÖ ÿ™ÿπÿ∑ŸäŸÑ ÿ≤ÿ± ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ®Ÿäÿπ');
            }
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿÆÿµŸÖ
            const discountInput = document.getElementById('discountInput');
            if (discountInput) {
                discountInput.value = '0';
            }
            
            console.log('‚úÖ ÿ™ŸÖ ÿ•ŸÅÿ±ÿßÿ∫ ÿßŸÑÿ≥ŸÑÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        function showSuccessMessage(message) {
            const successMsg = document.getElementById('successMessage');
            if (successMsg) {
                successMsg.style.display = 'block';
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 3000);
            }
        }

        function showWelcomeMessage() {
            const welcomeHTML = `
                <div class="welcome-overlay">
                    <div class="welcome-card">
                        <div class="welcome-header">
                            <h2>üéâ ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ ŸÅŸä ŸÜÿ∏ÿßŸÖ ŸÜŸÇÿßÿ∑ ÿßŸÑÿ®Ÿäÿπ</h2>
                        </div>
                        <div class="welcome-body">
                            <p>‚ú® ŸÜÿ∏ÿßŸÖ ŸÖÿ™ŸÉÿßŸÖŸÑ ŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ŸàÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</p>
                            <div class="welcome-features">
                                <div class="welcome-feature">
                                    <span>üì¶</span>
                                    <p>ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸàÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</p>
                                </div>
                                <div class="welcome-feature">
                                    <span>üí∞</span>
                                    <p>ŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ŸàÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±</p>
                                </div>
                                <div class="welcome-feature">
                                    <span>üë•</span>
                                    <p>ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≤ÿ®ÿßÿ¶ŸÜ ŸàÿßŸÑÿØŸäŸàŸÜ</p>
                                </div>
                                <div class="welcome-feature">
                                    <span>üìä</span>
                                    <p>ÿ™ŸÇÿßÿ±Ÿäÿ± ŸÖŸÅÿµŸÑÿ© Ÿàÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</p>
                                </div>
                                <div class="welcome-feature">
                                    <span>üé®</span>
                                    <p>12 ÿ´ŸäŸÖ ŸÖÿπ ÿ™ÿÆÿµŸäÿµ ÿßŸÑÿ£ŸÑŸàÿßŸÜ</p>
                                </div>
                                <div class="welcome-feature">
                                    <span>üåê</span>
                                    <p>ÿØÿπŸÖ ÿ´ŸÑÿßÿ´ ŸÑÿ∫ÿßÿ™</p>
                                </div>
                            </div>
                            <p class="welcome-note">üí° ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ© ŸÑŸÑÿ®ÿØÿ°</p>
                            <p class="welcome-hint">ŸäŸÖŸÉŸÜŸÉ ÿ≠ÿ∞ŸÅŸáÿß ŸÖŸÜ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ‚Üí ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑ ÿßŸÑŸÖÿµŸÜÿπ</p>
                        </div>
                        <div class="welcome-footer">
                            <button class="welcome-btn" onclick="closeWelcome()">ÿßÿ®ÿØÿ£ ÿßŸÑÿ¢ŸÜ</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', welcomeHTML);
        }
        
        function closeWelcome() {
            const overlay = document.querySelector('.welcome-overlay');
            if (overlay) {
                overlay.classList.add('fade-out');
                setTimeout(() => overlay.remove(), 300);
            }
        }
        
        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ¥ÿßŸÖŸÑ
        function handleGlobalSearch(event) {
            const searchTerm = event.target.value.trim().toLowerCase();
            const searchResults = document.getElementById('searchResults');
            
            if (searchTerm.length === 0) {
                searchResults.classList.remove('active');
                return;
            }
            
            if (searchTerm.length < 2) {
                return;
            }
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            const results = {
                products: [],
                sales: [],
                debts: [],
                categories: []
            };
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
            products.forEach(product => {
                if ((product.name && product.name.toLowerCase().includes(searchTerm)) ||
                    (product.barcode && product.barcode.toLowerCase().includes(searchTerm)) ||
                    (product.supplier && product.supplier.toLowerCase().includes(searchTerm))) {
                    results.products.push(product);
                }
            });
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
            salesData.forEach(sale => {
                if ((sale.invoice_id && sale.invoice_id.toLowerCase().includes(searchTerm)) ||
                    (sale.customer_name && sale.customer_name.toLowerCase().includes(searchTerm)) ||
                    (sale.payment_method && sale.payment_method.toLowerCase().includes(searchTerm))) {
                    results.sales.push(sale);
                }
            });
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿØŸäŸàŸÜ
            debtsData.forEach(debt => {
                if ((debt.customer_name && debt.customer_name.toLowerCase().includes(searchTerm)) ||
                    (debt.customer_phone && debt.customer_phone.toLowerCase().includes(searchTerm)) ||
                    (debt.customer_address && debt.customer_address.toLowerCase().includes(searchTerm))) {
                    results.debts.push(debt);
                }
            });
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™
            categories.forEach(category => {
                if (category.name && category.name.toLowerCase().includes(searchTerm)) {
                    results.categories.push(category);
                }
            });
            
            // ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨
            renderSearchResults(results, searchTerm);
        }
        
        // ÿπÿ±ÿ∂ ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´
        function renderSearchResults(results, searchTerm) {
            const searchResults = document.getElementById('searchResults');
            let html = '';
            
            const totalResults = results.products.length + results.sales.length + 
                               results.debts.length + results.categories.length;
            
            if (totalResults === 0) {
                html = `
                    <div class="search-empty">
                        <i class="fas fa-search-minus"></i>
                        <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÑŸÑÿ®ÿ≠ÿ´ ÿπŸÜ "<strong>${searchTerm}</strong>"</p>
                        <small style="opacity: 0.7; margin-top: 0.5rem; display: block;">ÿ¨ÿ±ÿ® ŸÉŸÑŸÖÿßÿ™ ŸÖÿÆÿ™ŸÑŸÅÿ© ÿ£Ÿà ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ•ŸÖŸÑÿßÿ°</small>
                    </div>
                `;
            } else {
                // ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨
                html += `
                    <div class="search-header">
                        <span><i class="fas fa-search"></i> ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´</span>
                        <span class="search-total">${totalResults} ŸÜÿ™Ÿäÿ¨ÿ©</span>
                    </div>
                `;
                
                // ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
                if (results.products.length > 0) {
                    html += '<div class="search-category">';
                    html += `
                        <div class="search-category-title">
                            <i class="fas fa-box"></i>
                            <span>ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</span>
                            <span class="count">${results.products.length}</span>
                        </div>
                    `;
                    results.products.slice(0, 5).forEach(product => {
                        const stockStatus = product.stock_quantity <= product.min_stock ? 
                            '<span class="search-result-badge" style="background: #fee; color: #c33;">ŸÖÿÆÿ≤ŸàŸÜ ŸÖŸÜÿÆŸÅÿ∂</span>' : '';
                        html += `
                            <div class="search-result-item" onclick="goToProductDetails('${product.product_id}')">
                                <div class="search-result-icon">
                                    <i class="fas fa-box"></i>
                                </div>
                                <div class="search-result-info">
                                    <div class="search-result-title">${product.name}</div>
                                    <div class="search-result-subtitle">
                                        <span><i class="fas fa-barcode"></i> ${product.barcode || 'ÿ®ÿØŸàŸÜ ÿ®ÿßÿ±ŸÉŸàÿØ'}</span>
                                        <span><i class="fas fa-tag"></i> ${formatCurrency(product.selling_price)}</span>
                                        <span><i class="fas fa-boxes"></i> ${product.stock_quantity} ŸÇÿ∑ÿπÿ©</span>
                                        ${stockStatus}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    if (results.products.length > 5) {
                        html += `<div style="padding: 0.75rem 1.25rem; text-align: center; color: var(--theme-text-secondary); font-size: 0.85rem;">Ÿà ${results.products.length - 5} ŸÜÿ™ÿßÿ¶ÿ¨ ÿ£ÿÆÿ±Ÿâ...</div>`;
                    }
                    html += '</div>';
                }
                
                // ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
                if (results.sales.length > 0) {
                    html += '<div class="search-category">';
                    html += `
                        <div class="search-category-title">
                            <i class="fas fa-receipt"></i>
                            <span>ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±</span>
                            <span class="count">${results.sales.length}</span>
                        </div>
                    `;
                    results.sales.slice(0, 5).forEach(sale => {
                        const paymentBadge = sale.payment_method === 'ŸÜŸÇÿØŸä' ? 
                            '<span class="search-result-badge" style="background: #e6ffe6; color: #2d7a2d;">ŸÜŸÇÿØŸä</span>' : 
                            '<span class="search-result-badge" style="background: #fff4e6; color: #b36200;">ŸÇÿ≥ÿ∑</span>';
                        html += `
                            <div class="search-result-item" onclick="goToInvoiceDetails('${sale.sale_id}')">
                                <div class="search-result-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                    <i class="fas fa-receipt"></i>
                                </div>
                                <div class="search-result-info">
                                    <div class="search-result-title">ŸÅÿßÿ™Ÿàÿ±ÿ© #${sale.invoice_id || sale.sale_id.substring(0, 8)}</div>
                                    <div class="search-result-subtitle">
                                        <span><i class="fas fa-user"></i> ${sale.customer_name || 'ÿ≤ÿ®ŸàŸÜ ÿπÿßŸÖ'}</span>
                                        <span><i class="fas fa-money-bill"></i> ${formatCurrency(sale.total_amount)}</span>
                                        <span><i class="fas fa-calendar"></i> ${new Date(sale.sale_date).toLocaleDateString('ar-EG')}</span>
                                        ${paymentBadge}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    if (results.sales.length > 5) {
                        html += `<div style="padding: 0.75rem 1.25rem; text-align: center; color: var(--theme-text-secondary); font-size: 0.85rem;">Ÿà ${results.sales.length - 5} ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ£ÿÆÿ±Ÿâ...</div>`;
                    }
                    html += '</div>';
                }
                
                // ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿØŸäŸàŸÜ
                if (results.debts.length > 0) {
                    html += '<div class="search-category">';
                    html += `
                        <div class="search-category-title">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>ÿßŸÑÿØŸäŸàŸÜ</span>
                            <span class="count">${results.debts.length}</span>
                        </div>
                    `;
                    results.debts.slice(0, 5).forEach(debt => {
                        const isOverdue = debt.due_date && new Date(debt.due_date) < new Date();
                        const statusBadge = debt.remaining_amount <= 0 ? 
                            '<span class="search-result-badge" style="background: #e6ffe6; color: #2d7a2d;">ŸÖÿ≥ÿØÿØ</span>' :
                            isOverdue ? 
                            '<span class="search-result-badge" style="background: #ffe6e6; color: #c33;">ŸÖÿ™ÿ£ÿÆÿ±</span>' :
                            '<span class="search-result-badge" style="background: #fff4e6; color: #b36200;">ŸÜÿ¥ÿ∑</span>';
                        html += `
                            <div class="search-result-item" onclick="goToDebtDetails('${debt.debt_id}')">
                                <div class="search-result-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <div class="search-result-info">
                                    <div class="search-result-title">${debt.customer_name}</div>
                                    <div class="search-result-subtitle">
                                        <span><i class="fas fa-phone"></i> ${debt.customer_phone || 'ÿ®ÿØŸàŸÜ Ÿáÿßÿ™ŸÅ'}</span>
                                        <span><i class="fas fa-dollar-sign"></i> ${formatCurrency(debt.remaining_amount)} ŸÖÿ™ÿ®ŸÇŸä</span>
                                        ${statusBadge}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    if (results.debts.length > 5) {
                        html += `<div style="padding: 0.75rem 1.25rem; text-align: center; color: var(--theme-text-secondary); font-size: 0.85rem;">Ÿà ${results.debts.length - 5} ÿØŸäŸÜ ÿ¢ÿÆÿ±...</div>`;
                    }
                    html += '</div>';
                }
                
                // ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™
                if (results.categories.length > 0) {
                    html += '<div class="search-category">';
                    html += `
                        <div class="search-category-title">
                            <i class="fas fa-tags"></i>
                            <span>ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™</span>
                            <span class="count">${results.categories.length}</span>
                        </div>
                    `;
                    results.categories.slice(0, 3).forEach(category => {
                        const categoryProducts = products.filter(p => p.category_id === category.category_id);
                        html += `
                            <div class="search-result-item" onclick="goToCategory('${category.category_id}')">
                                <div class="search-result-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                    <i class="${category.icon || 'fas fa-tag'}"></i>
                                </div>
                                <div class="search-result-info">
                                    <div class="search-result-title">${category.name}</div>
                                    <div class="search-result-subtitle">
                                        <span><i class="fas fa-box"></i> ${categoryProducts.length} ŸÖŸÜÿ™ÿ¨</span>
                                        <span>${category.description || 'ÿ™ÿµŸÜŸäŸÅ ŸÖŸÜÿ™ÿ¨ÿßÿ™'}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    if (results.categories.length > 3) {
                        html += `<div style="padding: 0.75rem 1.25rem; text-align: center; color: var(--theme-text-secondary); font-size: 0.85rem;">Ÿà ${results.categories.length - 3} ÿ™ÿµŸÜŸäŸÅÿßÿ™ ÿ£ÿÆÿ±Ÿâ...</div>`;
                    }
                    html += '</div>';
                }
            }
            
            searchResults.innerHTML = html;
            searchResults.classList.add('active');
        }
        
        // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ÿ•ŸÑŸâ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÖŸÜ ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´
        function goToProductDetails(productId) {
            hideSearchResults();
            navigateTo('products');
            setTimeout(() => showProductDetails(productId), 100);
        }
        
        // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ÿ•ŸÑŸâ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖŸÜ ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´
        function goToInvoiceDetails(saleId) {
            hideSearchResults();
            navigateTo('invoices');
            setTimeout(() => showInvoiceDetails(saleId), 100);
        }
        
        // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ÿ•ŸÑŸâ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸäŸÜ ŸÖŸÜ ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´
        function goToDebtDetails(debtId) {
            hideSearchResults();
            navigateTo('debts');
            setTimeout(() => showDebtDetails(debtId), 100);
        }
        
        // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ÿ•ŸÑŸâ ÿßŸÑÿ™ÿµŸÜŸäŸÅ ŸÖŸÜ ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´
        function goToCategory(categoryId) {
            hideSearchResults();
            navigateTo('pos');
            currentCategory = categoryId;
            renderProducts();
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÅŸÑÿ™ÿ± ÿßŸÑŸÜÿ¥ÿ∑
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.category === categoryId) {
                    btn.classList.add('active');
                }
            });
        }
        
        // ÿ•ÿÆŸÅÿßÿ° ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´
        function hideSearchResults() {
            const searchResults = document.getElementById('searchResults');
            searchResults.classList.remove('active');
            document.getElementById('globalSearchInput').value = '';
        }


        function updateInvoicePreview(config) {
            if (!config) return; // ÿ≠ŸÖÿßŸäÿ© ŸÖŸÜ config ŸÅÿßÿ±ÿ∫
            
            const elements = {
                'previewStoreName': config.store_name,
                'previewStoreAddress': config.store_address,
                'previewStorePhone': config.store_phone
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                updateElement(id, value);
            });
        }

        // ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
        function showInvoiceDetails(invoiceId) {
            const sale = salesData.find(s => s.invoice_id === invoiceId);
            if (!sale) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            const content = document.getElementById('invoiceDetailsContent');
            if (!content) return;
            
            // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ items ŸÖÿµŸÅŸàŸÅÿ©
            let items = [];
            if (sale.items && Array.isArray(sale.items)) {
                items = sale.items;
            } else if (typeof sale.items === 'string') {
                try {
                    items = JSON.parse(sale.items);
                } catch (e) {
                    items = [];
                }
            }
            
            const itemsHTML = items.length > 0 ? items.map(item => {
                const price = item.product_price || item.price || 0;
                const quantity = item.quantity || 1;
                const total = quantity * price;
                return `
                <tr>
                    <td>${item.product_name || item.name || 'ŸÖŸÜÿ™ÿ¨'}</td>
                    <td style="text-align: center;">${quantity}</td>
                    <td>${formatCurrency(price)}</td>
                    <td style="font-weight: bold; color: var(--primary-color);">${formatCurrency(total)}</td>
                </tr>
                `;
            }).join('') : '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--theme-text-secondary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™</td></tr>';
            
            // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
            const installmentDetails = sale.installment_details || {};
            const originalSubtotal = installmentDetails.original_subtotal || sale.subtotal || 0;
            const additionalAmount = installmentDetails.additional_amount || sale.additional_amount || 0;
            const downPayment = installmentDetails.down_payment || sale.down_payment || 0;
            const remainingAmount = installmentDetails.remaining_amount || sale.remaining_amount || 0;
            const monthlyAmount = installmentDetails.monthly_amount || sale.monthly_amount || 0;
            const installmentMonths = installmentDetails.installment_months || sale.installment_months || 0;
            const startDate = installmentDetails.start_date || sale.start_date || null;
            const advancedControlUsed = installmentDetails.advanced_control_used || installmentDetails.custom_values_used || false;
            
            content.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: var(--theme-bg-secondary); padding: 15px; border-radius: 8px;">
                            <div style="color: var(--theme-text-secondary); font-size: 14px; margin-bottom: 5px;">ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</div>
                            <div style="font-size: 18px; font-weight: bold;">${sale.invoice_id}</div>
                        </div>
                        <div style="background: var(--theme-bg-secondary); padding: 15px; border-radius: 8px;">
                            <div style="color: var(--theme-text-secondary); font-size: 14px; margin-bottom: 5px;">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</div>
                            <div style="font-size: 16px; font-weight: 500;">${new Date(sale.timestamp).toLocaleString('en-US')}</div>
                        </div>
                        <div style="background: var(--theme-bg-secondary); padding: 15px; border-radius: 8px;">
                            <div style="color: var(--theme-text-secondary); font-size: 14px; margin-bottom: 5px;">ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ</div>
                            <div style="font-size: 16px; font-weight: 500;">${sale.customer_name || 'ÿπŸÖŸäŸÑ ŸÜŸÇÿØŸä'}</div>
                        </div>
                        <div style="background: var(--theme-bg-secondary); padding: 15px; border-radius: 8px;">
                            <div style="color: var(--theme-text-secondary); font-size: 14px; margin-bottom: 5px;">ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ</div>
                            <div style="font-size: 16px; font-weight: 500;">
                                <i class="fas fa-${sale.payment_method === 'ŸÜŸÇÿØŸä' ? 'money-bill-wave' : 'credit-card'}"></i>
                                ${sale.payment_type || sale.payment_method}
                            </div>
                        </div>
                    </div>
                    
                    ${sale.customer_phone ? `
                    <div style="background: var(--theme-bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="color: var(--theme-text-secondary); font-size: 14px; margin-bottom: 5px;">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</div>
                        <div style="font-size: 16px; font-weight: 500;">${sale.customer_phone}</div>
                    </div>
                    ` : ''}
                    
                    ${sale.customer_address ? `
                    <div style="background: var(--theme-bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="color: var(--theme-text-secondary); font-size: 14px; margin-bottom: 5px;">ÿßŸÑÿπŸÜŸàÿßŸÜ</div>
                        <div style="font-size: 16px; font-weight: 500;">${sale.customer_address}</div>
                    </div>
                    ` : ''}
                    
                    ${sale.payment_type === 'ÿ£ŸÇÿ≥ÿßÿ∑' ? `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-calendar-alt"></i> ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÉÿßŸÖŸÑÿ©
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                            <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">üíµ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä</div>
                                <div style="font-size: 18px; font-weight: bold;">${formatCurrency(originalSubtotal)}</div>
                            </div>
                            ${additionalAmount > 0 ? `
                            <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">‚ûï ŸÖÿ®ŸÑÿ∫ ÿ•ÿ∂ÿßŸÅŸä</div>
                                <div style="font-size: 18px; font-weight: bold;">${formatCurrency(additionalAmount)}</div>
                            </div>
                            ` : ''}
                            ${downPayment > 0 ? `
                            <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">üíµ ÿØŸÅÿπÿ© ŸÖŸÇÿØŸÖÿ©</div>
                                <div style="font-size: 18px; font-weight: bold;">${formatCurrency(downPayment)}</div>
                            </div>
                            ` : ''}
                            <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">üí≥ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</div>
                                <div style="font-size: 18px; font-weight: bold;">${formatCurrency(remainingAmount)}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">üìÖ ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ±</div>
                                <div style="font-size: 18px; font-weight: bold;">${installmentMonths} ÿ¥Ÿáÿ±</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">üìä ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä</div>
                                <div style="font-size: 18px; font-weight: bold;">${formatCurrency(monthlyAmount)}</div>
                            </div>
                            ${startDate ? `
                            <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">üìÜ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ©</div>
                                <div style="font-size: 16px; font-weight: bold;">${new Date(startDate).toLocaleDateString('en-GB')}</div>
                            </div>
                            ` : ''}
                            ${advancedControlUsed ? `
                            <div style="background: rgba(139, 92, 246, 0.3); padding: 12px; border-radius: 8px; grid-column: 1/-1; text-align: center;">
                                <div style="font-size: 14px; font-weight: bold;"><i class="fas fa-cog"></i> ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <h4 style="margin: 20px 0 10px 0; color: var(--primary-color);"><i class="fas fa-shopping-cart"></i> ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--theme-bg-secondary);">
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid var(--primary-color);">ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid var(--primary-color);">ÿßŸÑŸÉŸÖŸäÿ©</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid var(--primary-color);">ÿßŸÑÿ≥ÿπÿ±</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid var(--primary-color);">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHTML || '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--theme-text-secondary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: var(--theme-bg-secondary); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÅÿ±ÿπŸä:</span>
                            <span style="font-weight: bold;">${formatCurrency(sale.subtotal || 0)}</span>
                        </div>
                        ${additionalAmount > 0 && sale.payment_type === 'ÿ£ŸÇÿ≥ÿßÿ∑' ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; color: #be123c;">
                            <span>ŸÖÿ®ŸÑÿ∫ ÿ•ÿ∂ÿßŸÅŸä:</span>
                            <span style="font-weight: bold;">+${formatCurrency(additionalAmount)}</span>
                        </div>
                        ` : ''}
                        ${downPayment > 0 && sale.payment_type === 'ÿ£ŸÇÿ≥ÿßÿ∑' ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; color: var(--success-color);">
                            <span>ÿØŸÅÿπÿ© ŸÖŸÇÿØŸÖÿ©:</span>
                            <span style="font-weight: bold;">-${formatCurrency(downPayment)}</span>
                        </div>
                        ` : ''}
                        ${(sale.discount_amount || sale.discount) ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; color: var(--success-color);">
                            <span>ÿßŸÑÿÆÿµŸÖ:</span>
                            <span style="font-weight: bold;">-${formatCurrency(sale.discount_amount || sale.discount || 0)}</span>
                        </div>
                        ` : ''}
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©:</span>
                            <span style="font-weight: bold;">${formatCurrency(sale.tax_amount || sale.tax || 0)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 2px solid var(--primary-color); font-size: 20px; font-weight: bold; color: var(--primary-color);">
                            <span>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä:</span>
                            <span>${formatCurrency(sale.final_total || 0)}</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" onclick="printInvoiceFromDetails('${sale.invoice_id}', ${sale.payment_type === 'ÿ£ŸÇÿ≥ÿßÿ∑' ? 'true' : 'false'})">
                            <i class="fas fa-print"></i> ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                        </button>
                        <button class="btn" onclick="returnInvoice('${sale.invoice_id}')" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; margin-right: 10px;">
                            <i class="fas fa-undo-alt"></i> ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                        </button>
                        <button class="btn btn-secondary" onclick="closeModal('invoiceDetailsModal')" style="margin-right: 10px;">
                            <i class="fas fa-times"></i> ÿ•ÿ∫ŸÑÿßŸÇ
                        </button>
                    </div>
                </div>
            `;
            
            showModal('invoiceDetailsModal');
        }
        
        // ÿØÿßŸÑÿ© ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖŸÜ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
        function printInvoiceFromDetails(invoiceId, isInstallment) {
            console.log('üñ®Ô∏è ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ŸÖŸÜ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ:', invoiceId, 'ÿ£ŸÇÿ≥ÿßÿ∑:', isInstallment);
            if (isInstallment) {
                let sale = null;
                if (typeof salesData !== 'undefined' && Array.isArray(salesData)) {
                    sale = salesData.find(s => s.invoice_id === invoiceId);
                }
                // ÿ¨ŸÑÿ® ŸÖŸÜ window.dataSdk ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØ ŸÅŸä salesData
                if (!sale && window.dataSdk && typeof window.dataSdk.getAll === 'function') {
                    const allSales = window.dataSdk.getAll();
                    sale = allSales.find(s => s.invoice_id === invoiceId);
                }
                if (!sale) {
                    console.error('‚ùå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:', invoiceId);
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    return;
                }
                console.log('‚úÖ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑:', sale);
                printInstallmentInvoice(invoiceId, true, sale); // ÿ∑ÿ®ÿßÿπÿ© ÿµÿßŸÖÿ™ÿ©
            } else {
                console.log('‚úÖ ÿ∑ÿ®ÿßÿπÿ© ŸÅÿßÿ™Ÿàÿ±ÿ© ŸÜŸÇÿØŸäÿ©:', invoiceId);
                printInvoice(invoiceId, true); // ÿ∑ÿ®ÿßÿπÿ© ÿµÿßŸÖÿ™ÿ©
            }
        }

        // ========================================
        // üîÑ ŸÜÿ∏ÿßŸÖ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
        // ========================================
        
        /**
         * ÿØÿßŸÑÿ© ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ®ÿßŸÑŸÉÿßŸÖŸÑ
         * - ÿ™ÿ≥ÿ™ÿ±ÿ¨ÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑŸÑŸÖÿÆÿ≤ŸàŸÜ
         * - ÿ™ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖŸÜ ÿ≥ÿ¨ŸÑ ÿßŸÑÿØŸäŸàŸÜ (ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿ£ŸÇÿ≥ÿßÿ∑)
         * - ÿ™ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖŸÜ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™
         * - ÿ™ÿ≠ÿØÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
         */
        async function returnInvoice(invoiceId) {
            try {
                // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                const sale = salesData.find(s => s.invoice_id === invoiceId);
                
                if (!sale) {
                    showNotification('‚ùå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©', 'error');
                    console.error('‚ùå ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©:', invoiceId);
                    return;
                }
                
                // ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ
                const confirmMessage = `
ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ Ÿáÿ∞Ÿá ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©ÿü

üìã ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©: ${sale.invoice_id}
üë§ ÿßŸÑÿπŸÖŸäŸÑ: ${sale.customer_name || 'ÿπŸÖŸäŸÑ ŸÜŸÇÿØŸä'}
üí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${formatCurrency(sale.final_total || 0)}
üí≥ ŸÜŸàÿπ ÿßŸÑÿØŸÅÿπ: ${sale.payment_type || sale.payment_method}

‚ö†Ô∏è ÿ™ŸÜÿ®ŸäŸá: ÿ≥Ÿäÿ™ŸÖ:
‚Ä¢ ÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑŸÑŸÖÿÆÿ≤ŸàŸÜ
${sale.payment_type === 'ÿ£ŸÇÿ≥ÿßÿ∑' ? '‚Ä¢ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖŸÜ ÿ≥ÿ¨ŸÑ ÿßŸÑÿØŸäŸàŸÜ\n‚Ä¢ ÿ•ŸÑÿ∫ÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ©' : ''}
‚Ä¢ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖŸÜ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™

Ÿáÿ∞Ÿá ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸáÿß!
                `.trim();
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                console.log('üîÑ ÿ®ÿØÿ° ÿπŸÖŸÑŸäÿ© ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:', invoiceId);
                
                // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖŸÜ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                let items = [];
                if (sale.items && Array.isArray(sale.items)) {
                    items = sale.items;
                } else if (typeof sale.items === 'string') {
                    try {
                        items = JSON.parse(sale.items);
                    } catch (e) {
                        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™:', e);
                        items = [];
                    }
                }
                
                if (items.length === 0) {
                    showNotification('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©', 'warning');
                    return;
                }
                
                // ========================================
                // 1Ô∏è‚É£ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑŸÑŸÖÿÆÿ≤ŸàŸÜ
                // ========================================
                console.log('1Ô∏è‚É£ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑŸÑŸÖÿÆÿ≤ŸàŸÜ...');
                let productsUpdated = 0;
                
                for (const item of items) {
                    const product = products.find(p => p.product_id === item.product_id);
                    
                    if (product && window.dataSdk && product.id) {
                        try {
                            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© (ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸÖÿ®ÿßÿπÿ©)
                            const currentQuantity = product.stock_quantity || product.product_quantity || 0;
                            const returnQuantity = item.quantity || 1;
                            const newQuantity = currentQuantity + returnQuantity;
                            
                            console.log(`üì¶ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ: ${item.product_name} - ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©: ${currentQuantity} + ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ: ${returnQuantity} = ${newQuantity}`);
                            
                            // ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                            const updateResult = await window.dataSdk.update(product.id, { 
                                stock_quantity: newQuantity,
                                product_quantity: newQuantity
                            });
                            
                            if (updateResult.isOk) {
                                // ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä ÿßŸÑŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
                                product.stock_quantity = newQuantity;
                                product.product_quantity = newQuantity;
                                productsUpdated++;
                                console.log(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´: ${item.product_name}`);
                            } else {
                                console.error(`‚ùå ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´: ${item.product_name}`);
                            }
                        } catch (error) {
                            console.error(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ ${item.product_name}:`, error);
                        }
                    } else {
                        console.warn(`‚ö†Ô∏è ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ: ${item.product_name}`);
                    }
                }
                
                console.log(`‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ${productsUpdated} ŸÖŸÜ ${items.length} ŸÖŸÜÿ™ÿ¨`);
                
                // ========================================
                // 2Ô∏è‚É£ ÿ≠ÿ∞ŸÅ ŸÖŸÜ ÿ≥ÿ¨ŸÑ ÿßŸÑÿØŸäŸàŸÜ (ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ£ŸÇÿ≥ÿßÿ∑)
                // ========================================
                if (sale.payment_type === 'ÿ£ŸÇÿ≥ÿßÿ∑' && sale.customer_name) {
                    console.log('2Ô∏è‚É£ ÿ≠ÿ∞ŸÅ ŸÖŸÜ ÿ≥ÿ¨ŸÑ ÿßŸÑÿØŸäŸàŸÜ...');
                    
                    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿØŸäŸÜ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ ÿ®ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                    const relatedDebt = debtsData.find(d => 
                        d.invoice_id === invoiceId || 
                        (d.customer_name === sale.customer_name && 
                         d.total_debt === sale.final_total &&
                         Math.abs(new Date(d.debt_date).getTime() - new Date(sale.timestamp).getTime()) < 60000) // ŸÜŸÅÿ≥ ÿßŸÑŸàŸÇÿ™ ÿ™ŸÇÿ±Ÿäÿ®ÿßŸã
                    );
                    
                    if (relatedDebt) {
                        try {
                            console.log('üóëÔ∏è ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿØŸäŸÜ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑:', relatedDebt);
                            
                            // ÿ≠ÿ∞ŸÅ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                            if (window.dataSdk && (relatedDebt.id || relatedDebt.__backendId)) {
                                const deleteId = relatedDebt.id || relatedDebt.__backendId;
                                const deleteResult = await window.dataSdk.delete(deleteId);
                                
                                if (deleteResult.isOk) {
                                    console.log('‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿØŸäŸÜ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                                    
                                    // ÿ•ÿ≤ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
                                    const debtIndex = debtsData.findIndex(d => 
                                        d.id === deleteId || d.__backendId === deleteId
                                    );
                                    
                                    if (debtIndex !== -1) {
                                        debtsData.splice(debtIndex, 1);
                                        console.log('‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿØŸäŸÜ ŸÖŸÜ ÿßŸÑŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ©');
                                    }
                                } else {
                                    console.error('‚ùå ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑÿØŸäŸÜ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                                }
                            }
                        } catch (error) {
                            console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿØŸäŸÜ:', error);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿØŸäŸÜ ŸÖÿ±ÿ™ÿ®ÿ∑ ÿ®ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©');
                    }
                }
                
                // ========================================
                // 3Ô∏è‚É£ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖŸÜ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™
                // ========================================
                console.log('3Ô∏è‚É£ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖŸÜ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™...');
                
                try {
                    // ÿ≠ÿ∞ŸÅ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                    if (window.dataSdk && sale.id) {
                        const deleteResult = await window.dataSdk.delete(sale.id);
                        
                        if (deleteResult.isOk) {
                            console.log('‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                            
                            // ÿ•ÿ≤ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
                            const saleIndex = salesData.findIndex(s => s.invoice_id === invoiceId);
                            if (saleIndex !== -1) {
                                salesData.splice(saleIndex, 1);
                                console.log('‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖŸÜ ÿßŸÑŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ©');
                            }
                        } else {
                            console.error('‚ùå ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                            showNotification('‚ùå ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©', 'error');
                            return;
                        }
                    } else {
                        console.error('‚ùå ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© - ŸÖÿπÿ±ŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                        showNotification('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©', 'error');
                        return;
                    }
                } catch (error) {
                    console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:', error);
                    showNotification('‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©', 'error');
                    return;
                }
                
                // ========================================
                // 4Ô∏è‚É£ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ŸàÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
                // ========================================
                console.log('4Ô∏è‚É£ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ŸàÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™...');
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
                if (typeof renderInvoicesTable === 'function') {
                    renderInvoicesTable();
                }
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
                if (typeof renderProductsTable === 'function') {
                    renderProductsTable();
                }
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ÿØŸàŸÑ ÿßŸÑÿØŸäŸàŸÜ (ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿ£ŸÇÿ≥ÿßÿ∑)
                if (sale.payment_type === 'ÿ£ŸÇÿ≥ÿßÿ∑' && typeof renderDebtsTable === 'function') {
                    renderDebtsTable();
                }
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
                if (typeof updateQuickStats === 'function') {
                    updateQuickStats();
                }
                
                if (typeof updateStatistics === 'function') {
                    updateStatistics();
                }
                
                // ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
                closeModal('invoiceDetailsModal');
                
                // ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÜÿ¨ÿßÿ≠
                const successMessage = `
‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!

üìã ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©: ${invoiceId}
üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿ±ÿ¨ÿπÿ©: ${productsUpdated}/${items.length}
${sale.payment_type === 'ÿ£ŸÇÿ≥ÿßÿ∑' ? 'üí≥ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖŸÜ ÿ≥ÿ¨ŸÑ ÿßŸÑÿØŸäŸàŸÜ' : ''}

ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ŸàÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™.
                `.trim();
                
                showNotification(successMessage, 'success');
                console.log('‚úÖ ÿßŸÉÿ™ŸÖŸÑÿ™ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿ®ŸÜÿ¨ÿßÿ≠');
                
                // üî• ŸÅÿ≠ÿµ ŸÅŸàÿ±Ÿä ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ®ÿπÿØ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
                if (window.NotificationsSystemV4 && window.NotificationsSystemV4.engine) {
                    setTimeout(() => {
                        console.log('üîç ŸÅÿ≠ÿµ ŸÅŸàÿ±Ÿä ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ®ÿπÿØ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ...');
                        window.NotificationsSystemV4.engine.performCheck();
                    }, 1000);
                }
                
                // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÅŸä ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÖÿßŸÜ (ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã)
                if (window.securityManager && typeof window.securityManager.logOperation === 'function') {
                    window.securityManager.logOperation('ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ŸÅÿßÿ™Ÿàÿ±ÿ©', {
                        invoiceId: invoiceId,
                        customerName: sale.customer_name || 'ÿπŸÖŸäŸÑ ŸÜŸÇÿØŸä',
                        totalAmount: sale.final_total,
                        paymentType: sale.payment_type,
                        itemsCount: items.length,
                        productsReturned: productsUpdated
                    });
                }
                
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:', error);
                showNotification('‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©', 'error');
            }
        }

        // ========================================
        // ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÖÿ™ŸÇÿØŸÖ
        // ========================================

        // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿßÿ®ÿπÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
        const defaultPrinterSettings = {
            printerType: 'default',
            printMode: 'preview',
            paperSize: '80mm',
            storeTitleSize: 24,
            storeInfoSize: 14,
            invoiceTextSize: 13,
            tableTextSize: 12,
            totalTextSize: 16,
            footerTextSize: 11,
            lineHeight: 1.4,
            sidePadding: 15,
            topBottomPadding: 15,
            borderStyle: 'dashed',
            borderWidth: 1,
            titleAlign: 'center',
            showLogo: false,
            showDateTime: true,
            showInvoiceNumber: true,
            showProductsTable: true,
            showFooter: true,
            customFooter: 'ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ≤Ÿäÿßÿ±ÿ™ŸÉŸÖ\nŸÜÿ™ÿ∑ŸÑÿπ ŸÑÿÆÿØŸÖÿ™ŸÉŸÖ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ'
        };

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿßÿ®ÿπÿ© ÿπŸÜÿØ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
        function loadPrinterSettings() {
            const saved = localStorage.getItem('printerSettings');
            const settings = saved ? JSON.parse(saved) : defaultPrinterSettings;
            
            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿπŸÜÿßÿµÿ±
            if (document.getElementById('printerType')) {
                document.getElementById('printerType').value = settings.printerType || 'default';
                document.getElementById('paperSize').value = settings.paperSize || '80mm';
                
                // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿÆÿ∑Ÿàÿ∑
                document.getElementById('storeTitleSize').value = settings.storeTitleSize || 24;
                document.getElementById('storeTitleSizeValue').textContent = settings.storeTitleSize || 24;
                
                document.getElementById('storeInfoSize').value = settings.storeInfoSize || 14;
                document.getElementById('storeInfoSizeValue').textContent = settings.storeInfoSize || 14;
                
                document.getElementById('invoiceTextSize').value = settings.invoiceTextSize || 13;
                document.getElementById('invoiceTextSizeValue').textContent = settings.invoiceTextSize || 13;
                
                document.getElementById('tableTextSize').value = settings.tableTextSize || 12;
                document.getElementById('tableTextSizeValue').textContent = settings.tableTextSize || 12;
                
                document.getElementById('totalTextSize').value = settings.totalTextSize || 16;
                document.getElementById('totalTextSizeValue').textContent = settings.totalTextSize || 16;
                
                document.getElementById('footerTextSize').value = settings.footerTextSize || 11;
                document.getElementById('footerTextSizeValue').textContent = settings.footerTextSize || 11;
                
                // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ŸÜÿ≥ŸäŸÇ
                document.getElementById('lineHeight').value = settings.lineHeight || 1.4;
                document.getElementById('lineHeightValue').textContent = settings.lineHeight || 1.4;
                
                document.getElementById('sidePadding').value = settings.sidePadding || 15;
                document.getElementById('sidePaddingValue').textContent = settings.sidePadding || 15;
                
                document.getElementById('topBottomPadding').value = settings.topBottomPadding || 15;
                document.getElementById('topBottomPaddingValue').textContent = settings.topBottomPadding || 15;
                
                document.getElementById('borderStyle').value = settings.borderStyle || 'dashed';
                document.getElementById('borderWidth').value = settings.borderWidth || 1;
                document.getElementById('borderWidthValue').textContent = settings.borderWidth || 1;
                
                document.getElementById('titleAlign').value = settings.titleAlign || 'center';
                
                // ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅŸäÿ©
                document.getElementById('showLogo').checked = settings.showLogo || false;
                document.getElementById('showDateTime').checked = settings.showDateTime !== false;
                document.getElementById('showInvoiceNumber').checked = settings.showInvoiceNumber !== false;
                document.getElementById('showProductsTable').checked = settings.showProductsTable !== false;
                document.getElementById('showFooter').checked = settings.showFooter !== false;
                document.getElementById('customFooter').value = settings.customFooter || '';
                
                // Ÿàÿ∂ÿπ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
                const printMode = settings.printMode || 'preview';
                document.querySelector(`input[name="printMode"][value="${printMode}"]`).checked = true;
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ∑ÿßÿ®ÿπÿ©
                updatePrinterStats();
            }
            
            return settings;
        }

        // ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿßÿ®ÿπÿ©
        function savePrinterSettings() {
            const settings = {
                printerType: document.getElementById('printerType').value,
                printMode: document.querySelector('input[name="printMode"]:checked').value,
                paperSize: document.getElementById('paperSize').value,
                storeTitleSize: parseInt(document.getElementById('storeTitleSize').value),
                storeInfoSize: parseInt(document.getElementById('storeInfoSize').value),
                invoiceTextSize: parseInt(document.getElementById('invoiceTextSize').value),
                tableTextSize: parseInt(document.getElementById('tableTextSize').value),
                totalTextSize: parseInt(document.getElementById('totalTextSize').value),
                footerTextSize: parseInt(document.getElementById('footerTextSize').value),
                lineHeight: parseFloat(document.getElementById('lineHeight').value),
                sidePadding: parseInt(document.getElementById('sidePadding').value),
                topBottomPadding: parseInt(document.getElementById('topBottomPadding').value),
                borderStyle: document.getElementById('borderStyle').value,
                borderWidth: parseInt(document.getElementById('borderWidth').value),
                titleAlign: document.getElementById('titleAlign').value,
                showLogo: document.getElementById('showLogo').checked,
                showDateTime: document.getElementById('showDateTime').checked,
                showInvoiceNumber: document.getElementById('showInvoiceNumber').checked,
                showProductsTable: document.getElementById('showProductsTable').checked,
                showFooter: document.getElementById('showFooter').checked,
                customFooter: document.getElementById('customFooter').value
            };
            
            localStorage.setItem('printerSettings', JSON.stringify(settings));
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            updatePrinterStats();
        }

        // ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
        function resetPrinterSettings() {
            if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©ÿü')) {
                localStorage.setItem('printerSettings', JSON.stringify(defaultPrinterSettings));
                loadPrinterSettings();
                updatePreview();
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ∑ÿßÿ®ÿπÿ©
        function updatePrinterStats() {
            const settings = JSON.parse(localStorage.getItem('printerSettings') || '{}');
            const printerTypeNames = {
                'default': 'ÿπÿßÿØŸäÿ©',
                'thermal': 'ÿ≠ÿ±ÿßÿ±Ÿäÿ© 80mm',
                'thermal-58': 'ÿ≠ÿ±ÿßÿ±Ÿäÿ© 58mm'
            };
            
            if (document.getElementById('activePrinterType')) {
                document.getElementById('activePrinterType').textContent = 
                    printerTypeNames[settings.printerType] || 'ÿπÿßÿØŸäÿ©';
            }
            if (document.getElementById('activePaperSize')) {
                document.getElementById('activePaperSize').textContent = settings.paperSize || '80mm';
            }
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±ÿ©
        function updatePreview() {
            const settings = {
                printerType: document.getElementById('printerType')?.value || 'default',
                paperSize: document.getElementById('paperSize')?.value || '80mm',
                storeTitleSize: parseInt(document.getElementById('storeTitleSize')?.value || 24),
                storeInfoSize: parseInt(document.getElementById('storeInfoSize')?.value || 14),
                invoiceTextSize: parseInt(document.getElementById('invoiceTextSize')?.value || 13),
                tableTextSize: parseInt(document.getElementById('tableTextSize')?.value || 12),
                totalTextSize: parseInt(document.getElementById('totalTextSize')?.value || 16),
                footerTextSize: parseInt(document.getElementById('footerTextSize')?.value || 11),
                lineHeight: parseFloat(document.getElementById('lineHeight')?.value || 1.4),
                sidePadding: parseInt(document.getElementById('sidePadding')?.value || 15),
                topBottomPadding: parseInt(document.getElementById('topBottomPadding')?.value || 15),
                borderStyle: document.getElementById('borderStyle')?.value || 'dashed',
                borderWidth: parseInt(document.getElementById('borderWidth')?.value || 1),
                titleAlign: document.getElementById('titleAlign')?.value || 'center',
                showLogo: document.getElementById('showLogo')?.checked || false,
                showDateTime: document.getElementById('showDateTime')?.checked !== false,
                showInvoiceNumber: document.getElementById('showInvoiceNumber')?.checked !== false,
                showProductsTable: document.getElementById('showProductsTable')?.checked !== false,
                showFooter: document.getElementById('showFooter')?.checked !== false,
                customFooter: document.getElementById('customFooter')?.value || ''
            };
            
            const preview = document.getElementById('receiptPreview');
            if (!preview) return;
            
            // ÿ™ÿ≠ÿØŸäÿØ ÿπÿ±ÿ∂ ÿßŸÑÿ•ŸäÿµÿßŸÑ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ≠ÿ¨ŸÖ ÿßŸÑŸàÿ±ŸÇ
            let receiptWidth = '80mm';
            if (settings.paperSize === '58mm' || settings.printerType === 'thermal-58') {
                receiptWidth = '58mm';
            } else if (settings.paperSize === 'A4') {
                receiptWidth = '210mm';
            } else if (settings.paperSize === 'A5') {
                receiptWidth = '148mm';
            }
            
            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ±
            const storeName = localStorage.getItem('storeName') || 'ŸÖÿ™ÿ¨ÿ± ÿßŸÑÿ™ŸÇŸÜŸäÿ© ÿßŸÑÿ≠ÿØŸäÿ´ÿ©';
            const storeAddress = localStorage.getItem('storeAddress') || 'ÿ®ÿ∫ÿØÿßÿØ - ÿßŸÑŸÖŸÜÿµŸàÿ±';
            const storePhone = localStorage.getItem('storePhone') || '07803092185';
            
            // ÿ™ÿßÿ±ŸäÿÆ ŸàŸàŸÇÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-GB');
            const timeStr = now.toLocaleTimeString('ar-IQ', { hour: '2-digit', minute: '2-digit' });
            
            // ÿ®ŸÜÿßÿ° HTML ÿßŸÑÿ•ŸäÿµÿßŸÑ
            let receiptHTML = `
                <div style="
                    width: ${receiptWidth};
                    padding: ${settings.topBottomPadding}px ${settings.sidePadding}px;
                    font-family: 'Cairo', sans-serif;
                    line-height: ${settings.lineHeight};
                    font-size: ${settings.invoiceTextSize}px;
                ">
            `;
            
            // ÿßŸÑÿ¥ÿπÿßÿ± (ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸÅÿπŸÑÿßŸã)
            if (settings.showLogo) {
                // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ¥ÿπÿßÿ± Base64 ÿßŸÑŸÖÿ∂ŸÖŸÜ ŸÅŸä ÿßŸÑŸÉŸàÿØ ŸÑÿ∂ŸÖÿßŸÜ ÿ∏ŸáŸàÿ±Ÿá ŸÅŸä ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
                receiptHTML += `
                    <div style="text-align: ${settings.titleAlign}; margin-bottom: 10px;">
                        <img src="${logoBase64}" alt="Logo" style="max-width:90px;max-height:90px;display:inline-block;vertical-align:middle;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:8px;" onerror="this.style.display='none'" />
                    </div>
                `;
            }
            
            // ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖÿ™ÿ¨ÿ±
            receiptHTML += `
                <div style="text-align: ${settings.titleAlign}; margin-bottom: 15px;">
                    <h2 style="
                        margin: 0 0 8px 0;
                        font-size: ${settings.storeTitleSize}px;
                        font-weight: bold;
                    ">${storeName}</h2>
                    <p style="margin: 4px 0; font-size: ${settings.storeInfoSize}px;">${storeAddress}</p>
                    <p style="margin: 4px 0; font-size: ${settings.storeInfoSize}px;">üìû ${storePhone}</p>
                </div>
            `;
            
            // ÿÆÿ∑ ŸÅÿßÿµŸÑ ÿπŸÑŸàŸä
            receiptHTML += `
                <div style="
                    border-top: ${settings.borderWidth}px ${settings.borderStyle} #000;
                    margin: 15px 0;
                "></div>
            `;
            
            // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
            receiptHTML += `<div style="margin: 10px 0; font-size: ${settings.invoiceTextSize}px;">`;
            
            if (settings.showInvoiceNumber) {
                receiptHTML += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:</span>
                        <span style="font-weight: bold;">INV-${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}</span>
                    </div>
                `;
            }
            
            if (settings.showDateTime) {
                receiptHTML += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:</span>
                        <span>${dateStr}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>ÿßŸÑŸàŸÇÿ™:</span>
                        <span>${timeStr}</span>
                    </div>
                `;
            }
            
            receiptHTML += `</div>`;
            
            // ÿÆÿ∑ ŸÅÿßÿµŸÑ
            receiptHTML += `
                <div style="
                    border-top: ${settings.borderWidth}px ${settings.borderStyle} #000;
                    margin: 15px 0;
                "></div>
            `;
            
            // ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
            if (settings.showProductsTable) {
                receiptHTML += `
                    <table style="
                        width: 100%;
                        border-collapse: collapse;
                        font-size: ${settings.tableTextSize}px;
                        margin: 10px 0;
                    ">
                        <thead>
                            <tr style="border-bottom: ${settings.borderWidth}px solid #000;">
                                <th style="text-align: right; padding: 5px 0; font-weight: bold;">ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
                                <th style="text-align: center; padding: 5px 0; font-weight: bold;">ÿßŸÑŸÉŸÖŸäÿ©</th>
                                <th style="text-align: left; padding: 5px 0; font-weight: bold;">ÿßŸÑÿ≥ÿπÿ±</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 8px 0; border-bottom: 1px dotted #ccc;">ŸÖŸÜÿ™ÿ¨ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä 1</td>
                                <td style="text-align: center; padding: 8px 0; border-bottom: 1px dotted #ccc;">2</td>
                                <td style="text-align: left; padding: 8px 0; border-bottom: 1px dotted #ccc;">20,000</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; border-bottom: 1px dotted #ccc;">ŸÖŸÜÿ™ÿ¨ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä 2</td>
                                <td style="text-align: center; padding: 8px 0; border-bottom: 1px dotted #ccc;">1</td>
                                <td style="text-align: left; padding: 8px 0; border-bottom: 1px dotted #ccc;">15,000</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0;">ŸÖŸÜÿ™ÿ¨ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä 3</td>
                                <td style="text-align: center; padding: 8px 0;">3</td>
                                <td style="text-align: left; padding: 8px 0;">45,000</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }
            
            // ÿÆÿ∑ ŸÅÿßÿµŸÑ
            receiptHTML += `
                <div style="
                    border-top: ${settings.borderWidth}px ${settings.borderStyle} #000;
                    margin: 15px 0;
                "></div>
            `;
            
            // ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
            receiptHTML += `
                <div style="
                    font-size: ${settings.totalTextSize}px;
                    font-weight: bold;
                    margin: 15px 0;
                ">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿ¨ÿ≤ÿ¶Ÿä:</span>
                        <span>80,000 ÿØŸäŸÜÿßÿ±</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>ÿßŸÑÿÆÿµŸÖ:</span>
                        <span style="color: #10b981;">- 5,000 ÿØŸäŸÜÿßÿ±</span>
                    </div>
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        padding-top: 8px;
                        border-top: 2px solid #000;
                    ">
                        <span>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä:</span>
                        <span>75,000 ÿØŸäŸÜÿßÿ±</span>
                    </div>
                </div>
            `;
            
            // ÿßŸÑÿ™ÿ∞ŸäŸäŸÑ
            if (settings.showFooter) {
                const footerText = settings.customFooter || 'ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ≤Ÿäÿßÿ±ÿ™ŸÉŸÖ\nŸÜÿ™ÿ∑ŸÑÿπ ŸÑÿÆÿØŸÖÿ™ŸÉŸÖ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ';
                const footerLines = footerText.split('\n');
                
                receiptHTML += `
                    <div style="
                        text-align: center;
                        margin-top: 20px;
                        font-size: ${settings.footerTextSize}px;
                        color: #666;
                    ">
                `;
                
                footerLines.forEach(line => {
                    receiptHTML += `<p style="margin: 4px 0;">${line}</p>`;
                });
                
                receiptHTML += `
                        <p style="margin-top: 10px;">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</p>
                    </div>
                `;
            }
            
            receiptHTML += `</div>`;
            
            preview.innerHTML = receiptHTML;
        }

        // ÿ∑ÿ®ÿßÿπÿ© ŸÅÿßÿ™Ÿàÿ±ÿ© ŸÅÿπŸÑŸäÿ©
        function printInvoice(invoiceId, silent = false) {
            const settings = JSON.parse(localStorage.getItem('printerSettings') || '{}');
            // ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£Ÿà ŸÖŸÜ salesData
            let sale = null;
            // Always fetch the latest sale from both memory and persistent storage
            if (typeof salesData !== 'undefined' && Array.isArray(salesData)) {
                sale = salesData.find(s => s.invoice_id === invoiceId);
            }
            if (window.dataSdk && window.dataSdk.getAll) {
                const allSales = window.dataSdk.getAll();
                // Prefer the most recent sale with this invoice_id
                const found = allSales.find(s => s.invoice_id === invoiceId);
                if (found) sale = found;
            }
            if (!sale) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            // Always parse items to ensure latest products are shown
            if (typeof sale.items === 'string') {
                try { sale.items = JSON.parse(sale.items); } catch { sale.items = []; }
            }
            
            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÇŸàÿßŸÑÿ® ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿ®Ÿäÿπ
            let receiptContent;
            const paymentMethod = sale.payment_method || sale.payment_type || '';
            const isInstallment = paymentMethod === 'ÿ£ŸÇÿ≥ÿßÿ∑' || paymentMethod === 'ÿ™ŸÇÿ≥Ÿäÿ∑' || sale.installment_months > 0;
            
            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÇŸàÿßŸÑÿ® ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÖŸÜ ŸÖŸÑŸÅ yaqoub-invoice-templates.js
            if (isInstallment) {
                // ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ™ŸÇÿ≥Ÿäÿ∑
                receiptContent = typeof window.generateYaqoubInstallmentReceipt === 'function'
                    ? window.generateYaqoubInstallmentReceipt(sale, settings)
                    : generateInstallmentInvoiceReceipt(sale, settings); // fallback
            } else {
                // ŸÅÿßÿ™Ÿàÿ±ÿ© ŸÜŸÇÿØ
                receiptContent = typeof window.generateYaqoubCashReceipt === 'function'
                    ? window.generateYaqoubCashReceipt(sale, settings)
                    : generateInvoiceReceipt(sale, settings); // fallback
            }
            
            // ÿ¨ŸÑÿ® ÿßÿ≥ŸÖ ÿßŸÑÿ∑ÿßÿ®ÿπÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÖŸÜ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
            let printerName = '';
            try {
                const printerSettings = JSON.parse(localStorage.getItem('printerSettings') || '{}');
                printerName = printerSettings.selectedPrinter || printerSettings.printerName || '';
            } catch {}

            // ÿ∑ÿ®ÿßÿπÿ© ÿ¢ŸÖŸÜÿ© ÿ™ÿ∂ŸÖŸÜ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿØÿßÿ¶ŸÖÿßŸã
            if (typeof window.safePrintInvoice === 'function') {
                window.safePrintInvoice(receiptContent, {
                    silent: true,
                    pageSize: 'A4',
                    printBackground: true,
                    printerName: printerName
                });
            } else {
                // ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ∑ÿ®ÿßÿπÿ©
                const printWindow = window.open('', '_blank');
                printWindow.document.write(receiptContent);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
            if (typeof updatePrintStats === 'function') updatePrintStats();
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }

        // ÿ™ŸàŸÑŸäÿØ ŸÖÿ≠ÿ™ŸàŸâ ÿ•ŸäÿµÿßŸÑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© (ŸÜÿ≥ÿÆÿ© ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ© - ÿßÿ™ÿ¨ÿßŸá LTR)
        function generateInvoiceReceipt(sale, settings) {
                    // ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ÿ•ŸÑŸâ ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©
                    // ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿπÿßŸÖÿ© toEnglishDigits
            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ± ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
            const storeName = 'ŸÖÿπÿ±ÿ∂ ŸäÿπŸÇŸàÿ® ŸÑŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ©';
            const storeAddress = 'ÿ®ÿßÿ® ÿßŸÑŸáÿßÿ¥ŸÖŸäÿ© ŸÇÿ±ÿ® ŸÖÿØÿ±ÿ≥ÿ© ÿßŸÑŸÉÿ±ÿßÿ±';
            const storePhone = localStorage.getItem('storePhone') || '07803092185';

            // ŸÇÿßŸÑÿ® A4 ÿØÿßÿ¶ŸÖŸãÿß
            let receiptWidth = '210mm';

            // ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™ - ÿπÿ±ÿ∂ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
            let saleDate = sale.date ? new Date(sale.date) : (sale.timestamp ? new Date(sale.timestamp) : new Date());
            if (typeof saleDate === 'string') saleDate = new Date(saleDate);
            
            // ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸÖÿπ ÿ£ÿ±ŸÇÿßŸÖ ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            const dateStrArabic = saleDate.toLocaleDateString('ar-IQ', dateOptions);
            const dateStr = toEnglishDigits(dateStrArabic); // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ŸÑŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©
            
            // ÿßŸÑŸàŸÇÿ™ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸÖÿπ ÿ£ÿ±ŸÇÿßŸÖ ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            const timeStrArabic = saleDate.toLocaleTimeString('ar-IQ', timeOptions);
            const timeStr = toEnglishDigits(timeStrArabic); // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ŸÑŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©

            let html = `
            <div style="
                width: ${receiptWidth};
                margin: 0 auto;
                padding: 32px 32px;
                font-family: 'Cairo', sans-serif;
                background: #fff;
                color: #222;
                border: 1px solid #e5e7eb;
                border-radius: 12px;
                box-shadow: 0 4px 24px rgba(0,0,0,0.08);
                line-height: 1.7;
                font-size: 18px;
                direction: rtl;
                text-align: right;
            ">
            `;

            // ÿ±ÿ£ÿ≥ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
            html += `
            <div style="text-align: center; margin-bottom: 24px; direction: rtl;">
                <h1 style="margin: 0 0 8px 0; font-size: 2.5rem; font-weight: bold; color: #2d3748; letter-spacing: 2px;">${storeName}</h1>
                <div style="font-size: 1.2rem; color: #374151; margin-bottom: 4px;">${storeAddress}</div>
                <div style="font-size: 1.1rem; color: #6366f1;">üìû ${storePhone}</div>
                <div style="width:100%;text-align:center;margin:12px 0 0 0;">
                                <img src="${logoBase64}" alt="Logo" style="max-width:120px;max-height:120px;display:inline-block;vertical-align:middle;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:8px;" onerror="this.style.display='none'" />
                </div>
            </div>
            <div style="border-top: 2px solid #6366f1; margin: 24px 0 16px 0;"></div>
            `;

            // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© - ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
            html += `
            <div style="display: flex; justify-content: flex-start; gap: 48px; margin-bottom: 18px; font-size: 1.1rem; direction: rtl;">
                <div><b>ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:</b> ${toEnglishDigits(sale.invoice_id)}</div>
                <div><b>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:</b> ${dateStr}</div>
                <div><b>ÿßŸÑŸàŸÇÿ™:</b> ${timeStr}</div>
            </div>
            <div style="border-top: 1px dashed #bbb; margin: 18px 0 18px 0;"></div>
            `;

            // ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
            let items = sale.items;
            if (typeof items === 'string') {
            try {
                items = JSON.parse(items);
            } catch {
                items = [];
            }
            }
            if (items && items.length > 0) {
            html += `
                <table style="width: 100%; border-collapse: collapse; font-size: 1.1rem; margin: 18px 0; background: #f9fafb; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.03); direction: rtl;">
                <thead>
                    <tr style="background: #6366f1; color: #fff;">
                    <th style="padding: 12px 0;">#</th>
                    <th style="padding: 12px 0;">ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
                    <th style="padding: 12px 0;">ÿßŸÑŸÉŸÖŸäÿ©</th>
                    <th style="padding: 12px 0;">ÿ≥ÿπÿ± ÿßŸÑŸàÿ≠ÿØÿ©</th>
                    <th style="padding: 12px 0;">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</th>
                    </tr>
                </thead>
                <tbody>
            `;
            items.forEach((item, index) => {
                const name = item.product_name || item.name || '‚Äî';
                const price = item.product_price || item.price || 0;
                html += `
                <tr style="background: ${index % 2 === 0 ? '#fff' : '#f3f4f6'}; text-align: center; direction: rtl;">
                    <td style="padding: 10px 0;">${toEnglishDigits(index + 1)}</td>
                    <td style="padding: 10px 0; text-align: right;">${name}</td>
                    <td style="padding: 10px 0;">${toEnglishDigits(item.quantity)}</td>
                    <td style="padding: 10px 0;">${toEnglishDigits(price.toLocaleString('en'))}</td>
                    <td style="padding: 10px 0; font-weight: bold; color: #10b981;">${toEnglishDigits((price * item.quantity).toLocaleString('en'))}</td>
                </tr>
                `;
            });
            html += `</tbody></table>`;
            }

            html += `<div style="border-top: 2px solid #6366f1; margin: 24px 0 16px 0;"></div>`;

            // ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸÖÿπ ÿßŸÑÿÆÿµŸÖ ÿßŸÑÿ•ÿ∂ÿßŸÅŸä
            const additionalDiscount = sale.additional_discount || 0;
            const totalDiscount = (sale.discount || 0) + additionalDiscount;
            
            html += `
            <div style="font-size: 1.3rem; font-weight: bold; margin: 32px 0 12px 0; text-align: right; direction: rtl;">
                <div style="display: flex; justify-content: flex-start; gap: 48px; margin-bottom: 10px;">
                <div><span style="color:#374151;">ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿ¨ÿ≤ÿ¶Ÿä:</span> <span>${toEnglishDigits((sale.total_amount || 0).toLocaleString('en'))}</span></div>
                ${sale.discount ? `<div><span style="color:#374151;">ÿßŸÑÿÆÿµŸÖ:</span> <span style="color: #10b981;">- ${toEnglishDigits(sale.discount.toLocaleString('en'))}</span></div>` : ''}
                ${additionalDiscount > 0 ? `<div><span style="color:#374151;">ÿÆÿµŸÖ ÿ•ÿ∂ÿßŸÅŸä:</span> <span style="color: #10b981;">- ${toEnglishDigits(additionalDiscount.toLocaleString('en'))}</span></div>` : ''}
                </div>
                ${totalDiscount > 0 ? `<div style="display: flex; justify-content: flex-start; gap: 48px; margin-bottom: 10px; padding: 8px; background: #f0fdf4; border-radius: 6px;">
                    <div><span style="color:#15803d;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿÆÿµŸÖ:</span> <span style="color: #15803d; font-weight: bold;">- ${toEnglishDigits(totalDiscount.toLocaleString('en'))}</span></div>
                </div>` : ''}
                <div style="display: flex; justify-content: flex-start; gap: 48px; border-top: 2px solid #6366f1; padding-top: 12px; margin-top: 8px;">
                <div><span style="color:#2d3748;">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä:</span> <span style="color:#e11d48; font-size:1.5rem;">${toEnglishDigits((sale.final_total || sale.total_amount || 0).toLocaleString('en'))}</span></div>
                </div>
            </div>
            `;

            // ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™
            const notes = [
                'ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä<br>ŸáŸà ŸàÿµŸÑ ÿ£ŸÖÿßŸÜÿ© ÿπŸÑŸäŸÉŸÖ.',
                'ÿßŸÑÿ≥ÿπÿ± ŸÖÿ≠ŸÖŸä ŸÑŸÖÿØÿ© 24 ÿ≥ÿßÿπÿ© ŸÖŸÜ ŸàŸÇÿ™ ÿßŸÑÿ¥ÿ±ÿßÿ°.',
                'ÿßŸÑŸÖÿ®ÿßÿπ ŸÑÿß Ÿäÿ±ÿ¨ÿπ ŸàŸÑÿß Ÿäÿ®ÿØŸÑ.',
                'ÿßŸÑÿÆÿ∑ÿ£ ŸàÿßŸÑÿ≥ŸáŸà ŸÖÿ±ÿ¨Ÿàÿπ ŸÑŸÑÿ∑ÿ±ŸÅŸäŸÜ.',
                'ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿßŸÑŸÖÿµŸÜÿπÿ© ŸáŸä ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑÿ© ÿπŸÜ ÿßŸÑÿ∂ŸÖÿßŸÜ ŸàŸÑŸäÿ≥ ÿ¥ÿ±ŸÉÿ™ŸÜÿß.',
                'ŸÉÿ≥ÿ± ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿ£Ÿà ŸÉÿ≥ÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ∫Ÿäÿ± ÿØÿßÿÆŸÑ ÿ®ÿßŸÑÿ∂ŸÖÿßŸÜ.',
                'ŸÖÿ≥ÿ§ŸàŸÑ ÿµŸäÿßŸÜÿ© Ÿàÿ™ŸÜÿµŸäÿ® ÿßŸÑÿ≥ÿ®ÿßŸÑÿ™: ÿ≠ŸÖÿ≤Ÿá ÿ£ÿ®Ÿà ÿ≠Ÿàÿ±ÿßÿ° - Ÿáÿßÿ™ŸÅ: <span dir="ltr" style="unicode-bidi: embed;">+964 785 570 6118</span> <img src="https://upload.wikimedia.org/wikipedia/commons/2/2f/Flag_of_Iraq.svg" alt="Iraq Flag" style="height: 1em; vertical-align: middle; margin-right: 4px;" />'
            ];
            html += `
            <div style="margin-top:28px; padding:16px 12px; background:#fffbe7; border-radius:8px; border:1px solid #ffe082;">
                <div style="font-size:1.05rem; font-weight:bold; color:#c62828; margin-bottom:6px; text-align:right; direction:rtl;">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ŸáÿßŸÖÿ©:</div>
                <ol style="font-size:1rem; padding-right:22px; margin:0; text-align:right; direction:rtl;">
                ${notes.map(n => `<li>${toEnglishDigits(n)}</li>`).join('')}
                </ol>
            </div>
            `;

            // ÿßŸÑÿ™ÿ∞ŸäŸäŸÑ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
            html += `<div style="text-align: center; margin-top: 40px; font-size: 1.1rem; color: #666; direction: rtl;">
            <p style="margin: 4px 0;">ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ™ÿπÿßŸÖŸÑŸÉŸÖ ŸÖÿπ ŸÖÿπÿ±ÿ∂ ŸäÿπŸÇŸàÿ® ŸÑŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ©</p>
            <p style="margin: 4px 0;">ŸÜÿ™ÿ∑ŸÑÿπ ŸÑÿÆÿØŸÖÿ™ŸÉŸÖ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ</p>
            <p style="margin-top: 18px; color: #6366f1; font-size: 1.2rem;">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</p>
            </div>`;
            html += `</div>`;
            return html;
        }

        // ==========================================
        // ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ∑ÿßÿ®ÿπÿ© ÿßŸÑŸÖÿ≠ÿØÿ´ÿ©
        // ==========================================

        // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ÿßÿ®ÿπÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÑÿ©
        async function refreshPrintersList() {
            const container = document.getElementById('connectedPrintersList');
            if (!container) return;
            
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ∑ÿßÿ®ÿπÿßÿ™...</p>
                </div>
            `;
            
            try {
                // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ÿßÿ®ÿπÿßÿ™ ŸÖŸÜ ÿßŸÑŸÜÿ∏ÿßŸÖ
                let printers = [];
                
                if (window.electronAPI && window.electronAPI.getPrinters) {
                    printers = await window.electronAPI.getPrinters();
                } else {
                    // ŸÖÿ≠ÿßŸÉÿßÿ© ŸÇÿßÿ¶ŸÖÿ© ÿ∑ÿßÿ®ÿπÿßÿ™ ŸÑŸÑÿ™ÿ¨ÿ±ÿ®ÿ© (ŸÑŸÑŸÖÿ™ÿµŸÅÿ≠)
                    printers = [
                        { name: 'ÿßŸÑÿ∑ÿßÿ®ÿπÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©', isDefault: true, status: 'ready' },
                        { name: 'Microsoft Print to PDF', isDefault: false, status: 'ready' }
                    ];
                }
                
                if (printers.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 1rem; color: #f59e0b;"></i>
                            <p>ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ∑ÿßÿ®ÿπÿßÿ™ ŸÖÿ™ÿµŸÑÿ©</p>
                        </div>
                    `;
                    return;
                }
                
                // ÿπÿ±ÿ∂ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ÿßÿ®ÿπÿßÿ™
                let html = '<div style="display: grid; gap: 1rem;">';
                
                printers.forEach((printer, index) => {
                    const isDefault = printer.isDefault;
                    const status = printer.status === 'ready' || printer.status === 'idle' ? 'ÿ¨ÿßŸáÿ≤ÿ©' : 'ÿ∫Ÿäÿ± ÿ¨ÿßŸáÿ≤ÿ©';
                    const statusColor = printer.status === 'ready' || printer.status === 'idle' ? '#10b981' : '#ef4444';
                    
                    html += `
                        <div style="
                            padding: 1rem;
                            background: var(--bg-secondary);
                            border-radius: 8px;
                            border: 2px solid ${isDefault ? '#6366f1' : 'var(--border-color)'};
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                        ">
                            <div style="
                                width: 40px;
                                height: 40px;
                                background: ${isDefault ? '#6366f1' : '#64748b'};
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                            ">
                                <i class="fas fa-print"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                    ${printer.name}
                                    ${isDefault ? '<span style="color: #6366f1; font-size: 0.75rem; margin-right: 0.5rem;">(ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©)</span>' : ''}
                                </div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                    ÿßŸÑÿ≠ÿßŸÑÿ©: <span style="color: ${statusColor};">${status}</span>
                                </div>
                            </div>
                            <button 
                                onclick="selectPrinter('${printer.name.replace(/'/g, "\\'")}')"
                                style="
                                    padding: 0.5rem 1rem;
                                    background: #6366f1;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 0.875rem;
                                "
                            >
                                ÿßÿÆÿ™Ÿäÿßÿ±
                            </button>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ÿßÿ®ÿπÿßÿ™ ŸÅŸä ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
                const select = document.getElementById('selectedPrinter');
                if (select) {
                    select.innerHTML = '<option value="">ÿßŸÑÿ∑ÿßÿ®ÿπÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©</option>';
                    printers.forEach(printer => {
                        const option = document.createElement('option');
                        option.value = printer.name;
                        option.textContent = printer.name + (printer.isDefault ? ' (ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©)' : '');
                        if (printer.isDefault) option.selected = true;
                        select.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ÿßÿ®ÿπÿßÿ™:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ∑ÿßÿ®ÿπÿßÿ™</p>
                    </div>
                `;
            }
        }

        // ÿßÿÆÿ™Ÿäÿßÿ± ÿ∑ÿßÿ®ÿπÿ©
        function selectPrinter(printerName) {
            const select = document.getElementById('selectedPrinter');
            if (select) {
                select.value = printerName;
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ•ŸäÿµÿßŸÑ
        function updateReceiptPreview() {
            const templateType = document.getElementById('receiptTemplate')?.value || 'cash';
            const printerType = document.getElementById('printerType')?.value || 'a4';
            
            // ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
            const settings = {
                templateType: templateType,
                printerType: printerType,
                storeTitleSize: parseInt(document.getElementById('storeTitleSize')?.value || 24),
                storeInfoSize: parseInt(document.getElementById('storeInfoSize')?.value || 14),
                invoiceTextSize: parseInt(document.getElementById('invoiceTextSize')?.value || 13),
                tableTextSize: parseInt(document.getElementById('tableTextSize')?.value || 12),
                totalTextSize: parseInt(document.getElementById('totalTextSize')?.value || 16),
                lineHeight: parseFloat(document.getElementById('lineHeight')?.value || 1.4),
                sidePadding: parseInt(document.getElementById('sidePadding')?.value || 15),
                showDateTime: document.getElementById('showDateTime')?.checked !== false,
                showInvoiceNumber: document.getElementById('showInvoiceNumber')?.checked !== false,
                customFooter: document.getElementById('customFooter')?.value || ''
            };
            
            // ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ© ŸÑŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
            const sampleInvoice = {
                invoice_id: 'INV-' + Math.floor(Math.random() * 10000),
                timestamp: new Date().toISOString(),
                customer_name: templateType === 'installment' ? 'ŸÖÿ≠ŸÖÿØ ÿ£ÿ≠ŸÖÿØ ÿπŸÑŸä' : 'ÿπŸÖŸäŸÑ ŸÜŸÇÿØŸä',
                customer_phone: templateType === 'installment' ? '07803092185' : '',
                customer_address: templateType === 'installment' ? 'ÿ®ÿ∫ÿØÿßÿØ - ÿßŸÑŸÖŸÜÿµŸàÿ±' : '',
                items: [
                    { product_name: 'ÿ´ŸÑÿßÿ¨ÿ© ÿ≥ÿßŸÖÿ≥ŸàŸÜÿ¨', quantity: 1, price: 800000, total: 800000 },
                    { product_name: 'ÿ∫ÿ≥ÿßŸÑÿ© LG', quantity: 1, price: 600000, total: 600000 }
                ],
                subtotal: 1400000,
                discount: 50000,
                tax: 0,
                final_total: 1350000,
                payment_method: templateType === 'installment' ? 'ÿ™ŸÇÿ≥Ÿäÿ∑' : 'ŸÜŸÇÿØŸä'
            };
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿ™ŸÇÿ≥Ÿäÿ∑ÿå ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
            if (templateType === 'installment') {
                sampleInvoice.installment_months = 12;
                sampleInvoice.down_payment = 350000;
                sampleInvoice.monthly_amount = 83334;
                sampleInvoice.remaining_amount = 1000000;
                sampleInvoice.installments = [];
                
                // ÿ™ŸàŸÑŸäÿØ ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
                for (let i = 1; i <= 12; i++) {
                    const dueDate = new Date();
                    dueDate.setMonth(dueDate.getMonth() + i);
                    sampleInvoice.installments.push({
                        month: i,
                        due_date: dueDate.toISOString().split('T')[0],
                        amount: 83334,
                        status: i <= 3 ? 'paid' : 'pending'
                    });
                }
            }
            
            // ÿ™ŸàŸÑŸäÿØ HTML ÿßŸÑÿ•ŸäÿµÿßŸÑ
            let receiptHTML;
            if (templateType === 'cash') {
                receiptHTML = generateCashReceiptPreview(sampleInvoice, settings);
            } else {
                receiptHTML = generateInstallmentReceiptPreview(sampleInvoice, settings);
            }
            
            // ÿπÿ±ÿ∂ ÿßŸÑŸÖÿπÿßŸäŸÜÿ©
            const preview = document.getElementById('receiptPreview');
            if (preview) {
                preview.innerHTML = receiptHTML;
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
            if (document.getElementById('activeTemplateType')) {
                document.getElementById('activeTemplateType').textContent = 
                    templateType === 'cash' ? 'ŸÜŸÇÿØŸä' : 'ÿ™ŸÇÿ≥Ÿäÿ∑';
            }
            if (document.getElementById('activePrinterType')) {
                const typeNames = {
                    'a4': 'A4',
                    'thermal-80': 'ÿ≠ÿ±ÿßÿ±Ÿä 80mm',
                    'thermal-58': 'ÿ≠ÿ±ÿßÿ±Ÿä 58mm'
                };
                document.getElementById('activePrinterType').textContent = typeNames[printerType] || 'A4';
            }
        }

        // ÿ™ŸàŸÑŸäÿØ HTML ŸÑŸÖÿπÿßŸäŸÜÿ© ÿ•ŸäÿµÿßŸÑ ŸÜŸÇÿØŸä
        function generateCashReceiptPreview(sale, settings) {
            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÇÿßŸÑÿ® ÿßŸÑÿ¨ÿØŸäÿØ
            if (typeof window.generateYaqoubCashReceipt === 'function') {
                return window.generateYaqoubCashReceipt(sale, settings);
            }
            
            // Fallback ŸÑŸÑŸÇÿßŸÑÿ® ÿßŸÑŸÇÿØŸäŸÖ
            const storeName = localStorage.getItem('storeName') || 'ŸÖÿ™ÿ¨ÿ± ŸäÿπŸÇŸàÿ® ÿ®ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ©';
            const storeAddress = localStorage.getItem('storeAddress') || 'ÿ®ÿßÿ® ÿßŸÑŸáÿßÿ¥ŸÖŸäÿ© ŸÇÿ±ÿ® ŸÖÿØÿ±ÿ≥ÿ© ÿßŸÑŸÉÿ±ÿßÿ±';
            const storePhone = localStorage.getItem('storePhone') || '07803092185';
            
            // ÿ™ÿ≠ÿØŸäÿØ ÿπÿ±ÿ∂ ÿßŸÑÿ•ŸäÿµÿßŸÑ
            let receiptWidth = '210mm'; // A4
            if (settings.printerType === 'thermal-80') {
                receiptWidth = '80mm';
            } else if (settings.printerType === 'thermal-58') {
                receiptWidth = '58mm';
            }
            
            // ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™ - ÿπÿ±ÿ®Ÿä ŸÖÿπ ÿ£ÿ±ŸÇÿßŸÖ ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©
            const saleDate = new Date(sale.timestamp);
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            const dateStrArabic = saleDate.toLocaleDateString('ar-IQ', dateOptions);
            const dateStr = toEnglishDigits(dateStrArabic);
            
            const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
            const timeStrArabic = saleDate.toLocaleTimeString('ar-IQ', timeOptions);
            const timeStr = toEnglishDigits(timeStrArabic);
            
            return `
                <div style="
                    width: ${receiptWidth};
                    padding: ${settings.sidePadding}px;
                    font-family: 'Cairo', 'Segoe UI', Arial, sans-serif;
                    line-height: ${settings.lineHeight};
                    font-size: ${settings.invoiceTextSize}px;
                    color: black;
                    background: white;
                ">
                    <!-- ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖÿ™ÿ¨ÿ± -->
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h2 style="margin: 0 0 8px 0; font-size: ${settings.storeTitleSize}px; font-weight: bold;">
                            ${storeName}
                        </h2>
                        <p style="margin: 4px 0; font-size: ${settings.storeInfoSize}px;">${storeAddress}</p>
                        <p style="margin: 4px 0; font-size: ${settings.storeInfoSize}px;">üìû ${storePhone}</p>
                    </div>
                    
                    <!-- ÿÆÿ∑ ŸÅÿßÿµŸÑ -->
                    <div style="border-top: 2px dashed #000; margin: 15px 0;"></div>
                    
                    <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© -->
                    <div style="margin: 10px 0; font-size: ${settings.invoiceTextSize}px;">
                        ${settings.showInvoiceNumber ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-weight: 600;">ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:</span>
                            <span style="font-weight: bold;">${sale.invoice_id}</span>
                        </div>` : ''}
                        ${settings.showDateTime ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:</span>
                            <span>${dateStr}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>ÿßŸÑŸàŸÇÿ™:</span>
                            <span>${timeStr}</span>
                        </div>` : ''}
                        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                            <span>ÿßŸÑÿπŸÖŸäŸÑ:</span>
                            <span style="font-weight: 600;">${sale.customer_name || 'ÿπŸÖŸäŸÑ ŸÜŸÇÿØŸä'}</span>
                        </div>
                    </div>
                    
                    <!-- ÿÆÿ∑ ŸÅÿßÿµŸÑ -->
                    <div style="border-top: 2px dashed #000; margin: 15px 0;"></div>
                    
                    <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ -->
                    <table style="width: 100%; border-collapse: collapse; font-size: ${settings.tableTextSize}px; margin: 10px 0;">
                        <thead>
                            <tr style="border-bottom: 1px solid #000;">
                                <th style="text-align: right; padding: 5px 0;">ÿßŸÑÿµŸÜŸÅ</th>
                                <th style="text-align: center; padding: 5px 5px;">ÿßŸÑŸÉŸÖŸäÿ©</th>
                                <th style="text-align: left; padding: 5px 0;">ÿßŸÑÿ≥ÿπÿ±</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Array.isArray(sale.items) ? sale.items.map(item => `
                                <tr>
                                    <td style="text-align: right; padding: 8px 0;">${item.product_name || item.name}</td>
                                    <td style="text-align: center; padding: 8px 5px;">${item.quantity}</td>
                                    <td style="text-align: left; padding: 8px 0;">${formatCurrency(item.total || (item.quantity * item.price))}</td>
                                </tr>
                            `).join('') : ''}
                        </tbody>
                    </table>
                    
                    <!-- ÿÆÿ∑ ŸÅÿßÿµŸÑ -->
                    <div style="border-top: 2px dashed #000; margin: 15px 0;"></div>
                    
                    <!-- ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿßÿ™ -->
                    <div style="font-size: ${settings.totalTextSize}px; margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÅÿ±ÿπŸä:</span>
                            <span>${formatCurrency(sale.subtotal || 0)}</span>
                        </div>
                        ${sale.discount > 0 ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; color: #10b981;">
                            <span>ÿßŸÑÿÆÿµŸÖ:</span>
                            <span>-${formatCurrency(sale.discount)}</span>
                        </div>` : ''}
                        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: ${settings.totalTextSize + 2}px; margin-top: 10px; padding-top: 10px; border-top: 2px solid #000;">
                            <span>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:</span>
                            <span>${formatCurrency(sale.final_total || 0)}</span>
                        </div>
                    </div>
                    
                    ${settings.customFooter ? `
                    <!-- ÿÆÿ∑ ŸÅÿßÿµŸÑ -->
                    <div style="border-top: 2px dashed #000; margin: 15px 0;"></div>
                    
                    <!-- ÿßŸÑÿ™ÿ∞ŸäŸäŸÑ -->
                    <div style="text-align: center; font-size: ${settings.storeInfoSize - 1}px; color: #666; margin-top: 15px;">
                        ${settings.customFooter}
                    </div>` : ''}
                </div>
            `;
        }

        // ÿ™ŸàŸÑŸäÿØ HTML ŸÑŸÖÿπÿßŸäŸÜÿ© ÿ•ŸäÿµÿßŸÑ ÿ™ŸÇÿ≥Ÿäÿ∑
        function generateInstallmentReceiptPreview(sale, settings) {
            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÇÿßŸÑÿ® ÿßŸÑÿ¨ÿØŸäÿØ
            if (typeof window.generateYaqoubInstallmentReceipt === 'function') {
                return window.generateYaqoubInstallmentReceipt(sale, settings);
            }
            
            // Fallback ŸÑŸÑŸÇÿßŸÑÿ® ÿßŸÑŸÇÿØŸäŸÖ
            const storeName = localStorage.getItem('storeName') || 'ŸÖÿ™ÿ¨ÿ± ŸäÿπŸÇŸàÿ® ÿ®ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ©';
            const storeAddress = localStorage.getItem('storeAddress') || 'ÿ®ÿßÿ® ÿßŸÑŸáÿßÿ¥ŸÖŸäÿ© ŸÇÿ±ÿ® ŸÖÿØÿ±ÿ≥ÿ© ÿßŸÑŸÉÿ±ÿßÿ±';
            const storePhone = localStorage.getItem('storePhone') || '07803092185';
            
            // ÿ™ÿ≠ÿØŸäÿØ ÿπÿ±ÿ∂ ÿßŸÑÿ•ŸäÿµÿßŸÑ
            let receiptWidth = '210mm'; // A4
            if (settings.printerType === 'thermal-80') {
                receiptWidth = '80mm';
            } else if (settings.printerType === 'thermal-58') {
                receiptWidth = '58mm';
            }
            
            // ÿßŸÑÿ™ÿßÿ±ŸäÿÆ - ÿπÿ±ÿ®Ÿä ŸÖÿπ ÿ£ÿ±ŸÇÿßŸÖ ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©
            const saleDate = new Date(sale.timestamp);
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            const dateStrArabic = saleDate.toLocaleDateString('ar-IQ', dateOptions);
            const dateStr = toEnglishDigits(dateStrArabic);
            
            return `
                <div style="
                    width: ${receiptWidth};
                    padding: ${settings.sidePadding}px;
                    font-family: 'Cairo', 'Segoe UI', Arial, sans-serif;
                    line-height: ${settings.lineHeight};
                    font-size: ${settings.invoiceTextSize}px;
                    color: black;
                    background: white;
                ">
                    <!-- ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖÿ™ÿ¨ÿ± -->
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h2 style="margin: 0 0 8px 0; font-size: ${settings.storeTitleSize}px; font-weight: bold;">
                            ${storeName}
                        </h2>
                        <p style="margin: 4px 0; font-size: ${settings.storeInfoSize}px;">${storeAddress}</p>
                        <p style="margin: 4px 0; font-size: ${settings.storeInfoSize}px;">üìû ${storePhone}</p>
                    </div>
                    
                    <!-- ÿÆÿ∑ ŸÅÿßÿµŸÑ -->
                    <div style="border-top: 2px dashed #000; margin: 15px 0;"></div>
                    
                    <!-- ŸÜŸàÿπ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© -->
                    <div style="text-align: center; background: #ffe4e6; padding: 8px; margin-bottom: 10px; border-radius: 4px;">
                        <strong style="color: #dc2626; font-size: ${settings.invoiceTextSize + 1}px;">ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ™ŸÇÿ≥Ÿäÿ∑</strong>
                    </div>
                    
                    <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸàÿßŸÑÿπŸÖŸäŸÑ -->
                    <div style="margin: 10px 0; font-size: ${settings.invoiceTextSize}px;">
                        ${settings.showInvoiceNumber ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-weight: 600;">ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:</span>
                            <span style="font-weight: bold;">${sale.invoice_id}</span>
                        </div>` : ''}
                        ${settings.showDateTime ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:</span>
                            <span>${dateStr}</span>
                        </div>` : ''}
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span>ÿßŸÑÿπŸÖŸäŸÑ:</span>
                            <span style="font-weight: 600;">${sale.customer_name}</span>
                        </div>
                        ${sale.customer_phone ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span>ÿßŸÑŸáÿßÿ™ŸÅ:</span>
                            <span>${sale.customer_phone}</span>
                        </div>` : ''}
                        ${sale.customer_address ? `
                        <div style="display: flex; justify-content: space-between;">
                            <span>ÿßŸÑÿπŸÜŸàÿßŸÜ:</span>
                            <span>${sale.customer_address}</span>
                        </div>` : ''}
                    </div>
                    
                    <!-- ÿÆÿ∑ ŸÅÿßÿµŸÑ -->
                    <div style="border-top: 2px dashed #000; margin: 15px 0;"></div>
                    
                    <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ -->
                    <table style="width: 100%; border-collapse: collapse; font-size: ${settings.tableTextSize}px; margin: 10px 0;">
                        <thead>
                            <tr style="border-bottom: 1px solid #000;">
                                <th style="text-align: right; padding: 5px 0;">ÿßŸÑÿµŸÜŸÅ</th>
                                <th style="text-align: center; padding: 5px 5px;">ÿßŸÑŸÉŸÖŸäÿ©</th>
                                <th style="text-align: left; padding: 5px 0;">ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Array.isArray(sale.items) ? sale.items.map(item => `
                                <tr>
                                    <td style="text-align: right; padding: 8px 0;">${item.product_name || item.name}</td>
                                    <td style="text-align: center; padding: 8px 5px;">${item.quantity}</td>
                                    <td style="text-align: left; padding: 8px 0;">${formatCurrency(item.total || (item.quantity * item.price))}</td>
                                </tr>
                            `).join('') : ''}
                        </tbody>
                    </table>
                    
                    <!-- ÿÆÿ∑ ŸÅÿßÿµŸÑ -->
                    <div style="border-top: 2px dashed #000; margin: 15px 0;"></div>
                    
                    <!-- ŸÖŸÑÿÆÿµ ÿßŸÑÿ™ŸÇÿ≥Ÿäÿ∑ -->
                    <div style="background: #f0f9ff; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: ${settings.invoiceTextSize}px;">
                        <div style="text-align: center; font-weight: bold; margin-bottom: 8px; color: #0284c7;">
                            ŸÖŸÑÿÆÿµ ÿßŸÑÿ™ŸÇÿ≥Ÿäÿ∑
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä:</span>
                            <span style="font-weight: bold;">${formatCurrency(remainingAmount)}</span>
                        </div>
                        ${sale.down_payment > 0 ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; color: #10b981;">
                            <span>ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑÿ£ŸàŸÑŸâ:</span>
                            <span style="font-weight: bold;">${formatCurrency(downPayment)}</span>
                        </div>` : ''}
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; padding-top: 5px; border-top: 1px dashed #0284c7;">
                            <span>ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä:</span>
                            <span style="font-weight: bold;">${formatCurrency(remainingAmount)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>ÿπÿØÿØ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑:</span>
                            <span style="font-weight: bold;">${installmentMonths} ÿ¥Ÿáÿ±</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px; margin-top: 8px;">
                            <span style="color: #0284c7; font-weight: bold;">ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä:</span>
                            <span style="font-weight: bold; color: #0284c7; font-size: ${settings.totalTextSize}px;">${formatCurrency(monthlyAmount)}</span>
                        </div>
                    </div>
                    
                    <!-- ÿÆÿ∑ ŸÅÿßÿµŸÑ -->
                    <div style="border-top: 2px dashed #000; margin: 15px 0;"></div>
                    
                    <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ -->
                    <div style="margin: 15px 0;">
                        <div style="text-align: center; font-weight: bold; margin-bottom: 10px; font-size: ${settings.invoiceTextSize + 1}px;">
                            ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: ${settings.tableTextSize - 1}px;">
                            <thead>
                                <tr style="background: #f3f4f6; border-bottom: 1px solid #000;">
                                    <th style="padding: 6px 4px; text-align: center;">ÿßŸÑÿ¥Ÿáÿ±</th>
                                    <th style="padding: 6px 4px; text-align: center;">ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ</th>
                                    <th style="padding: 6px 4px; text-align: center;">ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
                                    <th style="padding: 6px 4px; text-align: center;">ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Array.isArray(sale.installments) ? sale.installments.slice(0, 6).map(inst => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 6px 4px; text-align: center;">${inst.month}</td>
                                        <td style="padding: 6px 4px; text-align: center;">${new Date(inst.due_date).toLocaleDateString('ar-IQ', {month: 'numeric', day: 'numeric'})}</td>
                                        <td style="padding: 6px 4px; text-align: center;">${formatCurrency(inst.amount)}</td>
                                        <td style="padding: 6px 4px; text-align: center;">
                                            <span style="color: ${inst.status === 'paid' ? '#10b981' : '#ef4444'}; font-weight: bold;">
                                                ${inst.status === 'paid' ? '‚úì' : '‚úó'}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('') : ''}
                                ${sale.installments && sale.installments.length > 6 ? `
                                    <tr>
                                        <td colspan="4" style="padding: 6px; text-align: center; color: #6b7280; font-style: italic;">
                                            ... Ÿàÿ®ÿßŸÇŸä ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
                                        </td>
                                    </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- ÿÆÿ∑ ŸÅÿßÿµŸÑ -->
                    <div style="border-top: 2px dashed #000; margin: 15px 0;"></div>
                    
                    <!-- ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ŸÖŸáŸÖÿ© -->
                    <div style="background: #fef3c7; padding: 10px; border-radius: 4px; font-size: ${settings.tableTextSize}px; margin-top: 10px;">
                        <div style="font-weight: bold; margin-bottom: 5px; color: #d97706;">‚ö†Ô∏è ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ŸÖŸáŸÖÿ©:</div>
                        <ul style="margin: 5px 0; padding-right: 20px;">
                            <li>Ÿäÿ¨ÿ® ÿ™ÿ≥ÿØŸäÿØ ÿßŸÑŸÇÿ≥ÿ∑ ŸÅŸä ŸÖŸàÿπÿØŸá ÿßŸÑŸÖÿ≠ÿØÿØ</li>
                            <li>ÿßŸÑÿ™ÿ£ÿÆŸäÿ± ŸÅŸä ÿßŸÑÿ≥ÿØÿßÿØ Ÿäÿ™ÿ±ÿ™ÿ® ÿπŸÑŸäŸá ÿ∫ÿ±ÿßŸÖÿ©</li>
                            <li>ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®Ÿáÿ∞Ÿá ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÑŸÑŸÖÿ±ÿßÿ¨ÿπÿ©</li>
                        </ul>
                    </div>
                    
                    ${settings.customFooter ? `
                    <!-- ÿÆÿ∑ ŸÅÿßÿµŸÑ -->
                    <div style="border-top: 2px dashed #000; margin: 15px 0;"></div>
                    
                    <!-- ÿßŸÑÿ™ÿ∞ŸäŸäŸÑ -->
                    <div style="text-align: center; font-size: ${settings.storeInfoSize - 1}px; color: #666; margin-top: 15px;">
                        ${settings.customFooter}
                    </div>` : ''}
                    
                    <!-- ÿ™ŸàŸÇŸäÿπ ÿßŸÑÿπŸÖŸäŸÑ -->
                    <div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #ccc;">
                        <div style="display: flex; justify-content: space-between; font-size: ${settings.tableTextSize}px;">
                            <div style="text-align: center;">
                                <div style="border-top: 1px solid #000; width: 150px; margin-bottom: 5px;"></div>
                                <div>ÿ™ŸàŸÇŸäÿπ ÿßŸÑÿπŸÖŸäŸÑ</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="border-top: 1px solid #000; width: 150px; margin-bottom: 5px;"></div>
                                <div>ÿ™ŸàŸÇŸäÿπ ÿßŸÑÿ®ÿßÿ¶ÿπ</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿßÿ®ÿπÿ©
        function savePrinterSettings() {
            const settings = {
                receiptTemplate: document.getElementById('receiptTemplate')?.value || 'cash',
                selectedPrinter: document.getElementById('selectedPrinter')?.value || '',
                printerType: document.getElementById('printerType')?.value || 'a4',
                storeTitleSize: parseInt(document.getElementById('storeTitleSize')?.value || 24),
                storeInfoSize: parseInt(document.getElementById('storeInfoSize')?.value || 14),
                invoiceTextSize: parseInt(document.getElementById('invoiceTextSize')?.value || 13),
                tableTextSize: parseInt(document.getElementById('tableTextSize')?.value || 12),
                totalTextSize: parseInt(document.getElementById('totalTextSize')?.value || 16),
                lineHeight: parseFloat(document.getElementById('lineHeight')?.value || 1.4),
                sidePadding: parseInt(document.getElementById('sidePadding')?.value || 15),
                showDateTime: document.getElementById('showDateTime')?.checked !== false,
                showInvoiceNumber: document.getElementById('showInvoiceNumber')?.checked !== false,
                customFooter: document.getElementById('customFooter')?.value || '',
                // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ±
                store_name: document.getElementById('storeName')?.value || 'ŸÖÿπÿ±ÿ∂ ŸäÿπŸÇŸàÿ® ŸÑŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ©',
                store_address: document.getElementById('storeAddress')?.value || 'ÿ®ÿßÿ® ÿßŸÑŸáÿßÿ¥ŸÖŸäÿ© ŸÇÿ±ÿ® ŸÖÿØÿ±ÿ≥ÿ© ÿßŸÑŸÉÿ±ÿßÿ±',
                store_phone: document.getElementById('storePhone')?.value || '07803092185',
                store_logo: document.getElementById('storeLogo')?.value || 'yaqoub_logo.png',
                show_logo: document.getElementById('showLogo')?.checked !== false,
                // ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™
                note1: document.getElementById('note1')?.value || '',
                note2: document.getElementById('note2')?.value || '',
                note3: document.getElementById('note3')?.value || '',
                note4: document.getElementById('note4')?.value || '',
                note5: document.getElementById('note5')?.value || '',
                note6: document.getElementById('note6')?.value || '',
                // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©
                maintenance_name: document.getElementById('maintenanceName')?.value || 'ÿ≠ŸÖÿ≤Ÿá ÿßÿ®Ÿà ÿ≠Ÿàÿ±ÿßÿ°',
                maintenance_service: document.getElementById('maintenanceService')?.value || 'ÿµŸäÿßŸÜÿ© ÿßŸÑÿ≥ÿ®ÿßŸÑÿ™',
                maintenance_phone: document.getElementById('maintenancePhone')?.value || '+964 785 570 6118',
                show_maintenance: document.getElementById('showMaintenance')?.checked !== false
            };
            
            localStorage.setItem('printerSettings', JSON.stringify(settings));
            // ÿ≠ŸÅÿ∏ ŸÅŸä localStorage ŸÑŸÑŸàÿµŸàŸÑ ÿßŸÑÿ≥ÿ±Ÿäÿπ
            localStorage.setItem('storeName', settings.store_name);
            localStorage.setItem('storeAddress', settings.store_address);
            localStorage.setItem('storePhone', settings.store_phone);
            
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            
            console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿßÿ®ÿπÿ©:', settings);
        }

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿßÿ®ÿπÿ©
        function loadPrinterSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('printerSettings') || '{}');
                
                if (document.getElementById('receiptTemplate')) document.getElementById('receiptTemplate').value = settings.receiptTemplate || 'cash';
                if (document.getElementById('selectedPrinter')) document.getElementById('selectedPrinter').value = settings.selectedPrinter || '';
                if (document.getElementById('printerType')) document.getElementById('printerType').value = settings.printerType || 'a4';
                if (document.getElementById('storeTitleSize')) document.getElementById('storeTitleSize').value = settings.storeTitleSize || 24;
                if (document.getElementById('storeInfoSize')) document.getElementById('storeInfoSize').value = settings.storeInfoSize || 14;
                if (document.getElementById('invoiceTextSize')) document.getElementById('invoiceTextSize').value = settings.invoiceTextSize || 13;
                if (document.getElementById('tableTextSize')) document.getElementById('tableTextSize').value = settings.tableTextSize || 12;
                if (document.getElementById('totalTextSize')) document.getElementById('totalTextSize').value = settings.totalTextSize || 16;
                if (document.getElementById('lineHeight')) document.getElementById('lineHeight').value = settings.lineHeight || 1.4;
                if (document.getElementById('sidePadding')) document.getElementById('sidePadding').value = settings.sidePadding || 15;
                if (document.getElementById('showDateTime')) document.getElementById('showDateTime').checked = settings.showDateTime !== false;
                if (document.getElementById('showInvoiceNumber')) document.getElementById('showInvoiceNumber').checked = settings.showInvoiceNumber !== false;
                if (document.getElementById('customFooter')) document.getElementById('customFooter').value = settings.customFooter || '';
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ±
                if (document.getElementById('storeName')) document.getElementById('storeName').value = settings.store_name || 'ŸÖÿπÿ±ÿ∂ ŸäÿπŸÇŸàÿ® ŸÑŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ©';
                if (document.getElementById('storeAddress')) document.getElementById('storeAddress').value = settings.store_address || 'ÿ®ÿßÿ® ÿßŸÑŸáÿßÿ¥ŸÖŸäÿ© ŸÇÿ±ÿ® ŸÖÿØÿ±ÿ≥ÿ© ÿßŸÑŸÉÿ±ÿßÿ±';
                if (document.getElementById('storePhone')) document.getElementById('storePhone').value = settings.store_phone || '07803092185';
                if (document.getElementById('storeLogo')) document.getElementById('storeLogo').value = settings.store_logo || 'yaqoub_logo.png';
                if (document.getElementById('showLogo')) document.getElementById('showLogo').checked = settings.show_logo !== false;
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™
                if (document.getElementById('note1')) document.getElementById('note1').value = settings.note1 || 'ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖŸàÿ¨ŸàÿØ ŸáŸà ŸàÿµŸÑ ÿ£ŸÖÿßŸÜÿ©';
                if (document.getElementById('note2')) document.getElementById('note2').value = settings.note2 || 'ÿßŸÑÿ≥ÿπÿ± ŸÖÿ≠ŸÖŸä 24 ÿ≥ÿßÿπÿ©';
                if (document.getElementById('note3')) document.getElementById('note3').value = settings.note3 || 'ÿßŸÑŸÖÿ®ÿßÿπ ŸÑÿß Ÿäÿ±ÿ¨ÿπ ŸàŸÑÿß Ÿäÿ®ÿØŸÑ';
                if (document.getElementById('note4')) document.getElementById('note4').value = settings.note4 || 'ÿßŸÑÿÆÿ∑ÿ£ ŸàÿßŸÑÿ≥ŸáŸà ŸÖÿ±ÿ¨Ÿàÿπ ŸÑŸÑÿ∑ÿ±ŸÅŸäŸÜ';
                if (document.getElementById('note5')) document.getElementById('note5').value = settings.note5 || 'ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿßŸÑŸÖÿµŸÜÿπÿ© ŸÖÿ≥ÿ§ŸàŸÑÿ© ÿπŸÜ ÿßŸÑÿ∂ŸÖÿßŸÜ';
                if (document.getElementById('note6')) document.getElementById('note6').value = settings.note6 || 'ŸÉÿ≥ÿ± ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿ∫Ÿäÿ± ÿØÿßÿÆŸÑ ÿ®ÿßŸÑÿ∂ŸÖÿßŸÜ';
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©
                if (document.getElementById('maintenanceName')) document.getElementById('maintenanceName').value = settings.maintenance_name || 'ÿ≠ŸÖÿ≤Ÿá ÿßÿ®Ÿà ÿ≠Ÿàÿ±ÿßÿ°';
                if (document.getElementById('maintenanceService')) document.getElementById('maintenanceService').value = settings.maintenance_service || 'ÿµŸäÿßŸÜÿ© ÿßŸÑÿ≥ÿ®ÿßŸÑÿ™';
                if (document.getElementById('maintenancePhone')) document.getElementById('maintenancePhone').value = settings.maintenance_phone || '+964 785 570 6118';
                if (document.getElementById('showMaintenance')) document.getElementById('showMaintenance').checked = settings.show_maintenance !== false;
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇŸäŸÖ ÿßŸÑŸÖÿπÿ±Ÿàÿ∂ÿ©
                if (document.getElementById('storeTitleSizeValue')) document.getElementById('storeTitleSizeValue').textContent = settings.storeTitleSize || 24;
                if (document.getElementById('storeInfoSizeValue')) document.getElementById('storeInfoSizeValue').textContent = settings.storeInfoSize || 14;
                if (document.getElementById('invoiceTextSizeValue')) document.getElementById('invoiceTextSizeValue').textContent = settings.invoiceTextSize || 13;
                if (document.getElementById('tableTextSizeValue')) document.getElementById('tableTextSizeValue').textContent = settings.tableTextSize || 12;
                if (document.getElementById('totalTextSizeValue')) document.getElementById('totalTextSizeValue').textContent = settings.totalTextSize || 16;
                if (document.getElementById('lineHeightValue')) document.getElementById('lineHeightValue').textContent = settings.lineHeight || 1.4;
                if (document.getElementById('sidePaddingValue')) document.getElementById('sidePaddingValue').textContent = settings.sidePadding || 15;
                
                console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿßÿ®ÿπÿ©');
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿßÿ®ÿπÿ©:', error);
            }
        }

        // ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
        function resetPrinterSettings() {
            if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©ÿü')) {
                const defaultSettings = {
                    receiptTemplate: 'cash',
                    selectedPrinter: '',
                    printerType: 'a4',
                    storeTitleSize: 24,
                    storeInfoSize: 14,
                    invoiceTextSize: 13,
                    tableTextSize: 12,
                    totalTextSize: 16,
                    lineHeight: 1.4,
                    sidePadding: 15,
                    showDateTime: true,
                    showInvoiceNumber: true,
                    customFooter: ''
                };
                
                localStorage.setItem('printerSettings', JSON.stringify(defaultSettings));
                loadPrinterSettings();
                updateReceiptPreview();
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        // ÿ∑ÿ®ÿßÿπÿ© ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©
        function testPrintReceipt() {
            const templateType = document.getElementById('receiptTemplate')?.value || 'cash';
            const settings = JSON.parse(localStorage.getItem('printerSettings') || '{}');
            
            // ÿ™ÿ≠ÿØŸäÿ´ settings ÿ®ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿ≠ÿßŸÑŸäÿ©
            settings.templateType = templateType;
            settings.printerType = document.getElementById('printerType')?.value || 'a4';
            settings.storeTitleSize = parseInt(document.getElementById('storeTitleSize')?.value || 24);
            settings.storeInfoSize = parseInt(document.getElementById('storeInfoSize')?.value || 14);
            settings.invoiceTextSize = parseInt(document.getElementById('invoiceTextSize')?.value || 13);
            settings.tableTextSize = parseInt(document.getElementById('tableTextSize')?.value || 12);
            settings.totalTextSize = parseInt(document.getElementById('totalTextSize')?.value || 16);
            settings.lineHeight = parseFloat(document.getElementById('lineHeight')?.value || 1.4);
            settings.sidePadding = parseInt(document.getElementById('sidePadding')?.value || 15);
            settings.showDateTime = document.getElementById('showDateTime')?.checked !== false;
            settings.showInvoiceNumber = document.getElementById('showInvoiceNumber')?.checked !== false;
            settings.customFooter = document.getElementById('customFooter')?.value || '';
            
            // ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©
            const testInvoice = {
                invoice_id: 'TEST-' + Date.now(),
                timestamp: new Date().toISOString(),
                customer_name: templateType === 'installment' ? 'ÿπŸÖŸäŸÑ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä' : 'ÿπŸÖŸäŸÑ ŸÜŸÇÿØŸä',
                customer_phone: templateType === 'installment' ? '07900000000' : '',
                customer_address: templateType === 'installment' ? 'ÿ®ÿ∫ÿØÿßÿØ' : '',
                items: [
                    { product_name: 'ŸÖŸÜÿ™ÿ¨ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä 1', quantity: 2, price: 50000, total: 100000 },
                    { product_name: 'ŸÖŸÜÿ™ÿ¨ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä 2', quantity: 1, price: 75000, total: 75000 }
                ],
                subtotal: 175000,
                discount: 5000,
                final_total: 170000,
                payment_method: templateType === 'installment' ? 'ÿ™ŸÇÿ≥Ÿäÿ∑' : 'ŸÜŸÇÿØŸä'
            };
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ŸÇÿ≥Ÿäÿ∑ ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ±
            if (templateType === 'installment') {
                testInvoice.installment_months = 6;
                testInvoice.down_payment = 50000;
                testInvoice.monthly_amount = 20000;
                testInvoice.remaining_amount = 120000;
                testInvoice.installments = [];
                
                for (let i = 1; i <= 6; i++) {
                    const dueDate = new Date();
                    dueDate.setMonth(dueDate.getMonth() + i);
                    testInvoice.installments.push({
                        month: i,
                        due_date: dueDate.toISOString().split('T')[0],
                        amount: 20000,
                        status: 'pending'
                    });
                }
            }
            
            // ÿ™ŸàŸÑŸäÿØ HTML ÿßŸÑÿ•ŸäÿµÿßŸÑ
            const receiptHTML = templateType === 'cash' 
                ? generateCashReceiptPreview(testInvoice, settings)
                : generateInstallmentReceiptPreview(testInvoice, settings);
            
            // ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ∑ÿ®ÿßÿπÿ©
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>ÿ∑ÿ®ÿßÿπÿ© ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Cairo', sans-serif; }
                        @media print {
                            body { margin: 0; }
                            @page { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${receiptHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            // ÿ∑ÿ®ÿßÿπÿ© ÿ®ÿπÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
            setTimeout(() => {
                printWindow.print();
            }, 500);
            
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }

        // ÿ™ŸáŸäÿ¶ÿ© ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ∑ÿßÿ®ÿπÿ© ÿπŸÜÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
        function initPrinterPage() {
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©
            loadPrinterSettings();
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ÿßÿ®ÿπÿßÿ™
            refreshPrintersList();
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿπÿßŸäŸÜÿ©
            updateReceiptPreview();
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
            const totalPrints = parseInt(localStorage.getItem('totalPrints') || '0');
            const todayPrints = parseInt(localStorage.getItem('todayPrints') || '0');
            
            if (document.getElementById('totalPrints')) {
                document.getElementById('totalPrints').textContent = totalPrints;
            }
            if (document.getElementById('todayPrints')) {
                document.getElementById('todayPrints').textContent = todayPrints;
            }
            
            console.log('‚úÖ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ∑ÿßÿ®ÿπÿ©');
        }

        // ==========================================
        // ŸÜŸáÿßŸäÿ© ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ∑ÿßÿ®ÿπÿ©
        // ==========================================

        // ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
        function confirmDeleteInvoice(invoiceId, customerName) {
            // ŸÅÿ≠ÿµ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©
            if (!window.securityManager.checkPermission('invoices_delete')) {
                return;
            }
            
            const confirmed = confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©ÿü\n\nÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©: ${invoiceId}\nÿßŸÑÿπŸÖŸäŸÑ: ${customerName}\n\n‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá!`);
            
            if (confirmed) {
                deleteInvoice(invoiceId);
            }
        }

        // ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
        async function deleteInvoice(invoiceId) {
            // ŸÅÿ≠ÿµ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ
            if (!window.securityManager.checkPermission('invoices_delete')) {
                return;
            }
            
            try {
                // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                const saleIndex = salesData.findIndex(s => s.invoice_id === invoiceId);
                
                if (saleIndex === -1) {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    return;
                }
                
                const sale = salesData[saleIndex];
                
                // ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ŸÉŸÖŸäÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
                let items = [];
                if (typeof sale.items === 'string') {
                    try {
                        items = JSON.parse(sale.items);
                    } catch (e) {
                        items = sale.items || [];
                    }
                } else {
                    items = sale.items || [];
                }
                
                // ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÉŸÖŸäÿßÿ™ ŸÑŸÑŸÖÿÆÿ≤ŸàŸÜ
                if (Array.isArray(items)) {
                    for (const item of items) {
                        const product = products.find(p => p.product_id === item.product_id);
                        if (product) {
                            product.stock_quantity = (product.stock_quantity || 0) + (item.quantity || 0);
                            
                            // ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                            if (window.dataSdk && (product.id || product.__backendId)) {
                                const updateId = product.id || product.__backendId;
                                await window.dataSdk.update(updateId, {
                                    stock_quantity: product.stock_quantity
                                });
                            }
                        }
                    }
                }
                
                // ÿ≠ÿ∞ŸÅ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                if (window.dataSdk && (sale.id || sale.__backendId)) {
                    const deleteId = sale.id || sale.__backendId;
                    await window.dataSdk.delete(deleteId);
                }
                
                // ÿ≠ÿ∞ŸÅ ŸÖŸÜ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
                salesData.splice(saleIndex, 1);
                
                // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ©
                window.securityManager.logOperation('ÿ≠ÿ∞ŸÅ ŸÅÿßÿ™Ÿàÿ±ÿ©', {
                    invoiceId: invoiceId,
                    customerName: sale.customer_name || 'ÿπŸÖŸäŸÑ ŸÜŸÇÿØŸä',
                    totalAmount: sale.final_total
                });
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
                renderInvoicesTable();
                updateStatistics();
                
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
        function updatePrintStats() {
            let totalPrints = parseInt(localStorage.getItem('totalPrints') || '0');
            totalPrints++;
            localStorage.setItem('totalPrints', totalPrints);
            
            const today = new Date().toDateString();
            const lastPrintDate = localStorage.getItem('lastPrintDate');
            let todayPrints = parseInt(localStorage.getItem('todayPrints') || '0');
            
            if (lastPrintDate !== today) {
                todayPrints = 1;
                localStorage.setItem('lastPrintDate', today);
            } else {
                todayPrints++;
            }
            localStorage.setItem('todayPrints', todayPrints);
            
            if (document.getElementById('totalPrints')) {
                document.getElementById('totalPrints').textContent = totalPrints;
            }
            if (document.getElementById('todayPrints')) {
                document.getElementById('todayPrints').textContent = todayPrints;
            }
        }

        function showDebtDetails(debtId) {
            console.log('=== Show Debt Details ===');
            console.log('Looking for debt ID:', debtId);
            console.log('Available debts:', debtsData);
            
            const debt = debtsData.find(d => 
                d.id == debtId || 
                d.__backendId == debtId || 
                d.debt_id == debtId
            );
            
            if (!debt) {
                console.log('‚ùå Debt not found!');
                console.log('Searched ID:', debtId);
                console.log('Available debt IDs:', debtsData.map(d => ({
                    id: d.id,
                    __backendId: d.__backendId,
                    debt_id: d.debt_id
                })));
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            console.log('‚úÖ Found debt:', debt);
            console.log('Debt properties:');
            console.log('  - total_amount:', debt.total_amount);
            console.log('  - final_total:', debt.final_total);
            console.log('  - remaining_amount:', debt.remaining_amount);
            console.log('  - paid_amount:', debt.paid_amount);
            console.log('  - monthly_amount:', debt.monthly_amount);
            console.log('  - installment_months:', debt.installment_months);
            console.log('  - installments:', debt.installments);
            console.log('  - invoice_id:', debt.invoice_id);
            
            // ÿ≠ŸÅÿ∏ ŸÖÿπÿ±ŸÅ ÿßŸÑÿØŸäŸÜ ÿßŸÑÿ≠ÿßŸÑŸä
            window.currentDebtId = debtId;
            window.currentDebt = debt;
            
            // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ÿ•ŸÑŸâ ÿµŸÅÿ≠ÿ© ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸäŸÜ
            navigateTo('debtDetailsPage');
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ©
            const relatedSale = salesData.find(s => s.invoice_id === debt.invoice_id);
            console.log('Related sale:', relatedSale);
            
            // ÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ
            renderDebtCustomerInfo(debt);
            
            // ÿπÿ±ÿ∂ ŸÖŸÑÿÆÿµ ÿßŸÑÿØŸäŸÜ
            renderDebtSummary(debt);
            
            // ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
            renderDebtInvoiceDetails(relatedSale);
            
            // ÿπÿ±ÿ∂ ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
            renderInstallmentsTable(debt, relatedSale);
            
            // ÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™
            renderPaymentsHistory(debt);
            
            console.log('======================');
        }
        
        // ÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ
        function renderDebtCustomerInfo(debt) {
            const container = document.getElementById('debtCustomerInfo');
            if (!container) return;
            
            // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑŸÖÿ≥ÿØÿØÿ© ŸàÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©
            let paidMonths = 0;
            let remainingMonths = 0;
            let isPaid = false;
            
            if (debt.installments && Array.isArray(debt.installments) && debt.installments.length > 0) {
                paidMonths = debt.installments.filter(inst => inst.status === 'paid').length;
                remainingMonths = debt.installments.length - paidMonths;
                isPaid = remainingMonths === 0;
            } else {
                // ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØ ÿ£ŸÇÿ≥ÿßÿ∑ÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑŸÇÿØŸäŸÖÿ©
                const remainingAmount = debt.remaining_amount !== undefined ? debt.remaining_amount : (debt.total_amount || debt.final_total || 0);
                isPaid = remainingAmount <= 0;
                remainingMonths = isPaid ? 0 : (debt.installment_months || 0);
            }
            
            const isOverdue = new Date(debt.due_date) < new Date() && !isPaid;
            
            console.log('Customer info - Paid months:', paidMonths, 'Remaining:', remainingMonths, 'isPaid:', isPaid);
            
            let statusColor = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            let statusText = `${paidMonths} ŸÖŸÜ ${debt.installment_months || 0} ÿ¥Ÿáÿ±`;
            let statusIcon = 'clock';
            
            if (isPaid) {
                statusColor = 'var(--success-gradient)';
                statusText = 'ŸÖÿ≥ÿØÿØ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ';
                statusIcon = 'check-double';
            } else if (isOverdue) {
                statusColor = 'var(--danger-gradient)';
                statusText = `ŸÖÿ™ÿ£ÿÆÿ± - ${paidMonths}/${debt.installment_months || 0} ÿ¥Ÿáÿ±`;
                statusIcon = 'exclamation-triangle';
            }
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-user"></i></div>
                    <div class="stat-label">ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ</div>
                    <div class="stat-value" style="font-size: 1.5rem;">${debt.customer_name}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-phone"></i></div>
                    <div class="stat-label">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</div>
                    <div class="stat-value" style="font-size: 1.5rem;">${debt.customer_phone}</div>
                </div>
                <div class="stat-card" style="background: ${statusColor}; color: white;">
                    <div class="stat-icon"><i class="fas fa-${statusIcon}"></i></div>
                    <div class="stat-label">ÿßŸÑÿ≠ÿßŸÑÿ©</div>
                    <div class="stat-value">${statusText}</div>
                </div>
            `;
        }
        
        // ÿπÿ±ÿ∂ ŸÖŸÑÿÆÿµ ÿßŸÑÿØŸäŸÜ
        function renderDebtSummary(debt) {
            const container = document.getElementById('debtSummaryCard');
            if (!container) {
                console.error('‚ùå debtSummaryCard container not found!');
                return;
            }
            
            console.log('=== Rendering Debt Summary ===');
            console.log('Raw debt object:', JSON.stringify(debt, null, 2));
            console.log('Debt.total_amount:', debt.total_amount, typeof debt.total_amount);
            console.log('Debt.final_total:', debt.final_total, typeof debt.final_total);
            console.log('Debt.remaining_amount:', debt.remaining_amount, typeof debt.remaining_amount);
            console.log('Debt.paid_amount:', debt.paid_amount, typeof debt.paid_amount);
            console.log('Debt.installments:', debt.installments);
            console.log('Debt.invoice_id:', debt.invoice_id);
            console.log('Debt.linked_invoices:', debt.linked_invoices);
            
            // üî• ÿ•ÿµŸÑÿßÿ≠ ÿ¨ÿØŸäÿØ: ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ©
            let totalAmount = 0;
            
            // ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© 1: ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ© (ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑÿ£ŸàŸÑŸâ)
            if (debt.linked_invoices && Array.isArray(debt.linked_invoices) && debt.linked_invoices.length > 0) {
                console.log('üîç ÿ≠ÿ≥ÿßÿ® ŸÖŸÜ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ©:', debt.linked_invoices);
                
                debt.linked_invoices.forEach(invoiceId => {
                    const relatedSale = salesData.find(s => s.invoice_id === invoiceId);
                    if (relatedSale && relatedSale.final_total) {
                        const invoiceTotal = parseFloat(relatedSale.final_total);
                        totalAmount += invoiceTotal;
                        console.log(`  ‚úì ŸÅÿßÿ™Ÿàÿ±ÿ© ${invoiceId}: ${invoiceTotal}`);
                    }
                });
                
                console.log('‚úì ÿ•ÿ¨ŸÖÿßŸÑŸä ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ©:', totalAmount);
            }
            // ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© 2: ŸÖŸÜ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ŸÅŸÇÿ∑
            else if (debt.invoice_id) {
                const relatedSale = salesData.find(s => s.invoice_id === debt.invoice_id);
                if (relatedSale && relatedSale.final_total) {
                    totalAmount = parseFloat(relatedSale.final_total);
                    console.log('‚úì Got total from main invoice:', totalAmount);
                }
            }
            
            // ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© 3: ŸÖŸÜ ÿ≠ŸÇŸÑ final_total ŸÅŸä ÿßŸÑÿØŸäŸÜ
            if (!totalAmount && debt.final_total !== undefined && debt.final_total !== null) {
                totalAmount = parseFloat(debt.final_total);
                console.log('‚úì Got total from debt.final_total:', totalAmount);
            }
            
            // ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© 4: ŸÖŸÜ ÿ≠ŸÇŸÑ total_amount ŸÅŸä ÿßŸÑÿØŸäŸÜ
            if (!totalAmount && debt.total_amount !== undefined && debt.total_amount !== null) {
                totalAmount = parseFloat(debt.total_amount);
                console.log('‚úì Got total from debt.total_amount:', totalAmount);
            }
            
            // ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© 5: ŸÖŸÜ ÿ≠ŸÇŸÑ remaining_amount (ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖÿØŸÅŸàÿπ ÿ¥Ÿäÿ°)
            if (!totalAmount && debt.remaining_amount !== undefined && debt.remaining_amount !== null) {
                totalAmount = parseFloat(debt.remaining_amount);
                console.log('‚úì Got total from debt.remaining_amount:', totalAmount);
            }
            
            // ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© 6: ÿ≠ÿ≥ÿßÿ® ŸÖŸÜ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
            if (!totalAmount && debt.installments && Array.isArray(debt.installments) && debt.installments.length > 0) {
                totalAmount = debt.installments.reduce((sum, inst) => sum + parseFloat(inst.amount || 0), 0);
                console.log('‚úì Calculated total from installments:', totalAmount);
            }
            
            // ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© 7: ŸÖŸÜ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä √ó ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ±
            if (!totalAmount && debt.monthly_amount && debt.installment_months) {
                totalAmount = parseFloat(debt.monthly_amount) * parseInt(debt.installment_months);
                console.log('‚úì Calculated total from monthly √ó months:', totalAmount);
            }
            
            console.log('Final totalAmount:', totalAmount);
            
            // üî• ÿ•ÿµŸÑÿßÿ≠: ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ ŸÖŸÜ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ (ŸÉÿßŸÖŸÑÿ© Ÿàÿ¨ÿ≤ÿ¶Ÿäÿ©)
            let paidAmount = 0;
            let paidMonths = 0;
            let partiallyPaidMonths = 0;
            
            console.log('=== Calculating Paid Amount (FIXED) ===');
            console.log('Installments array:', debt.installments);
            console.log('Is array?', Array.isArray(debt.installments));
            console.log('Length:', debt.installments?.length);
            
            if (debt.installments && Array.isArray(debt.installments) && debt.installments.length > 0) {
                console.log('Calculating from installments:');
                debt.installments.forEach((inst, index) => {
                    console.log(`  Installment ${index + 1}:`, JSON.stringify(inst, null, 2));
                    console.log(`    Status: "${inst.status}" (type: ${typeof inst.status})`);
                    console.log(`    Paid amount: ${inst.paid_amount} (type: ${typeof inst.paid_amount})`);
                    console.log(`    Amount: ${inst.amount} (type: ${typeof inst.amount})`);
                    
                    if (inst.status === 'paid') {
                        // ŸÇÿ≥ÿ∑ ŸÖÿ≥ÿØÿØ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ
                        const instAmount = parseFloat(inst.paid_amount || inst.amount || 0);
                        console.log(`    ‚úì FULLY PAID - Adding amount: ${instAmount}`);
                        paidAmount += instAmount;
                        paidMonths++;
                    } else if (inst.status === 'partially_paid') {
                        // ŸÇÿ≥ÿ∑ ŸÖÿ≥ÿØÿØ ÿ¨ÿ≤ÿ¶ŸäÿßŸã - ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ ŸÅŸÇÿ∑
                        const instPaidAmount = parseFloat(inst.paid_amount || 0);
                        console.log(`    ‚ö†Ô∏è PARTIALLY PAID - Adding paid amount: ${instPaidAmount}`);
                        paidAmount += instPaidAmount;
                        partiallyPaidMonths++;
                    } else {
                        console.log(`    ‚úó NOT PAID - Status is "${inst.status}"`);
                    }
                });
            } else if (debt.paid_amount !== undefined && debt.paid_amount !== null) {
                paidAmount = parseFloat(debt.paid_amount) || 0;
                console.log('Using debt.paid_amount:', paidAmount);
            } else {
                console.log('‚ö†Ô∏è No installments found and no paid_amount field!');
            }
            
            console.log('=== Paid Amount Calculation Complete (FIXED) ===');
            console.log('Total Paid Amount:', paidAmount);
            console.log('Fully Paid Months:', paidMonths);
            console.log('Partially Paid Months:', partiallyPaidMonths);
            
            console.log('Final calculations:');
            console.log('  Total Amount:', totalAmount);
            console.log('  Paid Amount:', paidAmount);
            console.log('  Paid Months:', paidMonths);
            
            // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ
            totalAmount = Math.round(parseFloat(totalAmount) || 0);
            paidAmount = Math.round(parseFloat(paidAmount) || 0);
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä
            let remainingAmount = totalAmount - paidAmount;
            
            // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ŸÑÿß ŸäŸÉŸàŸÜ ÿ≥ÿßŸÑÿ®
            if (remainingAmount < 0) remainingAmount = 0;
            remainingAmount = Math.round(remainingAmount);
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ¶ŸàŸäÿ© ŸÖÿπ ÿ≠ŸÖÿßŸäÿ© ŸÖŸÜ ÿßŸÑŸÇÿ≥ŸÖÿ© ÿπŸÑŸâ ÿµŸÅÿ±
            let percentage = 0;
            if (totalAmount > 0 && !isNaN(totalAmount) && !isNaN(paidAmount)) {
                percentage = ((paidAmount / totalAmount) * 100).toFixed(1);
            }
            
            console.log('Summary Results:');
            console.log('  Total:', totalAmount);
            console.log('  Paid:', paidAmount);
            console.log('  Remaining:', remainingAmount);
            console.log('  Percentage:', percentage + '%');
            
            if (totalAmount === 0) {
                console.warn('‚ö†Ô∏è WARNING: Total amount is 0! This will cause display issues.');
                console.log('Debt object keys:', Object.keys(debt));
                console.log('All debt values:', debt);
            }
            
            console.log('==========================');
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div>
                        <div style="color: var(--theme-text-secondary); font-size: var(--font-size-base); margin-bottom: 5px;">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">${formatCurrency(totalAmount)}</div>
                    </div>
                    <div>
                        <div style="color: var(--theme-text-secondary); font-size: var(--font-size-base); margin-bottom: 5px;">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ</div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--success-color);">${formatCurrency(paidAmount)}</div>
                        ${partiallyPaidMonths > 0 ? `<div style="font-size: 0.85rem; color: var(--warning-color); margin-top: 5px;"><i class="fas fa-exclamation-circle"></i> (${partiallyPaidMonths} ŸÇÿ≥ÿ∑ ÿ¨ÿ≤ÿ¶Ÿä)</div>` : ''}
                    </div>
                    <div>
                        <div style="color: var(--theme-text-secondary); font-size: var(--font-size-base); margin-bottom: 5px;">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--danger-color);">${formatCurrency(remainingAmount)}</div>
                    </div>
                    <div>
                        <div style="color: var(--theme-text-secondary); font-size: var(--font-size-base); margin-bottom: 5px;">ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ≥ÿØÿßÿØ</div>
                        <div style="font-size: 24px; font-weight: bold;">${percentage}%</div>
                        <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 10px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: var(--success-gradient); transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
        function renderDebtInvoiceDetails(relatedSale) {
            const container = document.getElementById('debtInvoiceDetails');
            if (!container) return;
            
            const debt = window.currentDebt;
            
            // ÿ¨ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ©
            const invoiceIds = debt.linked_invoices || [debt.invoice_id];
            console.log('üìã ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ©:', invoiceIds);
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
            const allInvoices = invoiceIds.map(invoiceId => {
                const sale = salesData.find(s => s.invoice_id === invoiceId);
                return sale;
            }).filter(sale => sale); // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÇŸäŸÖ ÿßŸÑŸÅÿßÿ±ÿ∫ÿ©
            
            console.log('‚úÖ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑÿ™Ÿä ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸäŸáÿß:', allInvoices.length);
            
            // üî• ÿ•ÿµŸÑÿßÿ≠ ÿ¨ÿØŸäÿØ: ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØ ŸÅŸàÿßÿ™Ÿäÿ±ÿå ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖŸÜ ŸÉÿßÿ¶ŸÜ ÿßŸÑÿØŸäŸÜ ŸÜŸÅÿ≥Ÿá
            if (allInvoices.length === 0) {
                console.log('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÅŸàÿßÿ™Ÿäÿ± ŸÖÿ±ÿ™ÿ®ÿ∑ÿ©ÿå ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖŸÜ ÿßŸÑÿØŸäŸÜ ŸÖÿ®ÿßÿ¥ÿ±ÿ©');
                
                // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖŸÜ ÿßŸÑÿØŸäŸÜ
                let debtProducts = [];
                if (debt.products && Array.isArray(debt.products)) {
                    debtProducts = debt.products;
                } else if (debt.items) {
                    try {
                        debtProducts = typeof debt.items === 'string' ? JSON.parse(debt.items) : debt.items;
                    } catch (e) {
                        console.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™:', e);
                    }
                }
                
                console.log('üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖŸÜ ÿßŸÑÿØŸäŸÜ:', debtProducts);
                
                if (debtProducts.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--theme-text-secondary); padding: 20px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÅŸàÿßÿ™Ÿäÿ± ÿ£Ÿà ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖÿ±ÿ™ÿ®ÿ∑ÿ©</p>';
                    return;
                }
                
                // ÿ•ŸÜÿ¥ÿßÿ° HTML ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
                const itemsHTML = debtProducts.map(item => {
                    const price = item.product_price || item.price || 0;
                    const quantity = item.quantity || 1;
                    const total = quantity * price;
                    return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-box"></i>
                                ${item.product_name || item.name || 'ŸÖŸÜÿ™ÿ¨'}
                            </div>
                        </td>
                        <td style="text-align: center;">${quantity}</td>
                        <td>${formatCurrency(price)}</td>
                        <td style="font-weight: bold; color: var(--primary-color);">${formatCurrency(total)}</td>
                    </tr>
                    `;
                }).join('');
                
                // ÿπÿ±ÿ∂ ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿØŸäŸÜ ÿßŸÑŸäÿØŸàŸä
                container.innerHTML = `
                    <div class="invoice-card" style="background: var(--theme-bg-secondary); padding: 20px; border-radius: 12px; border: 2px solid var(--primary-color);">
                        <!-- ÿ¥ÿßÿ±ÿ© ÿØŸäŸÜ ŸäÿØŸàŸä -->
                        <div style="display: inline-block; background: var(--primary-color); color: white; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-bottom: 15px;">
                            <i class="fas fa-hand-holding-usd"></i>
                            ÿØŸäŸÜ ŸäÿØŸàŸä
                        </div>
                        
                        <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿØŸäŸÜ -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div>
                                <div style="color: var(--theme-text-secondary); font-size: var(--font-size-sm);">
                                    <i class="fas fa-hashtag"></i> ÿ±ŸÇŸÖ ÿßŸÑŸÖÿ±ÿ¨ÿπ
                                </div>
                                <div style="font-size: var(--font-size-lg); font-weight: bold; margin-top: 5px; color: var(--primary-color);">
                                    ${debt.invoice_id || debt.id}
                                </div>
                            </div>
                            <div>
                                <div style="color: var(--theme-text-secondary); font-size: var(--font-size-sm);">
                                    <i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿØŸäŸÜ
                                </div>
                                <div style="font-size: var(--font-size-base); font-weight: 600; margin-top: 5px;">
                                    ${new Date(debt.date || debt.timestamp).toLocaleDateString('ar-IQ', {
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric'
                                    })}
                                </div>
                            </div>
                            <div>
                                <div style="color: var(--theme-text-secondary); font-size: var(--font-size-sm);">
                                    <i class="fas fa-credit-card"></i> ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ
                                </div>
                                <div style="font-size: var(--font-size-base); font-weight: 500; margin-top: 5px;">
                                    <i class="fas fa-calendar-alt"></i> ÿ£ŸÇÿ≥ÿßÿ∑
                                </div>
                            </div>
                        </div>
                        
                        <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ -->
                        <div class="table-container" style="margin-top: 15px;">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
                                        <th style="text-align: center;">ÿßŸÑŸÉŸÖŸäÿ©</th>
                                        <th>ÿßŸÑÿ≥ÿπÿ±</th>
                                        <th>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHTML}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- ŸÖŸÑÿÆÿµ ÿßŸÑÿØŸäŸÜ -->
                        <div style="margin-top: 15px; padding: 15px; background: var(--theme-bg-card); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--theme-text-secondary);">ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÅÿ±ÿπŸä:</span>
                                <span style="font-weight: 600;">${formatCurrency(debt.subtotal || 0)}</span>
                            </div>
                            ${debt.additional_amount ? `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--warning-color);">
                                <span>ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ∂ÿßŸÅŸä:</span>
                                <span style="font-weight: 600;">+${formatCurrency(debt.additional_amount)}</span>
                            </div>
                            ` : ''}
                            ${debt.down_payment ? `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--success-color);">
                                <span>ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©:</span>
                                <span style="font-weight: 600;">-${formatCurrency(debt.down_payment)}</span>
                            </div>
                            ` : ''}
                            ${debt.installment_months ? `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--theme-text-secondary);">ÿπÿØÿØ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑:</span>
                                <span style="font-weight: 600;">${debt.installment_months} ÿ¥Ÿáÿ±</span>
                            </div>
                            ` : ''}
                            ${debt.monthly_amount ? `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--theme-text-secondary);">ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä:</span>
                                <span style="font-weight: 600;">${formatCurrency(debt.monthly_amount)}</span>
                            </div>
                            ` : ''}
                            ${debt.start_date ? `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--theme-text-secondary);">ÿ™ÿßÿ±ŸäÿÆ ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑:</span>
                                <span style="font-weight: 600;">${new Date(debt.start_date).toLocaleDateString('en-GB')}</span>
                            </div>
                            ` : ''}
                            ${debt.notes ? `
                            <div style="margin-top: 12px; padding: 10px; background: var(--theme-bg-secondary); border-radius: 6px;">
                                <div style="color: var(--theme-text-secondary); font-size: var(--font-size-sm); margin-bottom: 5px;">
                                    <i class="fas fa-sticky-note"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™:
                                </div>
                                <div style="font-size: var(--font-size-base);">
                                    ${debt.notes}
                                </div>
                            </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 2px solid var(--primary-color); font-size: var(--font-size-lg); font-weight: bold; color: var(--primary-color);">
                                <span>ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä:</span>
                                <span>${formatCurrency(debt.remaining_amount || debt.final_total || 0)}</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // ÿ®ŸÜÿßÿ° HTML ŸÑŸÉŸÑ ŸÅÿßÿ™Ÿàÿ±ÿ©
            const invoicesHTML = allInvoices.map((sale, index) => {
                // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ items ŸÖÿµŸÅŸàŸÅÿ©
                let items = [];
                if (sale.items && Array.isArray(sale.items)) {
                    items = sale.items;
                } else if (typeof sale.items === 'string') {
                    try {
                        items = JSON.parse(sale.items);
                    } catch (e) {
                        items = [];
                    }
                }
                
                const itemsHTML = items.length > 0 ? items.map(item => {
                    const price = item.product_price || item.price || 0;
                    const quantity = item.quantity || 1;
                    const total = quantity * price;
                    return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-box"></i>
                                ${item.product_name || item.name || 'ŸÖŸÜÿ™ÿ¨'}
                            </div>
                        </td>
                        <td style="text-align: center;">${quantity}</td>
                        <td>${formatCurrency(price)}</td>
                        <td style="font-weight: bold; color: var(--primary-color);">${formatCurrency(total)}</td>
                    </tr>
                    `;
                }).join('') : '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--theme-text-secondary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™</td></tr>';
                
                const isFirst = index === 0;
                const badgeColor = isFirst ? 'var(--primary-color)' : 'var(--warning-color)';
                const badgeText = isFirst ? 'ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ©' : `ŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖÿ∂ÿßŸÅÿ© #${index}`;
                
                return `
                <div class="invoice-card" style="background: var(--theme-bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid ${badgeColor};">
                    <!-- ÿ¥ÿßÿ±ÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© -->
                    <div style="display: inline-block; background: ${badgeColor}; color: white; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-bottom: 15px;">
                        <i class="fas ${isFirst ? 'fa-file-invoice' : 'fa-plus-circle'}"></i>
                        ${badgeText}
                    </div>
                    
                    <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div>
                            <div style="color: var(--theme-text-secondary); font-size: var(--font-size-sm);">
                                <i class="fas fa-hashtag"></i> ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                            </div>
                            <div style="font-size: var(--font-size-lg); font-weight: bold; margin-top: 5px; color: ${badgeColor};">
                                ${sale.invoice_id}
                            </div>
                        </div>
                        <div>
                            <div style="color: var(--theme-text-secondary); font-size: var(--font-size-sm);">
                                <i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                            </div>
                            <div style="font-size: var(--font-size-base); font-weight: 600; margin-top: 5px;">
                                ${new Date(sale.timestamp).toLocaleDateString('ar-IQ', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                })}
                            </div>
                            <div style="font-size: var(--font-size-sm); color: var(--theme-text-secondary);">
                                ${new Date(sale.timestamp).toLocaleTimeString('ar-IQ')}
                            </div>
                        </div>
                        <div>
                            <div style="color: var(--theme-text-secondary); font-size: var(--font-size-sm);">
                                <i class="fas fa-credit-card"></i> ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ
                            </div>
                            <div style="font-size: var(--font-size-base); font-weight: 500; margin-top: 5px;">
                                <i class="fas fa-calendar-alt"></i> ${sale.payment_type || 'ÿ£ŸÇÿ≥ÿßÿ∑'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ -->
                    <div class="table-container" style="margin-top: 15px;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
                                    <th style="text-align: center;">ÿßŸÑŸÉŸÖŸäÿ©</th>
                                    <th>ÿßŸÑÿ≥ÿπÿ±</th>
                                    <th>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHTML}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- ŸÖŸÑÿÆÿµ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© -->
                    <div style="margin-top: 15px; padding: 15px; background: var(--theme-bg-card); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--theme-text-secondary);">ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÅÿ±ÿπŸä:</span>
                            <span style="font-weight: 600;">${formatCurrency(sale.subtotal || 0)}</span>
                        </div>
                        ${(sale.discount_amount || sale.discount) ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--success-color);">
                            <span>ÿßŸÑÿÆÿµŸÖ:</span>
                            <span style="font-weight: 600;">-${formatCurrency(sale.discount_amount || sale.discount || 0)}</span>
                        </div>
                        ` : ''}
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--theme-text-secondary);">ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©:</span>
                            <span style="font-weight: 600;">${formatCurrency(sale.tax_amount || sale.tax || 0)}</span>
                        </div>
                        ${sale.additional_amount ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--warning-color);">
                            <span>ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ∂ÿßŸÅŸä:</span>
                            <span style="font-weight: 600;">+${formatCurrency(sale.additional_amount)}</span>
                        </div>
                        ` : ''}
                        ${sale.down_payment ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--success-color);">
                            <span>ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©:</span>
                            <span style="font-weight: 600;">${formatCurrency(sale.down_payment)}</span>
                        </div>
                        ` : ''}
                        ${sale.installment_months ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--theme-text-secondary);">ÿπÿØÿØ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑:</span>
                            <span style="font-weight: 600;">${sale.installment_months} ÿ¥Ÿáÿ±</span>
                        </div>
                        ` : ''}
                        ${sale.monthly_amount ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--theme-text-secondary);">ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä:</span>
                            <span style="font-weight: 600;">${formatCurrency(sale.monthly_amount)}</span>
                        </div>
                        ` : ''}
                        ${sale.start_date ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--theme-text-secondary);">ÿ™ÿßÿ±ŸäÿÆ ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑:</span>
                            <span style="font-weight: 600;">${new Date(sale.start_date).toLocaleDateString('en-GB')}</span>
                        </div>
                        ` : ''}
                        ${sale.installment_details?.advanced_control_used || sale.installment_details?.custom_values_used ? `
                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 12px; padding: 10px; background: rgba(139, 92, 246, 0.1); border-radius: 6px; border: 1px solid rgba(139, 92, 246, 0.3);">
                            <i class="fas fa-cog" style="color: #8b5cf6;"></i>
                            <span style="color: #8b5cf6; font-weight: 600; font-size: 0.9rem;">ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ ŸÅŸä ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</span>
                        </div>
                        ` : ''}
                        <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 2px solid ${badgeColor}; font-size: var(--font-size-lg); font-weight: bold; color: ${badgeColor};">
                            <span>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:</span>
                            <span>${formatCurrency(sale.final_total || 0)}</span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
            const grandTotal = allInvoices.reduce((sum, sale) => sum + (parseFloat(sale.final_total) || 0), 0);
            
            container.innerHTML = `
                <!-- ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÇÿ≥ŸÖ -->
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-file-invoice-dollar" style="color: var(--primary-color);"></i>
                        ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
                        <span style="background: var(--primary-color); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem;">
                            ${allInvoices.length} ${allInvoices.length === 1 ? 'ŸÅÿßÿ™Ÿàÿ±ÿ©' : 'ŸÅŸàÿßÿ™Ÿäÿ±'}
                        </span>
                    </h3>
                </div>
                
                <!-- ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± -->
                ${invoicesHTML}
                
                <!-- ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä (ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ÿ£ŸÉÿ´ÿ± ŸÖŸÜ ŸÅÿßÿ™Ÿàÿ±ÿ©) -->
                ${allInvoices.length > 1 ? `
                <div style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); padding: 20px; border-radius: 12px; color: white; margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: var(--font-size-sm); opacity: 0.9; margin-bottom: 5px;">
                                <i class="fas fa-calculator"></i> ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
                            </div>
                            <div style="font-size: var(--font-size-3xl); font-weight: bold;">
                                ${formatCurrency(grandTotal)}
                            </div>
                        </div>
                        <div style="font-size: 3rem; opacity: 0.3;">
                            <i class="fas fa-receipt"></i>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
        }
        
        // ÿπÿ±ÿ∂ ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
        function renderInstallmentsTable(debt, relatedSale) {
            const tbody = document.getElementById('installmentsTableBody');
            if (!tbody) {
                console.error('‚ùå installmentsTableBody not found!');
                return;
            }
            
            console.log('=== Rendering Installments Table ===');
            console.log('Debt:', debt);
            console.log('Related Sale:', relatedSale);
            
            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ±
            const months = parseInt(debt.installment_months || relatedSale?.installment_months || 12);
            console.log('Total months:', months);
            
            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä
            let monthlyAmount = parseFloat(debt.monthly_amount || relatedSale?.monthly_amount || 0);
            console.log('Monthly amount from debt:', monthlyAmount);
            
            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
            let totalAmount = parseFloat(debt.total_amount || debt.final_total || relatedSale?.final_total || debt.remaining_amount || 0);
            console.log('Total amount:', totalAmount);
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ monthlyAmount Ÿäÿ≥ÿßŸàŸä 0ÿå ÿßÿ≠ÿ≥ÿ®Ÿá ŸÖŸÜ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
            if (monthlyAmount === 0 && totalAmount > 0 && months > 0) {
                monthlyAmount = totalAmount / months;
                console.log('Calculated monthly amount:', monthlyAmount);
            }
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ totalAmount Ÿäÿ≥ÿßŸàŸä 0ÿå ÿßÿ≠ÿ≥ÿ®Ÿá ŸÖŸÜ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä
            if (totalAmount === 0 && monthlyAmount > 0 && months > 0) {
                totalAmount = monthlyAmount * months;
                console.log('Calculated total amount:', totalAmount);
            }
            
            console.log('Final values - Months:', months, 'Monthly:', monthlyAmount, 'Total:', totalAmount);
            
            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿ£Ÿà ÿ•ŸÜÿ¥ÿßÿ§Ÿáÿß
            let installments = [];
            
            if (debt.installments && Array.isArray(debt.installments) && debt.installments.length > 0) {
                installments = debt.installments;
                console.log('‚úì Using existing installments:', installments);
            } else {
                // ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
                console.log('Creating new installments array');
                const startDate = new Date(debt.timestamp || relatedSale?.timestamp || Date.now());
                
                for (let i = 0; i < months; i++) {
                    const dueDate = new Date(startDate);
                    dueDate.setMonth(dueDate.getMonth() + i + 1);
                    
                    installments.push({
                        month: i + 1,
                        due_date: dueDate.toISOString(),
                        amount: monthlyAmount,
                        status: 'pending',
                        paid_date: null,
                        paid_amount: 0
                    });
                }
                console.log('‚úì Created installments:', installments);
            }
            
            if (installments.length === 0) {
                console.warn('‚ö†Ô∏è No installments to display!');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--theme-text-secondary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ŸÇÿ≥ÿßÿ∑</td></tr>';
                return;
            }
            
            const now = new Date();
            tbody.innerHTML = installments.map(inst => buildInstallmentRowWithCarryforward(inst, debt)).join('');

            // ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÑÿÆÿµ ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿ•ÿ∞ÿß Ÿàÿ¨ÿØ
            const summaryContainer = document.getElementById('carryforwardSummaryContainer');
            if (summaryContainer) {
                const carryforwardSummary = createCarryforwardSummary(debt);
                summaryContainer.innerHTML = carryforwardSummary;
            }

            console.log('‚úÖ Installments table rendered successfully');
            console.log('=====================================');
        }
        
        // ÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™
        function renderPaymentsHistory(debt) {
            const tbody = document.getElementById('paymentsHistoryBody');
            if (!tbody) return;
            
            const payments = debt.payments || [];
            
            console.log('=== Rendering Payments History (FIXED) ===');
            console.log('Total payments:', payments.length);
            console.log('Payments:', payments);
            
            if (payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--theme-text-secondary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿ≥ÿØŸäÿØÿßÿ™ ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ</td></tr>';
                return;
            }
            
            // üî• ÿ•ÿµŸÑÿßÿ≠: ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ (ŸÉÿßŸÖŸÑÿ© Ÿàÿ¨ÿ≤ÿ¶Ÿäÿ©) ŸÖÿπ ÿ™ŸÅÿßÿµŸäŸÑ ÿ£ŸÉÿ´ÿ±
            tbody.innerHTML = payments.map((payment, index) => {
                const paymentDate = new Date(payment.date);
                const formattedDate = paymentDate.toLocaleString('ar-IQ', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // ÿ™ÿ≠ÿØŸäÿØ ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ÿØŸäÿØ
                const isPartial = payment.payment_type === 'partial';
                const paymentTypeIcon = isPartial ? '‚ö†Ô∏è' : '‚úÖ';
                const paymentTypeText = isPartial ? 'ÿ™ÿ≥ÿØŸäÿØ ÿ¨ÿ≤ÿ¶Ÿä' : 'ÿ™ÿ≥ÿØŸäÿØ ŸÉÿßŸÖŸÑ';
                const paymentTypeColor = isPartial ? 'var(--warning-color)' : 'var(--success-color)';
                
                // ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØ ÿßŸÑÿ¨ÿ≤ÿ¶Ÿä
                let detailsHtml = '';
                if (isPartial && payment.remaining_for_month > 0) {
                    detailsHtml = `
                        <div style="font-size: 0.85rem; color: var(--warning-color); margin-top: 5px;">
                            ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä: ${formatCurrency(payment.original_amount || 0)}<br>
                            ÿßŸÑŸÖÿ™ÿ®ŸÇŸä: ${formatCurrency(payment.remaining_for_month)}
                        </div>
                    `;
                }
                
                // üÜï ÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿ±ÿ≠ŸäŸÑ
                let carryforwardHtml = '';
                if (payment.carried_forward && payment.carried_forward_amount > 0) {
                    carryforwardHtml = `
                        <div style="font-size: 0.85rem; color: #f59e0b; margin-top: 8px; padding: 8px; background: rgba(251, 191, 36, 0.1); border-radius: 6px; border-right: 3px solid #f59e0b;">
                            <i class="fas fa-arrow-circle-left"></i> 
                            <strong>ÿ™ŸÖ ÿ™ÿ±ÿ≠ŸäŸÑ ${formatCurrency(payment.carried_forward_amount)}</strong>
                            <br>
                            <small>ÿ•ŸÑŸâ ÿßŸÑÿ¥Ÿáÿ± ${payment.carried_forward_to}</small>
                        </div>
                    `;
                }
                
                return `
                    <tr style="background: ${index % 2 === 0 ? 'var(--theme-bg)' : 'var(--theme-bg-secondary)'};">
                        <td style="padding: 15px;">
                            <i class="fas fa-calendar-alt" style="color: var(--primary-color); margin-left: 8px;"></i>
                            ${formattedDate}
                        </td>
                        <td style="font-weight: bold; color: var(--success-color); padding: 15px;">
                            <i class="fas fa-money-bill-wave" style="margin-left: 5px;"></i>
                            ${formatCurrency(payment.amount)}
                        </td>
                        <td style="padding: 15px;">
                            <strong style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.9rem;">
                                <i class="fas fa-calendar-check" style="margin-left: 5px;"></i>
                                ÿßŸÑÿ¥Ÿáÿ± ${payment.month}
                            </strong>
                        </td>
                        <td style="padding: 15px;">
                            <div style="display: flex; align-items: center; gap: 8px; color: ${paymentTypeColor}; font-weight: 600;">
                                <span style="font-size: 1.2rem;">${paymentTypeIcon}</span>
                                ${paymentTypeText}
                            </div>
                            ${detailsHtml}
                            ${carryforwardHtml}
                        </td>
                        <td style="padding: 15px; color: var(--theme-text-secondary);">
                            ${payment.notes || '-'}
                        </td>
                    </tr>
                `;
            }).join('');
            
            console.log('‚úÖ Rendered', payments.length, 'payment records');
        }

        // ================================================================
        // ÿØŸàÿßŸÑ ŸÖÿ≥ÿßÿπÿØÿ© ÿ¨ÿØŸäÿØÿ© ŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ±ÿ≠ŸäŸÑ
        // ================================================================

        /**
         * ÿ≠ÿ≥ÿßÿ® ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ŸÅŸä ÿØŸäŸÜ ŸÖÿπŸäŸÜ
         */
        function getTotalCarryforward(debt) {
            if (!debt.installments) return 0;
            return debt.installments.reduce((total, inst) => {
                return total + (inst.carryforward_amount || 0);
            }, 0);
        }

        /**
         * ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÇÿ≥ÿ∑ ŸÖÿπ ÿßŸÑÿ™ÿ±ÿ≠ŸäŸÑ
         */
        function getInstallmentWithCarryforward(installment) {
            const original = installment.original_amount || installment.amount;
            const carryforward = installment.carryforward_received || 0;
            return {
                original: original,
                carryforward: carryforward,
                total: original + carryforward,
                hasCarryforward: carryforward > 0
            };
        }

        /**
         * ÿ®ŸÜÿßÿ° HTML ŸÑÿµŸÅ ŸÇÿ≥ÿ∑ Ÿàÿßÿ≠ÿØ ŸÖÿπ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿ±ÿ≠ŸäŸÑ
         */
        function buildInstallmentRowWithCarryforward(inst, debt) {
            const dueDate = inst.due_date ? new Date(inst.due_date).toLocaleDateString('ar-IQ') : '-';
            const paidDate = inst.paid_date ? new Date(inst.paid_date).toLocaleDateString('ar-IQ') : '-';
            
            // üî• ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿ±ÿ≠ŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ©
            const hasCarryforward = (inst.carryforward_received || 0) > 0;
            let carryforwardInfo = '';
            
            if (hasCarryforward && inst.carryforward_from && Array.isArray(inst.carryforward_from)) {
                const carryforwardDetails = inst.carryforward_from.map(cf => 
                    `ÿßŸÑÿ¥Ÿáÿ± ${cf.from_month} (${cf.amount.toLocaleString('en')} ÿØ.ÿπ)`
                ).join(' + ');
                
                carryforwardInfo = `<div style="color: #f59e0b; font-size: 0.85em; margin-top: 4px; font-weight: 600;">
                     <i class="fas fa-arrow-circle-left"></i> 
                     ŸÖÿ±ÿ≠ŸÑ ŸÖŸÜ: ${carryforwardDetails}
                   </div>`;
            }
            
            // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä (ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ±ÿ≠ŸäŸÑ)
            const originalAmount = inst.original_amount || inst.amount;
            const currentAmount = parseFloat(inst.amount) || 0;
            const displayAmount = hasCarryforward 
                ? `<div>
                     <div style="font-weight: bold; color: var(--primary-color);">${currentAmount.toLocaleString('en')} ÿØ.ÿπ</div>
                     <div style="color: #6b7280; font-size: 0.85em;">
                       ÿßŸÑÿ£ÿµŸÑŸä: ${originalAmount.toLocaleString('en')} ÿØ.ÿπ
                     </div>
                   </div>`
                : `${currentAmount.toLocaleString('en')} ÿØ.ÿπ`;
            
            // ÿßŸÑÿ≠ÿßŸÑÿ© ŸÖÿπ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
            let statusHtml = '';
            if (inst.status === 'paid') {
                statusHtml = `<span class="installment-status paid">‚úì ŸÖÿ≥ÿØÿØ</span>`;
            } else if (inst.status === 'partially_paid') {
                const remaining = Math.round(currentAmount - (inst.paid_amount || 0));
                statusHtml = `<span class="installment-status partially_paid">‚ö†Ô∏è ÿØŸÅÿπ ÿ¨ÿ≤ÿ¶Ÿä</span>
                              <div style="font-size: 0.85em; color: #dc2626; margin-top: 4px; font-weight: 600;">
                                ŸÖÿ™ÿ®ŸÇŸä: ${remaining.toLocaleString('en')} ÿØ.ÿπ
                              </div>`;
            } else {
                const now = new Date();
                const due = new Date(inst.due_date);
                const isOverdue = due < now;
                statusHtml = isOverdue 
                    ? `<span class="installment-status overdue">‚è∞ ŸÖÿ™ÿ£ÿÆÿ±</span>` 
                    : `<span class="installment-status pending">‚è≥ ŸÖÿπŸÑŸÇ</span>`;
            }
            
            return `
                <tr style="${hasCarryforward ? 'background: rgba(251, 191, 36, 0.05);' : ''}">
                    <td><strong style="font-size: 1.1rem;">${inst.month}</strong></td>
                    <td>${displayAmount}${carryforwardInfo}</td>
                    <td>${dueDate}</td>
                    <td>${statusHtml}</td>
                    <td>${paidDate}</td>
                    <td>
                        ${inst.status === 'paid' 
                            ? `<button class="action-btn" style="background: var(--success-color); color: white; cursor: default;" disabled>
                                <i class="fas fa-check-circle"></i> ŸÖÿ≥ÿØÿØ
                               </button>`
                            : inst.status === 'partially_paid'
                            ? `<button class="action-btn" style="background: var(--warning-color);" onclick="payInstallment('${debt.id}', ${inst.month})" 
                                title="ÿ™ÿ≥ÿØŸäÿØ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä">
                                <i class="fas fa-money-bill-wave"></i> ÿ™ÿ≥ÿØŸäÿØ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä
                               </button>`
                            : `<button class="action-btn" onclick="payInstallment('${debt.id}', ${inst.month})" 
                                title="ÿ™ÿ≥ÿØŸäÿØ ÿßŸÑŸÇÿ≥ÿ∑">
                                <i class="fas fa-money-bill-wave"></i> ÿ™ÿ≥ÿØŸäÿØ
                               </button>`
                        }
                    </td>
                </tr>
            `;
        }

        /**
         * ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑÿÆÿµ ŸÑŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ŸÅŸä ÿßŸÑÿØŸäŸÜ
         */
        function createCarryforwardSummary(debt) {
            if (!debt.installments) return '';
            const totalCarryforward = getTotalCarryforward(debt);
            if (totalCarryforward === 0) return '';
            const carryforwardInstallments = debt.installments.filter(
                inst => (inst.carryforward_received || 0) > 0
            );
            if (carryforwardInstallments.length === 0) return '';
            let summaryHtml = `
                <div class="carryforward-info">
                    <div style="font-weight: bold; margin-bottom: 8px;">
                        <i class="fas fa-info-circle"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©
                    </div>
                    <div style="margin-bottom: 8px;">
                        ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©: <strong>${totalCarryforward.toLocaleString('en')} ÿØ.ÿπ</strong>
                    </div>
                    <div style="font-size: 0.9em;">
                        ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ™ÿ£ÿ´ÿ±ÿ©: ${carryforwardInstallments.map(inst => 
                            `ÿßŸÑÿ¥Ÿáÿ± ${inst.month} (${(inst.carryforward_received || 0).toLocaleString('en')} ÿØ.ÿπ)`
                        ).join(', ')}
                    </div>
                </div>
            `;
            return summaryHtml;
        }

        // ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ≥ÿØŸäÿØ ŸÇÿ≥ÿ∑ ÿ¥Ÿáÿ±Ÿä
        function payInstallment(debtId, monthNumber) {
            const debt = debtsData.find(d => 
                d.id == debtId || 
                d.__backendId == debtId || 
                d.debt_id == debtId
            );
            
            if (!debt) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿ©
            const relatedSale = salesData.find(s => s.invoice_id === debt.invoice_id);
            
            if (!debt.installments || debt.installments.length === 0) {
                const months = debt.installment_months || relatedSale?.installment_months || 12;
                let monthlyAmount = parseFloat(debt.monthly_amount || relatedSale?.monthly_amount || 0);
                
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ monthlyAmount Ÿäÿ≥ÿßŸàŸä 0ÿå ÿßÿ≠ÿ≥ÿ®Ÿá ŸÖŸÜ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
                if (monthlyAmount === 0) {
                    const totalAmount = parseFloat(debt.total_amount || debt.final_total || debt.remaining_amount || relatedSale?.final_total || 0);
                    monthlyAmount = totalAmount / months;
                }
                
                console.log('Creating installments - Months:', months, 'Monthly Amount:', monthlyAmount);
                
                debt.installments = [];
                const startDate = new Date(debt.timestamp || relatedSale?.timestamp || Date.now());
                for (let i = 0; i < months; i++) {
                    const dueDate = new Date(startDate);
                    dueDate.setMonth(dueDate.getMonth() + i + 1);
                    
                    debt.installments.push({
                        month: i + 1,
                        due_date: dueDate.toISOString(),
                        amount: monthlyAmount,
                        status: 'pending',
                        paid_date: null,
                        paid_amount: 0
                    });
                }
                
                console.log('‚úÖ Created installments:', debt.installments);
            }
            
            // ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÇÿ≥ÿ∑
            const installment = debt.installments.find(inst => inst.month === monthNumber);
            if (!installment) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            if (installment.status === 'paid') {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            console.log('Installment to pay:', installment);
            console.log('Installment amount:', installment.amount);
            
            // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ≠ÿßŸÑŸä
            currentInstallmentDebtId = debtId;
            currentInstallmentMonth = monthNumber;
            
            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ¥Ÿáÿ±Ÿä ŸÖÿπ fallback options
            let monthlyAmount = parseFloat(installment.amount) || 0;
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ®ŸÑÿ∫ 0ÿå ÿ≠ÿßŸàŸÑ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸäŸá ŸÖŸÜ ŸÖÿµÿßÿØÿ± ÿ£ÿÆÿ±Ÿâ
            if (monthlyAmount === 0) {
                monthlyAmount = parseFloat(debt.monthly_amount) || 0;
                console.log('Got amount from debt.monthly_amount:', monthlyAmount);
            }
            
            // ÿ•ÿ∞ÿß ŸÑÿß Ÿäÿ≤ÿßŸÑ 0ÿå ÿßÿ≠ÿ≥ÿ®Ÿá ŸÖŸÜ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
            if (monthlyAmount === 0) {
                const totalAmount = parseFloat(debt.total_amount || debt.final_total) || 0;
                const months = parseInt(debt.installment_months) || debt.installments.length || 1;
                monthlyAmount = totalAmount / months;
                console.log('Calculated from total:', totalAmount, '/', months, '=', monthlyAmount);
            }
            
            console.log('Final monthly amount:', monthlyAmount);
            
            // ŸÖŸÑÿ° ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ©
            document.getElementById('installmentMonthDisplay').value = `ÿßŸÑÿ¥Ÿáÿ± ${monthNumber}`;
            const amountValue = Math.round(monthlyAmount); // ÿ™ŸÇÿ±Ÿäÿ® ŸÑŸÑÿπÿØÿØ ÿßŸÑÿµÿ≠Ÿäÿ≠
            const amountInput = document.getElementById('installmentAmountInput');
            amountInput.value = amountValue;
            document.getElementById('installmentNotes').value = '';
            
            console.log('‚úÖ Amount field filled with:', amountValue);
            
            // ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ©
            showModal('payInstallmentModal');
            
            // ÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿ≠ŸÇŸÑ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿ®ÿπÿØ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ŸÑÿ™ÿ≥ŸáŸäŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑ
            setTimeout(() => {
                if (amountInput) {
                    amountInput.focus();
                    amountInput.select(); // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÜÿµ ŸÑÿ™ÿ≥ŸáŸäŸÑ ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ŸÅŸàŸÇŸá
                }
            }, 300);
        }
        
        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ™ÿ≥ÿØŸäÿØ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä
        async function handlePayInstallment(event) {
            event.preventDefault();
            
            const paidAmountInput = document.getElementById('installmentAmountInput').value;
            const paidAmount = parseFloat(paidAmountInput) || 0;
            const notes = document.getElementById('installmentNotes').value.trim();
            
            if (paidAmount <= 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            const debt = debtsData.find(d => 
                d.id == currentInstallmentDebtId || 
                d.__backendId == currentInstallmentDebtId || 
                d.debt_id == currentInstallmentDebtId
            );
            
            if (!debt) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            // ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÇÿ≥ÿ∑
            const installment = debt.installments.find(inst => inst.month === currentInstallmentMonth);
            if (!installment) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            console.log('=== Processing Installment Payment (FIXED) ===');
            console.log('Month:', currentInstallmentMonth);
            console.log('Original installment amount:', installment.amount);
            console.log('Paid amount:', paidAmount);
            
            // üî• ÿ•ÿµŸÑÿßÿ≠: ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä ŸÑŸÑŸÇÿ≥ÿ∑ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠
            const originalAmount = parseFloat(installment.original_amount || installment.amount) || 0;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ ÿ≥ÿßÿ®ŸÇÿßŸã (ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØ ÿßŸÑÿ¨ÿ≤ÿ¶Ÿä ÿßŸÑŸÖÿ™ŸÉÿ±ÿ±)
            const previouslyPaid = parseFloat(installment.paid_amount) || 0;
            const totalPaidForThisInstallment = previouslyPaid + paidAmount;
            
            console.log('Original amount:', originalAmount);
            console.log('Previously paid:', previouslyPaid);
            console.log('Current payment:', paidAmount);
            console.log('Total paid for installment:', totalPaidForThisInstallment);
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ≠ÿßŸÑŸä ÿ®ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ
            installment.paid_date = new Date().toISOString();
            installment.paid_amount = totalPaidForThisInstallment;
            
            // ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
            if (!installment.original_amount) {
                installment.original_amount = originalAmount;
            }
            
            // üî• ÿ•ÿµŸÑÿßÿ≠: ÿ™ÿ≠ÿØŸäÿØ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÇÿ≥ÿ∑ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠ (ŸÖÿπ ÿ™ŸÇÿ±Ÿäÿ® ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ)
            const roundedTotal = Math.round(totalPaidForThisInstallment);
            const roundedOriginal = Math.round(originalAmount);
            
            if (roundedTotal >= roundedOriginal) {
                // ÿØŸÅÿπ ŸÉÿßŸÖŸÑ
                installment.status = 'paid';
                // ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ ŸÑÿß Ÿäÿ≤ŸäÿØ ÿπŸÜ ÿßŸÑÿ£ÿµŸÑŸä
                installment.paid_amount = originalAmount;
                console.log('‚úÖ Full payment - status: paid');
            } else {
                // ÿØŸÅÿπ ÿ¨ÿ≤ÿ¶Ÿä
                installment.status = 'partially_paid';
                console.log('‚ö†Ô∏è Partial payment - status: partially_paid');
            }
            
            // üî• ÿ•ÿµŸÑÿßÿ≠: ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ≥ÿ¨ŸÑ ŸÑŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠
            if (!debt.payments) {
                debt.payments = [];
            }
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÅÿ±ŸÇ (ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ŸÖŸÜ ÿßŸÑŸÇÿ≥ÿ∑)
            const remainingForMonth = Math.round(originalAmount - totalPaidForThisInstallment);
            const isPartialPayment = totalPaidForThisInstallment < originalAmount;
            
            // üÜï ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ±ÿ≠ŸäŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
            let carriedForwardAmount = 0;
            let carriedForwardTo = null;
            
            if (isPartialPayment && remainingForMonth > 0) {
                // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ™ÿßŸÑŸä
                const nextInstallment = debt.installments.find(inst => inst.month === currentInstallmentMonth + 1);
                
                if (nextInstallment) {
                    console.log('üîÑ Carryforward detected - Remaining:', remainingForMonth);
                    console.log('   Next installment (Month', nextInstallment.month, '):', nextInstallment.amount);
                    
                    // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖÿ≠ŸÅŸàÿ∏ÿßŸã
                    if (!nextInstallment.original_amount) {
                        nextInstallment.original_amount = nextInstallment.amount;
                    }
                    
                    // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ±ÿ≠ŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ™ÿßŸÑŸä
                    nextInstallment.amount = parseFloat(nextInstallment.amount) + remainingForMonth;
                    
                    // ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿ±ÿ≠ŸäŸÑ
                    if (!nextInstallment.carryforward_received) {
                        nextInstallment.carryforward_received = 0;
                    }
                    nextInstallment.carryforward_received += remainingForMonth;
                    
                    // ÿ≠ŸÅÿ∏ ŸÖÿµÿØÿ± ÿßŸÑÿ™ÿ±ÿ≠ŸäŸÑ
                    if (!nextInstallment.carryforward_from) {
                        nextInstallment.carryforward_from = [];
                    }
                    nextInstallment.carryforward_from.push({
                        from_month: currentInstallmentMonth,
                        amount: remainingForMonth,
                        date: new Date().toISOString()
                    });
                    
                    carriedForwardAmount = remainingForMonth;
                    carriedForwardTo = nextInstallment.month;
                    
                    console.log('   ‚úÖ Carried forward', remainingForMonth, 'to month', nextInstallment.month);
                    console.log('   New amount for month', nextInstallment.month, ':', nextInstallment.amount);
                } else {
                    console.log('‚ö†Ô∏è No next installment found - Cannot carryforward');
                }
            }
            
            // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÑŸÑÿ≥ÿ¨ŸÑ
            const paymentRecord = {
                date: new Date().toISOString(),
                amount: paidAmount, // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÅŸÇÿ∑
                month: currentInstallmentMonth,
                original_amount: originalAmount,
                total_paid_for_month: totalPaidForThisInstallment, // ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿØŸÅŸàÿπ ŸÑŸáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±
                remaining_for_month: remainingForMonth > 0 ? remainingForMonth : 0, // ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ŸÑŸáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±
                payment_type: isPartialPayment ? 'partial' : 'full',
                difference: remainingForMonth > 0 ? remainingForMonth : 0,
                carried_forward: carriedForwardAmount > 0, // ŸáŸÑ ÿ™ŸÖ ÿßŸÑÿ™ÿ±ÿ≠ŸäŸÑ
                carried_forward_amount: carriedForwardAmount, // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ±ÿ≠ŸÑ
                carried_forward_to: carriedForwardTo, // ÿ•ŸÑŸâ ÿ£Ÿä ÿ¥Ÿáÿ±
                notes: notes || (isPartialPayment 
                    ? `ÿ™ÿ≥ÿØŸäÿØ ÿ¨ÿ≤ÿ¶Ÿä ŸÑŸÑŸÇÿ≥ÿ∑ ÿ±ŸÇŸÖ ${currentInstallmentMonth} - ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ: ${formatCurrency(paidAmount)} - ÿßŸÑŸÖÿ™ÿ®ŸÇŸä: ${formatCurrency(remainingForMonth)}${carriedForwardAmount > 0 ? ` - ÿ™ŸÖ ÿ™ÿ±ÿ≠ŸäŸÑ ${formatCurrency(carriedForwardAmount)} ÿ•ŸÑŸâ ÿßŸÑÿ¥Ÿáÿ± ${carriedForwardTo}` : ''}`
                    : `ÿ™ÿ≥ÿØŸäÿØ ŸÉÿßŸÖŸÑ ŸÑŸÑŸÇÿ≥ÿ∑ ÿ±ŸÇŸÖ ${currentInstallmentMonth}`)
            };
            
            debt.payments.push(paymentRecord);
            console.log('Payment record added:', paymentRecord);
            
            // üî• ÿ•ÿµŸÑÿßÿ≠: ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ŸàÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠
            const totalAmount = debt.total_amount || debt.final_total || 0;
            const currentPaid = debt.paid_amount || 0;
            debt.paid_amount = currentPaid + paidAmount;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ŸÖŸÜ ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿ®ÿ¥ŸÉŸÑ ÿØŸÇŸäŸÇ
            let totalRemainingFromInstallments = 0;
            if (debt.installments && Array.isArray(debt.installments)) {
                debt.installments.forEach(inst => {
                    const instOriginal = parseFloat(inst.original_amount || inst.amount || 0);
                    const instPaid = parseFloat(inst.paid_amount || 0);
                    const instRemaining = instOriginal - instPaid;
                    if (instRemaining > 0) {
                        totalRemainingFromInstallments += instRemaining;
                    }
                });
            }
            
            // üî• ÿ•ÿµŸÑÿßÿ≠: ÿ™ŸÇÿ±Ÿäÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ŸÑÿ™ÿ¨ŸÜÿ® ŸÖÿ¥ÿßŸÉŸÑ ÿßŸÑŸÉÿ≥Ÿàÿ± ÿßŸÑÿπÿ¥ÿ±Ÿäÿ©
            debt.remaining_amount = Math.round(totalRemainingFromInstallments);
            if (debt.remaining_amount < 0) debt.remaining_amount = 0;
            
            // üî• ÿ•ÿµŸÑÿßÿ≠: ÿ™ŸÇÿ±Ÿäÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ ÿ£Ÿäÿ∂ÿßŸã
            debt.paid_amount = Math.round(debt.paid_amount);
            
            // üî• ÿ•ÿµŸÑÿßÿ≠: ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ÿßŸÑÿ© ÿ®ÿ¥ŸÉŸÑ ÿØŸÇŸäŸÇ
            const allFullyPaid = debt.installments.every(inst => inst.status === 'paid');
            const anyPartiallyPaid = debt.installments.some(inst => inst.status === 'partially_paid');
            
            if (allFullyPaid) {
                debt.status = 'ŸÖÿ≥ÿØÿØ';
            } else if (anyPartiallyPaid) {
                debt.status = 'ŸÜÿ¥ÿ∑ - ÿØŸÅÿπ ÿ¨ÿ≤ÿ¶Ÿä';
            } else {
                debt.status = 'ŸÜÿ¥ÿ∑';
            }
            
            console.log('Payment processed (FIXED):');
            console.log('  - Total Amount:', totalAmount);
            console.log('  - Paid Amount:', debt.paid_amount);
            console.log('  - Remaining Amount:', debt.remaining_amount);
            console.log('  - Debt Status:', debt.status);
            
            // ÿ≠ŸÅÿ∏ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            if (window.dataSdk && debt.id) {
                const updateData = {
                    installments: debt.installments,
                    payments: debt.payments,
                    remaining_amount: debt.remaining_amount,
                    paid_amount: debt.paid_amount,
                    total_amount: totalAmount,
                    status: debt.status
                };
                
                console.log('=== Saving to database ===');
                console.log('Debt ID:', debt.id);
                console.log('Update data:', JSON.stringify(updateData, null, 2));
                
                await window.dataSdk.update(debt.id, updateData);
                console.log('‚úÖ Successfully saved to database');
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                const allData = await window.dataSdk.query();
                if (allData.isOk) {
                    debtsData = allData.data.filter(item => item.type === 'debt');
                    updateStatistics();
                    updateQuickStats();
                }
            }
            
            // ÿ∑ÿ®ÿßÿπÿ© ÿ•ŸäÿµÿßŸÑ ÿ™ÿ≥ÿØŸäÿØ ÿßŸÑŸÇÿ≥ÿ∑
            try {
                let storeSettings = {};
                try {
                    storeSettings = JSON.parse(localStorage.getItem('storeSettings') || '{}');
                } catch {}
                
                const receiptHtml = generateInstallmentPaymentReceipt({
                    debt,
                    paidInstallment: installment,
                    storeSettings
                });
                
                const printHtml = `<!DOCTYPE html><html dir="rtl" lang="ar"><head><meta charset="UTF-8"><title>ÿ•ŸäÿµÿßŸÑ ÿ™ÿ≥ÿØŸäÿØ ŸÇÿ≥ÿ∑</title><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet"><style>@media print { body { margin: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; } }</style></head><body>${receiptHtml}</body></html>`;
                
                if (window.electronAPI && window.electronAPI.printInvoiceHtml) {
                    await window.electronAPI.printInvoiceHtml(printHtml, {
                        silent: true, 
                        pageSize: 'A4', 
                        printBackground: true, 
                        margins: { top: 10, bottom: 10, left: 10, right: 10 }
                    });
                } else {
                    const win = window.open('', '_blank');
                    win.document.write(printHtml);
                    win.print();
                }
            } catch (err) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ∑ÿ®ÿßÿπÿ© ÿ•ŸäÿµÿßŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØ:', err);
            }

            // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ©
            closeModal('payInstallmentModal');
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂
            showDebtDetails(currentInstallmentDebtId);
        }
        
        // ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ≥ÿØŸäÿØ ÿ≥ÿ±Ÿäÿπ ŸÖŸÜ ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿØŸäŸàŸÜ
        function showQuickPayModal(debtId) {
            const debt = debtsData.find(d => 
                d.id == debtId || 
                d.__backendId == debtId || 
                d.debt_id == debtId
            );
            
            if (!debt) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ŸàŸÑ ŸÇÿ≥ÿ∑ ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπ
            let nextUnpaidInstallment = null;
            let nextUnpaidMonth = null;
            
            if (debt.installments && Array.isArray(debt.installments) && debt.installments.length > 0) {
                for (let inst of debt.installments) {
                    if (inst.status !== 'paid') {
                        nextUnpaidInstallment = inst;
                        nextUnpaidMonth = inst.month;
                        break;
                    }
                }
            }
            
            if (!nextUnpaidInstallment) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            // ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØ ŸÑŸÑŸÇÿ≥ÿ∑ ÿ∫Ÿäÿ± ÿßŸÑŸÖÿØŸÅŸàÿπ
            payInstallment(debtId, nextUnpaidMonth);
        }
        
        // ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ∞ŸÅ ÿßŸÑÿØŸäŸÜ
        function confirmDeleteDebt(debtId, customerName) {
            // ÿ≠ŸÅÿ∏ ŸÖÿπÿ±ŸÅ ÿßŸÑÿØŸäŸÜ
            debtToDelete = debtId;
            
            // ÿπÿ±ÿ∂ ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ ŸÅŸä ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            document.getElementById('deleteDebtCustomerName').textContent = customerName;
            
            // ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ£ŸÉŸäÿØ
            showModal('confirmDeleteModal');
        }
        
        // ÿ™ŸÜŸÅŸäÿ∞ ÿ≠ÿ∞ŸÅ ÿßŸÑÿØŸäŸÜ ÿ®ÿπÿØ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ
        function executeDeleteDebt() {
            if (debtToDelete) {
                closeModal('confirmDeleteModal');
                deleteDebt(debtToDelete);
                debtToDelete = null;
            }
        }
        
        // ÿ≠ÿ∞ŸÅ ÿßŸÑÿØŸäŸÜ
        async function deleteDebt(debtId) {
            try {
                const debt = debtsData.find(d => 
                    d.id == debtId || 
                    d.__backendId == debtId || 
                    d.debt_id == debtId
                );
                
                if (!debt) {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    return;
                }
                
                // ÿ≠ÿ∞ŸÅ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                if (window.dataSdk && (debt.id || debt.__backendId)) {
                    const deleteId = debt.id || debt.__backendId;
                    const result = await window.dataSdk.delete(deleteId);
                    
                    if (result.isOk) {
                        // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                        const allData = await window.dataSdk.query();
                        if (allData.isOk) {
                            debtsData = allData.data.filter(item => item.type === 'debt');
                            
                            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
                            renderDebtsTable();
                            updateStatistics();
                            updateQuickStats();
                            
                            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                        }
                    } else {
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    }
                } else {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                }
            } catch (error) {
                console.error('Error deleting debt:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }
        
        // ÿØÿßŸÑÿ© ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ≥ÿ±Ÿäÿπ ŸÅŸä ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ
        function filterPOSProducts() {
            renderProducts();
        }
        
        // ÿØÿßŸÑÿ© ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
        function filterInvoices() {
            renderInvoicesTable();
        }
        
        // ÿØÿßŸÑÿ© ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
        function filterProducts() {
            renderProductsTable();
        }
        
        // ÿØÿßŸÑÿ© ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
        function filterInventory() {
            renderInventoryTable();
        }
        
        // ÿØÿßŸÑÿ© ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿØŸäŸàŸÜ
        function filterDebts() {
            renderDebtsTable();
        }
        
        // ‚úÖ ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ÿ•ŸäÿµÿßŸÑ ŸÖÿ®Ÿäÿπÿßÿ™ ÿßŸÑŸäŸàŸÖ
        function showTodaySalesReport() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ŸÑŸÑŸäŸàŸÖ ÿßŸÑÿ≠ÿßŸÑŸä
            const todaySales = salesData.filter(sale => {
                const saleDate = sale.timestamp || sale.created_at || sale.date;
                if (!saleDate) return false;
                const saleDateStr = new Date(saleDate).toISOString().split('T')[0];
                return saleDateStr === todayStr;
            });
            
            // ÿ≠ÿ≥ÿßÿ® ŸÖÿ®Ÿäÿπÿßÿ™ ŸÜŸÇÿØŸä Ÿàÿ£ŸÇÿ≥ÿßÿ∑
            let cashTotal = 0;
            let installmentTotal = 0;
            let cashCount = 0;
            let installmentCount = 0;
            
            todaySales.forEach(sale => {
                const total = sale.final_total || sale.total || 0;
                if (sale.payment_method === 'ŸÜŸÇÿØŸä' || sale.payment_type === 'ŸÜŸÇÿØŸä') {
                    cashTotal += total;
                    cashCount++;
                } else if (sale.payment_method === 'ÿ£ŸÇÿ≥ÿßÿ∑' || sale.payment_type === 'ÿ£ŸÇÿ≥ÿßÿ∑') {
                    installmentTotal += total;
                    installmentCount++;
                }
            });
            
            const grandTotal = cashTotal + installmentTotal;
            
            // ÿ•ŸÜÿ¥ÿßÿ° HTML ŸÑŸÑÿ•ŸäÿµÿßŸÑ
            const dateStr = toEnglishDigits(today.toLocaleDateString('en-GB'));
            const timeStr = toEnglishDigits(today.toLocaleTimeString('ar-IQ', { hour: '2-digit', minute: '2-digit' }));
            const dayName = today.toLocaleDateString('ar-IQ', { weekday: 'long' });
            
            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ±
            const savedSettings = localStorage.getItem('storeSettings');
            let storeName = 'ŸÖÿπÿ±ÿ∂ ŸäÿπŸÇŸàÿ®';
            let storeAddress = 'ÿ®ÿßÿ® ÿßŸÑŸáÿßÿ¥ŸÖŸäÿ©';
            let storePhone = '07803092185';
            
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                storeName = settings.storeName || storeName;
                storeAddress = settings.storeAddress || storeAddress;
                storePhone = settings.storePhone || storePhone;
            }
            
            const html = `<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="UTF-8">
<title>ÿ•ŸäÿµÿßŸÑ ŸÖÿ®Ÿäÿπÿßÿ™ ÿßŸÑŸäŸàŸÖ</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: 'Cairo', sans-serif; 
    font-size: 11px; 
    line-height: 1.3;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
}
.page { 
    width: 210mm; 
    max-width: 100%; 
    margin: 0; 
    padding: 8mm;
    page-break-after: always;
    background: #fff;
}
.header { 
    text-align: center; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    color: #fff; 
    padding: 12px; 
    border-radius: 8px;
    margin-bottom: 10px;
}
.header h1 { font-size: 20px; margin-bottom: 5px; }
.header .info { font-size: 10px; }
.date-info { 
    background: #f8f9fa; 
    padding: 10px; 
    border-radius: 6px; 
    margin-bottom: 10px;
    text-align: center;
    border: 2px solid #dee2e6;
}
.date-info .day { font-size: 14px; font-weight: 700; color: #667eea; margin-bottom: 3px; }
.date-info .date { font-size: 12px; color: #6c757d; }
.sales-grid { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 10px; 
    margin-bottom: 10px; 
}
.sales-card { 
    padding: 12px; 
    border-radius: 8px; 
    text-align: center; 
    border: 2px solid;
}
.sales-card.cash { 
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); 
    border-color: #11998e;
    color: #fff;
}
.sales-card.installment { 
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
    border-color: #f093fb;
    color: #fff;
}
.sales-card .label { font-size: 10px; opacity: 0.9; margin-bottom: 5px; }
.sales-card .amount { font-size: 18px; font-weight: 900; margin-bottom: 3px; }
.sales-card .count { font-size: 9px; opacity: 0.85; }
.total-box { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    color: #fff; 
    padding: 15px; 
    border-radius: 8px;
    text-align: center;
    margin-bottom: 10px;
}
.total-box .label { font-size: 12px; opacity: 0.9; margin-bottom: 5px; }
.total-box .amount { font-size: 24px; font-weight: 900; }
.footer { 
    text-align: center; 
    background: #f8f9fa; 
    padding: 10px; 
    border-radius: 6px;
    border: 2px solid #dee2e6;
    font-size: 9px;
    color: #6c757d;
}
@media print {
    body { margin: 0; }
    .page { margin: 0; padding: 8mm; }
}
</style>
</head>
<body>
<div class="page">
    <div class="header">
        <h1>üìä ÿ•ŸäÿµÿßŸÑ ŸÖÿ®Ÿäÿπÿßÿ™ ÿßŸÑŸäŸàŸÖ</h1>
        <div class="info"><strong>${storeName}</strong> ‚Ä¢ ${storeAddress} ‚Ä¢ ${storePhone}</div>
    </div>
    
    <div class="date-info">
        <div class="day">${dayName}</div>
        <div class="date">${dateStr} - ${timeStr}</div>
    </div>
    
    <div class="sales-grid">
        <div class="sales-card cash">
            <div class="label">üíµ ŸÖÿ®Ÿäÿπÿßÿ™ ŸÜŸÇÿØŸä</div>
            <div class="amount">${toEnglishDigits(cashTotal.toLocaleString('en'))}</div>
            <div class="count">${toEnglishDigits(cashCount)} ÿπŸÖŸÑŸäÿ©</div>
        </div>
        
        <div class="sales-card installment">
            <div class="label">üìÖ ŸÖÿ®Ÿäÿπÿßÿ™ ÿ£ŸÇÿ≥ÿßÿ∑</div>
            <div class="amount">${toEnglishDigits(installmentTotal.toLocaleString('en'))}</div>
            <div class="count">${toEnglishDigits(installmentCount)} ÿπŸÖŸÑŸäÿ©</div>
        </div>
    </div>
    
    <div class="total-box">
        <div class="label">üí∞ ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿØÿÆŸÑ ŸÅŸä ÿßŸÑŸÉÿßÿ¥Ÿäÿ±</div>
        <div class="amount">${toEnglishDigits(grandTotal.toLocaleString('en'))} ÿØ.ÿπ</div>
    </div>
    
    <div class="footer">
        <div style="font-weight:700;margin-bottom:3px;">ŸÜÿ∏ÿßŸÖ ŸÉÿßÿ¥ ÿ®ÿ±Ÿà - Digital Creativity</div>
        <div>ÿ™ŸÖ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ŸÅŸä: ${dateStr} - ${timeStr}</div>
    </div>
</div>
</body>
</html>`;
            
            // ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ŸÑŸÑÿ∑ÿ®ÿßÿπÿ©
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(html);
                printWindow.document.close();
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            } else {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }
        
        function showPayDebtModal(debtId) {
            console.log('Show pay debt modal:', debtId);
        }

        function handlePayDebt(event) {
            event.preventDefault();
            console.log('Handle pay debt');
        }

        // ÿßŸÑÿ™ŸÜŸÇŸÑ ÿ•ŸÑŸâ ÿµŸÅÿ≠ÿßÿ™ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÅÿ±ÿπŸäÿ©
        function showSettingsPage(pageName) {
            // ÿ•ÿÆŸÅÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÅÿ≠ÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none';
            });
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
            const targetPage = document.getElementById(`settings-${pageName}`);
            if (targetPage) {
                targetPage.style.display = 'block';
                targetPage.classList.add('active');
                setTimeout(() => {
                    targetPage.classList.add('animate__animated', 'animate__fadeIn');
                }, 10);
            }
        }

        // ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ±
        function saveStoreSettings() {
            const storeSettings = {
                storeName: document.getElementById('settingsStoreName')?.value || '',
                ownerName: document.getElementById('settingsOwnerName')?.value || '',
                commercialReg: document.getElementById('settingsCommercialReg')?.value || '',
                taxNumber: document.getElementById('settingsTaxNumber')?.value || '',
                address: document.getElementById('settingsStoreAddress')?.value || '',
                phone1: document.getElementById('settingsStorePhone1')?.value || '',
                phone2: document.getElementById('settingsStorePhone2')?.value || '',
                email: document.getElementById('settingsStoreEmail')?.value || '',
                whatsapp: document.getElementById('settingsWhatsapp')?.value || '',
                website: document.getElementById('settingsWebsite')?.value || '',
                taxRate: parseFloat(document.getElementById('settingsTaxRate')?.value) || 0,
                currency: document.getElementById('settingsDefaultCurrency')?.value || 'IQD',
                minDebtAmount: parseFloat(document.getElementById('settingsMinDebtAmount')?.value) || 0,
                openTime: document.getElementById('settingsOpenTime')?.value || '09:00',
                closeTime: document.getElementById('settingsCloseTime')?.value || '22:00',
                closedFriday: document.getElementById('closedFriday')?.checked || false,
                closedSaturday: document.getElementById('closedSaturday')?.checked || false
            };

            // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ±ŸÅÿπ ÿßŸÑÿ¥ÿπÿßÿ±
            const logoInput = document.getElementById('settingsStoreLogo');
            if (logoInput && logoInput.files && logoInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    storeSettings.logo = e.target.result;
                    localStorage.setItem('storeSettings', JSON.stringify(storeSettings));
                    applyStoreSettings(storeSettings);
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                };
                reader.readAsDataURL(logoInput.files[0]);
            } else {
                const savedSettings = JSON.parse(localStorage.getItem('storeSettings') || '{}');
                if (savedSettings.logo) {
                    storeSettings.logo = savedSettings.logo;
                }
                localStorage.setItem('storeSettings', JSON.stringify(storeSettings));
                applyStoreSettings(storeSettings);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        // ÿ™ÿ∑ÿ®ŸäŸÇ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ± ÿπŸÑŸâ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
        function applyStoreSettings(settings) {
            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ™ÿ¨ÿ± ŸÅŸä ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÖÿßŸÉŸÜ
            document.querySelectorAll('.store-name-display').forEach(el => {
                el.textContent = settings.storeName || 'ÿßŸÑŸÖÿ™ÿ¨ÿ±';
            });
            
            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ¥ÿπÿßÿ±
            if (settings.logo) {
                document.querySelectorAll('.store-logo').forEach(img => {
                    img.src = settings.logo;
                });
            }
            
            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿπŸÖŸÑÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
            window.currentCurrency = settings.currency || 'IQD';
            
            // ÿ™ÿ∑ÿ®ŸäŸÇ ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©
            window.defaultTaxRate = settings.taxRate || 0;
            
            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑŸÑÿØŸäŸÜ
            window.minDebtAmount = settings.minDebtAmount || 0;
        }

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ±
        function loadStoreSettings() {
            const savedSettings = localStorage.getItem('storeSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                
                if (document.getElementById('settingsStoreName')) document.getElementById('settingsStoreName').value = settings.storeName || '';
                if (document.getElementById('settingsOwnerName')) document.getElementById('settingsOwnerName').value = settings.ownerName || '';
                if (document.getElementById('settingsCommercialReg')) document.getElementById('settingsCommercialReg').value = settings.commercialReg || '';
                if (document.getElementById('settingsTaxNumber')) document.getElementById('settingsTaxNumber').value = settings.taxNumber || '';
                if (document.getElementById('settingsStoreAddress')) document.getElementById('settingsStoreAddress').value = settings.address || '';
                if (document.getElementById('settingsStorePhone1')) document.getElementById('settingsStorePhone1').value = settings.phone1 || '';
                if (document.getElementById('settingsStorePhone2')) document.getElementById('settingsStorePhone2').value = settings.phone2 || '';
                if (document.getElementById('settingsStoreEmail')) document.getElementById('settingsStoreEmail').value = settings.email || '';
                if (document.getElementById('settingsWhatsapp')) document.getElementById('settingsWhatsapp').value = settings.whatsapp || '';
                if (document.getElementById('settingsWebsite')) document.getElementById('settingsWebsite').value = settings.website || '';
                if (document.getElementById('settingsTaxRate')) document.getElementById('settingsTaxRate').value = settings.taxRate || 0;
                if (document.getElementById('settingsDefaultCurrency')) document.getElementById('settingsDefaultCurrency').value = settings.currency || 'IQD';
                if (document.getElementById('settingsMinDebtAmount')) document.getElementById('settingsMinDebtAmount').value = settings.minDebtAmount || 0;
                if (document.getElementById('settingsOpenTime')) document.getElementById('settingsOpenTime').value = settings.openTime || '09:00';
                if (document.getElementById('settingsCloseTime')) document.getElementById('settingsCloseTime').value = settings.closeTime || '22:00';
                if (document.getElementById('closedFriday')) document.getElementById('closedFriday').checked = settings.closedFriday || false;
                if (document.getElementById('closedSaturday')) document.getElementById('closedSaturday').checked = settings.closedSaturday || false;
                
                // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
                applyStoreSettings(settings);
            }
        }

        // ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ
        function saveSystemSettings() {
            const systemSettings = {
                theme: document.getElementById('themeSelect')?.value || 'dark',
                colorScheme: document.getElementById('colorSchemeSelect')?.value || 'default',
                fontSize: document.getElementById('fontSizeSelect')?.value || 'medium',
                compactMode: document.getElementById('compactModeCheck')?.checked || false,
                language: document.getElementById('languageSelect')?.value || 'ar',
                dateFormat: document.getElementById('dateFormatSelect')?.value || 'DD/MM/YYYY',
                timeFormat: document.getElementById('timeFormatSelect')?.value || '12',
                itemsPerPage: document.getElementById('itemsPerPageSelect')?.value || 25,
                animations: document.getElementById('animationsCheck')?.checked !== false,
                autosave: document.getElementById('autosaveCheck')?.checked !== false,
                barcodeSound: document.getElementById('barcodeSound')?.checked !== false,
                autoPrint: document.getElementById('autoPrint')?.checked || false,
                clearCartAfterSale: document.getElementById('clearCartAfterSale')?.checked !== false
            };

            localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
            
            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸÅŸàÿ±ÿßŸã
            applySystemSettings(systemSettings);
            
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }

        // ÿ™ÿ∑ÿ®ŸäŸÇ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ
        function applySystemSettings(settings) {
            console.log('‚öôÔ∏è ÿ™ÿ∑ÿ®ŸäŸÇ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ:', settings);
            
            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ´ŸäŸÖ
            applyTheme(settings.theme || 'dark');
            
            // ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ¨ŸÖŸàÿπÿ© ÿßŸÑÿ£ŸÑŸàÿßŸÜ
            if (settings.colorScheme) {
                const colors = colorSchemes[settings.colorScheme] || colorSchemes.default;
                applyCustomColors(colors);
            } else {
                // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿßŸÑŸÖÿÆÿµÿµÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©
                const savedColors = localStorage.getItem('customColors');
                if (savedColors) {
                    applyCustomColors(JSON.parse(savedColors));
                }
            }
            
            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿ≠ÿ¨ŸÖ ÿßŸÑÿÆÿ∑
            applyFontSize(settings.fontSize || 'medium');
            
            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÑÿ∫ÿ©
            applyLanguage(settings.language || 'ar');
            
            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑
            if (settings.compactMode) {
                document.body.classList.add('compact-mode');
                console.log('üì¶ ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑');
            } else {
                document.body.classList.remove('compact-mode');
                console.log('üì¶ ÿ™ŸÖ ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑');
            }
            
            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ±ÿ≥ŸàŸÖ ÿßŸÑŸÖÿ™ÿ≠ÿ±ŸÉÿ©
            if (!settings.animations) {
                document.body.classList.add('no-animations');
                console.log('üé¨ ÿ™ŸÖ ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑÿ±ÿ≥ŸàŸÖ ÿßŸÑŸÖÿ™ÿ≠ÿ±ŸÉÿ©');
            } else {
                document.body.classList.remove('no-animations');
                console.log('üé¨ ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ±ÿ≥ŸàŸÖ ÿßŸÑŸÖÿ™ÿ≠ÿ±ŸÉÿ©');
            }
            
            console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿ¨ŸÖŸäÿπ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ´ŸäŸÖ
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('currentTheme', theme);
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿÆŸÑŸÅŸäÿ©
            const animatedBg = document.querySelector('.animated-bg');
            if (animatedBg) {
                if (theme === 'light') {
                    animatedBg.style.background = 'var(--theme-bg-primary)';
                } else {
                    animatedBg.style.background = 'var(--theme-bg-primary)';
                }
            }
            
            console.log('üé® ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ´ŸäŸÖ:', theme);
        }

        // Ÿàÿ∏ŸäŸÅÿ© ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ´ŸäŸÖ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
        function changeTheme(theme) {
            applyTheme(theme);
            
            const themeNames = {
                'dark': 'üåô ÿßŸÑÿØÿßŸÉŸÜ ÿßŸÑŸÉŸÑÿßÿ≥ŸäŸÉŸä',
                'light': '‚òÄÔ∏è ÿßŸÑŸÅÿßÿ™ÿ≠ ÿßŸÑŸÉŸÑÿßÿ≥ŸäŸÉŸä',
                'blue-dark': 'üîµ ÿßŸÑÿ£ÿ≤ÿ±ŸÇ ÿßŸÑÿØÿßŸÉŸÜ',
                'green-dark': 'üíö ÿßŸÑÿ£ÿÆÿ∂ÿ± ÿßŸÑÿØÿßŸÉŸÜ',
                'orange-dark': 'üß° ÿßŸÑÿ®ÿ±ÿ™ŸÇÿßŸÑŸä ÿßŸÑÿØÿßŸÉŸÜ',
                'purple-dark': 'üíú ÿßŸÑÿ®ŸÜŸÅÿ≥ÿ¨Ÿä ÿßŸÑÿØÿßŸÉŸÜ',
                'red-dark': '‚ù§Ô∏è ÿßŸÑÿ£ÿ≠ŸÖÿ± ÿßŸÑÿØÿßŸÉŸÜ',
                'cyan-light': 'ü©µ ÿßŸÑÿ≥ŸÖÿßŸàŸä ÿßŸÑŸÅÿßÿ™ÿ≠',
                'gold-light': 'üü° ÿßŸÑÿ∞Ÿáÿ®Ÿä ÿßŸÑŸÅÿßÿ™ÿ≠',
                'pink-light': 'üå∏ ÿßŸÑŸàÿ±ÿØŸä ÿßŸÑŸÅÿßÿ™ÿ≠',
                'olive': 'üü¢ ÿßŸÑÿ≤Ÿäÿ™ŸàŸÜŸä',
                'royal-blue': 'üî¥ ÿßŸÑÿ£ÿ≤ÿ±ŸÇ ÿßŸÑŸÖŸÑŸÉŸä'
            };
            
            const themeName = themeNames[theme] || theme;
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }

        // Ÿàÿ∏ŸäŸÅÿ© ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿ≥ÿ±Ÿäÿπ ÿ®ŸäŸÜ ÿßŸÑÿ´ŸäŸÖÿßÿ™
        function toggleThemeQuick() {
            const themes = [
                'dark', 'light', 'blue-dark', 'green-dark', 'orange-dark', 
                'purple-dark', 'red-dark', 'cyan-light', 'gold-light', 
                'pink-light', 'olive', 'royal-blue'
            ];
            
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const currentIndex = themes.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themes.length;
            const nextTheme = themes[nextIndex];
            
            changeTheme(nextTheme);
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸàÿ¨ŸàÿØÿ©
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) {
                themeSelect.value = nextTheme;
            }
        }

        // ŸÖÿ¨ŸÖŸàÿπÿßÿ™ ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿßŸÑŸÖÿ≠ÿØÿØÿ© ŸÖÿ≥ÿ®ŸÇÿßŸã
        const colorSchemes = {
            default: {
                primary: '#6366f1',
                secondary: '#8b5cf6',
                success: '#10b981',
                warning: '#f59e0b',
                danger: '#ef4444',
                info: '#3b82f6'
            },
            blue: {
                primary: '#3b82f6',
                secondary: '#2563eb',
                success: '#10b981',
                warning: '#f59e0b',
                danger: '#ef4444',
                info: '#0ea5e9'
            },
            green: {
                primary: '#10b981',
                secondary: '#059669',
                success: '#22c55e',
                warning: '#f59e0b',
                danger: '#ef4444',
                info: '#3b82f6'
            },
            orange: {
                primary: '#f97316',
                secondary: '#ea580c',
                success: '#10b981',
                warning: '#fb923c',
                danger: '#ef4444',
                info: '#3b82f6'
            },
            red: {
                primary: '#ef4444',
                secondary: '#dc2626',
                success: '#10b981',
                warning: '#f59e0b',
                danger: '#f87171',
                info: '#3b82f6'
            },
            purple: {
                primary: '#a855f7',
                secondary: '#9333ea',
                success: '#10b981',
                warning: '#f59e0b',
                danger: '#ef4444',
                info: '#3b82f6'
            },
            cyan: {
                primary: '#06b6d4',
                secondary: '#0891b2',
                success: '#10b981',
                warning: '#f59e0b',
                danger: '#ef4444',
                info: '#0ea5e9'
            },
            amber: {
                primary: '#f59e0b',
                secondary: '#d97706',
                success: '#10b981',
                warning: '#fbbf24',
                danger: '#ef4444',
                info: '#3b82f6'
            },
            teal: {
                primary: '#14b8a6',
                secondary: '#0d9488',
                success: '#10b981',
                warning: '#f59e0b',
                danger: '#ef4444',
                info: '#3b82f6'
            }
        };

        // ŸÖÿπÿßŸäŸÜÿ© ŸÖÿ¨ŸÖŸàÿπÿ© ÿßŸÑÿ£ŸÑŸàÿßŸÜ
        function previewColorScheme(scheme) {
            const colors = colorSchemes[scheme] || colorSchemes.default;
            applyCustomColors(colors);
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }

        // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿßŸÑŸÖÿÆÿµÿµÿ©
        function applyCustomColors(colors) {
            const root = document.documentElement;
            
            root.style.setProperty('--primary-color', colors.primary);
            root.style.setProperty('--secondary-color', colors.secondary);
            root.style.setProperty('--success-color', colors.success);
            root.style.setProperty('--warning-color', colors.warning);
            root.style.setProperty('--danger-color', colors.danger);
            root.style.setProperty('--info-color', colors.info);
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ÿØÿ±ÿ¨ÿßÿ™
            root.style.setProperty('--primary-gradient', `linear-gradient(135deg, ${colors.primary} 0%, ${colors.secondary} 100%)`);
            root.style.setProperty('--success-gradient', `linear-gradient(135deg, ${colors.success} 0%, ${adjustColor(colors.success, -20)} 100%)`);
            root.style.setProperty('--warning-gradient', `linear-gradient(135deg, ${colors.warning} 0%, ${adjustColor(colors.warning, -20)} 100%)`);
            root.style.setProperty('--danger-gradient', `linear-gradient(135deg, ${colors.danger} 0%, ${adjustColor(colors.danger, -20)} 100%)`);
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ŸÇŸàŸÑ ÿßŸÑÿ£ŸÑŸàÿßŸÜ
            updateColorInputs(colors);
            
            // ÿ≠ŸÅÿ∏ ŸÅŸä localStorage
            localStorage.setItem('customColors', JSON.stringify(colors));
            
            console.log('üé® ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿßŸÑŸÖÿÆÿµÿµÿ©:', colors);
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ŸÇŸàŸÑ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ£ŸÑŸàÿßŸÜ
        function updateColorInputs(colors) {
            if (document.getElementById('primaryColorPicker')) {
                document.getElementById('primaryColorPicker').value = colors.primary;
                document.getElementById('primaryColorInput').value = colors.primary;
            }
            if (document.getElementById('secondaryColorPicker')) {
                document.getElementById('secondaryColorPicker').value = colors.secondary;
                document.getElementById('secondaryColorInput').value = colors.secondary;
            }
            if (document.getElementById('successColorPicker')) {
                document.getElementById('successColorPicker').value = colors.success;
                document.getElementById('successColorInput').value = colors.success;
            }
            if (document.getElementById('warningColorPicker')) {
                document.getElementById('warningColorPicker').value = colors.warning;
                document.getElementById('warningColorInput').value = colors.warning;
            }
            if (document.getElementById('dangerColorPicker')) {
                document.getElementById('dangerColorPicker').value = colors.danger;
                document.getElementById('dangerColorInput').value = colors.danger;
            }
            if (document.getElementById('infoColorPicker')) {
                document.getElementById('infoColorPicker').value = colors.info;
                document.getElementById('infoColorInput').value = colors.info;
            }
        }

        // Ÿàÿ∏ŸäŸÅÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑÿ™ÿπÿØŸäŸÑ ÿ≥ÿ∑Ÿàÿπ ÿßŸÑŸÑŸàŸÜ
        function adjustColor(color, amount) {
            const num = parseInt(color.replace('#', ''), 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
        }

        // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
        function resetDefaultColors() {
            if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©ÿü')) {
                applyCustomColors(colorSchemes.default);
                const colorSchemeSelect = document.getElementById('colorSchemeSelect');
                if (colorSchemeSelect) colorSchemeSelect.value = 'default';
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        // ÿ•ÿπÿØÿßÿØ ŸÖÿπÿßŸÑÿ¨ÿßÿ™ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ£ŸÑŸàÿßŸÜ
        function setupColorPickers() {
            // ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä
            ['primaryColorPicker', 'primaryColorInput'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        const value = this.value;
                        document.getElementById('primaryColorPicker').value = value;
                        document.getElementById('primaryColorInput').value = value;
                        updateSingleColor('primary', value);
                    });
                }
            });

            // ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ´ÿßŸÜŸàŸä
            ['secondaryColorPicker', 'secondaryColorInput'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        const value = this.value;
                        document.getElementById('secondaryColorPicker').value = value;
                        document.getElementById('secondaryColorInput').value = value;
                        updateSingleColor('secondary', value);
                    });
                }
            });

            // ŸÑŸàŸÜ ÿßŸÑŸÜÿ¨ÿßÿ≠
            ['successColorPicker', 'successColorInput'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        const value = this.value;
                        document.getElementById('successColorPicker').value = value;
                        document.getElementById('successColorInput').value = value;
                        updateSingleColor('success', value);
                    });
                }
            });

            // ŸÑŸàŸÜ ÿßŸÑÿ™ÿ≠ÿ∞Ÿäÿ±
            ['warningColorPicker', 'warningColorInput'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        const value = this.value;
                        document.getElementById('warningColorPicker').value = value;
                        document.getElementById('warningColorInput').value = value;
                        updateSingleColor('warning', value);
                    });
                }
            });

            // ŸÑŸàŸÜ ÿßŸÑÿÆÿ∑ÿ±
            ['dangerColorPicker', 'dangerColorInput'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        const value = this.value;
                        document.getElementById('dangerColorPicker').value = value;
                        document.getElementById('dangerColorInput').value = value;
                        updateSingleColor('danger', value);
                    });
                }
            });

            // ŸÑŸàŸÜ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™
            ['infoColorPicker', 'infoColorInput'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        const value = this.value;
                        document.getElementById('infoColorPicker').value = value;
                        document.getElementById('infoColorInput').value = value;
                        updateSingleColor('info', value);
                    });
                }
            });
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ŸÑŸàŸÜ Ÿàÿßÿ≠ÿØ
        function updateSingleColor(colorType, value) {
            const root = document.documentElement;
            root.style.setProperty(`--${colorType}-color`, value);
            
            // ÿ≠ŸÅÿ∏ ŸÅŸä localStorage
            const savedColors = JSON.parse(localStorage.getItem('customColors') || '{}');
            savedColors[colorType] = value;
            localStorage.setItem('customColors', JSON.stringify(savedColors));
        }

        // ÿ™ÿ∑ÿ®ŸäŸÇ ÿ≠ÿ¨ŸÖ ÿßŸÑÿÆÿ∑
        function applyFontSize(size) {
            const root = document.documentElement;
            switch(size) {
                case 'small':
                    root.style.fontSize = '13px';
                    break;
                case 'large':
                    root.style.fontSize = '17px';
                    break;
                default: // medium
                    root.style.fontSize = '15px';
            }
            console.log('üìê ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿ≠ÿ¨ŸÖ ÿßŸÑÿÆÿ∑:', size);
        }

        // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÑÿ∫ÿ©
        function applyLanguage(lang) {
            // ÿ≠ŸÅÿ∏ ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
            localStorage.setItem('currentLanguage', lang);
            
            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿßÿ™ÿ¨ÿßŸá
            if (lang === 'ar' || lang === 'ku') {
                document.documentElement.setAttribute('dir', 'rtl');
                document.body.classList.add('rtl');
                document.body.classList.remove('ltr');
            } else {
                document.documentElement.setAttribute('dir', 'ltr');
                document.body.classList.add('ltr');
                document.body.classList.remove('rtl');
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿµŸàÿµ ÿ≠ÿ≥ÿ® ÿßŸÑŸÑÿ∫ÿ©
            updateUILanguage(lang);
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ŸÜÿµŸàÿµ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
        function updateUILanguage(lang) {
            const translations = {
                ar: {
                    // ÿßŸÑŸÇŸàÿßÿ¶ŸÖ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
                    pos: 'ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ',
                    products: 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™',
                    inventory: 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿÆÿ≤ŸÜ',
                    invoices: 'ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±',
                    debts: 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿØŸäŸàŸÜ',
                    printer: 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ∑ÿßÿ®ÿπÿ©',
                    settings: 'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©',
                    
                    // ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ
                    search: 'ÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÜÿ™ÿ¨...',
                    total: 'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä',
                    discount: 'ÿßŸÑÿÆÿµŸÖ',
                    finalTotal: 'ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜŸáÿßÿ¶Ÿä',
                    checkout: 'ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ®Ÿäÿπ',
                    clearCart: 'ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ŸÑÿ©',
                    cart: 'ÿ≥ŸÑÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ',
                    addToCart: 'ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ©',
                    
                    // ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
                    save: 'ÿ≠ŸÅÿ∏',
                    cancel: 'ÿ•ŸÑÿ∫ÿßÿ°',
                    delete: 'ÿ≠ÿ∞ŸÅ',
                    edit: 'ÿ™ÿπÿØŸäŸÑ',
                    add: 'ÿ•ÿ∂ÿßŸÅÿ©',
                    back: 'ÿ±ÿ¨Ÿàÿπ',
                    
                    // ÿßŸÑÿ≠ŸÇŸàŸÑ
                    name: 'ÿßŸÑÿßÿ≥ŸÖ',
                    price: 'ÿßŸÑÿ≥ÿπÿ±',
                    quantity: 'ÿßŸÑŸÉŸÖŸäÿ©',
                    category: 'ÿßŸÑŸÅÿ¶ÿ©',
                    barcode: 'ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ',
                    description: 'ÿßŸÑŸàÿµŸÅ'
                },
                en: {
                    // Main Menus
                    pos: 'Point of Sale',
                    products: 'Products Management',
                    inventory: 'Inventory Management',
                    invoices: 'Invoices',
                    debts: 'Debts Management',
                    printer: 'Printer Settings',
                    settings: 'General Settings',
                    
                    // Point of Sale
                    search: 'Search for product...',
                    total: 'Total',
                    discount: 'Discount',
                    finalTotal: 'Final Total',
                    checkout: 'Checkout',
                    clearCart: 'Clear Cart',
                    cart: 'Shopping Cart',
                    addToCart: 'Add to Cart',
                    
                    // Buttons
                    save: 'Save',
                    cancel: 'Cancel',
                    delete: 'Delete',
                    edit: 'Edit',
                    add: 'Add',
                    back: 'Back',
                    
                    // Fields
                    name: 'Name',
                    price: 'Price',
                    quantity: 'Quantity',
                    category: 'Category',
                    barcode: 'Barcode',
                    description: 'Description'
                },
                ku: {
                    // ŸÑ€åÿ≥ÿ™€å ÿ≥€ïÿ±€ï⁄©€å
                    pos: 'ÿÆÿß⁄µ€å ŸÅÿ±€Üÿ¥ÿ™ŸÜ',
                    products: 'ÿ®€ï⁄ï€éŸà€ïÿ®ÿ±ÿØŸÜ€å ÿ®€ïÿ±Ÿá€ïŸÖ€ï⁄©ÿßŸÜ',
                    inventory: 'ÿ®€ï⁄ï€éŸà€ïÿ®ÿ±ÿØŸÜ€å ⁄©€Ü⁄Øÿß',
                    invoices: 'Ÿà€ïÿ≥⁄µ€ï⁄©ÿßŸÜ',
                    debts: 'ÿ®€ï⁄ï€éŸà€ïÿ®ÿ±ÿØŸÜ€å ŸÇ€ïÿ±ÿ≤€ï⁄©ÿßŸÜ',
                    printer: '⁄ï€é⁄©ÿÆÿ≥ÿ™ŸÜ€å ⁄ÜÿßŸæ⁄©€ïÿ±',
                    settings: '⁄ï€é⁄©ÿÆÿ≥ÿ™ŸÜ€ï⁄©ÿßŸÜ€å ⁄Øÿ¥ÿ™€å',
                    
                    // ÿÆÿß⁄µ€å ŸÅÿ±€Üÿ¥ÿ™ŸÜ
                    search: '⁄Ø€ï⁄ïÿßŸÜ ÿ®€Ü ÿ®€ïÿ±Ÿá€ïŸÖ...',
                    total: '⁄©€Ü€å ⁄Øÿ¥ÿ™€å',
                    discount: 'ÿØÿßÿ¥⁄©ÿßŸÜÿØŸÜ',
                    finalTotal: '⁄©€Ü€å ⁄©€Üÿ™ÿß€å€å',
                    checkout: 'ÿ™€ïŸàÿßŸà⁄©ÿ±ÿØŸÜ€å ŸÅÿ±€Üÿ¥ÿ™ŸÜ',
                    clearCart: 'ÿ≥⁄ï€åŸÜ€ïŸà€ï€å ÿ≥€ïÿ®€ïÿ™€ï',
                    cart: 'ÿ≥€ïÿ®€ïÿ™€ï€å ⁄©⁄ï€åŸÜ',
                    addToCart: 'ÿ≤€åÿßÿØ⁄©ÿ±ÿØŸÜ ÿ®€Ü ÿ≥€ïÿ®€ïÿ™€ï',
                    
                    // ÿØŸà⁄ØŸÖ€ï⁄©ÿßŸÜ
                    save: 'Ÿæÿßÿ¥€ï⁄©€ïŸàÿ™⁄©ÿ±ÿØŸÜ',
                    cancel: 'Ÿá€ï⁄µŸà€ïÿ¥ÿßŸÜÿØŸÜ€ïŸà€ï',
                    delete: 'ÿ≥⁄ï€åŸÜ€ïŸà€ï',
                    edit: 'ÿØ€ïÿ≥ÿ™⁄©ÿßÿ±€å⁄©ÿ±ÿØŸÜ',
                    add: 'ÿ≤€åÿßÿØ⁄©ÿ±ÿØŸÜ',
                    back: '⁄Ø€ï⁄ïÿßŸÜ€ïŸà€ï',
                    
                    // ÿÆÿßŸÜ€ï⁄©ÿßŸÜ
                    name: 'ŸÜÿßŸà',
                    price: 'ŸÜÿ±ÿÆ',
                    quantity: 'ÿ®⁄ï',
                    category: 'ÿ¨€Üÿ±',
                    barcode: 'ÿ®ÿßÿ±⁄©€ÜÿØ',
                    description: 'Ÿà€ïÿ≥ŸÅ'
                }
            };
            
            const texts = translations[lang] || translations.ar;
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿπŸÜŸàÿßŸÜ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ≠ÿßŸÑŸä
            const titleElement = document.getElementById('currentPageTitle');
            if (titleElement) {
                const currentPage = document.querySelector('.page.active')?.id;
                if (currentPage && texts[currentPage]) {
                    titleElement.textContent = texts[currentPage];
                }
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÜÿµŸàÿµ ÿßŸÑŸÇŸàÿßÿ¶ŸÖ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©
            document.querySelectorAll('.nav-link').forEach(link => {
                const onclick = link.getAttribute('onclick');
                if (onclick) {
                    const pageMatch = onclick.match(/showPage\('([^']+)'\)/);
                    if (pageMatch && texts[pageMatch[1]]) {
                        const span = link.querySelector('span');
                        if (span) span.textContent = texts[pageMatch[1]];
                    }
                }
            });
            
            // ÿ™ÿ≠ÿØŸäÿ´ placeholder ÿ≠ŸÇŸÑ ÿßŸÑÿ®ÿ≠ÿ´
            const searchInput = document.getElementById('productSearchInput');
            if (searchInput && texts.search) {
                searchInput.placeholder = texts.search;
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÜÿµŸàÿµ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ¥ÿßÿ¶ÿπÿ©
            document.querySelectorAll('button').forEach(btn => {
                const text = btn.textContent.trim();
                if (text.includes('ÿ≠ŸÅÿ∏') || text.includes('Save')) {
                    const icon = btn.querySelector('i');
                    btn.innerHTML = '';
                    if (icon) btn.appendChild(icon.cloneNode(true));
                    btn.appendChild(document.createTextNode(' ' + texts.save));
                } else if (text.includes('ÿ•ŸÑÿ∫ÿßÿ°') || text.includes('Cancel')) {
                    const icon = btn.querySelector('i');
                    btn.innerHTML = '';
                    if (icon) btn.appendChild(icon.cloneNode(true));
                    btn.appendChild(document.createTextNode(' ' + texts.cancel));
                }
            });
            
            console.log('üåê ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÑÿ∫ÿ©:', lang);
        }


        // ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
        function savePrintingSettings() {
            const printingSettings = {
                defaultPrinter: document.getElementById('defaultPrinterSelect')?.value || '',
                paperSize: document.getElementById('paperSizeSelect')?.value || '80mm',
                fontSize: document.getElementById('invoiceFontSize')?.value || 'medium',
                showLogo: document.getElementById('showLogoOnInvoice')?.checked !== false,
                showBarcode: document.getElementById('showBarcodeOnInvoice')?.checked !== false,
                showTax: document.getElementById('showTaxOnInvoice')?.checked !== false,
                footerNote: document.getElementById('invoiceFooterNote')?.value || '',
                autoPrint: document.getElementById('autoPrintInvoice')?.checked || false,
                printCopies: document.getElementById('printCopies')?.checked || false,
                openCashDrawer: document.getElementById('openCashDrawer')?.checked || false
            };

            localStorage.setItem('printingSettings', JSON.stringify(printingSettings));
            
            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
            applyPrintingSettings(printingSettings);
            
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }

        // ÿ™ÿ∑ÿ®ŸäŸÇ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
        function applyPrintingSettings(settings) {
            // ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸÅŸä ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿπÿßŸÖÿ©
            window.printingSettings = settings;
        }

        // ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ŸÖÿßŸÜ
        function saveSecuritySettings() {
            const securitySettings = {
                passwordEnabled: document.getElementById('enablePassword')?.checked || false,
                requirePasswordForDelete: document.getElementById('requirePasswordForDelete')?.checked !== false,
                requirePasswordForReports: document.getElementById('requirePasswordForReports')?.checked || false,
                requirePasswordForSettings: document.getElementById('requirePasswordForSettings')?.checked !== false,
                activityLogEnabled: document.getElementById('enableActivityLog')?.checked !== false,
                logRetentionPeriod: document.getElementById('logRetentionPeriod')?.value || 90
            };

            localStorage.setItem('securitySettings', JSON.stringify(securitySettings));
            
            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ŸÖÿßŸÜ
            applySecuritySettings(securitySettings);
            
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }

        // ÿ™ÿ∑ÿ®ŸäŸÇ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ŸÖÿßŸÜ
        function applySecuritySettings(settings) {
            // ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸÅŸä ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿπÿßŸÖÿ©
            window.securitySettings = settings;
        }

        // ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä
        function saveBackupSettings() {
            const backupSettings = {
                autoBackupEnabled: document.getElementById('autoBackupEnabled')?.checked || false,
                frequency: document.getElementById('autoBackupFrequency')?.value || 'daily',
                location: document.getElementById('backupLocation')?.value || ''
            };

            localStorage.setItem('backupSettings', JSON.stringify(backupSettings));
            
            // ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿ•ŸÑŸâ Firebase
            const autoFirebaseBackup = document.getElementById('autoFirebaseBackupEnabled')?.checked;
            if (autoFirebaseBackup !== undefined) {
                localStorage.setItem('autoFirebaseBackupEnabled', autoFirebaseBackup.toString());
            }
            
            showNotification('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
        }

        // ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÉÿßŸÖŸÑÿ©
        async function createFullBackup() {
            try {
                const backupData = {
                    version: '1.0.0',
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleString('en-US'),
                    type: 'full',
                    data: {
                        products: products || [],
                        categories: categories || [],
                        suppliers: suppliers || [],
                        sales: salesData || [],
                        debts: debtsData || [],
                        settings: {
                            store: JSON.parse(localStorage.getItem('storeSettings') || '{}'),
                            system: JSON.parse(localStorage.getItem('systemSettings') || '{}'),
                            printing: JSON.parse(localStorage.getItem('printingSettings') || '{}'),
                            security: JSON.parse(localStorage.getItem('securitySettings') || '{}'),
                            backup: JSON.parse(localStorage.getItem('backupSettings') || '{}')
                        }
                    },
                    stats: {
                        totalProducts: (products || []).length,
                        totalCategories: (categories || []).length,
                        totalSuppliers: (suppliers || []).length,
                        totalSales: (salesData || []).length,
                        totalDebts: (debtsData || []).length
                    }
                };

                const dataStr = JSON.stringify(backupData, null, 2);
                const fileName = `ŸÜÿ≥ÿÆÿ©_ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©_ŸÉÿßŸÖŸÑÿ©_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
                
                // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Electron API ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿ™ŸàŸÅÿ±ÿßŸã
                if (window.electronAPI && window.electronAPI.saveFile) {
                    const backupSettings = JSON.parse(localStorage.getItem('backupSettings') || '{}');
                    const result = await window.electronAPI.saveFile({
                        defaultPath: backupSettings.location || '',
                        fileName: fileName,
                        content: dataStr
                    });
                    
                    if (result.success) {
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    } else {
                        throw new Error('Failed to save via Electron');
                    }
                } else {
                    // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ÿßŸÑÿπÿßÿØŸäÿ©
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                }
                
                console.log('üì¶ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©:', backupData.stats);
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        // ŸÜÿ≥ÿÆ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸÇÿ∑
        function createDataBackup() {
            try {
                const backupData = {
                    version: '1.0.0',
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleString('en-US'),
                    type: 'data',
                    data: {
                        products: products || [],
                        categories: categories || [],
                        suppliers: suppliers || [],
                        sales: salesData || [],
                        debts: debtsData || []
                    },
                    stats: {
                        totalProducts: (products || []).length,
                        totalSales: (salesData || []).length,
                        totalDebts: (debtsData || []).length
                    }
                };

                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `ŸÜÿ≥ÿÆÿ©_ÿ®ŸäÿßŸÜÿßÿ™_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                console.log('üì¶ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', backupData.stats);
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÜÿ≥ÿÆ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        // ŸÜÿ≥ÿÆ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸÅŸÇÿ∑
        function createSettingsBackup() {
            try {
                const backupData = {
                    version: '1.0.0',
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleString('en-US'),
                    type: 'settings',
                    data: {
                        store: JSON.parse(localStorage.getItem('storeSettings') || '{}'),
                        system: JSON.parse(localStorage.getItem('systemSettings') || '{}'),
                        printing: JSON.parse(localStorage.getItem('printingSettings') || '{}'),
                        security: JSON.parse(localStorage.getItem('securitySettings') || '{}'),
                        backup: JSON.parse(localStorage.getItem('backupSettings') || '{}')
                    }
                };

                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `ŸÜÿ≥ÿÆÿ©_ÿ•ÿπÿØÿßÿØÿßÿ™_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                console.log('üì¶ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™');
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÜÿ≥ÿÆ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        // ÿßÿ≥ÿ™ÿπÿßÿØÿ© ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
        function handleBackupRestore(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿ≥ÿ™ÿπÿßÿØÿ© Ÿáÿ∞Ÿá ÿßŸÑŸÜÿ≥ÿÆÿ©ÿü ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©!')) return;

                    // 1. ÿßÿ≥ÿ™ÿπÿßÿØÿ© localStorage
                    if (backupData.localStorage) {
                        localStorage.clear();
                        for (const key in backupData.localStorage) {
                            try { localStorage.setItem(key, backupData.localStorage[key]); } catch (e) {}
                        }
                    }

                    // 2. ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ elementSdk
                    if (backupData.elementConfig && window.elementSdk && typeof window.elementSdk.importConfig === 'function') {
                        await window.elementSdk.importConfig(JSON.stringify(backupData.elementConfig));
                    }

                    // 3. ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™ indexedDB (dataSdk)
                    if (backupData.indexedDB && window.dataSdk && typeof window.dataSdk.importData === 'function') {
                        // ÿ≠ÿØÿØ ŸÜŸàÿπ ÿßŸÑŸÜÿ≥ÿÆÿ©: ŸÉÿßŸÖŸÑÿ© ÿ£ŸÖ ÿßŸÜÿ™ŸÇÿßÿ¶Ÿäÿ©
                        let dataArr = [];
                        if (backupData.indexedDB.all) {
                            dataArr = backupData.indexedDB.all;
                        } else {
                            // ÿßŸÜÿ™ŸÇÿßÿ¶Ÿäÿ©: ÿØŸÖÿ¨ ŸÉŸÑ ŸÖÿß ŸáŸà ŸÖŸàÿ¨ŸàÿØ
                            ['products','invoices','debts','payments'].forEach(type => {
                                if (Array.isArray(backupData.indexedDB[type])) dataArr = dataArr.concat(backupData.indexedDB[type]);
                            });
                        }
                        if (dataArr.length > 0) {
                            await window.dataSdk.clearAll();
                            await window.dataSdk.importData(JSON.stringify(dataArr));
                        }
                    }

                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    setTimeout(() => location.reload(), 1500);
                } catch (error) {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        // ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑ ÿßŸÑŸÖÿµŸÜÿπ - ÿ≠ÿ∞ŸÅ ÿ¥ÿßŸÖŸÑ ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        async function confirmFactoryReset() {
            const confirmText = '‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ± ÿÆÿ∑Ÿäÿ± ÿ¨ÿØÿßŸã!\n\n' +
                               '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' +
                               'üóëÔ∏è ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ:\n' +
                               '‚Ä¢ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸàÿßŸÑŸÅÿ¶ÿßÿ™\n' +
                               '‚Ä¢ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸàÿ±ÿØŸäŸÜ\n' +
                               '‚Ä¢ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ŸàÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±\n' +
                               '‚Ä¢ ÿ¨ŸÖŸäÿπ ÿßŸÑÿØŸäŸàŸÜ ŸàÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑\n' +
                               '‚Ä¢ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸàÿßŸÑÿ™ÿÆÿµŸäÿµÿßÿ™\n' +
                               '‚Ä¢ ÿ≥ŸÑÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ ŸàÿßŸÑŸÖÿ≥ŸàÿØÿßÿ™\n' +
                               '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' +
                               '‚úÖ ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ŸÄ:\n' +
                               '‚Ä¢ ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ (UID + Secret)\n' +
                               '‚Ä¢ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ\n' +
                               '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n' +
                               '‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞Ÿá ÿßŸÑÿπŸÖŸÑŸäÿ©!\n\n' +
                               'ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ 100% ŸÖŸÜ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü';
            
            if (!confirm(confirmText)) return;
            if (!confirm('‚ö†Ô∏è ÿ™ÿ£ŸÉŸäÿØ ÿ´ÿßŸÜŸä:\n\nŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ™ŸÖÿßŸÖÿßŸã ŸÖŸÜ ÿ≠ÿ∞ŸÅ ŸÉŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿü\nÿ≥Ÿäÿµÿ®ÿ≠ ÿßŸÑŸÉÿßÿ¥Ÿäÿ± ŸÅÿßÿ±ÿ∫ÿßŸã ÿ™ŸÖÿßŸÖÿßŸã!')) return;
            if (!confirm('‚ö†Ô∏è ÿ™ÿ£ŸÉŸäÿØ ŸÜŸáÿßÿ¶Ÿä:\n\nÿ¢ÿÆÿ± ŸÅÿ±ÿµÿ© ŸÑŸÑÿ™ÿ±ÿßÿ¨ÿπ!\nÿßÿ∂ÿ∫ÿ∑ ŸÖŸàÿßŸÅŸÇ ŸÑÿ≠ÿ∞ŸÅ ŸÉŸÑ ÿ¥Ÿäÿ° ÿßŸÑÿ¢ŸÜ!')) return;
            
            try {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                
                // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÇÿ®ŸÑ ÿßŸÑÿ≠ÿ∞ŸÅ
                const savedUID = localStorage.getItem('app_uid');
                const savedSecret = localStorage.getItem('app_secret');
                
                if (!savedUID) {
                    throw new Error('ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿπÿ±ŸÅ ŸÖÿ≥ÿ™ÿÆÿØŸÖ! ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã.');
                }
                
                console.log('üíæ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ®: UID ŸÖŸàÿ¨ŸàÿØ');
                
                // 1. ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase (ŸÖÿπ Timeout)
                const isOnline = navigator.onLine;
                console.log('ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ:', isOnline ? '‚úÖ ŸÖÿ™ÿµŸÑ' : '‚ö†Ô∏è ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ');
                
                if (isOnline && window.database) {
                    console.log('üóëÔ∏è ÿ®ÿØÿ° ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase...');
                    
                    try {
                        // ÿ•ÿ∂ÿßŸÅÿ© timeout ŸÑŸÑÿ≠ÿ∞ŸÅ ŸÖŸÜ Firebase (5 ÿ´ŸàÿßŸÜŸä)
                        await Promise.race([
                            (async () => {
                                // ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿµŸÅŸàŸÅÿ© ŸÖŸÜ ŸàÿπŸàÿØ ÿßŸÑÿ≠ÿ∞ŸÅ
                                const deletePromises = [
                                    database.ref(`users/${savedUID}/products`).remove(),
                                    database.ref(`users/${savedUID}/sales`).remove(),
                                    database.ref(`users/${savedUID}/debts`).remove(),
                                    database.ref(`users/${savedUID}/activities`).remove(),
                                    database.ref(`users/${savedUID}/suppliers`).remove(),
                                    database.ref(`users/${savedUID}/categories`).remove(),
                                    database.ref(`users/${savedUID}/settings`).remove()
                                ];
                                
                                // ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ¨ŸÖŸäÿπ ÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ≠ÿ∞ŸÅ
                                await Promise.all(deletePromises);
                                
                                console.log('‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase ÿ®ŸÜÿ¨ÿßÿ≠');
                                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                            })(),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('timeout')), 5000)
                            )
                        ]);
                        
                    } catch (firebaseError) {
                        if (firebaseError.message === 'timeout') {
                            console.warn('‚ö†Ô∏è ÿßŸÜÿ™Ÿáÿ™ ŸÖŸáŸÑÿ© ÿßŸÑÿ≠ÿ∞ŸÅ ŸÖŸÜ Firebase - ÿßŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ÿ®ÿßŸÑÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑŸä');
                            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                        } else {
                            console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase:', firebaseError);
                            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                        }
                        // ŸÜÿ≥ÿ™ŸÖÿ± ŸÅŸä ÿßŸÑÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑŸä ÿ≠ÿ™Ÿâ ŸÑŸà ŸÅÿ¥ŸÑ Firebase
                    }
                } else {
                    if (!isOnline) {
                        console.warn('‚ö†Ô∏è ŸÑÿß ŸäŸàÿ¨ÿØ ÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ - ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑŸä ŸÅŸÇÿ∑');
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    } else {
                        console.warn('‚ö†Ô∏è Firebase ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ - ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑŸä ŸÅŸÇÿ∑');
                    }
                }
                
                // 2. ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©
                console.log('üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™...');
                products = [];
                categories = [];
                suppliers = [];
                salesData = [];
                debtsData = [];
                cart = [];
                cartItems = [];
                
                // 3. ÿ≠ÿ∞ŸÅ **ÿ¨ŸÖŸäÿπ** ŸÖŸÅÿßÿ™Ÿäÿ≠ LocalStorage ŸÖÿß ÿπÿØÿß ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ®
                console.log('üóëÔ∏è ÿ™ŸÜÿ∏ŸäŸÅ LocalStorage ÿ®ÿßŸÑŸÉÿßŸÖŸÑ...');
                const keysToKeep = ['app_uid', 'app_secret'];
                
                // ÿ≠ÿ∞ŸÅ ŸÉŸÑ ŸÖŸÅÿ™ÿßÿ≠ ŸÖÿß ÿπÿØÿß ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿßÿ™
                Object.keys(localStorage).forEach(key => {
                    if (!keysToKeep.includes(key)) {
                        console.log(`   ‚îú‚îÄ ÿ≠ÿ∞ŸÅ: ${key}`);
                        localStorage.removeItem(key);
                    }
                });
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÑŸÑÿ™ÿ£ŸÉŸäÿØ
                if (savedUID) localStorage.setItem('app_uid', savedUID);
                if (savedSecret) localStorage.setItem('app_secret', savedSecret);
                
                // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿµŸÅŸàŸÅÿßÿ™ ÿßŸÑŸÅÿßÿ±ÿ∫ÿ© ÿ®ÿ¥ŸÉŸÑ ÿµÿ±Ÿäÿ≠
                localStorage.setItem('products', '[]');
                localStorage.setItem('categories', '[]');
                localStorage.setItem('suppliers', '[]');
                localStorage.setItem('salesData', '[]');
                localStorage.setItem('debtsData', '[]');
                localStorage.setItem('cartItems', '[]');
                localStorage.setItem('cart', '[]');
                
                // ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÑÿßŸÖÿ© ÿ£ŸÜ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ™Ÿá (ŸÑŸÖŸÜÿπ ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©)
                localStorage.setItem('appInitialized', 'true');
                localStorage.setItem('factoryResetDone', 'true');
                
                console.log('‚úÖ ÿ™ŸÖ ÿ™ŸÜÿ∏ŸäŸÅ LocalStorage ŸÖÿπ ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ®');
                
                // 4. ÿ≠ÿ∞ŸÅ **ÿ¨ŸÖŸäÿπ** ŸÇŸàÿßÿπÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ IndexedDB ÿ®ÿ¥ŸÉŸÑ ÿ¥ÿßŸÖŸÑ
                console.log('üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ŸÇŸàÿßÿπÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ IndexedDB...');
                
                try {
                    // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿ¨ŸÖŸäÿπ ŸÇŸàÿßÿπÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                    if (indexedDB.databases) {
                        const allDatabases = await indexedDB.databases();
                        console.log(`üìã ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${allDatabases.length} ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™`);
                        
                        for (const db of allDatabases) {
                            if (db.name) {
                                console.log(`   ‚îú‚îÄ ÿ≠ÿ∞ŸÅ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ${db.name}`);
                                await new Promise((resolve) => {
                                    const deleteRequest = indexedDB.deleteDatabase(db.name);
                                    
                                    // ÿ•ÿ∂ÿßŸÅÿ© timeout ŸÑÿπŸÖŸÑŸäÿ© ÿßŸÑÿ≠ÿ∞ŸÅ (3 ÿ´ŸàÿßŸÜŸä ŸÑŸÉŸÑ ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™)
                                    const timeout = setTimeout(() => {
                                        console.warn(`   ‚ö†Ô∏è timeout: ${db.name}`);
                                        resolve();
                                    }, 3000);
                                    
                                    deleteRequest.onsuccess = () => {
                                        clearTimeout(timeout);
                                        console.log(`   ‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ: ${db.name}`);
                                        resolve();
                                    };
                                    deleteRequest.onerror = () => {
                                        clearTimeout(timeout);
                                        console.warn(`   ‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ: ${db.name}`);
                                        resolve();
                                    };
                                    deleteRequest.onblocked = () => {
                                        clearTimeout(timeout);
                                        console.warn(`   ‚ö†Ô∏è ŸÖÿ≠ÿ¨Ÿàÿ®: ${db.name}`);
                                        resolve();
                                    };
                                });
                            }
                        }
                    } else {
                        // ÿÆÿ∑ÿ© ÿ®ÿØŸäŸÑÿ©: ÿ≠ÿ∞ŸÅ ŸÇŸàÿßÿπÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿπÿ±ŸàŸÅÿ©
                        const knownDatabases = [
                            'POSSystemDB', 'POSDatabase', 'posDB', 'productsDB', 'salesDB', 'debtsDB', 
                            'categoriesDB', 'suppliersDB', 'cashierDB', 'invoicesDB',
                            'localforage', 'firebaseLocalStorageDb', '_pouch_', 'PouchDB'
                        ];
                        
                        for (const dbName of knownDatabases) {
                            await new Promise((resolve) => {
                                const deleteRequest = indexedDB.deleteDatabase(dbName);
                                
                                // ÿ•ÿ∂ÿßŸÅÿ© timeout
                                const timeout = setTimeout(() => resolve(), 3000);
                                
                                deleteRequest.onsuccess = () => {
                                    clearTimeout(timeout);
                                    console.log(`   ‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ: ${dbName}`);
                                    resolve();
                                };
                                deleteRequest.onerror = () => {
                                    clearTimeout(timeout);
                                    resolve();
                                };
                                deleteRequest.onblocked = () => {
                                    clearTimeout(timeout);
                                    resolve();
                                };
                            });
                        }
                    }
                    
                    console.log('‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ŸÇŸàÿßÿπÿØ ÿ®ŸäÿßŸÜÿßÿ™ IndexedDB');
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ IndexedDB:', error);
                    
                    // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ®ÿØŸäŸÑÿ©: ÿ≠ÿ∞ŸÅ ÿßŸÑŸÇŸàÿßÿπÿØ ÿßŸÑŸÖÿπÿ±ŸàŸÅÿ©
                    const databases = ['POSSystemDB', 'POSDatabase', 'posDB', 'productsDB', 'salesDB', 'debtsDB', 'categoriesDB', 'suppliersDB'];
                    
                    for (const dbName of databases) {
                        try {
                            await new Promise((resolve) => {
                                const deleteRequest = indexedDB.deleteDatabase(dbName);
                                
                                // timeout ŸÑŸÉŸÑ ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™
                                const timeout = setTimeout(() => resolve(), 3000);
                                
                                deleteRequest.onsuccess = () => {
                                    clearTimeout(timeout);
                                    console.log(`‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ: ${dbName}`);
                                    resolve();
                                };
                                deleteRequest.onerror = () => {
                                    clearTimeout(timeout);
                                    console.warn(`‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ${dbName}`);
                                    resolve();
                                };
                                deleteRequest.onblocked = () => {
                                    console.warn(`‚ö†Ô∏è ${dbName} ŸÖÿ≠ÿ¨Ÿàÿ®`);
                                    resolve();
                                };
                            });
                        } catch (error) {
                            console.warn(`‚ö†Ô∏è ÿßÿ≥ÿ™ÿ´ŸÜÿßÿ° ŸÅŸä ÿ≠ÿ∞ŸÅ ${dbName}:`, error);
                        }
                    }
                }
                
                // 5. ÿ≠ÿ∞ŸÅ SessionStorage
                console.log('üóëÔ∏è ÿ≠ÿ∞ŸÅ SessionStorage...');
                sessionStorage.clear();
                
                // 6. ÿ≠ÿ∞ŸÅ Cache API
                console.log('üóëÔ∏è ÿ≠ÿ∞ŸÅ Cache...');
                if ('caches' in window) {
                    try {
                        const cacheNames = await caches.keys();
                        await Promise.all(cacheNames.map(name => caches.delete(name)));
                        console.log('‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ Cache');
                    } catch (error) {
                        console.warn('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ Cache:', error);
                    }
                }
                
                // 7. ÿ™ŸÜÿ∏ŸäŸÅ DOM ŸàÿßŸÑŸàÿßÿ¨Ÿáÿ© ÿ®ÿßŸÑŸÉÿßŸÖŸÑ
                console.log('üóëÔ∏è ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ÿ®ÿßŸÑŸÉÿßŸÖŸÑ...');
                
                // ÿ™ŸÜÿ∏ŸäŸÅ ÿ¨ŸÖŸäÿπ ÿ≠ŸÇŸàŸÑ ÿßŸÑÿ•ÿØÿÆÿßŸÑ
                document.querySelectorAll('input[type="text"], input[type="search"], input[type="number"]').forEach(input => {
                    if (input.id !== 'app_uid' && input.id !== 'app_secret') {
                        input.value = '';
                    }
                });
                
                // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ≥ŸÑÿ©
                const cartSection = document.querySelector('.cart-items');
                if (cartSection) cartSection.innerHTML = '';
                
                // ÿ™ŸÜÿ∏ŸäŸÅ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
                const productsGrid = document.querySelector('.products-grid');
                if (productsGrid) productsGrid.innerHTML = '';
                
                // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
                const totalEl = document.getElementById('totalPrice');
                if (totalEl) totalEl.textContent = '0';
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπÿØÿßÿØÿßÿ™ ÿ•ŸÑŸâ ÿµŸÅÿ±
                document.querySelectorAll('[id$="Count"]').forEach(el => {
                    el.textContent = '0';
                });
                
                console.log('‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!');
                console.log('‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸàÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ');
                
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                
                // ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ£ŸÉŸäÿØ ŸÜŸáÿßÿ¶Ÿäÿ©
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                alert('‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!\n\n' +
                      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' +
                      'üóëÔ∏è ÿ™ŸÖ ÿ≠ÿ∞ŸÅ:\n' +
                      '‚Ä¢ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸàÿßŸÑŸÅÿ¶ÿßÿ™ (ÿßŸÑŸÖÿ≥ÿ™Ÿàÿ±ÿØÿ© ŸàÿßŸÑŸÖÿ≠ŸÑŸäÿ©)\n' +
                      '‚Ä¢ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ŸàÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±\n' +
                      '‚Ä¢ ÿ¨ŸÖŸäÿπ ÿßŸÑÿØŸäŸàŸÜ ŸàÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑\n' +
                      '‚Ä¢ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿÆÿµÿµÿ©\n\n' +
                      '‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ:\n' +
                      '‚Ä¢ ÿ≠ÿ≥ÿßÿ®ŸÉ Ÿàÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ\n' +
                      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n' +
                      'üîÑ ÿ≥Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ¢ŸÜ');
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
                window.location.href = window.location.href.split('?')[0];
                location.reload(true);
                
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑ ÿßŸÑŸÖÿµŸÜÿπ:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                alert('‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑ ÿßŸÑŸÖÿµŸÜÿπ:\n\n' + 
                      error.message + '\n\n' +
                      'Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ÿ£Ÿà ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿØÿπŸÖ ÿßŸÑŸÅŸÜŸä');
            }
        }

        // ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ© ŸÅŸÇÿ∑
        async function clearSampleData() {
            if (confirm('üßπ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ© ŸàÿßŸÑÿ®ÿØÿ° ÿ®ÿ™ÿ∑ÿ®ŸäŸÇ ŸÜÿ∏ŸäŸÅÿü\n\n‚úÖ ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ Ÿàÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ®')) {
                try {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    
                    // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ®
                    const savedUID = localStorage.getItem('app_uid');
                    const savedSecret = localStorage.getItem('app_secret');
                    
                    // ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase (ŸÖÿπ Timeout)
                    const isOnline = navigator.onLine;
                    
                    if (isOnline && savedUID && window.database) {
                        console.log('üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase...');
                        
                        try {
                            // ÿ•ÿ∂ÿßŸÅÿ© timeout ŸÑŸÑÿ≠ÿ∞ŸÅ ŸÖŸÜ Firebase (5 ÿ´ŸàÿßŸÜŸä)
                            await Promise.race([
                                (async () => {
                                    await database.ref(`users/${savedUID}/products`).remove();
                                    await database.ref(`users/${savedUID}/sales`).remove();
                                    await database.ref(`users/${savedUID}/debts`).remove();
                                    await database.ref(`users/${savedUID}/activities`).remove();
                                    await database.ref(`users/${savedUID}/suppliers`).remove();
                                    await database.ref(`users/${savedUID}/categories`).remove();
                                    console.log('‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase');
                                })(),
                                new Promise((_, reject) => 
                                    setTimeout(() => reject(new Error('timeout')), 5000)
                                )
                            ]);
                        } catch (error) {
                            if (error.message === 'timeout') {
                                console.warn('‚ö†Ô∏è ÿßŸÜÿ™Ÿáÿ™ ŸÖŸáŸÑÿ© ÿßŸÑÿ≠ÿ∞ŸÅ ŸÖŸÜ Firebase');
                            } else {
                                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase:', error);
                            }
                            // ÿßŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ÿ®ÿßŸÑÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑŸä
                        }
                    } else {
                        if (!isOnline) {
                            console.warn('‚ö†Ô∏è ŸÑÿß ŸäŸàÿ¨ÿØ ÿßÿ™ÿµÿßŸÑ - ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑŸä ŸÅŸÇÿ∑');
                        }
                    }
                    
                    // ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ© ŸÖŸÜ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™
                    products = [];
                    categories = [];
                    suppliers = [];
                    salesData = [];
                    debtsData = [];
                    cartItems = [];
                    
                    // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿßÿ±ÿ∫ÿ© ŸÅŸä LocalStorage
                    localStorage.setItem('products', JSON.stringify([]));
                    localStorage.setItem('categories', JSON.stringify([]));
                    localStorage.setItem('suppliers', JSON.stringify([]));
                    localStorage.setItem('salesData', JSON.stringify([]));
                    localStorage.setItem('debtsData', JSON.stringify([]));
                    localStorage.setItem('cartItems', JSON.stringify([]));
                    
                    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
                    updateAllViews();
                    renderCart();
                    
                    console.log('‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©');
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    
                    setTimeout(() => {
                        alert('‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!\n\n' +
                              'üìù ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ¢ŸÜ ŸÜÿ∏ŸäŸÅ Ÿàÿ¨ÿßŸáÿ≤ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ\n' +
                              '‚öôÔ∏è ÿ™ŸÖ ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ Ÿàÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ®');
                        location.reload();
                    }, 1000);
                    
                } catch (error) {
                    console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                }
            }
        }

        // ÿØŸàÿßŸÑ ÿ•ÿ∂ÿßŸÅŸäÿ©
        function refreshPrinters() {
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            // ŸáŸÜÿß ŸäŸÖŸÉŸÜ ÿ•ÿ∂ÿßŸÅÿ© ŸÉŸàÿØ ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ÿßÿ®ÿπÿßÿ™ ŸÖŸÜ ÿßŸÑŸÜÿ∏ÿßŸÖ
        }

        async function chooseBackupLocation() {
            if (window.electronAPI && window.electronAPI.selectDirectory) {
                const result = await window.electronAPI.selectDirectory();
                if (result && !result.canceled) {
                    const locationInput = document.getElementById('backupLocation');
                    if (locationInput) {
                        locationInput.value = result.filePaths[0];
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    }
                }
            } else {
                // ŸÅŸä ÿ≠ÿßŸÑÿ© ÿπÿØŸÖ ÿ™ŸàŸÅÿ± Electron API
                const locationInput = document.getElementById('backupLocation');
                if (locationInput) {
                    const path = prompt('ÿ£ÿØÿÆŸÑ ŸÖÿ≥ÿßÿ± ÿßŸÑŸÖÿ¨ŸÑÿØ ŸÑŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä:', locationInput.value || 'C:\\Backups');
                    if (path) {
                        locationInput.value = path;
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    }
                }
            }
        }

        function printTestPage() {
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            window.print();
        }

        function changePassword() {
            const current = document.getElementById('currentPassword')?.value;
            const newPass = document.getElementById('newPassword')?.value;
            const confirm = document.getElementById('confirmPassword')?.value;

            if (!current || !newPass || !confirm) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }

            if (newPass !== confirm) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }

            // ÿ≠ŸÅÿ∏ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± (Ÿäÿ¨ÿ® ÿ™ÿ¥ŸÅŸäÿ±Ÿáÿß ŸÅŸä ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ≠ŸÇŸäŸÇŸä)
            localStorage.setItem('appPassword', newPass);
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        function viewActivityLog() {
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            // ŸáŸÜÿß ŸäŸÖŸÉŸÜ ÿ•ÿ∂ÿßŸÅÿ© ÿµŸÅÿ≠ÿ© ÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ¥ÿßÿ∑ÿßÿ™
        }

        // ŸÖÿπÿßŸÑÿ¨ ÿ±ŸÅÿπ ÿßŸÑÿ¥ÿπÿßÿ± ŸÖÿπ ŸÖÿπÿßŸäŸÜÿ©
        function setupLogoPreview() {
            const logoInput = document.getElementById('settingsStoreLogo');
            if (logoInput) {
                logoInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            // ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿπÿßŸäŸÜÿ©
                            let preview = document.querySelector('.logo-preview');
                            if (!preview) {
                                preview = document.createElement('div');
                                preview.className = 'logo-preview';
                                preview.style.cssText = 'margin-top: 1rem; padding: 1rem; background: var(--theme-bg-hover); border-radius: 8px; text-align: center;';
                                logoInput.parentElement.appendChild(preview);
                            }
                            preview.innerHTML = `
                                <img src="${event.target.result}" style="max-width: 200px; max-height: 100px; border-radius: 8px;">
                                <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--success-color);">
                                    <i class="fas fa-check-circle"></i> ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ¥ÿπÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠
                                </p>
                            `;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }

        // ÿ™ŸÅÿπŸäŸÑ/ÿ•ŸÑÿ∫ÿßÿ° ÿ™ŸÅÿπŸäŸÑ ÿ≠ŸÇŸàŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
        document.addEventListener('DOMContentLoaded', async () => {
            const enablePasswordCheck = document.getElementById('enablePassword');
            const passwordFields = document.getElementById('passwordFields');
            
            if (enablePasswordCheck && passwordFields) {
                enablePasswordCheck.addEventListener('change', function() {
                    passwordFields.style.display = this.checked ? 'block' : 'none';
                });
            }

            // ÿ™ÿ≠ŸÖŸäŸÑ Ÿàÿ™ÿ∑ÿ®ŸäŸÇ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©
            loadAllSettings();
            
            // ÿ™ŸÅÿπŸäŸÑ ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ¥ÿπÿßÿ±
            setupLogoPreview();
            
            // ÿ•ÿπÿØÿßÿØ ŸÖŸÜÿ™ŸÇŸäÿßÿ™ ÿßŸÑÿ£ŸÑŸàÿßŸÜ
            setupColorPickers();
            
            // ÿ•ÿµŸÑÿßÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØŸäŸàŸÜ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
            if (typeof fixDebtsData === 'function' && debtsData && debtsData.length > 0) {
                console.log('üîß Running automatic debt data repair...');
                await fixDebtsData();
            }
        });

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
        function loadAllSettings() {
            loadStoreSettings();
            loadSystemSettings();
            loadPrintingSettings();
            loadSecuritySettings();
            loadBackupSettings();
        }

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ
        function loadSystemSettings() {
            const savedSettings = localStorage.getItem('systemSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÇŸäŸÖ ŸÅŸä ÿßŸÑŸÜŸÖÿßÿ∞ÿ¨
                if (document.getElementById('themeSelect')) document.getElementById('themeSelect').value = settings.theme || 'dark';
                if (document.getElementById('colorSchemeSelect')) document.getElementById('colorSchemeSelect').value = settings.colorScheme || 'default';
                if (document.getElementById('fontSizeSelect')) document.getElementById('fontSizeSelect').value = settings.fontSize || 'medium';
                if (document.getElementById('compactModeCheck')) document.getElementById('compactModeCheck').checked = settings.compactMode || false;
                if (document.getElementById('languageSelect')) document.getElementById('languageSelect').value = settings.language || 'ar';
                if (document.getElementById('dateFormatSelect')) document.getElementById('dateFormatSelect').value = settings.dateFormat || 'DD/MM/YYYY';
                if (document.getElementById('timeFormatSelect')) document.getElementById('timeFormatSelect').value = settings.timeFormat || '12';
                if (document.getElementById('itemsPerPageSelect')) document.getElementById('itemsPerPageSelect').value = settings.itemsPerPage || 25;
                if (document.getElementById('animationsCheck')) document.getElementById('animationsCheck').checked = settings.animations !== false;
                if (document.getElementById('autosaveCheck')) document.getElementById('autosaveCheck').checked = settings.autosave !== false;
                if (document.getElementById('barcodeSound')) document.getElementById('barcodeSound').checked = settings.barcodeSound !== false;
                if (document.getElementById('autoPrint')) document.getElementById('autoPrint').checked = settings.autoPrint || false;
                if (document.getElementById('clearCartAfterSale')) document.getElementById('clearCartAfterSale').checked = settings.clearCartAfterSale !== false;
                
                // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
                applySystemSettings(settings);
            }
        }


        // ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
        function loadPrintingSettings() {
            const savedSettings = localStorage.getItem('printingSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                
                if (document.getElementById('defaultPrinterSelect')) document.getElementById('defaultPrinterSelect').value = settings.defaultPrinter || '';
                if (document.getElementById('paperSizeSelect')) document.getElementById('paperSizeSelect').value = settings.paperSize || '80mm';
                if (document.getElementById('invoiceFontSize')) document.getElementById('invoiceFontSize').value = settings.fontSize || 'medium';
                if (document.getElementById('showLogoOnInvoice')) document.getElementById('showLogoOnInvoice').checked = settings.showLogo !== false;
                if (document.getElementById('showBarcodeOnInvoice')) document.getElementById('showBarcodeOnInvoice').checked = settings.showBarcode !== false;
                if (document.getElementById('showTaxOnInvoice')) document.getElementById('showTaxOnInvoice').checked = settings.showTax !== false;
                if (document.getElementById('invoiceFooterNote')) document.getElementById('invoiceFooterNote').value = settings.footerNote || '';
                if (document.getElementById('autoPrintInvoice')) document.getElementById('autoPrintInvoice').checked = settings.autoPrint || false;
                if (document.getElementById('printCopies')) document.getElementById('printCopies').checked = settings.printCopies || false;
                if (document.getElementById('openCashDrawer')) document.getElementById('openCashDrawer').checked = settings.openCashDrawer || false;
                
                // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
                applyPrintingSettings(settings);
            }
        }

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ŸÖÿßŸÜ
        function loadSecuritySettings() {
            const savedSettings = localStorage.getItem('securitySettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                
                if (document.getElementById('enablePassword')) document.getElementById('enablePassword').checked = settings.passwordEnabled || false;
                if (document.getElementById('requirePasswordForDelete')) document.getElementById('requirePasswordForDelete').checked = settings.requirePasswordForDelete !== false;
                if (document.getElementById('requirePasswordForReports')) document.getElementById('requirePasswordForReports').checked = settings.requirePasswordForReports || false;
                if (document.getElementById('requirePasswordForSettings')) document.getElementById('requirePasswordForSettings').checked = settings.requirePasswordForSettings !== false;
                if (document.getElementById('enableActivityLog')) document.getElementById('enableActivityLog').checked = settings.activityLogEnabled !== false;
                if (document.getElementById('logRetentionPeriod')) document.getElementById('logRetentionPeriod').value = settings.logRetentionPeriod || 90;
                
                // ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ÿ≠ŸÇŸàŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
                const passwordFields = document.getElementById('passwordFields');
                if (passwordFields) {
                    passwordFields.style.display = settings.passwordEnabled ? 'block' : 'none';
                }
                
                // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
                applySecuritySettings(settings);
            }
        }

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä
        function loadBackupSettings() {
            const savedSettings = localStorage.getItem('backupSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                
                if (document.getElementById('autoBackupEnabled')) document.getElementById('autoBackupEnabled').checked = settings.autoBackupEnabled || false;
                if (document.getElementById('autoBackupFrequency')) document.getElementById('autoBackupFrequency').value = settings.frequency || 'daily';
                if (document.getElementById('backupLocation')) document.getElementById('backupLocation').value = settings.location || '';
            }
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿ•ŸÑŸâ Firebase
            const autoFirebaseBackup = localStorage.getItem('autoFirebaseBackupEnabled');
            if (document.getElementById('autoFirebaseBackupEnabled')) {
                document.getElementById('autoFirebaseBackupEnabled').checked = autoFirebaseBackup !== 'false';
            }
        }

        // ÿØŸàÿßŸÑ ÿßŸÑÿ™ŸàÿßŸÅŸÇŸäÿ© ŸÑŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑŸÇÿØŸäŸÖÿ©
        function createBackup() {
            createFullBackup();
        }

        function restoreBackup() {
            document.getElementById('backupFileInput')?.click();
        }

        function resetSystem() {
            confirmFactoryReset();
        }

        // ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        async function exportData(type, format) {
            let data = [];
            let filename = '';
            
            // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜŸàÿπ
            switch(type) {
                case 'products':
                    data = products;
                    filename = 'ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™';
                    break;
                case 'inventory':
                    data = products;
                    filename = 'ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ';
                    break;
                case 'invoices':
                    data = salesData;
                    filename = 'ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±';
                    break;
                case 'debts':
                    data = debtsData;
                    filename = 'ÿßŸÑÿØŸäŸàŸÜ';
                    break;
                default:
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    return;
            }
            
            if (data.length === 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            try {
                switch(format) {
                    case 'json':
                        exportToJSON(data, filename);
                        break;
                    case 'excel':
                        exportToExcel(data, filename, type);
                        break;
                    case 'pdf':
                        exportToPDF(data, filename, type);
                        break;
                    default:
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                }
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿµÿØŸäÿ±:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }
        
        // ÿ™ÿµÿØŸäÿ± ÿ•ŸÑŸâ JSON
        function exportToJSON(data, filename) {
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${filename}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }
        
        // ÿ™ÿµÿØŸäÿ± ÿ•ŸÑŸâ Excel
        function exportToExcel(data, filename, type) {
            if (typeof XLSX === 'undefined') {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            let worksheetData = [];
            
            // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜŸàÿπ
            if (type === 'products' || type === 'inventory') {
                worksheetData = data.map(item => ({
                    'ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ': item.product_barcode || '',
                    'ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨': item.product_name || '',
                    'ÿßŸÑÿ™ÿµŸÜŸäŸÅ': categories.find(c => c.category_id === item.product_category)?.category_name || '',
                    'ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ': item.product_price_retail || 0,
                    'ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°': item.product_cost_retail || 0,
                    'ÿßŸÑŸÉŸÖŸäÿ©': item.stock_quantity || 0,
                    'ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ': item.min_stock || 0,
                    'ÿßŸÑŸÖŸàÿ±ÿØ': item.supplier || ''
                }));
            } else if (type === 'invoices') {
                worksheetData = data.map(item => ({
                    'ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©': item.invoice_id || '',
                    'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ': new Date(item.timestamp).toLocaleDateString('en-GB'),
                    'ÿßŸÑÿπŸÖŸäŸÑ': item.customer_name || 'ÿπŸÖŸäŸÑ ŸÜŸÇÿØŸä',
                    'ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä': item.final_total || 0,
                    'ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ': item.payment_method || '',
                    'ÿßŸÑÿÆÿµŸÖ': item.discount || 0,
                    'ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©': item.tax || 0
                }));
            } else if (type === 'debts') {
                worksheetData = data.map(item => ({
                    'ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ': item.customer_name || '',
                    'ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ': item.customer_phone || '',
                    'ÿßŸÑÿπŸÜŸàÿßŸÜ': item.customer_address || '',
                    'ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä': item.total_amount || item.final_total || 0,
                    'ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä': item.remaining_amount || 0,
                    'ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä': item.monthly_amount || 0,
                    'ÿπÿØÿØ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑': item.installment_months || 0,
                    'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ': new Date(item.due_date).toLocaleDateString('en-GB')
                }));
            }
            
            const worksheet = XLSX.utils.json_to_sheet(worksheetData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, filename);
            XLSX.writeFile(workbook, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }
        
        // ÿ™ÿµÿØŸäÿ± ÿ•ŸÑŸâ PDF
        function exportToPDF(data, filename, type) {
            if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            const { jsPDF } = jspdf;
            const doc = new jsPDF();
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿØÿπŸÖ ŸÑŸÑÿπÿ±ÿ®Ÿäÿ© (ŸäŸÖŸÉŸÜ ÿ™ÿ≠ÿ≥ŸäŸÜŸá ÿ®ÿ•ÿ∂ÿßŸÅÿ© ÿÆÿ∑ ÿπÿ±ÿ®Ÿä)
            let headers = [];
            let rows = [];
            
            if (type === 'products' || type === 'inventory') {
                headers = [['Barcode', 'Name', 'Category', 'Price', 'Cost', 'Stock', 'Min', 'Supplier']];
                rows = data.map(item => [
                    item.product_barcode || '',
                    item.product_name || '',
                    categories.find(c => c.category_id === item.product_category)?.category_name || '',
                    formatCurrency(item.product_price_retail || 0),
                    formatCurrency(item.product_cost_retail || 0),
                    item.stock_quantity || 0,
                    item.min_stock || 0,
                    item.supplier || ''
                ]);
            } else if (type === 'invoices') {
                headers = [['Invoice', 'Date', 'Customer', 'Total', 'Method', 'Discount', 'Tax']];
                rows = data.map(item => [
                    item.invoice_id || '',
                    new Date(item.timestamp).toLocaleDateString('en-GB'),
                    item.customer_name || 'Cash',
                    formatCurrency(item.final_total || 0),
                    item.payment_method || '',
                    formatCurrency(item.discount || 0),
                    formatCurrency(item.tax || 0)
                ]);
            } else if (type === 'debts') {
                headers = [['Customer', 'Phone', 'Total', 'Remaining', 'Monthly', 'Months', 'Due Date']];
                rows = data.map(item => [
                    item.customer_name || '',
                    item.customer_phone || '',
                    formatCurrency(item.total_amount || item.final_total || 0),
                    formatCurrency(item.remaining_amount || 0),
                    formatCurrency(item.monthly_amount || 0),
                    item.installment_months || 0,
                    new Date(item.due_date).toLocaleDateString('en-GB')
                ]);
            }
            
            doc.autoTable({
                head: headers,
                body: rows,
                startY: 20,
                styles: { font: 'helvetica', fontSize: 8 }
            });
            
            doc.save(`${filename}_${new Date().toISOString().split('T')[0]}.pdf`);
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸäÿßŸÜÿ© - Maintenance Management System
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // ŸÖÿµŸÅŸàŸÅÿ© ÿ™ÿÆÿ≤ŸäŸÜ ÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑÿµŸäÿßŸÜÿ©
        let maintenanceData = JSON.parse(localStorage.getItem('maintenanceData')) || [];

        // ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿ¨Ÿáÿßÿ≤ ŸÑŸÑÿµŸäÿßŸÜÿ©
        function showAddMaintenanceModal() {
            // ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ± ÿßŸÑŸÖÿ™ŸàŸÅÿ±ÿ©
            const availableParts = sparePartsData.filter(part => part.quantity > 0);
            const partsOptions = availableParts.map(part => 
                `<option value="${part.id}" data-price="${part.sellPrice}">${part.name} - ${formatCurrency(part.sellPrice)} (ŸÖÿ™ŸàŸÅÿ±: ${part.quantity})</option>`
            ).join('');
            
            const modalHTML = `
                <div class="modal active" id="addMaintenanceModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 900px; width: 90%; max-height: 85vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2><i class="fas fa-tools"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿ¨Ÿáÿßÿ≤ ŸÑŸÑÿµŸäÿßŸÜÿ©</h2>
                            <button class="close-btn" onclick="closeMaintenanceModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="maintenanceForm" onsubmit="addMaintenance(event)">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                    <div class="form-group">
                                        <label><i class="fas fa-box"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ *</label>
                                        <input type="text" id="maintenanceProductName" class="form-control" required placeholder="ŸÖÿ´ÿßŸÑ: ŸÑÿßÿ®ÿ™Ÿàÿ® HP">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-building"></i> ÿßÿ≥ŸÖ ÿßŸÑÿ¥ÿ±ŸÉÿ© *</label>
                                        <input type="text" id="maintenanceCompanyName" class="form-control" required placeholder="ŸÖÿ´ÿßŸÑ: ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿ™ŸÇŸÜŸäÿ©">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-exclamation-triangle"></i> ÿßŸÑÿÆŸÑŸÑ ÿßŸÑŸÖŸàÿ¨ŸàÿØ *</label>
                                        <input type="text" id="maintenanceFault" class="form-control" required placeholder="ŸÖÿ´ÿßŸÑ: ÿ¥ÿßÿ¥ÿ© ŸÑÿß ÿ™ÿπŸÖŸÑ">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-money-bill"></i> ÿ≥ÿπÿ± ÿßŸÑÿµŸäÿßŸÜÿ© (ÿØŸäŸÜÿßÿ±) *</label>
                                        <input type="number" id="maintenancePrice" class="form-control" required min="0" step="1000" placeholder="ŸÖÿ´ÿßŸÑ: 50000">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-calendar-check"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ *</label>
                                        <input type="date" id="maintenanceReceiveDate" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-calendar-alt"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸÖÿ™ŸàŸÇÿπ *</label>
                                        <input type="date" id="maintenanceDeliveryDate" class="form-control" required>
                                    </div>
                                    
                                    <!-- ŸÇÿ≥ŸÖ ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ© -->
                                    <div class="form-group" style="grid-column: 1 / -1; background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                        <h4 style="color: var(--primary-color); margin-bottom: 1rem;">
                                            <i class="fas fa-cogs"></i> ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ©
                                        </h4>
                                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                            <button type="button" class="btn btn-sm btn-primary" onclick="togglePartSelectionMode('select')" id="selectModeBtn">
                                                <i class="fas fa-list"></i> ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
                                            </button>
                                            <button type="button" class="btn btn-sm btn-secondary" onclick="togglePartSelectionMode('manual')" id="manualModeBtn">
                                                <i class="fas fa-keyboard"></i> ÿ•ÿØÿÆÿßŸÑ ŸäÿØŸàŸä
                                            </button>
                                        </div>
                                        
                                        <!-- Ÿàÿ∂ÿπ ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© -->
                                        <div id="selectPartMode" style="display: block;">
                                            <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 0.5rem; align-items: end;">
                                                <div class="form-group" style="margin: 0;">
                                                    <label><i class="fas fa-cog"></i> ŸÇÿ∑ÿπÿ© ÿßŸÑÿ∫Ÿäÿßÿ±</label>
                                                    <select id="selectedSparePartId" class="form-control" onchange="updatePartPrice()">
                                                        <option value="">ÿßÿÆÿ™ÿ± ŸÇÿ∑ÿπÿ© ÿ∫Ÿäÿßÿ±</option>
                                                        ${partsOptions}
                                                    </select>
                                                </div>
                                                <div class="form-group" style="margin: 0;">
                                                    <label><i class="fas fa-layer-group"></i> ÿßŸÑŸÉŸÖŸäÿ©</label>
                                                    <input type="number" id="selectedPartQuantity" class="form-control" min="1" value="1" placeholder="1">
                                                </div>
                                                <button type="button" class="btn btn-success" onclick="addSelectedPart()" style="margin-bottom: 0;">
                                                    <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ©
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Ÿàÿ∂ÿπ ÿßŸÑÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸäÿØŸàŸä -->
                                        <div id="manualPartMode" style="display: none;">
                                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 0.5rem; align-items: end;">
                                                <div class="form-group" style="margin: 0;">
                                                    <label><i class="fas fa-cog"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ∑ÿπÿ©</label>
                                                    <input type="text" id="manualPartName" class="form-control" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ∑ÿπÿ©">
                                                </div>
                                                <div class="form-group" style="margin: 0;">
                                                    <label><i class="fas fa-money-bill"></i> ÿßŸÑÿ≥ÿπÿ±</label>
                                                    <input type="number" id="manualPartPrice" class="form-control" min="0" step="1000" placeholder="0">
                                                </div>
                                                <div class="form-group" style="margin: 0;">
                                                    <label><i class="fas fa-layer-group"></i> ÿßŸÑŸÉŸÖŸäÿ©</label>
                                                    <input type="number" id="manualPartQuantity" class="form-control" min="1" value="1" placeholder="1">
                                                </div>
                                                <button type="button" class="btn btn-success" onclick="addManualPart()" style="margin-bottom: 0;">
                                                    <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ©
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÇÿ∑ÿπ ÿßŸÑŸÖÿ∂ÿßŸÅÿ© -->
                                        <div id="addedPartsList" style="margin-top: 1rem;">
                                            <table class="table" id="maintenancePartsTable" style="display: none; font-size: 0.9rem;">
                                                <thead>
                                                    <tr>
                                                        <th>ÿßŸÑŸÇÿ∑ÿπÿ©</th>
                                                        <th>ÿßŸÑŸÉŸÖŸäÿ©</th>
                                                        <th>ÿßŸÑÿ≥ÿπÿ±</th>
                                                        <th>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</th>
                                                        <th>ÿ•ÿ¨ÿ±ÿßÿ°</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="maintenancePartsTableBody"></tbody>
                                                <tfoot>
                                                    <tr style="font-weight: bold; background: #e9ecef;">
                                                        <td colspan="3" style="text-align: left;">ÿ•ÿ¨ŸÖÿßŸÑŸä ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ±:</td>
                                                        <td id="totalPartsPrice">0 ÿØŸäŸÜÿßÿ±</td>
                                                        <td></td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label><i class="fas fa-info-circle"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿπŸÜ ÿ≥ÿ®ÿ® ÿßŸÑÿπÿ∑ŸÑ</label>
                                        <textarea id="maintenanceCauseInfo" class="form-control" rows="3" placeholder="ÿ™ŸÅÿßÿµŸäŸÑ ÿ•ÿ∂ÿßŸÅŸäÿ© ÿπŸÜ ÿ≥ÿ®ÿ® ÿßŸÑÿπÿ∑ŸÑ..."></textarea>
                                    </div>
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label><i class="fas fa-sticky-note"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©</label>
                                        <textarea id="maintenanceNotes" class="form-control" rows="2" placeholder="ÿ£Ÿä ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ£ÿÆÿ±Ÿâ..."></textarea>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                    <button type="submit" class="btn btn-success" style="flex: 1;">
                                        <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="closeMaintenanceModal()" style="flex: 1;">
                                        <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ≠ÿßŸÑŸä ŸÉÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('maintenanceReceiveDate').value = today;
            
            // ÿ™ŸáŸäÿ¶ÿ© ŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑŸÇÿ∑ÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ©
            window.maintenanceUsedParts = [];
        }

        // ÿØÿßŸÑÿ© ÿ™ÿ®ÿØŸäŸÑ Ÿàÿ∂ÿπ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÇÿ∑ÿπ
        function togglePartSelectionMode(mode) {
            const selectMode = document.getElementById('selectPartMode');
            const manualMode = document.getElementById('manualPartMode');
            const selectBtn = document.getElementById('selectModeBtn');
            const manualBtn = document.getElementById('manualModeBtn');
            
            if (mode === 'select') {
                selectMode.style.display = 'block';
                manualMode.style.display = 'none';
                selectBtn.classList.remove('btn-secondary');
                selectBtn.classList.add('btn-primary');
                manualBtn.classList.remove('btn-primary');
                manualBtn.classList.add('btn-secondary');
            } else {
                selectMode.style.display = 'none';
                manualMode.style.display = 'block';
                manualBtn.classList.remove('btn-secondary');
                manualBtn.classList.add('btn-primary');
                selectBtn.classList.remove('btn-primary');
                selectBtn.classList.add('btn-secondary');
            }
        }

        // ÿØÿßŸÑÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿ≥ÿπÿ± ÿßŸÑŸÇÿ∑ÿπÿ© ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©
        function updatePartPrice() {
            const selectElement = document.getElementById('selectedSparePartId');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            // ŸäŸÖŸÉŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Ÿáÿ∞Ÿá ÿßŸÑÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ±
        }

        // ÿØÿßŸÑÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ∑ÿπÿ© ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
        function addSelectedPart() {
            const selectElement = document.getElementById('selectedSparePartId');
            const partId = selectElement.value;
            const quantity = parseInt(document.getElementById('selectedPartQuantity').value) || 1;
            
            if (!partId) {
                showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÇÿ∑ÿπÿ© ÿ∫Ÿäÿßÿ±', 'warning');
                return;
            }
            
            const part = sparePartsData.find(p => p.id == partId);
            if (!part) return;
            
            if (quantity > part.quantity) {
                showNotification(`ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© (${quantity}) ÿ£ŸÉÿ®ÿ± ŸÖŸÜ ÿßŸÑŸÖÿ™ŸàŸÅÿ± (${part.quantity})`, 'error');
                return;
            }
            
            window.maintenanceUsedParts.push({
                id: partId,
                name: part.name,
                price: part.sellPrice,
                quantity: quantity,
                total: part.sellPrice * quantity,
                fromInventory: true
            });
            
            updatePartsTable();
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ≠ŸÇŸàŸÑ
            selectElement.value = '';
            document.getElementById('selectedPartQuantity').value = 1;
        }

        // ÿØÿßŸÑÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ∑ÿπÿ© ŸäÿØŸàŸäÿßŸã
        function addManualPart() {
            const name = document.getElementById('manualPartName').value.trim();
            const price = parseFloat(document.getElementById('manualPartPrice').value) || 0;
            const quantity = parseInt(document.getElementById('manualPartQuantity').value) || 1;
            
            if (!name) {
                showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ∑ÿπÿ©', 'warning');
                return;
            }
            
            window.maintenanceUsedParts.push({
                id: null,
                name: name,
                price: price,
                quantity: quantity,
                total: price * quantity,
                fromInventory: false
            });
            
            updatePartsTable();
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ≠ŸÇŸàŸÑ
            document.getElementById('manualPartName').value = '';
            document.getElementById('manualPartPrice').value = '';
            document.getElementById('manualPartQuantity').value = 1;
        }

        // ÿØÿßŸÑÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÇÿ∑ÿπ
        function updatePartsTable() {
            const table = document.getElementById('maintenancePartsTable');
            const tbody = document.getElementById('maintenancePartsTableBody');
            const totalEl = document.getElementById('totalPartsPrice');
            
            if (window.maintenanceUsedParts.length === 0) {
                table.style.display = 'none';
                return;
            }
            
            table.style.display = 'table';
            
            tbody.innerHTML = window.maintenanceUsedParts.map((part, index) => `
                <tr>
                    <td>${part.name} ${part.fromInventory ? '<span class="badge" style="background: #10b981; font-size: 0.7rem; margin-right: 0.5rem;">ŸÖŸÜ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</span>' : ''}</td>
                    <td>${part.quantity}</td>
                    <td>${formatCurrency(part.price)}</td>
                    <td><strong>${formatCurrency(part.total)}</strong></td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removePartFromList(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            const total = window.maintenanceUsedParts.reduce((sum, part) => sum + part.total, 0);
            totalEl.textContent = formatCurrency(total);
        }

        // ÿØÿßŸÑÿ© ÿ≠ÿ∞ŸÅ ŸÇÿ∑ÿπÿ© ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
        function removePartFromList(index) {
            window.maintenanceUsedParts.splice(index, 1);
            updatePartsTable();
        }

        // ÿØÿßŸÑÿ© ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿµŸäÿßŸÜÿ©
        function closeMaintenanceModal() {
            const modal = document.getElementById('addMaintenanceModal') || 
                          document.getElementById('editMaintenanceModal') ||
                          document.getElementById('deliveryModal');
            if (modal) {
                modal.remove();
            }
            window.maintenanceUsedParts = [];
        }

        // ÿØÿßŸÑÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿ¨Ÿáÿßÿ≤ ŸÑŸÑÿµŸäÿßŸÜÿ©
        function addMaintenance(event) {
            event.preventDefault();
            
            const newMaintenance = {
                id: Date.now(),
                productName: document.getElementById('maintenanceProductName').value,
                companyName: document.getElementById('maintenanceCompanyName').value,
                fault: document.getElementById('maintenanceFault').value,
                price: parseFloat(document.getElementById('maintenancePrice').value),
                receiveDate: document.getElementById('maintenanceReceiveDate').value,
                deliveryDate: document.getElementById('maintenanceDeliveryDate').value,
                causeInfo: document.getElementById('maintenanceCauseInfo').value,
                notes: document.getElementById('maintenanceNotes').value,
                usedParts: window.maintenanceUsedParts || [],
                partsTotal: window.maintenanceUsedParts.reduce((sum, part) => sum + part.total, 0),
                status: 'pending',
                addedBy: currentUser,
                addedDate: new Date().toISOString()
            };
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÉŸÖŸäÿßÿ™ ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ± ŸÖŸÜ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
            newMaintenance.usedParts.forEach(part => {
                if (part.fromInventory && part.id) {
                    const sparePartIndex = sparePartsData.findIndex(sp => sp.id == part.id);
                    if (sparePartIndex !== -1) {
                        sparePartsData[sparePartIndex].quantity -= part.quantity;
                        localStorage.setItem('sparePartsData', JSON.stringify(sparePartsData));
                    }
                }
            });
            
            maintenanceData.push(newMaintenance);
            localStorage.setItem('maintenanceData', JSON.stringify(maintenanceData));
            
            closeMaintenanceModal();
            displayMaintenanceData();
            updateMaintenanceStats();
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ± ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÖŸÅÿ™Ÿàÿ≠ÿ©
            if (document.getElementById('spareParts') && document.getElementById('spareParts').style.display === 'block') {
                displaySparePartsData();
                updateSparePartsStats();
            }
            
            showNotification('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ¨Ÿáÿßÿ≤ ŸÑŸÑÿµŸäÿßŸÜÿ© ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
        }

        // ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©
        function displayMaintenanceData(data = maintenanceData) {
            const tbody = document.getElementById('maintenanceTableBody');
            if (!tbody) return;
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 3rem; color: #666;">
                            <i class="fas fa-tools" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
                            ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿ¨Ÿáÿ≤ÿ© ŸÅŸä ÿßŸÑÿµŸäÿßŸÜÿ© ÿ≠ÿßŸÑŸäÿßŸã
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.map((item, index) => {
                const statusBadge = item.status === 'completed' 
                    ? '<span class="badge" style="background: #10b981;">ÿ™ŸÖÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©</span>'
                    : '<span class="badge" style="background: #f59e0b;">ŸÇŸäÿØ ÿßŸÑÿµŸäÿßŸÜÿ©</span>';
                
                const rowStyle = item.status === 'completed' 
                    ? 'background: rgba(16, 185, 129, 0.1);' 
                    : '';
                
                return `
                    <tr style="${rowStyle}">
                        <td>${index + 1}</td>
                        <td><strong>${item.productName}</strong></td>
                        <td>${item.companyName}</td>
                        <td>${item.fault}</td>
                        <td><strong>${formatCurrency(item.price)}</strong></td>
                        <td>${formatDate(item.receiveDate)}</td>
                        <td>${formatDate(item.deliveryDate)}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                <button class="btn btn-sm btn-info" onclick="showMaintenanceDetails(${item.id})" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="editMaintenance(${item.id})" title="ÿ™ÿπÿØŸäŸÑ">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${item.status === 'pending' ? 
                                    `<button class="btn btn-sm btn-success" onclick="completeMaintenance(${item.id})" title="ÿ™ŸÖ ÿßŸÑÿµŸäÿßŸÜÿ©">
                                        <i class="fas fa-check"></i>
                                    </button>` : ''}
                                <button class="btn btn-sm btn-danger" onclick="deleteMaintenance(${item.id})" title="ÿ≠ÿ∞ŸÅ">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateCompanyFilter();
        }

        // ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿµŸäÿßŸÜÿ©
        function showMaintenanceDetails(id) {
            const item = maintenanceData.find(m => m.id === id);
            if (!item) return;
            
            const statusIcon = item.status === 'completed' 
                ? '<i class="fas fa-check-circle" style="color: #10b981;"></i>'
                : '<i class="fas fa-clock" style="color: #f59e0b;"></i>';
            
            const modalHTML = `
                <div class="modal active" id="maintenanceDetailsModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 700px;">
                        <div class="modal-header">
                            <h2>${statusIcon} ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿµŸäÿßŸÜÿ©</h2>
                            <button class="close-btn" onclick="closeMaintenanceDetailsModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="display: grid; gap: 1.5rem;">
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-box"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨:</span>
                                    <span class="info-value"><strong>${item.productName}</strong></span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-building"></i> ÿßÿ≥ŸÖ ÿßŸÑÿ¥ÿ±ŸÉÿ©:</span>
                                    <span class="info-value">${item.companyName}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-exclamation-triangle"></i> ÿßŸÑÿÆŸÑŸÑ:</span>
                                    <span class="info-value" style="color: #ef4444;">${item.fault}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-money-bill"></i> ÿ≥ÿπÿ± ÿßŸÑÿµŸäÿßŸÜÿ©:</span>
                                    <span class="info-value"><strong style="color: #10b981;">${formatCurrency(item.price)}</strong></span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-calendar-check"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ:</span>
                                    <span class="info-value">${formatDate(item.receiveDate)}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-calendar-alt"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ:</span>
                                    <span class="info-value">${formatDate(item.deliveryDate)}</span>
                                </div>
                                ${item.causeInfo ? `
                                <div class="info-row" style="flex-direction: column; align-items: flex-start;">
                                    <span class="info-label"><i class="fas fa-info-circle"></i> ÿ≥ÿ®ÿ® ÿßŸÑÿπÿ∑ŸÑ:</span>
                                    <span class="info-value" style="margin-top: 0.5rem; padding: 1rem; background: #f3f4f6; border-radius: 8px; width: 100%;">${item.causeInfo}</span>
                                </div>` : ''}
                                ${item.notes ? `
                                <div class="info-row" style="flex-direction: column; align-items: flex-start;">
                                    <span class="info-label"><i class="fas fa-sticky-note"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™:</span>
                                    <span class="info-value" style="margin-top: 0.5rem; padding: 1rem; background: #f3f4f6; border-radius: 8px; width: 100%;">${item.notes}</span>
                                </div>` : ''}
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-info-circle"></i> ÿßŸÑÿ≠ÿßŸÑÿ©:</span>
                                    <span class="info-value">
                                        ${item.status === 'completed' 
                                            ? '<span class="badge" style="background: #10b981;">ÿ™ŸÖÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©</span>'
                                            : '<span class="badge" style="background: #f59e0b;">ŸÇŸäÿØ ÿßŸÑÿµŸäÿßŸÜÿ©</span>'}
                                    </span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-user"></i> ÿ£ÿ∂ŸäŸÅ ÿ®Ÿàÿßÿ≥ÿ∑ÿ©:</span>
                                    <span class="info-value">${item.addedBy || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="closeMaintenanceDetailsModal()" style="width: 100%; margin-top: 1.5rem;">
                                <i class="fas fa-times"></i> ÿ•ÿ∫ŸÑÿßŸÇ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeMaintenanceDetailsModal() {
            const modal = document.getElementById('maintenanceDetailsModal');
            if (modal) modal.remove();
        }

        // ÿØÿßŸÑÿ© ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿµŸäÿßŸÜÿ©
        function editMaintenance(id) {
            const item = maintenanceData.find(m => m.id === id);
            if (!item) return;
            
            const modalHTML = `
                <div class="modal active" id="editMaintenanceModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 800px; width: 90%;">
                        <div class="modal-header">
                            <h2><i class="fas fa-edit"></i> ÿ™ÿπÿØŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©</h2>
                            <button class="close-btn" onclick="closeMaintenanceModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="editMaintenanceForm" onsubmit="updateMaintenance(event, ${id})">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                    <div class="form-group">
                                        <label><i class="fas fa-box"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ *</label>
                                        <input type="text" id="editMaintenanceProductName" class="form-control" required value="${item.productName}">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-building"></i> ÿßÿ≥ŸÖ ÿßŸÑÿ¥ÿ±ŸÉÿ© *</label>
                                        <input type="text" id="editMaintenanceCompanyName" class="form-control" required value="${item.companyName}">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-exclamation-triangle"></i> ÿßŸÑÿÆŸÑŸÑ ÿßŸÑŸÖŸàÿ¨ŸàÿØ *</label>
                                        <input type="text" id="editMaintenanceFault" class="form-control" required value="${item.fault}">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-money-bill"></i> ÿ≥ÿπÿ± ÿßŸÑÿµŸäÿßŸÜÿ© (ÿØŸäŸÜÿßÿ±) *</label>
                                        <input type="number" id="editMaintenancePrice" class="form-control" required min="0" step="1000" value="${item.price}">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-calendar-check"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ *</label>
                                        <input type="date" id="editMaintenanceReceiveDate" class="form-control" required value="${item.receiveDate}">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-calendar-alt"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸÖÿ™ŸàŸÇÿπ *</label>
                                        <input type="date" id="editMaintenanceDeliveryDate" class="form-control" required value="${item.deliveryDate}">
                                    </div>
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label><i class="fas fa-info-circle"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿπŸÜ ÿ≥ÿ®ÿ® ÿßŸÑÿπÿ∑ŸÑ</label>
                                        <textarea id="editMaintenanceCauseInfo" class="form-control" rows="3">${item.causeInfo || ''}</textarea>
                                    </div>
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label><i class="fas fa-sticky-note"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©</label>
                                        <textarea id="editMaintenanceNotes" class="form-control" rows="2">${item.notes || ''}</textarea>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                                        <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="closeMaintenanceModal()" style="flex: 1;">
                                        <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // ÿØÿßŸÑÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸäÿßŸÜÿ©
        function updateMaintenance(event, id) {
            event.preventDefault();
            
            const index = maintenanceData.findIndex(m => m.id === id);
            if (index === -1) return;
            
            maintenanceData[index] = {
                ...maintenanceData[index],
                productName: document.getElementById('editMaintenanceProductName').value,
                companyName: document.getElementById('editMaintenanceCompanyName').value,
                fault: document.getElementById('editMaintenanceFault').value,
                price: parseFloat(document.getElementById('editMaintenancePrice').value),
                receiveDate: document.getElementById('editMaintenanceReceiveDate').value,
                deliveryDate: document.getElementById('editMaintenanceDeliveryDate').value,
                causeInfo: document.getElementById('editMaintenanceCauseInfo').value,
                notes: document.getElementById('editMaintenanceNotes').value,
                lastModified: new Date().toISOString()
            };
            
            localStorage.setItem('maintenanceData', JSON.stringify(maintenanceData));
            
            closeMaintenanceModal();
            displayMaintenanceData();
            updateMaintenanceStats();
            
            showNotification('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ© ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
        }

        // ÿØÿßŸÑÿ© ÿ™ÿ∫ŸäŸäÿ± ÿ≠ÿßŸÑÿ© ÿßŸÑÿµŸäÿßŸÜÿ© ÿ•ŸÑŸâ ŸÖŸÉÿ™ŸÖŸÑÿ©
        // ÿØÿßŸÑÿ© ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿµŸäÿßŸÜÿ© ŸàŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ
        function completeMaintenance(id) {
            const item = maintenanceData.find(m => m.id === id);
            if (!item) return;
            
            showDeliveryModal(item);
        }

        // ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑÿ¨Ÿáÿßÿ≤
        function showDeliveryModal(maintenanceItem) {
            const totalCost = maintenanceItem.price + (maintenanceItem.partsTotal || 0);
            
            const modalHTML = `
                <div class="modal active" id="deliveryModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 700px;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
                            <h2><i class="fas fa-check-circle"></i> ÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑÿ¨Ÿáÿßÿ≤ Ÿàÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑŸÖÿ®ŸÑÿ∫</h2>
                            <button class="close-btn" onclick="closeMaintenanceModal()" style="color: white;">&times;</button>
                        </div>
                        <div class="modal-body">
                            <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¨Ÿáÿßÿ≤ -->
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                <h3 style="margin: 0 0 0.5rem 0; color: var(--primary-color);">${maintenanceItem.productName}</h3>
                                <div style="display: grid; gap: 0.5rem; font-size: 0.95rem;">
                                    <div><i class="fas fa-building"></i> ÿßŸÑÿ¥ÿ±ŸÉÿ©: <strong>${maintenanceItem.companyName}</strong></div>
                                    <div><i class="fas fa-exclamation-triangle"></i> ÿßŸÑÿÆŸÑŸÑ: <strong>${maintenanceItem.fault}</strong></div>
                                    <div><i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ: <strong>${formatDate(maintenanceItem.receiveDate)}</strong></div>
                                </div>
                            </div>
                            
                            <!-- ŸÖŸÑÿÆÿµ ÿßŸÑÿ™ŸÉŸÑŸÅÿ© -->
                            <div style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                                <div style="display: grid; gap: 0.75rem;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>ÿ≥ÿπÿ± ÿßŸÑÿµŸäÿßŸÜÿ©:</span>
                                        <strong style="font-size: 1.1rem;">${formatCurrency(maintenanceItem.price)}</strong>
                                    </div>
                                    ${maintenanceItem.usedParts && maintenanceItem.usedParts.length > 0 ? `
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ± (${maintenanceItem.usedParts.length} ŸÇÿ∑ÿπÿ©):</span>
                                        <strong style="font-size: 1.1rem;">${formatCurrency(maintenanceItem.partsTotal || 0)}</strong>
                                    </div>` : ''}
                                    <div style="border-top: 2px solid rgba(255,255,255,0.3); padding-top: 0.75rem; margin-top: 0.5rem;">
                                        <div style="display: flex; justify-content: space-between; font-size: 1.3rem;">
                                            <span><i class="fas fa-money-bill-wave"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:</span>
                                            <strong>${formatCurrency(totalCost)}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <form onsubmit="completeDelivery(event, ${maintenanceItem.id})">
                                <div class="form-group">
                                    <label><i class="fas fa-calendar-check"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸÅÿπŸÑŸä *</label>
                                    <input type="date" id="actualDeliveryDate" class="form-control" required value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                
                                <div class="form-group">
                                    <label><i class="fas fa-money-bill"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖ (ÿØŸäŸÜÿßÿ±) *</label>
                                    <input type="number" id="receivedAmount" class="form-control" required min="0" step="1000" value="${totalCost}" placeholder="${totalCost}">
                                </div>
                                
                                <div class="form-group">
                                    <label><i class="fas fa-credit-card"></i> ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ *</label>
                                    <select id="paymentMethod" class="form-control" required>
                                        <option value="cash">ŸÜŸÇÿØÿßŸã</option>
                                        <option value="card">ÿ®ÿ∑ÿßŸÇÿ©</option>
                                        <option value="transfer">ÿ™ÿ≠ŸàŸäŸÑ ÿ®ŸÜŸÉŸä</option>
                                        <option value="mixed">ŸÖÿÆÿ™ŸÑÿ∑</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label><i class="fas fa-user"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖ</label>
                                    <input type="text" id="receiverName" class="form-control" placeholder="ÿßÿ≥ŸÖ ÿßŸÑÿ¥ÿÆÿµ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖ ŸÑŸÑÿ¨Ÿáÿßÿ≤">
                                </div>
                                
                                <div class="form-group">
                                    <label><i class="fas fa-sticky-note"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ</label>
                                    <textarea id="deliveryNotes" class="form-control" rows="2" placeholder="ÿ£Ÿä ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ..."></textarea>
                                </div>
                                
                                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                    <button type="submit" class="btn btn-success" style="flex: 1;">
                                        <i class="fas fa-check-circle"></i> ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="closeMaintenanceModal()" style="flex: 1;">
                                        <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // ÿØÿßŸÑÿ© ÿ•ŸÉŸÖÿßŸÑ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ
        function completeDelivery(event, maintenanceId) {
            event.preventDefault();
            
            const maintenanceIndex = maintenanceData.findIndex(m => m.id === maintenanceId);
            if (maintenanceIndex === -1) return;
            
            const maintenanceItem = maintenanceData[maintenanceIndex];
            
            // ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ÿ¨ŸÑ ÿ¨Ÿáÿßÿ≤ ŸÖÿ≥ÿ™ŸÑŸÖ
            const deliveredDevice = {
                id: Date.now(),
                maintenanceId: maintenanceId,
                productName: maintenanceItem.productName,
                companyName: maintenanceItem.companyName,
                fault: maintenanceItem.fault,
                maintenancePrice: maintenanceItem.price,
                usedParts: maintenanceItem.usedParts || [],
                partsTotal: maintenanceItem.partsTotal || 0,
                totalCost: maintenanceItem.price + (maintenanceItem.partsTotal || 0),
                receiveDate: maintenanceItem.receiveDate,
                expectedDeliveryDate: maintenanceItem.deliveryDate,
                actualDeliveryDate: document.getElementById('actualDeliveryDate').value,
                receivedAmount: parseFloat(document.getElementById('receivedAmount').value),
                paymentMethod: document.getElementById('paymentMethod').value,
                receiverName: document.getElementById('receiverName').value,
                deliveryNotes: document.getElementById('deliveryNotes').value,
                causeInfo: maintenanceItem.causeInfo,
                notes: maintenanceItem.notes,
                deliveredBy: currentUser,
                deliveredDate: new Date().toISOString()
            };
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ©
            if (!window.deliveredDevicesData) {
                window.deliveredDevicesData = JSON.parse(localStorage.getItem('deliveredDevicesData')) || [];
            }
            window.deliveredDevicesData.push(deliveredDevice);
            localStorage.setItem('deliveredDevicesData', JSON.stringify(window.deliveredDevicesData));
            
            // ÿ≠ÿ∞ŸÅ ŸÖŸÜ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿµŸäÿßŸÜÿ©
            maintenanceData.splice(maintenanceIndex, 1);
            localStorage.setItem('maintenanceData', JSON.stringify(maintenanceData));
            
            closeMaintenanceModal();
            displayMaintenanceData();
            updateMaintenanceStats();
            
            showNotification('ÿ™ŸÖ ÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑÿ¨Ÿáÿßÿ≤ Ÿàÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
        }

        // ÿØÿßŸÑÿ© ÿ≠ÿ∞ŸÅ ÿ¨Ÿáÿßÿ≤ ŸÖŸÜ ÿßŸÑÿµŸäÿßŸÜÿ©
        function deleteMaintenance(id) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤ÿü')) return;
            
            maintenanceData = maintenanceData.filter(m => m.id !== id);
            localStorage.setItem('maintenanceData', JSON.stringify(maintenanceData));
            
            displayMaintenanceData();
            updateMaintenanceStats();
            
            showNotification('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ¨Ÿáÿßÿ≤ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
        }

        // ÿØÿßŸÑÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
        function updateMaintenanceStats() {
            const total = maintenanceData.length;
            const completed = maintenanceData.filter(m => m.status === 'completed').length;
            const pending = total - completed;
            const totalRevenue = maintenanceData
                .filter(m => m.status === 'completed')
                .reduce((sum, m) => sum + m.price, 0);
            
            const totalEl = document.getElementById('totalMaintenanceDevices');
            const completedEl = document.getElementById('completedMaintenanceDevices');
            const pendingEl = document.getElementById('pendingMaintenanceDevices');
            const revenueEl = document.getElementById('totalMaintenanceRevenue');
            
            if (totalEl) totalEl.textContent = total;
            if (completedEl) completedEl.textContent = completed;
            if (pendingEl) pendingEl.textContent = pending;
            if (revenueEl) revenueEl.textContent = formatCurrency(totalRevenue);
        }

        // ÿØÿßŸÑÿ© ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿµŸäÿßŸÜÿ©
        function filterMaintenance() {
            const searchTerm = document.getElementById('maintenanceSearchInput').value.toLowerCase();
            
            const filtered = maintenanceData.filter(item => 
                item.productName.toLowerCase().includes(searchTerm) ||
                item.companyName.toLowerCase().includes(searchTerm) ||
                item.fault.toLowerCase().includes(searchTerm)
            );
            
            displayMaintenanceData(filtered);
        }

        // ÿØÿßŸÑÿ© ÿßŸÑŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿßŸÑÿ©
        function filterMaintenanceByStatus() {
            const status = document.getElementById('maintenanceStatusFilter').value;
            
            let filtered = maintenanceData;
            if (status !== 'all') {
                filtered = maintenanceData.filter(m => m.status === status);
            }
            
            displayMaintenanceData(filtered);
        }

        // ÿØÿßŸÑÿ© ÿßŸÑŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ¥ÿ±ŸÉÿ©
        function filterMaintenanceByCompany() {
            const company = document.getElementById('maintenanceCompanyFilter').value;
            
            let filtered = maintenanceData;
            if (company !== 'all') {
                filtered = maintenanceData.filter(m => m.companyName === company);
            }
            
            displayMaintenanceData(filtered);
        }

        // ÿØÿßŸÑÿ© ÿßŸÑŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
        function filterMaintenanceByPeriod() {
            const period = document.getElementById('maintenancePeriodFilter').value;
            const customDateRange = document.getElementById('customMaintenanceDateRange');
            
            if (period === 'custom') {
                customDateRange.style.display = 'flex';
                return;
            } else {
                customDateRange.style.display = 'none';
            }
            
            const today = new Date();
            let filtered = maintenanceData;
            
            if (period !== 'all') {
                filtered = maintenanceData.filter(item => {
                    const itemDate = new Date(item.receiveDate);
                    
                    switch(period) {
                        case 'today':
                            return itemDate.toDateString() === today.toDateString();
                        case 'week':
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            return itemDate >= weekAgo;
                        case 'month':
                            return itemDate.getMonth() === today.getMonth() && 
                                   itemDate.getFullYear() === today.getFullYear();
                        default:
                            return true;
                    }
                });
            }
            
            displayMaintenanceData(filtered);
        }

        // ÿØÿßŸÑÿ© ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑŸÖÿÆÿµÿµÿ©
        function applyCustomMaintenanceDateFilter() {
            const dateFrom = document.getElementById('maintenanceDateFrom').value;
            const dateTo = document.getElementById('maintenanceDateTo').value;
            
            if (!dateFrom || !dateTo) {
                showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ© ŸàÿßŸÑŸÜŸáÿßŸäÿ©', 'warning');
                return;
            }
            
            const filtered = maintenanceData.filter(item => {
                const itemDate = new Date(item.receiveDate);
                return itemDate >= new Date(dateFrom) && itemDate <= new Date(dateTo);
            });
            
            displayMaintenanceData(filtered);
        }

        // ÿØÿßŸÑÿ© ÿßŸÑŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ≥ÿπÿ±
        function filterMaintenanceByPrice() {
            const priceRange = document.getElementById('maintenancePriceFilter').value;
            
            let filtered = maintenanceData;
            if (priceRange !== 'all') {
                if (priceRange.includes('+')) {
                    const minPrice = parseInt(priceRange.replace('+', ''));
                    filtered = maintenanceData.filter(m => m.price >= minPrice);
                } else {
                    const [min, max] = priceRange.split('-').map(Number);
                    filtered = maintenanceData.filter(m => m.price >= min && m.price <= max);
                }
            }
            
            displayMaintenanceData(filtered);
        }

        // ÿØÿßŸÑÿ© ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÅŸÑÿßÿ™ÿ±
        function resetMaintenanceFilters() {
            document.getElementById('maintenanceStatusFilter').value = 'all';
            document.getElementById('maintenanceCompanyFilter').value = 'all';
            document.getElementById('maintenancePeriodFilter').value = 'all';
            document.getElementById('maintenancePriceFilter').value = 'all';
            document.getElementById('maintenanceSearchInput').value = '';
            document.getElementById('customMaintenanceDateRange').style.display = 'none';
            
            displayMaintenanceData();
        }

        // ÿØÿßŸÑÿ© ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¥ÿ±ŸÉÿßÿ™ ŸÅŸä ÿßŸÑŸÅŸÑÿ™ÿ±
        function updateCompanyFilter() {
            const companyFilter = document.getElementById('maintenanceCompanyFilter');
            if (!companyFilter) return;
            
            const companies = [...new Set(maintenanceData.map(m => m.companyName))];
            
            const currentValue = companyFilter.value;
            companyFilter.innerHTML = '<option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ¥ÿ±ŸÉÿßÿ™</option>';
            
            companies.forEach(company => {
                companyFilter.innerHTML += `<option value="${company}">${company}</option>`;
            });
            
            companyFilter.value = currentValue;
        }

        // ÿØÿßŸÑÿ© ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©
        function importMaintenanceData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let importedData = [];
                    
                    if (file.name.endsWith('.json')) {
                        importedData = JSON.parse(e.target.result);
                    } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || file.name.endsWith('.csv')) {
                        // ŸÖÿπÿßŸÑÿ¨ÿ© ŸÖŸÑŸÅÿßÿ™ Excel/CSV (ÿ™ÿ≠ÿ™ÿßÿ¨ ŸÖŸÉÿ™ÿ®ÿ© XLSX)
                        showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖŸÑŸÅÿßÿ™ JSON ŸÑŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ', 'warning');
                        return;
                    }
                    
                    if (!Array.isArray(importedData)) {
                        throw new Error('ÿµŸäÿ∫ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                    }
                    
                    // ÿØŸÖÿ¨ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™Ÿàÿ±ÿØÿ©
                    importedData.forEach(item => {
                        if (!maintenanceData.find(m => m.id === item.id)) {
                            maintenanceData.push(item);
                        }
                    });
                    
                    localStorage.setItem('maintenanceData', JSON.stringify(maintenanceData));
                    
                    displayMaintenanceData();
                    updateMaintenanceStats();
                    
                    showNotification(`ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${importedData.length} ÿ¨Ÿáÿßÿ≤ ÿ®ŸÜÿ¨ÿßÿ≠`, 'success');
                } catch (error) {
                    showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + error.message, 'error');
                }
                
                input.value = '';
            };
            
            reader.readAsText(file);
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿØÿßŸÑÿ© exportData ŸÑÿØÿπŸÖ ÿßŸÑÿµŸäÿßŸÜÿ©
        const originalExportData = exportData;
        exportData = async function(type, format) {
            if (type === 'maintenance') {
                if (maintenanceData.length === 0) {
                    showNotification('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±', 'warning');
                    return;
                }
                
                const filename = 'ÿ®ŸäÿßŸÜÿßÿ™_ÿßŸÑÿµŸäÿßŸÜÿ©';
                
                try {
                    switch(format) {
                        case 'json':
                            exportToJSON(maintenanceData, filename);
                            break;
                        case 'excel':
                            exportMaintenanceToExcel(maintenanceData, filename);
                            break;
                        case 'word':
                            exportMaintenanceToWord(maintenanceData, filename);
                            break;
                        case 'pdf':
                            exportMaintenanceToPDF(maintenanceData, filename);
                            break;
                    }
                } catch (error) {
                    showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿµÿØŸäÿ±', 'error');
                }
            } else {
                return originalExportData(type, format);
            }
        };

        // ÿØÿßŸÑÿ© ÿ™ÿµÿØŸäÿ± ÿßŸÑÿµŸäÿßŸÜÿ© ÿ•ŸÑŸâ Excel
        function exportMaintenanceToExcel(data, filename) {
            const ws_data = [
                ['#', 'ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨', 'ÿßŸÑÿ¥ÿ±ŸÉÿ©', 'ÿßŸÑÿÆŸÑŸÑ', 'ÿ≥ÿπÿ± ÿßŸÑÿµŸäÿßŸÜÿ©', 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ', 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ', 'ÿßŸÑÿ≠ÿßŸÑÿ©', 'ÿ≥ÿ®ÿ® ÿßŸÑÿπÿ∑ŸÑ', 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™']
            ];
            
            data.forEach((item, index) => {
                ws_data.push([
                    index + 1,
                    item.productName,
                    item.companyName,
                    item.fault,
                    item.price,
                    formatDate(item.receiveDate),
                    formatDate(item.deliveryDate),
                    item.status === 'completed' ? 'ÿ™ŸÖÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©' : 'ŸÇŸäÿØ ÿßŸÑÿµŸäÿßŸÜÿ©',
                    item.causeInfo || '',
                    item.notes || ''
                ]);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            ws['!cols'] = [
                {wch: 5}, {wch: 20}, {wch: 20}, {wch: 25}, {wch: 15},
                {wch: 15}, {wch: 15}, {wch: 15}, {wch: 30}, {wch: 30}
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'ÿßŸÑÿµŸäÿßŸÜÿ©');
            XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // ÿØÿßŸÑÿ© ÿ™ÿµÿØŸäÿ± ÿßŸÑÿµŸäÿßŸÜÿ© ÿ•ŸÑŸâ Word
        function exportMaintenanceToWord(data, filename) {
            let content = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset='utf-8'>
                    <style>
                        body { direction: rtl; font-family: Arial; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                        th { background-color: #4CAF50; color: white; }
                        h1 { text-align: center; color: #333; }
                    </style>
                </head>
                <body>
                    <h1>ÿ™ŸÇÿ±Ÿäÿ± ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©</h1>
                    <p>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿµÿØŸäÿ±: ${new Date().toLocaleDateString('ar-IQ')}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
                                <th>ÿßŸÑÿ¥ÿ±ŸÉÿ©</th>
                                <th>ÿßŸÑÿÆŸÑŸÑ</th>
                                <th>ÿßŸÑÿ≥ÿπÿ±</th>
                                <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ</th>
                                <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ</th>
                                <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach((item, index) => {
                content += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.productName}</td>
                        <td>${item.companyName}</td>
                        <td>${item.fault}</td>
                        <td>${formatCurrency(item.price)}</td>
                        <td>${formatDate(item.receiveDate)}</td>
                        <td>${formatDate(item.deliveryDate)}</td>
                        <td>${item.status === 'completed' ? 'ÿ™ŸÖÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©' : 'ŸÇŸäÿØ ÿßŸÑÿµŸäÿßŸÜÿ©'}</td>
                    </tr>
                `;
            });
            
            content += `
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            const blob = new Blob(['\ufeff', content], {
                type: 'application/msword'
            });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${filename}_${new Date().toISOString().split('T')[0]}.doc`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // ÿØÿßŸÑÿ© ÿ™ÿµÿØŸäÿ± ÿßŸÑÿµŸäÿßŸÜÿ© ÿ•ŸÑŸâ PDF
        function exportMaintenanceToPDF(data, filename) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿÆÿ∑ ÿßŸÑÿπÿ±ÿ®Ÿä
            doc.addFont('https://cdn.jsdelivr.net/npm/amiri-font@1.0.0/Amiri-Regular.ttf', 'Amiri', 'normal');
            doc.setFont('Amiri');
            
            // ÿßŸÑÿπŸÜŸàÿßŸÜ
            doc.setFontSize(18);
            doc.text('ÿ™ŸÇÿ±Ÿäÿ± ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©', 148, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿµÿØŸäÿ±: ${new Date().toLocaleDateString('ar-IQ')}`, 148, 30, { align: 'center' });
            
            // ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ¨ÿØŸàŸÑ
            const tableData = data.map((item, index) => [
                (index + 1).toString(),
                item.productName,
                item.companyName,
                item.fault,
                formatCurrency(item.price),
                formatDate(item.receiveDate),
                formatDate(item.deliveryDate),
                item.status === 'completed' ? 'ÿ™ŸÖÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©' : 'ŸÇŸäÿØ ÿßŸÑÿµŸäÿßŸÜÿ©'
            ]);
            
            doc.autoTable({
                startY: 40,
                head: [['#', 'ÿßŸÑŸÖŸÜÿ™ÿ¨', 'ÿßŸÑÿ¥ÿ±ŸÉÿ©', 'ÿßŸÑÿÆŸÑŸÑ', 'ÿßŸÑÿ≥ÿπÿ±', 'ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ', 'ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ', 'ÿßŸÑÿ≠ÿßŸÑÿ©']],
                body: tableData,
                styles: {
                    font: 'Amiri',
                    fontSize: 10,
                    halign: 'right'
                },
                headStyles: {
                    fillColor: [99, 102, 241],
                    textColor: 255,
                    fontSize: 11,
                    fontStyle: 'bold'
                },
                margin: { right: 10, left: 10 }
            });
            
            doc.save(`${filename}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // ÿ™ŸáŸäÿ¶ÿ© ÿµŸÅÿ≠ÿ© ÿßŸÑÿµŸäÿßŸÜÿ© ÿπŸÜÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('maintenance')) {
                displayMaintenanceData();
                updateMaintenanceStats();
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ŸÜŸáÿßŸäÿ© ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸäÿßŸÜÿ©
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ŸÇÿ∑ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© - Spare Parts Management System
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // ŸÖÿµŸÅŸàŸÅÿ© ÿ™ÿÆÿ≤ŸäŸÜ ŸÇÿ∑ÿπ ÿßŸÑÿµŸäÿßŸÜÿ©
        let sparePartsData = JSON.parse(localStorage.getItem('sparePartsData')) || [];
        
        // ŸÖÿµŸÅŸàŸÅÿ© ÿ™ÿÆÿ≤ŸäŸÜ ŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°
        let purchaseInvoicesData = JSON.parse(localStorage.getItem('purchaseInvoicesData')) || [];

        // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™
        const LOW_STOCK_THRESHOLD = 5; // ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑŸÑÿ™ŸÜÿ®ŸäŸá
        const OUT_OF_STOCK = 0; // ŸÜŸÅÿßÿØ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ

        // ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ∑ÿπÿ©
        function showAddSparePartModal() {
            const modalHTML = `
                <div class="modal active" id="addSparePartModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 900px; width: 90%;">
                        <div class="modal-header">
                            <h2><i class="fas fa-cogs"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ∑ÿπÿ© ÿµŸäÿßŸÜÿ© ÿ¨ÿØŸäÿØÿ©</h2>
                            <button class="close-btn" onclick="closeSparePartModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="sparePartForm" onsubmit="addSparePart(event)">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                    <div class="form-group">
                                        <label><i class="fas fa-box"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ∑ÿπÿ© *</label>
                                        <input type="text" id="sparePartName" class="form-control" required placeholder="ŸÖÿ´ÿßŸÑ: ÿ¥ÿßÿ¥ÿ© ŸÑÿßÿ® ÿ™Ÿàÿ® 15.6">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-barcode"></i> ÿßŸÑŸÉŸàÿØ/ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ</label>
                                        <input type="text" id="sparePartCode" class="form-control" placeholder="ŸÖÿ´ÿßŸÑ: LCD-156-001">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-layer-group"></i> ÿßŸÑÿ™ÿµŸÜŸäŸÅ *</label>
                                        <select id="sparePartCategory" class="form-control" required>
                                            <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅ</option>
                                            <option value="electronics">ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿßÿ™</option>
                                            <option value="mechanical">ŸÖŸäŸÉÿßŸÜŸäŸÉŸäÿ©</option>
                                            <option value="tools">ÿ£ÿØŸàÿßÿ™</option>
                                            <option value="accessories">ÿ•ŸÉÿ≥ÿ≥Ÿàÿßÿ±ÿßÿ™</option>
                                            <option value="other">ÿ£ÿÆÿ±Ÿâ</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-building"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ±ÿØ *</label>
                                        <input type="text" id="sparePartSupplier" class="form-control" required placeholder="ŸÖÿ´ÿßŸÑ: ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿ™ŸÇŸÜŸäÿ©">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-phone"></i> Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖŸàÿ±ÿØ</label>
                                        <input type="text" id="sparePartSupplierPhone" class="form-control" placeholder="ŸÖÿ´ÿßŸÑ: 07701234567">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-shopping-cart"></i> ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ° (ÿØŸäŸÜÿßÿ±) *</label>
                                        <input type="number" id="sparePartPurchasePrice" class="form-control" required min="0" step="1000" placeholder="50000">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-tag"></i> ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ ÿßŸÑŸÖŸÅÿ±ÿØ (ÿØŸäŸÜÿßÿ±) *</label>
                                        <input type="number" id="sparePartRetailPrice" class="form-control" required min="0" step="1000" placeholder="75000">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-tags"></i> ÿ≥ÿπÿ± ÿßŸÑÿ¨ŸÖŸÑÿ© (ÿØŸäŸÜÿßÿ±) *</label>
                                        <input type="number" id="sparePartWholesalePrice" class="form-control" required min="0" step="1000" placeholder="65000">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-boxes"></i> ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸÖÿ™ŸàŸÅÿ±ÿ© *</label>
                                        <input type="number" id="sparePartQuantity" class="form-control" required min="0" step="1" placeholder="10">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-exclamation-triangle"></i> ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑŸÑÿ™ŸÜÿ®ŸäŸá</label>
                                        <input type="number" id="sparePartMinStock" class="form-control" min="0" step="1" placeholder="5" value="5">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-map-marker-alt"></i> ŸÖŸàŸÇÿπ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ</label>
                                        <input type="text" id="sparePartLocation" class="form-control" placeholder="ŸÖÿ´ÿßŸÑ: ÿ±ŸÅ 3 - ÿµŸÜÿØŸàŸÇ A">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-file-invoice"></i> ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</label>
                                        <input type="text" id="sparePartInvoiceNumber" class="form-control" placeholder="ÿ±ŸÇŸÖ ŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ¥ÿ±ÿßÿ°">
                                    </div>
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label><i class="fas fa-sticky-note"></i> ÿßŸÑŸàÿµŸÅ ŸàÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</label>
                                        <textarea id="sparePartDescription" class="form-control" rows="3" placeholder="ŸàÿµŸÅ ÿ™ŸÅÿµŸäŸÑŸä ŸÑŸÑŸÇÿ∑ÿπÿ© Ÿàÿ£Ÿä ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©..."></textarea>
                                    </div>
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label><i class="fas fa-info-circle"></i> ÿßŸÑŸÖŸàÿßÿµŸÅÿßÿ™ ÿßŸÑŸÅŸÜŸäÿ©</label>
                                        <textarea id="sparePartSpecs" class="form-control" rows="2" placeholder="ÿßŸÑŸÖŸàÿßÿµŸÅÿßÿ™ ÿßŸÑŸÅŸÜŸäÿ© ŸàÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ..."></textarea>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                    <button type="submit" class="btn btn-success" style="flex: 1;">
                                        <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="closeSparePartModal()" style="flex: 1;">
                                        <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // ÿØÿßŸÑÿ© ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ŸÇÿ∑ÿπ ÿßŸÑÿµŸäÿßŸÜÿ©
        function closeSparePartModal() {
            const modal = document.getElementById('addSparePartModal') || 
                         document.getElementById('editSparePartModal') ||
                         document.getElementById('addInvoiceModal');
            if (modal) {
                modal.remove();
            }
        }

        // ÿØÿßŸÑÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ∑ÿπÿ© ÿµŸäÿßŸÜÿ©
        function addSparePart(event) {
            event.preventDefault();
            
            const newPart = {
                id: Date.now(),
                name: document.getElementById('sparePartName').value,
                code: document.getElementById('sparePartCode').value,
                category: document.getElementById('sparePartCategory').value,
                supplier: document.getElementById('sparePartSupplier').value,
                supplierPhone: document.getElementById('sparePartSupplierPhone').value,
                purchasePrice: parseFloat(document.getElementById('sparePartPurchasePrice').value),
                retailPrice: parseFloat(document.getElementById('sparePartRetailPrice').value),
                wholesalePrice: parseFloat(document.getElementById('sparePartWholesalePrice').value),
                quantity: parseInt(document.getElementById('sparePartQuantity').value),
                minStock: parseInt(document.getElementById('sparePartMinStock').value) || LOW_STOCK_THRESHOLD,
                location: document.getElementById('sparePartLocation').value,
                invoiceNumber: document.getElementById('sparePartInvoiceNumber').value,
                description: document.getElementById('sparePartDescription').value,
                specs: document.getElementById('sparePartSpecs').value,
                addedBy: currentUser,
                addedDate: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };
            
            sparePartsData.push(newPart);
            localStorage.setItem('sparePartsData', JSON.stringify(sparePartsData));
            
            closeSparePartModal();
            displaySparePartsData();
            updateSparePartsStats();
            checkStockAlerts();
            
            showNotification('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÇÿ∑ÿπÿ© ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
        }

        // ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ÿ®ŸäÿßŸÜÿßÿ™ ŸÇÿ∑ÿπ ÿßŸÑÿµŸäÿßŸÜÿ©
        function displaySparePartsData(data = sparePartsData) {
            const tbody = document.getElementById('sparePartsTableBody');
            if (!tbody) return;
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 3rem; color: #666;">
                            <i class="fas fa-cogs" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
                            ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÇÿ∑ÿπ ÿµŸäÿßŸÜÿ© ŸÖÿ≥ÿ¨ŸÑÿ© ÿ≠ÿßŸÑŸäÿßŸã
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.map((item, index) => {
                let stockStatus, statusBadge, rowStyle;
                
                if (item.quantity === 0) {
                    stockStatus = 'ŸÜÿßŸÅÿØ';
                    statusBadge = '<span class="badge" style="background: #ef4444;">ŸÜÿßŸÅÿØ</span>';
                    rowStyle = 'background: rgba(239, 68, 68, 0.1);';
                } else if (item.quantity <= item.minStock) {
                    stockStatus = 'ŸÇŸÑŸäŸÑ';
                    statusBadge = '<span class="badge" style="background: #f59e0b;">ŸÇŸÑŸäŸÑ</span>';
                    rowStyle = 'background: rgba(245, 158, 11, 0.1);';
                } else {
                    stockStatus = 'ŸÖÿ™ŸàŸÅÿ±';
                    statusBadge = '<span class="badge" style="background: #10b981;">ŸÖÿ™ŸàŸÅÿ±</span>';
                    rowStyle = '';
                }
                
                const categoryNames = {
                    'electronics': 'ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿßÿ™',
                    'mechanical': 'ŸÖŸäŸÉÿßŸÜŸäŸÉŸäÿ©',
                    'tools': 'ÿ£ÿØŸàÿßÿ™',
                    'accessories': 'ÿ•ŸÉÿ≥ÿ≥Ÿàÿßÿ±ÿßÿ™',
                    'other': 'ÿ£ÿÆÿ±Ÿâ'
                };
                
                return `
                    <tr style="${rowStyle}">
                        <td>${index + 1}</td>
                        <td><strong>${item.name}</strong>${item.code ? '<br><small style="color: #666;">(' + item.code + ')</small>' : ''}</td>
                        <td>${categoryNames[item.category] || item.category}</td>
                        <td>${item.supplier}</td>
                        <td>${formatCurrency(item.purchasePrice)}</td>
                        <td><strong style="color: #10b981;">${formatCurrency(item.retailPrice)}</strong></td>
                        <td><strong style="color: #06b6d4;">${formatCurrency(item.wholesalePrice)}</strong></td>
                        <td><strong>${item.quantity}</strong></td>
                        <td>${statusBadge}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                <button class="btn btn-sm btn-info" onclick="showSparePartDetails(${item.id})" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="editSparePart(${item.id})" title="ÿ™ÿπÿØŸäŸÑ">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-success" onclick="adjustStock(${item.id})" title="ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÉŸÖŸäÿ©">
                                    <i class="fas fa-boxes"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSparePart(${item.id})" title="ÿ≠ÿ∞ŸÅ">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateSupplierFilter();
        }

        // ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÇÿ∑ÿπÿ©
        function showSparePartDetails(id) {
            const item = sparePartsData.find(p => p.id === id);
            if (!item) return;
            
            const categoryNames = {
                'electronics': 'ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿßÿ™',
                'mechanical': 'ŸÖŸäŸÉÿßŸÜŸäŸÉŸäÿ©',
                'tools': 'ÿ£ÿØŸàÿßÿ™',
                'accessories': 'ÿ•ŸÉÿ≥ÿ≥Ÿàÿßÿ±ÿßÿ™',
                'other': 'ÿ£ÿÆÿ±Ÿâ'
            };
            
            const profit = item.retailPrice - item.purchasePrice;
            const profitMargin = ((profit / item.purchasePrice) * 100).toFixed(2);
            const totalValue = item.quantity * item.purchasePrice;
            const expectedProfit = item.quantity * profit;
            
            const modalHTML = `
                <div class="modal active" id="sparePartDetailsModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h2><i class="fas fa-cogs"></i> ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÇÿ∑ÿπÿ©</h2>
                            <button class="close-btn" onclick="closeSparePartDetailsModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="display: grid; gap: 1.5rem;">
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-box"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ∑ÿπÿ©:</span>
                                    <span class="info-value"><strong>${item.name}</strong></span>
                                </div>
                                ${item.code ? `
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-barcode"></i> ÿßŸÑŸÉŸàÿØ:</span>
                                    <span class="info-value">${item.code}</span>
                                </div>` : ''}
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-layer-group"></i> ÿßŸÑÿ™ÿµŸÜŸäŸÅ:</span>
                                    <span class="info-value">${categoryNames[item.category]}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-building"></i> ÿßŸÑŸÖŸàÿ±ÿØ:</span>
                                    <span class="info-value">${item.supplier}${item.supplierPhone ? ' - ' + item.supplierPhone : ''}</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 8px;">
                                    <div class="info-row" style="flex-direction: column; align-items: flex-start; border: none; padding: 0;">
                                        <span class="info-label"><i class="fas fa-shopping-cart"></i> ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°:</span>
                                        <span class="info-value" style="font-size: 1.2rem;"><strong>${formatCurrency(item.purchasePrice)}</strong></span>
                                    </div>
                                    <div class="info-row" style="flex-direction: column; align-items: flex-start; border: none; padding: 0;">
                                        <span class="info-label"><i class="fas fa-tag"></i> ÿ≥ÿπÿ± ÿßŸÑŸÖŸÅÿ±ÿØ:</span>
                                        <span class="info-value" style="font-size: 1.2rem; color: #10b981;"><strong>${formatCurrency(item.retailPrice)}</strong></span>
                                    </div>
                                    <div class="info-row" style="flex-direction: column; align-items: flex-start; border: none; padding: 0;">
                                        <span class="info-label"><i class="fas fa-tags"></i> ÿ≥ÿπÿ± ÿßŸÑÿ¨ŸÖŸÑÿ©:</span>
                                        <span class="info-value" style="font-size: 1.2rem; color: #06b6d4;"><strong>${formatCurrency(item.wholesalePrice)}</strong></span>
                                    </div>
                                    <div class="info-row" style="flex-direction: column; align-items: flex-start; border: none; padding: 0;">
                                        <span class="info-label"><i class="fas fa-chart-line"></i> ŸáÿßŸÖÿ¥ ÿßŸÑÿ±ÿ®ÿ≠:</span>
                                        <span class="info-value" style="font-size: 1.2rem; color: #8b5cf6;"><strong>${profitMargin}%</strong></span>
                                    </div>
                                </div>
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-boxes"></i> ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸÖÿ™ŸàŸÅÿ±ÿ©:</span>
                                    <span class="info-value"><strong style="font-size: 1.3rem;">${item.quantity}</strong></span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-exclamation-triangle"></i> ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ:</span>
                                    <span class="info-value">${item.minStock}</span>
                                </div>
                                ${item.location ? `
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-map-marker-alt"></i> ŸÖŸàŸÇÿπ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ:</span>
                                    <span class="info-value">${item.location}</span>
                                </div>` : ''}
                                ${item.invoiceNumber ? `
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-file-invoice"></i> ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:</span>
                                    <span class="info-value">${item.invoiceNumber}</span>
                                </div>` : ''}
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; padding: 1rem; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 8px;">
                                    <div class="info-row" style="flex-direction: column; align-items: flex-start; border: none; padding: 0;">
                                        <span class="info-label"><i class="fas fa-money-bill-wave"></i> ŸÇŸäŸÖÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ:</span>
                                        <span class="info-value" style="font-size: 1.1rem;"><strong>${formatCurrency(totalValue)}</strong></span>
                                    </div>
                                    <div class="info-row" style="flex-direction: column; align-items: flex-start; border: none; padding: 0;">
                                        <span class="info-label"><i class="fas fa-chart-line"></i> ÿßŸÑÿ±ÿ®ÿ≠ ÿßŸÑŸÖÿ™ŸàŸÇÿπ:</span>
                                        <span class="info-value" style="font-size: 1.1rem; color: #10b981;"><strong>${formatCurrency(expectedProfit)}</strong></span>
                                    </div>
                                </div>
                                ${item.description ? `
                                <div class="info-row" style="flex-direction: column; align-items: flex-start;">
                                    <span class="info-label"><i class="fas fa-sticky-note"></i> ÿßŸÑŸàÿµŸÅ:</span>
                                    <span class="info-value" style="margin-top: 0.5rem; padding: 1rem; background: #f3f4f6; border-radius: 8px; width: 100%;">${item.description}</span>
                                </div>` : ''}
                                ${item.specs ? `
                                <div class="info-row" style="flex-direction: column; align-items: flex-start;">
                                    <span class="info-label"><i class="fas fa-info-circle"></i> ÿßŸÑŸÖŸàÿßÿµŸÅÿßÿ™:</span>
                                    <span class="info-value" style="margin-top: 0.5rem; padding: 1rem; background: #f3f4f6; border-radius: 8px; width: 100%;">${item.specs}</span>
                                </div>` : ''}
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-user"></i> ÿ£ÿ∂ŸäŸÅ ÿ®Ÿàÿßÿ≥ÿ∑ÿ©:</span>
                                    <span class="info-value">${item.addedBy || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©:</span>
                                    <span class="info-value">${formatDate(item.addedDate)}</span>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="closeSparePartDetailsModal()" style="width: 100%; margin-top: 1.5rem;">
                                <i class="fas fa-times"></i> ÿ•ÿ∫ŸÑÿßŸÇ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeSparePartDetailsModal() {
            const modal = document.getElementById('sparePartDetailsModal');
            if (modal) modal.remove();
        }

        // ÿØÿßŸÑÿ© ÿ™ÿπÿØŸäŸÑ ŸÇÿ∑ÿπÿ© ÿßŸÑÿµŸäÿßŸÜÿ©
        function editSparePart(id) {
            const item = sparePartsData.find(p => p.id === id);
            if (!item) return;
            
            const modalHTML = `
                <div class="modal active" id="editSparePartModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 900px; width: 90%;">
                        <div class="modal-header">
                            <h2><i class="fas fa-edit"></i> ÿ™ÿπÿØŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÇÿ∑ÿπÿ©</h2>
                            <button class="close-btn" onclick="closeSparePartModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="editSparePartForm" onsubmit="updateSparePart(event, ${id})">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                    <div class="form-group">
                                        <label><i class="fas fa-box"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ∑ÿπÿ© *</label>
                                        <input type="text" id="editSparePartName" class="form-control" required value="${item.name}">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-barcode"></i> ÿßŸÑŸÉŸàÿØ/ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ</label>
                                        <input type="text" id="editSparePartCode" class="form-control" value="${item.code || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-layer-group"></i> ÿßŸÑÿ™ÿµŸÜŸäŸÅ *</label>
                                        <select id="editSparePartCategory" class="form-control" required>
                                            <option value="electronics" ${item.category === 'electronics' ? 'selected' : ''}>ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿßÿ™</option>
                                            <option value="mechanical" ${item.category === 'mechanical' ? 'selected' : ''}>ŸÖŸäŸÉÿßŸÜŸäŸÉŸäÿ©</option>
                                            <option value="tools" ${item.category === 'tools' ? 'selected' : ''}>ÿ£ÿØŸàÿßÿ™</option>
                                            <option value="accessories" ${item.category === 'accessories' ? 'selected' : ''}>ÿ•ŸÉÿ≥ÿ≥Ÿàÿßÿ±ÿßÿ™</option>
                                            <option value="other" ${item.category === 'other' ? 'selected' : ''}>ÿ£ÿÆÿ±Ÿâ</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-building"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ±ÿØ *</label>
                                        <input type="text" id="editSparePartSupplier" class="form-control" required value="${item.supplier}">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-phone"></i> Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖŸàÿ±ÿØ</label>
                                        <input type="text" id="editSparePartSupplierPhone" class="form-control" value="${item.supplierPhone || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-shopping-cart"></i> ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ° (ÿØŸäŸÜÿßÿ±) *</label>
                                        <input type="number" id="editSparePartPurchasePrice" class="form-control" required min="0" step="1000" value="${item.purchasePrice}">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-tag"></i> ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ ÿßŸÑŸÖŸÅÿ±ÿØ (ÿØŸäŸÜÿßÿ±) *</label>
                                        <input type="number" id="editSparePartRetailPrice" class="form-control" required min="0" step="1000" value="${item.retailPrice}">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-tags"></i> ÿ≥ÿπÿ± ÿßŸÑÿ¨ŸÖŸÑÿ© (ÿØŸäŸÜÿßÿ±) *</label>
                                        <input type="number" id="editSparePartWholesalePrice" class="form-control" required min="0" step="1000" value="${item.wholesalePrice}">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-boxes"></i> ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸÖÿ™ŸàŸÅÿ±ÿ© *</label>
                                        <input type="number" id="editSparePartQuantity" class="form-control" required min="0" step="1" value="${item.quantity}">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-exclamation-triangle"></i> ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑŸÑÿ™ŸÜÿ®ŸäŸá</label>
                                        <input type="number" id="editSparePartMinStock" class="form-control" min="0" step="1" value="${item.minStock}">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-map-marker-alt"></i> ŸÖŸàŸÇÿπ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ</label>
                                        <input type="text" id="editSparePartLocation" class="form-control" value="${item.location || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-file-invoice"></i> ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</label>
                                        <input type="text" id="editSparePartInvoiceNumber" class="form-control" value="${item.invoiceNumber || ''}">
                                    </div>
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label><i class="fas fa-sticky-note"></i> ÿßŸÑŸàÿµŸÅ ŸàÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</label>
                                        <textarea id="editSparePartDescription" class="form-control" rows="3">${item.description || ''}</textarea>
                                    </div>
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label><i class="fas fa-info-circle"></i> ÿßŸÑŸÖŸàÿßÿµŸÅÿßÿ™ ÿßŸÑŸÅŸÜŸäÿ©</label>
                                        <textarea id="editSparePartSpecs" class="form-control" rows="2">${item.specs || ''}</textarea>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                                        <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="closeSparePartModal()" style="flex: 1;">
                                        <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // ÿØÿßŸÑÿ© ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿ∑ÿπÿ© ÿßŸÑÿµŸäÿßŸÜÿ©
        function updateSparePart(event, id) {
            event.preventDefault();
            
            const index = sparePartsData.findIndex(p => p.id === id);
            if (index === -1) return;
            
            sparePartsData[index] = {
                ...sparePartsData[index],
                name: document.getElementById('editSparePartName').value,
                code: document.getElementById('editSparePartCode').value,
                category: document.getElementById('editSparePartCategory').value,
                supplier: document.getElementById('editSparePartSupplier').value,
                supplierPhone: document.getElementById('editSparePartSupplierPhone').value,
                purchasePrice: parseFloat(document.getElementById('editSparePartPurchasePrice').value),
                retailPrice: parseFloat(document.getElementById('editSparePartRetailPrice').value),
                wholesalePrice: parseFloat(document.getElementById('editSparePartWholesalePrice').value),
                quantity: parseInt(document.getElementById('editSparePartQuantity').value),
                minStock: parseInt(document.getElementById('editSparePartMinStock').value),
                location: document.getElementById('editSparePartLocation').value,
                invoiceNumber: document.getElementById('editSparePartInvoiceNumber').value,
                description: document.getElementById('editSparePartDescription').value,
                specs: document.getElementById('editSparePartSpecs').value,
                lastModified: new Date().toISOString()
            };
            
            localStorage.setItem('sparePartsData', JSON.stringify(sparePartsData));
            
            closeSparePartModal();
            displaySparePartsData();
            updateSparePartsStats();
            checkStockAlerts();
            
            showNotification('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÇÿ∑ÿπÿ© ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
        }

        // ÿØÿßŸÑÿ© ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÉŸÖŸäÿ©
        function adjustStock(id) {
            const item = sparePartsData.find(p => p.id === id);
            if (!item) return;
            
            const modalHTML = `
                <div class="modal active" id="adjustStockModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h2><i class="fas fa-boxes"></i> ÿ™ÿπÿØŸäŸÑ ŸÉŸÖŸäÿ©: ${item.name}</h2>
                            <button class="close-btn" onclick="closeAdjustStockModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="text-align: center; padding: 1rem; background: #f3f4f6; border-radius: 8px; margin-bottom: 1.5rem;">
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©</div>
                                <div style="font-size: 2rem; font-weight: bold; color: #6366f1;">${item.quantity}</div>
                            </div>
                            <form id="adjustStockForm" onsubmit="saveStockAdjustment(event, ${id})">
                                <div class="form-group">
                                    <label><i class="fas fa-exchange-alt"></i> ŸÜŸàÿπ ÿßŸÑÿπŸÖŸÑŸäÿ© *</label>
                                    <select id="adjustType" class="form-control" required onchange="updateAdjustmentType()">
                                        <option value="">ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿπŸÖŸÑŸäÿ©</option>
                                        <option value="add">ÿ•ÿ∂ÿßŸÅÿ© (+)</option>
                                        <option value="subtract">ÿ≥ÿ≠ÿ® (-)</option>
                                        <option value="set">ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÉŸÖŸäÿ©</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label><i class="fas fa-calculator"></i> <span id="quantityLabel">ÿßŸÑŸÉŸÖŸäÿ© *</span></label>
                                    <input type="number" id="adjustQuantity" class="form-control" required min="0" step="1" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label><i class="fas fa-sticky-note"></i> ÿßŸÑÿ≥ÿ®ÿ®</label>
                                    <textarea id="adjustReason" class="form-control" rows="2" placeholder="ÿ≥ÿ®ÿ® ÿßŸÑÿ™ÿπÿØŸäŸÑ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)"></textarea>
                                </div>
                                <div id="newQuantityPreview" style="display: none; padding: 1rem; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 8px; margin-top: 1rem; text-align: center;">
                                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©</div>
                                    <div id="newQuantityValue" style="font-size: 1.5rem; font-weight: bold; color: #10b981;"></div>
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                                        <i class="fas fa-check"></i> ÿ™ÿ£ŸÉŸäÿØ
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="closeAdjustStockModal()" style="flex: 1;">
                                        <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπ ŸÑŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
            document.getElementById('adjustQuantity').addEventListener('input', updateAdjustmentPreview);
        }

        function updateAdjustmentType() {
            const type = document.getElementById('adjustType').value;
            const label = document.getElementById('quantityLabel');
            
            switch(type) {
                case 'add':
                    label.textContent = 'ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸÖÿ∂ÿßŸÅÿ© *';
                    break;
                case 'subtract':
                    label.textContent = 'ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸÖÿ≥ÿ≠Ÿàÿ®ÿ© *';
                    break;
                case 'set':
                    label.textContent = 'ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© *';
                    break;
            }
            
            updateAdjustmentPreview();
        }

        function updateAdjustmentPreview() {
            const type = document.getElementById('adjustType')?.value;
            const quantity = parseInt(document.getElementById('adjustQuantity')?.value) || 0;
            const preview = document.getElementById('newQuantityPreview');
            const previewValue = document.getElementById('newQuantityValue');
            
            if (!type || !preview || !previewValue) return;
            
            const currentQuantity = parseInt(document.querySelector('#adjustStockModal .modal-body > div > div:last-child').textContent);
            let newQuantity;
            
            switch(type) {
                case 'add':
                    newQuantity = currentQuantity + quantity;
                    break;
                case 'subtract':
                    newQuantity = Math.max(0, currentQuantity - quantity);
                    break;
                case 'set':
                    newQuantity = quantity;
                    break;
                default:
                    preview.style.display = 'none';
                    return;
            }
            
            preview.style.display = 'block';
            previewValue.textContent = newQuantity;
            previewValue.style.color = newQuantity < currentQuantity ? '#ef4444' : '#10b981';
        }

        function saveStockAdjustment(event, id) {
            event.preventDefault();
            
            const type = document.getElementById('adjustType').value;
            const quantity = parseInt(document.getElementById('adjustQuantity').value);
            const reason = document.getElementById('adjustReason').value;
            
            const index = sparePartsData.findIndex(p => p.id === id);
            if (index === -1) return;
            
            const oldQuantity = sparePartsData[index].quantity;
            let newQuantity;
            
            switch(type) {
                case 'add':
                    newQuantity = oldQuantity + quantity;
                    break;
                case 'subtract':
                    newQuantity = Math.max(0, oldQuantity - quantity);
                    break;
                case 'set':
                    newQuantity = quantity;
                    break;
            }
            
            sparePartsData[index].quantity = newQuantity;
            sparePartsData[index].lastModified = new Date().toISOString();
            
            // ÿ≠ŸÅÿ∏ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑ
            if (!sparePartsData[index].adjustmentHistory) {
                sparePartsData[index].adjustmentHistory = [];
            }
            sparePartsData[index].adjustmentHistory.push({
                date: new Date().toISOString(),
                type: type,
                oldQuantity: oldQuantity,
                newQuantity: newQuantity,
                changeAmount: quantity,
                reason: reason,
                user: currentUser
            });
            
            localStorage.setItem('sparePartsData', JSON.stringify(sparePartsData));
            
            closeAdjustStockModal();
            displaySparePartsData();
            updateSparePartsStats();
            checkStockAlerts();
            
            showNotification(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÉŸÖŸäÿ© ŸÖŸÜ ${oldQuantity} ÿ•ŸÑŸâ ${newQuantity}`, 'success');
        }

        function closeAdjustStockModal() {
            const modal = document.getElementById('adjustStockModal');
            if (modal) modal.remove();
        }

        // ÿØÿßŸÑÿ© ÿ≠ÿ∞ŸÅ ŸÇÿ∑ÿπÿ© ÿµŸäÿßŸÜÿ©
        function deleteSparePart(id) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÇÿ∑ÿπÿ©ÿü')) return;
            
            sparePartsData = sparePartsData.filter(p => p.id !== id);
            localStorage.setItem('sparePartsData', JSON.stringify(sparePartsData));
            
            displaySparePartsData();
            updateSparePartsStats();
            checkStockAlerts();
            
            showNotification('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÇÿ∑ÿπÿ© ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
        }

        // ÿØÿßŸÑÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
        function updateSparePartsStats() {
            const total = sparePartsData.length;
            const totalQuantity = sparePartsData.reduce((sum, p) => sum + p.quantity, 0);
            const lowStock = sparePartsData.filter(p => p.quantity > 0 && p.quantity <= p.minStock).length;
            const outOfStock = sparePartsData.filter(p => p.quantity === 0).length;
            const totalValue = sparePartsData.reduce((sum, p) => sum + (p.quantity * p.purchasePrice), 0);
            const expectedProfit = sparePartsData.reduce((sum, p) => sum + (p.quantity * (p.retailPrice - p.purchasePrice)), 0);
            
            updateElement('totalSpareParts', total);
            updateElement('totalSparePartsQuantity', totalQuantity);
            updateElement('lowStockSpareParts', lowStock);
            updateElement('outOfStockSpareParts', outOfStock);
            updateElement('totalSparePartsValue', formatCurrency(totalValue));
            updateElement('expectedSparePartsProfit', formatCurrency(expectedProfit));
        }

        // ÿØÿßŸÑÿ© ŸÅÿ≠ÿµ ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™
        function checkStockAlerts() {
            const alertsContainer = document.getElementById('sparePartsAlerts');
            if (!alertsContainer) return;
            
            const outOfStock = sparePartsData.filter(p => p.quantity === 0);
            const lowStock = sparePartsData.filter(p => p.quantity > 0 && p.quantity <= p.minStock);
            
            if (outOfStock.length === 0 && lowStock.length === 0) {
                alertsContainer.innerHTML = '';
                return;
            }
            
            let alertsHTML = '';
            
            if (outOfStock.length > 0) {
                alertsHTML += `
                    <div class="alert alert-danger" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 8px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1)); border-left: 4px solid #ef4444;">
                        <i class="fas fa-times-circle" style="font-size: 2rem; color: #ef4444;"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 0.5rem;">
                                <i class="fas fa-exclamation-triangle"></i> ÿ™ŸÜÿ®ŸäŸá: ${outOfStock.length} ŸÇÿ∑ÿπÿ© ŸÜÿßŸÅÿØÿ©
                            </div>
                            <div style="font-size: 0.9rem; color: #666;">
                                ${outOfStock.map(p => p.name).join(', ')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (lowStock.length > 0) {
                alertsHTML += `
                    <div class="alert alert-warning" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 8px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1)); border-left: 4px solid #f59e0b; margin-top: ${outOfStock.length > 0 ? '1rem' : '0'};">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #f59e0b;"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 0.5rem;">
                                <i class="fas fa-info-circle"></i> ÿ™ŸÜÿ®ŸäŸá: ${lowStock.length} ŸÇÿ∑ÿπÿ© ŸÇŸÑŸäŸÑÿ©
                            </div>
                            <div style="font-size: 0.9rem; color: #666;">
                                ${lowStock.map(p => `${p.name} (${p.quantity})`).join(', ')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            alertsContainer.innerHTML = alertsHTML;
        }

        // ÿØÿßŸÑÿ© ÿßŸÑÿ®ÿ≠ÿ´
        function filterSpareParts() {
            const searchTerm = document.getElementById('sparePartsSearchInput').value.toLowerCase();
            
            const filtered = sparePartsData.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                (item.code && item.code.toLowerCase().includes(searchTerm)) ||
                item.supplier.toLowerCase().includes(searchTerm) ||
                item.category.toLowerCase().includes(searchTerm)
            );
            
            displaySparePartsData(filtered);
        }

        // ÿØŸàÿßŸÑ ÿßŸÑŸÅŸÑÿ™ÿ±ÿ©
        function filterSparePartsByStock() {
            const status = document.getElementById('sparePartsStockFilter').value;
            
            let filtered = sparePartsData;
            if (status !== 'all') {
                filtered = sparePartsData.filter(p => {
                    switch(status) {
                        case 'available':
                            return p.quantity > p.minStock;
                        case 'low':
                            return p.quantity > 0 && p.quantity <= p.minStock;
                        case 'out':
                            return p.quantity === 0;
                        default:
                            return true;
                    }
                });
            }
            
            displaySparePartsData(filtered);
        }

        function filterSparePartsBySupplier() {
            const supplier = document.getElementById('sparePartsSupplierFilter').value;
            
            let filtered = sparePartsData;
            if (supplier !== 'all') {
                filtered = sparePartsData.filter(p => p.supplier === supplier);
            }
            
            displaySparePartsData(filtered);
        }

        function filterSparePartsByCategory() {
            const category = document.getElementById('sparePartsCategoryFilter').value;
            
            let filtered = sparePartsData;
            if (category !== 'all') {
                filtered = sparePartsData.filter(p => p.category === category);
            }
            
            displaySparePartsData(filtered);
        }

        function filterSparePartsByPrice() {
            const priceRange = document.getElementById('sparePartsPriceFilter').value;
            
            let filtered = sparePartsData;
            if (priceRange !== 'all') {
                if (priceRange.includes('+')) {
                    const minPrice = parseInt(priceRange.replace('+', ''));
                    filtered = sparePartsData.filter(p => p.retailPrice >= minPrice);
                } else {
                    const [min, max] = priceRange.split('-').map(Number);
                    filtered = sparePartsData.filter(p => p.retailPrice >= min && p.retailPrice <= max);
                }
            }
            
            displaySparePartsData(filtered);
        }

        function resetSparePartsFilters() {
            document.getElementById('sparePartsStockFilter').value = 'all';
            document.getElementById('sparePartsSupplierFilter').value = 'all';
            document.getElementById('sparePartsCategoryFilter').value = 'all';
            document.getElementById('sparePartsPriceFilter').value = 'all';
            document.getElementById('sparePartsSearchInput').value = '';
            
            displaySparePartsData();
        }

        // ÿØÿßŸÑÿ© ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸàÿ±ÿØŸäŸÜ
        function updateSupplierFilter() {
            const supplierFilter = document.getElementById('sparePartsSupplierFilter');
            if (!supplierFilter) return;
            
            const suppliers = [...new Set(sparePartsData.map(p => p.supplier))];
            
            const currentValue = supplierFilter.value;
            supplierFilter.innerHTML = '<option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸàÿ±ÿØŸäŸÜ</option>';
            
            suppliers.forEach(supplier => {
                supplierFilter.innerHTML += `<option value="${supplier}">${supplier}</option>`;
            });
            
            supplierFilter.value = currentValue;
        }

        // ÿØÿßŸÑÿ© ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        function importSparePartsData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let importedData = [];
                    
                    if (file.name.endsWith('.json')) {
                        importedData = JSON.parse(e.target.result);
                    } else {
                        showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖŸÑŸÅÿßÿ™ JSON ŸÑŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ', 'warning');
                        return;
                    }
                    
                    if (!Array.isArray(importedData)) {
                        throw new Error('ÿµŸäÿ∫ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                    }
                    
                    importedData.forEach(item => {
                        if (!sparePartsData.find(p => p.id === item.id)) {
                            sparePartsData.push(item);
                        }
                    });
                    
                    localStorage.setItem('sparePartsData', JSON.stringify(sparePartsData));
                    
                    displaySparePartsData();
                    updateSparePartsStats();
                    checkStockAlerts();
                    
                    showNotification(`ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${importedData.length} ŸÇÿ∑ÿπÿ© ÿ®ŸÜÿ¨ÿßÿ≠`, 'success');
                } catch (error) {
                    showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + error.message, 'error');
                }
                
                input.value = '';
            };
            
            reader.readAsText(file);
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿØÿßŸÑÿ© exportData ŸÑÿØÿπŸÖ ŸÇÿ∑ÿπ ÿßŸÑÿµŸäÿßŸÜÿ©
        const originalExportDataSpareParts = exportData;
        exportData = async function(type, format) {
            if (type === 'spareParts') {
                if (sparePartsData.length === 0) {
                    showNotification('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±', 'warning');
                    return;
                }
                
                const filename = 'ŸÇÿ∑ÿπ_ÿßŸÑÿµŸäÿßŸÜÿ©';
                
                try {
                    switch(format) {
                        case 'json':
                            exportToJSON(sparePartsData, filename);
                            break;
                        case 'excel':
                            exportSparePartsToExcel(sparePartsData, filename);
                            break;
                        case 'word':
                            exportSparePartsToWord(sparePartsData, filename);
                            break;
                        case 'pdf':
                            exportSparePartsToPDF(sparePartsData, filename);
                            break;
                    }
                } catch (error) {
                    showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿµÿØŸäÿ±', 'error');
                }
            } else {
                return originalExportDataSpareParts(type, format);
            }
        };

        // ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿµÿØŸäÿ±
        function exportSparePartsToExcel(data, filename) {
            const categoryNames = {
                'electronics': 'ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿßÿ™',
                'mechanical': 'ŸÖŸäŸÉÿßŸÜŸäŸÉŸäÿ©',
                'tools': 'ÿ£ÿØŸàÿßÿ™',
                'accessories': 'ÿ•ŸÉÿ≥ÿ≥Ÿàÿßÿ±ÿßÿ™',
                'other': 'ÿ£ÿÆÿ±Ÿâ'
            };
            
            const ws_data = [
                ['#', 'ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ∑ÿπÿ©', 'ÿßŸÑŸÉŸàÿØ', 'ÿßŸÑÿ™ÿµŸÜŸäŸÅ', 'ÿßŸÑŸÖŸàÿ±ÿØ', 'Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖŸàÿ±ÿØ', 'ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°', 'ÿ≥ÿπÿ± ÿßŸÑŸÖŸÅÿ±ÿØ', 'ÿ≥ÿπÿ± ÿßŸÑÿ¨ŸÖŸÑÿ©', 'ÿßŸÑŸÉŸÖŸäÿ©', 'ÿßŸÑŸÖŸàŸÇÿπ', 'ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©']
            ];
            
            data.forEach((item, index) => {
                ws_data.push([
                    index + 1,
                    item.name,
                    item.code || '',
                    categoryNames[item.category],
                    item.supplier,
                    item.supplierPhone || '',
                    item.purchasePrice,
                    item.retailPrice,
                    item.wholesalePrice,
                    item.quantity,
                    item.location || '',
                    item.invoiceNumber || ''
                ]);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            ws['!cols'] = [
                {wch: 5}, {wch: 25}, {wch: 15}, {wch: 15}, {wch: 20},
                {wch: 15}, {wch: 12}, {wch: 12}, {wch: 12}, {wch: 8}, {wch: 20}, {wch: 15}
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'ŸÇÿ∑ÿπ ÿßŸÑÿµŸäÿßŸÜÿ©');
            XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportSparePartsToWord(data, filename) {
            const categoryNames = {
                'electronics': 'ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿßÿ™',
                'mechanical': 'ŸÖŸäŸÉÿßŸÜŸäŸÉŸäÿ©',
                'tools': 'ÿ£ÿØŸàÿßÿ™',
                'accessories': 'ÿ•ŸÉÿ≥ÿ≥Ÿàÿßÿ±ÿßÿ™',
                'other': 'ÿ£ÿÆÿ±Ÿâ'
            };
            
            let content = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset='utf-8'>
                    <style>
                        body { direction: rtl; font-family: Arial; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: right; font-size: 12px; }
                        th { background-color: #4CAF50; color: white; }
                        h1 { text-align: center; color: #333; }
                    </style>
                </head>
                <body>
                    <h1>ÿ™ŸÇÿ±Ÿäÿ± ŸÇÿ∑ÿπ ÿßŸÑÿµŸäÿßŸÜÿ©</h1>
                    <p>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿµÿØŸäÿ±: ${new Date().toLocaleDateString('ar-IQ')}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>ÿßŸÑŸÇÿ∑ÿπÿ©</th>
                                <th>ÿßŸÑÿ™ÿµŸÜŸäŸÅ</th>
                                <th>ÿßŸÑŸÖŸàÿ±ÿØ</th>
                                <th>ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°</th>
                                <th>ÿ≥ÿπÿ± ÿßŸÑŸÖŸÅÿ±ÿØ</th>
                                <th>ÿßŸÑŸÉŸÖŸäÿ©</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach((item, index) => {
                content += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.name}</td>
                        <td>${categoryNames[item.category]}</td>
                        <td>${item.supplier}</td>
                        <td>${formatCurrency(item.purchasePrice)}</td>
                        <td>${formatCurrency(item.retailPrice)}</td>
                        <td>${item.quantity}</td>
                    </tr>
                `;
            });
            
            content += `
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            const blob = new Blob(['\ufeff', content], {
                type: 'application/msword'
            });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${filename}_${new Date().toISOString().split('T')[0]}.doc`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function exportSparePartsToPDF(data, filename) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            doc.addFont('https://cdn.jsdelivr.net/npm/amiri-font@1.0.0/Amiri-Regular.ttf', 'Amiri', 'normal');
            doc.setFont('Amiri');
            
            doc.setFontSize(18);
            doc.text('ÿ™ŸÇÿ±Ÿäÿ± ŸÇÿ∑ÿπ ÿßŸÑÿµŸäÿßŸÜÿ©', 148, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿµÿØŸäÿ±: ${new Date().toLocaleDateString('ar-IQ')}`, 148, 30, { align: 'center' });
            
            const categoryNames = {
                'electronics': 'ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿßÿ™',
                'mechanical': 'ŸÖŸäŸÉÿßŸÜŸäŸÉŸäÿ©',
                'tools': 'ÿ£ÿØŸàÿßÿ™',
                'accessories': 'ÿ•ŸÉÿ≥ÿ≥Ÿàÿßÿ±ÿßÿ™',
                'other': 'ÿ£ÿÆÿ±Ÿâ'
            };
            
            const tableData = data.map((item, index) => [
                (index + 1).toString(),
                item.name,
                categoryNames[item.category],
                item.supplier,
                formatCurrency(item.purchasePrice),
                formatCurrency(item.retailPrice),
                item.quantity.toString()
            ]);
            
            doc.autoTable({
                startY: 40,
                head: [['#', 'ÿßŸÑŸÇÿ∑ÿπÿ©', 'ÿßŸÑÿ™ÿµŸÜŸäŸÅ', 'ÿßŸÑŸÖŸàÿ±ÿØ', 'ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°', 'ÿ≥ÿπÿ± ÿßŸÑŸÖŸÅÿ±ÿØ', 'ÿßŸÑŸÉŸÖŸäÿ©']],
                body: tableData,
                styles: {
                    font: 'Amiri',
                    fontSize: 10,
                    halign: 'right'
                },
                headStyles: {
                    fillColor: [99, 102, 241],
                    textColor: 255,
                    fontSize: 11,
                    fontStyle: 'bold'
                },
                margin: { right: 10, left: 10 }
            });
            
            doc.save(`${filename}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // ÿ™ŸáŸäÿ¶ÿ© ÿµŸÅÿ≠ÿ© ŸÇÿ∑ÿπ ÿßŸÑÿµŸäÿßŸÜÿ©
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('spareParts')) {
                displaySparePartsData();
                updateSparePartsStats();
                checkStockAlerts();
            }
        });

        // ÿØÿßŸÑÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ¥ÿ±ÿßÿ°
        function showAddInvoiceModal() {
            const modalHTML = `
                <div class="modal active" id="addInvoiceModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 1000px; width: 95%;">
                        <div class="modal-header">
                            <h2><i class="fas fa-file-invoice"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ¥ÿ±ÿßÿ° ŸÇÿ∑ÿπ ÿµŸäÿßŸÜÿ©</h2>
                            <button class="close-btn" onclick="closeSparePartModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="invoiceForm" onsubmit="addPurchaseInvoice(event)">
                                <h3 style="margin-bottom: 1rem;"><i class="fas fa-info-circle"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</h3>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
                                    <div class="form-group">
                                        <label><i class="fas fa-file-invoice"></i> ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© *</label>
                                        <input type="text" id="invoiceNumber" class="form-control" required placeholder="INV-001">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-building"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ±ÿØ *</label>
                                        <input type="text" id="invoiceSupplier" class="form-control" required placeholder="ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿ™ŸÇŸÜŸäÿ©">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© *</label>
                                        <input type="date" id="invoiceDate" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-phone"></i> Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖŸàÿ±ÿØ</label>
                                        <input type="text" id="invoiceSupplierPhone" class="form-control" placeholder="07701234567">
                                    </div>
                                    <div class="form-group" style="grid-column: span 2;">
                                        <label><i class="fas fa-sticky-note"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</label>
                                        <input type="text" id="invoiceNotes" class="form-control" placeholder="ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©...">
                                    </div>
                                </div>
                                
                                <h3 style="margin-bottom: 1rem;"><i class="fas fa-boxes"></i> ŸÇÿ∑ÿπ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</h3>
                                <div id="invoiceItemsContainer" style="margin-bottom: 1rem;">
                                    <!-- ÿßŸÑŸÇÿ∑ÿπ ÿ≥ÿ™ÿ∂ÿßŸÅ ŸáŸÜÿß -->
                                </div>
                                
                                <button type="button" class="btn btn-success btn-sm" onclick="addInvoiceItem()" style="margin-bottom: 2rem;">
                                    <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ∑ÿπÿ©
                                </button>
                                
                                <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 8px; margin-bottom: 1.5rem;">
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
                                        <div>
                                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÇÿ∑ÿπ</div>
                                            <div id="totalInvoiceItems" style="font-size: 1.5rem; font-weight: bold; color: #6366f1;">0</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÖŸäÿ©</div>
                                            <div id="totalInvoiceQuantity" style="font-size: 1.5rem; font-weight: bold; color: #10b981;">0</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ŸÑÿ∫</div>
                                            <div id="totalInvoiceAmount" style="font-size: 1.5rem; font-weight: bold; color: #8b5cf6;">0 ÿØŸäŸÜÿßÿ±</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 1rem;">
                                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                                        <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="closeSparePartModal()" style="flex: 1;">
                                        <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ≠ÿßŸÑŸä
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDate').value = today;
            
            // ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ∑ÿπÿ© Ÿàÿßÿ≠ÿØÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂ŸäÿßŸã
            addInvoiceItem();
        }

        let invoiceItemCounter = 0;

        function addInvoiceItem() {
            invoiceItemCounter++;
            const container = document.getElementById('invoiceItemsContainer');
            
            const itemHTML = `
                <div class="invoice-item" id="invoiceItem${invoiceItemCounter}" style="padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0;"><i class="fas fa-box"></i> ŸÇÿ∑ÿπÿ© #${invoiceItemCounter}</h4>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeInvoiceItem(${invoiceItemCounter})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                        <div class="form-group" style="grid-column: span 2;">
                            <label><i class="fas fa-box"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ∑ÿπÿ© *</label>
                            <input type="text" class="form-control item-name" required placeholder="ŸÖÿ´ÿßŸÑ: ÿ¥ÿßÿ¥ÿ© ŸÑÿßÿ® ÿ™Ÿàÿ®">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-barcode"></i> ÿßŸÑŸÉŸàÿØ</label>
                            <input type="text" class="form-control item-code" placeholder="LCD-156">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-layer-group"></i> ÿßŸÑÿ™ÿµŸÜŸäŸÅ *</label>
                            <select class="form-control item-category" required>
                                <option value="">ÿßÿÆÿ™ÿ±...</option>
                                <option value="electronics">ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿßÿ™</option>
                                <option value="mechanical">ŸÖŸäŸÉÿßŸÜŸäŸÉŸäÿ©</option>
                                <option value="tools">ÿ£ÿØŸàÿßÿ™</option>
                                <option value="accessories">ÿ•ŸÉÿ≥ÿ≥Ÿàÿßÿ±ÿßÿ™</option>
                                <option value="other">ÿ£ÿÆÿ±Ÿâ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-shopping-cart"></i> ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ° *</label>
                            <input type="number" class="form-control item-purchase-price" required min="0" step="1000" placeholder="50000" onchange="updateInvoiceTotals()">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-tag"></i> ÿ≥ÿπÿ± ÿßŸÑŸÖŸÅÿ±ÿØ *</label>
                            <input type="number" class="form-control item-retail-price" required min="0" step="1000" placeholder="75000">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-tags"></i> ÿ≥ÿπÿ± ÿßŸÑÿ¨ŸÖŸÑÿ© *</label>
                            <input type="number" class="form-control item-wholesale-price" required min="0" step="1000" placeholder="65000">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-boxes"></i> ÿßŸÑŸÉŸÖŸäÿ© *</label>
                            <input type="number" class="form-control item-quantity" required min="1" step="1" placeholder="10" onchange="updateInvoiceTotals()">
                        </div>
                        <div class="form-group" style="grid-column: span 4;">
                            <label><i class="fas fa-sticky-note"></i> ŸàÿµŸÅ/ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</label>
                            <input type="text" class="form-control item-description" placeholder="ŸàÿµŸÅ ÿßŸÑŸÇÿ∑ÿπÿ©...">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', itemHTML);
            updateInvoiceTotals();
        }

        function removeInvoiceItem(id) {
            const item = document.getElementById('invoiceItem' + id);
            if (item) {
                item.remove();
                updateInvoiceTotals();
            }
        }

        function updateInvoiceTotals() {
            const items = document.querySelectorAll('.invoice-item');
            let totalItems = items.length;
            let totalQuantity = 0;
            let totalAmount = 0;
            
            items.forEach(item => {
                const quantity = parseInt(item.querySelector('.item-quantity')?.value) || 0;
                const price = parseFloat(item.querySelector('.item-purchase-price')?.value) || 0;
                
                totalQuantity += quantity;
                totalAmount += quantity * price;
            });
            
            document.getElementById('totalInvoiceItems').textContent = totalItems;
            document.getElementById('totalInvoiceQuantity').textContent = totalQuantity;
            document.getElementById('totalInvoiceAmount').textContent = formatCurrency(totalAmount);
        }

        function addPurchaseInvoice(event) {
            event.preventDefault();
            
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const supplier = document.getElementById('invoiceSupplier').value;
            const supplierPhone = document.getElementById('invoiceSupplierPhone').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const notes = document.getElementById('invoiceNotes').value;
            
            const items = [];
            const itemElements = document.querySelectorAll('.invoice-item');
            
            itemElements.forEach(itemEl => {
                const item = {
                    name: itemEl.querySelector('.item-name').value,
                    code: itemEl.querySelector('.item-code').value,
                    category: itemEl.querySelector('.item-category').value,
                    purchasePrice: parseFloat(itemEl.querySelector('.item-purchase-price').value),
                    retailPrice: parseFloat(itemEl.querySelector('.item-retail-price').value),
                    wholesalePrice: parseFloat(itemEl.querySelector('.item-wholesale-price').value),
                    quantity: parseInt(itemEl.querySelector('.item-quantity').value),
                    description: itemEl.querySelector('.item-description').value
                };
                items.push(item);
            });
            
            if (items.length === 0) {
                showNotification('Ÿäÿ¨ÿ® ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ∑ÿπÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ', 'warning');
                return;
            }
            
            // ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
            const invoice = {
                id: Date.now(),
                invoiceNumber: invoiceNumber,
                supplier: supplier,
                supplierPhone: supplierPhone,
                date: invoiceDate,
                notes: notes,
                items: items,
                totalItems: items.length,
                totalQuantity: items.reduce((sum, i) => sum + i.quantity, 0),
                totalAmount: items.reduce((sum, i) => sum + (i.quantity * i.purchasePrice), 0),
                addedBy: currentUser,
                addedDate: new Date().toISOString()
            };
            
            purchaseInvoicesData.push(invoice);
            localStorage.setItem('purchaseInvoicesData', JSON.stringify(purchaseInvoicesData));
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÇÿ∑ÿπ ÿ•ŸÑŸâ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
            items.forEach(item => {
                const existingPart = sparePartsData.find(p => 
                    p.name === item.name && p.code === item.code
                );
                
                if (existingPart) {
                    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÉŸÖŸäÿ©
                    existingPart.quantity += item.quantity;
                    existingPart.lastModified = new Date().toISOString();
                } else {
                    // ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ∑ÿπÿ© ÿ¨ÿØŸäÿØÿ©
                    const newPart = {
                        id: Date.now() + Math.random(),
                        name: item.name,
                        code: item.code,
                        category: item.category,
                        supplier: supplier,
                        supplierPhone: supplierPhone,
                        purchasePrice: item.purchasePrice,
                        retailPrice: item.retailPrice,
                        wholesalePrice: item.wholesalePrice,
                        quantity: item.quantity,
                        minStock: LOW_STOCK_THRESHOLD,
                        location: '',
                        invoiceNumber: invoiceNumber,
                        description: item.description,
                        specs: '',
                        addedBy: currentUser,
                        addedDate: new Date().toISOString(),
                        lastModified: new Date().toISOString()
                    };
                    sparePartsData.push(newPart);
                }
            });
            
            localStorage.setItem('sparePartsData', JSON.stringify(sparePartsData));
            
            closeSparePartModal();
            displaySparePartsData();
            updateSparePartsStats();
            checkStockAlerts();
            
            showNotification(`ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿßÿ™Ÿàÿ±ÿ© ${invoiceNumber} ÿ®ŸÜÿ¨ÿßÿ≠ ŸÖÿπ ${items.length} ŸÇÿ∑ÿπÿ©`, 'success');
        }

        // ŸÜŸáÿßŸäÿ© ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ŸÇÿ∑ÿπ ÿßŸÑÿµŸäÿßŸÜÿ©
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ© - Delivered Devices System
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // ŸÖÿµŸÅŸàŸÅÿ© ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ©
        let deliveredDevicesData = JSON.parse(localStorage.getItem('deliveredDevicesData')) || [];

        // ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ©
        function displayDeliveredDevicesData(data = deliveredDevicesData) {
            const tbody = document.getElementById('deliveredDevicesTableBody');
            if (!tbody) return;
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 3rem; color: #666;">
                            <i class="fas fa-check-double" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
                            ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿ¨Ÿáÿ≤ÿ© ŸÖÿ≥ÿ™ŸÑŸÖÿ© ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.map((item, index) => {
                const paymentMethods = {
                    'cash': '<span class="badge" style="background: #10b981;">ŸÜŸÇÿØÿßŸã</span>',
                    'card': '<span class="badge" style="background: #6366f1;">ÿ®ÿ∑ÿßŸÇÿ©</span>',
                    'transfer': '<span class="badge" style="background: #8b5cf6;">ÿ™ÿ≠ŸàŸäŸÑ</span>',
                    'mixed': '<span class="badge" style="background: #f59e0b;">ŸÖÿÆÿ™ŸÑÿ∑</span>'
                };
                
                const partsCount = item.usedParts ? item.usedParts.length : 0;
                const partsTotal = item.partsTotal || 0;
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${item.productName}</strong></td>
                        <td>${item.companyName}</td>
                        <td>${item.fault}</td>
                        <td>${formatCurrency(item.maintenancePrice)}</td>
                        <td>${partsCount > 0 ? `${partsCount} ŸÇÿ∑ÿπÿ©<br><small>(${formatCurrency(partsTotal)})</small>` : '-'}</td>
                        <td><strong style="color: #6366f1;">${formatCurrency(item.totalCost)}</strong></td>
                        <td><strong style="color: #10b981;">${formatCurrency(item.receivedAmount)}</strong></td>
                        <td>${formatDate(item.actualDeliveryDate)}</td>
                        <td>${paymentMethods[item.paymentMethod] || item.paymentMethod}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                <button class="btn btn-sm btn-info" onclick="showDeliveredDeviceDetails(${item.id})" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteDeliveredDevice(${item.id})" title="ÿ≠ÿ∞ŸÅ">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿ¨Ÿáÿßÿ≤ ŸÖÿ≥ÿ™ŸÑŸÖ
        function showDeliveredDeviceDetails(id) {
            const item = deliveredDevicesData.find(d => d.id === id);
            if (!item) return;
            
            const paymentMethods = {
                'cash': 'ŸÜŸÇÿØÿßŸã',
                'card': 'ÿ®ÿ∑ÿßŸÇÿ©',
                'transfer': 'ÿ™ÿ≠ŸàŸäŸÑ ÿ®ŸÜŸÉŸä',
                'mixed': 'ŸÖÿÆÿ™ŸÑÿ∑'
            };
            
            const modalHTML = `
                <div class="modal active" id="deliveredDeviceDetailsModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
                            <h2><i class="fas fa-check-circle"></i> ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ¨Ÿáÿßÿ≤ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖ</h2>
                            <button class="close-btn" onclick="closeDeliveredDeviceModal()" style="color: white;">&times;</button>
                        </div>
                        <div class="modal-body">
                            <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¨Ÿáÿßÿ≤ -->
                            <h3 style="color: var(--primary-color); margin-bottom: 1rem;">
                                <i class="fas fa-box"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¨Ÿáÿßÿ≤
                            </h3>
                            <div style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-box"></i> ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨:</span>
                                    <span class="info-value"><strong>${item.productName}</strong></span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-building"></i> ÿßŸÑÿ¥ÿ±ŸÉÿ©:</span>
                                    <span class="info-value">${item.companyName}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-exclamation-triangle"></i> ÿßŸÑÿÆŸÑŸÑ:</span>
                                    <span class="info-value" style="color: #ef4444;">${item.fault}</span>
                                </div>
                            </div>

                            <!-- ÿßŸÑÿ™ŸÉÿßŸÑŸäŸÅ -->
                            <h3 style="color: var(--primary-color); margin-bottom: 1rem;">
                                <i class="fas fa-money-bill-wave"></i> ÿßŸÑÿ™ŸÉÿßŸÑŸäŸÅ ŸàÿßŸÑÿ£ÿ≥ÿπÿßÿ±
                            </h3>
                            <div style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-tools"></i> ÿ≥ÿπÿ± ÿßŸÑÿµŸäÿßŸÜÿ©:</span>
                                    <span class="info-value">${formatCurrency(item.maintenancePrice)}</span>
                                </div>
                                ${item.usedParts && item.usedParts.length > 0 ? `
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-cogs"></i> ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ± (${item.usedParts.length} ŸÇÿ∑ÿπÿ©):</span>
                                    <span class="info-value">${formatCurrency(item.partsTotal)}</span>
                                </div>
                                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 0.5rem 0;">
                                    <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #666;">ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÇÿ∑ÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ©:</h4>
                                    ${item.usedParts.map(part => `
                                        <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; font-size: 0.85rem;">
                                            <span>${part.name} ${part.fromInventory ? '<span class="badge" style="background: #10b981; font-size: 0.7rem;">ŸÖŸÜ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</span>' : ''}</span>
                                            <span>${part.quantity} √ó ${formatCurrency(part.price)} = <strong>${formatCurrency(part.total)}</strong></span>
                                        </div>
                                    `).join('')}
                                </div>` : ''}
                                <div class="info-row" style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
                                    <span class="info-label" style="color: white;"><i class="fas fa-calculator"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:</span>
                                    <span class="info-value" style="color: white; font-size: 1.2rem;"><strong>${formatCurrency(item.totalCost)}</strong></span>
                                </div>
                            </div>

                            <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿØŸÅÿπ -->
                            <h3 style="color: var(--primary-color); margin-bottom: 1rem;">
                                <i class="fas fa-credit-card"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿØŸÅÿπ ŸàÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ
                            </h3>
                            <div style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-hand-holding-usd"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖ:</span>
                                    <span class="info-value"><strong style="color: #10b981; font-size: 1.1rem;">${formatCurrency(item.receivedAmount)}</strong></span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-credit-card"></i> ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ:</span>
                                    <span class="info-value">${paymentMethods[item.paymentMethod] || item.paymentMethod}</span>
                                </div>
                                ${item.receiverName ? `
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-user"></i> ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖ:</span>
                                    <span class="info-value">${item.receiverName}</span>
                                </div>` : ''}
                            </div>

                            <!-- ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ -->
                            <h3 style="color: var(--primary-color); margin-bottom: 1rem;">
                                <i class="fas fa-calendar-alt"></i> ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ
                            </h3>
                            <div style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-calendar-check"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ ŸÑŸÑÿµŸäÿßŸÜÿ©:</span>
                                    <span class="info-value">${formatDate(item.receiveDate)}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-calendar"></i> ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸÖÿ™ŸàŸÇÿπ:</span>
                                    <span class="info-value">${formatDate(item.expectedDeliveryDate)}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label"><i class="fas fa-calendar-check"></i> ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸÅÿπŸÑŸä:</span>
                                    <span class="info-value"><strong>${formatDate(item.actualDeliveryDate)}</strong></span>
                                </div>
                            </div>

                            ${item.causeInfo || item.deliveryNotes ? `
                            <h3 style="color: var(--primary-color); margin-bottom: 1rem;">
                                <i class="fas fa-sticky-note"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™
                            </h3>
                            ${item.causeInfo ? `
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #666;">ÿ≥ÿ®ÿ® ÿßŸÑÿπÿ∑ŸÑ:</h4>
                                <p style="margin: 0;">${item.causeInfo}</p>
                            </div>` : ''}
                            ${item.deliveryNotes ? `
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #666;">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ:</h4>
                                <p style="margin: 0;">${item.deliveryNotes}</p>
                            </div>` : ''}` : ''}

                            <div class="info-row">
                                <span class="info-label"><i class="fas fa-user"></i> ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿ®Ÿàÿßÿ≥ÿ∑ÿ©:</span>
                                <span class="info-value">${item.deliveredBy || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                            </div>

                            <button class="btn btn-secondary" onclick="closeDeliveredDeviceModal()" style="width: 100%; margin-top: 1.5rem;">
                                <i class="fas fa-times"></i> ÿ•ÿ∫ŸÑÿßŸÇ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeDeliveredDeviceModal() {
            const modal = document.getElementById('deliveredDeviceDetailsModal');
            if (modal) modal.remove();
        }

        // ÿØÿßŸÑÿ© ÿ≠ÿ∞ŸÅ ÿ¨Ÿáÿßÿ≤ ŸÖÿ≥ÿ™ŸÑŸÖ
        function deleteDeliveredDevice(id) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ¨ŸÑÿü\nŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ±ÿ¨ÿßÿπ ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ© ÿ•ŸÑŸâ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ.')) return;
            
            const deviceIndex = deliveredDevicesData.findIndex(d => d.id === id);
            if (deviceIndex === -1) return;
            
            const device = deliveredDevicesData[deviceIndex];
            
            // ÿ•ÿ±ÿ¨ÿßÿπ ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ± ÿ•ŸÑŸâ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
            if (device.usedParts && device.usedParts.length > 0) {
                device.usedParts.forEach(part => {
                    if (part.fromInventory && part.id) {
                        const sparePartIndex = sparePartsData.findIndex(sp => sp.id == part.id);
                        if (sparePartIndex !== -1) {
                            sparePartsData[sparePartIndex].quantity += part.quantity;
                        }
                    }
                });
                localStorage.setItem('sparePartsData', JSON.stringify(sparePartsData));
            }
            
            deliveredDevicesData.splice(deviceIndex, 1);
            localStorage.setItem('deliveredDevicesData', JSON.stringify(deliveredDevicesData));
            
            displayDeliveredDevicesData();
            updateDeliveredStats();
            
            showNotification('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≥ÿ¨ŸÑ Ÿàÿ•ÿ±ÿ¨ÿßÿπ ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ± ŸÑŸÑŸÖÿÆÿ≤ŸàŸÜ', 'success');
        }

        // ÿØÿßŸÑÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
        function updateDeliveredStats() {
            const totalDevices = deliveredDevicesData.length;
            const totalRevenue = deliveredDevicesData.reduce((sum, item) => sum + item.receivedAmount, 0);
            
            // ÿπÿØÿØ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖÿßÿ™ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const weekDevices = deliveredDevicesData.filter(item => 
                new Date(item.actualDeliveryDate) >= oneWeekAgo
            ).length;
            
            // ŸÖÿ™Ÿàÿ≥ÿ∑ ŸàŸÇÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©
            let avgDays = 0;
            if (deliveredDevicesData.length > 0) {
                const totalDays = deliveredDevicesData.reduce((sum, item) => {
                    const receiveDate = new Date(item.receiveDate);
                    const deliveryDate = new Date(item.actualDeliveryDate);
                    const diffTime = Math.abs(deliveryDate - receiveDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return sum + diffDays;
                }, 0);
                avgDays = Math.round(totalDays / deliveredDevicesData.length);
            }
            
            const totalEl = document.getElementById('totalDeliveredDevices');
            const revenueEl = document.getElementById('totalDeliveredRevenue');
            const weekEl = document.getElementById('weekDeliveredDevices');
            const avgEl = document.getElementById('avgDeliveryTime');
            
            if (totalEl) totalEl.textContent = totalDevices;
            if (revenueEl) revenueEl.textContent = formatCurrency(totalRevenue);
            if (weekEl) weekEl.textContent = weekDevices;
            if (avgEl) avgEl.textContent = `${avgDays} ${avgDays === 1 ? 'ŸäŸàŸÖ' : 'ŸäŸàŸÖ'}`;
        }

        // ÿØÿßŸÑÿ© ÿßŸÑÿ®ÿ≠ÿ´
        function filterDeliveredDevices() {
            const searchTerm = document.getElementById('deliveredDevicesSearchInput').value.toLowerCase();
            
            const filtered = deliveredDevicesData.filter(item => 
                item.productName.toLowerCase().includes(searchTerm) ||
                item.companyName.toLowerCase().includes(searchTerm) ||
                item.fault.toLowerCase().includes(searchTerm) ||
                (item.receiverName && item.receiverName.toLowerCase().includes(searchTerm))
            );
            
            displayDeliveredDevicesData(filtered);
        }

        // ÿØÿßŸÑÿ© ÿßŸÑŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÅÿ™ÿ±ÿ©
        function filterDeliveredByPeriod() {
            const period = document.getElementById('deliveredPeriodFilter').value;
            const customDateRange = document.getElementById('customDeliveredDateRange');
            
            if (period === 'custom') {
                customDateRange.style.display = 'flex';
                return;
            } else {
                customDateRange.style.display = 'none';
            }
            
            const today = new Date();
            let filtered = deliveredDevicesData;
            
            if (period !== 'all') {
                filtered = deliveredDevicesData.filter(item => {
                    const itemDate = new Date(item.actualDeliveryDate);
                    
                    switch(period) {
                        case 'today':
                            return itemDate.toDateString() === today.toDateString();
                        case 'week':
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            return itemDate >= weekAgo;
                        case 'month':
                            return itemDate.getMonth() === today.getMonth() && 
                                   itemDate.getFullYear() === today.getFullYear();
                        default:
                            return true;
                    }
                });
            }
            
            displayDeliveredDevicesData(filtered);
        }

        // ÿØÿßŸÑÿ© ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑŸÖÿÆÿµÿµÿ©
        function applyCustomDeliveredDateFilter() {
            const dateFrom = document.getElementById('deliveredDateFrom').value;
            const dateTo = document.getElementById('deliveredDateTo').value;
            
            if (!dateFrom || !dateTo) {
                showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ© ŸàÿßŸÑŸÜŸáÿßŸäÿ©', 'warning');
                return;
            }
            
            const filtered = deliveredDevicesData.filter(item => {
                const itemDate = new Date(item.actualDeliveryDate);
                return itemDate >= new Date(dateFrom) && itemDate <= new Date(dateTo);
            });
            
            displayDeliveredDevicesData(filtered);
        }

        // ÿØÿßŸÑÿ© ÿßŸÑŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ
        function filterDeliveredByPayment() {
            const method = document.getElementById('paymentMethodFilter').value;
            
            let filtered = deliveredDevicesData;
            if (method !== 'all') {
                filtered = deliveredDevicesData.filter(item => item.paymentMethod === method);
            }
            
            displayDeliveredDevicesData(filtered);
        }

        // ÿØÿßŸÑÿ© ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÅŸÑÿßÿ™ÿ±
        function resetDeliveredFilters() {
            document.getElementById('deliveredPeriodFilter').value = 'all';
            document.getElementById('paymentMethodFilter').value = 'all';
            document.getElementById('deliveredDevicesSearchInput').value = '';
            document.getElementById('customDeliveredDateRange').style.display = 'none';
            
            displayDeliveredDevicesData();
        }

        // ÿ™ŸáŸäÿ¶ÿ© ÿµŸÅÿ≠ÿ© ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ©
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('deliveredDevices')) {
                deliveredDevicesData = JSON.parse(localStorage.getItem('deliveredDevicesData')) || [];
                displayDeliveredDevicesData();
                updateDeliveredStats();
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ŸÜŸáÿßŸäÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ©
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        async function importData(type) {
            const fileInputId = `import${type.charAt(0).toUpperCase() + type.slice(1)}File`;
            const fileInput = document.getElementById(fileInputId);
            
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            const file = fileInput.files[0];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            try {
                if (fileExtension === 'json') {
                    await importFromJSON(file, type);
                } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                    await importFromExcel(file, type);
                } else if (fileExtension === 'csv') {
                    await importFromCSV(file, type);
                } else {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                }
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ input
            fileInput.value = '';
        }
        
        // ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖŸÜ JSON
        async function importFromJSON(file, type) {
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(jsonData)) {
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                        return;
                    }
                    
                    await processImportedData(jsonData, type);
                } catch (error) {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© JSON:', error);
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                }
            };
            
            reader.readAsText(file);
        }
        
        // ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖŸÜ Excel
        async function importFromExcel(file, type) {
            if (typeof XLSX === 'undefined') {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜŸàÿπ
                    const convertedData = convertExcelData(jsonData, type);
                    await processImportedData(convertedData, type);
                } catch (error) {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© Excel:', error);
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖŸÜ CSV
        async function importFromCSV(file, type) {
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const csvData = e.target.result;
                    const lines = csvData.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    const jsonData = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        
                        const values = lines[i].split(',');
                        const obj = {};
                        
                        headers.forEach((header, index) => {
                            obj[header] = values[index]?.trim() || '';
                        });
                        
                        jsonData.push(obj);
                    }
                    
                    const convertedData = convertExcelData(jsonData, type);
                    await processImportedData(convertedData, type);
                } catch (error) {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© CSV:', error);
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                }
            };
            
            reader.readAsText(file);
        }
        
        // ÿ™ÿ≠ŸàŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ Excel/CSV ÿ•ŸÑŸâ ÿßŸÑÿµŸäÿ∫ÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
        function convertExcelData(excelData, type) {
            const convertedData = [];
            
            if (type === 'products' || type === 'inventory') {
                excelData.forEach(row => {
                    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ™ÿµŸÜŸäŸÅ
                    let categoryId = '';
                    const categoryName = row['ÿßŸÑÿ™ÿµŸÜŸäŸÅ'] || row['Category'] || '';
                    if (categoryName) {
                        const foundCategory = categories.find(c => c.category_name === categoryName);
                        categoryId = foundCategory ? foundCategory.category_id : '';
                    }
                    
                    convertedData.push({
                        type: 'product',
                        product_id: row['product_id'] || Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        product_name: row['ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨'] || row['Name'] || row['product_name'] || '',
                        product_barcode: row['ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ'] || row['Barcode'] || row['product_barcode'] || '',
                        product_price_retail: parseFloat(row['ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ'] || row['Price'] || row['product_price_retail'] || 0),
                        product_price_wholesale: parseFloat(row['ÿ≥ÿπÿ± ÿßŸÑÿ¨ŸÖŸÑÿ©'] || row['Wholesale Price'] || row['product_price_wholesale'] || row['ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ'] || row['Price'] || 0),
                        product_cost_retail: parseFloat(row['ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°'] || row['Cost'] || row['product_cost_retail'] || 0),
                        product_cost_wholesale: parseFloat(row['ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ¨ŸÖŸÑÿ©'] || row['Wholesale Cost'] || row['product_cost_wholesale'] || row['ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°'] || row['Cost'] || 0),
                        stock_quantity: parseInt(row['ÿßŸÑŸÉŸÖŸäÿ©'] || row['Stock'] || row['stock_quantity'] || 0),
                        min_stock: parseInt(row['ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ'] || row['Min'] || row['min_stock'] || 5),
                        product_category: row['product_category'] || categoryId || '1',
                        supplier: row['ÿßŸÑŸÖŸàÿ±ÿØ'] || row['Supplier'] || row['supplier'] || '',
                        timestamp: row['timestamp'] || new Date().toISOString()
                    });
                });
            } else if (type === 'invoices') {
                excelData.forEach(row => {
                    convertedData.push({
                        type: 'sale',
                        invoice_id: row['ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©'] || row['Invoice'] || row['invoice_id'] || 'INV-' + Date.now(),
                        customer_name: row['ÿßŸÑÿπŸÖŸäŸÑ'] || row['Customer'] || row['customer_name'] || 'ÿπŸÖŸäŸÑ ŸÜŸÇÿØŸä',
                        final_total: parseFloat(row['ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä'] || row['Total'] || row['final_total'] || 0),
                        payment_method: row['ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ'] || row['Method'] || row['payment_method'] || 'ŸÜŸÇÿØŸä',
                        discount: parseFloat(row['ÿßŸÑÿÆÿµŸÖ'] || row['Discount'] || row['discount'] || 0),
                        tax: parseFloat(row['ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©'] || row['Tax'] || row['tax'] || 0),
                        items: row['items'] || '[]',
                        timestamp: row['timestamp'] || new Date().toISOString()
                    });
                });
            } else if (type === 'debts') {
                excelData.forEach(row => {
                    const totalAmount = parseFloat(row['ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä'] || row['Total'] || row['total_amount'] || 0);
                    const installmentMonths = parseInt(row['ÿπÿØÿØ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑'] || row['Months'] || row['installment_months'] || 12);
                    const monthlyAmount = parseFloat(row['ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä'] || row['Monthly'] || row['monthly_amount'] || (totalAmount / installmentMonths));
                    
                    convertedData.push({
                        type: 'debt',
                        customer_name: row['ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ'] || row['Customer'] || row['customer_name'] || '',
                        customer_phone: row['ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ'] || row['Phone'] || row['customer_phone'] || '',
                        customer_address: row['ÿßŸÑÿπŸÜŸàÿßŸÜ'] || row['Address'] || row['customer_address'] || '',
                        total_amount: totalAmount,
                        remaining_amount: parseFloat(row['ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä'] || row['Remaining'] || row['remaining_amount'] || totalAmount),
                        monthly_amount: monthlyAmount,
                        installment_months: installmentMonths,
                        due_date: row['due_date'] || new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                        invoice_id: row['invoice_id'] || 'INV-' + Date.now(),
                        timestamp: row['timestamp'] || new Date().toISOString()
                    });
                });
            }
            
            return convertedData;
        }
        
        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™Ÿàÿ±ÿØÿ©
        async function processImportedData(data, type) {
            if (!window.dataSdk) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }
            
            let successCount = 0;
            let errorCount = 0;
            
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            
            for (const item of data) {
                try {
                    // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÜŸàÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿµÿ≠Ÿäÿ≠
                    if (type === 'products' || type === 'inventory') {
                        item.type = 'product';
                    } else if (type === 'invoices') {
                        item.type = 'sale';
                    } else if (type === 'debts') {
                        item.type = 'debt';
                    }
                    
                    const result = await window.dataSdk.create(item);
                    if (result.isOk) {
                        successCount++;
                    } else {
                        errorCount++;
                        console.error('ŸÅÿ¥ŸÑ ŸÅŸä ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿπŸÜÿµÿ±:', item, result.error);
                    }
                } catch (error) {
                    errorCount++;
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿπŸÜÿµÿ±:', item, error);
                }
            }
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (successCount > 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            } else {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        // Initialize app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // ÿ±ÿ®ÿ∑ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿ®ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
        document.addEventListener('DOMContentLoaded', () => {
            // ÿ•ÿπÿØÿßÿØ ŸÖÿ≥ÿ™ŸÖÿπÿßÿ™ ÿ£ÿ≠ÿØÿßÿ´ ÿßŸÑÿ≥ŸÑÿ© ŸÑŸÑÿ™ŸÖÿ±Ÿäÿ± ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
            const cartSection = document.querySelector('.cart-section');
            const cartItems = document.getElementById('cartItems');
            
            if (cartSection && cartItems) {
                // ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑÿ£ÿπŸÑŸâ ÿπŸÜÿØ hover ÿπŸÑŸâ ÿßŸÑÿ≥ŸÑÿ©
                cartSection.addEventListener('mouseenter', () => {
                    scrollCartToTop();
                });
                
                // ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑÿ£ÿ≥ŸÅŸÑ ÿπŸÜÿØ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÖÿ§ÿ¥ÿ±
                cartSection.addEventListener('mouseleave', () => {
                    scrollCartToBottom();
                });
            }
            
            // ÿ≤ÿ± ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ
            const closeBtn = document.querySelector('.titlebar-btn.close');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    if (window.electronAPI && window.electronAPI.windowClose) {
                        window.electronAPI.windowClose();
                    }
                });
            }
            
            // ÿ≤ÿ± ÿßŸÑÿ™ÿµÿ∫Ÿäÿ±
            const minimizeBtn = document.querySelector('.titlebar-btn.minimize');
            if (minimizeBtn) {
                minimizeBtn.addEventListener('click', () => {
                    if (window.electronAPI && window.electronAPI.windowMinimize) {
                        window.electronAPI.windowMinimize();
                    }
                });
            }
            
            // ÿ≤ÿ± ÿßŸÑÿ™ŸÉÿ®Ÿäÿ±
            const maximizeBtn = document.querySelector('.titlebar-btn.maximize');
            if (maximizeBtn) {
                let isProcessing = false;
                maximizeBtn.addEventListener('click', () => {
                    if (isProcessing) return;
                    isProcessing = true;
                    if (window.electronAPI && window.electronAPI.windowToggleMaximize) {
                        window.electronAPI.windowToggleMaximize();
                    }
                    setTimeout(() => { isProcessing = false; }, 500); // ÿ≠ŸÖÿßŸäÿ© ŸÖŸÜ ÿßŸÑÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿ≥ÿ±Ÿäÿπ
                });
                // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≤ÿ± ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
                if (window.electronAPI && window.electronAPI.onWindowMaximized) {
                    window.electronAPI.onWindowMaximized((isMaximized) => {
                        maximizeBtn.classList.toggle('is-maximized', isMaximized);
                    });
                }
            }
        });

        
    </script>
    <!-- ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑŸÖÿ™ŸÉÿßŸÖŸÑ -->
    
    <!-- ŸÜÿ∏ÿßŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ -->
    <div id="loginOverlay" class="login-overlay" style="display: none;">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h2 class="login-title">ŸÜÿ∏ÿßŸÖ ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ</h2>
                <p class="login-subtitle">ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÑŸÖÿ™ÿßÿ®ÿπÿ©</p>
            </div>
            
            <form class="login-form" onsubmit="event.preventDefault(); window.securityManager.handleLogin();">
                <div class="login-input-group">
                    <label class="login-label" for="loginUsername">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</label>
                    <input type="text" id="loginUsername" class="login-input" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ" required>
                </div>
                
                <div class="login-input-group">
                    <label class="login-label" for="loginPassword">ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
                    <input type="password" id="loginPassword" class="login-input" placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±" required>
                </div>
                
                <button type="submit" class="login-button">
                    <i class="fas fa-sign-in-alt"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                </button>
            </form>
            
            <div style="text-align: center; margin-top: 20px; font-size: 12px; color: var(--theme-text-tertiary);">
                ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä: admin / admin123
            </div>
            
            <div style="text-align: center; margin-top: 15px;">
                <button type="button" onclick="window.resetSecuritySystem()" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px;">
                    <i class="fas fa-sync-alt"></i> ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÜÿ∏ÿßŸÖ
                </button>
                <p style="font-size: 11px; color: var(--theme-text-tertiary); margin-top: 8px;">ÿßÿ∂ÿ∫ÿ∑ ŸáŸÜÿß ÿ•ÿ∞ÿß Ÿàÿßÿ¨Ÿáÿ™ ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</p>
            </div>
        </div>
    </div>

    <script>
        // ÿØÿßŸÑÿ© ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ£ŸÖÿßŸÜ
        window.resetSecuritySystem = function() {
            if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ Ÿàÿ•ÿπÿßÿØÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä.')) {
                console.log('üîÑ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ£ŸÖÿßŸÜ...');
                
                // ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©
                localStorage.removeItem('app_users');
                sessionStorage.clear();
                
                console.log('‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©');
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
                alert('ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿ®ŸÜÿ¨ÿßÿ≠. ÿ≥Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©.');
                window.location.reload();
            }
        };
    </script>

    <!-- ŸÑŸàÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ŸÖÿßŸÜ -->
    <div id="securityPanel" class="security-panel">
        <div class="security-content">
            <div class="security-header">
                <h2 class="security-title">
                    <i class="fas fa-shield-alt"></i>
                    ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ≠ŸÖÿßŸäÿ© ŸàÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™
                </h2>
                <button class="security-close" onclick="window.securityManager.closeSecurityPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="security-tabs">
                <button class="security-tab active" onclick="window.securityManager.switchSecurityTab('users')">
                    <i class="fas fa-users"></i> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
                </button>
                <button class="security-tab" onclick="window.securityManager.switchSecurityTab('permissions')">
                    <i class="fas fa-key"></i> ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©
                </button>
            </div>

            <div class="security-body">
                <!-- ÿ™ÿ®ŸàŸäÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ -->
                <div id="usersTab" class="tab-content" style="display: block;">
                    <div class="security-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="section-title">
                                <i class="fas fa-users"></i>
                                ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸàŸÜ ÿßŸÑŸÖÿ≥ÿ¨ŸÑŸàŸÜ
                            </h3>
                            <button class="btn-add-user" onclick="window.securityManager.openUserModal()">
                                <i class="fas fa-plus"></i>
                                ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ
                            </button>
                        </div>

                        <div style="overflow-x: auto;">
                            <table class="users-table">
                                <thead>
                                    <tr>
                                        <th>ÿßŸÑÿßÿ≥ŸÖ</th>
                                        <th>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
                                        <th>ÿßŸÑÿØŸàÿ±</th>
                                        <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                        <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°</th>
                                        <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®Ÿàÿßÿ≥ÿ∑ÿ© JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ÿ™ÿ®ŸàŸäÿ® ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ -->
                <div id="permissionsTab" class="tab-content" style="display: none;">
                    <div class="security-section">
                        <h3 class="section-title">
                            <i class="fas fa-info-circle"></i>
                            ÿØŸÑŸäŸÑ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ
                        </h3>
                        
                        <div class="permissions-grid">
                            <div class="permission-card">
                                <div class="permission-card-title">
                                    <i class="fas fa-tachometer-alt" style="color: #6366f1;"></i>
                                    ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ
                                </div>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿπÿ±ÿ∂ ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿπÿ±ÿ∂ ŸÇŸäŸÖÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿπÿ±ÿ∂ ÿπÿØÿØ ÿßŸÑÿØŸäŸàŸÜ</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿπÿ±ÿ∂ ŸÇŸäŸÖÿ© ÿßŸÑÿØŸäŸàŸÜ</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿπÿ±ÿ∂ ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿπÿ±ÿ∂ ÿßŸÑÿ£ÿ±ÿ®ÿßÿ≠</li>
                                </ul>
                            </div>

                            <div class="permission-card">
                                <div class="permission-card-title">
                                    <i class="fas fa-bars" style="color: #8b5cf6;"></i>
                                    ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä
                                </div>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿßŸÑÿØŸäŸàŸÜ</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿßŸÑÿ∑ÿßÿ®ÿπÿ©</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</li>
                                </ul>
                            </div>

                            <div class="permission-card">
                                <div class="permission-card-title">
                                    <i class="fas fa-boxes" style="color: #10b981;"></i>
                                    ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
                                </div>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ™ÿπÿØŸäŸÑ ŸÖŸÜÿ™ÿ¨</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ≠ÿ∞ŸÅ ŸÖŸÜÿ™ÿ¨</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ¶ÿ©</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</li>
                                </ul>
                            </div>

                            <div class="permission-card">
                                <div class="permission-card-title">
                                    <i class="fas fa-warehouse" style="color: #f59e0b;"></i>
                                    ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
                                </div>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿÆÿ≤ŸàŸÜ</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ™ÿπÿØŸäŸÑ ŸÖÿÆÿ≤ŸàŸÜ</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ≠ÿ∞ŸÅ ŸÖÿÆÿ≤ŸàŸÜ</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÉŸÖŸäÿ©</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿπÿ±ÿ∂ ÿßŸÑÿ≥ÿ¨ŸÑ</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</li>
                                </ul>
                            </div>

                            <div class="permission-card">
                                <div class="permission-card-title">
                                    <i class="fas fa-cash-register" style="color: #ec4899;"></i>
                                    ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ
                                </div>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ®Ÿäÿπ</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ©</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿßŸÑÿ®Ÿäÿπ ÿ®ÿßŸÑÿ™ŸÇÿ≥Ÿäÿ∑</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ•ÿ∂ÿßŸÅÿ© ÿÆÿµŸÖ</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ®Ÿäÿπ</li>
                                </ul>
                            </div>

                            <div class="permission-card">
                                <div class="permission-card-title">
                                    <i class="fas fa-credit-card" style="color: #ef4444;"></i>
                                    ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿØŸäŸàŸÜ
                                </div>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ™ÿ≥ÿØŸäÿØ ŸÇÿ≥ÿ∑</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ≠ÿ∞ŸÅ ÿØŸäŸÜ</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ÿ∞ŸÉŸäÿ±ÿßÿ™</li>
                                </ul>
                            </div>

                            <div class="permission-card">
                                <div class="permission-card-title">
                                    <i class="fas fa-chart-bar" style="color: #3b82f6;"></i>
                                    ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±
                                </div>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑÿØŸäŸàŸÜ</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑÿ£ÿ±ÿ®ÿßÿ≠</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±</li>
                                </ul>
                            </div>

                            <div class="permission-card">
                                <div class="permission-card-title">
                                    <i class="fas fa-cog" style="color: #64748b;"></i>
                                    ÿßŸÑÿ∑ÿßÿ®ÿπÿ© ŸàÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
                                </div>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ∑ÿßÿ®ÿπÿ©</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ∑ÿ®ÿßÿπÿ©</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä</li>
                                    <li style="padding: 8px 0; color: var(--theme-text-secondary);">‚Ä¢ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ -->
    <div id="userModal" class="user-modal">
        <div class="user-modal-content">
            <div class="user-modal-header">
                <h3 class="user-modal-title" id="userModalTitle">ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ</h3>
            </div>
            
            <div class="user-modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    
                    <div class="form-group">
                        <label class="form-label" for="userName">ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ *</label>
                        <input type="text" id="userName" class="form-input" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="userUsername">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ *</label>
                        <input type="text" id="userUsername" class="form-input" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="userPassword">ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
                        <input type="password" id="userPassword" class="form-input" placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±">
                        <small style="color: var(--theme-text-tertiary); font-size: 12px;">ÿßÿ™ÿ±ŸÉŸáÿß ŸÅÿßÿ±ÿ∫ÿ© ŸÑŸÑÿ•ÿ®ŸÇÿßÿ° ÿπŸÑŸâ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ≠ÿßŸÑŸäÿ©</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="userRole">ÿßŸÑÿØŸàÿ± *</label>
                        <select id="userRole" class="form-select" required>
                            <option value="user">ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿπÿßÿØŸä</option>
                            <option value="admin">ŸÖÿØŸäÿ±</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™</label>
                        <div class="permissions-grid" style="margin-top: 10px;">
                            <!-- Dashboard -->
                            <div class="permission-card">
                                <div class="permission-card-title">ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ</div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_dashboard_products_count" class="permission-checkbox">
                                    <label for="perm_dashboard_products_count" class="permission-label">ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_dashboard_inventory_value" class="permission-checkbox">
                                    <label for="perm_dashboard_inventory_value" class="permission-label">ŸÇŸäŸÖÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_dashboard_debts_count" class="permission-checkbox">
                                    <label for="perm_dashboard_debts_count" class="permission-label">ÿπÿØÿØ ÿßŸÑÿØŸäŸàŸÜ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_dashboard_debts_value" class="permission-checkbox">
                                    <label for="perm_dashboard_debts_value" class="permission-label">ŸÇŸäŸÖÿ© ÿßŸÑÿØŸäŸàŸÜ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_dashboard_revenue" class="permission-checkbox">
                                    <label for="perm_dashboard_revenue" class="permission-label">ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_dashboard_profit" class="permission-checkbox">
                                    <label for="perm_dashboard_profit" class="permission-label">ÿßŸÑÿ£ÿ±ÿ®ÿßÿ≠</label>
                                </div>
                            </div>

                            <!-- Sidebar -->
                            <div class="permission-card">
                                <div class="permission-card-title">ÿßŸÑŸÇŸàÿßÿ¶ŸÖ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©</div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_sidebar_pos" class="permission-checkbox">
                                    <label for="perm_sidebar_pos" class="permission-label">ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_sidebar_invoices" class="permission-checkbox">
                                    <label for="perm_sidebar_invoices" class="permission-label">ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_sidebar_products" class="permission-checkbox">
                                    <label for="perm_sidebar_products" class="permission-label">ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_sidebar_inventory" class="permission-checkbox">
                                    <label for="perm_sidebar_inventory" class="permission-label">ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_sidebar_debts" class="permission-checkbox">
                                    <label for="perm_sidebar_debts" class="permission-label">ÿßŸÑÿØŸäŸàŸÜ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_sidebar_reports" class="permission-checkbox">
                                    <label for="perm_sidebar_reports" class="permission-label">ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_sidebar_printer" class="permission-checkbox">
                                    <label for="perm_sidebar_printer" class="permission-label">ÿßŸÑÿ∑ÿßÿ®ÿπÿ©</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_sidebar_settings" class="permission-checkbox">
                                    <label for="perm_sidebar_settings" class="permission-label">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</label>
                                </div>
                            </div>

                            <!-- ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿßÿ™ -->
                            <div class="permission-card">
                                <div class="permission-card-title">ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿßÿ™</div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_sales_view" class="permission-checkbox">
                                    <label for="perm_sales_view" class="permission-label">ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_products_view" class="permission-checkbox">
                                    <label for="perm_products_view" class="permission-label">ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_inventory_view" class="permission-checkbox">
                                    <label for="perm_inventory_view" class="permission-label">ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_debts_view" class="permission-checkbox">
                                    <label for="perm_debts_view" class="permission-label">ÿßŸÑÿØŸäŸàŸÜ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_reports_view" class="permission-checkbox">
                                    <label for="perm_reports_view" class="permission-label">ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_settings_view" class="permission-checkbox">
                                    <label for="perm_settings_view" class="permission-label">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</label>
                                </div>
                            </div>

                            <!-- ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ -->
                            <div class="permission-card">
                                <div class="permission-card-title">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_products_add" class="permission-checkbox">
                                    <label for="perm_products_add" class="permission-label">ÿ•ÿ∂ÿßŸÅÿ©</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_products_edit" class="permission-checkbox">
                                    <label for="perm_products_edit" class="permission-label">ÿ™ÿπÿØŸäŸÑ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_products_delete" class="permission-checkbox">
                                    <label for="perm_products_delete" class="permission-label">ÿ≠ÿ∞ŸÅ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_products_export" class="permission-checkbox">
                                    <label for="perm_products_export" class="permission-label">ÿ™ÿµÿØŸäÿ±</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_products_import" class="permission-checkbox">
                                    <label for="perm_products_import" class="permission-label">ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_products_add_category" class="permission-checkbox">
                                    <label for="perm_products_add_category" class="permission-label">ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ¶ÿ©</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_products_stock_management" class="permission-checkbox">
                                    <label for="perm_products_stock_management" class="permission-label">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</label>
                                </div>
                            </div>

                            <!-- ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ -->
                            <div class="permission-card">
                                <div class="permission-card-title">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_inventory_add" class="permission-checkbox">
                                    <label for="perm_inventory_add" class="permission-label">ÿ•ÿ∂ÿßŸÅÿ©</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_inventory_edit" class="permission-checkbox">
                                    <label for="perm_inventory_edit" class="permission-label">ÿ™ÿπÿØŸäŸÑ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_inventory_delete" class="permission-checkbox">
                                    <label for="perm_inventory_delete" class="permission-label">ÿ≠ÿ∞ŸÅ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_inventory_adjust" class="permission-checkbox">
                                    <label for="perm_inventory_adjust" class="permission-label">ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÉŸÖŸäÿ©</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_inventory_history" class="permission-checkbox">
                                    <label for="perm_inventory_history" class="permission-label">ÿπÿ±ÿ∂ ÿßŸÑÿ≥ÿ¨ŸÑ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_inventory_export" class="permission-checkbox">
                                    <label for="perm_inventory_export" class="permission-label">ÿ™ÿµÿØŸäÿ±</label>
                                </div>
                            </div>

                            <!-- ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ -->
                            <div class="permission-card">
                                <div class="permission-card-title">ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ</div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_pos_access" class="permission-checkbox">
                                    <label for="perm_pos_access" class="permission-label">ÿßŸÑŸàÿµŸàŸÑ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_pos_sell" class="permission-checkbox">
                                    <label for="perm_pos_sell" class="permission-label">ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ®Ÿäÿπ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_pos_add_to_cart" class="permission-checkbox">
                                    <label for="perm_pos_add_to_cart" class="permission-label">ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ©</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_pos_installment" class="permission-checkbox">
                                    <label for="perm_pos_installment" class="permission-label">ÿßŸÑÿ®Ÿäÿπ ÿ®ÿßŸÑÿ™ŸÇÿ≥Ÿäÿ∑</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_pos_discount" class="permission-checkbox">
                                    <label for="perm_pos_discount" class="permission-label">ÿ•ÿ∂ÿßŸÅÿ© ÿÆÿµŸÖ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_pos_print" class="permission-checkbox">
                                    <label for="perm_pos_print" class="permission-label">ÿ∑ÿ®ÿßÿπÿ©</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_pos_cancel" class="permission-checkbox">
                                    <label for="perm_pos_cancel" class="permission-label">ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ®Ÿäÿπ</label>
                                </div>
                            </div>

                            <!-- ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± -->
                            <div class="permission-card">
                                <div class="permission-card-title">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±</div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_invoices_view" class="permission-checkbox">
                                    <label for="perm_invoices_view" class="permission-label">ÿπÿ±ÿ∂ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_invoices_delete" class="permission-checkbox">
                                    <label for="perm_invoices_delete" class="permission-label">ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_invoices_export" class="permission-checkbox">
                                    <label for="perm_invoices_export" class="permission-label">ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±</label>
                                </div>
                            </div>

                            <!-- ÿßŸÑÿØŸäŸàŸÜ -->
                            <div class="permission-card">
                                <div class="permission-card-title">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿØŸäŸàŸÜ</div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_debts_view_details" class="permission-checkbox">
                                    <label for="perm_debts_view_details" class="permission-label">ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_debts_payment" class="permission-checkbox">
                                    <label for="perm_debts_payment" class="permission-label">ÿ™ÿ≥ÿØŸäÿØ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_debts_delete" class="permission-checkbox">
                                    <label for="perm_debts_delete" class="permission-label">ÿ≠ÿ∞ŸÅ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_debts_export" class="permission-checkbox">
                                    <label for="perm_debts_export" class="permission-label">ÿ™ÿµÿØŸäÿ±</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_debts_reminders" class="permission-checkbox">
                                    <label for="perm_debts_reminders" class="permission-label">ÿ™ÿ∞ŸÉŸäÿ±ÿßÿ™</label>
                                </div>
                            </div>

                            <!-- ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± -->
                            <div class="permission-card">
                                <div class="permission-card-title">ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±</div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_reports_sales" class="permission-checkbox">
                                    <label for="perm_reports_sales" class="permission-label">ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_reports_inventory" class="permission-checkbox">
                                    <label for="perm_reports_inventory" class="permission-label">ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_reports_debts" class="permission-checkbox">
                                    <label for="perm_reports_debts" class="permission-label">ÿßŸÑÿØŸäŸàŸÜ</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_reports_profit" class="permission-checkbox">
                                    <label for="perm_reports_profit" class="permission-label">ÿßŸÑÿ£ÿ±ÿ®ÿßÿ≠</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_reports_export" class="permission-checkbox">
                                    <label for="perm_reports_export" class="permission-label">ÿ™ÿµÿØŸäÿ±</label>
                                </div>
                            </div>

                            <!-- ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ -->
                            <div class="permission-card">
                                <div class="permission-card-title">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_printer_configure" class="permission-checkbox">
                                    <label for="perm_printer_configure" class="permission-label">ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ∑ÿßÿ®ÿπÿ©</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_printer_test" class="permission-checkbox">
                                    <label for="perm_printer_test" class="permission-label">ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ∑ÿ®ÿßÿπÿ©</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_settings_edit" class="permission-checkbox">
                                    <label for="perm_settings_edit" class="permission-label">ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_settings_backup" class="permission-checkbox">
                                    <label for="perm_settings_backup" class="permission-label">ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="perm_settings_restore" class="permission-checkbox">
                                    <label for="perm_settings_restore" class="permission-label">ÿßÿ≥ÿ™ÿπÿßÿØÿ©</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="window.securityManager.closeUserModal()">
                        <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                    <button type="button" class="btn-primary" onclick="window.securityManager.saveUser()">
                        <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="./reports-system.js"></script>
    <script src="./expenses-system.js"></script>
    
    <!-- =============================================== -->
    <!-- ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÑŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© -->
    <!-- =============================================== -->
    
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿØŸäŸÜ -->
    <div id="editDebtModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> ÿ™ÿπÿØŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØŸäŸÜ</h2>
                <button class="close-modal" onclick="closeEditDebtModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editDebtForm" onsubmit="saveEditedDebt(event)">
                    <input type="hidden" id="editDebtId">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ <span style="color: red;">*</span></label>
                            <input type="text" id="editDebtCustomerName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</label>
                            <input type="tel" id="editDebtCustomerPhone" class="form-input">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä <span style="color: red;">*</span></label>
                            <input type="number" id="editDebtTotalAmount" class="form-input" required min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ</label>
                            <input type="number" id="editDebtPaidAmount" class="form-input" min="0" step="0.01">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ±</label>
                            <input type="number" id="editDebtMonths" class="form-input" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä</label>
                            <input type="number" id="editDebtMonthlyPayment" class="form-input" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</label>
                        <textarea id="editDebtNotes" class="form-input" rows="3"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditDebtModal()">
                            <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿØŸäŸÜ ÿ¨ÿØŸäÿØ ŸÖÿ≠ÿ≥ŸëŸÜÿ© ŸÖÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ -->
    <div id="addManualDebtModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿØŸäŸÜ ÿ¨ÿØŸäÿØ</h2>
                <button class="close-modal" onclick="closeAddManualDebtModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addManualDebtForm" onsubmit="saveManualDebt(event)">
                    <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ -->
                    <h3 style="color: var(--primary-color); margin-bottom: 1rem;">
                        <i class="fas fa-user"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ
                    </h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ <span style="color: red;">*</span></label>
                            <input type="text" id="manualDebtCustomerName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ <span style="color: red;">*</span></label>
                            <input type="tel" id="manualDebtPhone" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÿßŸÑÿπŸÜŸàÿßŸÜ</label>
                            <input type="text" id="manualDebtAddress" class="form-input">
                        </div>
                    </div>
                    
                    <!-- ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ¥ÿ™ÿ±ÿßÿ© -->
                    <h3 style="color: var(--primary-color); margin: 2rem 0 1rem;">
                        <i class="fas fa-shopping-cart"></i> ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ¥ÿ™ÿ±ÿßÿ©
                    </h3>
                    <div id="debtProductsContainer">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
                                    <th>ÿßŸÑÿ≥ÿπÿ±</th>
                                    <th>ÿßŸÑŸÉŸÖŸäÿ©</th>
                                    <th>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</th>
                                    <th>ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                                </tr>
                            </thead>
                            <tbody id="debtProductsTable">
                                <!-- ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ≥ÿ™ÿ∂ÿßŸÅ ŸáŸÜÿß -->
                            </tbody>
                        </table>
                        <button type="button" class="btn btn-success" onclick="addDebtProductRow()">
                            <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨
                        </button>
                    </div>
                    
                    <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿØŸÅÿπ -->
                    <h3 style="color: var(--primary-color); margin: 2rem 0 1rem;">
                        <i class="fas fa-money-bill-wave"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿØŸÅÿπ ŸàÿßŸÑÿ™ŸÇÿ≥Ÿäÿ∑
                    </h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ŸÑÿ∫</label>
                            <input type="number" id="manualDebtTotalAmount" class="form-input" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ ŸÖŸÇÿØŸÖÿßŸã</label>
                            <input type="number" id="manualDebtPaidAmount" class="form-input" min="0" step="0.01" value="0" onchange="calculateManualDebtInstallment()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</label>
                            <input type="number" id="manualDebtRemainingAmount" class="form-input" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ÿπÿØÿØ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ (ÿ®ÿßŸÑÿ£ÿ¥Ÿáÿ±) <span style="color: red;">*</span></label>
                            <input type="number" id="manualDebtInstallmentMonths" class="form-input" required min="1" value="3" onchange="calculateManualDebtInstallment()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä</label>
                            <input type="number" id="manualDebtMonthlyAmount" class="form-input" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÿ™ÿßÿ±ŸäÿÆ ÿ£ŸàŸÑ ŸÇÿ≥ÿ∑</label>
                            <input type="date" id="manualDebtFirstDate" class="form-input">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</label>
                        <textarea id="manualDebtNotes" class="form-input" rows="3" placeholder="ÿ£Ÿä ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©..."></textarea>
                    </div>
                    
                    <!-- ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© -->
                    <div class="form-group">
                        <label class="form-label">ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="manualDebtInvoiceId" class="form-input" placeholder="ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ£Ÿà ÿßÿ™ÿ±ŸÉ ŸÅÿßÿ±ÿ∫ÿßŸã ŸÑŸÑÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä" style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="generateInvoiceNumber()" style="white-space: nowrap;">
                                <i class="fas fa-sync-alt"></i> ÿ™ŸàŸÑŸäÿØ ÿ±ŸÇŸÖ
                            </button>
                        </div>
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                            <i class="fas fa-info-circle"></i> ÿ•ÿ∞ÿß ÿ™ÿ±ŸÉÿ™ ÿßŸÑÿ≠ŸÇŸÑ ŸÅÿßÿ±ÿ∫ÿßŸãÿå ÿ≥Ÿäÿ™ŸÖ ÿ™ŸàŸÑŸäÿØ ÿ±ŸÇŸÖ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
                        </small>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeAddManualDebtModal()">
                            <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸäŸÜ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÅŸä ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ -->
    <div id="productDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2><i class="fas fa-info-circle"></i> ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨</h2>
                <button class="close-modal" onclick="closeProductDetailsModal()">&times;</button>
            </div>
            <div class="modal-body" id="productDetailsContent">
                <!-- ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ™Ÿá ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
            </div>
        </div>
    </div>
    
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ -->
    <div id="editProductModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨</h2>
                <button class="close-modal" onclick="closeEditProductModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editProductForm" onsubmit="saveEditedProduct(event)">
                    <input type="hidden" id="editProductId">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ <span style="color: red;">*</span></label>
                            <input type="text" id="editProductName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ <span style="color: red;">*</span></label>
                            <input type="text" id="editProductBarcode" class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ÿßŸÑÿ™ÿµŸÜŸäŸÅ</label>
                            <select id="editProductCategory" class="form-select">
                                <!-- ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™ ÿ≥ÿ™ÿ∂ÿßŸÅ ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÿßŸÑŸÉŸÖŸäÿ©</label>
                            <input type="number" id="editProductStock" class="form-input" min="0">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°</label>
                            <input type="number" id="editProductCost" class="form-input" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ</label>
                            <input type="number" id="editProductPrice" class="form-input" min="0" step="0.01">
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditProductModal()">
                            <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ŸÜÿßŸÅÿ∞ÿ© ŸÜŸÇŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ®ŸäŸÜ ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™ -->
    <div id="moveProductCategoryModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fas fa-exchange-alt"></i> ŸÜŸÇŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ•ŸÑŸâ ÿ™ÿµŸÜŸäŸÅ ÿ¢ÿÆÿ±</h2>
                <button class="close-modal" onclick="closeMoveProductCategoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="moveProductCategoryForm" onsubmit="saveProductCategoryMove(event)">
                    <input type="hidden" id="moveProductId">
                    
                    <div class="form-group">
                        <label class="form-label">ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿßŸÑÿ≠ÿßŸÑŸä</label>
                        <input type="text" id="moveProductName" class="form-input" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ≠ÿßŸÑŸä</label>
                        <input type="text" id="moveProductCurrentCategory" class="form-input" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ¨ÿØŸäÿØ <span style="color: red;">*</span></label>
                        <select id="moveProductNewCategory" class="form-select" required>
                            <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ¨ÿØŸäÿØ...</option>
                            <!-- ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™ ÿ≥ÿ™ÿ∂ÿßŸÅ ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
                        </select>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeMoveProductCategoryModal()">
                            <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i> ŸÜŸÇŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- =============================================== -->
    <!-- ÿßŸÑÿØŸàÿßŸÑ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÑŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© -->
    <!-- =============================================== -->
    <script>
    
    // ============================================
    // ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜÿ©
    // ============================================
    
    // ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿØŸäŸÜ
    function openEditDebtModal(debtId) {
        const debt = debtsData.find(d => d.id === debtId);
        if (!debt) {
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            return;
        }
        
        document.getElementById('editDebtId').value = debt.id;
        document.getElementById('editDebtCustomerName').value = debt.customer_name || '';
        document.getElementById('editDebtCustomerPhone').value = debt.customer_phone || '';
        document.getElementById('editDebtTotalAmount').value = debt.total_amount || 0;
        document.getElementById('editDebtPaidAmount').value = debt.paid_amount || 0;
        document.getElementById('editDebtMonths').value = debt.installment_months || 1;
        document.getElementById('editDebtMonthlyPayment').value = debt.monthly_installment || 0;
        document.getElementById('editDebtNotes').value = debt.notes || '';
        
        showModal('editDebtModal');
    }
    
    // ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿØŸäŸÜ
    function closeEditDebtModal_OLD() {
        // ŸÜÿ≥ÿÆÿ© ŸÇÿØŸäŸÖÿ© - ÿ∫Ÿäÿ± ŸÖÿ≥ÿ™ÿÆÿØŸÖÿ©
        closeModal('editDebtModal');
        document.getElementById('editDebtForm').reset();
    }
    
    // ÿ≠ŸÅÿ∏ ÿ™ÿπÿØŸäŸÑÿßÿ™ ÿßŸÑÿØŸäŸÜ
    async function saveEditedDebt(event) {
        event.preventDefault();
        
        const debtId = document.getElementById('editDebtId').value;
        const customerName = document.getElementById('editDebtCustomerName').value;
        const customerPhone = document.getElementById('editDebtCustomerPhone').value;
        const totalAmount = parseFloat(document.getElementById('editDebtTotalAmount').value) || 0;
        const paidAmount = parseFloat(document.getElementById('editDebtPaidAmount').value) || 0;
        const months = parseInt(document.getElementById('editDebtMonths').value) || 1;
        const notes = document.getElementById('editDebtNotes').value;
        
        const remainingAmount = totalAmount - paidAmount;
        const monthlyPayment = remainingAmount / months;
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØŸäŸÜ
        const debtIndex = debtsData.findIndex(d => d.id === debtId);
        if (debtIndex === -1) {
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            return;
        }
        
        debtsData[debtIndex] = {
            ...debtsData[debtIndex],
            customer_name: customerName,
            customer_phone: customerPhone,
            total_amount: totalAmount,
            paid_amount: paidAmount,
            remaining_amount: remainingAmount,
            installment_months: months,
            monthly_installment: monthlyPayment,
            notes: notes,
            updated_at: new Date().toISOString()
        };
        
        // ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™
        await saveToLocalStorage('debtsData', debtsData);
        
        closeEditDebtModal();
        updateDebtsView();
        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
    }
    
    // ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿØŸäŸÜ ÿ¨ÿØŸäÿØ ŸÖÿ≠ÿ≥ŸëŸÜÿ©
    let debtProductsArray = [];
    
    function showAddManualDebtModal() {
        manualDebtProducts = [];
        document.getElementById('manualDebtProductsTable').innerHTML = '';
        document.getElementById('manualDebtProductsContainer').style.display = 'none';
        
        // ŸÖÿ≥ÿ≠ ÿßŸÑÿ≠ŸÇŸàŸÑ
        document.getElementById('manualDebtCustomerName').value = '';
        document.getElementById('manualDebtCustomerPhone').value = '';
        document.getElementById('manualDebtCustomerAddress').value = '';
        document.getElementById('manualDebtDate').valueAsDate = new Date();
        document.getElementById('manualDebtTotalAmount').value = 0;
        document.getElementById('manualDebtDownPayment').value = 0;
        document.getElementById('manualDebtMonths').value = 12;
        document.getElementById('manualDebtAdditionalAmount').value = 0;
        document.getElementById('manualDebtStartDate').valueAsDate = new Date();
        document.getElementById('manualDebtNotes').value = '';
        
        calculateManualDebtInstallments();
        showModal('addManualDebtModal');
    }
    
    function closeAddManualDebtModal() {
        closeModal('addManualDebtModal');
        manualDebtProducts = [];
        
        // ŸÖÿ≥ÿ≠ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨
        document.getElementById('manualDebtCustomerName').value = '';
        document.getElementById('manualDebtPhone').value = '';
        document.getElementById('manualDebtAddress').value = '';
        document.getElementById('manualDebtTotalAmount').value = '';
        document.getElementById('manualDebtPaidAmount').value = '0';
        document.getElementById('manualDebtRemainingAmount').value = '';
        document.getElementById('manualDebtInstallmentMonths').value = '3';
        document.getElementById('manualDebtMonthlyAmount').value = '';
        document.getElementById('manualDebtFirstDate').value = '';
        document.getElementById('manualDebtNotes').value = '';
        document.getElementById('manualDebtInvoiceId').value = '';
        
        // ŸÖÿ≥ÿ≠ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
        document.getElementById('debtProductsTable').innerHTML = '';
    }
    
    // ÿ•ÿ∂ÿßŸÅÿ© ÿµŸÅ ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ
    function addDebtProductRow() {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="text" class="form-input debt-product-name" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨" list="productsList" onchange="updateDebtProductPrice(this)">
                <datalist id="productsList">
                    ${products.map(p => `<option value="${p.name}" data-price="${p.price}">${p.name} - ${p.price} ÿØŸäŸÜÿßÿ±</option>`).join('')}
                </datalist>
            </td>
            <td>
                <input type="number" class="form-input debt-product-price" placeholder="ÿßŸÑÿ≥ÿπÿ±" min="0" step="0.01" onchange="calculateDebtProductTotal(this)">
            </td>
            <td>
                <input type="number" class="form-input debt-product-quantity" placeholder="ÿßŸÑŸÉŸÖŸäÿ©" min="1" value="1" onchange="calculateDebtProductTotal(this)">
            </td>
            <td>
                <input type="number" class="form-input debt-product-total" placeholder="ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä" readonly>
            </td>
            <td>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeDebtProductRow(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        document.getElementById('debtProductsTable').appendChild(row);
    }
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿ≥ÿπÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿπŸÜÿØ ÿßÿÆÿ™Ÿäÿßÿ±Ÿá
    function updateDebtProductPrice(input) {
        const productName = input.value;
        const product = products.find(p => p.name === productName);
        if (product) {
            const row = input.closest('tr');
            row.querySelector('.debt-product-price').value = product.price;
            calculateDebtProductTotal(row.querySelector('.debt-product-price'));
        }
    }
    
    // ÿ≠ÿ≥ÿßÿ® ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÜÿ™ÿ¨
    function calculateDebtProductTotal(input) {
        const row = input.closest('tr');
        const price = parseFloat(row.querySelector('.debt-product-price').value) || 0;
        const quantity = parseFloat(row.querySelector('.debt-product-quantity').value) || 0;
        const total = price * quantity;
        row.querySelector('.debt-product-total').value = total.toFixed(2);
        
        // ÿ≠ÿ≥ÿßÿ® ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿØŸäŸÜ
        calculateManualDebtTotal();
    }
    
    // ÿ≠ÿ≥ÿßÿ® ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿØŸäŸÜ
    function calculateManualDebtTotal() {
        let total = 0;
        document.querySelectorAll('.debt-product-total').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        
        document.getElementById('manualDebtTotalAmount').value = total.toFixed(2);
        calculateManualDebtInstallment();
    }
    
    // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä
    function calculateManualDebtInstallment() {
        const totalAmount = parseFloat(document.getElementById('manualDebtTotalAmount').value) || 0;
        const paidAmount = parseFloat(document.getElementById('manualDebtPaidAmount').value) || 0;
        const months = parseInt(document.getElementById('manualDebtInstallmentMonths').value) || 1;
        
        const remainingAmount = totalAmount - paidAmount;
        const monthlyAmount = remainingAmount / months;
        
        document.getElementById('manualDebtRemainingAmount').value = remainingAmount.toFixed(2);
        document.getElementById('manualDebtMonthlyAmount').value = monthlyAmount.toFixed(2);
    }
    
    // ÿ≠ÿ∞ŸÅ ÿµŸÅ ŸÖŸÜÿ™ÿ¨
    function removeDebtProductRow(button) {
        button.closest('tr').remove();
        calculateManualDebtTotal();
    }
    
    // ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸäŸÜ ÿßŸÑÿ¨ÿØŸäÿØ
    // ÿ™ŸàŸÑŸäÿØ ÿ±ŸÇŸÖ ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ™ŸÑŸÇÿßÿ¶Ÿä
    function generateInvoiceNumber() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        
        const invoiceNumber = `INV-${year}${month}${day}-${random}`;
        document.getElementById('manualDebtInvoiceId').value = invoiceNumber;
        
        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
    }
    
    // ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸäŸÜ ÿßŸÑÿ¨ÿØŸäÿØ
    async function saveManualDebt() {
        // ÿ¨ŸÖÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿµÿ≠Ÿäÿ≠
        const customerName = document.getElementById('manualDebtCustomerName').value.trim();
        const customerPhone = document.getElementById('manualDebtCustomerPhone').value.trim();
        const customerAddress = document.getElementById('manualDebtCustomerAddress').value.trim();
        const originalSubtotal = parseFloat(document.getElementById('manualDebtTotalAmount').value) || 0;
        const downPayment = parseFloat(document.getElementById('manualDebtDownPayment').value) || 0;
        const months = parseInt(document.getElementById('manualDebtMonths').value) || 1;
        const additionalAmount = parseFloat(document.getElementById('manualDebtAdditionalAmount').value) || 0;
        const startDate = document.getElementById('manualDebtStartDate').value;
        const notes = document.getElementById('manualDebtNotes').value.trim();
        
        // ÿ¨ŸÖÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖŸÜ ÿßŸÑÿ¨ÿØŸàŸÑ - ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ manualDebtProducts ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ± ÿßŸÑÿπÿßŸÖ
        const productsToSave = manualDebtProducts && manualDebtProducts.length > 0 ? 
            manualDebtProducts : [];
        
        console.log('üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ∂ÿßŸÅÿ©:', productsToSave);
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        if (!customerName || !customerPhone) {
            alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ Ÿàÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ');
            return;
        }
        
        if (originalSubtotal <= 0) {
            alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿØŸäŸÜ');
            return;
        }
        
        if (productsToSave.length === 0) {
            alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
            return;
        }
        
        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿ®ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© (ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑)
        const totalAmount = originalSubtotal + additionalAmount;  // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä
        const remainingAmount = totalAmount - downPayment;        // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ÿ®ÿπÿØ ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©
        const monthlyAmount = remainingAmount / months;           // ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä
        
        const installments = [];
        const startDateObj = startDate ? new Date(startDate) : new Date();
        
        for (let i = 0; i < months; i++) {
            const dueDate = new Date(startDateObj);
            dueDate.setMonth(dueDate.getMonth() + i);
            
            installments.push({
                month: i + 1,
                amount: monthlyAmount,
                due_date: dueDate.toISOString(),
                status: 'pending',
                paid_date: null,
                paid_amount: 0
            });
        }
        
        const currentDate = new Date().toISOString();
        const debtId = 'debt_' + Date.now();
        const invoiceId = 'INV-' + Date.now();
        
        // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿØŸäŸÜ ÿßŸÑÿ¨ÿØŸäÿØ (ŸÖÿ∑ÿßÿ®ŸÇ ŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑)
        const newDebt = {
            type: 'debt',
            id: debtId,
            debt_id: debtId,
            invoice_id: invoiceId,
            customer_name: customerName,
            customer_phone: customerPhone,
            customer_address: customerAddress,
            date: document.getElementById('manualDebtDate').value || new Date().toISOString().split('T')[0],
            
            // ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿ®ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©
            subtotal: originalSubtotal,          // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä
            final_total: remainingAmount,        // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ÿßŸÑŸÖÿ™ÿ®ŸÇŸä
            
            // ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
            installment_details: {
                original_subtotal: originalSubtotal,
                additional_amount: additionalAmount,
                total_amount: totalAmount,
                down_payment: downPayment,
                remaining_amount: remainingAmount,
                installment_months: months,
                monthly_amount: monthlyAmount,
                start_date: startDate || new Date().toISOString().split('T')[0]
            },
            
            // ŸÑŸÑÿ™ŸàÿßŸÅŸÇ ŸÖÿπ ÿßŸÑÿ£ŸÜÿ∏ŸÖÿ© ÿßŸÑŸÇÿØŸäŸÖÿ©
            total_amount: totalAmount,
            down_payment: downPayment,
            additional_amount: additionalAmount,
            remaining_amount: remainingAmount,
            paid_amount: downPayment,
            installment_months: months,
            monthly_amount: monthlyAmount,
            start_date: startDate || new Date().toISOString().split('T')[0],
            
            notes: notes,
            items: JSON.stringify(productsToSave),  // ÿ≠ŸÅÿ∏ ŸÉŸÄ JSON ŸÑŸÑÿ™ŸàÿßŸÅŸÇ
            products: productsToSave,               // ÿ≠ŸÅÿ∏ ŸÉŸÄ array
            installments: installments,
            
            payment_type: 'ÿ£ŸÇÿ≥ÿßÿ∑',
            payment_method: 'ÿ£ŸÇÿ≥ÿßÿ∑',
            status: 'ŸÜÿ¥ÿ∑',
            
            created_at: currentDate,
            updated_at: currentDate,
            timestamp: currentDate
        };
        
        console.log('üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸäŸÜ:', newDebt);
        
        try {
            // 1. ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ debtsData ÿ£ŸàŸÑÿßŸã
            debtsData.push(newDebt);
            console.log('‚úÖ ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ debtsData');
            
            // 2. ÿ≠ŸÅÿ∏ ŸÅŸä localStorage ŸÅŸàÿ±ÿßŸã
            await saveToLocalStorage('debtsData', debtsData);
            console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÅŸä localStorage');
            
            // 3. ÿ≠ŸÅÿ∏ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
            const cachedDebts = debtsData.map(d => ({...d, type: 'debt'}));
            localStorage.setItem('cached_debts', JSON.stringify(cachedDebts));
            console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©');
            
            // 4. ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ≠ŸÅÿ∏ ŸÅŸä dataSdk (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
            if (window.dataSdk) {
                try {
                    const result = await window.dataSdk.create(newDebt);
                    if (result.isOk) {
                        console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÅŸä dataSdk');
                        // ÿ™ÿ≠ÿØŸäÿ´ ID ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿÆÿ™ŸÑŸÅÿßŸã
                        if (result.id && result.id !== newDebt.id) {
                            const index = debtsData.findIndex(d => d.id === newDebt.id);
                            if (index !== -1) {
                                debtsData[index].id = result.id;
                                debtsData[index].debt_id = result.id;
                                await saveToLocalStorage('debtsData', debtsData);
                            }
                        }
                    }
                } catch (sdkError) {
                    console.warn('‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏ ŸÅŸä dataSdk (ŸÑŸäÿ≥ ÿÆÿ∑Ÿäÿ±ÿßŸã):', sdkError);
                }
            }
            
            // 5. ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ≠ŸÅÿ∏ ŸÅŸä Firebase (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
            if (window.database) {
                try {
                    const uid = localStorage.getItem('app_uid');
                    if (uid) {
                        await window.database.ref(`users/${uid}/debts/${debtId}`).set(newDebt);
                        console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÅŸä Firebase');
                    }
                } catch (fbError) {
                    console.warn('‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏ ŸÅŸä Firebase (ŸÑŸäÿ≥ ÿÆÿ∑Ÿäÿ±ÿßŸã):', fbError);
                }
            }
            
            // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© Ÿàÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ¨ÿØŸàŸÑ
            closeAddManualDebtModal();
            renderDebtsTable();
            
            // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿ¨ÿßÿ≠ ŸÖÿπ ÿÆŸäÿßÿ± ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
            const printInvoice = confirm('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸäŸÜ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ¢ŸÜÿü');
            
            if (printInvoice) {
                // ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                showManualDebtInvoice(newDebt);
            }
            
            console.log('‚úÖ ÿ™ŸÖÿ™ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ≠ŸÅÿ∏ ÿ®ŸÜÿ¨ÿßÿ≠');
            
        } catch (error) {
            console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸäŸÜ:', error);
            alert('‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸäŸÜ: ' + error.message);
        }
    }
    
    // ============================================
    // ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿØŸäŸÜ
    // ============================================
    
    // ÿØÿßŸÑÿ© ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿØŸäŸÜ
    function searchProductsForDebt(searchTerm) {
        const resultsContainer = document.getElementById('manualDebtProductSearchResults');
        
        if (!searchTerm || searchTerm.trim() === '') {
            resultsContainer.style.display = 'none';
            return;
        }
        
        // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
        if (!products || products.length === 0) {
            resultsContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--theme-text-secondary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ</div>';
            resultsContainer.style.display = 'block';
            return;
        }
        
        const searchLower = searchTerm.toLowerCase().trim();
        const filtered = products.filter(p => {
            if (!p) return false;
            
            const name = p.name || p.product_name || '';
            const barcode = p.barcode || p.product_barcode || '';
            
            return name.toLowerCase().includes(searchLower) || barcode.includes(searchTerm);
        });
        
        if (filtered.length === 0) {
            resultsContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--theme-text-secondary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÑŸÑÿ®ÿ≠ÿ´ ÿπŸÜ "' + searchTerm + '"</div>';
            resultsContainer.style.display = 'block';
            return;
        }
        
        resultsContainer.innerHTML = filtered.map(p => {
            const name = p.name || p.product_name || 'ŸÖŸÜÿ™ÿ¨';
            const price = p.product_cost_retail || p.price || 0;
            const barcode = p.barcode || p.product_barcode || '';
            
            return `
            <div onclick="selectProductForDebt('${p.id}')" style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid var(--theme-border-color); transition: all 0.2s;"
                 onmouseover="this.style.background='var(--theme-bg-secondary)'" 
                 onmouseout="this.style.background='transparent'">
                <div style="font-weight: 500; color: var(--theme-text-primary);">${name}</div>
                <div style="font-size: 0.85rem; color: var(--theme-text-secondary); display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem;">
                    <span>${price.toLocaleString()} ÿØŸäŸÜÿßÿ±</span>
                    ${barcode ? '<span style="background: var(--theme-bg-secondary); padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">' + barcode + '</span>' : ''}
                </div>
            </div>
            `;
        }).join('');
        
        resultsContainer.style.display = 'block';
    }
    
    // ÿØÿßŸÑÿ© ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÜÿ™ÿ¨ ŸÖŸÜ ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´
    function selectProductForDebt(productId) {
        const product = products.find(p => p.id === productId);
        if (!product) {
            console.error('ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ:', productId);
            return;
        }
        
        const name = product.name || product.product_name || 'ŸÖŸÜÿ™ÿ¨';
        const price = product.product_cost_retail || product.price || 0;
        
        document.getElementById('manualDebtProductName').value = name;
        document.getElementById('manualDebtProductPrice').value = price;
        document.getElementById('manualDebtProductQty').value = 1;
        document.getElementById('manualDebtProductSearchResults').style.display = 'none';
        document.getElementById('manualDebtProductSearch').value = '';
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
        updateManualDebtTotal();
    }
    
    // ÿØÿßŸÑÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿØŸäŸÜ
    function addManualDebtProduct() {
        const name = document.getElementById('manualDebtProductName').value.trim();
        const price = parseFloat(document.getElementById('manualDebtProductPrice').value) || 0;
        const qty = parseInt(document.getElementById('manualDebtProductQty').value) || 1;
        
        if (!name || price <= 0 || qty <= 0) {
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            return;
        }
        
        const total = price * qty;
        manualDebtProducts.push({ name, price, qty, total });
        
        renderManualDebtProducts();
        updateManualDebtTotal();
        
        // ŸÖÿ≥ÿ≠ ÿßŸÑÿ≠ŸÇŸàŸÑ
        document.getElementById('manualDebtProductName').value = '';
        document.getElementById('manualDebtProductPrice').value = '';
        document.getElementById('manualDebtProductQty').value = 1;
    }
    
    // ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑÿ¨ÿØŸàŸÑ
    function renderManualDebtProducts() {
        const container = document.getElementById('manualDebtProductsContainer');
        const tbody = document.getElementById('manualDebtProductsTable');
        
        if (manualDebtProducts.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        tbody.innerHTML = manualDebtProducts.map((p, index) => `
            <tr>
                <td>${p.name}</td>
                <td>${p.price.toLocaleString()} ÿØŸäŸÜÿßÿ±</td>
                <td>${p.qty}</td>
                <td>${p.total.toLocaleString()} ÿØŸäŸÜÿßÿ±</td>
                <td>
                    <button class="action-btn delete-btn" onclick="removeManualDebtProduct(${index})" title="ÿ≠ÿ∞ŸÅ">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    // ÿØÿßŸÑÿ© ÿ≠ÿ∞ŸÅ ŸÖŸÜÿ™ÿ¨
    function removeManualDebtProduct(index) {
        manualDebtProducts.splice(index, 1);
        renderManualDebtProducts();
        updateManualDebtTotal();
    }
    
    // ÿØÿßŸÑÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä
    function updateManualDebtTotal() {
        const total = manualDebtProducts.reduce((sum, p) => sum + p.total, 0);
        document.getElementById('manualDebtTotalAmount').value = total;
        calculateManualDebtInstallments();
    }
    
    // ÿØÿßŸÑÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
    function calculateManualDebtInstallments() {
        const totalAmount = parseFloat(document.getElementById('manualDebtTotalAmount').value) || 0;
        const downPayment = parseFloat(document.getElementById('manualDebtDownPayment').value) || 0;
        const months = parseInt(document.getElementById('manualDebtMonths').value) || 1;
        const additionalAmount = parseFloat(document.getElementById('manualDebtAdditionalAmount').value) || 0;
        
        // ÿ≠ÿ≥ÿßÿ® ÿ®ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© (ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÑŸÑÿ•ÿµŸÑÿßÿ≠ÿßÿ™)
        const totalAmountWithAddition = totalAmount + additionalAmount;  // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸä
        const remaining = totalAmountWithAddition - downPayment;         // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä
        const monthly = remaining / months;                              // ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä
        
        document.getElementById('manualDebtRemainingAmount').textContent = remaining.toLocaleString() + ' ÿØŸäŸÜÿßÿ±';
        document.getElementById('manualDebtMonthlyAmount').textContent = monthly.toLocaleString() + ' ÿØŸäŸÜÿßÿ±';
        document.getElementById('manualDebtFinalTotal').textContent = totalAmountWithAddition.toLocaleString() + ' ÿØŸäŸÜÿßÿ±';
    }
    
    // ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ Ÿàÿ∑ÿ®ÿßÿπÿ© ŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿØŸäŸÜ ÿßŸÑŸäÿØŸàŸä
    function showManualDebtInvoice(debtData) {
        const settings = loadSettings();
        
        // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ•ŸÑŸâ ÿßŸÑÿµŸäÿ∫ÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
        let items = [];
        try {
            if (debtData.items) {
                items = typeof debtData.items === 'string' ? JSON.parse(debtData.items) : debtData.items;
            } else if (debtData.products) {
                items = debtData.products;
            }
            
            // ÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ ÿßŸÑÿµŸäÿ∫ÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© ŸÑŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
            items = items.map(item => ({
                product_name: item.name || item.product_name,
                product_price: item.price || item.product_price,
                quantity: item.qty || item.quantity || 1
            }));
        } catch (e) {
            console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™:', e);
            items = [];
        }
        
        // ÿ•ÿπÿØÿßÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
        const invoiceData = {
            ...debtData,
            items: items,
            payment_type: 'ÿ£ŸÇÿ≥ÿßÿ∑',
            payment_method: 'ÿ£ŸÇÿ≥ÿßÿ∑'
        };
        
        // ÿ•ŸÜÿ¥ÿßÿ° HTML ŸÑŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
        const invoiceHTML = generateInstallmentInvoiceReceipt(invoiceData, settings);
        
        // ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
        const printWindow = window.open('', '_blank');
        if (printWindow) {
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>ŸÅÿßÿ™Ÿàÿ±ÿ© ÿØŸäŸÜ - ${debtData.invoice_id}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Cairo', sans-serif; background: #fff; direction: rtl; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none !important; }
                            @page { size: A4; margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${invoiceHTML}
                    <div class="no-print" style="text-align: center; padding: 20px; background: #f5f5f5;">
                        <button onclick="window.print()" style="padding: 12px 30px; background: #6366f1; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-family: 'Cairo', sans-serif; margin: 0 10px;">
                            <i class="fas fa-print"></i> ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                        </button>
                        <button onclick="window.close()" style="padding: 12px 30px; background: #dc2626; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-family: 'Cairo', sans-serif; margin: 0 10px;">
                            <i class="fas fa-times"></i> ÿ•ÿ∫ŸÑÿßŸÇ
                        </button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            
            // ÿ∑ÿ®ÿßÿπÿ© ÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© ÿ®ÿπÿØ ÿ´ÿßŸÜŸäÿ©
            setTimeout(() => {
                printWindow.print();
            }, 500);
        } else {
            alert('‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ∑ÿ®ÿßÿπÿ©. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ©.');
        }
    }
    
    // ÿØŸàÿßŸÑ ŸÖŸÖÿßÿ´ŸÑÿ© ŸÑŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ
    function searchProductsForEditDebt(searchTerm) {
        const resultsContainer = document.getElementById('editDebtProductSearchResults');
        
        if (!searchTerm || searchTerm.trim() === '') {
            resultsContainer.style.display = 'none';
            return;
        }
        
        const filtered = products.filter(p => 
            p.name && p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            p.barcode && p.barcode.includes(searchTerm)
        );
        
        if (filtered.length === 0) {
            resultsContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--theme-text-secondary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨</div>';
            resultsContainer.style.display = 'block';
            return;
        }
        
        resultsContainer.innerHTML = filtered.map(p => `
            <div onclick="selectProductForEditDebt('${p.id}')" style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid var(--theme-border-color); transition: all 0.2s;"
                 onmouseover="this.style.background='var(--theme-bg-secondary)'" 
                 onmouseout="this.style.background='transparent'">
                <div style="font-weight: 500; color: var(--theme-text-primary);">${p.name}</div>
                <div style="font-size: 0.85rem; color: var(--theme-text-secondary);">
                    ${p.product_cost_retail ? p.product_cost_retail.toLocaleString() : '0'} ÿØŸäŸÜÿßÿ±
                </div>
            </div>
        `).join('');
        
        resultsContainer.style.display = 'block';
    }
    
    function selectProductForEditDebt(productId) {
        const product = products.find(p => p.id === productId);
        if (!product) return;
        
        document.getElementById('editDebtProductName').value = product.name;
        document.getElementById('editDebtProductPrice').value = product.product_cost_retail || 0;
        document.getElementById('editDebtProductQty').value = 1;
        document.getElementById('editDebtProductSearchResults').style.display = 'none';
        document.getElementById('editDebtProductSearch').value = '';
    }
    
    function addEditDebtProduct() {
        const name = document.getElementById('editDebtProductName').value.trim();
        const price = parseFloat(document.getElementById('editDebtProductPrice').value) || 0;
        const qty = parseInt(document.getElementById('editDebtProductQty').value) || 1;
        
        if (!name || price <= 0 || qty <= 0) {
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            return;
        }
        
        const total = price * qty;
        editDebtProducts.push({ name, price, qty, total });
        
        renderEditDebtProducts();
        updateEditDebtTotal();
        
        document.getElementById('editDebtProductName').value = '';
        document.getElementById('editDebtProductPrice').value = '';
        document.getElementById('editDebtProductQty').value = 1;
    }
    
    function renderEditDebtProducts() {
        const container = document.getElementById('editDebtProductsContainer');
        const tbody = document.getElementById('editDebtProductsTable');
        
        if (editDebtProducts.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        tbody.innerHTML = editDebtProducts.map((p, index) => `
            <tr>
                <td>${p.name}</td>
                <td>${p.price.toLocaleString()} ÿØŸäŸÜÿßÿ±</td>
                <td>${p.qty}</td>
                <td>${p.total.toLocaleString()} ÿØŸäŸÜÿßÿ±</td>
                <td>
                    <button class="action-btn delete-btn" onclick="removeEditDebtProduct(${index})" title="ÿ≠ÿ∞ŸÅ">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    function removeEditDebtProduct(index) {
        editDebtProducts.splice(index, 1);
        renderEditDebtProducts();
        updateEditDebtTotal();
    }
    
    function updateEditDebtTotal() {
        const total = editDebtProducts.reduce((sum, p) => sum + p.total, 0);
        document.getElementById('editDebtTotalAmount').value = total;
        calculateEditDebtInstallments();
    }
    
    function calculateEditDebtInstallments() {
        const totalAmount = parseFloat(document.getElementById('editDebtTotalAmount').value) || 0;
        const downPayment = parseFloat(document.getElementById('editDebtDownPayment').value) || 0;
        const months = parseInt(document.getElementById('editDebtMonths').value) || 1;
        const additionalAmount = parseFloat(document.getElementById('editDebtAdditionalAmount').value) || 0;
        
        const remaining = totalAmount - downPayment + additionalAmount;
        const monthly = remaining / months;
        const finalTotal = totalAmount + additionalAmount;
        
        document.getElementById('editDebtRemainingAmount').textContent = remaining.toLocaleString() + ' ÿØŸäŸÜÿßÿ±';
        document.getElementById('editDebtMonthlyAmount').textContent = monthly.toLocaleString() + ' ÿØŸäŸÜÿßÿ±';
        document.getElementById('editDebtFinalTotal').textContent = finalTotal.toLocaleString() + ' ÿØŸäŸÜÿßÿ±';
    }
    
    // ÿØÿßŸÑÿ© ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ
    async function showEditDebtModal(debtId) {
        console.log('üîç ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿØŸäŸÜ:', debtId, 'ŸÜŸàÿπ:', typeof debtId);
        currentEditDebtId = debtId;
        
        // ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑŸÑŸÖŸÇÿßÿ±ŸÜÿ© ÿ™ÿØÿπŸÖ ŸÉŸÑ ÿ£ŸÜŸàÿßÿπ ÿßŸÑŸÖÿπÿ±ŸÅÿßÿ™
        const compareIds = (id1, id2) => {
            if (id1 == id2) return true; // ŸÖŸÇÿßÿ±ŸÜÿ© ÿπÿßÿØŸäÿ© (== ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ===)
            if (String(id1) === String(id2)) return true; // ŸÖŸÇÿßÿ±ŸÜÿ© ŸÉŸÜÿµŸàÿµ
            if (Number(id1) === Number(id2)) return true; // ŸÖŸÇÿßÿ±ŸÜÿ© ŸÉÿ£ÿ±ŸÇÿßŸÖ
            return false;
        };
        
        // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä debtsData ÿ£ŸàŸÑÿßŸã
        let debt = debtsData.find(d => {
            const id = d.id || d.__backendId || d.debt_id;
            return compareIds(id, debtId);
        });
        
        console.log('üìä ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä debtsData:', debt ? 'ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸäŸá' : 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ±');
        console.log('üìã ÿπÿØÿØ ÿßŸÑÿØŸäŸàŸÜ ŸÅŸä debtsData:', debtsData.length);
        
        // ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸäŸáÿå ÿ¨ÿ±ÿ® ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä dataSdk
        if (!debt && window.dataSdk) {
            console.log('üîç ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä dataSdk...');
            const allData = window.dataSdk.getAll();
            console.log('üìä ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ŸÅŸä dataSdk:', allData.length);
            
            const allDebts = allData.filter(item => item.type === 'debt');
            console.log('üìä ÿπÿØÿØ ÿßŸÑÿØŸäŸàŸÜ ŸÅŸä dataSdk:', allDebts.length);
            console.log('üìã ŸÖÿπÿ±ŸÅÿßÿ™ ÿßŸÑÿØŸäŸàŸÜ:', allDebts.map(d => ({
                id: d.id,
                __backendId: d.__backendId,
                debt_id: d.debt_id,
                customer: d.customer_name
            })));
            
            debt = allDebts.find(d => {
                const id = d.id || d.__backendId || d.debt_id;
                return compareIds(id, debtId);
            });
            
            if (debt) {
                console.log('‚úÖ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿØŸäŸÜ ŸÅŸä dataSdk');
                // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿØŸäŸÜ ÿ•ŸÑŸâ debtsData ŸÑŸÑŸÖÿ±ÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©
                if (!debtsData.find(d => compareIds(d.id || d.__backendId || d.debt_id, debtId))) {
                    debtsData.push(debt);
                    console.log('‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿØŸäŸÜ ÿ•ŸÑŸâ debtsData');
                }
            }
        }
        
        if (!debt) {
            console.error('‚ùå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿØŸäŸÜ:', debtId);
            console.error('üìã ÿßŸÑŸÖÿπÿ±ŸÅÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© ŸÅŸä debtsData:', debtsData.map(d => d.id || d.__backendId || d.debt_id));
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            return;
        }
        
        console.log('‚úÖ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØŸäŸÜ:', debt);
        
        // ÿ™ÿπÿ®ÿ¶ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        document.getElementById('editDebtCustomerName').value = debt.customer_name || '';
        document.getElementById('editDebtCustomerPhone').value = debt.customer_phone || '';
        document.getElementById('editDebtCustomerAddress').value = debt.customer_address || '';
        document.getElementById('editDebtDate').value = debt.date || new Date().toISOString().split('T')[0];
        document.getElementById('editDebtTotalAmount').value = debt.total_amount || 0;
        document.getElementById('editDebtDownPayment').value = debt.down_payment || debt.paid_amount || 0;
        document.getElementById('editDebtMonths').value = debt.installment_months || 1;
        document.getElementById('editDebtAdditionalAmount').value = debt.additional_amount || 0;
        document.getElementById('editDebtStartDate').value = debt.start_date || '';
        document.getElementById('editDebtNotes').value = debt.notes || '';
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸàÿ¨ŸàÿØÿ©
        editDebtProducts = debt.products ? [...debt.products] : [];
        renderEditDebtProducts();
        calculateEditDebtInstallments();
        
        showModal('editDebtModal');
    }
    
    function closeEditDebtModal() {
        closeModal('editDebtModal');
        currentEditDebtId = null;
        editDebtProducts = [];
    }
    
    // ÿØÿßŸÑÿ© ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™
    async function updateDebt() {
        if (!currentEditDebtId) {
            alert('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿØŸäŸÜ ŸÑŸÑÿ™ÿπÿØŸäŸÑ');
            return;
        }
        
        // ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑŸÑŸÖŸÇÿßÿ±ŸÜÿ© ÿ™ÿØÿπŸÖ ŸÉŸÑ ÿ£ŸÜŸàÿßÿπ ÿßŸÑŸÖÿπÿ±ŸÅÿßÿ™
        const compareIds = (id1, id2) => {
            if (id1 == id2) return true;
            if (String(id1) === String(id2)) return true;
            if (Number(id1) === Number(id2)) return true;
            return false;
        };
        
        const debtIndex = debtsData.findIndex(d => {
            const id = d.id || d.__backendId || d.debt_id;
            return compareIds(id, currentEditDebtId);
        });
        
        if (debtIndex === -1) {
            console.error('‚ùå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿØŸäŸÜ ŸÅŸä debtsData:', currentEditDebtId);
            alert('‚ùå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿØŸäŸÜ');
            return;
        }
        
        const customerName = document.getElementById('editDebtCustomerName').value.trim();
        const customerPhone = document.getElementById('editDebtCustomerPhone').value.trim();
        
        if (!customerName || !customerPhone) {
            alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ Ÿàÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ');
            return;
        }
        
        const totalAmount = parseFloat(document.getElementById('editDebtTotalAmount').value) || 0;
        const downPayment = parseFloat(document.getElementById('editDebtDownPayment').value) || 0;
        const months = parseInt(document.getElementById('editDebtMonths').value) || 1;
        const additionalAmount = parseFloat(document.getElementById('editDebtAdditionalAmount').value) || 0;
        const startDate = document.getElementById('editDebtStartDate').value;
        const debtDate = document.getElementById('editDebtDate').value;
        
        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑÿ¨ÿØŸäÿØÿ©
        const remaining = totalAmount - downPayment + additionalAmount;
        const monthly = remaining / months;
        const installments = [];
        const startDateObj = startDate ? new Date(startDate) : new Date();
        
        // ÿ•ŸÜÿ¥ÿßÿ° ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
        for (let i = 0; i < months; i++) {
            const dueDate = new Date(startDateObj);
            dueDate.setMonth(dueDate.getMonth() + i);
            
            // ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿØŸÅŸàÿπÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸàÿ¨ŸàÿØÿ©
            const existingInstallment = debtsData[debtIndex].installments?.[i];
            
            installments.push({
                month: i + 1,
                amount: monthly,
                due_date: dueDate.toISOString(),
                status: existingInstallment?.status || 'pending',
                paid_date: existingInstallment?.paid_date || null,
                paid_amount: existingInstallment?.paid_amount || 0
            });
        }
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿØŸäŸÜ
        const updatedDebt = {
            ...debtsData[debtIndex],
            type: 'debt',
            customer_name: customerName,
            customer_phone: customerPhone,
            customer_address: document.getElementById('editDebtCustomerAddress').value.trim() || '',
            date: debtDate || new Date().toISOString().split('T')[0],
            total_amount: totalAmount,
            down_payment: downPayment,
            additional_amount: additionalAmount,
            remaining_amount: remaining,
            paid_amount: downPayment,
            installment_months: months,
            monthly_amount: monthly,
            start_date: startDate || new Date().toISOString().split('T')[0],
            notes: document.getElementById('editDebtNotes').value.trim() || '',
            products: editDebtProducts || debtsData[debtIndex].products || [],
            installments: installments,
            status: debtsData[debtIndex].status || 'ŸÜÿ¥ÿ∑',
            updated_at: new Date().toISOString()
        };
        
        // ÿ•ÿ≤ÿßŸÑÿ© ÿ£Ÿä ÿ≠ŸÇŸàŸÑ undefined
        Object.keys(updatedDebt).forEach(key => {
            if (updatedDebt[key] === undefined) {
                delete updatedDebt[key];
            }
        });
        
        console.log('üíæ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿØŸäŸÜ:', updatedDebt);
        
        try {
            // 1. ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä debtsData
            debtsData[debtIndex] = updatedDebt;
            console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä debtsData');
            
            // 2. ÿ≠ŸÅÿ∏ ŸÅŸä localStorage ŸÅŸàÿ±ÿßŸã
            await saveToLocalStorage('debtsData', debtsData);
            console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÅŸä localStorage');
            
            // 3. ÿ≠ŸÅÿ∏ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
            const cachedDebts = debtsData.map(d => ({...d, type: 'debt'}));
            localStorage.setItem('cached_debts', JSON.stringify(cachedDebts));
            console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©');
            
            // 4. ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä dataSdk (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
            if (window.dataSdk && debtsData[debtIndex].id) {
                try {
                    const result = await window.dataSdk.update(debtsData[debtIndex].id, updatedDebt);
                    if (result.isOk) {
                        console.log('‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä dataSdk');
                    }
                } catch (sdkError) {
                    console.warn('‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä dataSdk (ŸÑŸäÿ≥ ÿÆÿ∑Ÿäÿ±ÿßŸã):', sdkError);
                }
            }
            
            // 5. ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä Firebase (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
            if (window.database) {
                try {
                    const uid = localStorage.getItem('app_uid');
                    if (uid && currentEditDebtId) {
                        await window.database.ref(`users/${uid}/debts/${currentEditDebtId}`).set(updatedDebt);
                        console.log('‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä Firebase');
                    }
                } catch (fbError) {
                    console.warn('‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä Firebase (ŸÑŸäÿ≥ ÿÆÿ∑Ÿäÿ±ÿßŸã):', fbError);
                }
            }
            
            closeEditDebtModal();
            renderDebtsTable();
            
            alert('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿØŸäŸÜ ÿ®ŸÜÿ¨ÿßÿ≠');
            console.log('‚úÖ ÿ™ŸÖÿ™ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸÜÿ¨ÿßÿ≠');
            
        } catch (error) {
            console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿØŸäŸÜ:', error);
            alert('‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿØŸäŸÜ: ' + error.message);
        }
    }
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿØÿßŸÑÿ© processInstallmentPayment ŸÑÿ™ÿ∂ŸÖŸäŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
    async function processInstallmentPaymentUpdated() {
        const customerName = document.getElementById('customerName').value.trim();
        const customerPhone = document.getElementById('customerPhone').value.trim();
        const customerAddress = document.getElementById('customerAddress').value.trim();
        const months = parseInt(document.getElementById('installmentMonths').value) || 12;
        const additionalAmount = parseFloat(document.getElementById('additionalAmount').value) || 0;
        const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
        const startDate = document.getElementById('installmentStartDate').value;
        
        if (!customerName || !customerPhone) {
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            return;
        }
        
        if (cart.length === 0) {
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            return;
        }
        
        const cartTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const totalWithAddition = cartTotal + additionalAmount;
        const remainingAmount = totalWithAddition - downPayment;
        const monthlyPayment = remainingAmount / months;
        
        // ÿ•ŸÜÿ¥ÿßÿ° ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ŸÖÿπ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ
        const installments = [];
        const startDateObj = startDate ? new Date(startDate) : new Date();
        
        for (let i = 0; i < months; i++) {
            const dueDate = new Date(startDateObj);
            dueDate.setMonth(dueDate.getMonth() + i);
            
            installments.push({
                month: i + 1,
                amount: monthlyPayment,
                due_date: dueDate.toISOString(),
                status: 'pending',
                paid_date: null,
                paid_amount: 0
            });
        }
        
        // ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ÿ¨ŸÑ ÿßŸÑÿØŸäŸÜ
        const debt = {
            id: 'debt_' + Date.now(),
            customer_name: customerName,
            customer_phone: customerPhone,
            customer_address: customerAddress,
            total_amount: totalWithAddition,
            down_payment: downPayment,
            remaining_amount: remainingAmount,
            installment_months: months,
            monthly_amount: monthlyPayment,
            additional_amount: additionalAmount,
            start_date: startDate,
            installments: installments,
            products: cart.map(item => ({
                name: item.name,
                price: item.price,
                qty: item.quantity,
                total: item.price * item.quantity
            })),
            date: new Date().toISOString(),
            status: 'active',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };
        
        debtsData.push(debt);
        
        // ÿ≠ŸÅÿ∏ Ÿàÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿπŸÖŸÑŸäÿ©
        try {
            if (window.database) {
                await window.database.ref('debts/' + debt.id).set(debt);
            }
            
            await saveToLocalStorage('debtsData', debtsData);
            
            cart = [];
            updateCartDisplay();
            closeModal('paymentModal');
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            updateDebtsView();
        } catch (error) {
            console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸäŸÜ:', error);
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        }
    }
    
    // ============================================
    // ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜÿ©
    // ============================================
    
    // ÿØŸàÿßŸÑ ÿ®ÿ≠ÿ´ ŸÖŸàÿ≠ÿØÿ© ŸÑŸÑŸÖŸÜÿ™ÿ¨
    function findProductById(productId) {
        return products.find(
            p => String(p.id) === String(productId) || String(p.product_id) === String(productId) || String(p.barcode) === String(productId)
        );
    }
    function findProductIndexById(productId) {
        return products.findIndex(
            p => String(p.id) === String(productId) || String(p.product_id) === String(productId) || String(p.barcode) === String(productId)
        );
    }

    // ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨
    function showProductDetails(productId) {
        const product = findProductById(productId);
        if (!product) {
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            return;
        }
        
        const totalCost = (product.cost || 0) * (product.stock || 0);
        const totalValue = (product.price || 0) * (product.stock || 0);
        const expectedProfit = totalValue - totalCost;
        const profitMargin = totalCost > 0 ? ((expectedProfit / totalCost) * 100).toFixed(2) : 0;
        
        const content = `
            <div style="padding: 1rem;">
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-label">ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨</div>
                        <div class="stat-value" style="font-size: 1.2rem;">${product.name}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ</div>
                        <div class="stat-value" style="font-size: 1.2rem;">${product.barcode}</div>
                    </div>
                </div>
                
                <table class="table">
                    <tbody>
                        <tr>
                            <th><i class="fas fa-layer-group"></i> ÿßŸÑÿ™ÿµŸÜŸäŸÅ</th>
                            <td>${product.category || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-warehouse"></i> ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸÖÿ™ŸàŸÅÿ±ÿ©</th>
                            <td>${product.stock || 0}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-coins"></i> ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°</th>
                            <td>${(product.cost || 0).toLocaleString()} ÿØŸäŸÜÿßÿ±</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-money-bill"></i> ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ</th>
                            <td>${(product.price || 0).toLocaleString()} ÿØŸäŸÜÿßÿ±</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-chart-line"></i> ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©</th>
                            <td>${totalCost.toLocaleString()} ÿØŸäŸÜÿßÿ±</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-dollar-sign"></i> ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑŸÖÿ™ŸàŸÇÿπÿ©</th>
                            <td>${totalValue.toLocaleString()} ÿØŸäŸÜÿßÿ±</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-chart-pie"></i> ÿßŸÑÿ±ÿ®ÿ≠ ÿßŸÑŸÖÿ™ŸàŸÇÿπ</th>
                            <td style="color: ${expectedProfit >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">
                                ${expectedProfit.toLocaleString()} ÿØŸäŸÜÿßÿ±
                            </td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-percent"></i> ŸáÿßŸÖÿ¥ ÿßŸÑÿ±ÿ®ÿ≠</th>
                            <td>${profitMargin}%</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-calendar"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©</th>
                            <td>${product.created_at ? new Date(product.created_at).toLocaleDateString('en-GB') : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="closeProductDetailsModal(); openEditProductModal('${product.id}');">
                        <i class="fas fa-edit"></i> ÿ™ÿπÿØŸäŸÑ
                    </button>
                    <button class="btn btn-secondary" onclick="closeProductDetailsModal()">
                        <i class="fas fa-times"></i> ÿ•ÿ∫ŸÑÿßŸÇ
                    </button>
                </div>
            </div>
        `;
        
        document.getElementById('productDetailsContent').innerHTML = content;
        showModal('productDetailsModal');
    }
    
    function closeProductDetailsModal() {
        hideModal('productDetailsModal');
    }
    
    // ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨
    function openEditProductModal(productId) {
        const product = findProductById(productId);
        if (!product) {
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            return;
        }
        document.getElementById('editProductId').value = product.id || '';
        document.getElementById('editProductName').value = product.name || '';
        document.getElementById('editProductBarcode').value = product.barcode || '';
        document.getElementById('editProductStock').value = product.stock != null ? product.stock : 0;
        document.getElementById('editProductCost').value = product.cost != null ? product.cost : 0;
        document.getElementById('editProductPrice').value = product.price != null ? product.price : 0;
        // ŸÖŸÑÿ° ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™
        const categorySelect = document.getElementById('editProductCategory');
        categorySelect.innerHTML = '<option value="">ÿ®ÿØŸàŸÜ ÿ™ÿµŸÜŸäŸÅ</option>';
        if (Array.isArray(categories) && categories.length > 0) {
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name;
                if (product.category === cat.name) option.selected = true;
                categorySelect.appendChild(option);
            });
        }
        showModal('editProductModal');
    }
    
    function closeEditProductModal() {
        hideModal('editProductModal');
        document.getElementById('editProductForm').reset();
    }
    
    // ÿ≠ŸÅÿ∏ ÿ™ÿπÿØŸäŸÑÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨
    async function saveEditedProduct(event) {
        event.preventDefault();
        
        const productId = document.getElementById('editProductId').value;
        const name = document.getElementById('editProductName').value;
        const barcode = document.getElementById('editProductBarcode').value;
        const category = document.getElementById('editProductCategory').value;
        const stock = parseInt(document.getElementById('editProductStock').value) || 0;
        const cost = parseFloat(document.getElementById('editProductCost').value) || 0;
        const price = parseFloat(document.getElementById('editProductPrice').value) || 0;
        
        const productIndex = findProductIndexById(productId);
        if (productIndex === -1) {
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            return;
        }
        
        products[productIndex] = {
            ...products[productIndex],
            name: name,
            barcode: barcode,
            category: category,
            stock: stock,
            cost: cost,
            price: price,
            updated_at: new Date().toISOString()
        };
        if (window.dataSdk) {
            await window.dataSdk.save({ ...products[productIndex], type: 'product' });
        }
        closeEditProductModal();
        updateInventoryView();
        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
    }
    
    // ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨
    async function deleteProduct(productId) {
        if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨ÿü ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°!')) {
            return;
        }
        const productIndex = findProductIndexById(productId);
        if (productIndex === -1) {
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            return;
        }
        if (window.dataSdk) {
            await window.dataSdk.delete(productId);
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖŸÜ ÿßŸÑŸÇÿßÿπÿØÿ© ÿ®ÿπÿØ ÿßŸÑÿ≠ÿ∞ŸÅ (ÿßŸÜÿ™ÿ∏ÿßÿ± ŸÅÿπŸÑŸä)
            if (typeof window.dataSdk.getAll === 'function') {
                const allData = await window.dataSdk.getAll();
                products = allData.filter(item => item.type === 'product');
            }
        }
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑŸàÿßÿ¨Ÿáÿßÿ™ ÿ®ÿπÿØ ÿßŸÑÿ≠ÿ∞ŸÅ
        if (typeof updateAllViews === 'function') {
            updateAllViews();
        } else if (typeof updateInventoryView === 'function') {
            updateInventoryView();
        }
        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
    }
    
    // ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ŸÜŸÇŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ®ŸäŸÜ ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™
    function openMoveProductCategoryModal(productId) {
        const product = findProductById(productId);
        if (!product) {
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            return;
        }
        
        document.getElementById('moveProductId').value = product.id;
        document.getElementById('moveProductName').value = product.name;
        document.getElementById('moveProductCurrentCategory').value = product.category || 'ÿ®ÿØŸàŸÜ ÿ™ÿµŸÜŸäŸÅ';
        
        // ŸÖŸÑÿ° ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©
        const categorySelect = document.getElementById('moveProductNewCategory');
        categorySelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ¨ÿØŸäÿØ...</option>';
        categories.forEach(cat => {
            if (cat.name !== product.category) {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
            }
        });
        
        showModal('moveProductCategoryModal');
    }
    
    function closeMoveProductCategoryModal() {
        hideModal('moveProductCategoryModal');
        document.getElementById('moveProductCategoryForm').reset();
    }
    
    // ÿ≠ŸÅÿ∏ ŸÜŸÇŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ•ŸÑŸâ ÿ™ÿµŸÜŸäŸÅ ÿ¨ÿØŸäÿØ
    async function saveProductCategoryMove(event) {
        event.preventDefault();
        
        const productId = document.getElementById('moveProductId').value;
        const newCategory = document.getElementById('moveProductNewCategory').value;
        
        if (!newCategory) {
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            return;
        }
        
        const productIndex = products.findIndex(p => p.id === productId);
        if (productIndex === -1) {
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            return;
        }
        
        products[productIndex].category = newCategory;
        products[productIndex].updated_at = new Date().toISOString();
        
        await dataSDK.save({ ...products[productIndex], type: 'product' });
        
        closeMoveProductCategoryModal();
        updateInventoryView();
        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
    }
    
    // ÿ∑ÿ®ÿßÿπÿ© ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
    function printInventoryReport() {
        const storeSettings = JSON.parse(localStorage.getItem('storeSettings') || '{}');
        const storeName = storeSettings.storeName || storeSettings.store_name || 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ™ÿ¨ÿ±';
        const today = new Date().toLocaleDateString('en-GB');
        
        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
        let totalCost = 0;
        let totalValue = 0;
        let totalProfit = 0;
        
        products.forEach(product => {
            const cost = (product.cost || 0) * (product.stock || 0);
            const value = (product.price || 0) * (product.stock || 0);
            totalCost += cost;
            totalValue += value;
        });
        
        totalProfit = totalValue - totalCost;
        const profitMargin = totalCost > 0 ? ((totalProfit / totalCost) * 100).toFixed(2) : 0;
        
        let html = `
        <div style="width:100%;max-width:800px;margin:0 auto;padding:20px;font-family:'Cairo',sans-serif;background:#fff;color:#222;direction:rtl;">
            <div style="text-align:center;margin-bottom:20px;border-bottom:3px solid #6366f1;padding-bottom:15px;">
                <h1 style="margin:0 0 5px 0;font-size:2rem;color:#2d3748;">${storeName}</h1>
                <h2 style="margin:0;font-size:1.5rem;color:#6366f1;">ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿßŸÑÿ¥ÿßŸÖŸÑ</h2>
                <p style="margin:10px 0 0;font-size:1rem;color:#666;">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: ${today}</p>
            </div>
            
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:25px;">
                <div style="background:linear-gradient(135deg,#6366f1,#4f46e5);color:#fff;padding:15px;border-radius:10px;text-align:center;">
                    <div style="font-size:0.9rem;margin-bottom:5px;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÉŸÑŸÅÿ©</div>
                    <div style="font-size:1.5rem;font-weight:bold;">${totalCost.toLocaleString()} ÿØŸäŸÜÿßÿ±</div>
                </div>
                <div style="background:linear-gradient(135deg,#10b981,#059669);color:#fff;padding:15px;border-radius:10px;text-align:center;">
                    <div style="font-size:0.9rem;margin-bottom:5px;">ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑŸÖÿ™ŸàŸÇÿπÿ©</div>
                    <div style="font-size:1.5rem;font-weight:bold;">${totalValue.toLocaleString()} ÿØŸäŸÜÿßÿ±</div>
                </div>
                <div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;padding:15px;border-radius:10px;text-align:center;">
                    <div style="font-size:0.9rem;margin-bottom:5px;">ÿßŸÑÿ±ÿ®ÿ≠ ÿßŸÑŸÖÿ™ŸàŸÇÿπ</div>
                    <div style="font-size:1.5rem;font-weight:bold;">${totalProfit.toLocaleString()} ÿØŸäŸÜÿßÿ±</div>
                </div>
            </div>
            
            <table style="width:100%;border-collapse:collapse;margin-top:20px;">
                <thead>
                    <tr style="background:#6366f1;color:#fff;">
                        <th style="padding:10px;border:1px solid #ddd;text-align:center;">#</th>
                        <th style="padding:10px;border:1px solid #ddd;text-align:right;">ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
                        <th style="padding:10px;border:1px solid #ddd;text-align:center;">ÿßŸÑÿ™ÿµŸÜŸäŸÅ</th>
                        <th style="padding:10px;border:1px solid #ddd;text-align:center;">ÿßŸÑŸÉŸÖŸäÿ©</th>
                        <th style="padding:10px;border:1px solid #ddd;text-align:center;">ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°</th>
                        <th style="padding:10px;border:1px solid #ddd;text-align:center;">ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ</th>
                        <th style="padding:10px;border:1px solid #ddd;text-align:center;">ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©</th>
                        <th style="padding:10px;border:1px solid #ddd;text-align:center;">ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑŸÖÿ™ŸàŸÇÿπÿ©</th>
                    </tr>
                </thead>
                <tbody>`;
        
        products.forEach((product, index) => {
            const cost = (product.cost || 0) * (product.stock || 0);
            const value = (product.price || 0) * (product.stock || 0);
            
            html += `
                <tr style="background:${index % 2 === 0 ? '#fff' : '#f9fafb'};">
                    <td style="padding:8px;border:1px solid #ddd;text-align:center;">${index + 1}</td>
                    <td style="padding:8px;border:1px solid #ddd;text-align:right;">${product.name}</td>
                    <td style="padding:8px;border:1px solid #ddd;text-align:center;">${product.category || '-'}</td>
                    <td style="padding:8px;border:1px solid #ddd;text-align:center;">${product.stock || 0}</td>
                    <td style="padding:8px;border:1px solid #ddd;text-align:center;">${(product.cost || 0).toLocaleString()}</td>
                    <td style="padding:8px;border:1px solid #ddd;text-align:center;">${(product.price || 0).toLocaleString()}</td>
                    <td style="padding:8px;border:1px solid #ddd;text-align:center;">${cost.toLocaleString()}</td>
                    <td style="padding:8px;border:1px solid #ddd;text-align:center;">${value.toLocaleString()}</td>
                </tr>`;
        });
        
        html += `
                </tbody>
            </table>
            
            <div style="margin-top:30px;padding:20px;background:#f9fafb;border-radius:10px;text-align:center;">
                <p style="font-size:1.2rem;color:#6366f1;font-weight:bold;margin:0;">
                    ŸáÿßŸÖÿ¥ ÿßŸÑÿ±ÿ®ÿ≠ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${profitMargin}%
                </p>
            </div>
            
            <div style="margin-top:30px;text-align:center;color:#666;font-size:0.9rem;">
                <p style="margin:5px 0;">ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ŸÜÿ∏ÿßŸÖ ŸÜŸÇÿßÿ∑ ÿßŸÑÿ®Ÿäÿπ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ</p>
                <p style="margin:5px 0;">ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿ•ÿ®ÿØÿßÿπ ÿßŸÑÿ±ŸÇŸÖŸä - ÿ•ÿØÿßÿ±ÿ© ŸÉÿ±ÿßÿ± ÿßŸÑÿ≥ÿπÿ®ÿ±Ÿä</p>
            </div>
        </div>`;
        
        if (window.electronAPI && window.electronAPI.printInvoiceHtml) {
            window.electronAPI.printInvoiceHtml(html, { silent: false });
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        } else {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        }
    }
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿπÿ±ÿ∂ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ŸÖÿπ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™
    const originalUpdateInventoryView = window.updateInventoryView;
    window.updateInventoryView = function() {
        if (originalUpdateInventoryView) {
            originalUpdateInventoryView();
        }
        
        // ÿ•ÿ∂ÿßŸÅÿ© ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ŸÑŸÉŸÑ ŸÖŸÜÿ™ÿ¨
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        if (inventoryTableBody) {
            const rows = inventoryTableBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const product = products[index];
                if (product && row.cells.length < 8) {
                    const actionsCell = row.insertCell(-1);
                    actionsCell.innerHTML = `
                        <div class="action-buttons">
                            <button class="btn-icon btn-info" onclick="showProductDetails('${product.id}')" title="ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <button class="btn-icon btn-primary" onclick="openEditProductModal('${product.id}')" title="ÿ™ÿπÿØŸäŸÑ">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon btn-warning" onclick="openMoveProductCategoryModal('${product.id}')" title="ŸÜŸÇŸÑ">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            <button class="btn-icon btn-danger" onclick="deleteProduct('${product.id}')" title="ÿ≠ÿ∞ŸÅ">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }
            });
        }
    };
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿπÿ±ÿ∂ ÿ¨ÿØŸàŸÑ ÿßŸÑÿØŸäŸàŸÜ ŸÖÿπ ÿ≤ÿ± ÿßŸÑÿ™ÿπÿØŸäŸÑ
    const originalUpdateDebtsView = window.updateDebtsView;
    window.updateDebtsView = function() {
        if (originalUpdateDebtsView) {
            originalUpdateDebtsView();
        }
        
        // ÿ•ÿ∂ÿßŸÅÿ© ÿ≤ÿ± ÿßŸÑÿ™ÿπÿØŸäŸÑ ŸÑŸÉŸÑ ÿØŸäŸÜ
        const debtsTableBody = document.getElementById('debtsTableBody');
        if (debtsTableBody) {
            const rows = debtsTableBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const debt = debtsData[index];
                if (debt) {
                    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿÆŸÑŸäÿ© ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™
                    const actionsCell = row.cells[row.cells.length - 1];
                    if (actionsCell && !actionsCell.querySelector('.edit-debt-btn')) {
                        const editButton = document.createElement('button');
                        editButton.className = 'btn-icon btn-warning edit-debt-btn';
                        editButton.title = 'ÿ™ÿπÿØŸäŸÑ';
                        editButton.innerHTML = '<i class="fas fa-edit"></i>';
                        editButton.onclick = () => openEditDebtModal(debt.id);
                        
                        actionsCell.insertBefore(editButton, actionsCell.firstChild);
                    }
                }
            });
        }
    };
    
    // ÿ•ÿµŸÑÿßÿ≠ÿßÿ™ ÿ¥ÿßŸÖŸÑÿ©
    console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ŸàÿßŸÑÿ•ÿµŸÑÿßÿ≠ÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!');
    
    // ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üîÑ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™...');
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±Ÿàÿ∂
        if (typeof updateInventoryView === 'function') {
            updateInventoryView();
        }
        if (typeof updateDebtsView === 'function') {
            updateDebtsView();
        }
    });






    
    
    </script>
    
    <!-- üí∞ ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ÿßŸÑŸÖÿ™ŸÉÿßŸÖŸÑ -->
    <script>
    // ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™
    (function() {
        'use strict';

        // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™
        let allPayments = [];
        let filteredPayments = [];
        let currentFilters = {
            searchText: '',
            dateFrom: '',
            dateTo: '',
            status: 'all',
            sortBy: 'date_desc'
        };

        /**
         * ÿ™ŸáŸäÿ¶ÿ© ÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™
         */
        window.initPaymentsPage = async function() {
            console.log('üîß ÿ™ŸáŸäÿ¶ÿ© ÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™...');
            await loadAllPayments();
            setupPaymentsEventListeners();
            applyPaymentsFilters();
            updatePaymentsStats();
        };

        /**
         * ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ŸÖŸÜ ÿßŸÑÿØŸäŸàŸÜ
         */
        async function loadAllPayments() {
            try {
                allPayments = [];
                
                // üî• ÿ•ÿµŸÑÿßÿ≠: ÿ™ÿ≠ÿØŸäÿ´ debtsData ÿ£ŸàŸÑÿßŸã
                if (window.dataSdk) {
                    const allData = await window.dataSdk.query();
                    if (allData.isOk) {
                        debtsData = allData.data.filter(item => item.type === 'debt');
                        console.log('‚úÖ Updated debtsData:', debtsData.length, 'debts');
                    }
                }
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿØŸäŸàŸÜ
                const debts = debtsData.length > 0 ? debtsData : (window.dataSdk ? window.dataSdk.query({ type: 'debt' }) : []);
                
                if (!debts || debts.length === 0) {
                    console.log('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿØŸäŸàŸÜ ŸÖÿ≠ŸÅŸàÿ∏ÿ©');
                    return;
                }
                
                console.log('=== Loading All Payments (FIXED) ===');
                console.log('Total debts:', debts.length);
                
                // üî• ÿ•ÿµŸÑÿßÿ≠: ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ÿßŸÑŸÅÿπŸÑŸäÿ© ŸÖŸÜ ÿ≥ÿ¨ŸÑ payments ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ¨ÿØŸàŸÑÿ©
                debts.forEach(debt => {
                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ≥ÿ¨ŸÑ ÿ™ÿ≥ÿØŸäÿØÿßÿ™
                    if (debt.payments && Array.isArray(debt.payments) && debt.payments.length > 0) {
                        console.log(`Processing debt ${debt.id} - ${debt.payments.length} payments found`);
                        
                        // ÿ•ÿ∂ÿßŸÅÿ© ŸÉŸÑ ÿ™ÿ≥ÿØŸäÿØ ŸÅÿπŸÑŸä
                        debt.payments.forEach((payment, index) => {
                            // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ
                            const relatedInstallment = debt.installments?.find(inst => inst.month === payment.month);
                            
                            allPayments.push({
                                id: `${debt.id}_payment_${index}`,
                                debt_id: debt.id,
                                customer_name: debt.customer_name,
                                customer_phone: debt.customer_phone,
                                month: payment.month,
                                amount: payment.amount,
                                original_amount: payment.original_amount || payment.amount,
                                total_paid_for_month: payment.total_paid_for_month || payment.amount,
                                remaining_for_month: payment.remaining_for_month || 0,
                                payment_type: payment.payment_type || 'full',
                                due_date: relatedInstallment?.due_date || payment.date,
                                paid_date: payment.date,
                                payment_date: payment.date, // ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ÿØŸäÿØ ÿßŸÑŸÅÿπŸÑŸä
                                status: 'paid', // ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ŸÅŸä payments ŸáŸä ÿ™ÿ≥ÿØŸäÿØÿßÿ™ ŸÖÿØŸÅŸàÿπÿ©
                                notes: payment.notes || '',
                                total_debt: debt.total_amount || debt.final_total,
                                monthly_amount: debt.monthly_amount,
                                installment_months: debt.installment_months,
                                installments: debt.installments
                            });
                        });
                    }
                    
                    // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ≥ÿØÿØÿ© ÿ£Ÿäÿ∂ÿßŸã ŸÑŸÑÿπÿ±ÿ∂ ÿßŸÑŸÉÿßŸÖŸÑ
                    if (debt.installments && Array.isArray(debt.installments)) {
                        debt.installments.forEach((installment, index) => {
                            if (installment.status !== 'paid' && installment.status !== 'partially_paid') {
                                allPayments.push({
                                    id: `${debt.id}_installment_${index}`,
                                    debt_id: debt.id,
                                    customer_name: debt.customer_name,
                                    customer_phone: debt.customer_phone,
                                    month: installment.month,
                                    amount: installment.amount,
                                    original_amount: installment.original_amount || installment.amount,
                                    due_date: installment.due_date,
                                    paid_date: null,
                                    payment_date: null,
                                    status: installment.status || 'pending',
                                    notes: installment.notes || '',
                                    total_debt: debt.total_amount || debt.final_total,
                                    monthly_amount: debt.monthly_amount,
                                    installment_months: debt.installment_months,
                                    installments: debt.installments
                                });
                            } else if (installment.status === 'partially_paid') {
                                // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑÿ¨ÿ≤ÿ¶Ÿäÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ŸÖŸÜŸáÿß
                                allPayments.push({
                                    id: `${debt.id}_partial_${index}`,
                                    debt_id: debt.id,
                                    customer_name: debt.customer_name,
                                    customer_phone: debt.customer_phone,
                                    month: installment.month,
                                    amount: installment.amount - (installment.paid_amount || 0), // ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä
                                    original_amount: installment.original_amount || installment.amount,
                                    paid_amount: installment.paid_amount || 0,
                                    due_date: installment.due_date,
                                    paid_date: installment.paid_date,
                                    payment_date: installment.paid_date,
                                    status: 'partially_paid',
                                    notes: `ÿ™ÿ≥ÿØŸäÿØ ÿ¨ÿ≤ÿ¶Ÿä - ÿßŸÑŸÖÿ™ÿ®ŸÇŸä: ${formatCurrency((installment.amount || 0) - (installment.paid_amount || 0))}`,
                                    total_debt: debt.total_amount || debt.final_total,
                                    monthly_amount: debt.monthly_amount,
                                    installment_months: debt.installment_months,
                                    installments: debt.installments
                                });
                            }
                        });
                    }
                });

                console.log(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ${allPayments.length} ÿ≥ÿ¨ŸÑ (ÿ™ÿ≥ÿØŸäÿØÿßÿ™ Ÿàÿ£ŸÇÿ≥ÿßÿ∑)`);
                console.log('All payments:', allPayments);
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        }

        /**
         * ÿ•ÿπÿØÿßÿØ ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´
         */
        function setupPaymentsEventListeners() {
            // ÿßŸÑÿ®ÿ≠ÿ´
            const searchInput = document.getElementById('paymentsSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    currentFilters.searchText = e.target.value;
                    applyPaymentsFilters();
                });
            }
        }

        /**
         * ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÅŸÑÿßÿ™ÿ±
         */
        window.applyPaymentsFilters = function() {
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÅŸÑÿßÿ™ÿ± ŸÖŸÜ ÿßŸÑÿ≠ŸÇŸàŸÑ
            const dateFrom = document.getElementById('paymentsDateFrom')?.value || '';
            const dateTo = document.getElementById('paymentsDateTo')?.value || '';
            const status = document.getElementById('paymentsStatusFilter')?.value || 'all';
            const sortBy = document.getElementById('paymentsSortFilter')?.value || 'date_desc';
            const monthFilter = document.getElementById('paymentsMonthFilter')?.value || 'all';
            
            currentFilters.dateFrom = dateFrom;
            currentFilters.dateTo = dateTo;
            currentFilters.status = status;
            currentFilters.sortBy = sortBy;
            currentFilters.monthFilter = monthFilter;

            filteredPayments = [...allPayments];
            
            console.log('=== Applying Filters (FIXED) ===');
            console.log('Total payments before filters:', filteredPayments.length);
            console.log('Filters:', currentFilters);

            // ŸÅŸÑÿ™ÿ± ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÜÿµŸä
            if (currentFilters.searchText) {
                const searchLower = currentFilters.searchText.toLowerCase();
                filteredPayments = filteredPayments.filter(payment => 
                    payment.customer_name.toLowerCase().includes(searchLower) ||
                    (payment.customer_phone && payment.customer_phone.includes(searchLower))
                );
                console.log('After search filter:', filteredPayments.length);
            }

            // ŸÅŸÑÿ™ÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸÖŸÜ
            if (currentFilters.dateFrom) {
                const fromDate = new Date(currentFilters.dateFrom);
                filteredPayments = filteredPayments.filter(payment => {
                    const paymentDate = payment.payment_date ? new Date(payment.payment_date) : new Date(payment.due_date);
                    return paymentDate >= fromDate;
                });
                console.log('After date from filter:', filteredPayments.length);
            }

            // ŸÅŸÑÿ™ÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿ•ŸÑŸâ
            if (currentFilters.dateTo) {
                const toDate = new Date(currentFilters.dateTo);
                filteredPayments = filteredPayments.filter(payment => {
                    const paymentDate = payment.payment_date ? new Date(payment.payment_date) : new Date(payment.due_date);
                    return paymentDate <= toDate;
                });
                console.log('After date to filter:', filteredPayments.length);
            }
            
            // üî• ŸÅŸÑÿ™ÿ± ÿßŸÑÿ¥Ÿáÿ± - ÿ¨ÿØŸäÿØ
            if (currentFilters.monthFilter && currentFilters.monthFilter !== 'all') {
                if (currentFilters.monthFilter === '13+') {
                    // ÿßŸÑÿ£ÿ¥Ÿáÿ± 13 ŸàŸÖÿß ŸÅŸàŸÇ
                    filteredPayments = filteredPayments.filter(payment => payment.month >= 13);
                } else {
                    // ÿ¥Ÿáÿ± ŸÖÿ≠ÿØÿØ
                    const monthNum = parseInt(currentFilters.monthFilter);
                    filteredPayments = filteredPayments.filter(payment => payment.month === monthNum);
                }
                console.log('After month filter:', filteredPayments.length);
            }

            // ŸÅŸÑÿ™ÿ± ÿßŸÑÿ≠ÿßŸÑÿ©
            if (currentFilters.status !== 'all') {
                console.log('Filtering by status:', currentFilters.status);
                
                if (currentFilters.status === 'overdue') {
                    // ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ™ÿ£ÿÆÿ±ÿ©: ÿ∫Ÿäÿ± ŸÖÿ≥ÿØÿØÿ© Ÿàÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ ŸÇÿØ ŸÖÿ∂Ÿâ
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    filteredPayments = filteredPayments.filter(payment => {
                        const dueDate = new Date(payment.due_date);
                        dueDate.setHours(0, 0, 0, 0);
                        return (payment.status === 'pending' || payment.status === 'partially_paid') && dueDate < today;
                    });
                } else if (currentFilters.status === 'upcoming') {
                    // ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÇÿßÿØŸÖÿ©: ÿ∫Ÿäÿ± ŸÖÿ≥ÿØÿØÿ© Ÿàÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ ŸÑŸÖ Ÿäÿ£ÿ™Ÿê ÿ®ÿπÿØ
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    filteredPayments = filteredPayments.filter(payment => {
                        const dueDate = new Date(payment.due_date);
                        dueDate.setHours(0, 0, 0, 0);
                        return (payment.status === 'pending' || payment.status === 'partially_paid') && dueDate >= today;
                    });
                } else {
                    // ŸÅŸÑÿ™ÿ±ÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿßŸÑÿ©
                    filteredPayments = filteredPayments.filter(payment => {
                        console.log(`  Payment month ${payment.month}: status = "${payment.status}"`);
                        return payment.status === currentFilters.status;
                    });
                }
                console.log('After status filter:', filteredPayments.length);
            }

            // ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®
            filteredPayments.sort((a, b) => {
                switch (currentFilters.sortBy) {
                    case 'date_desc':
                        const dateA = new Date(a.payment_date || a.due_date);
                        const dateB = new Date(b.payment_date || b.due_date);
                        return dateB - dateA;
                    case 'date_asc':
                        const dateA2 = new Date(a.payment_date || a.due_date);
                        const dateB2 = new Date(b.payment_date || b.due_date);
                        return dateA2 - dateB2;
                    case 'amount_desc':
                        return b.amount - a.amount;
                    case 'amount_asc':
                        return a.amount - b.amount;
                    case 'customer_asc':
                        return a.customer_name.localeCompare(b.customer_name, 'ar');
                    case 'customer_desc':
                        return b.customer_name.localeCompare(a.customer_name, 'ar');
                    default:
                        return 0;
                }
            });
            
            console.log('Final filtered count:', filteredPayments.length);
            console.log('=================================');

            renderPaymentsTable();
            updatePaymentsStats();
        };

        /**
         * ÿπÿ±ÿ∂ ÿ¨ÿØŸàŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™
         */
        function renderPaymentsTable() {
            const tbody = document.getElementById('paymentsTableBody');
            const noDataMessage = document.getElementById('noPaymentsMessage');
            
            if (!tbody) return;

            if (filteredPayments.length === 0) {
                tbody.innerHTML = '';
                if (noDataMessage) noDataMessage.style.display = 'block';
                return;
            }

            if (noDataMessage) noDataMessage.style.display = 'none';

            console.log('=== Rendering Payments Table (FIXED) ===');
            console.log('Filtered payments:', filteredPayments.length);

            tbody.innerHTML = filteredPayments.map(payment => {
                const statusInfo = getPaymentStatus(payment);
                
                // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸÜÿßÿ≥ÿ® ŸÑŸÑÿπÿ±ÿ∂ (ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ÿØŸäÿØ ÿ£Ÿà ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ)
                const displayDate = payment.payment_date ? new Date(payment.payment_date) : new Date(payment.due_date);
                const dueDayName = displayDate.toLocaleDateString('ar-IQ', { weekday: 'long' });
                const dueDateStr = displayDate.toLocaleDateString('ar-IQ', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const dueDateFull = `${dueDayName}<br>${dueDateStr}`;
                
                // ÿ™ŸÜÿ≥ŸäŸÇ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ÿØŸäÿØ ÿßŸÑŸÅÿπŸÑŸä
                let paidDateFull = '-';
                if (payment.paid_date || payment.payment_date) {
                    const paidDate = new Date(payment.paid_date || payment.payment_date);
                    const paidDayName = paidDate.toLocaleDateString('ar-IQ', { weekday: 'long' });
                    const paidDateStr = paidDate.toLocaleDateString('ar-IQ', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    paidDateFull = `${paidDayName}<br>${paidDateStr}`;
                }
                
                // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿ≥ÿØŸäÿØ ÿßŸÑÿ¨ÿ≤ÿ¶Ÿä
                let amountDisplay = `${payment.amount.toLocaleString('en')} ÿØŸäŸÜÿßÿ±`;
                if (payment.payment_type === 'partial' && payment.remaining_for_month > 0) {
                    amountDisplay += `<br><small style="color: var(--warning-color); font-size: 0.85rem;">ÿßŸÑŸÖÿ™ÿ®ŸÇŸä: ${payment.remaining_for_month.toLocaleString('en')} ÿØ</small>`;
                }

                return `
                    <tr style="${payment.payment_type === 'partial' ? 'background: rgba(251, 191, 36, 0.05);' : ''}">
                        <td><span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 16px; border-radius: 20px; font-weight: 700; font-size: 1rem;">ÿßŸÑÿ¥Ÿáÿ± ${payment.month}</span></td>
                        <td><strong style="font-size: 1rem;">${payment.customer_name}</strong></td>
                        <td style="direction: ltr; text-align: center;">${payment.customer_phone || '-'}</td>
                        <td style="text-align: center;"><strong style="color: var(--primary-color); font-size: 1.05rem;">${amountDisplay}</strong></td>
                        <td style="font-size: 0.9rem; line-height: 1.5;">${dueDateFull}</td>
                        <td style="font-size: 0.9rem; line-height: 1.5;">${paidDateFull}</td>
                        <td>
                            <span class="badge ${statusInfo.class}" style="padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 0.95rem;">
                                <i class="${statusInfo.icon}"></i> ${statusInfo.text}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons" style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                                <button class="btn-icon btn-info" onclick="viewPaymentDetailsFromPaymentsPage('${payment.debt_id}')" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ" style="width: 45px; height: 45px; border-radius: 12px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transition: all 0.3s;">
                                    <i class="fas fa-eye" style="font-size: 1.3rem;"></i>
                                </button>
                                ${payment.status === 'paid' ? `
                                    <button class="btn-icon btn-success" onclick="printPaymentReceiptFromPaymentsPage('${payment.debt_id}', ${payment.month})" title="ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ•ŸäÿµÿßŸÑ" style="width: 45px; height: 45px; border-radius: 12px; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3); transition: all 0.3s;">
                                        <i class="fas fa-print" style="font-size: 1.3rem;"></i>
                                    </button>
                                    <button class="btn-icon btn-warning" onclick="cancelInstallmentPaymentFromPaymentsPage('${payment.debt_id}', ${payment.month})" title="ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿ≥ÿØŸäÿØ" style="width: 45px; height: 45px; border-radius: 12px; box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3); transition: all 0.3s;">
                                        <i class="fas fa-undo-alt" style="font-size: 1.3rem;"></i>
                                    </button>
                                ` : payment.status === 'pending' || payment.status === 'partially_paid' ? `
                                    <button class="btn-icon btn-primary" onclick="payInstallmentFromPaymentsPage('${payment.debt_id}', ${payment.month})" title="ÿ™ÿ≥ÿØŸäÿØ ÿßŸÑŸÇÿ≥ÿ∑" style="width: 45px; height: 45px; border-radius: 12px; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); transition: all 0.3s;">
                                        <i class="fas fa-money-bill-wave" style="font-size: 1.3rem;"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            console.log('‚úÖ Table rendered with', filteredPayments.length, 'rows');
        }

        /**
         * ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÇÿ≥ÿ∑
         */
        function getPaymentStatus(payment) {
            if (payment.status === 'paid') {
                return {
                    text: 'ŸÖÿ≥ÿØÿØ',
                    class: 'badge-success',
                    icon: 'fas fa-check-circle'
                };
            }
            
            if (payment.status === 'partially_paid') {
                return {
                    text: 'ÿ™ÿ≥ÿØŸäÿØ ÿ¨ÿ≤ÿ¶Ÿä',
                    class: 'badge-warning',
                    icon: 'fas fa-exclamation-circle'
                };
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dueDate = new Date(payment.due_date);
            dueDate.setHours(0, 0, 0, 0);

            if (dueDate < today) {
                return {
                    text: 'ŸÖÿ™ÿ£ÿÆÿ±',
                    class: 'badge-danger',
                    icon: 'fas fa-exclamation-triangle'
                };
            } else if (dueDate.getTime() === today.getTime()) {
                return {
                    text: 'ŸÖÿ≥ÿ™ÿ≠ŸÇ ÿßŸÑŸäŸàŸÖ',
                    class: 'badge-warning',
                    icon: 'fas fa-calendar-day'
                };
            } else {
                const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                if (diffDays <= 7) {
                    return {
                        text: `ŸÇÿßÿØŸÖ (${diffDays} ÿ£ŸäÿßŸÖ)`,
                        class: 'badge-warning',
                        icon: 'fas fa-clock'
                    };
                } else {
                    return {
                        text: 'ŸÇÿßÿØŸÖ',
                        class: 'badge-info',
                        icon: 'fas fa-clock'
                    };
                }
            }
        }

        /**
         * ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
         */
        function updatePaymentsStats() {
            const stats = calculatePaymentsStats();

            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿØÿßÿØÿßÿ™
            document.getElementById('totalPaymentsCount').textContent = stats.total.toLocaleString('en');
            document.getElementById('paidPaymentsCount').textContent = stats.paid.toLocaleString('en');
            document.getElementById('overduePaymentsCount').textContent = stats.overdue.toLocaleString('en');
            document.getElementById('upcomingPaymentsCount').textContent = stats.upcoming.toLocaleString('en');
            document.getElementById('totalPaidAmount').textContent = stats.paidAmount.toLocaleString('en') + ' ÿØ';
            document.getElementById('totalRemainingAmount').textContent = stats.remainingAmount.toLocaleString('en') + ' ÿØ';
        }

        /**
         * ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
         */
        function calculatePaymentsStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let stats = {
                total: allPayments.length,
                paid: 0,
                pending: 0,
                overdue: 0,
                upcoming: 0,
                paidAmount: 0,
                remainingAmount: 0
            };

            allPayments.forEach(payment => {
                if (payment.status === 'paid') {
                    stats.paid++;
                    stats.paidAmount += payment.amount;
                } else {
                    stats.remainingAmount += payment.amount;
                    const dueDate = new Date(payment.due_date);
                    dueDate.setHours(0, 0, 0, 0);

                    if (dueDate < today) {
                        stats.overdue++;
                    } else {
                        stats.upcoming++;
                    }
                }
            });

            return stats;
        }

        /**
         * ŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿßŸÑÿ©
         */
        window.filterPaymentsByStatus = function(status) {
            const statusFilter = document.getElementById('paymentsStatusFilter');
            if (statusFilter) {
                statusFilter.value = status;
                applyPaymentsFilters();
            }
        };

        /**
         * ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÅŸÑÿßÿ™ÿ±
         */
        window.resetPaymentsFilters = function() {
            document.getElementById('paymentsSearchInput').value = '';
            document.getElementById('paymentsDateFrom').value = '';
            document.getElementById('paymentsDateTo').value = '';
            document.getElementById('paymentsStatusFilter').value = 'all';
            document.getElementById('paymentsSortFilter').value = 'date_desc';
            document.getElementById('paymentsMonthFilter').value = 'all';
            
            currentFilters = {
                searchText: '',
                dateFrom: '',
                dateTo: '',
                status: 'all',
                sortBy: 'date_desc',
                monthFilter: 'all'
            };
            
            applyPaymentsFilters();
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        };

        /**
         * ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ (ŸÑŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ≥ÿ±Ÿäÿπ)
         */
        window.filterPayments = function() {
            applyPaymentsFilters();
        };

        /**
         * ÿ™ÿ≠ÿØŸäÿ´ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™
         */
        window.refreshPaymentsPage = async function() {
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            await loadAllPayments();
            applyPaymentsFilters();
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        };

        /**
         * ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÇÿ≥ÿ∑
         */
        window.viewPaymentDetails = function(debtId) {
            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÜŸÅÿ≥ ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸäŸÜ
            if (typeof showDebtDetails === 'function') {
                showDebtDetails(debtId);
            } else {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        };

        /**
         * ÿ∑ÿ®ÿßÿπÿ© ÿ•ŸäÿµÿßŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØ
         */
        window.printPaymentReceipt = async function(debtId, month) {
            try {
                // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØŸäŸÜ
                const debt = window.dataSdk.getById(parseInt(debtId));
                if (!debt) {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    return;
                }

                // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑŸÖÿ≥ÿØÿØ
                const paidInstallment = debt.installments.find(inst => inst.month === month);
                if (!paidInstallment) {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    return;
                }

                // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ±
                const storeSettings = window.elementSdk.getConfig();

                // ÿ™ŸàŸÑŸäÿØ ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ•ŸäÿµÿßŸÑ
                const receiptHtml = generateInstallmentPaymentReceipt({
                    debt,
                    paidInstallment,
                    storeSettings
                });

                // ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ•ŸäÿµÿßŸÑ
                if (window.electronAPI && window.electronAPI.printInvoiceHtml) {
                    await window.electronAPI.printInvoiceHtml(receiptHtml, {
                        silent: true,
                        pageSize: { width: 80000, height: 297000 }
                    });
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                } else {
                    // ÿ∑ÿ®ÿßÿπÿ© ÿπÿ®ÿ± ÿßŸÑŸÖÿ™ÿµŸÅÿ≠
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(receiptHtml);
                    printWindow.document.close();
                    printWindow.print();
                }
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ•ŸäÿµÿßŸÑ:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        };

        /**
         * ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± Excel
         */
        window.exportPaymentsReport = function() {
            if (filteredPayments.length === 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }

            // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ CSV
            let csv = 'ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ,ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ,ÿ±ŸÇŸÖ ÿßŸÑŸÇÿ≥ÿ∑,ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ,ÿßŸÑŸÖÿ®ŸÑÿ∫,ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿØŸÅÿπ,ÿßŸÑÿ≠ÿßŸÑÿ©\n';
            
            filteredPayments.forEach(payment => {
                const status = getPaymentStatus(payment).text;
                const paidDate = payment.paid_date ? 
                    new Date(payment.paid_date).toLocaleDateString('en-GB') : '-';
                
                csv += `${payment.customer_name},`;
                csv += `${payment.customer_phone || '-'},`;
                csv += `ÿßŸÑÿ¥Ÿáÿ± ${payment.month},`;
                csv += `${new Date(payment.due_date).toLocaleDateString('en-GB')},`;
                csv += `${payment.amount},`;
                csv += `${paidDate},`;
                csv += `${status}\n`;
            });

            // ÿ™ŸÜÿ≤ŸäŸÑ ÿßŸÑŸÖŸÑŸÅ
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `ÿ™ŸÇÿ±Ÿäÿ±_ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        };

        /**
         * ÿ∑ÿ®ÿßÿπÿ© ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™
         */
        window.printPaymentsReport = function() {
            if (filteredPayments.length === 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }

            const stats = calculatePaymentsStats();
            const currentDate = new Date().toLocaleDateString('ar-IQ', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });

            let html = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Cairo', sans-serif; padding: 20px; background: white; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #667eea; padding-bottom: 20px; }
                        .header h1 { color: #667eea; font-size: 28px; margin-bottom: 10px; }
                        .header p { color: #666; font-size: 14px; }
                        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
                        .stat-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center; }
                        .stat-box .value { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
                        .stat-box .label { font-size: 14px; opacity: 0.9; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 12px; text-align: right; border: 1px solid #ddd; }
                        th { background: #667eea; color: white; font-weight: 600; }
                        tr:nth-child(even) { background: #f9f9f9; }
                        .badge { padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: 600; }
                        .badge-success { background: #10b981; color: white; }
                        .badge-danger { background: #ef4444; color: white; }
                        .badge-warning { background: #f59e0b; color: white; }
                        .badge-info { background: #06b6d4; color: white; }
                        @media print {
                            body { padding: 10px; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìä ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ŸàÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</h1>
                        <p>${currentDate}</p>
                    </div>

                    <div class="stats">
                        <div class="stat-box">
                            <div class="value">${stats.total}</div>
                            <div class="label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${stats.paid}</div>
                            <div class="label">ÿ£ŸÇÿ≥ÿßÿ∑ ŸÖÿ≥ÿØÿØÿ©</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${stats.overdue}</div>
                            <div class="label">ÿ£ŸÇÿ≥ÿßÿ∑ ŸÖÿ™ÿ£ÿÆÿ±ÿ©</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${stats.paidAmount.toLocaleString('en')} ÿØ</div>
                            <div class="label">ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿØÿØÿ©</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${stats.remainingAmount.toLocaleString('en')} ÿØ</div>
                            <div class="label">ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${stats.upcoming}</div>
                            <div class="label">ÿ£ŸÇÿ≥ÿßÿ∑ ŸÇÿßÿØŸÖÿ©</div>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>ÿßŸÑÿπŸÖŸäŸÑ</th>
                                <th>ÿßŸÑŸáÿßÿ™ŸÅ</th>
                                <th>ÿßŸÑŸÇÿ≥ÿ∑</th>
                                <th>ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ</th>
                                <th>ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
                                <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿØŸÅÿπ</th>
                                <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredPayments.map(payment => {
                                const statusInfo = getPaymentStatus(payment);
                                const paidDate = payment.paid_date ? 
                                    new Date(payment.paid_date).toLocaleDateString('ar-IQ', {
                                        year: 'numeric',
                                        month: 'short',
                                        day: 'numeric'
                                    }) : '-';
                                
                                return `
                                    <tr>
                                        <td><strong>${payment.customer_name}</strong></td>
                                        <td>${payment.customer_phone || '-'}</td>
                                        <td>ÿßŸÑÿ¥Ÿáÿ± ${payment.month}</td>
                                        <td>${new Date(payment.due_date).toLocaleDateString('ar-IQ', {
                                            year: 'numeric',
                                            month: 'short',
                                            day: 'numeric'
                                        })}</td>
                                        <td><strong>${payment.amount.toLocaleString('en')} ÿØ</strong></td>
                                        <td>${paidDate}</td>
                                        <td><span class="badge ${statusInfo.class}">${statusInfo.text}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>

                    <div style="margin-top: 30px; text-align: center; color: #666; font-size: 12px;">
                        <p>ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ŸÜÿ∏ÿßŸÖ ŸÜŸÇÿßÿ∑ ÿßŸÑÿ®Ÿäÿπ - ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿ•ÿ®ÿØÿßÿπ ÿßŸÑÿ±ŸÇŸÖŸä</p>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        };

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÜÿØ ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿ©
        const originalShowPage = window.showPage;
        window.showPage = function(page) {
            if (originalShowPage) {
                originalShowPage(page);
            }
            
            if (page === 'payments') {
                setTimeout(() => {
                    initPaymentsPage();
                }, 100);
            }
        };

        /**
         * ÿØŸàÿßŸÑ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ŸÖŸÜ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™
         */
        
        // ÿ™ÿ≥ÿØŸäÿØ ŸÇÿ≥ÿ∑ ŸÖŸÜ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™
        window.payInstallmentFromPaymentsPage = function(debtId, month) {
            if (typeof payInstallment === 'function') {
                payInstallment(parseInt(debtId), month);
            } else {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        };

        // ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸäŸÜ ŸÖŸÜ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™
        window.viewPaymentDetailsFromPaymentsPage = function(debtId) {
            if (typeof showDebtDetails === 'function') {
                showDebtDetails(parseInt(debtId));
            } else {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        };

        // ÿ∑ÿ®ÿßÿπÿ© ÿ•ŸäÿµÿßŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØ ŸÖŸÜ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™
        window.printPaymentReceiptFromPaymentsPage = async function(debtId, month) {
            try {
                const debt = window.dataSdk.getById(parseInt(debtId));
                if (!debt) {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    return;
                }

                const paidInstallment = debt.installments.find(inst => inst.month === month);
                if (!paidInstallment) {
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                    return;
                }

                const storeSettings = window.elementSdk.getConfig();
                const receiptHtml = generateInstallmentPaymentReceipt({
                    debt,
                    paidInstallment,
                    storeSettings
                });

                if (window.electronAPI && window.electronAPI.printInvoiceHtml) {
                    await window.electronAPI.printInvoiceHtml(receiptHtml, {
                        silent: true,
                        pageSize: { width: 80000, height: 297000 }
                    });
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                } else {
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(receiptHtml);
                    printWindow.document.close();
                    printWindow.print();
                }
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ•ŸäÿµÿßŸÑ:', error);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            }
        };

        // ÿ•ŸÑÿ∫ÿßÿ° ÿ™ÿ≥ÿØŸäÿØ ŸÇÿ≥ÿ∑ ŸÖŸÜ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™
        window.cancelInstallmentPaymentFromPaymentsPage = async function(debtId, month) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ŸÑÿ∫ÿßÿ° ÿ¢ÿÆÿ± ÿ™ÿ≥ÿØŸäÿØ ŸÑŸáÿ∞ÿß ÿßŸÑŸÇÿ≥ÿ∑ÿü\n\nŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿ≥Ÿäÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ¢ÿÆÿ± ÿπŸÖŸÑŸäÿ© ÿ™ÿ≥ÿØŸäÿØ ŸÅŸÇÿ∑.')) {
                return;
            }

            try {
                // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿØŸäŸÜ ŸÅŸä debtsData
                let debt = debtsData.find(d => 
                    d.id == debtId || 
                    d.__backendId == debtId || 
                    d.debt_id == debtId
                );
                
                // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã ŸÅŸä debtsDataÿå ÿ≠ÿßŸàŸÑ ŸÖŸÜ dataSdk
                if (!debt && window.dataSdk) {
                    debt = await window.dataSdk.getById(parseInt(debtId));
                }
                
                if (!debt) {
                    alert('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿØŸäŸÜ');
                    return;
                }

                const installmentIndex = debt.installments.findIndex(inst => inst.month === month);
                if (installmentIndex === -1) {
                    alert('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÇÿ≥ÿ∑');
                    return;
                }

                const installment = debt.installments[installmentIndex];
                if (installment.status !== 'paid' && installment.status !== 'partially_paid') {
                    alert('ÿßŸÑŸÇÿ≥ÿ∑ ÿ∫Ÿäÿ± ŸÖÿ≥ÿØÿØ ÿ£ÿµŸÑÿßŸã');
                    return;
                }

                // üî• ÿ•ÿµŸÑÿßÿ≠: ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ¢ÿÆÿ± ÿ™ÿ≥ÿØŸäÿØ ŸÑŸáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±
                let lastPaymentIndex = -1;
                let lastPayment = null;
                
                if (debt.payments && Array.isArray(debt.payments)) {
                    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ŸÑŸáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±
                    const monthPayments = debt.payments
                        .map((p, index) => ({ payment: p, index: index }))
                        .filter(item => item.payment.month === month);
                    
                    if (monthPayments.length > 0) {
                        // ÿ£ÿÆÿ∞ ÿ¢ÿÆÿ± ÿ™ÿ≥ÿØŸäÿØ (ÿßŸÑÿ£ÿ≠ÿØÿ´)
                        const lastItem = monthPayments[monthPayments.length - 1];
                        lastPaymentIndex = lastItem.index;
                        lastPayment = lastItem.payment;
                    }
                }
                
                if (!lastPayment) {
                    alert('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ≥ÿØŸäÿØ');
                    return;
                }
                
                const amountToCancel = lastPayment.amount || 0;
                
                // üî• ŸÖÿπÿßŸÑÿ¨ÿ© ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿ±ÿ≠ŸäŸÑ
                if (lastPayment.carried_forward && lastPayment.carried_forward_amount > 0) {
                    const carriedAmount = lastPayment.carried_forward_amount;
                    const carriedToMonth = lastPayment.carried_forward_to;
                    
                    console.log('üîÑ Reversing carryforward:', carriedAmount, 'from month', carriedToMonth);
                    
                    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ∞Ÿä ÿ™ŸÖ ÿßŸÑÿ™ÿ±ÿ≠ŸäŸÑ ÿ•ŸÑŸäŸá
                    const nextInstallment = debt.installments.find(inst => inst.month === carriedToMonth);
                    
                    if (nextInstallment) {
                        // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ±ÿ≠ŸÑ
                        nextInstallment.amount = parseFloat(nextInstallment.amount) - carriedAmount;
                        nextInstallment.carryforward_received = (nextInstallment.carryforward_received || 0) - carriedAmount;
                        
                        // ÿ•ÿ≤ÿßŸÑÿ© ŸÖŸÜ ÿ≥ÿ¨ŸÑ carryforward_from
                        if (nextInstallment.carryforward_from && Array.isArray(nextInstallment.carryforward_from)) {
                            nextInstallment.carryforward_from = nextInstallment.carryforward_from.filter(
                                cf => cf.from_month !== month
                            );
                            
                            // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäÿπÿØ ŸáŸÜÿßŸÉ ÿ£Ÿä ÿ™ÿ±ÿ≠ŸäŸÑÿßÿ™ÿå ÿßŸÖÿ≥ÿ≠ ÿßŸÑÿ≠ŸÇŸàŸÑ
                            if (nextInstallment.carryforward_from.length === 0) {
                                delete nextInstallment.carryforward_from;
                                delete nextInstallment.carryforward_received;
                            }
                        }
                        
                        console.log('   ‚úÖ Removed carryforward from month', carriedToMonth);
                        console.log('   New amount for month', carriedToMonth, ':', nextInstallment.amount);
                    }
                }

                // üî• ÿ•ÿµŸÑÿßÿ≠: ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ ŸÑŸÑŸÇÿ≥ÿ∑
                const newPaidAmount = (installment.paid_amount || 0) - amountToCancel;
                installment.paid_amount = newPaidAmount > 0 ? newPaidAmount : 0;
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÇÿ≥ÿ∑
                const originalAmount = installment.original_amount || installment.amount || 0;
                if (installment.paid_amount <= 0) {
                    installment.status = 'pending';
                    installment.paid_date = null;
                    installment.paid_amount = 0;
                } else if (installment.paid_amount >= originalAmount) {
                    installment.status = 'paid';
                } else {
                    installment.status = 'partially_paid';
                }
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ ŸàÿßŸÑŸÖÿ™ÿ®ŸÇŸä ŸÑŸÑÿØŸäŸÜ
                debt.paid_amount = Math.round((debt.paid_amount || 0) - amountToCancel);
                if (debt.paid_amount < 0) debt.paid_amount = 0;
                
                debt.remaining_amount = Math.round((debt.remaining_amount || 0) + amountToCancel);
                
                // üî• ÿ•ÿµŸÑÿßÿ≠: ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ≠ÿØÿØ ŸÅŸÇÿ∑ ŸÖŸÜ payments
                if (lastPaymentIndex !== -1) {
                    debt.payments.splice(lastPaymentIndex, 1);
                }

                // ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™
                if (window.dataSdk && debt.id) {
                    const result = await window.dataSdk.update(parseInt(debt.id), {
                        installments: debt.installments,
                        payments: debt.payments,
                        paid_amount: debt.paid_amount,
                        remaining_amount: debt.remaining_amount,
                        status: debt.remaining_amount > 0 ? 'ŸÜÿ¥ÿ∑' : 'ŸÖÿ≥ÿØÿØ'
                    });
                    
                    if (result.isOk) {
                        alert('ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ¢ÿÆÿ± ÿ™ÿ≥ÿØŸäÿØ ÿ®ŸÜÿ¨ÿßÿ≠');
                        // ÿ™ÿ≠ÿØŸäÿ´ debtsData
                        const allData = await window.dataSdk.query();
                        if (allData.isOk) {
                            debtsData = allData.data.filter(item => item.type === 'debt');
                        }
                        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ©
                        await refreshPaymentsPage();
                        if (typeof updateDebtsStats === 'function') {
                            updateDebtsStats();
                        }
                    } else {
                        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ŸÅÿ∏');
                    }
                } else {
                    // ÿ≠ŸÅÿ∏ ŸÖÿ≠ŸÑŸä ŸÅŸÇÿ∑
                    localStorage.setItem('debts', JSON.stringify(debtsData));
                    alert('ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ¢ÿÆÿ± ÿ™ÿ≥ÿØŸäÿØ ÿ®ŸÜÿ¨ÿßÿ≠');
                    await refreshPaymentsPage();
                    if (typeof updateDebtsStats === 'function') {
                        updateDebtsStats();
                    }
                }
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿ≥ÿØŸäÿØ:', error);
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿ≥ÿØŸäÿØ: ' + error.message);
            }
        };

        /**
         * ÿØŸàÿßŸÑ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ¥ÿßŸÖŸÑÿ©
         */

        // ÿ∑ÿ®ÿßÿπÿ© ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÖÿπŸäŸÜÿ© ŸÖÿπ ÿßŸÑÿ¨ÿØŸàŸÑ
        window.printSpecificPaymentsReport = function(filterType) {
            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÅŸÑÿ™ÿ± ÿßŸÑŸÖÿ∑ŸÑŸàÿ®
            const statusFilter = document.getElementById('paymentsStatusFilter');
            if (statusFilter) {
                statusFilter.value = filterType;
                applyPaymentsFilters();
            }

            // ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ŸÇŸÑŸäŸÑÿßŸã ŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÅŸÑÿ™ÿ± ÿ´ŸÖ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
            setTimeout(() => {
                printPaymentsReport();
            }, 300);
        };

        // ÿ∑ÿ®ÿßÿπÿ© ŸÇÿ≥ŸÖ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÖÿ≠ÿØÿØ ŸÅŸÇÿ∑
        window.printPaymentsStat = function(statType) {
            if (allPayments.length === 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }

            const stats = calculatePaymentsStats();
            const currentDate = new Date().toLocaleDateString('ar-IQ', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });

            let statTitle = '';
            let statValue = '';
            let statDescription = '';

            switch(statType) {
                case 'total':
                    statTitle = 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑';
                    statValue = stats.total;
                    statDescription = 'ÿßŸÑÿπÿØÿØ ÿßŸÑŸÉŸÑŸä ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ';
                    break;
                case 'paid':
                    statTitle = 'ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ≥ÿØÿØÿ©';
                    statValue = stats.paid;
                    statDescription = 'ÿπÿØÿØ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑÿ™Ÿä ÿ™ŸÖ ÿ™ÿ≥ÿØŸäÿØŸáÿß ÿ®ÿßŸÑŸÉÿßŸÖŸÑ';
                    break;
                case 'overdue':
                    statTitle = 'ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ™ÿ£ÿÆÿ±ÿ©';
                    statValue = stats.overdue;
                    statDescription = 'ÿπÿØÿØ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ™ÿ£ÿÆÿ±ÿ© ÿπŸÜ ŸÖŸàÿπÿØ ÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇŸáÿß';
                    break;
                case 'upcoming':
                    statTitle = 'ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÇÿßÿØŸÖÿ©';
                    statValue = stats.upcoming;
                    statDescription = 'ÿπÿØÿØ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÇÿßÿØŸÖÿ© ÿßŸÑÿ™Ÿä ŸÑŸÖ ÿ™ÿ≥ÿ™ÿ≠ŸÇ ÿ®ÿπÿØ';
                    break;
                case 'paidAmount':
                    statTitle = 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿØÿØÿ©';
                    statValue = stats.paidAmount.toLocaleString('en') + ' ÿØŸäŸÜÿßÿ±';
                    statDescription = 'ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿßŸÑŸäÿ© ÿßŸÑŸÖÿ≥ÿØÿØÿ©';
                    break;
                case 'remainingAmount':
                    statTitle = 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©';
                    statValue = stats.remainingAmount.toLocaleString('en') + ' ÿØŸäŸÜÿßÿ±';
                    statDescription = 'ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿßŸÑŸäÿ© ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©';
                    break;
            }

            const html = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>ÿ™ŸÇÿ±Ÿäÿ± ${statTitle}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            font-family: 'Cairo', sans-serif; 
                            padding: 40px; 
                            background: white; 
                            text-align: center;
                        }
                        .header { 
                            border-bottom: 4px solid #667eea; 
                            padding-bottom: 30px; 
                            margin-bottom: 50px; 
                        }
                        .header h1 { 
                            color: #667eea; 
                            font-size: 32px; 
                            margin-bottom: 15px; 
                        }
                        .header p { color: #666; font-size: 16px; }
                        .stat-container {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 60px;
                            border-radius: 20px;
                            margin: 30px auto;
                            max-width: 600px;
                            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                        }
                        .stat-value {
                            font-size: 72px;
                            font-weight: bold;
                            margin: 20px 0;
                        }
                        .stat-label {
                            font-size: 28px;
                            margin-bottom: 15px;
                            opacity: 0.95;
                        }
                        .stat-desc {
                            font-size: 18px;
                            opacity: 0.85;
                            margin-top: 20px;
                        }
                        .footer {
                            margin-top: 60px;
                            padding-top: 30px;
                            border-top: 2px solid #e0e0e0;
                            color: #666;
                            font-size: 14px;
                        }
                        @media print {
                            body { padding: 20px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìä ÿ™ŸÇÿ±Ÿäÿ± ${statTitle}</h1>
                        <p>${currentDate}</p>
                    </div>

                    <div class="stat-container">
                        <div class="stat-label">${statTitle}</div>
                        <div class="stat-value">${statValue}</div>
                        <div class="stat-desc">${statDescription}</div>
                    </div>

                    <div class="footer">
                        <p>ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ŸÜÿ∏ÿßŸÖ ŸÜŸÇÿßÿ∑ ÿßŸÑÿ®Ÿäÿπ</p>
                        <p>ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿ•ÿ®ÿØÿßÿπ ÿßŸÑÿ±ŸÇŸÖŸä ¬© 2025</p>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        };

        // ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿµŸÅÿ≠ÿ© ŸÉÿßŸÖŸÑÿ© (ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ + ÿßŸÑÿ¨ÿØŸàŸÑ)
        window.printCompletePaymentsReport = function() {
            if (allPayments.length === 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }

            const stats = calculatePaymentsStats();
            const currentDate = new Date().toLocaleDateString('ar-IQ', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });

            const html = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ÿßŸÑÿ¥ÿßŸÖŸÑ</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Cairo', sans-serif; padding: 20px; background: white; }
                        .header { 
                            text-align: center; 
                            margin-bottom: 30px; 
                            border-bottom: 3px solid #667eea; 
                            padding-bottom: 20px; 
                        }
                        .header h1 { color: #667eea; font-size: 32px; margin-bottom: 10px; }
                        .header p { color: #666; font-size: 16px; }
                        .stats { 
                            display: grid; 
                            grid-template-columns: repeat(3, 1fr); 
                            gap: 20px; 
                            margin-bottom: 30px; 
                        }
                        .stat-box { 
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                            color: white; 
                            padding: 25px; 
                            border-radius: 15px; 
                            text-align: center; 
                        }
                        .stat-box .value { font-size: 36px; font-weight: bold; margin-bottom: 10px; }
                        .stat-box .label { font-size: 18px; opacity: 0.95; }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-top: 30px; 
                        }
                        th, td { 
                            padding: 14px 8px; 
                            text-align: center; 
                            border: 1px solid #ddd; 
                            font-size: 14px;
                        }
                        th { 
                            background: #667eea; 
                            color: white; 
                            font-weight: 600; 
                        }
                        tr:nth-child(even) { background: #f9f9f9; }
                        .badge { 
                            padding: 6px 12px; 
                            border-radius: 15px; 
                            font-size: 13px; 
                            font-weight: 600; 
                            display: inline-block;
                        }
                        .badge-success { background: #10b981; color: white; }
                        .badge-danger { background: #ef4444; color: white; }
                        .badge-warning { background: #f59e0b; color: white; }
                        .badge-info { background: #06b6d4; color: white; }
                        .footer { 
                            margin-top: 40px; 
                            text-align: center; 
                            color: #666; 
                            font-size: 13px; 
                            padding-top: 20px;
                            border-top: 2px solid #e0e0e0;
                        }
                        @media print {
                            body { padding: 10px; }
                            .stat-box .value { font-size: 28px; }
                            .stat-box .label { font-size: 14px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìä ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™ ŸàÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑÿ¥ÿßŸÖŸÑ</h1>
                        <p>${currentDate}</p>
                    </div>

                    <div class="stats">
                        <div class="stat-box">
                            <div class="value">${stats.total}</div>
                            <div class="label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${stats.paid}</div>
                            <div class="label">ÿ£ŸÇÿ≥ÿßÿ∑ ŸÖÿ≥ÿØÿØÿ©</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${stats.overdue}</div>
                            <div class="label">ÿ£ŸÇÿ≥ÿßÿ∑ ŸÖÿ™ÿ£ÿÆÿ±ÿ©</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${stats.upcoming}</div>
                            <div class="label">ÿ£ŸÇÿ≥ÿßÿ∑ ŸÇÿßÿØŸÖÿ©</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${stats.paidAmount.toLocaleString('en')} ÿØ</div>
                            <div class="label">ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿØÿØÿ©</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${stats.remainingAmount.toLocaleString('en')} ÿØ</div>
                            <div class="label">ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©</div>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>ÿßŸÑÿπŸÖŸäŸÑ</th>
                                <th>ÿßŸÑŸáÿßÿ™ŸÅ</th>
                                <th>ÿßŸÑŸÇÿ≥ÿ∑</th>
                                <th>ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ</th>
                                <th>ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
                                <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ÿØŸäÿØ</th>
                                <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredPayments.map(payment => {
                                const statusInfo = getPaymentStatus(payment);
                                const dueDate = new Date(payment.due_date);
                                const dueDateStr = dueDate.toLocaleDateString('ar-IQ', {
                                    year: 'numeric',
                                    month: 'short',
                                    day: 'numeric'
                                });
                                const paidDate = payment.paid_date ? 
                                    new Date(payment.paid_date).toLocaleDateString('ar-IQ', {
                                        year: 'numeric',
                                        month: 'short',
                                        day: 'numeric'
                                    }) : '-';
                                
                                return `
                                    <tr>
                                        <td><strong>${payment.customer_name}</strong></td>
                                        <td>${payment.customer_phone || '-'}</td>
                                        <td>ÿßŸÑÿ¥Ÿáÿ± ${payment.month}</td>
                                        <td>${dueDateStr}</td>
                                        <td><strong>${payment.amount.toLocaleString('en')} ÿØ</strong></td>
                                        <td>${paidDate}</td>
                                        <td><span class="badge ${statusInfo.class}">${statusInfo.text}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>

                    <div class="footer">
                        <p>ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ŸÜÿ∏ÿßŸÖ ŸÜŸÇÿßÿ∑ ÿßŸÑÿ®Ÿäÿπ - ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿ•ÿ®ÿØÿßÿπ ÿßŸÑÿ±ŸÇŸÖŸä</p>
                        <p>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©: ${currentDate}</p>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        };

        /**
         * ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿµÿØŸäÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©
         */

        // ÿ™ÿµÿØŸäÿ± ŸÉŸÄ JSON
        window.exportPaymentsAsJSON = function() {
            if (allPayments.length === 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }

            const dataToExport = allPayments.map(payment => ({
                'ÿ±ŸÇŸÖ ÿßŸÑŸÇÿ≥ÿ∑': payment.month,
                'ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ': payment.customer_name,
                'ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ': payment.customer_phone || '-',
                'ÿßŸÑŸÖÿ®ŸÑÿ∫': payment.amount,
                'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ': payment.due_date,
                'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ÿØŸäÿØ': payment.paid_date || '-',
                'ÿßŸÑÿ≠ÿßŸÑÿ©': payment.status,
                'ŸÖÿπÿ±ŸÅ ÿßŸÑÿØŸäŸÜ': payment.debt_id
            }));

            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ÿ™ÿ≥ÿØŸäÿØÿßÿ™_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        };

        // ÿ™ÿµÿØŸäÿ± ŸÉŸÄ Excel (CSV)
        window.exportPaymentsAsExcel = function() {
            exportPaymentsReport(); // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
        };

        // ÿ™ÿµÿØŸäÿ± ŸÉŸÄ PDF
        window.exportPaymentsAsPDF = function() {
            if (allPayments.length === 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }

            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿØÿßŸÑÿ© ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ŸÑÿ•ŸÜÿ¥ÿßÿ° PDF
            printCompletePaymentsReport();
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        };

        /**
         * ÿØŸàÿßŸÑ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜÿ© - ŸÖÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÉÿßŸÖŸÑÿ©
         */

        // ÿ∑ÿ®ÿßÿπÿ© ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÖÿπŸäŸÜÿ© ŸÖÿπ ÿ¨ÿØŸàŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÅŸÑÿ™ÿ±ÿ©
        window.printPaymentsStat = function(statType) {
            if (allPayments.length === 0) {
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                return;
            }

            const stats = calculatePaymentsStats();
            const currentDate = new Date().toLocaleDateString('ar-IQ', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });

            let statTitle = '';
            let statValue = '';
            let statDescription = '';
            let dataToShow = [];

            // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜŸàÿπ
            switch(statType) {
                case 'total':
                    statTitle = 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑';
                    statValue = stats.total;
                    statDescription = 'ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ';
                    dataToShow = allPayments;
                    break;
                case 'paid':
                    statTitle = 'ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ≥ÿØÿØÿ©';
                    statValue = stats.paid;
                    statDescription = 'ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑÿ™Ÿä ÿ™ŸÖ ÿ™ÿ≥ÿØŸäÿØŸáÿß';
                    dataToShow = allPayments.filter(p => p.status === 'paid');
                    break;
                case 'overdue':
                    statTitle = 'ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ™ÿ£ÿÆÿ±ÿ©';
                    statValue = stats.overdue;
                    statDescription = 'ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÖÿ™ÿ£ÿÆÿ±ÿ© ÿπŸÜ ŸÖŸàÿπÿØŸáÿß';
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    dataToShow = allPayments.filter(p => {
                        const dueDate = new Date(p.due_date);
                        return p.status !== 'paid' && dueDate < today;
                    });
                    break;
                case 'upcoming':
                    statTitle = 'ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÇÿßÿØŸÖÿ©';
                    statValue = stats.upcoming;
                    statDescription = 'ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÇÿßÿØŸÖÿ©';
                    const todayUpcoming = new Date();
                    todayUpcoming.setHours(0, 0, 0, 0);
                    dataToShow = allPayments.filter(p => {
                        const dueDate = new Date(p.due_date);
                        return p.status !== 'paid' && dueDate >= todayUpcoming;
                    });
                    break;
                case 'paidAmount':
                    statTitle = 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿØÿØÿ©';
                    statValue = stats.paidAmount.toLocaleString('en') + ' ÿØŸäŸÜÿßÿ±';
                    statDescription = 'ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿØÿØÿ©';
                    dataToShow = allPayments.filter(p => p.status === 'paid');
                    break;
                case 'remainingAmount':
                    statTitle = 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©';
                    statValue = stats.remainingAmount.toLocaleString('en') + ' ÿØŸäŸÜÿßÿ±';
                    statDescription = 'ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©';
                    dataToShow = allPayments.filter(p => p.status !== 'paid');
                    break;
            }

            // ÿ•ŸÜÿ¥ÿßÿ° HTML ŸÑŸÑÿ∑ÿ®ÿßÿπÿ©
            const html = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>ÿ™ŸÇÿ±Ÿäÿ± ${statTitle}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            font-family: 'Cairo', sans-serif; 
                            padding: 30px; 
                            background: white; 
                        }
                        .header { 
                            text-align: center;
                            border-bottom: 4px solid #667eea; 
                            padding-bottom: 25px; 
                            margin-bottom: 40px; 
                        }
                        .header h1 { 
                            color: #667eea; 
                            font-size: 38px; 
                            margin-bottom: 12px;
                            font-weight: 900;
                        }
                        .header p { color: #666; font-size: 17px; }
                        .stat-container {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 50px;
                            border-radius: 20px;
                            margin: 25px auto 40px;
                            max-width: 700px;
                            box-shadow: 0 15px 50px rgba(0,0,0,0.25);
                            text-align: center;
                        }
                        .stat-value {
                            font-size: 80px;
                            font-weight: 900;
                            margin: 25px 0;
                            text-shadow: 0 4px 8px rgba(0,0,0,0.2);
                        }
                        .stat-label {
                            font-size: 32px;
                            margin-bottom: 18px;
                            opacity: 0.95;
                            font-weight: 700;
                        }
                        .stat-desc {
                            font-size: 20px;
                            opacity: 0.85;
                            margin-top: 25px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 30px;
                            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
                        }
                        th, td {
                            padding: 16px 12px;
                            text-align: center;
                            border: 1px solid #e0e0e0;
                            font-size: 15px;
                        }
                        th {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            font-weight: 700;
                            font-size: 16px;
                        }
                        tr:nth-child(even) { background: #f8f9fa; }
                        tr:hover { background: #e8f4fd; }
                        .badge {
                            padding: 6px 14px;
                            border-radius: 15px;
                            font-size: 14px;
                            font-weight: 700;
                            display: inline-block;
                        }
                        .badge-success { background: #10b981; color: white; }
                        .badge-danger { background: #ef4444; color: white; }
                        .badge-warning { background: #f59e0b; color: white; }
                        .badge-info { background: #06b6d4; color: white; }
                        .footer { 
                            margin-top: 50px; 
                            padding-top: 25px; 
                            border-top: 2px solid #e0e0e0; 
                            text-align: center;
                            color: #666; 
                            font-size: 15px; 
                        }
                        @media print {
                            body { padding: 15px; }
                            .stat-value { font-size: 65px; }
                            .stat-label { font-size: 26px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìä ${statTitle}</h1>
                        <p>${currentDate}</p>
                    </div>

                    <div class="stat-container">
                        <div class="stat-label">${statTitle}</div>
                        <div class="stat-value">${statValue}</div>
                        <div class="stat-desc">${statDescription}</div>
                    </div>

                    ${dataToShow.length > 0 ? `
                        <h2 style="color: #667eea; margin: 30px 0 20px; font-size: 28px; text-align: center;">ÿ™ŸÅÿßÿµŸäŸÑ ${statTitle}</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>ÿßŸÑŸÇÿ≥ÿ∑</th>
                                    <th>ÿßŸÑÿπŸÖŸäŸÑ</th>
                                    <th>ÿßŸÑŸáÿßÿ™ŸÅ</th>
                                    <th>ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
                                    <th>ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ</th>
                                    <th>ÿßŸÑÿ™ÿ≥ÿØŸäÿØ</th>
                                    <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${dataToShow.map(payment => {
                                    const statusInfo = getPaymentStatus(payment);
                                    const dueDate = new Date(payment.due_date);
                                    const dueDateStr = dueDate.toLocaleDateString('ar-IQ', {
                                        year: 'numeric',
                                        month: 'short',
                                        day: 'numeric'
                                    });
                                    const paidDate = payment.paid_date ? 
                                        new Date(payment.paid_date).toLocaleDateString('ar-IQ', {
                                            year: 'numeric',
                                            month: 'short',
                                            day: 'numeric'
                                        }) : '-';
                                    
                                    return `
                                        <tr>
                                            <td><strong>ÿßŸÑÿ¥Ÿáÿ± ${payment.month}</strong></td>
                                            <td><strong>${payment.customer_name}</strong></td>
                                            <td>${payment.customer_phone || '-'}</td>
                                            <td><strong>${payment.amount.toLocaleString('en')} ÿØ</strong></td>
                                            <td>${dueDateStr}</td>
                                            <td>${paidDate}</td>
                                            <td><span class="badge ${statusInfo.class}">${statusInfo.text}</span></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    ` : '<p style="text-align: center; color: #999; font-size: 18px; margin-top: 30px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑÿπÿ±ÿ∂Ÿáÿß</p>'}

                    <div class="footer">
                        <p style="font-weight: 700; margin-bottom: 8px;">ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ŸÜÿ∏ÿßŸÖ ŸÜŸÇÿßÿ∑ ÿßŸÑÿ®Ÿäÿπ</p>
                        <p>ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿ•ÿ®ÿØÿßÿπ ÿßŸÑÿ±ŸÇŸÖŸä ¬© 2025</p>
                        <p style="margin-top: 8px; font-size: 13px;">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©: ${currentDate}</p>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        };

        console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ÿ≥ÿØŸäÿØÿßÿ™');
    })();



    
    </script>
    

    
    <!-- ŸÇŸàÿßŸÑÿ® ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÖÿ≠ÿØÿ´ÿ© -->
    <script>
/**
 * ŸÇŸàÿßŸÑÿ® ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ© - ŸÖÿπÿ±ÿ∂ ŸäÿπŸÇŸàÿ® ŸÑŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ©
 * ŸÜÿ≥ÿÆÿ© ŸÖÿ≠ÿØÿ´ÿ© ÿ®ÿ™ÿµŸÖŸäŸÖ ŸÖÿ∂ÿ∫Ÿàÿ∑ Ÿàÿßÿ≠ÿ™ÿ±ÿßŸÅŸä
 */

(function() {
    'use strict';
    
    /**
     * ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ÿ•ŸÑŸâ ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©
     */
    function toEnglishDigits(str) {
        if (!str) return str;
        const arabicDigits = ['Ÿ†', 'Ÿ°', 'Ÿ¢', 'Ÿ£', 'Ÿ§', 'Ÿ•', 'Ÿ¶', 'Ÿß', 'Ÿ®', 'Ÿ©'];
        const englishDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
        
        let result = String(str);
        for (let i = 0; i < 10; i++) {
            result = result.replace(new RegExp(arabicDigits[i], 'g'), englishDigits[i]);
        }
        return result;
    }
    
    /**
     * ŸÇÿßŸÑÿ® ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ŸÑŸÑÿØŸÅÿπ ÿßŸÑŸÜŸÇÿØŸä - ÿ™ÿµŸÖŸäŸÖ ŸÖÿ≠ÿ≥ŸÜ
     */
    window.generateYaqoubCashReceipt = function(sale, settings) {
        // ÿØŸÖÿ¨ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÖÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖŸÖÿ±ÿ±ÿ©
        const savedSettings = JSON.parse(localStorage.getItem('printerSettings') || '{}');
        const finalSettings = { ...savedSettings, ...settings };
        
        // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ± ŸÖŸÜ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
        const storeName = finalSettings.store_name || 'ŸÖÿπÿ±ÿ∂ ŸäÿπŸÇŸàÿ® ŸÑŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ©';
        const storeAddress = finalSettings.store_address || 'ÿ®ÿßÿ® ÿßŸÑŸáÿßÿ¥ŸÖŸäÿ© ŸÇÿ±ÿ® ŸÖÿØÿ±ÿ≥ÿ© ÿßŸÑŸÉÿ±ÿßÿ±';
        const storePhone = finalSettings.store_phone || localStorage.getItem('storePhone') || '07803092185';
        const storeLogo = finalSettings.store_logo || 'yaqoub_logo.png';
        const showLogo = finalSettings.show_logo !== false;

        // ŸÇÿßŸÑÿ® A4 ÿØÿßÿ¶ŸÖŸãÿß
        let receiptWidth = '210mm';

        // ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™
        let saleDate = sale.date ? new Date(sale.date) : (sale.timestamp ? new Date(sale.timestamp) : new Date());
        if (typeof saleDate === 'string') saleDate = new Date(saleDate);
        const dateStr = saleDate.toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' });
        const timeStr = saleDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

        let html = `
        <div class="a4-sheet" style="
            width: ${receiptWidth};
            margin: 0 auto;
            padding: 32px 32px;
            font-family: 'Cairo', sans-serif;
            background: #fff;
            color: #222;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            line-height: 1.7;
            font-size: 18px;
            direction: rtl;
            text-align: right;
            position: relative;
        ">
        `;

        // ÿ±ÿ£ÿ≥ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
        html += `
        <div style="text-align: center; margin-bottom: 24px; direction: rtl;">
            <h1 style="margin: 0 0 8px 0; font-size: 2.5rem; font-weight: bold; color: #2d3748; letter-spacing: 2px;">${storeName}</h1>
            <div style="font-size: 1.2rem; color: #374151; margin-bottom: 4px;">${storeAddress}</div>
            <div style="font-size: 1.1rem; color: #6366f1;">üìû ${storePhone}</div>
            ${showLogo ? `<div style="width:100%;text-align:center;margin:12px 0 0 0;">
            <img src="${logoBase64}" alt="Logo" style="max-width:120px;max-height:120px;display:inline-block;vertical-align:middle;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:8px;" onerror="this.style.display='none'" />
            </div>` : ''}
        </div>
        <div style="border-top: 2px solid #6366f1; margin: 24px 0 16px 0;"></div>
        `;

        // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
        html += `
        <div style="display: flex; justify-content: flex-start; gap: 48px; margin-bottom: 18px; font-size: 1.1rem; direction: ltr;">
            <div><b>Invoice No.:</b> ${toEnglishDigits(sale.invoice_id)}</div>
            <div><b>Date:</b> ${toEnglishDigits(dateStr)}</div>
            <div><b>Time:</b> ${toEnglishDigits(timeStr)}</div>
        </div>
        <div style="border-top: 1px dashed #bbb; margin: 18px 0 18px 0;"></div>
        `;

        // ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
        let items = sale.items;
        if (typeof items === 'string') {
            try {
                items = JSON.parse(items);
            } catch {
                items = [];
            }
        }
        if (items && items.length > 0) {
            html += `
            <table style="width: 100%; border-collapse: collapse; font-size: 1.1rem; margin: 18px 0; background: #f9fafb; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.03); direction: ltr;">
            <thead>
                <tr style="background: #6366f1; color: #fff;">
                <th style="padding: 12px 0;">#</th>
                <th style="padding: 12px 0;">Product Name</th>
                <th style="padding: 12px 0;">Qty</th>
                <th style="padding: 12px 0;">Unit Price</th>
                <th style="padding: 12px 0;">Total</th>
                </tr>
            </thead>
            <tbody>
        `;
            items.forEach((item, index) => {
                const name = item.product_name || item.name || '‚Äî';
                const price = item.product_price || item.price || 0;
                html += `
            <tr style="background: ${index % 2 === 0 ? '#fff' : '#f3f4f6'}; text-align: center; direction: ltr;">
                <td style="padding: 10px 0;">${toEnglishDigits(index + 1)}</td>
                <td style="padding: 10px 0; text-align: left;">${name}</td>
                <td style="padding: 10px 0;">${toEnglishDigits(item.quantity)}</td>
                <td style="padding: 10px 0;">${toEnglishDigits(price.toLocaleString('en'))}</td>
                <td style="padding: 10px 0; font-weight: bold; color: #10b981;">${toEnglishDigits((price * item.quantity).toLocaleString('en'))}</td>
            </tr>
            `;
            });
            html += `</tbody></table>`;
        }

        html += `<div style="border-top: 2px solid #6366f1; margin: 24px 0 16px 0;"></div>`;

        // ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸÖÿπ ÿßŸÑÿÆÿµŸÖ ÿßŸÑÿ•ÿ∂ÿßŸÅŸä
        const additionalDiscount = sale.additional_discount || 0;
        const totalDiscount = (sale.discount || 0) + additionalDiscount;
        
        html += `
        <div style="font-size: 1.3rem; font-weight: bold; margin: 32px 0 12px 0; text-align: right; direction: rtl;">
            <div style="display: flex; justify-content: flex-start; gap: 48px; margin-bottom: 10px;">
            <div><span style="color:#374151;">ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿ¨ÿ≤ÿ¶Ÿä:</span> <span>${toEnglishDigits((sale.total_amount || 0).toLocaleString('en'))}</span></div>
            ${sale.discount ? `<div><span style="color:#374151;">ÿßŸÑÿÆÿµŸÖ:</span> <span style="color: #10b981;">- ${toEnglishDigits(sale.discount.toLocaleString('en'))}</span></div>` : ''}
            ${additionalDiscount > 0 ? `<div><span style="color:#374151;">ÿÆÿµŸÖ ÿ•ÿ∂ÿßŸÅŸä:</span> <span style="color: #10b981;">- ${toEnglishDigits(additionalDiscount.toLocaleString('en'))}</span></div>` : ''}
            </div>
            ${totalDiscount > 0 ? `<div style="display: flex; justify-content: flex-start; gap: 48px; margin-bottom: 10px; padding: 8px; background: #f0fdf4; border-radius: 6px;">
                <div><span style="color:#15803d;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿÆÿµŸÖ:</span> <span style="color: #15803d; font-weight: bold;">- ${toEnglishDigits(totalDiscount.toLocaleString('en'))}</span></div>
            </div>` : ''}
            <div style="display: flex; justify-content: flex-start; gap: 48px; border-top: 2px solid #6366f1; padding-top: 12px; margin-top: 8px;">
            <div><span style="color:#2d3748;">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä:</span> <span style="color:#e11d48; font-size:1.5rem;">${toEnglishDigits((sale.final_total || sale.total_amount || 0).toLocaleString('en'))}</span></div>
            </div>
        </div>
        `;

        // ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ŸÖŸÜ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
        const notes = [];
        if (finalSettings.note1) notes.push(finalSettings.note1);
        if (finalSettings.note2) notes.push(finalSettings.note2);
        if (finalSettings.note3) notes.push(finalSettings.note3);
        if (finalSettings.note4) notes.push(finalSettings.note4);
        if (finalSettings.note5) notes.push(finalSettings.note5);
        if (finalSettings.note6) notes.push(finalSettings.note6);
        
        // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©
        if (finalSettings.show_maintenance !== false) {
            const maintenanceName = finalSettings.maintenance_name || 'ÿ≠ŸÖÿ≤Ÿá ÿ£ÿ®Ÿà ÿ≠Ÿàÿ±ÿßÿ°';
            const maintenanceService = finalSettings.maintenance_service || 'ÿµŸäÿßŸÜÿ© ÿßŸÑÿ≥ÿ®ÿßŸÑÿ™';
            const maintenancePhone = finalSettings.maintenance_phone || '+964 785 570 6118';
            notes.push(`ŸÖÿ≥ÿ§ŸàŸÑ ${maintenanceService}: ${maintenanceName} - Ÿáÿßÿ™ŸÅ: <span dir="ltr" style="unicode-bidi: embed;">${maintenancePhone}</span> <img src="https://upload.wikimedia.org/wikipedia/commons/2/2f/Flag_of_Iraq.svg" alt="Iraq Flag" style="height: 1em; vertical-align: middle; margin-right: 4px;" />`);
        }
        
        if (notes.length > 0) {
            html += `
            <div style="margin-top:28px; padding:16px 12px; background:#fffbe7; border-radius:8px; border:1px solid #ffe082;">
                <div style="font-size:1.05rem; font-weight:bold; color:#c62828; margin-bottom:6px; text-align:right; direction:rtl;">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ŸáÿßŸÖÿ©:</div>
                <ol style="font-size:1rem; padding-right:22px; margin:0; text-align:right; direction:rtl;">
                ${notes.map(n => `<li>${toEnglishDigits(n)}</li>`).join('')}
                </ol>
            </div>
            `;
        }

        // ÿßŸÑÿ™ÿ∞ŸäŸäŸÑ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
        html += `<div style="text-align: center; margin-top: 40px; font-size: 1.1rem; color: #666; direction: rtl;">
        <p style="margin: 4px 0;">ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ™ÿπÿßŸÖŸÑŸÉŸÖ ŸÖÿπ ${storeName}</p>
        <p style="margin: 4px 0;">ŸÜÿ™ÿ∑ŸÑÿπ ŸÑÿÆÿØŸÖÿ™ŸÉŸÖ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ</p>
        <p style="margin-top: 18px; color: #6366f1; font-size: 1.2rem;">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</p>
        </div>`;
        html += `</div>`;
        return html;
    };
    
    /**
     * ŸÇÿßŸÑÿ® ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ŸÑŸÑÿ™ŸÇÿ≥Ÿäÿ∑ - ÿ™ÿµŸÖŸäŸÖ ŸÖÿ∂ÿ∫Ÿàÿ∑ ŸÖÿ≠ÿ≥ŸÜ
     */
    window.generateYaqoubInstallmentReceipt = function(sale, settings) {
        // ÿØŸÖÿ¨ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÖÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖŸÖÿ±ÿ±ÿ©
        const savedSettings = JSON.parse(localStorage.getItem('printerSettings') || '{}');
        const finalSettings = { ...savedSettings, ...settings };
        
        // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑÿ≥ÿßÿπÿ©
        const saleDate = new Date(sale.timestamp || sale.created_at || Date.now());
        const dateStr = saleDate.toLocaleDateString('ar-IQ', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            weekday: 'long'
        });
        const timeStr = saleDate.toLocaleTimeString('ar-IQ', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true
        });
        
        // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ŸÖŸÜ installment_details ÿ£Ÿà ŸÖŸÜ ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
        const installmentDetails = sale.installment_details || {};
        const originalSubtotal = installmentDetails.original_subtotal || sale.subtotal || 0;
        const additionalAmount = installmentDetails.additional_amount || sale.additional_amount || 0;
        const downPayment = installmentDetails.down_payment || sale.down_payment || 0;
        const totalBeforeDiscount = originalSubtotal + additionalAmount;
        
        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä
        let finalTotal = originalSubtotal; // ÿßŸÑÿ®ÿØÿßŸäÿ© ŸÖŸÜ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä
        if (additionalAmount > 0) finalTotal += additionalAmount; // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ∂ÿßŸÅŸä
        if (downPayment > 0) finalTotal -= downPayment; // ÿÆÿµŸÖ ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑŸÖŸÇÿØŸÖÿ©
        
        const remainingAmount = installmentDetails.remaining_amount || sale.remaining_amount || (totalBeforeDiscount - downPayment);
        const monthlyAmount = installmentDetails.monthly_amount || sale.monthly_amount || 0;
        const installmentMonths = installmentDetails.installment_months || sale.installment_months || 0;
        const startDate = installmentDetails.start_date || sale.start_date || null;
        const advancedControlUsed = installmentDetails.advanced_control_used || installmentDetails.custom_values_used || false;
        
        // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿ± ŸÖŸÜ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
        const storeName = finalSettings.store_name || 'ŸäÿπŸÇŸàÿ® ŸÑŸÑÿßÿ¨Ÿáÿ≤Ÿá ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ¶ŸäŸá';
        const storeAddress = finalSettings.store_address || 'ÿ®ÿßÿ® ÿßŸÑŸáÿßÿ¥ŸÖŸäŸá ŸÇÿ±ÿ® ŸÖÿØÿ±ÿ≥Ÿá ÿßŸÑŸÉÿ±ÿßÿ±';
        const storePhone = finalSettings.store_phone || '07803092185';
        
        let html = `<div style="width:210mm;min-height:297mm;margin:0 auto;padding:12mm 10mm;font-family:'Cairo',sans-serif;background:#fff;color:#222;line-height:1.4;font-size:11px;box-sizing:border-box;">
        
        <!-- ÿßŸÑŸáŸäÿØÿ± ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜ -->
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;padding-bottom:6px;border-bottom:2px solid #6366f1;">
            <!-- ÿßŸÑŸäÿ≥ÿßÿ±: ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ -->
            <div style="flex:0 0 35%;">
                <h1 style="margin:0;font-size:1.3rem;font-weight:bold;color:#2d3748;">${storeName}</h1>
            </div>
            <!-- ÿßŸÑŸäŸÖŸäŸÜ: ÿßŸÑÿπŸÜŸàÿßŸÜ ŸàÿßŸÑŸáÿßÿ™ŸÅ -->
            <div style="flex:0 0 60%;text-align:left;">
                <div style="font-size:0.95rem;color:#374151;font-weight:600;margin-bottom:2px;">${storeAddress}</div>
                <div style="font-size:0.9rem;color:#6366f1;font-weight:600;">üìû ${storePhone}</div>
            </div>
        </div>
        
        <!-- ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸàŸÖÿπŸÑŸàŸÖÿßÿ™Ÿáÿß -->
        <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:6px;padding:6px 10px;margin-bottom:8px;color:#fff;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div style="font-size:1.05rem;font-weight:bold;">üìã ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ™ŸÇÿ≥Ÿäÿ∑</div>
                    <div style="font-size:0.85rem;opacity:0.95;">ÿ±ŸÇŸÖ: ${sale.invoice_id || ''}</div>
                </div>
                <div style="text-align:left;font-size:0.85rem;">
                    <div>üìÖ ${dateStr}</div>
                    <div>üïê ${timeStr}</div>
                </div>
            </div>
        </div>
        
        <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ - ÿµŸÅ Ÿàÿßÿ≠ÿØ -->
        <div style="background:#f8fafc;border-radius:6px;padding:6px 8px;margin-bottom:8px;border:1px solid #e2e8f0;">
            <div style="font-weight:bold;color:#1e293b;margin-bottom:4px;font-size:0.95rem;">üë§ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:0.9rem;">
                <div><strong>ÿßŸÑÿßÿ≥ŸÖ:</strong> ${sale.customer_name || ''}</div>
                <div><strong>ÿßŸÑŸáÿßÿ™ŸÅ:</strong> ${sale.customer_phone || ''}</div>
                <div><strong>ÿßŸÑÿπŸÜŸàÿßŸÜ:</strong> ${sale.customer_address || ''}</div>
            </div>
        </div>
        
        <!-- ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ - ŸÖÿ∂ÿ∫Ÿàÿ∑ -->
        <div style="background:#f0f9ff;border-radius:6px;padding:6px 8px;margin-bottom:8px;border:1px solid #bae6fd;">
            <div style="font-weight:bold;color:#0c4a6e;margin-bottom:4px;font-size:0.95rem;">üí≥ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;font-size:0.85rem;">
                <div style="background:#dbeafe;padding:4px;border-radius:4px;text-align:center;">
                    <div style="font-weight:600;color:#1e40af;font-size:0.8rem;">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä</div>
                    <div style="font-weight:bold;color:#1e3a8a;">${originalSubtotal.toLocaleString()}</div>
                </div>
                ${additionalAmount > 0 ? `<div style="background:#fce7f3;padding:4px;border-radius:4px;text-align:center;">
                    <div style="font-weight:600;color:#9f1239;font-size:0.8rem;">ŸÖÿ®ŸÑÿ∫ ÿ•ÿ∂ÿßŸÅŸä</div>
                    <div style="font-weight:bold;color:#be123c;">${additionalAmount.toLocaleString()}</div>
                </div>` : ''}
                ${downPayment > 0 ? `<div style="background:#d1fae5;padding:4px;border-radius:4px;text-align:center;">
                    <div style="font-weight:600;color:#065f46;font-size:0.8rem;">ÿØŸÅÿπÿ© ŸÖŸÇÿØŸÖÿ©</div>
                    <div style="font-weight:bold;color:#047857;">${downPayment.toLocaleString()}</div>
                </div>` : ''}
                <div style="background:#fee2e2;padding:4px;border-radius:4px;text-align:center;">
                    <div style="font-weight:600;color:#7f1d1d;font-size:0.8rem;">ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</div>
                    <div style="font-weight:bold;color:#991b1b;">${remainingAmount.toLocaleString()}</div>
                </div>
                <div style="background:#fef3c7;padding:4px;border-radius:4px;text-align:center;">
                    <div style="font-weight:600;color:#78350f;font-size:0.8rem;">ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ±</div>
                    <div style="font-weight:bold;color:#92400e;">${installmentMonths}</div>
                </div>
                <div style="background:#ffedd5;padding:4px;border-radius:4px;text-align:center;">
                    <div style="font-weight:600;color:#7c2d12;font-size:0.8rem;">ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ¥Ÿáÿ±Ÿä</div>
                    <div style="font-weight:bold;color:#9a3412;">${monthlyAmount.toLocaleString()}</div>
                </div>
                ${startDate ? `<div style="background:#e0e7ff;padding:4px;border-radius:4px;text-align:center;">
                    <div style="font-weight:600;color:#3730a3;font-size:0.8rem;">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ©</div>
                    <div style="font-weight:bold;color:#4338ca;font-size:0.8rem;">${new Date(startDate).toLocaleDateString('en-GB')}</div>
                </div>` : ''}
                ${advancedControlUsed ? `<div style="background:#ede9fe;padding:4px;border-radius:4px;text-align:center;grid-column:1/-1;">
                    <div style="font-weight:600;color:#5b21b6;font-size:0.8rem;">‚öôÔ∏è ÿ™ÿ≠ŸÉŸÖ ŸÖÿ™ŸÇÿØŸÖ</div>
                </div>` : ''}
            </div>
        </div>
        
        <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ - ŸÖÿ∂ÿ∫Ÿàÿ∑ -->
        <div style="margin-bottom:8px;">
            <table style="width:100%;border-collapse:collapse;font-size:0.9rem;border:1px solid #e5e7eb;">
            <thead>
                <tr style="background:#6366f1;color:#fff;">
                    <th style="padding:4px 6px;width:6%;text-align:center;border:1px solid rgba(255,255,255,0.2);">#</th>
                    <th style="padding:4px 6px;width:44%;text-align:right;border:1px solid rgba(255,255,255,0.2);">ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
                    <th style="padding:4px 6px;width:12%;text-align:center;border:1px solid rgba(255,255,255,0.2);">ÿßŸÑŸÉŸÖŸäÿ©</th>
                    <th style="padding:4px 6px;width:18%;text-align:center;border:1px solid rgba(255,255,255,0.2);">ÿßŸÑÿ≥ÿπÿ±</th>
                    <th style="padding:4px 6px;width:20%;text-align:center;border:1px solid rgba(255,255,255,0.2);">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</th>
                </tr>
            </thead>
            <tbody>`;
        
        let items = sale.items;
        if (typeof items === 'string') {
            try { items = JSON.parse(items); } catch { items = []; }
        }
        
        items.forEach((item, index) => {
            const name = item.product_name || item.name || '‚Äî';
            const price = item.product_price || item.price || 0;
            const qty = item.quantity || 1;
            const total = price * qty;
            html += `<tr style="background:${index%2===0?'#fff':'#f9fafb'};">
                <td style="padding:4px 6px;text-align:center;border:1px solid #e5e7eb;font-weight:600;">${index+1}</td>
                <td style="padding:4px 6px;text-align:right;border:1px solid #e5e7eb;">${name}</td>
                <td style="padding:4px 6px;text-align:center;border:1px solid #e5e7eb;font-weight:600;">${qty}</td>
                <td style="padding:4px 6px;text-align:center;border:1px solid #e5e7eb;font-weight:600;">${price.toLocaleString()}</td>
                <td style="padding:4px 6px;text-align:center;border:1px solid #e5e7eb;font-weight:bold;color:#10b981;">${total.toLocaleString()}</td>
            </tr>`;
        });
        
        html += `</tbody></table></div>
        
        <!-- ŸÖŸÑÿÆÿµ ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ - ŸÖÿ∂ÿ∫Ÿàÿ∑ -->
        <div style="background:#fef3c7;border-radius:6px;padding:6px 8px;margin-bottom:8px;border:1px solid #fde68a;">
            <div style="font-weight:bold;color:#78350f;margin-bottom:4px;font-size:0.95rem;">üí∞ ŸÖŸÑÿÆÿµ ÿßŸÑŸÖÿ®ÿßŸÑÿ∫</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:0.9rem;">
                <div style="display:flex;justify-content:space-between;padding:3px 6px;background:#e0f2fe;border-radius:4px;">
                    <span>ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿ¨ÿ≤ÿ¶Ÿä:</span>
                    <strong>${originalSubtotal.toLocaleString()}</strong>
                </div>
                ${additionalAmount > 0 ? `<div style="display:flex;justify-content:space-between;padding:3px 6px;background:#fce7f3;border-radius:4px;">
                    <span>ŸÖÿ®ŸÑÿ∫ ÿ•ÿ∂ÿßŸÅŸä:</span>
                    <strong style="color:#be123c;">+${additionalAmount.toLocaleString()}</strong>
                </div>` : ''}
                ${downPayment > 0 ? `<div style="display:flex;justify-content:space-between;padding:3px 6px;background:#d1fae5;border-radius:4px;">
                    <span>ÿØŸÅÿπÿ© ŸÖŸÇÿØŸÖÿ©:</span>
                    <strong style="color:#047857;">-${downPayment.toLocaleString()}</strong>
                </div>` : ''}
                <div style="grid-column:1/-1;display:flex;justify-content:space-between;padding:6px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:4px;color:#fff;">
                    <span style="font-size:1rem;font-weight:bold;">üíµ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä:</span>
                    <strong style="font-size:1.1rem;">${finalTotal.toLocaleString()} ÿØŸäŸÜÿßÿ±</strong>
                </div>
            </div>
        </div>
        
        <!-- ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ŸÖÿ∂ÿ∫Ÿàÿ∑ÿ© -->
        <div style="background:#fffbeb;border-radius:6px;padding:6px 8px;margin-bottom:8px;border:1px solid #fbbf24;">
            <div style="font-weight:bold;color:#b91c1c;margin-bottom:4px;font-size:0.9rem;">‚ö†Ô∏è ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ŸáÿßŸÖÿ©</div>
            <ol style="font-size:0.8rem;padding-right:18px;margin:0;line-height:1.5;">`;
        
        // ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ŸÖŸÜ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
        const notes = [];
        if (finalSettings.note1) notes.push(finalSettings.note1);
        if (finalSettings.note2) notes.push(finalSettings.note2);
        if (finalSettings.note3) notes.push(finalSettings.note3);
        if (finalSettings.note4) notes.push(finalSettings.note4);
        if (finalSettings.note5) notes.push(finalSettings.note5);
        if (finalSettings.note6) notes.push(finalSettings.note6);
        
        // ŸÇŸäŸÖ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™
        if (notes.length === 0) {
            notes.push('ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖŸàÿ¨ŸàÿØ ŸáŸà ŸàÿµŸÑ ÿ£ŸÖÿßŸÜÿ©');
            notes.push('ÿßŸÑÿ≥ÿπÿ± ŸÖÿ≠ŸÖŸä 24 ÿ≥ÿßÿπÿ©');
            notes.push('ÿßŸÑŸÖÿ®ÿßÿπ ŸÑÿß Ÿäÿ±ÿ¨ÿπ ŸàŸÑÿß Ÿäÿ®ÿØŸÑ');
            notes.push('ÿßŸÑÿÆÿ∑ÿ£ ŸàÿßŸÑÿ≥ŸáŸà ŸÖÿ±ÿ¨Ÿàÿπ ŸÑŸÑÿ∑ÿ±ŸÅŸäŸÜ');
            notes.push('ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿßŸÑŸÖÿµŸÜÿπÿ© ŸÖÿ≥ÿ§ŸàŸÑÿ© ÿπŸÜ ÿßŸÑÿ∂ŸÖÿßŸÜ');
            notes.push('ŸÉÿ≥ÿ± ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿ∫Ÿäÿ± ÿØÿßÿÆŸÑ ÿ®ÿßŸÑÿ∂ŸÖÿßŸÜ');
        }
        
        notes.forEach(note => {
            html += `<li>${note}</li>`;
        });
        
        // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©
        if (finalSettings.show_maintenance !== false) {
            const maintenanceName = finalSettings.maintenance_name || 'ÿ≠ŸÖÿ≤Ÿá ÿßÿ®Ÿà ÿ≠Ÿàÿ±ÿßÿ°';
            const maintenanceService = finalSettings.maintenance_service || 'ÿµŸäÿßŸÜÿ© ÿßŸÑÿ≥ÿ®ÿßŸÑÿ™';
            const maintenancePhone = finalSettings.maintenance_phone || '+964 785 570 6118';
            
            html += `<li style="margin-top:4px;">
                    <div style="background:#e0f2fe;padding:4px 6px;border-radius:4px;border:1px solid #bae6fd;">
                        <strong style="color:#0c4a6e;">üë®‚Äçüîß ${maintenanceService}:</strong> ${maintenanceName}
                        <div style="direction:ltr;text-align:left;font-weight:bold;color:#0c4a6e;margin-top:2px;">
                            üì± <span style="letter-spacing:1px;">${maintenancePhone}</span>
                        </div>
                    </div>
                </li>`;
        }
        
        html += `</ol>
        </div>
        
        <!-- ÿßŸÑÿ™ŸàŸÇŸäÿπÿßÿ™ -->
        <div style="display:flex;justify-content:space-between;gap:30px;margin-top:10px;">
            <div style="flex:1;text-align:center;">
                <div style="font-size:0.9rem;font-weight:bold;margin-bottom:15px;">‚úçÔ∏è ÿ™ŸàŸÇŸäÿπ ÿßŸÑÿ®ÿßÿ¶ÿπ</div>
                <div style="border-bottom:1px dashed #9ca3af;"></div>
            </div>
            <div style="flex:1;text-align:center;">
                <div style="font-size:0.9rem;font-weight:bold;margin-bottom:15px;">‚úçÔ∏è ÿ™ŸàŸÇŸäÿπ ÿßŸÑÿπŸÖŸäŸÑ</div>
                <div style="border-bottom:1px dashed #9ca3af;"></div>
            </div>
        </div>
        
        <!-- ÿßŸÑÿÆÿ™ÿßŸÖ -->
        <div style="text-align:center;margin-top:10px;padding-top:6px;border-top:2px solid #e5e7eb;">
            <p style="margin:2px 0;font-size:0.95rem;font-weight:bold;color:#6366f1;">üåü ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ™ÿπÿßŸÖŸÑŸÉŸÖ ŸÖÿπŸÜÿß üåü</p>
            <p style="margin:2px 0;font-size:0.85rem;color:#6b7280;">ŸÜÿ™ÿ∑ŸÑÿπ ŸÑÿÆÿØŸÖÿ™ŸÉŸÖ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ</p>
        </div>
        </div>`;
        return html;
    };
    
    console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÇŸàÿßŸÑÿ® ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÖÿ≠ÿØÿ´ÿ© - ŸÖÿπÿ±ÿ∂ ŸäÿπŸÇŸàÿ®');
})();




    </script>
    
    
    <style>
    /* ÿ£ŸÜŸÖÿßÿ∑ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑŸÖŸÅÿßÿ™Ÿäÿ≠ */
    .switch-container input[type="checkbox"] {
        position: relative;
        width: 50px;
        height: 26px;
        -webkit-appearance: none;
        appearance: none;
        background: #ccc;
        border-radius: 50px;
        outline: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .switch-container input[type="checkbox"]:checked {
        background: linear-gradient(135deg, #667eea, #764ba2);
    }
    
    .switch-container input[type="checkbox"]::before {
        content: '';
        position: absolute;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: white;
        top: 2px;
        right: 2px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .switch-container input[type="checkbox"]:checked::before {
        transform: translateX(-24px);
    }

    /* ==========================================
       üîî ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ v4.0 - CSS
       ========================================== */
/* ===================================
   üîî ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ v3.0 - CSS ÿßŸÑŸÜŸáÿßÿ¶Ÿä ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜ
   =================================== */

/* ===== ÿ≤ÿ± ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÅŸä top-actions ===== */
.notification-bell-btn {
    position: relative;
    width: 42px;
    height: 42px;
    border: none;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
    color: white;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
    margin: 0 8px;
}

.notification-bell-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.35);
}

.notification-bell-btn:active {
    transform: translateY(0);
}

.notification-bell-btn i {
    font-size: 18px;
}

/* ===== ÿ¥ÿßÿ±ÿ© ÿßŸÑÿπÿØÿØ ===== */
.notification-count-badge {
    position: absolute;
    top: -6px;
    left: -6px;
    min-width: 20px;
    height: 20px;
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-radius: 10px;
    color: white;
    font-size: 10px;
    font-weight: 700;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 0 5px;
    border: 2px solid white;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    animation: badge-pulse 2s infinite;
}

.notification-count-badge.visible {
    display: flex;
}

@keyframes badge-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* ===== ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿßŸÑŸÖÿπÿ™ŸÖÿ© (Overlay) ===== */
.notifications-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 99998;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    backdrop-filter: blur(4px);
}

.notifications-modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

/* ===== ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ±ŸÉÿ≤Ÿäÿ© ===== */
.notifications-center-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    width: 98%;
    max-width: 850px;
    max-height: 90vh;
    background: white;
    border-radius: 20px;
    box-shadow: 0 25px 70px rgba(0, 0, 0, 0.35);
    z-index: 99999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.notifications-center-modal.active {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, -50%) scale(1);
}

/* ===== ÿ±ÿ£ÿ≥ ÿßŸÑŸÑŸàÿ≠ÿ© ===== */
.notifications-modal-header {
    padding: 24px 28px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
}

.notifications-modal-title {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 0;
    font-size: 28px;
    font-weight: 800;
}

.notifications-modal-title i {
    font-size: 32px;
}

/* ===== ÿ£ÿ≤ÿ±ÿßÿ± ÿ±ÿ£ÿ≥ ÿßŸÑŸÑŸàÿ≠ÿ© ===== */
.notifications-modal-actions {
    display: flex;
    gap: 8px;
}

.notifications-modal-action-btn {
    width: 38px;
    height: 38px;
    border: none;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 10px;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.notifications-modal-action-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: scale(1.05);
}

/* ===== ÿ¨ÿ≥ŸÖ ÿßŸÑŸÑŸàÿ≠ÿ© ===== */
.notifications-modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

/* ===== ÿ±ÿ≥ÿßŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ© ===== */
.notifications-empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #9ca3af;
}

.notifications-empty-state i {
    font-size: 72px;
    margin-bottom: 20px;
    opacity: 0.4;
}

.notifications-empty-state p {
    font-size: 16px;
    margin: 0;
    font-weight: 500;
}

/* ===== ÿπŸÜÿµÿ± ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ===== */
.notification-item-card {
    display: flex;
    align-items: flex-start;
    gap: 14px;
    padding: 16px;
    border-radius: 14px;
    background: #f9fafb;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    border: 2px solid transparent;
}

.notification-item-card.unread {
    background: linear-gradient(135deg, #eff6ff 0%, #f9fafb 100%);
    border-color: #93c5fd;
}

.notification-item-card:hover {
    background: #f3f4f6;
    transform: translateX(-3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

/* ===== ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ===== */
.notification-item-icon {
    flex-shrink: 0;
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* ===== ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ===== */
.notification-item-content {
    flex: 1;
    min-width: 0;
}

.notification-item-title {
    font-size: 22px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 8px;
    line-height: 1.5;
}

.notification-item-message {
    font-size: 18px;
    color: #6b7280;
    margin-bottom: 10px;
    line-height: 1.6;
}

.notification-item-time {
    font-size: 15px;
    color: #9ca3af;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* ===== ÿ≤ÿ± ÿ≠ÿ∞ŸÅ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ===== */
.notification-item-delete {
    flex-shrink: 0;
    width: 34px;
    height: 34px;
    border: none;
    background: rgba(239, 68, 68, 0.1);
    border-radius: 8px;
    color: #ef4444;
    cursor: pointer;
    opacity: 0;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.notification-item-card:hover .notification-item-delete {
    opacity: 1;
}

.notification-item-delete:hover {
    background: rgba(239, 68, 68, 0.2);
    transform: scale(1.1);
}


/* ÿ™ŸÖŸäŸäÿ≤ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ŸÖŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± */
.product-highlighted {
    animation: highlightPulse 2s ease-in-out 3;
    background: linear-gradient(90deg, 
        rgba(251, 191, 36, 0.2) 0%, 
        rgba(251, 191, 36, 0.4) 50%, 
        rgba(251, 191, 36, 0.2) 100%);
    border: 2px solid #fbbf24 !important;
    box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
}

@keyframes highlightPulse {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
    }
    50% {
        transform: scale(1.02);
        box-shadow: 0 0 30px rgba(251, 191, 36, 0.8);
    }
}

.product-highlighted::before {
    content: '‚ö†Ô∏è ÿ™ŸÜÿ®ŸäŸá: Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÖŸÜÿÆŸÅÿ∂ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ';
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    background: #fbbf24;
    color: #000;
    padding: 5px 15px;
    border-radius: 5px;
    font-size: 12px;
    font-weight: bold;
    white-space: nowrap;
    z-index: 1000;
    animation: fadeInOut 4s ease-in-out;
}

@keyframes fadeInOut {
    0%, 100% { opacity: 0; }
    10%, 90% { opacity: 1; }
}

/* ===== Toast Notifications ===== */
.notifications-toast-container {
    position: fixed;
    top: 90px;
    left: 20px;
    z-index: 100000;
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-width: 420px;
    pointer-events: none;
}

.notification-toast-card {
    background: white;
    border-radius: 14px;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    padding: 16px;
    transform: translateX(-120%);
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    opacity: 0;
    pointer-events: all;
    border-right: 4px solid #3b82f6;
    max-width: 420px;
}

.notification-toast-card.visible {
    transform: translateX(0);
    opacity: 1;
}

/* ===== ÿ£ŸàŸÑŸàŸäÿßÿ™ Toast ===== */
.notification-toast-card.priority-critical {
    border-right-color: #ef4444;
    background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
}

.notification-toast-card.priority-high {
    border-right-color: #f59e0b;
    background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%);
}

.notification-toast-card.priority-medium {
    border-right-color: #3b82f6;
}

.notification-toast-card.priority-low {
    border-right-color: #10b981;
}

/* ===== ŸÖÿ≠ÿ™ŸàŸâ Toast ===== */
.notification-toast-content {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.notification-toast-icon {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.9);
    font-size: 20px;
}

.notification-toast-body {
    flex: 1;
    min-width: 0;
}

.notification-toast-title {
    font-size: 15px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 4px;
}

.notification-toast-message {
    font-size: 13px;
    color: #6b7280;
    line-height: 1.5;
}

.notification-toast-close {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    border: none;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 6px;
    color: #9ca3af;
    cursor: pointer;
    transition: all 0.2s;
}

.notification-toast-close:hover {
    background: rgba(0, 0, 0, 0.1);
    color: #6b7280;
}

/* ===== Scrollbar ===== */
.notifications-modal-body::-webkit-scrollbar {
    width: 8px;
}

.notifications-modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.notifications-modal-body::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 10px;
}

.notifications-modal-body::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #5568d3, #6a3e8a);
}

/* ===== Responsive ===== */
@media (max-width: 768px) {
    .notification-bell-btn {
        width: 38px;
        height: 38px;
    }
    
    .notifications-center-modal {
        width: 95%;
        max-height: 90vh;
    }
    
    .notifications-modal-header {
        padding: 20px;
    }
    
    .notifications-modal-title {
        font-size: 18px;
    }
    
    .notifications-toast-container {
        left: 10px;
        right: 10px;
        max-width: calc(100% - 20px);
    }
    
    .notification-toast-card {
        max-width: 100%;
    }
}

/* ===== ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ™ÿ∂ÿßÿ±ÿ® ===== */
.notification-bell-btn,
.notifications-modal-overlay,
.notifications-center-modal,
.notifications-toast-container {
    font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
    </style>
    
    
    <script src="products-fixes.js"></script>


    
    <!-- ==========================================
         üîî ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ v4.0 - ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ™ŸÅÿµŸäŸÑŸäÿ©
         ========================================== -->
    <script>
/* ===================================
   üîî ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ v4.0 - ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ™ŸÅÿµŸäŸÑŸäÿ©
   ŸÖŸäÿ≤ÿ© ÿ¨ÿØŸäÿØÿ©: ÿ•ÿ¥ÿπÿßÿ± ŸÖŸÜŸÅÿµŸÑ ŸÑŸÉŸÑ ÿπŸÖŸäŸÑ ŸàŸÖŸÜÿ™ÿ¨
   =================================== */

(function() {
    'use strict';
    
    if (window.NotificationsSystemV4) {
        console.warn('‚ö†Ô∏è ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ v4 ŸÖÿ≠ŸÖŸëŸÑ ÿ®ÿßŸÑŸÅÿπŸÑ');
        return;
    }
    
    console.log('üîî ÿ™ÿ≠ŸÖŸäŸÑ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ v4.0 - ÿßŸÑÿ™ŸÅÿµŸäŸÑŸä...');


    // ==================== NotificationPersistence ====================
    class NotificationPersistenceV4 {
        constructor() {
            this.storageKey = 'yaqoub_notifications_read';
            this.dismissedKey = 'yaqoub_notifications_dismissed';
            this.shownKey = 'yaqoub_notifications_shown';
        }
        
        markAsRead(notificationId) {
            const readIds = this.getReadIds();
            if (!readIds.includes(notificationId)) {
                readIds.push(notificationId);
                localStorage.setItem(this.storageKey, JSON.stringify(readIds));
            }
        }
        
        markAsDismissed(notificationId) {
            const dismissedIds = this.getDismissedIds();
            if (!dismissedIds.includes(notificationId)) {
                dismissedIds.push(notificationId);
                localStorage.setItem(this.dismissedKey, JSON.stringify(dismissedIds));
            }
        }
        
        markAsShown(notificationId) {
            const shownIds = this.getShownIds();
            if (!shownIds.includes(notificationId)) {
                shownIds.push(notificationId);
                localStorage.setItem(this.shownKey, JSON.stringify(shownIds));
            }
        }
        
        getReadIds() {
            try {
                const data = localStorage.getItem(this.storageKey);
                return data ? JSON.parse(data) : [];
            } catch (e) { return []; }
        }
        
        getDismissedIds() {
            try {
                const data = localStorage.getItem(this.dismissedKey);
                return data ? JSON.parse(data) : [];
            } catch (e) { return []; }
        }
        
        getShownIds() {
            try {
                const data = localStorage.getItem(this.shownKey);
                return data ? JSON.parse(data) : [];
            } catch (e) { return []; }
        }
        
        isRead(notificationId) {
            return this.getReadIds().includes(notificationId);
        }
        
        isDismissed(notificationId) {
            return this.getDismissedIds().includes(notificationId);
        }
        
        isShown(notificationId) {
            return this.getShownIds().includes(notificationId);
        }
        
        shouldShow(notificationId) {
            return !this.isRead(notificationId) && 
                   !this.isDismissed(notificationId) &&
                   !this.isShown(notificationId);
        }
        
        clearOldData() {
            // ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
            const maxAge = 30 * 24 * 60 * 60 * 1000; // 30 ŸäŸàŸÖ
            // ŸäŸÖŸÉŸÜ ÿ™ÿ∑ŸàŸäÿ± Ÿáÿ∞ÿß ŸÑÿßÿ≠ŸÇÿßŸã
        }
    }

    // ==================== NotificationEngine ====================
    class NotificationEngineV4 {
        constructor() {
            this.checkInterval = 5 * 60 * 1000; // 5 ÿØŸÇÿßÿ¶ŸÇ
            this.isRunning = false;
            this.lastCheck = null;
            this.intervalId = null;
        }
        
        start() {
            if (this.isRunning) return;
            
            this.isRunning = true;
            console.log('üîî ÿ®ÿØÿ° ŸÖÿ≠ÿ±ŸÉ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ v4');
            
            this.performCheck();
            
            this.intervalId = setInterval(() => {
                this.performCheck();
            }, this.checkInterval);
        }
        
        stop() {
            if (this.intervalId) {
                clearInterval(this.intervalId);
                this.intervalId = null;
            }
            this.isRunning = false;
            console.log('üîï ÿ•ŸäŸÇÿßŸÅ ŸÖÿ≠ÿ±ŸÉ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ v4');
        }
        
        async performCheck() {
            console.log('üîç ŸÅÿ≠ÿµ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ŸÅÿµŸäŸÑŸä...');
            
            const notifications = [];
            
            try {
                const stockNotifs = await this.checkInventory();
                notifications.push(...stockNotifs);
                
                const debtNotifs = await this.checkDebts();
                notifications.push(...debtNotifs);
                
                this.lastCheck = new Date();
                
                if (notifications.length > 0) {
                    await this.processNotifications(notifications);
                }
                
                console.log(`‚úÖ ÿßŸÑŸÅÿ≠ÿµ: ${notifications.length} ÿ•ÿ¥ÿπÿßÿ± ÿ™ŸÅÿµŸäŸÑŸä`);
                
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÅÿ≠ÿµ:', error);
            }
            
            return notifications;
        }
        
        async checkInventory() {
            const notifications = [];
            
            try {
                // 1. ŸÖÿ≠ÿßŸàŸÑÿ© ÿ¨ŸÑÿ® ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖŸÜ productsData ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ÿ£ŸàŸÑÿßŸã
                let products = [];
                
                // ÿ¨ŸÑÿ® ŸÖŸÜ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ± ÿßŸÑÿπÿßŸÖ
                if (window.productsData && Array.isArray(window.productsData)) {
                    products = window.productsData;
                    console.log('üì¶ ÿ¨ŸÑÿ® ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖŸÜ productsData:', products.length);
                }
                
                // ÿ¨ŸÑÿ® ŸÖŸÜ localStorage ŸÉŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
                if (products.length === 0) {
                    const savedProducts = localStorage.getItem('productsData');
                    if (savedProducts) {
                        try {
                            const parsed = JSON.parse(savedProducts);
                            if (Array.isArray(parsed)) {
                                products = parsed;
                                console.log('üì¶ ÿ¨ŸÑÿ® ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖŸÜ localStorage:', products.length);
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖŸÜ localStorage');
                        }
                    }
                }
                
                // 2. ŸÖÿ≠ÿßŸàŸÑÿ© ÿ¨ŸÑÿ® ŸÖŸÜ dataSdk ŸÉÿ¢ÿÆÿ± ÿÆŸäÿßÿ±
                if (products.length === 0 && window.dataSdk) {
                    products = await window.dataSdk.query({ type: 'product' });
                    console.log('üì¶ ÿ¨ŸÑÿ® ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖŸÜ dataSdk:', products ? products.length : 0);
                }
                
                if (!products || products.length === 0) {
                    console.log('‚ÑπÔ∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑŸÑŸÅÿ≠ÿµ');
                    return notifications;
                }
                
                // ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖŸÜÿÆŸÅÿ∂ÿ©: ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑŸÉŸÖŸäÿ© <= ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ
                const lowStock = products.filter(p => {
                    const stock = p.stock_quantity || p.quantity || 0;
                    const minStock = p.min_stock_quantity || p.min_stock || 0;
                    // ŸÑÿß ŸÜÿπÿ∑Ÿä ÿ•ÿ¥ÿπÿßÿ± ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ≠ÿØÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ≠ÿØ ÿ£ÿØŸÜŸâ
                    if (!minStock || minStock <= 0) return false;
                    // ŸÜÿπÿ∑Ÿä ÿ•ÿ¥ÿπÿßÿ± ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑŸÉŸÖŸäÿ© <= ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ÿßŸÑŸÖÿ≠ÿØÿØ
                    return stock > 0 && stock <= minStock;
                });

                // ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©: ÿßŸÑŸÉŸÖŸäÿ© = 0
                const outOfStock = products.filter(p => {
                    const stock = p.stock_quantity || p.quantity || 0;
                    return stock === 0;
                });
                
                console.log(`üîç ŸÅÿ≠ÿµ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ: ŸÖŸÜÿÆŸÅÿ∂=${lowStock.length}, ŸÜÿßŸÅÿ∞=${outOfStock.length}`);
                
                // ÿ•ŸÜÿ¥ÿßÿ° ÿ•ÿ¥ÿπÿßÿ± ŸÖŸÜŸÅÿµŸÑ ŸÑŸÉŸÑ ŸÖŸÜÿ™ÿ¨ ŸÜÿßŸÅÿ∞
                outOfStock.forEach(product => {
                    const productName = product.name || product.product_name || product.title || 'ŸÖŸÜÿ™ÿ¨ ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ';
                    notifications.push({
                        id: `out-stock-${product.id}-${Date.now()}`,
                        type: 'out_of_stock',
                        priority: 'critical',
                        title: `ŸÜŸÅÿ∞ ŸÖŸÜ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ: ${productName}`,
                        message: `ÿßŸÑŸÖŸÜÿ™ÿ¨ "${productName}" ŸÜŸÅÿØ ŸÖŸÜ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿ™ŸÖÿßŸÖÿßŸã`,
                        icon: 'fa-times-circle',
                        color: '#ef4444',
                        timestamp: new Date().toISOString(),
                        data: {
                            product: product,
                            productId: product.id,
                            productName: productName,
                            stock: 0
                        }
                    });
                });
                
                // ÿ•ŸÜÿ¥ÿßÿ° ÿ•ÿ¥ÿπÿßÿ± ŸÖŸÜŸÅÿµŸÑ ŸÑŸÉŸÑ ŸÖŸÜÿ™ÿ¨ ŸÖŸÜÿÆŸÅÿ∂
                lowStock.forEach(product => {
                    const remaining = product.stock_quantity || product.quantity || 0;
                    const minStock = product.min_stock_quantity || product.min_stock || 10;
                    const productName = product.name || product.product_name || product.title || 'ŸÖŸÜÿ™ÿ¨ ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ';
                    notifications.push({
                        id: `low-stock-${product.id}-${Date.now()}`,
                        type: 'low_stock',
                        priority: 'high',
                        title: `ŸÖŸÜÿÆŸÅÿ∂: ${productName}`,
                        message: `ÿßŸÑŸÖŸÜÿ™ÿ¨ "${productName}" - ÿßŸÑŸÖÿ™ÿ®ŸÇŸä: ${remaining} Ÿàÿ≠ÿØÿ© ŸÅŸÇÿ∑ (ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ: ${minStock})`,
                        icon: 'fa-exclamation-triangle',
                        color: '#f59e0b',
                        timestamp: new Date().toISOString(),
                        data: {
                            product: product,
                            productId: product.id,
                            productName: productName,
                            stock: remaining,
                            minStock: minStock
                        }
                    });
                });
                
                // ÿ•ÿ¥ÿπÿßÿ± ŸÖŸÑÿÆÿµ ŸÑŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© (ÿ•ÿ∂ÿßŸÅŸä)
                if (outOfStock.length > 0) {
                    notifications.push({
                        id: `summary-out-stock-${Date.now()}`,
                        type: 'out_of_stock_summary',
                        priority: 'critical',
                        title: `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©`,
                        message: `${outOfStock.length} ŸÖŸÜÿ™ÿ¨ ŸÜŸÅÿØ ŸÖŸÜ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ`,
                        icon: 'fa-warehouse',
                        color: '#ef4444',
                        timestamp: new Date().toISOString(),
                        data: {
                            count: outOfStock.length,
                            products: outOfStock
                        }
                    });
                }
                
                // ÿ•ÿ¥ÿπÿßÿ± ŸÖŸÑÿÆÿµ ŸÑŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖŸÜÿÆŸÅÿ∂ÿ© (ÿ•ÿ∂ÿßŸÅŸä)
                if (lowStock.length > 0) {
                    notifications.push({
                        id: `summary-low-stock-${Date.now()}`,
                        type: 'low_stock_summary',
                        priority: 'high',
                        title: `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖŸÜÿÆŸÅÿ∂ÿ©`,
                        message: `${lowStock.length} ŸÖŸÜÿ™ÿ¨ ŸÇÿßÿ±ÿ® ÿπŸÑŸâ ÿßŸÑŸÜŸÅÿßÿ∞`,
                        icon: 'fa-chart-line',
                        color: '#f59e0b',
                        timestamp: new Date().toISOString(),
                        data: {
                            count: lowStock.length,
                            products: lowStock
                        }
                    });
                }
                
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÅÿ≠ÿµ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ:', error);
            }
            
            return notifications;
        }
        
        async checkDebts() {
            const notifications = [];
            
            try {
                // 1. ÿ¨ŸÑÿ® ÿßŸÑÿØŸäŸàŸÜ ŸÖŸÜ ŸÖÿµÿßÿØÿ± ŸÖÿ™ÿπÿØÿØÿ©
                let debts = [];
                
                // ÿ¨ŸÑÿ® ŸÖŸÜ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ± ÿßŸÑÿπÿßŸÖ
                if (window.debtsData && Array.isArray(window.debtsData)) {
                    debts = window.debtsData;
                    console.log('üì¶ ÿ¨ŸÑÿ® ÿßŸÑÿØŸäŸàŸÜ ŸÖŸÜ debtsData:', debts.length);
                }
                
                // ÿ¨ŸÑÿ® ŸÖŸÜ localStorage ŸÉŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
                if (debts.length === 0) {
                    const savedDebts = localStorage.getItem('debtsData');
                    if (savedDebts) {
                        try {
                            const parsed = JSON.parse(savedDebts);
                            if (Array.isArray(parsed)) {
                                debts = parsed;
                                console.log('üì¶ ÿ¨ŸÑÿ® ÿßŸÑÿØŸäŸàŸÜ ŸÖŸÜ localStorage:', debts.length);
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿØŸäŸàŸÜ ŸÖŸÜ localStorage');
                        }
                    }
                }
                
                // 2. ŸÖÿ≠ÿßŸàŸÑÿ© ÿ¨ŸÑÿ® ŸÖŸÜ dataSdk ŸÉÿ¢ÿÆÿ± ÿÆŸäÿßÿ±
                if (debts.length === 0 && window.dataSdk) {
                    debts = await window.dataSdk.query({ type: 'debt' });
                    console.log('üì¶ ÿ¨ŸÑÿ® ÿßŸÑÿØŸäŸàŸÜ ŸÖŸÜ dataSdk:', debts ? debts.length : 0);
                }
                
                if (!debts || debts.length === 0) {
                    console.log('‚ÑπÔ∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿØŸäŸàŸÜ ŸÑŸÑŸÅÿ≠ÿµ');
                    return notifications;
                }
                
                const now = new Date();
                
                // ŸÅÿ≠ÿµ ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÖÿ™ÿ£ÿÆÿ±ÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÅÿπŸÑŸäÿ©
                const overdue = debts.filter(debt => {
                    // ÿ™ÿÆÿ∑Ÿä ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÖÿ≥ÿØÿØÿ© ÿ®ÿßŸÑŸÉÿßŸÖŸÑ
                    let paidMonths = 0;
                    let totalMonths = 0;
                    
                    if (debt.installments && Array.isArray(debt.installments) && debt.installments.length > 0) {
                        totalMonths = debt.installments.length;
                        debt.installments.forEach(inst => {
                            if (inst.status === 'paid') {
                                paidMonths++;
                            }
                        });
                    }
                    
                    const isPaid = paidMonths === totalMonths && totalMonths > 0;
                    if (isPaid) return false;
                    
                    // ŸÅÿ≠ÿµ ÿßŸÑÿ™ÿ£ÿÆŸäÿ± ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÅÿπŸÑŸäÿ©
                    if (debt.installments && Array.isArray(debt.installments) && debt.installments.length > 0) {
                        // ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ŸÇÿ≥ÿßÿ∑ ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπÿ© ŸàŸÖÿ™ÿ£ÿÆÿ±ÿ©
                        const unpaidOverdue = debt.installments.filter(inst => {
                            if (inst.status === 'paid') return false;
                            const dueDate = new Date(inst.due_date);
                            return dueDate < now;
                        });
                        return unpaidOverdue.length > 0;
                    } else {
                        // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ÿ£ŸÇÿ≥ÿßÿ∑ÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ due_date ÿ£Ÿà start_date
                        const checkDate = debt.due_date || debt.start_date || debt.date;
                        if (checkDate) {
                            const dueDate = new Date(checkDate);
                            const totalAmount = debt.total_amount || debt.final_total || 0;
                            const paidAmount = debt.paid_amount || 0;
                            const remainingAmount = totalAmount - paidAmount;
                            return dueDate < now && remainingAmount > 0;
                        }
                        return false;
                    }
                });
                
                // ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÇÿ±Ÿäÿ®ÿ© (ÿÆŸÑÿßŸÑ 3 ÿ£ŸäÿßŸÖ) ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑
                const upcoming = debts.filter(debt => {
                    // ÿ™ÿÆÿ∑Ÿä ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÖÿ≥ÿØÿØÿ© ÿ®ÿßŸÑŸÉÿßŸÖŸÑ
                    let paidMonths = 0;
                    let totalMonths = 0;
                    
                    if (debt.installments && Array.isArray(debt.installments) && debt.installments.length > 0) {
                        totalMonths = debt.installments.length;
                        debt.installments.forEach(inst => {
                            if (inst.status === 'paid') {
                                paidMonths++;
                            }
                        });
                    }
                    
                    const isPaid = paidMonths === totalMonths && totalMonths > 0;
                    if (isPaid) return false;
                    
                    const threeDays = new Date();
                    threeDays.setDate(threeDays.getDate() + 3);
                    
                    // ŸÅÿ≠ÿµ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÇÿ±Ÿäÿ®ÿ©
                    if (debt.installments && Array.isArray(debt.installments) && debt.installments.length > 0) {
                        const upcomingInstallments = debt.installments.filter(inst => {
                            if (inst.status === 'paid') return false;
                            const dueDate = new Date(inst.due_date);
                            return dueDate >= now && dueDate <= threeDays;
                        });
                        return upcomingInstallments.length > 0;
                    } else {
                        const checkDate = debt.due_date || debt.start_date || debt.date;
                        if (checkDate) {
                            const dueDate = new Date(checkDate);
                            return dueDate >= now && dueDate <= threeDays;
                        }
                        return false;
                    }
                });
                
                console.log(`üîç ŸÅÿ≠ÿµ ÿßŸÑÿØŸäŸàŸÜ: ŸÖÿ™ÿ£ÿÆÿ±ÿ©=${overdue.length}, ŸÇÿ±Ÿäÿ®ÿ©=${upcoming.length}`);
                
                // ÿ•ŸÜÿ¥ÿßÿ° ÿ•ÿ¥ÿπÿßÿ± ŸÖŸÜŸÅÿµŸÑ ŸÑŸÉŸÑ ÿØŸäŸÜ ŸÖÿ™ÿ£ÿÆÿ±
                overdue.forEach(debt => {
                    const totalAmount = debt.total_amount || debt.final_total || 0;
                    const paidAmount = debt.paid_amount || 0;
                    const remainingAmount = totalAmount - paidAmount;
                    const amount = this.formatCurrency(remainingAmount);
                    const customerName = debt.customer_name || 'ÿπŸÖŸäŸÑ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                    
                    // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ£ÿÆÿ±ÿ©
                    let daysPast = 0;
                    if (debt.installments && Array.isArray(debt.installments) && debt.installments.length > 0) {
                        const overdueInstallments = debt.installments.filter(inst => {
                            if (inst.status === 'paid') return false;
                            const dueDate = new Date(inst.due_date);
                            return dueDate < now;
                        });
                        if (overdueInstallments.length > 0) {
                            // ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ£ŸÇÿØŸÖ ŸÇÿ≥ÿ∑ ŸÖÿ™ÿ£ÿÆÿ±
                            const oldestOverdue = overdueInstallments.reduce((oldest, inst) => {
                                const instDate = new Date(inst.due_date);
                                const oldestDate = new Date(oldest.due_date);
                                return instDate < oldestDate ? inst : oldest;
                            });
                            daysPast = Math.floor((now - new Date(oldestOverdue.due_date)) / (1000 * 60 * 60 * 24));
                        }
                    } else {
                        const checkDate = debt.due_date || debt.start_date || debt.date;
                        if (checkDate) {
                            daysPast = Math.floor((now - new Date(checkDate)) / (1000 * 60 * 60 * 24));
                        }
                    }
                    
                    notifications.push({
                        id: `overdue-${debt.id || debt.debt_id}-${Date.now()}`,
                        type: 'overdue_debt',
                        priority: daysPast > 30 ? 'critical' : 'high',
                        title: `ÿØŸäŸÜ ŸÖÿ™ÿ£ÿÆÿ±: ${customerName}`,
                        message: `ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä: ${amount} - ŸÖÿ™ÿ£ÿÆÿ± ${daysPast} ŸäŸàŸÖ`,
                        icon: 'fa-exclamation-circle',
                        color: '#ef4444',
                        timestamp: new Date().toISOString(),
                        data: {
                            debt: debt,
                            debtId: debt.id || debt.debt_id,
                            customerId: debt.customer_id,
                            customerName: customerName,
                            amount: remainingAmount,
                            daysPast: daysPast,
                            dueDate: debt.due_date || debt.start_date
                        }
                    });
                });
                
                // ÿ•ŸÜÿ¥ÿßÿ° ÿ•ÿ¥ÿπÿßÿ± ŸÖŸÜŸÅÿµŸÑ ŸÑŸÉŸÑ ÿØŸäŸÜ ŸÇÿ±Ÿäÿ®
                upcoming.forEach(debt => {
                    const totalAmount = debt.total_amount || debt.final_total || 0;
                    const paidAmount = debt.paid_amount || 0;
                    const remainingAmount = totalAmount - paidAmount;
                    const amount = this.formatCurrency(remainingAmount);
                    const customerName = debt.customer_name || 'ÿπŸÖŸäŸÑ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                    
                    // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©
                    let daysLeft = 0;
                    if (debt.installments && Array.isArray(debt.installments) && debt.installments.length > 0) {
                        const upcomingInstallments = debt.installments.filter(inst => {
                            if (inst.status === 'paid') return false;
                            const dueDate = new Date(inst.due_date);
                            const threeDays = new Date();
                            threeDays.setDate(threeDays.getDate() + 3);
                            return dueDate >= now && dueDate <= threeDays;
                        });
                        if (upcomingInstallments.length > 0) {
                            // ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ£ŸÇÿ±ÿ® ŸÇÿ≥ÿ∑
                            const nearestUpcoming = upcomingInstallments.reduce((nearest, inst) => {
                                const instDate = new Date(inst.due_date);
                                const nearestDate = new Date(nearest.due_date);
                                return instDate < nearestDate ? inst : nearest;
                            });
                            daysLeft = Math.ceil((new Date(nearestUpcoming.due_date) - now) / (1000 * 60 * 60 * 24));
                        }
                    } else {
                        const checkDate = debt.due_date || debt.start_date || debt.date;
                        if (checkDate) {
                            daysLeft = Math.ceil((new Date(checkDate) - now) / (1000 * 60 * 60 * 24));
                        }
                    }
                    
                    notifications.push({
                        id: `upcoming-${debt.id || debt.debt_id}-${Date.now()}`,
                        type: 'upcoming_debt',
                        priority: 'medium',
                        title: `ÿØŸäŸÜ ŸÇÿ±Ÿäÿ®: ${customerName}`,
                        message: `ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä: ${amount} - Ÿäÿ≥ÿ™ÿ≠ŸÇ ÿÆŸÑÿßŸÑ ${daysLeft} ŸäŸàŸÖ`,
                        icon: 'fa-clock',
                        color: '#f59e0b',
                        timestamp: new Date().toISOString(),
                        data: {
                            debt: debt,
                            debtId: debt.id || debt.debt_id,
                            customerId: debt.customer_id,
                            customerName: customerName,
                            amount: remainingAmount,
                            daysLeft: daysLeft,
                            dueDate: debt.due_date || debt.start_date
                        }
                    });
                });
                
                // ÿ•ÿ¥ÿπÿßÿ± ŸÖŸÑÿÆÿµ ŸÑŸÑÿØŸäŸàŸÜ ÿßŸÑŸÖÿ™ÿ£ÿÆÿ±ÿ© (ÿ•ÿ∂ÿßŸÅŸä)
                if (overdue.length > 0) {
                    const total = overdue.reduce((sum, d) => {
                        const totalAmount = d.total_amount || d.final_total || 0;
                        const paidAmount = d.paid_amount || 0;
                        return sum + (totalAmount - paidAmount);
                    }, 0);
                    notifications.push({
                        id: `summary-overdue-${Date.now()}`,
                        type: 'overdue_debts_summary',
                        priority: 'critical',
                        title: `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÖÿ™ÿ£ÿÆÿ±ÿ©`,
                        message: `${overdue.length} ÿØŸäŸÜ ŸÖÿ™ÿ£ÿÆÿ± - ÿßŸÑŸÖÿ¨ŸÖŸàÿπ: ${this.formatCurrency(total)}`,
                        icon: 'fa-money-bill-wave',
                        color: '#ef4444',
                        timestamp: new Date().toISOString(),
                        data: {
                            count: overdue.length,
                            totalAmount: total,
                            debts: overdue
                        }
                    });
                }
                
                // ÿ•ÿ¥ÿπÿßÿ± ŸÖŸÑÿÆÿµ ŸÑŸÑÿØŸäŸàŸÜ ÿßŸÑŸÇÿ±Ÿäÿ®ÿ© (ÿ•ÿ∂ÿßŸÅŸä)
                if (upcoming.length > 0) {
                    const total = upcoming.reduce((sum, d) => {
                        const totalAmount = d.total_amount || d.final_total || 0;
                        const paidAmount = d.paid_amount || 0;
                        return sum + (totalAmount - paidAmount);
                    }, 0);
                    notifications.push({
                        id: `summary-upcoming-${Date.now()}`,
                        type: 'upcoming_debts_summary',
                        priority: 'medium',
                        title: `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿØŸäŸàŸÜ ÿßŸÑŸÇÿ±Ÿäÿ®ÿ©`,
                        message: `${upcoming.length} ÿØŸäŸÜ - ÿßŸÑŸÖÿ¨ŸÖŸàÿπ: ${this.formatCurrency(total)}`,
                        icon: 'fa-calendar-alt',
                        color: '#f59e0b',
                        timestamp: new Date().toISOString(),
                        data: {
                            count: upcoming.length,
                            totalAmount: total,
                            debts: upcoming
                        }
                    });
                }
                
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÅÿ≠ÿµ ÿßŸÑÿØŸäŸàŸÜ:', error);
            }
            
            return notifications;
        }
        
        async processNotifications(notifications) {
            // ÿ™ÿµŸÅŸäÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ - ÿπÿ±ÿ∂ ŸÅŸÇÿ∑ ÿßŸÑÿ¨ÿØŸäÿØÿ©
            const newNotifications = notifications.filter(n => {
                if (window.NotificationsSystemV4?.persistence) {
                    return window.NotificationsSystemV4.persistence.shouldShow(n.id);
                }
                return true;
            });
            
            if (newNotifications.length === 0) {
                console.log('‚ÑπÔ∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ¨ÿØŸäÿØÿ©');
                return;
            }
            
            console.log(`üîî ${newNotifications.length} ÿ•ÿ¥ÿπÿßÿ± ÿ¨ÿØŸäÿØ`);
            
            // ÿπÿ±ÿ∂ Toast ŸÅŸÇÿ∑ ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖŸÑÿÆÿµÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©
            const summaryNotifs = newNotifications.filter(n => 
                n.type.includes('_summary')
            );
            
            for (const notif of summaryNotifs) {
                window.NotificationsSystemV4.ui.showToast(notif);
                // ÿ™ÿ≠ÿØŸäÿØ ŸÉŸÖÿπÿ±Ÿàÿ∂
                if (window.NotificationsSystemV4?.persistence) {
                    window.NotificationsSystemV4.persistence.markAsShown(notif.id);
                }
            }
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÑŸÑŸÖÿØŸäÿ±
            for (const notif of newNotifications) {
                window.NotificationsSystemV4.manager.add(notif);
                
                // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÅÿ±ÿØŸäÿ© ŸÉŸÖÿπÿ±Ÿàÿ∂ÿ© ÿ£Ÿäÿ∂ÿßŸã
                if (!notif.type.includes('_summary') && 
                    window.NotificationsSystemV4?.persistence) {
                    window.NotificationsSystemV4.persistence.markAsShown(notif.id);
                }
            }
        }
        
        formatCurrency(amount) {
            return new Intl.NumberFormat('ar-IQ', {
                style: 'decimal',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount) + ' ÿØ.ÿπ';
        }
    }

    // ==================== NotificationManager ====================
    class NotificationManagerV4 {
        constructor() {
            this.notifications = [];
            this.unreadCount = 0;
        }
        
        add(notif) {
            // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØŸÖ Ÿàÿ¨ŸàÿØ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ŸÖÿ≥ÿ®ŸÇÿßŸã
            const exists = this.notifications.some(n => n.id === notif.id);
            if (exists) return;
            
            // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ŸÑŸÖ Ÿäÿ™ŸÖ ŸÇÿ±ÿßÿ°ÿ™Ÿá ÿ£Ÿà ÿ≠ÿ∞ŸÅŸá ÿ≥ÿßÿ®ŸÇÿßŸã
            if (window.NotificationsSystemV4?.persistence) {
                if (!window.NotificationsSystemV4.persistence.shouldShow(notif.id)) {
                    return; // ŸÑÿß ÿ™ÿ∏Ÿáÿ± ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖŸÇÿ±Ÿàÿ°ÿ© ÿ£Ÿà ŸÖÿ≠ÿ∞ŸàŸÅÿ©
                }
            }
            
            this.notifications.unshift(notif);
            this.unreadCount++;
            this.updateBadge();
            this.playSound();
        }
        
        markAsRead(id) {
            const notif = this.notifications.find(n => n.id === id);
            if (notif && !notif.read) {
                notif.read = true;
                notif.readAt = new Date().toISOString();
                this.unreadCount = Math.max(0, this.unreadCount - 1);
                this.updateBadge();
            }
        }
        
        markAllAsRead() {
            this.notifications.forEach(n => {
                if (!n.read) {
                    n.read = true;
                    n.readAt = new Date().toISOString();
                }
            });
            this.unreadCount = 0;
            this.updateBadge();
            window.NotificationsSystemV4.ui.renderModal();
        }
        
        delete(id) {
            const index = this.notifications.findIndex(n => n.id === id);
            if (index !== -1) {
                const notif = this.notifications[index];
                if (!notif.read) {
                    this.unreadCount--;
                }
                this.notifications.splice(index, 1);
                this.updateBadge();
            }
        }
        
        clearAll() {
            this.notifications = [];
            this.unreadCount = 0;
            this.updateBadge();
            window.NotificationsSystemV4.ui.renderModal();
        }
        
        getAll() {
            return this.notifications;
        }
        
        updateBadge() {
            const badge = document.getElementById('notificationsBadgeV4');
            if (badge) {
                if (this.unreadCount > 0) {
                    badge.textContent = this.unreadCount > 99 ? '99+' : this.unreadCount;
                    badge.classList.add('visible');
                } else {
                    badge.classList.remove('visible');
                }
            }
        }
        
        playSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.frequency.value = 800;
                osc.type = 'sine';
                
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.5);
            } catch (error) {
                console.warn('ÿ™ÿπÿ∞ÿ± ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™');
            }
        }
    }

    // ==================== NotificationUI ====================
    class NotificationUIV4 {
        constructor() {
            this.modalOverlay = null;
            this.modal = null;
            this.toastContainer = null;
            this.initUI();
        }
        
        initUI() {
            this.addBellButton();
            this.createModal();
            this.createToastContainer();
        }
        
        addBellButton() {
            const topActions = document.querySelector('.top-actions');
            
            if (!topActions) {
                console.error('‚ùå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ .top-actions');
                return;
            }
            
            const bellBtn = document.createElement('button');
            bellBtn.className = 'notification-bell-btn';
            bellBtn.id = 'notificationsBellBtnV4';
            bellBtn.innerHTML = `
                <i class="fas fa-bell"></i>
                <span class="notification-count-badge" id="notificationsBadgeV4">0</span>
            `;
            
            bellBtn.addEventListener('click', () => {
                this.toggleModal();
            });
            
            const themeToggle = topActions.querySelector('.theme-toggle');
            if (themeToggle) {
                topActions.insertBefore(bellBtn, themeToggle);
            } else {
                topActions.appendChild(bellBtn);
            }
            
            console.log('‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿ≤ÿ± ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ v4');
        }
        
        createModal() {
            this.modalOverlay = document.createElement('div');
            this.modalOverlay.className = 'notifications-modal-overlay';
            this.modalOverlay.id = 'notificationsOverlayV4';
            this.modalOverlay.addEventListener('click', () => {
                this.closeModal();
            });
            document.body.appendChild(this.modalOverlay);
            
            this.modal = document.createElement('div');
            this.modal.className = 'notifications-center-modal';
            this.modal.id = 'notificationsModalV4';
            this.modal.innerHTML = `
                <div class="notifications-modal-header">
                    <h3 class="notifications-modal-title">
                        <i class="fas fa-bell"></i>
                        ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ™ŸÅÿµŸäŸÑŸäÿ©
                    </h3>
                    <div class="notifications-modal-actions">
                        <button class="notifications-modal-action-btn" id="markAllReadBtnV4" title="ÿ™ÿπŸÑŸäŸÖ ÿßŸÑŸÉŸÑ ŸÉŸÖŸÇÿ±Ÿàÿ°">
                            <i class="fas fa-check-double"></i>
                        </button>
                        <button class="notifications-modal-action-btn" id="clearAllBtnV4" title="ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="notifications-modal-action-btn" id="closeModalBtnV4" title="ÿ•ÿ∫ŸÑÿßŸÇ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="notifications-modal-body" id="notificationsBodyV4">
                    <!-- ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
                </div>
            `;
            
            document.body.appendChild(this.modal);
            
            document.getElementById('markAllReadBtnV4').addEventListener('click', () => {
                window.NotificationsSystemV4.manager.markAllAsRead();
            });
            
            document.getElementById('clearAllBtnV4').addEventListener('click', () => {
                if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ÿü')) {
                    window.NotificationsSystemV4.manager.clearAll();
                }
            });
            
            document.getElementById('closeModalBtnV4').addEventListener('click', () => {
                this.closeModal();
            });
            
            console.log('‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ v4');
        }
        
        createToastContainer() {
            this.toastContainer = document.createElement('div');
            this.toastContainer.className = 'notifications-toast-container';
            this.toastContainer.id = 'toastsContainerV4';
            document.body.appendChild(this.toastContainer);
        }
        
        toggleModal() {
            const isActive = this.modal.classList.contains('active');
            
            if (isActive) {
                this.closeModal();
            } else {
                this.openModal();
            }
        }
        
        openModal() {
            this.renderModal();
            this.modalOverlay.classList.add('active');
            this.modal.classList.add('active');
        }
        
        closeModal() {
            this.modalOverlay.classList.remove('active');
            this.modal.classList.remove('active');
        }
        
        renderModal() {
            const body = document.getElementById('notificationsBodyV4');
            if (!body) return;
            
            const notifications = window.NotificationsSystemV4.manager.getAll();
            
            if (notifications.length === 0) {
                body.innerHTML = `
                    <div class="notifications-empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</p>
                    </div>
                `;
                return;
            }
            
            body.innerHTML = notifications.map(n => this.createItemHTML(n)).join('');
        }
        
        createItemHTML(notif) {
            const timeAgo = this.getTimeAgo(notif.timestamp);
            const readClass = notif.read ? 'read' : 'unread';
            
            return `
                <div class="notification-item-card ${readClass}" 
                     data-notif-id="${notif.id}"
                     onclick="window.NotificationsSystemV4.ui.handleItemClick('${notif.id}')">
                    <div class="notification-item-icon" style="color: ${notif.color}">
                        <i class="fas ${notif.icon}"></i>
                    </div>
                    <div class="notification-item-content">
                        <div class="notification-item-title">${notif.title}</div>
                        <div class="notification-item-message">${notif.message}</div>
                        <div class="notification-item-time">
                            <i class="fas fa-clock"></i> ${timeAgo}
                        </div>
                    </div>
                    <button class="notification-item-delete" 
                            onclick="event.stopPropagation(); window.NotificationsSystemV4.manager.delete('${notif.id}'); window.NotificationsSystemV4.ui.renderModal();">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }
        
        handleItemClick(id) {
            const notif = window.NotificationsSystemV4.manager.notifications.find(n => n.id === id);
            if (!notif) return;
            
            window.NotificationsSystemV4.manager.markAsRead(id);
            
            // ÿßŸÑÿ™Ÿàÿ¨ŸäŸá ÿ≠ÿ≥ÿ® ÿßŸÑŸÜŸàÿπ
            switch (notif.type) {
                case 'out_of_stock':
                case 'low_stock':
                    // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑŸÖŸÜÿ™ÿ¨ ŸÖÿ≠ÿØÿØ
                    this.navigateToProduct(notif.data.productId);
                    break;
                    
                case 'out_of_stock_summary':
                case 'low_stock_summary':
                    // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑÿµŸÅÿ≠ÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
                    this.navigateToInventory();
                    break;
                    
                case 'overdue_debt':
                case 'upcoming_debt':
                    // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑÿπŸÖŸäŸÑ ŸÖÿ≠ÿØÿØ
                    this.navigateToCustomer(notif.data.customerId || notif.data.debtId);
                    break;
                    
                case 'overdue_debts_summary':
                case 'upcoming_debts_summary':
                    // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿØŸäŸàŸÜ
                    this.navigateToDebts();
                    break;
            }
            
            this.closeModal();
        }
        
        navigateToProduct(productId) {
            console.log('üéØ ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑŸÑŸÖŸÜÿ™ÿ¨:', productId);
            
            // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
            if (typeof showPage === 'function') {
                showPage('products');
            }
            
            // ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑÿå ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑŸÖŸÜÿ™ÿ¨
            setTimeout(() => {
                const productElement = document.querySelector(`[data-product-id="${productId}"], tr[data-product-id="${productId}"]`);
                if (productElement) {
                    productElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    productElement.style.backgroundColor = '#fef3c7';
                    setTimeout(() => {
                        productElement.style.backgroundColor = '';
                    }, 2000);
                }
            }, 500);
        }
        
        navigateToCustomer(customerId) {
            console.log('üéØ ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑŸÑÿπŸÖŸäŸÑ:', customerId);
            
            // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿØŸäŸàŸÜ
            if (typeof showPage === 'function') {
                showPage('debts');
            }
            
            // ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑÿå ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿπŸÖŸäŸÑ
            setTimeout(() => {
                // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•Ÿäÿ¨ÿßÿØ ÿßŸÑÿØŸäŸÜ ŸÅŸä ÿßŸÑÿ¨ÿØŸàŸÑ
                const debtRow = document.querySelector(`[data-debt-id="${customerId}"], [data-customer-id="${customerId}"]`);
                if (debtRow) {
                    debtRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    debtRow.style.backgroundColor = '#fef3c7';
                    setTimeout(() => {
                        debtRow.style.backgroundColor = '';
                    }, 2000);
                } else {
                    // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ data attributeÿå ŸÜÿ≠ÿßŸàŸÑ ŸÅÿ™ÿ≠ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸäŸÜ
                    const viewButton = document.querySelector(`button[onclick*="${customerId}"]`);
                    if (viewButton) {
                        viewButton.click();
                    }
                }
            }, 500);
        }
        
        navigateToInventory() {
            if (typeof showPage === 'function') {
                showPage('products'); // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
            }
        }
        
        navigateToDebts() {
            if (typeof showPage === 'function') {
                showPage('debts');
            }
        }
        
        showToast(notif) {
            const toast = document.createElement('div');
            toast.className = `notification-toast-card priority-${notif.priority}`;
            toast.innerHTML = `
                <div class="notification-toast-content">
                    <div class="notification-toast-icon" style="color: ${notif.color}">
                        <i class="fas ${notif.icon}"></i>
                    </div>
                    <div class="notification-toast-body">
                        <div class="notification-toast-title">${notif.title}</div>
                        <div class="notification-toast-message">${notif.message}</div>
                    </div>
                    <button class="notification-toast-close" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            this.toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('visible');
            }, 100);
            
            const duration = this.getToastDuration(notif.priority);
            setTimeout(() => {
                toast.classList.remove('visible');
                setTimeout(() => {
                    toast.remove();
                }, 400);
            }, duration);
        }
        
        getToastDuration(priority) {
            switch (priority) {
                case 'critical': return 10000;
                case 'high': return 7000;
                case 'medium': return 5000;
                default: return 4000;
            }
        }
        
        getTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'ÿßŸÑÿ¢ŸÜ';
            if (diffMins < 60) return `ŸÖŸÜÿ∞ ${diffMins} ÿØŸÇŸäŸÇÿ©`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `ŸÖŸÜÿ∞ ${diffHours} ÿ≥ÿßÿπÿ©`;
            
            const diffDays = Math.floor(diffHours / 24);
            if (diffDays < 7) return `ŸÖŸÜÿ∞ ${diffDays} ŸäŸàŸÖ`;
            
            return then.toLocaleDateString('en-GB');
        }
    }

    // ==================== ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ====================
    
    function initSystemV4() {
        console.log('üîî ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ v4.0 ÿßŸÑÿ™ŸÅÿµŸäŸÑŸä...');
        
        try {
            window.NotificationsSystemV4 = {
                engine: new NotificationEngineV4(),
                manager: new NotificationManagerV4(),
                ui: new NotificationUIV4(),
                persistence: new NotificationPersistenceV4()
            };
            
            setTimeout(() => {
                window.NotificationsSystemV4.engine.start();
            }, 3000);
            
            console.log('‚úÖ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ v4.0 ÿßŸÑÿ™ŸÅÿµŸäŸÑŸä ÿ¨ÿßŸáÿ≤');
            
        } catch (error) {
            console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ:', error);
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initSystemV4);
    } else {
        initSystemV4();
    }
    
    // ==================== ÿØŸàÿßŸÑ ŸÖÿ≥ÿßÿπÿØÿ© ====================
    
    window.testNotificationsV4 = function() {
        console.log('üß™ ÿßÿÆÿ™ÿ®ÿßÿ± ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ v4 ÿßŸÑÿ™ŸÅÿµŸäŸÑŸä...');
        
        // ÿ•ÿ¥ÿπÿßÿ± ŸÖŸÜÿ™ÿ¨ ŸÖÿ≠ÿØÿØ ŸÜÿßŸÅÿ∞
        window.NotificationsSystemV4.manager.add({
            id: 'test-product-1',
            type: 'out_of_stock',
            priority: 'critical',
            title: 'ŸÜŸÅÿ∞ ŸÖŸÜ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ: ŸÉŸàŸÑÿß',
            message: 'ÿßŸÑŸÖŸÜÿ™ÿ¨ "ŸÉŸàŸÑÿß" ŸÜŸÅÿØ ŸÖŸÜ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿ™ŸÖÿßŸÖÿßŸã',
            icon: 'fa-times-circle',
            color: '#ef4444',
            timestamp: new Date().toISOString(),
            data: { productId: '123', productName: 'ŸÉŸàŸÑÿß' }
        });
        
        // ÿ•ÿ¥ÿπÿßÿ± ÿØŸäŸÜ ŸÖÿ≠ÿØÿØ ŸÖÿ™ÿ£ÿÆÿ±
        window.NotificationsSystemV4.manager.add({
            id: 'test-debt-1',
            type: 'overdue_debt',
            priority: 'high',
            title: 'ÿØŸäŸÜ ŸÖÿ™ÿ£ÿÆÿ±: ÿ£ÿ≠ŸÖÿØ ÿπŸÑŸä',
            message: 'ÿßŸÑŸÖÿ®ŸÑÿ∫: 500,000 ÿØ.ÿπ - ŸÖÿ™ÿ£ÿÆÿ± 15 ŸäŸàŸÖ',
            icon: 'fa-exclamation-circle',
            color: '#ef4444',
            timestamp: new Date().toISOString(),
            data: { customerId: '456', customerName: 'ÿ£ÿ≠ŸÖÿØ ÿπŸÑŸä', amount: 500000 }
        });
        
        window.NotificationsSystemV4.ui.renderModal();
        console.log('‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©');
    };
    
    window.recheckNotificationsV4 = async function() {
        if (window.NotificationsSystemV4 && window.NotificationsSystemV4.engine) {
            await window.NotificationsSystemV4.engine.performCheck();
        }
    };
    
    console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ v4.0 ÿßŸÑÿ™ŸÅÿµŸäŸÑŸä ÿ®ŸÜÿ¨ÿßÿ≠');
})();

// ============================================================================
// üî• ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿ•ŸÑŸâ Firebase
// ============================================================================
(function() {
    console.log('üî• ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿ•ŸÑŸâ Firebase...');
    
    // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initBackupSystem);
    } else {
        initBackupSystem();
    }
    
    function initBackupSystem() {
        console.log('üì± ÿ®ÿØÿ° ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä...');
        
        // ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£ŸàŸÑÿßŸã
        setTimeout(() => {
            try {
                if (typeof checkUserStatus === 'function') {
                    checkUserStatus();
                    console.log('‚úÖ ÿ™ŸÖ ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', error);
            }
        }, 500);
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ÿ®ÿπÿØ ÿ´ÿßŸÜŸäÿ© Ÿàÿßÿ≠ÿØÿ©
        setTimeout(() => {
            try {
                if (typeof updateFirebaseBackupUI === 'function') {
                    updateFirebaseBackupUI();
                    console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä:', error);
            }
        }, 1000);
        
        // ÿ®ÿØÿ° ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿ®ÿπÿØ 5 ÿ´ŸàÿßŸÜŸä
        setTimeout(() => {
            try {
                if (typeof autoBackupOnAppStart === 'function') {
                    autoBackupOnAppStart();
                } else {
                    console.warn('‚ö†Ô∏è ÿØÿßŸÑÿ© autoBackupOnAppStart ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸëŸÅÿ©');
                }
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä:', error);
            }
        }, 5000);
    }
    
    console.log('‚úÖ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿ®ŸÜÿ¨ÿßÿ≠');
})();

// ============================================================================
// ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
// ============================================================================
(function() {
    console.log('üî• ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä...');
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDataUpload);
    } else {
        initDataUpload();
    }
    
    console.log('‚úÖ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿ®ŸÜÿ¨ÿßÿ≠');
})();
// ============================================================================

    </script>
    <script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ŸÖŸÑŸÅ ÿ™ÿµÿ≠Ÿäÿ≠ ÿ¥ÿßŸÖŸÑ ŸÑÿ•ÿµŸÑÿßÿ≠ ŸÖÿ¥ÿßŸÉŸÑ ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿßÿ™
// Comprehensive Fix for Page Display Issues
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

(function() {
    'use strict';
    
    console.log('üîß ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ ÿßŸÑÿ™ÿµÿ≠Ÿäÿ≠ÿßÿ™ ÿßŸÑÿ¥ÿßŸÖŸÑÿ©...');
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 1. ÿ•ÿµŸÑÿßÿ≠ ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿßÿ™
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function fixPageDisplay() {
        console.log('üìÑ ÿ•ÿµŸÑÿßÿ≠ ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿßÿ™...');
        
        // ÿ•ÿ∂ÿßŸÅÿ© styles ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÑÿ∂ŸÖÿßŸÜ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑÿµÿ≠Ÿäÿ≠
        const style = document.createElement('style');
        style.textContent = `
            /* ÿ•ÿµŸÑÿßÿ≠ ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿßÿ™ */
            .page {
                min-height: 100vh;
                position: relative;
            }
            
            .page.active {
                display: block !important;
                opacity: 1 !important;
                visibility: visible !important;
            }
            
            .settings-full-width {
                display: block !important;
                width: 100% !important;
                min-height: 50vh;
            }
            
            .settings-content-wrapper {
                display: block !important;
                min-height: 300px;
                opacity: 1 !important;
                visibility: visible !important;
            }
            
            /* ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑÿµÿ∫Ÿäÿ±ÿ© */
            .info-mini-card {
                display: flex !important;
                opacity: 1 !important;
            }
            
            /* ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™ */
            .cloud-tab-panel {
                min-height: 200px;
            }
            
            .cloud-tab-panel.active {
                display: block !important;
                opacity: 1 !important;
            }
            
            /* ÿ•ÿµŸÑÿßÿ≠ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™ */
            .cloud-tab-btn {
                display: flex !important;
            }
        `;
        document.head.appendChild(style);
        console.log('‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© CSS ÿ•ÿµŸÑÿßÿ≠Ÿä');
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 2. ÿ•ÿµŸÑÿßÿ≠ ÿØŸàÿßŸÑ ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿßÿ™
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function patchShowPageFunctions() {
        console.log('üîß ÿ•ÿµŸÑÿßÿ≠ ÿØŸàÿßŸÑ ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿßÿ™...');
        
        // ÿ≠ŸÅÿ∏ ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ©
        const originalShowPage = window.showPage;
        const originalShowSettingsPage = window.showSettingsPage;
        
        // ÿØÿßŸÑÿ© showPage ŸÖÿ≠ÿ≥ŸÜÿ©
        window.showPage = function(pageId) {
            console.log('üìÑ ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿ©:', pageId);
            
            try {
                // ÿ•ÿÆŸÅÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÅÿ≠ÿßÿ™
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                    page.style.display = 'none';
                    page.style.opacity = '0';
                });
                
                // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.style.display = 'block';
                    targetPage.style.opacity = '1';
                    targetPage.style.visibility = 'visible';
                    targetPage.classList.add('active');
                    
                    // ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑÿ£ÿπŸÑŸâ
                    setTimeout(() => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 100);
                    
                    console.log('‚úÖ ÿ™ŸÖ ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿ©:', pageId);
                } else {
                    console.error('‚ùå ÿßŸÑÿµŸÅÿ≠ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©:', pageId);
                }
                
                // ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸàÿ¨ŸàÿØÿ©
                if (originalShowPage && typeof originalShowPage === 'function') {
                    try {
                        originalShowPage(pageId);
                    } catch (e) {
                        console.warn('ÿ™ÿ≠ÿ∞Ÿäÿ± ŸÖŸÜ ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ©:', e);
                    }
                }
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä showPage:', error);
            }
        };
        
        // ÿØÿßŸÑÿ© showSettingsPage ŸÖÿ≠ÿ≥ŸÜÿ©
        window.showSettingsPage = function(pageName) {
            console.log('‚öôÔ∏è ÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™:', pageName);
            
            try {
                const fullPageId = `settings-${pageName}`;
                
                // ÿ•ÿÆŸÅÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÅÿ≠ÿßÿ™
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                    page.style.display = 'none';
                    page.style.opacity = '0';
                });
                
                // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
                const targetPage = document.getElementById(fullPageId);
                if (targetPage) {
                    targetPage.style.display = 'block';
                    targetPage.style.opacity = '1';
                    targetPage.style.visibility = 'visible';
                    targetPage.classList.add('active');
                    
                    // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ∏ŸáŸàÿ± ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿØÿßÿÆŸÑŸä
                    const wrapper = targetPage.querySelector('.settings-full-width');
                    if (wrapper) {
                        wrapper.style.display = 'block';
                        wrapper.style.opacity = '1';
                    }
                    
                    const contentWrapper = targetPage.querySelector('.settings-content-wrapper');
                    if (contentWrapper) {
                        contentWrapper.style.display = 'block';
                        contentWrapper.style.opacity = '1';
                    }
                    
                    // ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑÿ£ÿπŸÑŸâ
                    setTimeout(() => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 100);
                    
                    console.log('‚úÖ ÿ™ŸÖ ÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™:', fullPageId);
                } else {
                    console.error('‚ùå ÿµŸÅÿ≠ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©:', fullPageId);
                }
                
                // ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸàÿ¨ŸàÿØÿ©
                if (originalShowSettingsPage && typeof originalShowSettingsPage === 'function') {
                    try {
                        originalShowSettingsPage(pageName);
                    } catch (e) {
                        console.warn('ÿ™ÿ≠ÿ∞Ÿäÿ± ŸÖŸÜ ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ©:', e);
                    }
                }
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä showSettingsPage:', error);
            }
        };
        
        console.log('‚úÖ ÿ™ŸÖ ÿ•ÿµŸÑÿßÿ≠ ÿØŸàÿßŸÑ ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿßÿ™');
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 3. ÿ•ÿµŸÑÿßÿ≠ ÿØÿßŸÑÿ© switchCloudTab
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function patchCloudTabFunction() {
        console.log('‚òÅÔ∏è ÿ•ÿµŸÑÿßÿ≠ ÿØÿßŸÑÿ© ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿ©...');
        
        window.switchCloudTab = function(tabName) {
            console.log('üîÑ ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿ©:', tabName);
            
            try {
                // ÿ•ÿÆŸÅÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™
                document.querySelectorAll('.cloud-tab-panel').forEach(panel => {
                    panel.classList.remove('active');
                    panel.style.display = 'none';
                });
                
                // ÿ•ÿ≤ÿßŸÑÿ© active ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
                document.querySelectorAll('.cloud-tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
                const targetPanel = document.getElementById(`cloudTab-${tabName}`);
                const targetBtn = document.querySelector(`.cloud-tab-btn[data-tab="${tabName}"]`);
                
                if (targetPanel) {
                    targetPanel.style.display = 'block';
                    targetPanel.style.opacity = '1';
                    targetPanel.classList.add('active');
                    console.log('‚úÖ ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿ©:', tabName);
                }
                
                if (targetBtn) {
                    targetBtn.classList.add('active');
                }
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä switchCloudTab:', error);
            }
        };
    }

    // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ÿµÿ≠Ÿäÿ≠ÿßÿ™ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            fixPageDisplay();
            patchShowPageFunctions();
            patchCloudTabFunction();
        });
    } else {
        fixPageDisplay();
        patchShowPageFunctions();
        patchCloudTabFunction();
	}

})();
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- üî• ŸÜÿ∏ÿßŸÖ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä v2.1 ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜ - ŸÖÿπ dataSdk ŸàŸàÿßÿ¨Ÿáÿßÿ™ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ -->
<!-- Cloud Subscription System v2.1 Enhanced - With dataSdk & History UI -->
<!-- Digital Creativity Company - Karrar Alsabri -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<style>
/* ŸÜÿ∏ÿßŸÖ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä - ÿßŸÑÿ£ŸÜŸÖÿßÿ∑ ÿßŸÑŸÉÿßŸÖŸÑÿ© */
.cloud-subscription-btn {
    width: 42px; height: 42px; border-radius: 50%;
    border: 2px solid rgba(59, 130, 246, 0.25);
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.3s ease; font-size: 18px;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
}
.cloud-subscription-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}
.cloud-subscription-btn.active {
    background: linear-gradient(135deg, #10b981, #059669);
    border-color: rgba(16, 185, 129, 0.25);
}
.cloud-subscription-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px);
    z-index: 9999; display: flex; align-items: center; justify-content: center;
    opacity: 0; visibility: hidden; transition: all 0.3s ease;
}
.cloud-subscription-overlay.active {opacity: 1; visibility: visible;}
.cloud-subscription-modal {
    background: var(--card-bg, #fff); border-radius: 16px;
    width: 90%; max-width: 850px; max-height: 90vh; overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    transform: translateY(-20px); opacity: 0; transition: all 0.3s ease;
}
.cloud-subscription-overlay.active .cloud-subscription-modal {
    transform: translateY(0); opacity: 1;
}
.cloud-subscription-header {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white; padding: 24px; border-radius: 16px 16px 0 0;
    text-align: center; position: relative;
}
.cloud-subscription-header.active-header {
    background: linear-gradient(135deg, #10b981, #059669);
}
.cloud-subscription-header i.header-icon {
    font-size: 48px; margin-bottom: 12px; display: block;
}
.cloud-subscription-header h2 {
    margin: 0 0 8px 0; font-size: 1.75rem; font-weight: 700;
}
.cloud-subscription-body {padding: 32px 24px;}
.subscription-status {
    background: var(--warning-light, #fef3c7);
    border: 2px solid var(--warning, #f59e0b);
    border-radius: 12px; padding: 16px; margin-bottom: 24px; text-align: center;
}
.subscription-status.active {
    background: var(--success-light, #d1fae5);
    border-color: var(--success, #10b981);
}
.form-group {margin-bottom: 20px;}
.form-group label {
    display: block; margin-bottom: 8px; font-weight: 600;
    color: var(--text-primary, #1f2937);
}
.form-group input {
    width: 100%; padding: 12px 16px;
    border: 2px solid var(--border, #e5e7eb);
    border-radius: 8px; font-size: 1rem; direction: rtl;
}
.form-group input:focus {
    outline: none; border-color: var(--primary, #3b82f6);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
.btn-primary {
    width: 100%; padding: 14px 24px;
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white; border: none; border-radius: 8px;
    font-size: 1.05rem; font-weight: 600; cursor: pointer;
    transition: all 0.3s ease; display: flex; align-items: center;
    justify-content: center; gap: 8px;
}
.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
}
.btn-primary:disabled {opacity: 0.6; cursor: not-allowed;}
.backup-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px; margin: 24px 0;
}
.backup-btn {
    padding: 12px 16px;
    background: var(--bg-secondary, #f9fafb);
    border: 2px solid var(--border, #e5e7eb);
    border-radius: 8px; cursor: pointer; transition: all 0.3s ease;
    display: flex; align-items: center; justify-content: center;
    gap: 8px; font-size: 0.95rem; font-weight: 600;
}
.backup-btn:hover:not(:disabled) {
    background: var(--primary, #3b82f6);
    border-color: var(--primary, #3b82f6);
    color: white; transform: translateY(-2px);
}
.backup-btn:disabled {opacity: 0.5; cursor: not-allowed;}
.backup-history-table {
    width: 100%; margin-top: 20px; border-collapse: collapse; direction: rtl;
}
.backup-history-table th,
.backup-history-table td {
    padding: 12px; text-align: right;
    border-bottom: 1px solid var(--border, #e5e7eb);
}
.backup-history-table th {
    background: var(--bg-secondary, #f9fafb);
    font-weight: 600;
}
.backup-history-table tbody tr:hover {
    background: var(--bg-secondary, #f9fafb);
}
.backup-history-table .action-btn {
    padding: 6px 12px; color: white; border: none;
    border-radius: 6px; cursor: pointer; font-size: 0.85rem;
    transition: all 0.2s ease; margin: 0 4px;
}
.backup-history-table .action-btn.restore-btn {
    background: var(--success, #10b981);
}
.backup-history-table .action-btn.view-btn {
    background: var(--info, #3b82f6);
}
.backup-history-empty {
    text-align: center; padding: 40px 20px;
    color: var(--text-secondary, #6b7280);
}
.backup-details {
    background: var(--bg-secondary, #f9fafb);
    border-radius: 12px; padding: 20px; margin-top: 20px;
}
.backup-details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px; margin-top: 12px;
}
.backup-detail-item {
    background: white; padding: 12px;
    border-radius: 8px; text-align: center;
}
.backup-detail-item .count {
    font-size: 1.5rem; font-weight: 700;
    color: var(--primary, #3b82f6); display: block;
}
.backup-detail-item .label {
    font-size: 0.85rem;
    color: var(--text-secondary, #6b7280);
    margin-top: 4px;
}
.close-modal-btn {
    position: absolute; top: 16px; left: 16px;
    width: 36px; height: 36px; border-radius: 50%;
    background: rgba(255, 255, 255, 0.2); border: none;
    color: white; font-size: 1.2rem; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
}
.close-modal-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}
.loading-spinner {
    display: inline-block; width: 16px; height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white; border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
@keyframes spin {to {transform: rotate(360deg);}}
[data-theme="dark"] .cloud-subscription-modal {background: #1f2937;}
[data-theme="dark"] .backup-history-table th {background: #374151;}
[data-theme="dark"] .backup-detail-item {background: #4b5563;}
</style>

<script>
(function() {
    'use strict';
    console.log('üîê ŸÜÿ∏ÿßŸÖ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä v2.1 ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜ...');
    
    let subscriptionStatus = {isActive: false, username: null, phone: null, activationDate: null, userId: null};
    let backupHistory = [];
    
    function getCurrentUserId() {
        let userId = localStorage.getItem('currentUserId');
        if (!userId) {
            // ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿπÿ±ŸÅ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
            userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('currentUserId', userId);
            console.log('üÜï ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿπÿ±ŸÅ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ:', userId);
        }
        return userId;
    }
    
    function ensureFirebaseReady(callback) {
        if (window.isFirebaseReady && window.isFirebaseReady()) {callback(true); return;}
        if (window.waitForFirebase) {window.waitForFirebase(callback);} 
        else {console.error('‚ùå Firebase ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠'); callback(false);}
    }
    
    // ÿØÿßŸÑÿ© ŸÑÿ•ÿ≤ÿßŸÑÿ© ÿ¨ŸÖŸäÿπ ŸÇŸäŸÖ undefined ŸÖŸÜ ÿßŸÑŸÉÿßÿ¶ŸÜ ÿ®ÿ¥ŸÉŸÑ ÿπŸÖŸäŸÇ
    function removeUndefined(obj) {
        if (obj === null || obj === undefined) {
            return null;
        }
        
        if (Array.isArray(obj)) {
            return obj.map(item => removeUndefined(item)).filter(item => item !== null && item !== undefined);
        }
        
        if (typeof obj === 'object') {
            const cleaned = {};
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    const value = obj[key];
                    if (value !== undefined && value !== null) {
                        if (typeof value === 'object') {
                            const cleanedValue = removeUndefined(value);
                            if (cleanedValue !== null && cleanedValue !== undefined) {
                                if (Array.isArray(cleanedValue)) {
                                    if (cleanedValue.length > 0) {
                                        cleaned[key] = cleanedValue;
                                    }
                                } else if (Object.keys(cleanedValue).length > 0) {
                                    cleaned[key] = cleanedValue;
                                }
                            }
                        } else {
                            cleaned[key] = value;
                        }
                    }
                }
            }
            return cleaned;
        }
        
        return obj;
    }
    
    async function collectAllData() {
        console.log('üì¶ ÿ¨ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
        const data = {localStorage: {}, dataSdk: {}, metadata: {collectedAt: new Date().toISOString(), userId: getCurrentUserId(), version: '2.2'}};
        
        try {
            const keys = {invoices:'invoices',debtsData:'debts',payments:'payments',expensesData:'expenses',suppliers:'suppliers',customers:'customers',storeSettings:'storeSettings',printerSettings:'printerSettings',users:'users'};
            Object.entries(keys).forEach(([storageKey, dataKey]) => {
                const stored = localStorage.getItem(storageKey);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    data.localStorage[dataKey] = parsed;
                    console.log(`‚úÖ ${dataKey}: ${Array.isArray(parsed) ? parsed.length : 'obj'}`);
                }
            });
        } catch (e) {console.error('‚ùå ÿÆÿ∑ÿ£ localStorage:', e);}
        
        try {
            if (window.dataSdk) {
                if (typeof window.dataSdk.getAll === 'function') {
                    const allData = window.dataSdk.getAll();
                    if (allData) {
                        data.dataSdk.products = allData.filter(i => i.type === 'product') || [];
                        data.dataSdk.categories = allData.filter(i => i.type === 'category') || [];
                        data.dataSdk.sales = allData.filter(i => i.type === 'sale') || [];
                        console.log(`‚úÖ dataSdk: ${data.dataSdk.products.length} ŸÖŸÜÿ™ÿ¨, ${data.dataSdk.categories.length} ÿ™ÿµŸÜŸäŸÅ, ${data.dataSdk.sales.length} ŸÖÿ®Ÿäÿπÿ©`);
                    }
                }
                if (typeof window.dataSdk.query === 'function') {
                    if (!data.dataSdk.products || data.dataSdk.products.length === 0) {
                        const products = await window.dataSdk.query({type: 'product'});
                        if (products && products.length > 0) {
                            data.dataSdk.products = products;
                            console.log(`‚úÖ query: ${products.length} ŸÖŸÜÿ™ÿ¨`);
                        }
                    }
                }
                if ((!data.dataSdk.products || data.dataSdk.products.length === 0) && window.products && Array.isArray(window.products) && window.products.length > 0) {
                    data.dataSdk.products = window.products;
                    console.log(`‚úÖ window.products: ${window.products.length}`);
                }
                if ((!data.dataSdk.categories || data.dataSdk.categories.length === 0) && window.categories && Array.isArray(window.categories) && window.categories.length > 0) {
                    data.dataSdk.categories = window.categories;
                }
            } else {console.warn('‚ö†Ô∏è dataSdk ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±');}
        } catch (e) {console.error('‚ùå ÿÆÿ∑ÿ£ dataSdk:', e);}
        
        // ÿ™ŸÜÿ∏ŸäŸÅ ÿ¨ŸÖŸäÿπ ŸÇŸäŸÖ undefined ŸÇÿ®ŸÑ ÿßŸÑÿ•ÿ±ÿ¨ÿßÿπ
        console.log('üßπ ÿ™ŸÜÿ∏ŸäŸÅ ŸÇŸäŸÖ undefined...');
        const cleanedData = removeUndefined(data);
        console.log('‚úÖ ÿ™ŸÖ ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
        
        return cleanedData;
    }
    
    function loadSubscriptionFromFirebase() {
        const userId = getCurrentUserId(); // Ÿáÿ∞Ÿá ÿ≥ÿ™ŸÜÿ¥ÿ¶ ŸÖÿπÿ±ŸÅ ÿ¨ÿØŸäÿØ ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
        if (!userId) {
            console.warn('‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ≠ŸÖŸäŸÑ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿ®ÿØŸàŸÜ ŸÖÿπÿ±ŸÅ ŸÖÿ≥ÿ™ÿÆÿØŸÖ');
            return;
        }
        
        ensureFirebaseReady((ready) => {
            if (!ready) {
                console.warn('‚ö†Ô∏è Firebase ÿ∫Ÿäÿ± ÿ¨ÿßŸáÿ≤ ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ');
                return;
            }
            
            window.database.ref(`users/${userId}/cloudSubscription`).once('value', (snap) => {
                const d = snap.val();
                if (d && d.status === 'active') {
                    subscriptionStatus = {
                        isActive: true, 
                        username: d.username, 
                        phone: d.phone, 
                        activationDate: d.activationDate, 
                        userId
                    };
                    localStorage.setItem('cloudSubscriptionStatus', JSON.stringify(subscriptionStatus));
                    updateButtonAppearance(true);
                    console.log('‚úÖ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖŸÅÿπŸëŸÑ:', d.username);
                } else if (d && d.status === 'pending') {
                    console.log('‚è≥ ÿ∑ŸÑÿ® ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÅÿπŸäŸÑ');
                    updateButtonAppearance(false);
                } else {
                    console.log('‚ÑπÔ∏è ŸÑÿß ŸäŸàÿ¨ÿØ ÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖÿ≥ÿ¨ŸÑ');
                    updateButtonAppearance(false);
                }
            }).catch((error) => {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ:', error);
            });
        });
    }
    
    function submitSubscriptionRequest(username, phone) {
        return new Promise((resolve, reject) => {
            const userId = getCurrentUserId(); // Ÿáÿ∞Ÿá ÿßŸÑÿØÿßŸÑÿ© ÿ≥ÿ™ŸÜÿ¥ÿ¶ ŸÖÿπÿ±ŸÅ ÿ¨ÿØŸäÿØ ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
            if (!userId) {reject('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ'); return;}
            
            console.log('üì§ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', userId);
            
            ensureFirebaseReady((ready) => {
                if (!ready) {reject('ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ÿ© ÿ≠ÿßŸÑŸäÿßŸã. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™.'); return;}
                const timestamp = new Date().toISOString();
                const requestId = `req_${Date.now()}_${userId.replace(/[^a-zA-Z0-9]/g, '')}`;
                const data = {
                    userId, 
                    username, 
                    phone, 
                    requestDate: timestamp, 
                    status: 'pending', 
                    source: 'desktop_app',
                    createdBy: 'new_user_registration'
                };
                
                // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ŸÖÿ≥ÿßÿ±ŸäŸÜ: ÿ™ÿ≠ÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸàŸÅŸä ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™
                window.database.ref(`users/${userId}/cloudSubscription`).set({...data, type: 'subscription_request'})
                    .then(() => {
                        console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ≠ÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
                        return window.database.ref(`subscriptionRequests/${requestId}`).set(data);
                    })
                    .then(() => {
                        console.log('‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑÿ¥ÿ±ŸÉÿ©');
                        // ÿ≠ŸÅÿ∏ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÑÿ® ŸÅŸä localStorage ÿ£Ÿäÿ∂ÿßŸã
                        localStorage.setItem('pendingSubscription', JSON.stringify({
                            userId,
                            username,
                            phone,
                            requestId,
                            requestDate: timestamp,
                            status: 'pending'
                        }));
                        resolve({success: true, requestId, userId});
                    })
                    .catch((e) => {
                        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®:', e);
                        reject('ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®: ' + e.message);
                    });
            });
        });
    }
    
    function performFullBackupToFirebase() {
        return new Promise(async (resolve, reject) => {
            const userId = getCurrentUserId();
            if (!userId) {
                reject('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
                return;
            }
            
            if (!subscriptionStatus.isActive) {
                reject('‚ö†Ô∏è ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä ÿ∫Ÿäÿ± ŸÖŸÅÿπŸëŸÑ!\n\nŸäÿ±ÿ¨Ÿâ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿ£ŸàŸÑÿßŸã ŸàÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÅÿπŸäŸÑ ŸÖŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿ©.');
                return;
            }
            
            ensureFirebaseReady(async (ready) => {
                if (!ready) {reject('ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿ© ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ÿ© ÿ≠ÿßŸÑŸäÿßŸã. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™.'); return;}
                try {
                    const allData = await collectAllData();
                    const backupId = `backup_${Date.now()}`;
                    await window.database.ref(`users/${userId}/cloudBackups/${backupId}`).set({...allData, username: subscriptionStatus.username, userId, timestamp: new Date().toISOString()});
                    localStorage.setItem('lastCloudBackup', new Date().toISOString());
                    const counts = {invoices: allData.localStorage.invoices?.length || 0, debts: allData.localStorage.debts?.length || 0, products: allData.dataSdk.products?.length || 0};
                    await window.database.ref(`users/${userId}/cloudSubscription/lastBackup`).set({timestamp: new Date().toISOString(), backupId, itemsCount: counts});
                    resolve({success: true, backupId, itemsCount: counts});
                } catch (e) {reject(e.message);}
            });
        });
    }
    
    function viewBackupHistoryFromFirebase() {
        return new Promise((resolve, reject) => {
            const userId = getCurrentUserId();
            if (!userId) {reject('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ'); return;}
            ensureFirebaseReady((ready) => {
                if (!ready) {reject('ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿäÿ© ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ÿ© ÿ≠ÿßŸÑŸäÿßŸã'); return;}
                window.database.ref(`users/${userId}/cloudBackups`).once('value', (snap) => {
                    const backups = [];
                    snap.forEach((child) => {
                        const b = child.val();
                        backups.push({
                            id: child.key,
                            timestamp: b.timestamp,
                            username: b.username,
                            itemsCount: {
                                invoices: b.localStorage?.invoices?.length || 0,
                                debts: b.localStorage?.debts?.length || 0,
                                products: b.dataSdk?.products?.length || 0,
                                categories: b.dataSdk?.categories?.length || 0,
                                customers: b.localStorage?.customers?.length || 0
                            }
                        });
                    });
                    backups.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    backupHistory = backups;
                    resolve(backups);
                }).catch((e) => reject(e.message));
            });
        });
    }
    
    function restoreBackupFromFirebase(backupId) {
        return new Promise((resolve, reject) => {
            const userId = getCurrentUserId();
            if (!userId) {reject('Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ'); return;}
            ensureFirebaseReady((ready) => {
                if (!ready) {reject('ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ÿ©'); return;}
                window.database.ref(`users/${userId}/cloudBackups/${backupId}`).once('value', (snap) => {
                    const b = snap.val();
                    if (!b) {reject('ÿßŸÑŸÜÿ≥ÿÆÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©'); return;}
                    try {
                        if (b.localStorage) {
                            const keyMap = {invoices:'invoices',debts:'debtsData',payments:'payments',expenses:'expensesData',suppliers:'suppliers',customers:'customers',storeSettings:'storeSettings',printerSettings:'printerSettings',users:'users'};
                            Object.entries(keyMap).forEach(([dataKey, storageKey]) => {
                                if (b.localStorage[dataKey]) localStorage.setItem(storageKey, JSON.stringify(b.localStorage[dataKey]));
                            });
                        }
                        if (b.dataSdk) {
                            if (b.dataSdk.products) window.products = b.dataSdk.products;
                            if (b.dataSdk.categories) window.categories = b.dataSdk.categories;
                        }
                        resolve({success: true, timestamp: b.timestamp});
                    } catch (e) {reject(e.message);}
                }).catch((e) => reject(e.message));
            });
        });
    }
    
    function addCloudButton() {
        const topActions = document.querySelector('.top-actions');
        if (!topActions || document.getElementById('cloudSubscriptionBtn')) return;
        const btn = document.createElement('button');
        btn.id = 'cloudSubscriptionBtn';
        btn.className = 'cloud-subscription-btn';
        btn.innerHTML = '<i class="fas fa-cloud"></i>';
        btn.onclick = openModal;
        const themeToggle = topActions.querySelector('[onclick*="toggleTheme"]');
        if (themeToggle) topActions.insertBefore(btn, themeToggle);
        else topActions.appendChild(btn);
    }
    
    function updateButtonAppearance(isActive) {
        const btn = document.getElementById('cloudSubscriptionBtn');
        if (btn) btn.classList.toggle('active', isActive);
    }
    
    function createModal() {
        if (document.getElementById('cloudSubscriptionModal')) return;
        const overlay = document.createElement('div');
        overlay.id = 'cloudSubscriptionModal';
        overlay.className = 'cloud-subscription-overlay';
        overlay.onclick = (e) => {if (e.target === overlay) closeModal();};
        const modal = document.createElement('div');
        modal.className = 'cloud-subscription-modal';
        modal.onclick = (e) => e.stopPropagation();
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
    }
    
    function openModal() {
        createModal();
        updateModalContent();
        setTimeout(() => document.getElementById('cloudSubscriptionModal').classList.add('active'), 10);
    }
    
    function closeModal() {
        const m = document.getElementById('cloudSubscriptionModal');
        if (m) m.classList.remove('active');
    }
    
    window.closeCloudSubscriptionModal = closeModal;
    
    function updateModalContent() {
        const modal = document.getElementById('cloudSubscriptionModal')?.querySelector('.cloud-subscription-modal');
        if (!modal) return;
        modal.innerHTML = subscriptionStatus.isActive ? renderActiveDashboard() : renderRegistrationForm();
    }
    
    function renderRegistrationForm() {
        return `
            <div class="cloud-subscription-header">
                <button class="close-modal-btn" onclick="closeCloudSubscriptionModal()"><i class="fas fa-times"></i></button>
                <i class="fas fa-cloud-upload-alt header-icon"></i>
                <h2>ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä</h2>
                <p>ÿ•ÿØÿßÿ±ÿ© ÿ¥ÿßŸÖŸÑÿ© ŸÑŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä</p>
            </div>
            <div class="cloud-subscription-body">
                <div class="subscription-status">
                    <div class="subscription-status-icon">‚ö†Ô∏è</div>
                    <h3>ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿ∫Ÿäÿ± ŸÖŸÅÿπŸëŸÑ</h3>
                    <p>ŸÇÿØŸÖ ŸÖÿπŸÑŸàŸÖÿßÿ™ŸÉ ŸÑŸÑÿ™ŸÅÿπŸäŸÑ</p>
                </div>
                <form class="subscription-form" onsubmit="window.handleSubscriptionSubmit(event)">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ±ÿ®ÿßÿπŸä</label>
                        <input type="text" id="subscriptionUsername" placeholder="ÿ£ÿ≠ŸÖÿØ ÿπŸÑŸä ŸÖÿ≠ŸÖÿØ" minlength="10" required />
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-phone"></i> ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</label>
                        <input type="tel" id="subscriptionPhone" placeholder="07XXXXXXXXX" pattern="[0-9]{11}" maxlength="11" required />
                    </div>
                    <button type="submit" class="btn-primary" id="submitSubscriptionBtn">
                        <i class="fas fa-paper-plane"></i><span>ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿ™ŸÅÿπŸäŸÑ</span>
                    </button>
                </form>
            </div>
        `;
    }
    
    window.handleSubscriptionSubmit = function(event) {
        event.preventDefault();
        const username = document.getElementById('subscriptionUsername').value.trim();
        const phone = document.getElementById('subscriptionPhone').value.trim();
        const btn = document.getElementById('submitSubscriptionBtn');
        
        if (!username || username.split(' ').length < 4) {
            alert('‚ö†Ô∏è ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ±ÿ®ÿßÿπŸä ŸÉÿßŸÖŸÑÿßŸã');
            return;
        }
        
        if (!phone || phone.length !== 11) {
            alert('‚ö†Ô∏è ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ 11 ÿ±ŸÇŸÖÿßŸã');
            return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span><span>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ...</span>';
        
        submitSubscriptionRequest(username, phone)
            .then((result) => {
                alert(`‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿ®ŸÜÿ¨ÿßÿ≠!

üìù ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ÿ≥ŸÑÿ©:
‚Ä¢ ÿßŸÑÿßÿ≥ŸÖ: ${username}
‚Ä¢ ÿßŸÑŸáÿßÿ™ŸÅ: ${phone}
‚Ä¢ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${result.userId}
‚Ä¢ ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®: ${result.requestId}

‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑÿ¥ÿ±ŸÉÿ©

‚è≥ ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÉ ÿÆŸÑÿßŸÑ 24 ÿ≥ÿßÿπÿ© ŸÑÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä.

üìû ŸÑŸÑÿßÿ≥ÿ™ŸÅÿ≥ÿßÿ±: ÿßÿ™ÿµŸÑ ÿ®ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿπŸÑŸâ ÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑÿØÿπŸÖ ÿßŸÑŸÅŸÜŸä.`);
                closeModal();
            })
            .catch((e) => {
                alert(`‚ùå ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®!

ÿßŸÑÿÆÿ∑ÿ£: ${e}

Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ:
‚Ä¢ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™
‚Ä¢ ÿ•ÿπÿØÿßÿØÿßÿ™ Firebase
‚Ä¢ ÿ´ŸÖ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ`);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i><span>ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿ™ŸÅÿπŸäŸÑ</span>';
            });
    };
    
    function renderActiveDashboard() {
        return `
            <div class="cloud-subscription-header active-header">
                <button class="close-modal-btn" onclick="closeCloudSubscriptionModal()"><i class="fas fa-times"></i></button>
                <i class="fas fa-cloud-upload-alt header-icon"></i>
                <h2>ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä - ŸÜÿ¥ÿ∑</h2>
                <p>ŸÖÿ±ÿ≠ÿ®ÿßŸã ${subscriptionStatus.username}</p>
            </div>
            <div class="cloud-subscription-body">
                <div class="subscription-status active">
                    <div class="subscription-status-icon">‚úÖ</div>
                    <h3>ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖŸÅÿπŸëŸÑ</h3>
                </div>
                <div class="backup-controls">
                    <button class="backup-btn" onclick="window.performBackup(event)">
                        <i class="fas fa-cloud-upload-alt"></i><span>ÿ±ŸÅÿπ ŸÜÿ≥ÿÆÿ©</span>
                    </button>
                    <button class="backup-btn" onclick="window.viewHistory(event)">
                        <i class="fas fa-history"></i><span>ÿπÿ±ÿ∂ ÿßŸÑÿ≥ÿ¨ŸÑ</span>
                    </button>
                </div>
                <div id="historyContainer"></div>
            </div>
        `;
    }
    
    window.performBackup = function(event) {
        const btn = event.target.closest('.backup-btn');
        const orig = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span><span>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ±ŸÅÿπ...</span>';
        performFullBackupToFirebase()
            .then((r) => {
                alert(`‚úÖ ÿ™ŸÖ ÿßŸÑÿ±ŸÅÿπ!\n\nÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™: ${r.itemsCount.products}\nÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±: ${r.itemsCount.invoices}\nÿßŸÑÿØŸäŸàŸÜ: ${r.itemsCount.debts}`);
                window.viewHistory(event);
            })
            .catch((e) => alert('‚ùå ŸÅÿ¥ŸÑ: ' + e))
            .finally(() => {btn.disabled = false; btn.innerHTML = orig;});
    };
    
    window.viewHistory = function(event) {
        const btn = event?.target?.closest('.backup-btn');
        if (btn) {
            const orig = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span><span>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</span>';
            viewBackupHistoryFromFirebase()
                .then((backups) => {
                    displayBackupHistory(backups);
                    btn.disabled = false;
                    btn.innerHTML = orig;
                })
                .catch((e) => {
                    alert('‚ùå ŸÅÿ¥ŸÑ: ' + e);
                    btn.disabled = false;
                    btn.innerHTML = orig;
                });
        } else {
            viewBackupHistoryFromFirebase().then(displayBackupHistory).catch((e) => alert('‚ùå ŸÅÿ¥ŸÑ: ' + e));
        }
    };
    
    function displayBackupHistory(backups) {
        const container = document.getElementById('historyContainer');
        if (!container) return;
        if (backups.length === 0) {
            container.innerHTML = '<div class="backup-history-empty"><i class="fas fa-inbox"></i><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©</p></div>';
            return;
        }
        let html = '<table class="backup-history-table"><thead><tr><th>#</th><th>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th><th>ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</th><th>ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±</th><th>ÿßŸÑÿØŸäŸàŸÜ</th><th>ÿßŸÑÿπŸÖŸÑÿßÿ°</th><th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th></tr></thead><tbody>';
        backups.forEach((b, i) => {
            const date = new Date(b.timestamp).toLocaleString('ar-IQ');
            html += `<tr>
                <td>${i + 1}</td>
                <td>${date}</td>
                <td>${b.itemsCount.products}</td>
                <td>${b.itemsCount.invoices}</td>
                <td>${b.itemsCount.debts}</td>
                <td>${b.itemsCount.customers}</td>
                <td>
                    <button class="action-btn view-btn" onclick="window.showBackupDetails('${b.id}', ${i})">
                        <i class="fas fa-eye"></i> ÿπÿ±ÿ∂
                    </button>
                    <button class="action-btn restore-btn" onclick="window.restoreBackup('${b.id}', '${date}')">
                        <i class="fas fa-download"></i> ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ
                    </button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    window.showBackupDetails = function(backupId, index) {
        const backup = backupHistory[index];
        if (!backup) return;
        const details = `
            <div class="backup-details">
                <h4><i class="fas fa-info-circle"></i> ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÜÿ≥ÿÆÿ©</h4>
                <div class="backup-details-grid">
                    <div class="backup-detail-item">
                        <span class="count">${backup.itemsCount.products}</span>
                        <div class="label">ŸÖŸÜÿ™ÿ¨</div>
                    </div>
                    <div class="backup-detail-item">
                        <span class="count">${backup.itemsCount.categories}</span>
                        <div class="label">ÿ™ÿµŸÜŸäŸÅ</div>
                    </div>
                    <div class="backup-detail-item">
                        <span class="count">${backup.itemsCount.invoices}</span>
                        <div class="label">ŸÅÿßÿ™Ÿàÿ±ÿ©</div>
                    </div>
                    <div class="backup-detail-item">
                        <span class="count">${backup.itemsCount.debts}</span>
                        <div class="label">ÿØŸäŸÜ</div>
                    </div>
                    <div class="backup-detail-item">
                        <span class="count">${backup.itemsCount.customers}</span>
                        <div class="label">ÿπŸÖŸäŸÑ</div>
                    </div>
                </div>
            </div>
        `;
        const container = document.getElementById('historyContainer');
        const existingDetails = container.querySelector('.backup-details');
        if (existingDetails) existingDetails.remove();
        container.insertAdjacentHTML('beforeend', details);
    };
    
    window.restoreBackup = function(backupId, date) {
        if (!confirm(`‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±!\n\nÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ÿßŸÑŸÜÿ≥ÿÆÿ© ŸÖŸÜ:\n${date}\n\nŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü`)) return;
        restoreBackupFromFirebase(backupId)
            .then(() => {
                alert('‚úÖ ÿ™ŸÖ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ!\n\nÿ≥Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ...');
                setTimeout(() => window.location.reload(), 1000);
            })
            .catch((e) => alert('‚ùå ŸÅÿ¥ŸÑ: ' + e));
    };
    
    window.activateSubscriptionManually = function(username, phone) {
        const userId = getCurrentUserId();
        if (!userId) {console.error('‚ùå Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ'); return;}
        subscriptionStatus = {isActive: true, username, phone, activationDate: new Date().toISOString(), userId};
        localStorage.setItem('cloudSubscriptionStatus', JSON.stringify(subscriptionStatus));
        updateButtonAppearance(true);
        ensureFirebaseReady((ready) => {
            if (ready) {
                window.database.ref(`users/${userId}/cloudSubscription`).update({
                    status: 'active', username, phone,
                    activationDate: subscriptionStatus.activationDate,
                    activatedBy: 'manual_console'
                }).then(() => console.log('‚úÖ ÿ≠ŸÅÿ∏ ŸÅŸä Firebase'));
            }
        });
        console.log('‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ŸÅÿπŸäŸÑ!');
        alert('‚úÖ ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ!');
    };
    
    function init() {
        console.log('‚öôÔ∏è ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ...');
        loadSubscriptionFromFirebase();
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                addCloudButton();
                createModal();
            });
        } else {
            addCloudButton();
            createModal();
        }
    }
    
    init();
    
    console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  ‚òÅÔ∏è  ŸÜÿ∏ÿßŸÖ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä v2.1 ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜ                   ‚ïë
‚ïë  ŸÖÿπ dataSdk ŸàŸàÿßÿ¨Ÿáÿßÿ™ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™                               ‚ïë
‚ïë  ‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠                                      ‚ïë
‚ïë  üî• ŸÖÿ™ÿµŸÑ ÿ®ŸÄ Firebase                                       ‚ïë
‚ïë  üìù ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ±: activateSubscriptionManually('ÿßŸÑÿßÿ≥ŸÖ','07...')  ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    `);
    
})();

// ŸÅŸä ÿØÿßŸÑÿ© restoreFromBackup()
window.restoreOldDebtsFromBackup(backupData);
</script>

</body>
</html>